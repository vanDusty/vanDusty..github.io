<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>【Git 系列】git stash</title>
    <url>/2021/11/01/5fd8a966.html</url>
    <content><![CDATA[<p><code>stash</code>在英文意思是隐藏。<code>git stash</code> 的作用也是隐藏没完成的代码，防止它干扰<strong>别人</strong>或者<strong>新分支</strong>的工作。</p>
<a id="more"></a>

<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><h3 id="1-1-我们经常会遇到这样的情况"><a href="#1-1-我们经常会遇到这样的情况" class="headerlink" title="1.1 我们经常会遇到这样的情况"></a>1.1 我们经常会遇到这样的情况</h3><blockquote>
<p>正在 <code>dev</code> 分支开发新功能，做到一半时有人过来反馈一个 <code>bug</code> ，需要马上解决，但是新功能做到了一半你又不想提交。</p>
</blockquote>
<p>这时就可以使用 <code>git stash</code> 命令先把当前进度保存起来，然后切换到另一个分支去修改<code>bug</code>；修改完提交后，再切回 <code>dev</code> 分支，使用<code>git stash pop</code>来恢复之前的进度继续开发新功能。</p>
<p>看到这里，有些小伙伴就有疑问：没必要啊，修 <code>BUG</code> 的时候，直接切换分支，修改完提交后再切回来到原来的分支不就行了。</p>
<h3 id="1-2-真的要这么麻烦吗？"><a href="#1-2-真的要这么麻烦吗？" class="headerlink" title="1.2 真的要这么麻烦吗？"></a>1.2 真的要这么麻烦吗？</h3><ul>
<li>比如有情景如下：</li>
</ul>
<ol>
<li>在 <code>dev</code> 分支下创建一个文件 <code>dev_file.txt</code>，并 <code>add</code>，让它 <code>stage</code>；</li>
<li>这时切到 <code>master</code> 分支，你会看到这个 <code>dev_file.txt</code> 居然也在 <code>master</code> 分支里。他不是应该只在 <code>dev</code> 分支吗？</li>
</ol>
<ul>
<li>如果你试试你再试试：</li>
</ul>
<ol>
<li>切回 <code>dev</code> 分支，执行 <code>git stash</code>；</li>
<li>这时你在切回 <code>master</code> 分支， <code>dev_file.txt</code> 就消失了。</li>
</ol>
<p>这时候，我不禁想说：<strong>git stash，YYDS ！</strong></p>
<h2 id="二、git-stash"><a href="#二、git-stash" class="headerlink" title="二、git stash"></a>二、git stash</h2><p>当你执行 <code>git stash</code> 时会提醒你：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">Saved working directory and index state WIP on newF2: b63fbcb add dev_file.txt</span><br><span class="line">HEAD is now at b63fbcb add dev_file.txt。</span><br></pre></td></tr></table></figure>

<p>它已经把 <code>dev_file.txt</code> 保存好了。</p>
<h3 id="2-1-git-stash-干了什么"><a href="#2-1-git-stash-干了什么" class="headerlink" title="2.1  git stash 干了什么"></a>2.1  git stash 干了什么</h3><p>它会保存当前工作进度，会把暂存区和工作区的改动保存到一个未完结变更的堆栈中；执行完这个命令后，在运行<code>git status</code>命令，就会发现当前是一个干净的工作区，没有任何改动。</p>
<blockquote>
<ol>
<li><code>git stash</code> 是本地的，不会上传到服务器上；</li>
<li>可以通过使用<code>git stash save &#39;message...&#39;</code>可以添加一些注释。</li>
</ol>
</blockquote>
<h3 id="2-2-git-stash-相关命令"><a href="#2-2-git-stash-相关命令" class="headerlink" title="2.2 git stash 相关命令"></a>2.2 git stash 相关命令</h3><table>
<thead>
<tr>
<th>命令名</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>git stash</td>
<td>隐藏当前的工作现场, 此时, git status的结果是 clean</td>
</tr>
<tr>
<td>git stash list</td>
<td>查看所有隐藏, 每一行的冒号前面的字符串就是标识此隐藏的id</td>
</tr>
<tr>
<td>git stash apply <id></td>
<td>重新显示标识为 id 的隐藏</td>
</tr>
<tr>
<td>git stash drop <id></td>
<td>git apply恢复隐藏后, 需要手动删除 list 列表中的记录</td>
</tr>
<tr>
<td>git stash pop</td>
<td>恢复最新的进度到工作区</td>
</tr>
<tr>
<td>git stash pop stash@[stash_id]</td>
<td>恢复指定的进度到工作区</td>
</tr>
</tbody></table>
<blockquote>
<p>如：<code>git stash pop stash@{1}</code>。<code>stash_id</code>是通过<code>git stash list</code>命令得到的；</p>
</blockquote>
<h2 id="三、git-stash-使用场景"><a href="#三、git-stash-使用场景" class="headerlink" title="三、git stash 使用场景"></a>三、git stash 使用场景</h2><h3 id="3-1-有人与我改动同一分支"><a href="#3-1-有人与我改动同一分支" class="headerlink" title="3.1 有人与我改动同一分支"></a>3.1 有人与我改动同一分支</h3><blockquote>
<p>我在本地修改好后，发现远程分支已经被改动了，此时我本地也被改动了就造成了冲突，无法 <code>push</code> 或者 <code>pull</code>。</p>
</blockquote>
<p>此时，就可以用 <code>git stash</code> 来处理</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">// 把本地的改动暂存起来</span><br><span class="line">git stash </span><br><span class="line">// 拉取远程分支（此时本地分支会回滚到上次commit的情况，你的改动都存在stash中）</span><br><span class="line">git pull  </span><br><span class="line">// 将stash中改动重新加回本地分支，就可以继续修改了，当然，如果改好了就是add,commit,push</span><br><span class="line">git stash pop</span><br></pre></td></tr></table></figure>

<h3 id="3-2-不小心改动了其他分支"><a href="#3-2-不小心改动了其他分支" class="headerlink" title="3.2 不小心改动了其他分支"></a>3.2 不小心改动了其他分支</h3><blockquote>
<p>例如忘记切换，将代码写错了分支，直接在 <code>master</code> 分支上做改动，这里假设我的分支是 <code>feature/category_vechice</code> 分支。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">// 把本地当前改动暂存起来，此时master分支就恢复到了上次拉取时的状态</span><br><span class="line">git stash</span><br><span class="line">// 切换到需要改动的分支</span><br><span class="line">git checkout test</span><br><span class="line">// 将改动pop到自己当前的分支</span><br><span class="line">git stash pop</span><br></pre></td></tr></table></figure>

<h2 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h2><blockquote>
<p>顾名思义，<code>stash</code> 就是一个栈，平时我们把需要暂存的文件存到栈中，把代码恢复到上次拉取的状态以进行操作。</p>
</blockquote>
<p>就我个人使用而言，<code>git stash pop</code> 就已经满足日常需要了，毕竟频繁的线上 <code>bug</code> 或者忘记切代码啥的，我们应该考虑的不是这个命令的问题，是开发质量的范畴了。</p>
]]></content>
      <categories>
        <category>Git 系列</category>
      </categories>
      <tags>
        <tag>Git 命令</tag>
      </tags>
  </entry>
  <entry>
    <title>【面试】程序员的简历该怎么写？</title>
    <url>/2021/10/30/34b0cc40.html</url>
    <content><![CDATA[<blockquote>
<p>简历是我们面试的敲门砖，简历基本属于面试流程的50%，好的简历面试官一看就能被吸引，大部分简历被扔到废纸篓。</p>
</blockquote>
<a id="more"></a>

<p>程序员就应该拿技术说话，「技术总结」是一份程序员简历的重中之重。除了大神和大牛，普通的程序员如果能在叙述中体现自己的风格，在技术总结中展示鲜明的个人形象，会更吸引公司的注意，拿到更多的面试邀请。</p>
<h2 id="一、小小的建议"><a href="#一、小小的建议" class="headerlink" title="一、小小的建议"></a>一、小小的建议</h2><p>推荐大家使用 <code>Markdown</code> 语法写简历，然后再将 <code>Markdown</code> 格式转换为<code>PDF</code>格式后进行简历投递。</p>
<ul>
<li>为什么用 <code>Markdown</code> 语法？</li>
</ul>
<ol>
<li><strong>语法真的非常简单</strong>;</li>
<li>程序员的世界到处都是 <code>Markdown</code>，像简书，<code>GitChat</code>， <code>GitHub</code>，<code>CSDN</code> 等等都支持 <code>Markdown</code> 文档，正宗的官方技术文档都是使用 <code>Markdown</code> 来写的。</li>
</ol>
<blockquote>
<p>如果你对Markdown语法不太了解的话，可以花五分钟简单看一下 <a href="http://www.markdown.cn" target="_blank" rel="noopener">Markdown 语法</a></p>
</blockquote>
<ul>
<li>为什么转换为<code>PDF</code>格式后进行投递</li>
</ul>
<p>我们都知道，因为 <code>Word</code> 版本不同或者 <code>Mac</code>/<code>Windows</code> 系统等原因，如果不转成 <code>PDF</code>格式，你辛辛苦苦编辑的样式就可能到别人手上就变得<strong>惨不忍不</strong>。为了保证别人看到的样式跟你想要表达的一致，推荐转换为<code>PDF</code>格式后进行简历投递。</p>
<h3 id="写简历的几个原则："><a href="#写简历的几个原则：" class="headerlink" title="写简历的几个原则："></a>写简历的几个原则：</h3><ol>
<li>仔细核对，语句通畅，<strong>没错别字</strong>；</li>
<li>尽量避免主观表述，少一点语义模糊的形容词，除非是大公司大牛，已经有成果撑腰，否则慎用「熟悉… …」、「使用过… …」</li>
<li>简历上体现的项目细节，<strong>核心指标要有依据，能自圆其说</strong>，被认为在撒谎基本就GG；</li>
<li><strong>不要过分夸大</strong>，包装自己的项目和技术，不懂的虚心请教，不要编或者瞎猜；</li>
<li>如果面试官专挑冷门，你简历完全没涉及的技术点问，可以喷他，这种公司不去也罢。</li>
</ol>
<h2 id="二、-两大法则"><a href="#二、-两大法则" class="headerlink" title="二、 两大法则"></a>二、 两大法则</h2><h3 id="STAR-法则"><a href="#STAR-法则" class="headerlink" title="STAR 法则"></a>STAR 法则</h3><ol>
<li>Situation： 事情是在什么情况下发生；</li>
<li>Task:： 你是如何明确你的任务的；</li>
<li>Action： 针对这样的情况分析，你采用了什么行动方式；</li>
<li>Result： 结果怎样，在这样的情况下你学习到了什么。</li>
</ol>
<blockquote>
<p>简而言之，STAR 法则，就是一种讲述自己故事的方式，或者说，是一个清晰、条理的作文模板。不管是什么，合理熟练运用此法则，可以轻松的对面试官描述事物的逻辑方式，表现出自己分析阐述问题的清晰性、条理性和逻辑性。</p>
</blockquote>
<h3 id="FAB-法则"><a href="#FAB-法则" class="headerlink" title="FAB 法则"></a>FAB 法则</h3><ol>
<li>Feature： 是什么；</li>
<li>Advantage： 比别人好在哪些地方；</li>
<li>Benefifit： 如果雇佣你，招聘方会得到什么好处。</li>
</ol>
<blockquote>
<p>简单来说，这个法则主要是让你的面试官知道你的优势、招了你之后对公司有什么帮助。</p>
</blockquote>
<h2 id="三、简历模板"><a href="#三、简历模板" class="headerlink" title="三、简历模板"></a>三、简历模板</h2><h3 id="联系方式"><a href="#联系方式" class="headerlink" title="联系方式"></a>联系方式</h3><p>手机： 135****2021 <br><br>邮箱： ***@gmail.com <br><br>微信： **** <br><br>Github： **** <br><br>博客： **** <br></p>
<h3 id="个人信息"><a href="#个人信息" class="headerlink" title="个人信息"></a>个人信息</h3><p>* 姓名 / 男 / 1995 <br><br>* 本科 / 浙江大学 / 软件工程 <br><br>* 工作年限：5年 <br><br>* 情况简介：目前在***大数据部门的**组，负责**系统的开发工作 <br><br>* 主要技术栈: Java JDK(1.8)、Spring、Redis、XXL-Job、Sofa、MySQL、Mybatis、Sharing-JDBC、Apollo、Kafka、Flink、Cat等</p>
<h3 id="工作经历"><a href="#工作经历" class="headerlink" title="工作经历"></a>工作经历</h3><h4 id="公司名（2019-03-至今）"><a href="#公司名（2019-03-至今）" class="headerlink" title="公司名（2019.03 ~ 至今）"></a>公司名（2019.03 ~ 至今）</h4><p><strong>2020.03-至今       XX系统                   技术专家        系统负责人</strong></p>
<p>项目背景：由于公司XX，以及XX，公司让我负责XX系统（简单2-3句话交代一下背景）。</p>
<p>系统难点：XX业务流程复杂，涉及的XXX，外部XXX不稳定（突出项目难点）。</p>
<ol>
<li>流程设计，XX底层模板抽象，XX高度复用，XX似需求接入效率提升了50%，由 1周缩短为 3天（需求+业务效果）；</li>
<li>线程池XX、子任务XX，根据外部系统 RRT 动态调整调用XX系统的QPS, XXXX 查询耗时缩短 73ms/笔;</li>
<li>优化XXX，XXXX响应时间缩短至 XXX ms以内;</li>
<li>XXXX任务分发，灵活调整 XXXX 任务执行DAG，XXX &amp; 测试上线时间缩短 30%；</li>
<li>实现XXX验证器、XXXX 路由、XXXX处理、XXXX补偿 &amp; XXXX重试等技术手段，XXX成功率提升XXX;</li>
<li>分布式限流，分布式调度任务灵活配置任务执行时间区间、频率、执行参数;</li>
</ol>
<p><strong>2019.03-2020.06       XX系统                资深研发工程师  主要开发人员</strong></p>
<p>项目背景：由于公司XX，以及XX，公司让我负责XX系统（简单2-3句话交代一下背景）。</p>
<p>系统难点：XX业务流程复杂，涉及的XXX，外部XXX不稳定（突出项目难点）。</p>
<ol>
<li>流程设计，XX底层模板抽象，XX高度复用，XX似需求接入效率提升了50%，由 1周缩短为 3天（需求+业务效果）；</li>
<li>线程池XX、子任务XX，根据外部系统 RRT 动态调整调用XX系统的QPS, XXXX 查询耗时缩短 73ms/笔;</li>
<li>优化XXX，XXXX响应时间缩短至 XXX ms以内;</li>
<li>XXXX任务分发，灵活调整 XXXX 任务执行DAG，XXX &amp; 测试上线时间缩短 30%；</li>
<li>实现XXX验证器、XXXX 路由、XXXX处理、XXXX补偿 &amp; XXXX重试等技术手段，XXX成功率提升XXX;</li>
<li>分布式限流，分布式调度任务灵活配置任务执行时间区间、频率、执行参数;</li>
</ol>
<h4 id="XX公司（2016-03-2019-03）"><a href="#XX公司（2016-03-2019-03）" class="headerlink" title="XX公司（2016.03 ~ 2019.03）"></a>XX公司（2016.03 ~ 2019.03）</h4><p><strong>2017.01-2018.03       XX系统                研发工程师  主要开发人员</strong></p>
<p>项目背景：由于公司XX，以及XX，公司让我负责XX系统（简单2-3句话交代一下背景）。</p>
<p>系统难点：XX业务流程复杂，涉及的XXX，外部XXX不稳定（突出项目难点）。</p>
<ol>
<li>流程设计，XX底层模板抽象，XX高度复用，XX似需求接入效率提升了50%，由 1周缩短为 3天（需求+业务效果）；</li>
<li>线程池XX、子任务XX，根据外部系统 RRT 动态调整调用XX系统的QPS, XXXX 查询耗时缩短 73ms/笔;</li>
<li>优化XXX，XXXX响应时间缩短至 XXX ms以内;</li>
<li>XXXX任务分发，灵活调整 XXXX 任务执行DAG，XXX &amp; 测试上线时间缩短 30%；</li>
<li>实现XXX验证器、XXXX 路由、XXXX处理、XXXX补偿 &amp; XXXX重试等技术手段，XXX成功率提升XXX;</li>
<li>分布式限流，分布式调度任务灵活配置任务执行时间区间、频率、执行参数;</li>
</ol>
<h2 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h2><h3 id="公司和项目经验是否分开？"><a href="#公司和项目经验是否分开？" class="headerlink" title="公司和项目经验是否分开？"></a>公司和项目经验是否分开？</h3><p>很多人喜欢公司和项目经历分开，我觉得其实没必要，本来工作经历就是跟公司绑定的。PS：仁者见仁智者见智，你有不同的想法，按照你觉得 OK 的改好了。</p>
<h3 id="博客、Github-是否放到简历上？"><a href="#博客、Github-是否放到简历上？" class="headerlink" title="博客、Github 是否放到简历上？"></a>博客、Github 是否放到简历上？</h3><p>简而言之：<strong>有亮点！</strong>如果你的博客或者 Github 上有原创比较有深度的文章或者给某些<strong>知名开源项目提交过有意义的代码</strong>，写上去会帮你加分。反之，则不建议放上去。</p>
<blockquote>
<p>推荐一个在线编辑简历的网址 【<a href="http://cv.ftqq.com" target="_blank" rel="noopener">冷熊简历</a>】,他也给了一定建议，可以参考，按照相应的格式编写好你的简历，然后导出成 PDF 就可以了。</p>
</blockquote>
]]></content>
      <categories>
        <category>面试</category>
      </categories>
      <tags>
        <tag>简历</tag>
      </tags>
  </entry>
  <entry>
    <title>【Git 系列】基础知识</title>
    <url>/2021/10/18/ecdabc1a.html</url>
    <content><![CDATA[<p><code>Git</code> 是一种分布式版本控制系统，它可以不受网络连接的限制，加上其它众多优点，目前已经成为程序开发人员做项目版本管理时的首选，非开发人员也可以用 <code>Git</code> 来做自己的文档版本管理工具。</p>
<a id="more"></a>

<h2 id="一、Git-基础"><a href="#一、Git-基础" class="headerlink" title="一、Git 基础"></a>一、Git 基础</h2><h3 id="1-1-Git-与-SVN-区别"><a href="#1-1-Git-与-SVN-区别" class="headerlink" title="1.1 Git 与 SVN 区别"></a>1.1 Git 与 SVN 区别</h3><p><code>Git</code> 不仅仅是个版本控制系统，它也是个内容管理系统(<code>CMS</code>)，工作管理系统等。</p>
<p>如果你是一个具有使用 <code>SVN</code> 背景的人，你需要做一定的思想转换，来适应 <code>Git</code> 提供的一些概念和特征。</p>
<p><code>Git</code> 与 <code>SVN</code> 区别点：</p>
<ol>
<li><code>Git</code> 是分布式的，<code>SVN</code> 不是：这是 <code>Git</code> 和其它非分布式的版本控制系统，例如 <code>SVN</code>，<code>CVS</code> 等，最核心的区别。</li>
<li><code>Git</code> 把内容按元数据方式存储，而 <code>SVN</code> 是按文件：所有的资源控制系统都是把文件的元信息隐藏在一个类似 <code>.svn</code>、<code>.cvs</code> 等的文件夹里。</li>
<li><code>Git</code> 分支和 <code>SVN</code> 的分支不同：分支在 <code>SVN</code> 中一点都不特别，其实它就是版本库中的另外一个目录。</li>
<li><code>Git</code> 没有一个全局的版本号，而 <code>SVN</code> 有：目前为止这是跟 <code>SVN</code> 相比 <code>Git</code> 缺少的最大的一个特征。</li>
<li><code>Git</code> 的内容完整性要优于 <code>SVN</code> ：<code>Git</code> 的内容存储使用的是 <code>SHA-1</code> 哈希算法。这能确保代码内容的完整性，确保在遇到磁盘故障和网络问题时降低对版本库的破坏。</li>
</ol>
<h3 id="1-2-版本控制"><a href="#1-2-版本控制" class="headerlink" title="1.2 版本控制"></a>1.2 版本控制</h3><p>版本控制（<code>Revision control</code>）是一种在开发的过程中用于管理我们对文件、目录或工程等内容的修改历史，方便查看更改历史记录，备份以便恢复以前的版本的软件工程技术。一句话就是用于管理多人协同开发项目的技术。</p>
<ul>
<li>优点</li>
</ul>
<ol>
<li>实现跨区域多人协同开发；</li>
<li>追踪和记载一个或者多个文件的历史记录；</li>
<li>组织和保护你的源代码和文档；</li>
<li>统计工作量；</li>
<li>并行开发、提高开发效率；</li>
<li>跟踪记录整个软件的开发过程；</li>
<li>减轻开发人员的负担，节省时间，同时降低人为错误。</li>
</ol>
<h3 id="1-3-Git-工作区、暂存区和版本库"><a href="#1-3-Git-工作区、暂存区和版本库" class="headerlink" title="1.3 Git 工作区、暂存区和版本库"></a>1.3 Git 工作区、暂存区和版本库</h3><ol>
<li><p>工作区：就是你在电脑里能看到的目录。</p>
</li>
<li><p>版本库：工作区有一个隐藏目录 <code>.git</code>，这个不算工作区，而是 <code>Git</code> 的版本库。</p>
</li>
<li><p>暂存区：本地版本库里存了很多东西，其中最重要的就是称为 <code>stage</code>（或者叫index）的暂存区。</p>
</li>
</ol>
<p>下面这个图展示了工作区、版本库中的暂存区和版本库之间的关系：</p>
<p><img src="/File/Imgs/Git/Git_info_01.png" alt="Git_info_01"></p>
<h3 id="1-4-分支"><a href="#1-4-分支" class="headerlink" title="1.4 分支"></a>1.4 分支</h3><p>分支是为了将修改记录的整个流程分开存储，让分开的分支不受其它分支的影响，所以在同一个数据库里可以同时进行多个不同的修改。</p>
<ul>
<li>主分支（Master）</li>
</ul>
<p>是 Git 为我们自动创建的第一个分支，也叫主分支，其它分支开发完成后都要合并到 master</p>
<ul>
<li>分支合并（Merge）</li>
</ul>
<p>将某分支上的更改联接到此主干或同为主干的另一个分支。</p>
<ul>
<li>合并冲突（Conflict）</li>
</ul>
<p>多人对同一文件的工作副本进行更改，并将这些更改提交到仓库。</p>
<h3 id="1-5-标签"><a href="#1-5-标签" class="headerlink" title="1.5 标签"></a>1.5 标签</h3><p>标签是用于标记特定的点或提交的历史，通常会用来标记发布版本的名称或版本号（如：<code>publish/0.0.1</code>），虽然标签看起来有点像分支，但打上标签的提交是固定的，不能随意的改动。</p>
<h3 id="1-6-头（HEAD）"><a href="#1-6-头（HEAD）" class="headerlink" title="1.6 头（HEAD）"></a>1.6 头（HEAD）</h3><p>头是一个象征性的参考，最常用以指向当前选择的分支。</p>
<h2 id="二、四个区域"><a href="#二、四个区域" class="headerlink" title="二、四个区域"></a>二、四个区域</h2><h3 id="2-1-Workspace：工作区"><a href="#2-1-Workspace：工作区" class="headerlink" title="2.1 Workspace：工作区"></a>2.1 Workspace：工作区</h3><ol>
<li>程序员进行开发改动的地方，是你当前看到的，也是最新的；</li>
<li>平常我们开发就是拷贝远程仓库中的一个分支，基于该分支进行开发。在开发过程中就是对工作区的操作。</li>
</ol>
<h3 id="2-2-Index-Stage：暂存区"><a href="#2-2-Index-Stage：暂存区" class="headerlink" title="2.2 Index / Stage：暂存区"></a>2.2 Index / Stage：暂存区</h3><ol>
<li><code>.git</code> 目录下的 <code>index</code> 文件, 暂存区会记录 <code>git add</code> 添加文件的相关信息(文件名、大小、<code>timestamp</code>…)，不保存文件实体, 通过 <code>id</code> 指向每个文件实体。可以使用 <code>git status</code> 查看暂存区的状态。暂存区标记了你当前工作区中，哪些内容是被 <code>Git</code> 管理的；</li>
<li>当你完成某个需求或功能后需要提交到远程仓库，那么第一步就是通过<code>git add</code> 先提交到暂存区，被 <code>Git</code> 管理。</li>
</ol>
<h3 id="2-3-Repository：本地仓库"><a href="#2-3-Repository：本地仓库" class="headerlink" title="2.3 Repository：本地仓库"></a>2.3 Repository：本地仓库</h3><ol>
<li>保存了对象被提交 过的各个版本，比起工作区和暂存区的内容，它要更旧一些；</li>
<li><code>git commit</code> 后同步 <code>index</code> 的目录树到本地仓库，方便从下一步通过 <code>git push</code> 同步本地仓库与远程仓库的同步。</li>
</ol>
<h3 id="2-4-Remote：远程仓库"><a href="#2-4-Remote：远程仓库" class="headerlink" title="2.4 Remote：远程仓库"></a>2.4 Remote：远程仓库</h3><p>远程仓库的内容可能被分布在多个地点的处于协作关系的本地仓库修改，因此它可能与本地仓库同步，也可能不同步，但是它的内容是最旧的。</p>
<h3 id="2-5-四个区域的关系"><a href="#2-5-四个区域的关系" class="headerlink" title="2.5 四个区域的关系"></a>2.5 四个区域的关系</h3><ol>
<li>任何对象都是在工作区中诞生和被修改；</li>
<li>任何修改都是从进入 index 区才开始被版本控制；</li>
<li>只有把修改提交到本地仓库，该修改才能在仓库中留下痕迹；</li>
<li>与协作者分享本地的修改，可以把它们 push 到远程仓库来共享。</li>
</ol>
<h2 id="三、Git-文件操作"><a href="#三、Git-文件操作" class="headerlink" title="三、Git 文件操作"></a>三、Git 文件操作</h2><blockquote>
<p>版本控制就是对文件的版本控制：首先要知道文件当前在什么状态，然后才能对文件进行修改、提交等操作，不然可能会提交了现在还不想提交的文件。</p>
</blockquote>
<h3 id="3-1-文件的四种状态"><a href="#3-1-文件的四种状态" class="headerlink" title="3.1 文件的四种状态"></a>3.1 文件的四种状态</h3><ol>
<li><code>Untracked</code>: 未跟踪, 此文件在文件夹中, 但并没有加入到 <code>Git</code> 库, 不参与版本控制.通过 <code>git add</code> 状态变为 <code>Staged</code>;</li>
<li><code>Unmodify</code>: 文件已经入库, 未修改, 即版本库中的文件快照内容与文件夹中完全一致. 这种类型的文件有两种去处, 如果它被修改, 而变为 <code>Modified.</code> 如果使用 <code>git rm</code> 移出版本库, 则成为 <code>Untracked</code> 文件;</li>
<li><code>Modified</code>: 文件已修改, 仅仅是修改, 并没有进行其他的操作. 这个文件也有两个去处,通过 <code>git add</code> 可进入暂存 <code>staged</code> 状态, 使用 <code>git checkout</code>则丢弃修改过, 返回到 <code>unmodify</code> 状态, 这个 <code>git checkout</code> 即从库中取出文件, 覆盖当前修改;</li>
<li><code>Staged</code>: 暂存状态.执行 <code>git commit</code> 则将修改同步到库中, 这时库中的文件和本地文件又变为一致, 文件为 <code>Unmodify</code> 状态. 执行 <code>git reset HEAD filename</code> 取消暂存, 文件状态为 <code>Modified</code>。</li>
</ol>
<h3 id="3-2-查看文件状态"><a href="#3-2-查看文件状态" class="headerlink" title="3.2 查看文件状态"></a>3.2 查看文件状态</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git status # 添加指定文件到暂存区；</span><br><span class="line">git add (dir) # 添加当前目录的所有文件到暂存区。</span><br></pre></td></tr></table></figure>

<h3 id="3-3-移除文件与目录（撤销-add）"><a href="#3-3-移除文件与目录（撤销-add）" class="headerlink" title="3.3 移除文件与目录（撤销 add）"></a>3.3 移除文件与目录（撤销 add）</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git rm --cached # 直接从暂存区删除文件，工作区不做出改变</span><br><span class="line">git checkout . # 用赞寻去全部或指定文件替换工作区的文件，这个操作很危险，会清楚工作区中未添加到暂存区的改动。</span><br><span class="line">git clean # 一般会加上参数 -df，-d 表示包含目录，-f 表示强制清除；</span><br></pre></td></tr></table></figure>

<h3 id="3-4-查看文件修改后的差异"><a href="#3-4-查看文件修改后的差异" class="headerlink" title="3.4 查看文件修改后的差异"></a>3.4 查看文件修改后的差异</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git status # 只能查看对哪些文件做了改动，如果要看改动了什么，可以用;</span><br><span class="line">git diff (files) # 查看文件修改后的差异</span><br></pre></td></tr></table></figure>

<p>此外，还有以下两个常用命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git diff --cached # 比较暂存区的文件与之前已经提交过的文件</span><br><span class="line">git diff HEAD~n # 比较 repo 与工作空间中的文件差异</span><br></pre></td></tr></table></figure>

<h3 id="3-5-签出"><a href="#3-5-签出" class="headerlink" title="3.5 签出"></a>3.5 签出</h3><ul>
<li>使用情景</li>
</ul>
<p>该文件已经存在仓库中，工作区已经对其进行修改过了，如果想撤销修改，可以使用 <code>checkout</code>。</p>
<p><strong>检出命令git checkout 是 git 最常用的命令之一，同时也是一个很危险的命令，因为折腾命令会重写工作区。</strong></p>
<h3 id="3-6-提交"><a href="#3-6-提交" class="headerlink" title="3.6 提交"></a>3.6 提交</h3><blockquote>
<p>通过 <code>add</code> 只是将文件或者目录添加到 <code>index</code> 即暂存区，使用 <code>commit</code> 可以实现将暂存区的文件提交到本地仓库。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git commit -m [message] # 提交暂存区到仓库区</span><br><span class="line">git commit [file1] [file2] ... -m [message] # 提交暂存区的指定文件到仓库区</span><br><span class="line">git commit -a # 提交工作区自上次 commit 之后的变化，直接到仓库区，跳过了 add,对新文件无效</span><br><span class="line">git commit -v # 提交时显示所有 diff 信息</span><br></pre></td></tr></table></figure>

<h3 id="3-7-撤销更新"><a href="#3-7-撤销更新" class="headerlink" title="3.7 撤销更新"></a>3.7 撤销更新</h3><ul>
<li>撤销暂存区更新</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git reset HEAD [filename] # 将暂存区指定文件移出到工作区</span><br></pre></td></tr></table></figure>

<ul>
<li>撤销本地仓库更新</li>
</ul>
<p>放弃工作区和暂存区的改动，同时 <code>HEAD</code> 指针指向前一个 <code>commit</code> 对象：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git log  #查看提交日志，  </span><br><span class="line">git reset --hard HELD~1  #撤销了上一次的提交，这里的上一次提交日志就不存在了。</span><br><span class="line">cat [filename]  #查看文件内内容</span><br><span class="line">git revert #把指定的提交修改回滚，并同时生成一个新的提交</span><br></pre></td></tr></table></figure>

<h3 id="3-8-日志与历史"><a href="#3-8-日志与历史" class="headerlink" title="3.8 日志与历史"></a>3.8 日志与历史</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git log #查看所有提交日志；</span><br><span class="line">git log [filename] #查看某文件提交日志；</span><br><span class="line">history #查看在 bash 下输入过的指令；</span><br><span class="line">git reflog #查看仓库中所有分支的所有更新记录，包括已经撤销的更新。</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="四、Git-配置"><a href="#四、Git-配置" class="headerlink" title="四、Git 配置"></a>四、Git 配置</h2><h3 id="4-1-分类介绍"><a href="#4-1-分类介绍" class="headerlink" title="4.1 分类介绍"></a>4.1 分类介绍</h3><blockquote>
<p><code>Git</code> 配置文件有三个级别，分别是系统级别、全局级别以及仓库级别。下面的表格展示了各个级别的配置的具体信息：</p>
</blockquote>
<table>
<thead>
<tr>
<th>配置级别</th>
<th>文件位置</th>
<th>配置命令</th>
<th>优先级别</th>
</tr>
</thead>
<tbody><tr>
<td>系统</td>
<td>Git 安装目录\etc\gitconfig</td>
<td>git config –system</td>
<td>低</td>
</tr>
<tr>
<td>全局</td>
<td>用户文件夹.gitconfig</td>
<td>git config –global</td>
<td>中</td>
</tr>
<tr>
<td>仓库</td>
<td>仓库文件夹.git\config</td>
<td>git config –local</td>
<td>高</td>
</tr>
</tbody></table>
<h2 id="4-2-Git-常用配置命令"><a href="#4-2-Git-常用配置命令" class="headerlink" title="4.2 Git 常用配置命令"></a>4.2 Git 常用配置命令</h2><ul>
<li>对全局的 <code>Git</code> 用户名和邮箱进行配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;xxxx&quot; ：设置所有仓库提交的用户名</span><br><span class="line">git config --global user.email &quot;xxxx@example.com&quot;：设置所有仓库提交的邮箱</span><br></pre></td></tr></table></figure>

<ul>
<li>查看所有配置或某一项配置：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global  --list;</span><br><span class="line">git config --global  --get user.name;</span><br><span class="line">git config --global  --get user.email;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>系统和当前项目的命令同上，仅需将<code>global</code>改为<code>system</code>/<code>local</code>即可。</p>
</blockquote>
<h2 id="五、本地仓库"><a href="#五、本地仓库" class="headerlink" title="五、本地仓库"></a>五、本地仓库</h2><blockquote>
<p>创建本地仓库的方法有两种：一种是创建全新的仓库，另一种是克隆远程仓库。</p>
</blockquote>
<h3 id="5-1-创建全新仓库"><a href="#5-1-创建全新仓库" class="headerlink" title="5.1 创建全新仓库"></a>5.1 创建全新仓库</h3><ul>
<li>使用当前目录作为 <code>Git</code> 仓库</li>
</ul>
<p>只需使它初始化：<code>git init</code> ；执行后可以看到，仅仅在项目目录多出了一个<code>.git</code> 目录；</p>
<ul>
<li>使用指定目录作为 <code>Git</code> 仓库</li>
</ul>
<p>使用如下命令，可以把创建目录与仓库一起完成：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git init [project-name] # 新建一个目录，将其初始化为 Git 代码库</span><br></pre></td></tr></table></figure>

<h3 id="5-2-克隆远程仓库"><a href="#5-2-克隆远程仓库" class="headerlink" title="5.2 克隆远程仓库"></a>5.2 克隆远程仓库</h3><ol>
<li>将远程服务器上的仓库完全镜像一份至本地，而不是取某一个特定版本，所以用 <code>clone</code> 而不是 <code>checkout</code>，语法格式为：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone (url)</span><br></pre></td></tr></table></figure>

<p>例如：我们要从克隆的远程仓库托管在 <code>Github</code> 上，首先，我们先前往 <code>Github</code> 上拷贝地址如：<br><a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">https://github.com/vanDusty/Java-Note</a>，然后执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;vanDusty&#x2F;Java-Note</span><br></pre></td></tr></table></figure>

<p>克隆远程仓库到当前目录。</p>
<h3 id="5-3-Git-仓库目录结构"><a href="#5-3-Git-仓库目录结构" class="headerlink" title="5.3 Git 仓库目录结构"></a>5.3 Git 仓库目录结构</h3><ul>
<li>初始化仓库使用 <code>git init</code> 命令，初始目录（<code>.git</code>）结构：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.git</span><br><span class="line">├── branches</span><br><span class="line">├── config</span><br><span class="line">├── description</span><br><span class="line">├── HEAD</span><br><span class="line">├── hooks</span><br><span class="line">│   ├── applypatch-msg.sample</span><br><span class="line">│   ├── commit-msg.sample</span><br><span class="line">│   ├── post-update.sample</span><br><span class="line">│   ├── pre-applypatch.sample</span><br><span class="line">│   ├── pre-commit.sample</span><br><span class="line">│   ├── prepare-commit-msg.sample</span><br><span class="line">│   ├── pre-push.sample</span><br><span class="line">│   ├── pre-rebase.sample</span><br><span class="line">│   └── update.sample</span><br><span class="line">├── info</span><br><span class="line">│   └── exclude</span><br><span class="line">├── objects</span><br><span class="line">│   ├── info</span><br><span class="line">│   └── pack</span><br><span class="line">└── refs</span><br><span class="line">    ├── heads</span><br><span class="line">    └── tags</span><br><span class="line"> </span><br><span class="line">9 directories, 13 files</span><br></pre></td></tr></table></figure>

<ul>
<li>这个初始化后的仓库，当创建完分支 <code>dev-branch</code>，并 <code>push</code> 后的目录结构：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.git/</span><br><span class="line">├── branches</span><br><span class="line">├── COMMIT_EDITMSG</span><br><span class="line">├── config</span><br><span class="line">├── description</span><br><span class="line">├── HEAD</span><br><span class="line">├── hooks</span><br><span class="line">│   ├── applypatch-msg.sample</span><br><span class="line">│   ├── commit-msg.sample</span><br><span class="line">│   ├── post-update.sample</span><br><span class="line">│   ├── pre-applypatch.sample</span><br><span class="line">│   ├── pre-commit.sample</span><br><span class="line">│   ├── prepare-commit-msg.sample</span><br><span class="line">│   ├── pre-push.sample</span><br><span class="line">│   ├── pre-rebase.sample</span><br><span class="line">│   └── update.sample</span><br><span class="line">├── index</span><br><span class="line">├── info</span><br><span class="line">│   └── exclude</span><br><span class="line">├── logs</span><br><span class="line">│   ├── HEAD</span><br><span class="line">│   └── refs</span><br><span class="line">│       ├── heads</span><br><span class="line">│       │   ├── dev-branch</span><br><span class="line">│       │   └── master</span><br><span class="line">│       └── remotes</span><br><span class="line">│           └── origin</span><br><span class="line">│               └── master</span><br><span class="line">├── objects</span><br><span class="line">│   ├── 2d</span><br><span class="line">│   │   └── d2c71b69c837a7459f4bd9c9f7db6520731d06</span><br><span class="line">│   ├── 5c</span><br><span class="line">│   │   └── 7b8eda18a75e13d27c31e65a54b0abd7948510</span><br><span class="line">│   ├── 77</span><br><span class="line">│   │   └── cad3aecf7c2754231095598119979d62a1e1da</span><br><span class="line">│   ├── info</span><br><span class="line">│   └── pack</span><br><span class="line">└── refs</span><br><span class="line">    ├── heads</span><br><span class="line">    │   ├── dev-branch</span><br><span class="line">    │   └── master</span><br><span class="line">    ├── remotes</span><br><span class="line">    │   └── origin</span><br><span class="line">    │       └── master</span><br><span class="line">    └── tags</span><br><span class="line"> </span><br><span class="line">19 directories, 25 files</span><br></pre></td></tr></table></figure>

<h3 id="5-4-目录结构说明"><a href="#5-4-目录结构说明" class="headerlink" title="5.4 目录结构说明"></a>5.4 目录结构说明</h3><ul>
<li><code>branches</code> 目录</li>
</ul>
<p>一种不常用的存储速记方式，用于指定 <code>git fetch</code> ，<code>git pull</code> 和 <code>git push</code> 的 <code>URL</code> ，目前已基本不用。</p>
<ul>
<li><code>COMMIT_EDITMSG</code> 文件</li>
</ul>
<p><code>commit</code> 编辑信息，仅记录最近一次提交的 <code>commit</code> 编辑信息。</p>
<ul>
<li><code>config</code> 文件</li>
</ul>
<p>存储当前仓库的配置信息</p>
<ul>
<li><code>description</code> 文件</li>
</ul>
<p>用于在 <code>GitWeb</code> 中展示项目的描述信息。</p>
<ul>
<li><code>HEAD</code> 文件</li>
</ul>
<p>存储 HEAD 指针，指向当前分支，即：记录当前活动分支。</p>
<ul>
<li><code>hooks</code> 目录</li>
</ul>
<p>目录下存储了许多钩子文件（一些脚本），这些文件是各种 <code>Git</code> 命令使用的自定义脚本，可以在 <code>Git</code> 特定阶段自动执行。</p>
<ul>
<li><code>index</code> 文件</li>
</ul>
<p>暂存区（<code>stage</code>），二进制文件。</p>
<ul>
<li><code>info</code> 目录</li>
</ul>
<p>存储库的其他信息将记录在此目录中。</p>
<ul>
<li><code>logs</code> 目录</li>
</ul>
<p>保存所有更新的引用记录。</p>
<ul>
<li><code>objects</code> 目录</li>
</ul>
<p>简单理解就是：<code>objects</code> 目录是 <code>Git</code> 的数据库，存储所有数据内容。</p>
<ul>
<li><code>refs</code> 目录</li>
</ul>
<p>（1）<code>heads</code> 目录</p>
<p>目录有以各个本地分支名命名的文件，保存对应分支最新提交的 <code>ID</code>，是通过 <code>SHA1</code> 算法计算的一个字符串。</p>
<p>（2）<code>remotes</code> 目录</p>
<p>目录有以各个远程分支名命名的文件，保存对应分支最新提交的 <code>ID</code>，和 <code>heads</code> 目录一个原理。</p>
<p>（3）<code>tags</code> 目录</p>
<p>存储在开发过程中打的标签，里面的文件以标签名命令，文件内容为对应的 <code>ID</code> 。</p>
<h2 id="六、远程仓库"><a href="#六、远程仓库" class="headerlink" title="六、远程仓库"></a>六、远程仓库</h2><blockquote>
<p>Git 是分布式版本控制系统，同一个 <code>Git</code> 仓库，可以分布到不同的机器上，即发布到不同的远程仓库上。</p>
</blockquote>
<h3 id="6-1-常见的托管平台"><a href="#6-1-常见的托管平台" class="headerlink" title="6.1 常见的托管平台"></a>6.1 常见的托管平台</h3><ul>
<li>GitHub</li>
</ul>
<p>对，就是那个“全世界最大同性交友网站”。<a href="https://github.com" target="_blank" rel="noopener">https://github.com</a></p>
<p>绝大多数好的开源项目都来自 GitHub，但是 GitHub 只能新建公开的 Git 仓库，私有仓库要收费，有时候访问比较卡，如果你做的是一个开源项目，可以首选 GitHub。</p>
<ul>
<li>Gitlab</li>
</ul>
<p>提到 GitHub 就会自然的想到 Gitlab，Gitlab 支持无限的公有项目和私有项目。<a href="https://about.gitlab.com" target="_blank" rel="noopener">https://about.gitlab.com</a></p>
<ul>
<li>Bitbucket</li>
</ul>
<p>Bitbucket免费支持 5 个开发成员的团队创建无限私有代码托管库。<a href="https://bitbucket.org" target="_blank" rel="noopener">https://bitbucket.org</a></p>
<ul>
<li>Gitee 码云</li>
</ul>
<p>前面说的都是国外的，下面来说几个国内的。码云，个人开发者可免费创建 1000 个项目（不限公有、私有），提供最多 5G 的免费代码存储空间。<a href="http://git.oschina.net" target="_blank" rel="noopener">http://git.oschina.net</a>，</p>
<ul>
<li>Coding.net</li>
</ul>
<p>谈到 Coding.net,首先必须提的是速度快，同样一个账号最多可以创建 1000 个项目(5 个私有)，也支持任务的创建等。<a href="https://coding.net" target="_blank" rel="noopener">https://coding.net</a></p>
<h3 id="6-2-远程仓库操作"><a href="#6-2-远程仓库操作" class="headerlink" title="6.2 远程仓库操作"></a>6.2 远程仓库操作</h3><p>申请到了 <code>Git</code> 远程仓库的帐号并创建了一个空的远程仓库现在我们就可以结合本地的仓库与远程仓库一起协同工作了，多人协同开发，这也是我们工作时的情形，这里我们全部使用命令完成（实际开发中很多开发工具例如：<code>IDEA</code> 等，无需命令操作）。</p>
<ul>
<li>克隆项目</li>
</ul>
<p>远程操作的第一步，通常是从远程主机克隆一个版本库，这时就要用到 <code>git clone</code> 命令，例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;vanDusty&#x2F;Java-Note</span><br></pre></td></tr></table></figure>

<p>该命令会在本地主机生成一个目录，与远程主机的版本库同名。如果要指定不同的目录名，可以将目录名作为 <code>git clone</code> 命令的第二个参数。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone &lt;版本库的网址&gt; &lt;本地目录名&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>git clone 支持多种协议</strong><br>除了 <code>HTTP(s)</code>以外，还支持 <code>SSH</code>、<code>Git</code>、本地文件协议等。通常来说，<code>Git</code> 协议下载速度最快，<code>SSH</code> 协议用于需要用户认证的场合。各种协议优劣的详细讨论请参考官方文档。</p>
</blockquote>
<ul>
<li><code>git remote</code></li>
</ul>
<p>为了便于管理，<code>Git</code> 要求每个远程主机都必须指定一个主机名。<code>git remote</code> 命令就用于管理主机名。<br>不带选项的时候， <code>git remote</code> 命令列出所有远程主机名。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git remote -v  #参看远程主机的网址。</span><br></pre></td></tr></table></figure>

<p>结果表示，当前只有一台远程主机，叫做 <code>origin</code>，以及它的网址。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">origin  git@github.com:jquery&#x2F;jquery.git (fetch)</span><br><span class="line">origin  git@github.com:jquery&#x2F;jquery.git (push)</span><br></pre></td></tr></table></figure>

<p>克隆版本库的时候，所使用的远程主机自动被 <code>Git</code> 命名为 <code>origin</code> 。如果想用其他的主机名，需要用 <code>git clone</code> 命令的 <code>-o</code> 选项指定：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone -o dusty https:&#x2F;&#x2F;github.com&#x2F;vanDusty&#x2F;Java-Note</span><br></pre></td></tr></table></figure>

<p>上面命令表示，克隆的时候，指定远程主机叫做 <code>dusty</code></p>
<p>更多命令如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ git remote show &lt;主机名&gt;  #查看该主机的详细信息</span><br><span class="line">$ git remote add &lt;主机名&gt; &lt;网址&gt; #添加远程主机</span><br><span class="line">$ git remote rm &lt;主机名&gt; #删除远程主机</span><br><span class="line">$ git remoterename&lt;原主机名&gt; &lt;新主机名&gt; #远程主机的改名</span><br></pre></td></tr></table></figure>

<ul>
<li><code>git fetch</code></li>
</ul>
<p>一旦远程主机的版本库有了更新，需要将这些更新取回本地，这时就要用到该命令。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git fetch  #将某个远程主机的更新，全部取回本地。</span><br><span class="line">git fetch &lt;远程主机名&gt; &lt;分支名&gt; #取回指定主机名的指定分支</span><br></pre></td></tr></table></figure>

<p>所取回的更新，在本地主机上要用”远程主机名/分支名”的形式读取。比如 <code>origin</code> 主机的 <code>master</code>，就要用 <code>origin/master</code> 读取。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git checkout -b newBrach origin&#x2F;master  #在 origin&#x2F;master 的基础上，创建一个新分支。</span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>git merge</code> 命令或者 <code>git rebase</code> 命令，在本地分支上合并远程分支。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git merge origin&#x2F;master #或者$ git rebase origin&#x2F;master</span><br></pre></td></tr></table></figure>

<ul>
<li><code>git pull</code></li>
</ul>
<p><code>git pull</code> 命令的作用是，取回远程主机某个分支的更新，再与本地的指定分支合并。它的完整格式稍稍有点复杂。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git pull &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;</span><br></pre></td></tr></table></figure>

<p>示例：取回 <code>origin</code> 主机的 <code>master</code> 分支，与本地的 <code>develop</code> 分支合并:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git pull origin master:develop</span><br></pre></td></tr></table></figure>

<p>如果远程分支( <code>master</code>)要与当前分支合并，则冒号后面的部分可以省略。可以简写为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git pull origin master</span><br></pre></td></tr></table></figure>

<p>上面命令表示，取回 <code>origin/master</code> 分支，再与当前分支合并。实质上，这等同于先做 <code>git fetch</code> ，再做 <code>git merge</code> 。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git fetch origin</span><br><span class="line">git merge master&#x2F;develop</span><br></pre></td></tr></table></figure>

<ul>
<li><code>git fetch</code> 和 <code>git pull</code> 的区别</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git fetch：相当于是从远程获取最新版本到本地，不会自动合并。</span><br><span class="line">git pull：相当于是从远程获取最新版本并merge到本地</span><br></pre></td></tr></table></figure>

<h2 id="七、Git-命令"><a href="#七、Git-命令" class="headerlink" title="七、Git 命令"></a>七、Git 命令</h2><blockquote>
<p>偷个懒，发现一个很全的【<a href="https://github.com/xjh22222228/git-manual" target="_blank" rel="noopener">Git常用命令参考手册</a>】</p>
</blockquote>
]]></content>
      <categories>
        <category>Git 系列</category>
      </categories>
      <tags>
        <tag>基础知识</tag>
      </tags>
  </entry>
  <entry>
    <title>【MySQL】主从同步</title>
    <url>/2021/10/02/bab1265d.html</url>
    <content><![CDATA[<p>面试中，经常被问到MySQL中主从同步的原理是什么？什么是主从延迟？如何解决主从同步延迟问题？</p>
<a id="more"></a>

<p>随着业务量的增长，高并发，数据库服务器宕机等问题频繁出现，单台MySQL服务器将会成为系统瓶颈。</p>
<p>为了解决此问题，通常会使用集群主从同步模式（Master-Slave）来同步数据，通过读写分离（MySQL-Proxy）来提升数据库的并发负载能力。</p>
<h2 id="一、先认识主角【binlog】"><a href="#一、先认识主角【binlog】" class="headerlink" title="一、先认识主角【binlog】"></a>一、先认识主角【binlog】</h2><blockquote>
<p>MySQL主从之间数据同步主要通过 <code>binlog</code> 日志实现。</p>
</blockquote>
<h3 id="1-1-binlog"><a href="#1-1-binlog" class="headerlink" title="1.1 binlog"></a>1.1 <code>binlog</code></h3><p>是指用于记录数据库执行的写入性操作(不包括查询)信息，以二进制的形式保存在磁盘中，可以简单理解为记录的就是sql语句。</p>
<h3 id="1-2-binlog-主要使用场景"><a href="#1-2-binlog-主要使用场景" class="headerlink" title="1.2 binlog 主要使用场景"></a>1.2 <code>binlog</code> 主要使用场景</h3><ol>
<li>用于主从复制，在主从结构中，<code>binlog</code> 作为操作记录从 <code>master</code> 被发送到 <code>slave</code>，<code>slave</code> 服务器从 <code>master</code> 接收到的日志保存到 <code>relay log</code> 中；</li>
<li>用于数据备份，在数据库备份文件生成后，<code>binlog</code> 保存了数据库备份后的详细信息，以便下一次备份能从备份点开始；</li>
</ol>
<h3 id="1-3-binlog-格式"><a href="#1-3-binlog-格式" class="headerlink" title="1.3 binlog 格式"></a>1.3 <code>binlog</code> 格式</h3><p>有三种格式，分别为 <code>Statement</code> 、 <code>Row</code> 和 <code>Mixed</code>。</p>
<ul>
<li><code>Statement</code>格式 </li>
</ul>
<p>基于<code>sql</code>语句的复制，每一条会修改数据的<code>sql</code>都会记录在<code>binlog</code>中。</p>
<ol>
<li>优点：不需要记录每一行的变化，减少了<code>binlog</code>日志量，节约了<code>IO</code>，提高性能；</li>
<li>缺点：由于记录的只是执行语句，但由于<code>sql</code>的执行是有上下文的,因此在保存的时候需要保存相关的信息,同时还有一些使用了函数(比如 <code>uuid()</code> 函数)之类的语句无法被记录复制。</li>
</ol>
<ul>
<li><code>Row</code>格式</li>
</ul>
<p>基于行的复制，记录单元为每一行的改动,基本是可以全部记下来。</p>
<ol>
<li>优点：会记录每次操作的源数据与修改后的目标数据,绝对精准的还原，从而保证了数据的安全与可靠，并且复制和数据恢复过程可以是并发进行的;</li>
<li>缺点：可能会导致大量行的改动(比如<code>alter table</code>),这种模式的文件保存的信息太多,日志量太大。</li>
</ol>
<ul>
<li><code>Mixed</code>格式</li>
</ul>
<p>一种折中的方案,普通操作使用<code>Statement</code>记录，当无法使用<code>Statement</code>的时候使用<code>Row</code>。</p>
<h2 id="二、主从同步过程"><a href="#二、主从同步过程" class="headerlink" title="二、主从同步过程"></a>二、主从同步过程</h2><h3 id="2-1-主从同步优势"><a href="#2-1-主从同步优势" class="headerlink" title="2.1 主从同步优势"></a>2.1 主从同步优势</h3><ol>
<li>读写分离，缓解数据库压力(主数据库用来做数据写入，从数据库用来做数据读取)；</li>
<li>一主多从，系统可拓展性和高可用性；</li>
<li>数据备份容灾，异地双活，保证主库异常随时切换，提高系统容错能力。</li>
</ol>
<h3 id="2-2-实现过程"><a href="#2-2-实现过程" class="headerlink" title="2.2 实现过程"></a>2.2 实现过程</h3><p><img src="#" alt="风尘博客"></p>
<ol>
<li><code>master</code>库上的数据发生改变时，则将其改变写入<code>binlog</code>中；</li>
<li><code>slave</code>库在一定时间间隔内对<code>master</code>进行<code>binlog</code>探测是否发生改变，如发生改变，则开启<code>I/O</code>线程连接<code>Master</code>事件，请求从执行<code>binlog</code>日志文件中的指定位置，开始读取<code>binlog</code>至<code>slave</code>库；</li>
<li><code>master</code>库接收到从库的<code>IO</code>线程请求后，其上复制的<code>dump</code>线程会根据<code>Slave</code>的请求信息分批读取<code>binlog</code>文件然后返回给从库的<code>IO</code>线程；</li>
<li><code>slave</code>库的<code>I/O</code>线程获取到<code>master</code>库上<code>IO</code>线程发送的日志内容后，会将<code>binlog</code>日志内容依次写到<code>slave</code>库的<code>relay Log</code>（即中继日志）文件的最末端,并将新的<code>binlog</code>文件名和位置记录到<code>master-info</code>文件中，以便下一次读取<code>master</code>库<code>binlog</code>日志时能告诉<code>master</code>服务器从新<code>binlog</code>日志的指定文件及位置开始读取新的<code>binlog</code>日志内容；</li>
<li><code>slave</code>库服务器的<code>SQL</code>线程会实时监测到本地<code>relay log</code>中新增了日志内容，然后把<code>relay log</code>中的日志翻译成<code>sql</code>并且按照顺序执行<code>sql</code>来更新从库的数据。</li>
</ol>
<h2 id="三、主从延迟"><a href="#三、主从延迟" class="headerlink" title="三、主从延迟"></a>三、主从延迟</h2><h3 id="3-1-产生延迟的原因"><a href="#3-1-产生延迟的原因" class="headerlink" title="3.1 产生延迟的原因"></a>3.1 产生延迟的原因</h3><ul>
<li>从库的机器性能比主库要差</li>
</ul>
<p>比如将<code>20</code>台主库放在<code>4</code>台机器，把从库放在一台机器。这个时候进行更新操作，由于更新时会触发大量读操作，导致从库机器上的多个从库争夺资源，导致主从延迟。</p>
<ul>
<li>从库的压力大</li>
</ul>
<p>按照正常的策略，读写分离，主库提供写能力，从库提供读能力。将进行大量查询放在从库上，结果导致从库上耗费了大量的CPU资源，进而影响了同步速度，造成主从延迟。</p>
<ul>
<li>大事务的执行</li>
</ul>
<p>一旦执行大事务，那么主库必须要等到事务完成之后才会写入<code>binlog</code>。比如主库执行了一条<code>insert … select</code>非常大的插入操作，该操作产生了近几百<code>G</code>的<code>binlog</code>文件传输到只读节点，进而导致了只读节点出现应用<code>binlog</code>延迟。</p>
<ul>
<li>主库的DDL(alter、drop、create)</li>
</ul>
<p>只读节点与主库的DDL同步是串行进行，如果DDL操作在主库执行时间很长，那么从库也会消耗同样的时间，比如在主库对一张500W的表添加一个字段耗费了10分钟，那么从节点上也会耗费10分钟。</p>
<ul>
<li>锁冲突</li>
</ul>
<p>锁冲突问题也可能导致从节点的SQL线程执行慢，比如从机上有一些<code>select .... for update</code>的 <code>sql</code> 等。</p>
<h3 id="3-2-主从延迟解决方案"><a href="#3-2-主从延迟解决方案" class="headerlink" title="3.2 主从延迟解决方案"></a>3.2 主从延迟解决方案</h3><p>在高并发场景或者网络不佳的场景，如果存在较大的主从同步数据延迟，这时候读请求去读从库，就会读到旧数据。这时候最简单暴力的方法，就是<strong>强制读主库</strong>。实际上可以使用【缓存标记法】。</p>
<p><img src="#" alt="风尘博客"></p>
<ol>
<li><code>A</code> 发起写请求，更新主库数据，并在缓存中设置一个标记，表示数据已更新，标记格式为：<code>userId+业务Id</code>；</li>
<li>设置此标记，设置过期时间（估值为主库和从库同步延迟的时间）;</li>
<li><code>B</code>发起读请求，先判断此请求，在缓存中有没有更新标记;</li>
<li>如果存在标记，走主库；如果没有，请求走从库。</li>
</ol>
<p>这个方案，解决了数据不一致问题，但是每次请求都要先跟缓存打交道，会影响系统吞吐。</p>
<p>【<a href="https://juejin.cn/post/7020047661956857863" target="_blank" rel="noopener">参考文章</a>】</p>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL 优化】分页查询优化</title>
    <url>/2021/08/22/4d9c49a9.html</url>
    <content><![CDATA[<blockquote>
<p>当需要从数据库查询的表有上万条记录的时候，一次性查询所有结果会变得很慢，特别是随着数据量的增加特别明显，这时需要使用分页查询。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、分页查询真的一直快吗？"><a href="#一、分页查询真的一直快吗？" class="headerlink" title="一、分页查询真的一直快吗？"></a>一、分页查询真的一直快吗？</h2><h3 id="1-1-一般分页查询"><a href="#1-1-一般分页查询" class="headerlink" title="1.1 一般分页查询"></a>1.1 一般分页查询</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table_name <span class="keyword">limit</span> <span class="keyword">start</span>, <span class="keyword">count</span></span><br></pre></td></tr></table></figure>

<p><code>MySQL</code> 的分页语句，作为开发，再熟悉不过了吧，需注意以下几点：</p>
<ol>
<li>第一个参数指定第一个返回记录行的偏移量(从<code>0</code>开始)；</li>
<li>第二个参数指定返回记录行的最大数目；</li>
<li>如果只给定一个参数，表示返回最大的记录行数目；</li>
<li>第二个参数为 <code>-1</code> 表示检索从某一个偏移量到记录集的结束所有的记录行<br>初始记录行的偏移量是 <code>0</code>(而不是 <code>1</code>)。</li>
</ol>
<ul>
<li>例如</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">1000</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>该语句将会从表 <code>orders_history</code> 中查询偏移量从 <code>1000</code> 开始之后的 <code>10</code> 条数据，也就是第<code>1001</code>条到第<code>1010</code>条数据。</p>
<h3 id="1-2-偏移量测试"><a href="#1-2-偏移量测试" class="headerlink" title="1.2 偏移量测试"></a>1.2 偏移量测试</h3><ul>
<li>查询记录量增大时</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">10000</span>,<span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">10000</span>,<span class="number">10</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">10000</span>,<span class="number">100</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">10000</span>,<span class="number">1000</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">10000</span>,<span class="number">10000</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>查询记录数</th>
<th>执行三次时间</th>
</tr>
</thead>
<tbody><tr>
<td>查询1条记录</td>
<td>3072ms 3092ms 3002ms</td>
</tr>
<tr>
<td>查询10条记录</td>
<td>3081ms 3077ms 3032ms</td>
</tr>
<tr>
<td>查询100条记录</td>
<td>3118ms 3200ms 3128ms</td>
</tr>
<tr>
<td>查询1000条记录</td>
<td>3412ms 3468ms 3394ms</td>
</tr>
<tr>
<td>查询10000条记录</td>
<td>3749ms 3802ms 3696ms</td>
</tr>
</tbody></table>
<ul>
<li>查询偏移量偏大时</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100</span>,<span class="number">100</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">1000</span>,<span class="number">100</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">10000</span>,<span class="number">100</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100000</span>,<span class="number">100</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">1000000</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>查询偏移量</th>
<th>执行三次时间</th>
</tr>
</thead>
<tbody><tr>
<td>查询100偏移</td>
<td>25ms 24ms 24ms</td>
</tr>
<tr>
<td>查询1000偏移</td>
<td>78ms 76ms 77ms</td>
</tr>
<tr>
<td>查询10000偏移</td>
<td>3092ms 3212ms 3128ms</td>
</tr>
<tr>
<td>查询100000偏移</td>
<td>3878ms 3812ms 3798ms</td>
</tr>
<tr>
<td>查询1000000偏移</td>
<td>14608ms 14062ms 14700ms</td>
</tr>
</tbody></table>
<ol>
<li>从查询时间来看，基本可以确定，在偏移量不大时，在查询记录量增大时时，查询时间基本没有差距；</li>
<li>但随着查询偏移量越来越大，所花费的时间增加特别明显。</li>
</ol>
<p>传统分页查询方式会从数据库第一条记录开始扫描，所以偏移量越大，查询速度越慢。</p>
<h2 id="二、分页优化-使用子查询优化"><a href="#二、分页优化-使用子查询优化" class="headerlink" title="二、分页优化-使用子查询优化"></a>二、分页优化-使用子查询优化</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100000</span>,<span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100000</span>,<span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">and</span> </span><br><span class="line"><span class="keyword">id</span>&gt;=(<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100000</span>,<span class="number">1</span>) </span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-基本思路"><a href="#2-1-基本思路" class="headerlink" title="2.1 基本思路"></a>2.1 基本思路</h3><blockquote>
<p>这种方式适用于 <code>id</code> 递增的情况。</p>
</blockquote>
<p>先定位偏移位置的 <code>id</code>，然后往后查询。</p>
<h3 id="2-2-示例"><a href="#2-2-示例" class="headerlink" title="2.2 示例"></a>2.2 示例</h3><ul>
<li>先查询第 <code>10w</code> 条数据的位置</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100000</span>,<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>然后取 <code>ID</code> 值作起始标识定位下 <code>100</code> 条记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">and</span> </span><br><span class="line"><span class="keyword">id</span>&gt;=(<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100000</span>,<span class="number">1</span>) </span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>对比下原分页语句</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> orders_history <span class="keyword">where</span> <span class="keyword">type</span>=<span class="number">8</span> <span class="keyword">limit</span> <span class="number">100000</span>,<span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>分页方式</th>
<th>耗时</th>
</tr>
</thead>
<tbody><tr>
<td>原分页</td>
<td>3710ms</td>
</tr>
<tr>
<td>子查询分页</td>
<td>1327ms</td>
</tr>
</tbody></table>
<p>这种方式相较于原始一般的查询方法，将会增快数倍。</p>
<h3 id="2-3-关于数据表的id说明"><a href="#2-3-关于数据表的id说明" class="headerlink" title="2.3 关于数据表的id说明"></a>2.3 关于数据表的id说明</h3><blockquote>
<p>一般情况下，在数据库中建立表的时候，强制为每一张表添加 <code>id</code> 递增字段，这样方便查询。</p>
</blockquote>
<p>如果像是订单库等数据量非常庞大，一般会进行分库分表。这个时候不建议使用数据库的 <code>id</code> 作为唯一标识，而应该使用分布式的高并发唯一 <code>id</code> 生成器来生成，并在数据表中使用另外的字段来存储这个唯一标识。</p>
<p>使用先使用范围查询定位 <code>id</code> （或者索引），然后再使用索引进行定位数据，能够提高好几倍查询速度。即先 <code>select id</code>，然后再 <code>select *</code>。</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>在一些场景下，比如使用历史表的时候，或者出现过数据缺失问题时，可以考虑使用临时存储的表来记录分页的 <code>id</code>，使用分页的 <code>id</code> 来进行 <code>in</code> 查询。这样能够极大的提高传统的分页查询速度，尤其是数据量上千万的时候。</p>
<p><a href="http://uusama.com/458.html" target="_blank" rel="noopener">参考文章</a></p>
]]></content>
      <categories>
        <category>SQL 优化</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【JDK】分析 String str=&quot;&quot; 与 new String()</title>
    <url>/2021/06/12/e408f44d.html</url>
    <content><![CDATA[<p><code>String str=&quot;&quot;</code>与<code>new String()</code> 没区别？看完本文，希望你有所收获。</p>
<a id="more"></a>

<h3 id="一、基础概念"><a href="#一、基础概念" class="headerlink" title="一、基础概念"></a>一、基础概念</h3><blockquote>
<p>为了讲清楚他们的差异，这里先介绍几个概念。</p>
</blockquote>
<h4 id="1-1-常量池"><a href="#1-1-常量池" class="headerlink" title="1.1 常量池"></a>1.1 常量池</h4><p>所谓常量池：顾名思义就是用来存放一些常量的。该常量是在<strong>编译期被确定</strong>，并被保存在已编译的<code>.class</code>文件中，其中包括了类，方法，接口等包含的数值常量，字符常量和字符串常量。</p>
<h4 id="1-2-字符串常量池"><a href="#1-2-字符串常量池" class="headerlink" title="1.2 字符串常量池"></a>1.2 字符串常量池</h4><p>在常量池中，有个专门用来存储字符串常量的，称之为字符串常量池。</p>
<p>当我们需要使用字符串时，首先会在该字符串常量中查找是否存在该字符串，若存在则直接进行使用；若不存在，则会新建一个对应的字符串，并保存在该字符串常量池中。</p>
<h4 id="1-3-在编译期间创建的常量和运行期间创建的常量保存的地址是不一样的"><a href="#1-3-在编译期间创建的常量和运行期间创建的常量保存的地址是不一样的" class="headerlink" title="1.3 在编译期间创建的常量和运行期间创建的常量保存的地址是不一样的"></a>1.3 在编译期间创建的常量和运行期间创建的常量保存的地址是不一样的</h4><blockquote>
<p>对象的引用都是存放在栈中</p>
</blockquote>
<ol>
<li>编译期间创建的常量保存在常量池中；</li>
<li>运行期间通过<code>new</code>创建时，会直接创建一个新字符串常量并会存储在堆中。</li>
</ol>
<blockquote>
<p>所以我们可以发现，在堆中，可以有很多重复相同的字符串，而在常量池中，不会出现重复的值。</p>
</blockquote>
<h4 id="1-4-equals-与"><a href="#1-4-equals-与" class="headerlink" title="1.4 equals()与=="></a>1.4 <code>equals()</code>与<code>==</code></h4><ul>
<li><code>==</code></li>
</ul>
<ol>
<li>如果是基本类型，<code>==</code>表示判断它们值是否相等；</li>
<li>如果是引用对象，<code>==</code>表示判断两个对象指向的内存地址是否相同。</li>
</ol>
<ul>
<li><code>equals()</code></li>
</ul>
<ol>
<li><code>equals()</code>方法未被重写时（<code>Object</code>时),比较的是内存地址；</li>
<li><code>equals()</code>方法被<code>String</code>、<code>Integer</code>、<code>Date</code>等类重写时，其比较的是两个内容是否相同。</li>
</ol>
<h3 id="二、String-str-quot-quot-与new-String-的区别"><a href="#二、String-str-quot-quot-与new-String-的区别" class="headerlink" title="二、String str=&quot;&quot;与new String()的区别"></a>二、<code>String str=&quot;&quot;</code>与<code>new String()</code>的区别</h3><h4 id="2-1-String-str-quot-quot"><a href="#2-1-String-str-quot-quot" class="headerlink" title="2.1 String str=&quot;&quot;"></a>2.1 <code>String str=&quot;&quot;</code></h4><p>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String str = <span class="string">"风尘博客"</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>先在栈区创建<code>str</code>引用，然后关于创建对象。</li>
</ul>
<blockquote>
<p>这个表达式，可能会创建一个对象，也可能不会创建对象。</p>
</blockquote>
<ol>
<li>如果常量池中没有“风尘博客”这个字符串，就需要创建；</li>
<li>常量池中存在“风尘博客”这个字符串，就直接拿来用。</li>
</ol>
<ul>
<li>最后<code>str</code>指向常量池中的对象。</li>
</ul>
<blockquote>
<p>注意！这里就是上面说的，从常量池中直接取用，所以，两者引用地址应该也相同，即 <code>==</code> 比较为<code>true</code>。<br><img src="https://img.dusty.vip/blog//JDK-String-compare-01.png" alt="JDK-String-compare-01"></p>
</blockquote>
<h4 id="2-2-String-str-new-String"><a href="#2-2-String-str-new-String" class="headerlink" title="2.2 String str=new String()"></a>2.2 <code>String str=new String()</code></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String str=<span class="keyword">new</span> String(“风尘博客”)</span><br></pre></td></tr></table></figure>

<ul>
<li>同样的，先在栈区创建<code>str</code>引用；</li>
</ul>
<blockquote>
<p>这个表达式，可能会创建一个对象，也可能创建两个对象。</p>
</blockquote>
<ol>
<li>然后会直接创建一个字符串存放在堆中；</li>
<li>其次，同样的：如果常量池中没有“风尘博客”这个字符串，就需要创建；常量池中存在“风尘博客”这个字符串，就直接拿来用。</li>
</ol>
<ul>
<li>最后<code>str</code>指向常量池中的对象。</li>
</ul>
<blockquote>
<p>注意！这里这里和上面不一样，这里直接在堆里创建对象，每新建一个都会创建一个，所以，两者引用地址肯定不相同，即 <code>==</code> 比较为<code>false</code>。</p>
</blockquote>
<p><img src="https://img.dusty.vip/blog//JDK-String-compare-01.png" alt="JDK-String-compare-02"></p>
]]></content>
      <categories>
        <category>JDK</category>
        <category>String</category>
      </categories>
      <tags>
        <tag>String</tag>
        <tag>JDK</tag>
      </tags>
  </entry>
  <entry>
    <title>【工作流】如何设计一个简单的工作流引擎</title>
    <url>/2021/05/02/62a5513b.html</url>
    <content><![CDATA[<p>工作流（Workflow），指<strong>业务过程的部分或整体在计算机应用环境下的自动化</strong>，是对工作流程及其各操作步骤之间业务规则的抽象、概括描述。</p>
<a id="more"></a>

<h3 id="一、工作流简介"><a href="#一、工作流简介" class="headerlink" title="一、工作流简介"></a>一、工作流简介</h3><h4 id="1-1-什么是工作流？"><a href="#1-1-什么是工作流？" class="headerlink" title="1.1 什么是工作流？"></a>1.1 什么是工作流？</h4><p>工作流（Workflow），指<strong>业务过程的部分或整体在计算机应用环境下的自动化</strong>，是对工作流程及其各操作步骤之间业务规则的抽象、概括描述。在计算机中，工作流属于计算机支持的协同工作（CSCW）的一部分。后者是普遍地研究一个群体如何在计算机的帮助下实现协同工作的。</p>
<blockquote>
<p>比如说，我们在公司请假，可能要走审批的流程，从你自己到 Leader,然后从 Leader 到部门经理，然后部门经理再到人事部门，这一系列的流程实际上就相当于是一个工作流程，而这个就是一个工作流的最容易理解的模型。</p>
</blockquote>
<h4 id="1-2-工作流有什么用？"><a href="#1-2-工作流有什么用？" class="headerlink" title="1.2 工作流有什么用？"></a>1.2 工作流有什么用？</h4><p>工作流主要解决的主要问题是：为了实现某个业务目标，利用计算机在多个参与者之间按某种预定规则自动传递文档、信息或者任务。</p>
<h3 id="二、打怪升级史"><a href="#二、打怪升级史" class="headerlink" title="二、打怪升级史"></a>二、打怪升级史</h3><p>接下来，我将大致介绍如何一级一级设计一个工作流系统。</p>
<h4 id="2-1-第一关"><a href="#2-1-第一关" class="headerlink" title="2.1 第一关"></a>2.1 第一关</h4><p>第一版，从<code>0</code>到<code>1</code>就可以了，先做个简单的工作流引擎。</p>
<p><img src="https://img.dusty.vip/blog/Workflow-01.png" alt="Workflow-01"></p>
<ul>
<li>按顺序添加任意个审批人组成一个链表，最后加一个结束节点；</li>
<li>记录当前审批人，当审批完后，审批人向后移动一位；</li>
<li>当审批人对应结束节点时，流程结束。</li>
</ul>
<h4 id="2-2-第二关-支持会签节点"><a href="#2-2-第二关-支持会签节点" class="headerlink" title="2.2 第二关 - 支持会签节点"></a>2.2 第二关 - 支持会签节点</h4><blockquote>
<p>会签节点就是一个大节点，里面有很多审批人，当这个大节点里的所有人都审批通过后，才能进入下一个节点。</p>
</blockquote>
<p><img src="https://img.dusty.vip/blog/Workflow-02.png" alt="Workflow-02"></p>
<ul>
<li>结构上做出如下调整:</li>
</ul>
<ol>
<li>把节点分为两大类：简单节点(上图中长方形)和复杂节点(上图中圆形)。</li>
<li>用一棵树表示整个流程，其中叶子节点都是简单节点，简单节点都是叶子节点。</li>
<li>每个简单节点里都有且仅有有一个审批人。</li>
<li>复杂节点包含若干个子节点。</li>
<li>加入会签节点: 会签节点激活后，所有的子节点都可以审批，当所有的子节点全部审批完毕后，会签节点完成。</li>
<li>加入串行节点：子节点只能从左到右依次进行审批，当最后一个子节点审批完成后，串行节点完成。</li>
<li>所有的工作流最外层都是一个串行节点，该节点完成后代表整个工作流完成。</li>
</ol>
<ul>
<li>为了控制审批流程，设计了一些节点状态:</li>
</ul>
<ol>
<li><code>Ready</code>: 可以进行审批操作的简单节点是<code>Ready</code>状态。</li>
<li><code>Complete</code>: 已经审批完成的节点状态。</li>
<li><code>Future</code>: 现在还没有走到的节点状态。</li>
<li><code>Waiting</code>: 只有复杂节点有该状态，表示在等待子节点审批。</li>
</ol>
<p>借助上述状态，如下是带会签节点的工作流审批过程：</p>
<p><img src="https://img.dusty.vip/blog/Workflow-03.png" alt="Workflow-03"></p>
<h4 id="2-3-第三关-支持并行节点"><a href="#2-3-第三关-支持并行节点" class="headerlink" title="2.3 第三关 - 支持并行节点"></a>2.3 第三关 - 支持并行节点</h4><p>并行节点是一个包含很多审批人的大节点，这个大节点里任何一个人审批通过，则该节点就完成。</p>
<blockquote>
<p>并行节点是一个复杂节点，该节点激活时，任何一个子节点都可以进行审批，且任何一个子节点是完成状态时，该节点完成。所以又加了一个状态。</p>
</blockquote>
<p><code>Skip</code>:当一个并行节点的子节点状态为非(<code>Ready</code>, <code>Waiting</code>)时，其它兄弟节点及其子节点的状态被置为<code>Skip</code>。</p>
<p><img src="https://img.dusty.vip/blog/Workflow-04.png" alt="Workflow-04"></p>
<blockquote>
<p>举个栗子：A、B、C 三人都可以审批一个流程，该节点只要三人中的任何一个审批都算完成。现在A审批了，A的状态就是已完成审批（<code>Complete</code>），B和C就无需审批了，B和C就是<code>Skip</code>状态。</p>
</blockquote>
<h4 id="2-4-第四关-节点支持嵌套"><a href="#2-4-第四关-节点支持嵌套" class="headerlink" title="2.4 第四关 - 节点支持嵌套"></a>2.4 第四关 - 节点支持嵌套</h4><blockquote>
<p>比如会签节点里有个并行节点，并行节点里又有个复杂节点，要可以嵌套任意层。</p>
</blockquote>
<p><img src="https://img.dusty.vip/blog/Workflow-05.png" alt="Workflow-05"></p>
<ul>
<li>已经支持，能无限扩展的树形结构可以支持任意复杂流程。</li>
</ul>
<h4 id="2-5-第五关-支持条件节点"><a href="#2-5-第五关-支持条件节点" class="headerlink" title="2.5 第五关 - 支持条件节点"></a>2.5 第五关 - 支持条件节点</h4><p>工作流附带一个表单，要根据表单的内容确定下一步进入哪个分支。</p>
<p><img src="https://img.dusty.vip/blog/Workflow-06.png" alt="Workflow-06"></p>
<blockquote>
<p>条件节点类似并行节点，只不过只有满足条件的子节点才能进入接下来的审批。</p>
</blockquote>
<h4 id="2-6-第六关-增加审批人类型"><a href="#2-6-第六关-增加审批人类型" class="headerlink" title="2.6 第六关 - 增加审批人类型"></a>2.6 第六关 - 增加审批人类型</h4><p>把简单节点分成了3类：</p>
<ol>
<li>第一种：审批人是写死的；</li>
<li>第二种：审批人从表单中读取；</li>
<li>第三种：根据发起人和一个映射函数，算出审批人。比如 get_主管(“钱某”) 得到钱某的主管 李某。</li>
</ol>
<p><img src="https://img.dusty.vip/blog/Workflow-07.png" alt="Workflow-07"></p>
<h4 id="2-7-第七关-驳回"><a href="#2-7-第七关-驳回" class="headerlink" title="2.7 第七关 - 驳回"></a>2.7 第七关 - 驳回</h4><p>要实现驳回到发起人的功能，相当于一切从头开始。</p>
<blockquote>
<p>只有<code>Ready</code>状态的节点有权利驳回。（就像只有<code>Ready</code>状态的节点有权利审批一样）。</p>
</blockquote>
<p><img src="https://img.dusty.vip/blog/Workflow-08.png" alt="Workflow-08"></p>
<h3 id="2-8-第八关-时间限制"><a href="#2-8-第八关-时间限制" class="headerlink" title="2.8 第八关 - 时间限制"></a>2.8 第八关 - 时间限制</h3><p>在普通节点加一个时间限制，要是在规定时间内没完成就显示已超时。</p>
<p><img src="https://img.dusty.vip/blog/Workflow-09.png" alt="Workflow-09"></p>
<h3 id="2-9-第九关-代理"><a href="#2-9-第九关-代理" class="headerlink" title="2.9 第九关 - 代理"></a>2.9 第九关 - 代理</h3><blockquote>
<p>比如有件事让你审批，但是你拿不准，那就转给拿得准的人审批。</p>
</blockquote>
<ul>
<li>代理操作的本质是，新建一个并行节点作为本节点的父节点，再新建一个兄弟节点放代理人，这样自己和代理人都能审批通过。</li>
<li>代理操作可以无限嵌套，即代理人也可以找人代理。</li>
</ul>
<p><img src="https://img.dusty.vip/blog/Workflow-10.png" alt="Workflow-10"></p>
<h4 id="2-10-第十关-取消代理"><a href="#2-10-第十关-取消代理" class="headerlink" title="2.10 第十关 - 取消代理"></a>2.10 第十关 - 取消代理</h4><ul>
<li>取消代理是代理的逆操作。</li>
<li>如果代理人审批过了那就不能取消代理。</li>
</ul>
<p><img src="https://img.dusty.vip/blog/Workflow-11.png" alt="Workflow-11"></p>
]]></content>
      <categories>
        <category>工作流</category>
      </categories>
      <tags>
        <tag>工作流</tag>
      </tags>
  </entry>
  <entry>
    <title>【MyBatis】几种批量插入效率的比较</title>
    <url>/2021/04/04/cdc1f59d.html</url>
    <content><![CDATA[<p>批处理数据主要有三种方式：</p>
<ol>
<li>反复执行单条插入语句</li>
<li><code>foreach</code> 拼接 <code>sql</code></li>
<li>批处理</li>
</ol>
<a id="more"></a>

<h3 id="一、前期准备"><a href="#一、前期准备" class="headerlink" title="一、前期准备"></a>一、前期准备</h3><p>基于<code>Spring Boot</code> + <code>Mysql</code>，同时为了省略<code>get</code>/<code>set</code>，使用了<code>lombok</code>，详见<code>pom.xml</code>。</p>
<h4 id="1-1-表结构"><a href="#1-1-表结构" class="headerlink" title="1.1 表结构"></a>1.1 表结构</h4><blockquote>
<p><code>id</code> 使用数据库自增。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_info_batch`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_info_batch`</span> (</span><br><span class="line">                           <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键id'</span>,</span><br><span class="line">                           <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'账户名称'</span>,</span><br><span class="line">                           <span class="string">`pass_word`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'登录密码'</span>,</span><br><span class="line">                           <span class="string">`nick_name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</span><br><span class="line">                           <span class="string">`mobile`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'手机号'</span>,</span><br><span class="line">                           <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱地址'</span>,</span><br><span class="line">                           <span class="string">`gmt_create`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">                           <span class="string">`gmt_update`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">                           PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ROW_FORMAT=DYNAMIC <span class="keyword">COMMENT</span> <span class="string">'Mybatis Batch'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-项目配置文件"><a href="#1-2-项目配置文件" class="headerlink" title="1.2 项目配置文件"></a>1.2 项目配置文件</h4><p>细心的你可能已经发现，数据库<code>url</code> 后面跟了一段 <code>rewriteBatchedStatements=true</code>，有什么用呢？先不急，后面会介绍。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># 数据库配置</span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql://47.111.118.152:3306/mybatis?rewriteBatchedStatements=true</span><br><span class="line">    username: mybatis</span><br><span class="line">    password: password</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line"># mybatis</span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:mapper/*.xml</span><br><span class="line">  type-aliases-package: cn.van.mybatis.batch.entity</span><br></pre></td></tr></table></figure>

<h4 id="1-3-实体类"><a href="#1-3-实体类" class="headerlink" title="1.3 实体类"></a>1.3 实体类</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Data</span><br><span class="line">@Accessors(chain &#x3D; true)</span><br><span class="line">public class UserInfoBatchDO implements Serializable &#123;</span><br><span class="line">    private Long id;</span><br><span class="line"></span><br><span class="line">    private String userName;</span><br><span class="line"></span><br><span class="line">    private String passWord;</span><br><span class="line"></span><br><span class="line">    private String nickName;</span><br><span class="line"></span><br><span class="line">    private String mobile;</span><br><span class="line"></span><br><span class="line">    private String email;</span><br><span class="line"></span><br><span class="line">    private LocalDateTime gmtCreate;</span><br><span class="line"></span><br><span class="line">    private LocalDateTime gmtUpdate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-4-UserInfoBatchMapper"><a href="#1-4-UserInfoBatchMapper" class="headerlink" title="1.4 UserInfoBatchMapper"></a>1.4 <code>UserInfoBatchMapper</code></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoBatchMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 单条插入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> info</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(UserInfoBatchDO info)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * foreach 插入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">batchInsert</span><span class="params">(List&lt;UserInfoBatchDO&gt; list)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-5-UserInfoBatchMapper-xml"><a href="#1-5-UserInfoBatchMapper-xml" class="headerlink" title="1.5 UserInfoBatchMapper.xml"></a>1.5 <code>UserInfoBatchMapper.xml</code></h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"cn.van.mybatis.batch.mapper.UserInfoBatchMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">parameterType</span>=<span class="string">"cn.van.mybatis.batch.entity.UserInfoBatchDO"</span>&gt;</span></span><br><span class="line">    insert into user_info_batch (user_name, pass_word, nick_name, mobile, email, gmt_create, gmt_update)</span><br><span class="line">    values (#&#123;userName,jdbcType=VARCHAR&#125;, #&#123;passWord,jdbcType=VARCHAR&#125;,#&#123;nickName,jdbcType=VARCHAR&#125;, #&#123;mobile,jdbcType=VARCHAR&#125;, #&#123;email,jdbcType=VARCHAR&#125;, #&#123;gmtCreate,jdbcType=TIMESTAMP&#125;, #&#123;gmtUpdate,jdbcType=TIMESTAMP&#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"batchInsert"</span>&gt;</span></span><br><span class="line">    insert into user_info_batch (user_name, pass_word, nick_name, mobile, email, gmt_create, gmt_update)</span><br><span class="line">    values</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"list"</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">      (#&#123;item.userName,jdbcType=VARCHAR&#125;, #&#123;item.passWord,jdbcType=VARCHAR&#125;, #&#123;item.nickName,jdbcType=VARCHAR&#125;, #&#123;item.mobile,jdbcType=VARCHAR&#125;, #&#123;item.email,jdbcType=VARCHAR&#125;, #&#123;item.gmtCreate,jdbcType=TIMESTAMP&#125;, #&#123;item.gmtUpdate,jdbcType=TIMESTAMP&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="1-6-预备数据"><a href="#1-6-预备数据" class="headerlink" title="1.6 预备数据"></a>1.6 预备数据</h4><blockquote>
<p>为了方便测试，抽离了几个变量，并进行提前加载。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private List&lt;UserInfoBatchDO&gt; list &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">private List&lt;UserInfoBatchDO&gt; lessList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">private List&lt;UserInfoBatchDO&gt; lageList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">private List&lt;UserInfoBatchDO&gt; warmList &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">&#x2F;&#x2F; 计数工具</span><br><span class="line">private StopWatch sw &#x3D; new StopWatch();</span><br></pre></td></tr></table></figure>

<ul>
<li>为了方便组装数据，抽出了一个公共方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">private List&lt;UserInfoBatchDO&gt; assemblyData(int count)&#123;</span><br><span class="line">    List&lt;UserInfoBatchDO&gt; list &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">    UserInfoBatchDO userInfoDO;</span><br><span class="line">    for (int i &#x3D; 0;i &lt; count;i++)&#123;</span><br><span class="line">        userInfoDO &#x3D; new UserInfoBatchDO()</span><br><span class="line">                .setUserName(&quot;Van&quot;)</span><br><span class="line">                .setNickName(&quot;风尘博客&quot;)</span><br><span class="line">                .setMobile(&quot;17098705205&quot;)</span><br><span class="line">                .setPassWord(&quot;password&quot;)</span><br><span class="line">                .setGmtUpdate(LocalDateTime.now());</span><br><span class="line">        list.add(userInfoDO);</span><br><span class="line">    &#125;</span><br><span class="line">    return list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>预热数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Before</span><br><span class="line">public void assemblyData() &#123;</span><br><span class="line">    list &#x3D; assemblyData(200000);</span><br><span class="line">    lessList &#x3D; assemblyData(2000);</span><br><span class="line">    lageList &#x3D; assemblyData(1000000);</span><br><span class="line">    warmList &#x3D; assemblyData(5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="二、反复执行单条插入语句"><a href="#二、反复执行单条插入语句" class="headerlink" title="二、反复执行单条插入语句"></a>二、反复执行单条插入语句</h3><blockquote>
<p>可能‘懒’的程序员会这么做，很简单，直接在原先单条<code>insert</code>语句上嵌套一个<code>for</code>循环。</p>
</blockquote>
<h4 id="2-1-对应-mapper-接口"><a href="#2-1-对应-mapper-接口" class="headerlink" title="2.1 对应 mapper 接口"></a>2.1 对应 mapper 接口</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int insert(UserInfoBatchDO info);</span><br></pre></td></tr></table></figure>

<h4 id="2-2-测试方法"><a href="#2-2-测试方法" class="headerlink" title="2.2 测试方法"></a>2.2 测试方法</h4><blockquote>
<p>因为这种方法太慢，所以数据降低到 <code>2000</code> 条</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void insert() &#123;</span><br><span class="line">    log.info(&quot;【程序热身】&quot;);</span><br><span class="line">    for (UserInfoBatchDO userInfoBatchDO : warmList) &#123;</span><br><span class="line">        userInfoBatchMapper.insert(userInfoBatchDO);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(&quot;【热身结束】&quot;);</span><br><span class="line">    sw.start(&quot;反复执行单条插入语句&quot;);</span><br><span class="line">    &#x2F;&#x2F; 这里插入 20w 条太慢了，所以我只插入了 2000 条</span><br><span class="line">    for (UserInfoBatchDO userInfoBatchDO : lessList) &#123;</span><br><span class="line">        userInfoBatchMapper.insert(userInfoBatchDO);</span><br><span class="line">    &#125;</span><br><span class="line">    sw.stop();</span><br><span class="line">    log.info(&quot;all cost info:&#123;&#125;&quot;,sw.prettyPrint());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-执行时间"><a href="#2-3-执行时间" class="headerlink" title="2.3 执行时间"></a>2.3 执行时间</h4><ul>
<li>第一次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">59887  100%  反复执行单条插入语句</span><br></pre></td></tr></table></figure>

<ul>
<li>第二次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">64853  100%  反复执行单条插入语句</span><br></pre></td></tr></table></figure>

<ul>
<li>第三次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">58235  100%  反复执行单条插入语句</span><br></pre></td></tr></table></figure>

<p>该方式插入<code>2000</code> 条数据，执行三次的平均时间：<code>60991 ms</code>。</p>
<h3 id="三、foreach-拼接SQL"><a href="#三、foreach-拼接SQL" class="headerlink" title="三、foreach 拼接SQL"></a>三、<code>foreach</code> 拼接<code>SQL</code></h3><h4 id="3-1-对应mapper-接口"><a href="#3-1-对应mapper-接口" class="headerlink" title="3.1 对应mapper 接口"></a>3.1 对应mapper 接口</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">batchInsert</span><span class="params">(List&lt;UserInfoBatchDO&gt; list)</span></span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-测试方法"><a href="#3-2-测试方法" class="headerlink" title="3.2 测试方法"></a>3.2 测试方法</h4><blockquote>
<p>该方式和下一种方式都采用<code>20w</code>条数据测试。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void batchInsert() &#123;</span><br><span class="line">    log.info(&quot;【程序热身】&quot;);</span><br><span class="line">    for (UserInfoBatchDO userInfoBatchDO : warmList) &#123;</span><br><span class="line">        userInfoBatchMapper.insert(userInfoBatchDO);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(&quot;【热身结束】&quot;);</span><br><span class="line">    sw.start(&quot;foreach 拼接 sql&quot;);</span><br><span class="line">    userInfoBatchMapper.batchInsert(list);</span><br><span class="line">    sw.stop();</span><br><span class="line">    log.info(&quot;all cost info:&#123;&#125;&quot;,sw.prettyPrint());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="3-3-执行时间"><a href="#3-3-执行时间" class="headerlink" title="3.3 执行时间"></a>3.3 执行时间</h4><ul>
<li>第一次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">18835  100%  foreach 拼接 sql</span><br></pre></td></tr></table></figure>

<ul>
<li>第二次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">17895  100%  foreach 拼接 sql</span><br></pre></td></tr></table></figure>

<ul>
<li>第三次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">19827  100%  foreach 拼接 sql</span><br></pre></td></tr></table></figure>

<p>该方式插入<code>20w</code> 条数据，执行三次的平均时间：<code>18852 ms</code>。</p>
<h3 id="四、批处理"><a href="#四、批处理" class="headerlink" title="四、批处理"></a>四、批处理</h3><blockquote>
<p>该方式 <code>mapper</code> 和<code>xml</code> 复用了 <code>2.1</code>。</p>
</blockquote>
<h4 id="4-1-rewriteBatchedStatements-参数"><a href="#4-1-rewriteBatchedStatements-参数" class="headerlink" title="4.1 rewriteBatchedStatements 参数"></a>4.1 <code>rewriteBatchedStatements</code> 参数</h4><blockquote>
<p>我在测试一开始，发现改成 <code>Mybatis Batch</code>提交的方法都不起作用，实际上在插入的时候仍然是一条条记录的插，而且速度远不如原来 <code>foreach</code> 拼接<code>SQL</code>的方法，这是非常不科学的。</p>
</blockquote>
<p><strong>后来才发现要批量执行的话，连接<code>URL</code>字符串中需要新增一个参数：<code>rewriteBatchedStatements=true</code></strong></p>
<ul>
<li><code>rewriteBatchedStatements</code>参数介绍</li>
</ul>
<p><code>MySql</code>的<code>JDBC</code>连接的<code>url</code>中要加<code>rewriteBatchedStatements</code>参数，并保证<code>5.1.13</code>以上版本的驱动，才能实现高性能的批量插入。<code>MySql JDBC</code>驱动在默认情况下会无视<code>executeBatch()</code>语句，把我们期望批量执行的一组<code>sql</code>语句拆散，一条一条地发给<code>MySql</code>数据库，批量插入实际上是单条插入，直接造成较低的性能。只有把<code>rewriteBatchedStatements</code>参数置为<code>true</code>, 驱动才会帮你批量执行<code>SQL</code>。这个选项对<code>INSERT</code>/<code>UPDATE</code>/<code>DELETE</code>都有效。</p>
<h4 id="4-2-批处理准备"><a href="#4-2-批处理准备" class="headerlink" title="4.2 批处理准备"></a>4.2 批处理准备</h4><ul>
<li>手动注入 <code>SqlSessionFactory</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Resource</span><br><span class="line">private SqlSessionFactory sqlSessionFactory;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void processInsert() &#123;</span><br><span class="line">    log.info(&quot;【程序热身】&quot;);</span><br><span class="line">    for (UserInfoBatchDO userInfoBatchDO : warmList) &#123;</span><br><span class="line">        userInfoBatchMapper.insert(userInfoBatchDO);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(&quot;【热身结束】&quot;);</span><br><span class="line">    sw.start(&quot;批处理执行 插入&quot;);</span><br><span class="line">    &#x2F;&#x2F; 打开批处理</span><br><span class="line">    SqlSession session &#x3D; sqlSessionFactory.openSession(ExecutorType.BATCH);</span><br><span class="line">    UserInfoBatchMapper mapper &#x3D; session.getMapper(UserInfoBatchMapper.class);</span><br><span class="line">    for (int i &#x3D; 0,length &#x3D; list.size(); i &lt; length; i++) &#123;</span><br><span class="line">        mapper.insert(list.get(i));</span><br><span class="line">        &#x2F;&#x2F;每20000条提交一次防止内存溢出</span><br><span class="line">        if(i%20000&#x3D;&#x3D;19999)&#123;</span><br><span class="line">            session.commit();</span><br><span class="line">            session.clearCache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    session.commit();</span><br><span class="line">    session.clearCache();</span><br><span class="line">    sw.stop();</span><br><span class="line">    log.info(&quot;all cost info:&#123;&#125;&quot;,sw.prettyPrint());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-执行时间"><a href="#4-3-执行时间" class="headerlink" title="4.3 执行时间"></a>4.3 执行时间</h4><ul>
<li>第一次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">09346  100%  批处理执行 插入</span><br></pre></td></tr></table></figure>

<ul>
<li>第二次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">08890  100%  批处理执行 插入</span><br></pre></td></tr></table></figure>

<ul>
<li>第三次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">09042  100%  批处理执行 插入</span><br></pre></td></tr></table></figure>

<p>该方式插入<code>20w</code> 条数据，执行三次的平均时间：<code>9092 ms</code>。</p>
<h4 id="4-4-如果数据更大"><a href="#4-4-如果数据更大" class="headerlink" title="4.4 如果数据更大"></a>4.4 如果数据更大</h4><p>当我把数据扩大到 <code>100w</code> 时，<code>foreach</code> 拼接 <code>sql</code> 的方式已经无法完成插入了，所以我只能测试批处理的插入时间。</p>
<blockquote>
<p>测试时，仅需将 【4.2】测试代码中的 <code>list</code> 切成 <code>lageList</code> 测试即可。</p>
</blockquote>
<ul>
<li>第一次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">32419  100%  批处理执行 插入</span><br></pre></td></tr></table></figure>

<ul>
<li>第二次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">31935  100%  批处理执行 插入</span><br></pre></td></tr></table></figure>

<ul>
<li>第三次</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">33048  100%  批处理执行 插入</span><br></pre></td></tr></table></figure>

<p>该方式插入<code>100w</code> 条数据，执行三次的平均时间：<code>32467 ms</code>。</p>
<h3 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h3><table>
<thead>
<tr>
<th>批量插入方式</th>
<th>数据量</th>
<th>执行三次的平均时间</th>
</tr>
</thead>
<tbody><tr>
<td>循环插入单条数据</td>
<td>2000</td>
<td>60991 ms</td>
</tr>
<tr>
<td><code>foreach</code> 拼接<code>sql</code></td>
<td>20w</td>
<td>18852 ms</td>
</tr>
<tr>
<td>批处理</td>
<td>20w</td>
<td>9092 ms</td>
</tr>
<tr>
<td>批处理</td>
<td>100w</td>
<td>32467 ms</td>
</tr>
</tbody></table>
<ol>
<li>循环插入单条数据虽然效率极低，但是代码量极少，数据量较小时可以使用，但是数据量较大禁止使用，效率太低了；</li>
<li><code>foreach</code> 拼接<code>sql</code>的方式，使用时有大段的<code>xml</code>和<code>sql</code>语句要写，很容易出错，虽然效率尚可，但是真正应对大量数据的时候，依旧无法使用，所以不推荐使用；</li>
<li>批处理执行是有大数据量插入时推荐的做法，使用起来也比较方便。</li>
</ol>
<p>【<a href="https://github.com/vanDusty/Frame-Home/tree/master/mybatis-case/mybatis-batch" target="_blank" rel="noopener">本文示例代码</a>】</p>
]]></content>
      <categories>
        <category>MyBatis</category>
      </categories>
      <tags>
        <tag>MyBatis</tag>
        <tag>批量</tag>
      </tags>
  </entry>
  <entry>
    <title>【代码优化】基础优化</title>
    <url>/2021/03/21/4360d2ec.html</url>
    <content><![CDATA[<p><strong>代码优化</strong>是一个很重要的课题。可能有些人觉得没用，一些细小的地方有什么好修改的，改与不改对于代码的运行效率有什么影响呢？</p>
<a id="more"></a>
<h3 id="为什么要优化代码"><a href="#为什么要优化代码" class="headerlink" title="为什么要优化代码"></a>为什么要优化代码</h3><blockquote>
<p>就像大海里面的鲸鱼一样，它吃一条小虾米有用吗？没用，但是，吃的小虾米一多之后，鲸鱼就被喂饱了。</p>
</blockquote>
<p>代码优化也是一样，如果项目着眼于尽快无<code>BUG</code>上线，那么此时可以抓大放小，代码的细节可以不精打细磨；但是如果有足够的时间开发、维护代码，这时候就必须考虑每个可以优化的细节了，一个一个细小的优化点累积起来，对于代码的运行效率绝对是有提升的。</p>
<ul>
<li>代码优化的目标是：<ol>
<li>减小代码的体积；</li>
<li>提高代码运行的效率；</li>
<li>代码优化细节。</li>
</ol>
</li>
</ul>
<h3 id="Map-获取-key-和-value"><a href="#Map-获取-key-和-value" class="headerlink" title="Map 获取 key 和 value"></a><code>Map</code> 获取 <code>key</code> 和 <code>value</code></h3><p>当循环中只需要获取 <code>Map</code> 的主键 <code>key</code> 时，迭代 <code>keySet()</code> 是正确的；但是，当需要主键 <code>key</code> 和取值 <code>value</code> 时，迭代 <code>entrySet()</code> 才是更高效的做法，其比先迭代 <code>keySet()</code> 后再去通过 <code>get</code> 取值性能更佳。</p>
<ul>
<li>获取 <code>key</code> &amp; <code>value</code> 反例：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String key : map.keySet())&#123;</span><br><span class="line">    String value = map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取 <code>key</code> &amp; <code>value</code> 正例：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"> <span class="keyword">for</span> (Map.Entry&lt;String,String&gt; entry : map.entrySet())&#123;</span><br><span class="line">    String key = entry.getKey();</span><br><span class="line">    String value = entry.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Collection-isEmpty-检测空"><a href="#使用-Collection-isEmpty-检测空" class="headerlink" title="使用 Collection.isEmpty() 检测空"></a>使用 <code>Collection.isEmpty()</code> 检测空</h3><ol>
<li>使用 <code>Collection.size()</code> 来检测是否为空在逻辑上没有问题，但是使用 <code>Collection.isEmpty()</code>使得代码更易读，并且可以获得更好的性能；</li>
<li>除此之外，任何 <code>Collection.isEmpty()</code>实现的时间复杂度都是 <code>O(1)</code>，不需要多次循环遍历；但是某些通过 <code>Collection.size()</code> 方法实现的时间复杂度可能是 <code>O(n)</code>。(参见：【<a href="https://www.cnblogs.com/taojietaoge/p/10947214.html" target="_blank" rel="noopener">O(1) 纬度减少循环次数</a>】）</li>
</ol>
<h3 id="返回空数组和集合而非-null"><a href="#返回空数组和集合而非-null" class="headerlink" title="返回空数组和集合而非 null"></a>返回空数组和集合而非 <code>null</code></h3><p>若程序运行返回 <code>null</code>，需要调用方强制检测 <code>null</code>，否则就会抛出空指针异常；返回空数组或空集合，<strong>有效地避免了调用方因为未检测 <code>null</code> 而抛出空指针异常的情况，还可以删除调用方检测 <code>null</code> 的语句使代码更简洁。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Result&gt; <span class="title">getResultList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Result&gt; <span class="title">getResultMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="尽量减少对变量的重复计算"><a href="#尽量减少对变量的重复计算" class="headerlink" title="尽量减少对变量的重复计算"></a>尽量减少对变量的重复计算</h3><p>对方法的调用，即使方法中只有一句语句，也是有消耗的，包括创建栈帧、调用方法时保护现场、调用方法完毕时恢复现场等。所以例如下面的操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;list.size(); i++)&#123;</span><br><span class="line">    <span class="comment">// xxx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>建议替换为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>,length = list.size(); i&lt;length; i++)&#123;</span><br><span class="line">    <span class="comment">// xxx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，避免每次都计算<code>list.size()</code>，就减少了很多的消耗。</p>
<h3 id="尽量采用懒加载的策略，即在需要的时候才创建"><a href="#尽量采用懒加载的策略，即在需要的时候才创建" class="headerlink" title="尽量采用懒加载的策略，即在需要的时候才创建"></a>尽量采用懒加载的策略，即在需要的时候才创建</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String str = <span class="string">"abc"</span>;</span><br><span class="line"><span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">    list.add(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>替换为</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">    String str = <span class="string">"abc"</span>;</span><br><span class="line">    list.add(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="循环内不要不断创建对象引用"><a href="#循环内不要不断创建对象引用" class="headerlink" title="循环内不要不断创建对象引用"></a>循环内不要不断创建对象引用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种做法会导致内存中有<code>count</code>份<code>Object</code>对象引用存在，<code>count</code>很大时，就耗费内存了，建议为改为</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object obj = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">    obj = <span class="keyword">new</span> Object();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的话，内存中只有一份<code>Object</code>对象引用，每次<code>new Object</code>的时候，<code>Object</code>对象引用指向不同的<code>Object</code>罢了，但是内存中只有一份，这样就大大节省了内存空间了。</p>
<h3 id="将常量声明为-static-final，并以大写命名"><a href="#将常量声明为-static-final，并以大写命名" class="headerlink" title="将常量声明为 static final，并以大写命名"></a>将常量声明为 <code>static final</code>，并以大写命名</h3><p>这样在编译期间就可以把这些内容放入常量池中，避免运行期间计算生成常量的值。另外，将常量的名字以大写命名也可以方便区分出常量与变量。</p>
<h3 id="使用静态代码块实现赋值静态成员变量"><a href="#使用静态代码块实现赋值静态成员变量" class="headerlink" title="使用静态代码块实现赋值静态成员变量"></a>使用静态代码块实现赋值静态成员变量</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;()&#123;</span><br><span class="line">      map.put(<span class="string">"Leo"</span>,<span class="number">1</span>);</span><br><span class="line">      map.put(<span class="string">"Family-loving"</span>,<span class="number">2</span>);</span><br><span class="line">      map.put(<span class="string">"Cold on the out side passionate on the inside"</span>,<span class="number">3</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;()&#123;</span><br><span class="line">     list.add(<span class="string">"Sagittarius"</span>);</span><br><span class="line">     list.add(<span class="string">"Charming"</span>);</span><br><span class="line">     list.add(<span class="string">"Perfectionist"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对于集合类型的静态成员变量，应该使用静态代码块赋值，而不是使用集合实现来赋值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">      map.put(<span class="string">"Leo"</span>,<span class="number">1</span>);</span><br><span class="line">      map.put(<span class="string">"Family-loving"</span>,<span class="number">2</span>);</span><br><span class="line">      map.put(<span class="string">"Cold on the out side passionate on the inside"</span>,<span class="number">3</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> <span class="keyword">static</span> &#123;</span><br><span class="line">     list.add(<span class="string">"Sagittarius"</span>);</span><br><span class="line">     list.add(<span class="string">"Charming"</span>);</span><br><span class="line">     list.add(<span class="string">"Perfectionist"</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>


<h3 id="若需频繁调用-Collection-contains-方法则使用-Set"><a href="#若需频繁调用-Collection-contains-方法则使用-Set" class="headerlink" title="若需频繁调用 Collection.contains 方法则使用 Set"></a>若需频繁调用 <code>Collection.contains</code> 方法则使用 <code>Set</code></h3><p>在 <code>Java</code> 集合类库中，<code>List</code> 的 <code>contains</code> 方法普遍时间复杂度为 <code>O(n)</code>，若代码中需要频繁调用 <code>contains</code>方法查找数据则先将集合 <code>List</code>  转换成 <code>HashSet</code> 实现，将 <code>O(n)</code> 的时间复杂度将为 <code>O(1)</code>。</p>
<h3 id="采用Lambda表达式替换内部匿名类，使代码更优雅"><a href="#采用Lambda表达式替换内部匿名类，使代码更优雅" class="headerlink" title="采用Lambda表达式替换内部匿名类，使代码更优雅"></a>采用<code>Lambda</code>表达式替换内部匿名类，使代码更优雅</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sortUserInfoList</span><span class="params">(List&lt;UserInfo&gt; userInfoList)</span></span>&#123;</span><br><span class="line">    userInfoList.sort(<span class="keyword">new</span> Comparator&lt;UserInfo&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(UserInfo user1, UserInfo user2)</span> </span>&#123;</span><br><span class="line">            Long userId1 = user1.getUserId();</span><br><span class="line">            Long userId2 = user2.getUserId();</span><br><span class="line">            <span class="keyword">return</span> userId1.compareTo(userId2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>JDK8</code>的新特性-<code>Lambda</code>表达式：不仅比匿名内部类更加优雅，并且在大多数虚拟机中，都是采用<code>invokeDynamic</code>指令实现，相对于匿名内部类，效率也更高。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sortUserInfoList</span><span class="params">(List&lt;UserInfo&gt; userInfoList)</span></span>&#123;</span><br><span class="line">    userInfoList.sort((user1, user2) -&gt; &#123;</span><br><span class="line">        Long userId1 = user1.getUserId();</span><br><span class="line">        Long userId2 = user2.getUserId();</span><br><span class="line">        <span class="keyword">return</span> userId1.compareTo(userId2);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="处理Java日期时，当心YYYY格式设置的问题。"><a href="#处理Java日期时，当心YYYY格式设置的问题。" class="headerlink" title="处理Java日期时，当心YYYY格式设置的问题。"></a>处理Java日期时，当心YYYY格式设置的问题。</h3><blockquote>
<p>2020年底发生一件很诡异的事情：明明是2020年12月27日，当天确显示2021年12月27日。</p>
</blockquote>
<p>其实，这就是 <code>YYYY-MM-dd</code> 给你送的新年彩蛋!</p>
<p>只要去查下 【<a href="https://docs.oracle.com/javase/8/docs/api/index.html" target="_blank" rel="noopener">jdk 8 的 api</a>】不难发现，</p>
<p><code>y</code> 对应 <code>year</code>：就是年的意思<br><code>Y</code> 对应 <code>Week year</code>：代表的是本周所在年份，而只要本周跨年，那么本周都是算到下一年的，所以就出现了上面的彩蛋。</p>
<p>在项目中，应该尽量避免每次转换日期都手动进行编写格式的操作，这边总会不可避免的产生这样的问题，统一定义一个DateConstant类，里面提供各种转换格式的方法以及所以常用的到的格式的常量定义，这样跨年的彩蛋就不会找上你了。</p>
<div style="text-align: center;font-weight:bold;">...................持续更新...................</div>]]></content>
      <categories>
        <category>代码优化</category>
      </categories>
      <tags>
        <tag>代码优化</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL 优化】判断结果是否&quot;存在&quot;</title>
    <url>/2021/02/09/39707b73.html</url>
    <content><![CDATA[<blockquote>
<p>当我们从数据库表中查询是否存在满足条件的数据，无论是刚入职场的小白，还是已经秃顶的老白，都是一如既往的用<code>count</code>。</p>
</blockquote>
<a id="more"></a>

<p>如果查询结果只有『有』与『没有』两种状态，那为什么在写<code>SQL</code>的时候，还要<code>SELECT count(*)</code> 呢？</p>
<h3 id="一、目前多数人的写法"><a href="#一、目前多数人的写法" class="headerlink" title="一、目前多数人的写法"></a>一、目前多数人的写法</h3><p>根据一个或多个条件，查询是否存在记录，不关心有多少条记录。普遍的<code>SQL</code>及代码写法如下:</p>
<ul>
<li>sql</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> a = <span class="number">1</span> <span class="keyword">AND</span> b = <span class="number">2</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Java</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> countNum = xxDao.countXxxxByXxx(params);</span><br><span class="line"><span class="keyword">if</span> (countNum &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">  <span class="comment">//当存在时，XXX</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">//当不存在时，XXX</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是不是感觉很OK，没有什么问题。</p>
<h3 id="二、优化方案"><a href="#二、优化方案" class="headerlink" title="二、优化方案"></a>二、优化方案</h3><ul>
<li>sql</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> a = <span class="number">1</span> <span class="keyword">AND</span> b = <span class="number">2</span> <span class="keyword">LIMIT</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Java</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer exist = xxDao.existXxxxByXxx(params);</span><br><span class="line"><span class="keyword">if</span> ( exist != NULL ) &#123;</span><br><span class="line">  <span class="comment">//当存在时，XXX</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">//当不存在时，XXX</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相较于前者，<code>SQL</code>不再使用<code>count</code>，而是改用<code>LIMIT 1</code>，<strong>让数据库查询时遇到一条就返回，不要再继续查找还有多少条了。</strong></p>
<p>这种写法，查出来的条数越多，性能提升的越明显。</p>
]]></content>
      <categories>
        <category>SQL 优化</category>
      </categories>
      <tags>
        <tag>SQL</tag>
        <tag>SQL 优化</tag>
      </tags>
  </entry>
  <entry>
    <title>【并发编程】并发情况的随机数</title>
    <url>/2020/12/09/a7a7fc47.html</url>
    <content><![CDATA[<p>随机数生成是一个非常常见的操作，而且 <code>Java</code>也提供了 <code>java.util.Random</code>类用于生成随机数，而且呢，这个类也是线程安全的，就是有一点不好，在高并发下，它的性能不佳。</p>
<a id="more"></a>

<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><ul>
<li>为什么高并发下，<code>Random</code> 的性能不佳？</li>
</ul>
<p>因为它共享一个<code>Random</code> 实例。这样就会导致多个线程争用。</p>
<p>为了解决这个问题，<code>Java 7</code> 引入了 <code>java.util.concurrent.ThreadLocalRandom</code> 类，用于在多线程环境中生成随机数。</p>
<h2 id="二、ThreadLocalRandom"><a href="#二、ThreadLocalRandom" class="headerlink" title="二、ThreadLocalRandom"></a>二、<code>ThreadLocalRandom</code></h2><ul>
<li>使用方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">random</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ThreadLocalRandom random = ThreadLocalRandom.current();</span><br><span class="line">    Integer num = random.nextInt(<span class="number">10</span>);</span><br><span class="line">    System.out.println(num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>附一个随机字符串工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StrRandomUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全部字符字典</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String allChar = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 纯字母字典</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String letterChar = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 纯数字字典</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String numberChar = <span class="string">"0123456789"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成包含大、小写字母、数字的随机字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length 字符串长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genStr</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        ThreadLocalRandom random = ThreadLocalRandom.current();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            sb.append(allChar.charAt(random.nextInt(allChar.length())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成纯数字字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genDigitalStr</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        ThreadLocalRandom random = ThreadLocalRandom.current();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            sb.append(numberChar.charAt(random.nextInt(numberChar.length())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成只包含大小写字母的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genLetterStr</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        ThreadLocalRandom random = ThreadLocalRandom.current();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            sb.append(letterChar.charAt(random.nextInt(letterChar.length())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成只包含小写字母的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genLowerStr</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> genLetterStr(length).toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成只包含大写字母的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genUpperStr</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> genLetterStr(length).toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成纯0字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genZeroStr</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            sb.append(<span class="string">'0'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把数字转成字符串，长度不够前面补0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strLength</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">genStrWithZero</span><span class="params">(<span class="keyword">int</span> num, <span class="keyword">int</span> strLength)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String strNum = String.valueOf(num);</span><br><span class="line">        <span class="keyword">if</span> (strLength - strNum.length() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            sb.append(genZeroStr(strLength - strNum.length()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"将数字"</span> + num + <span class="string">"转化为长度为"</span> + strLength + <span class="string">"的字符串异常!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(strNum);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>随机数</category>
        <category>并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>【并发编程】浅谈线程安全</title>
    <url>/2020/10/08/113e477d.html</url>
    <content><![CDATA[<p><strong>线程安全不是指线程的安全，而是指内存的安全。</strong></p>
<a id="more"></a>

<h3 id="一、线程不安全"><a href="#一、线程不安全" class="headerlink" title="一、线程不安全"></a>一、线程不安全</h3><h4 id="1-1-线程不安全"><a href="#1-1-线程不安全" class="headerlink" title="1.1 线程不安全"></a>1.1 线程不安全</h4><blockquote>
<p>假设某个线程把数据处理到一半，觉得很累，就去休息了一会；回来准备接着处理，却发现数据已经被修改了，不是自己离开时的样子了，可能被其它线程修改了。</p>
</blockquote>
<ul>
<li><p>目前主流操作系统都是多任务的，即多个进程同时运行。为了保证安全，每个进程只能访问分配给自己的内存空间，而不能访问别的进程的，这是由操作系统保障的。</p>
</li>
<li><p>在每个进程的内存空间中都会有一块特殊的<strong>公共区域</strong>，通常称为<strong>堆（内存）</strong>。进程内的所有线程都可以访问到该区域，这就是造成问题的潜在原因。</p>
</li>
</ul>
<h4 id="1-2-线程安全"><a href="#1-2-线程安全" class="headerlink" title="1.2 线程安全"></a>1.2 线程安全</h4><p><strong>所以线程安全指的是：在堆内存中的数据由于可以被任何线程访问到，在没有限制的情况下存在被意外修改的风险</strong>。</p>
<blockquote>
<p>即堆内存空间在没有保护机制的情况下，对多线程来说是不安全的地方，因为你放进去的数据，可能被别的线程<strong>破坏</strong>。</p>
</blockquote>
<h3 id="二、有什么解决方案"><a href="#二、有什么解决方案" class="headerlink" title="二、有什么解决方案"></a>二、有什么解决方案</h3><h4 id="2-1-私有化"><a href="#2-1-私有化" class="headerlink" title="2.1 私有化"></a>2.1 私有化</h4><p>除了所有线程都可以访问的堆内存，操作系统会为每个线程分配属于它自己的内存空间，通常称为<strong>栈内存</strong>，<strong>其它线程无权访问</strong>，这也是由操作系统保障的。</p>
<blockquote>
<p>如果一些数据只有某个线程会使用，其它线程不能操作也不需要操作，这些数据就可以放入线程的栈内存中。较为常见的就是局部变量。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">avgScore</span><span class="params">(<span class="keyword">double</span>[] scores)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">double</span> score : scores) &#123;</span><br><span class="line">        sum += score;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> count = scores.length;</span><br><span class="line">    <span class="keyword">double</span> avg = sum / count;</span><br><span class="line">    <span class="keyword">return</span> avg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的变量<code>sum</code>，<code>count</code>，<code>avg</code>都是局部变量，它们都会被分配在线程栈内存中。</p>
</blockquote>
<p>假如现在<code>A</code>线程来执行这个方法，这些变量会在<code>A</code>的栈内存分配。与此同时，<code>B</code>线程也来执行这个方法，这些变量也会在<code>B</code>的栈内存中分配。</p>
<p>也就是说<strong>这些数据会在每个线程的栈内存中都分配一份</strong>。由于线程的栈内存只能自己访问，所以栈内存中的数据只属于自己，其它线程根本就不知道。</p>
<h4 id="2-2-线程本地"><a href="#2-2-线程本地" class="headerlink" title="2.2 线程本地"></a>2.2 线程本地</h4><p><code>2.1</code>的解决方案是基于<strong>位置</strong>，因为定义局部变量的<strong>位置</strong>是在方法里，它的使用范围也就被限制在这个方法里了，因此局部变量的安全是由<strong>位置</strong>来保障的。</p>
<blockquote>
<p>往往会有一个变量需要多个方法都能够使用的情况，此时定义这个变量的<strong>位置</strong>就不能在方法里面了，而应该在方法外面。也就是说，这时候的变量将应该分配在<strong>公共的堆内存</strong>中。这种情况下，如何保证公共区域变量的安全呢？</p>
</blockquote>
<p>要让公共区域堆内存中的数据对于每个线程都是安全的，我们可以让每个线程都拷贝一份，每个线程只处理自己的这一份而不去影响别的线程的数据，这不就安全了吗。</p>
<p>我猜大家应该想到了，就是<code>ThreadLocal</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentAssistant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ThreadLocal&lt;String&gt; realName = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">    ThreadLocal&lt;Double&gt; totalScore = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">determineDegree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> score = totalScore.get();</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">90</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"A"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"B"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">70</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"C"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">60</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"D"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"E"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">determineOptionalcourseScore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> score = totalScore.get();</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">90</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">70</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">30</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (score &gt;= <span class="number">60</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">40</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>StudentAssistant.java</code>有两个成员变量，<code>realName</code>和<code>totalScore</code>，都是<code>ThreadLocal</code>类型的。每个线程在运行时都会拷贝一份存储到自己本地。</p>
</blockquote>
<p>线程类（<code>Thread</code>）有一个成员变量，类似于<code>Map</code>类型的，专门用于存储<code>ThreadLocal</code>类型的数据。从逻辑从属关系来讲，这些<code>ThreadLocal</code>数据是属于<code>Thread</code>类的成员变量级别的。从所在<strong>位置</strong>的角度来讲，这些<code>ThreadLocal</code>数据是分配在公共区域的<strong>堆内存</strong>中的。</p>
<blockquote>
<p>说直白一些，就是把堆内存中的一个数据复制<code>N</code>份，每个线程认领<code>1</code>份，同时规定好，每个线程只能玩自己的那份，不准影响别人。</p>
</blockquote>
<p>需要说明的是<strong>这<code>N</code>份数据都还是存储在公共区域堆内存里的</strong>，经常听到的<strong>线程本地</strong>，是从逻辑从属关系上来讲的，这些数据和线程一一对应，仿佛成了线程自己领地的东西了。其实从数据所在<strong>位置</strong>的角度来讲，它们都位于公共的堆内存中，只不过被线程认领了而已。</p>
<h4 id="2-3-互斥锁"><a href="#2-3-互斥锁" class="headerlink" title="2.3 互斥锁"></a>2.3 互斥锁</h4><p>如果公共区域（堆内存）的数据，要被多个线程操作时，为了确保数据的安全性（或一致性），需要在数据旁边放一把锁，要想操作数据，先获取锁。</p>
<ol>
<li>假设一个线程来到数据跟前一看，发现锁是空闲的，没有人持有。于是它就拿到了这把锁，然后开始操作数据，干了一会活，累了，就去休息了。</li>
<li>这时，又来了一个线程，发现锁被别人持有着，按照规定，它不能操作数据，因为它无法得到这把锁。当然，它可以选择等待，或放弃，转而去干别的。</li>
</ol>
<p>第一个线程之所以敢大胆的去睡觉，就是因为它手里拿着锁呢，其它线程是不可能操作数据的。当它回来后继续把数据操作完，就可以把锁给释放了。锁再次回到空闲状态，其它线程就可以来抢这把锁了，谁抢到了锁谁才可以操作数据。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassAssistant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> totalScore = <span class="number">60</span>;</span><br><span class="line">    <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> Lock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addScore</span><span class="params">(<span class="keyword">double</span> score)</span> </span>&#123;</span><br><span class="line">        lock.obtain();</span><br><span class="line">        totalScore += score;</span><br><span class="line">        lock.release();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">subScore</span><span class="params">(<span class="keyword">double</span> score)</span> </span>&#123;</span><br><span class="line">        lock.obtain();</span><br><span class="line">        totalScore -= score;</span><br><span class="line">        lock.release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>假定一个班级的初始分数是<code>60</code>分，这个班级抽出<code>10</code>名学生来同时参加<code>10</code>个不同的答题节目，每个学生答对一次为班级加上<code>5</code>分，答错一次减去<code>5</code>分。因为<code>10</code>个学生一起进行，所以这一定是一个并发情形。为了保证数据的一致性，需要在每次操作前先获取锁，操作完成后再释放锁。</p>
</blockquote>
<h3 id="2-4-CAS"><a href="#2-4-CAS" class="headerlink" title="2.4 CAS"></a>2.4 CAS</h3><blockquote>
<p>上个方案虽然可行，但是锁的获取和释放是要花费一定的代价，如果在线程数目特别少的时候，可能根本就不会有别的线程来操作数据，此时你还要获取锁和释放锁，可以说是一种浪费。</p>
</blockquote>
<p>比如我把数据放到公共区域的堆内存中，但是始终都只会有<code>1</code>个线程，也就是单线程模型，那这数据肯定是安全的。</p>
<p>针对这种<strong>地广人稀</strong>的情况，专门提出了一种方法，叫<code>CAS</code>（<code>Compare And Swap</code>）。就是在并发很小的情况下，数据被意外修改的概率很低，但是又存在这种可能性，此时就用<code>CAS</code>。</p>
<ol>
<li>假如一个线程操作数据，干了一半活，累了，想要去休息。于是它记录下当前数据的状态（就是数据的值），回家睡觉了。</li>
<li>醒来后打算继续接着干活，但是又担心数据可能被修改了，于是就把睡觉前保存的数据状态拿出来和现在的数据状态比较一下，如果一样，说明自己在睡觉期间，数据没有被人动过（当然也有可能是先被改成了其它，然后又改回来了，这就是<code>ABA</code>问题了），那就接着继续干。如果不一样，说明数据已经被修改了，那之前做的那些操作其实都白瞎了，就干脆放弃，从头再重新开始处理一遍。</li>
</ol>
<p>所以<code>CAS</code>这种方式适用于并发量不高的情况，也就是数据被意外修改的可能性较小的情况。如果并发量很高的话，你的数据一定会被修改，每次都要放弃，然后从头再来，这样反而花费的代价更大了，还不如直接加锁。</p>
<ul>
<li><code>ABA</code>问题，举个例子，大家都懂了</li>
</ul>
<blockquote>
<ol>
<li>假如你睡觉前数据是<code>5</code>，醒来后数据还是<code>5</code>，并不能肯定数据没有被修改过。可能数据先被修改成<code>8</code>然后又改回到<code>5</code>，只是你不知道罢了。对于这个问题，其实也很好解决，再加一个版本号字段就行了，并规定只要修改数据，必须使版本号加<code>1</code>。</li>
<li>这样你睡觉前数据是<code>5</code>版本号是<code>0</code>，醒来后数据是<code>5</code>版本号是<code>0</code>，表明数据没有被修改。如果数据是<code>5</code>版本号是<code>2</code>，表明数据被改动了<code>2</code>次，先改为其它，然后又改回到<code>5</code>。</li>
</ol>
</blockquote>
<p>这里的<code>CAS</code>其实就是乐观锁，上一种方案里的获取锁和释放锁其实就是悲观锁。乐观锁持乐观态度，就是假设我的数据不会被意外修改，如果修改了，就放弃，从头再来。悲观锁持悲观态度，就是假设我的数据一定会被意外修改，那干脆直接加锁得了。</p>
<h3 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h3><p>为了保证线程安全，本文提出了四种方案：</p>
<ol>
<li>前两种属于隔离法，一个是位置隔离，一个是数据隔离。</li>
<li>然后是标记法，通过加锁进行标记。</li>
<li>最后一种是大胆法，先来怼一把试试，若不行从头再来（适用于并发不高的情况）。</li>
</ol>
]]></content>
      <categories>
        <category>并发编程</category>
        <category>多线程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
        <tag>线程安全</tag>
      </tags>
  </entry>
  <entry>
    <title>【并发编程】锁分类介绍</title>
    <url>/2020/10/05/c9de5b2f.html</url>
    <content><![CDATA[<p>从<strong>宏观上来分类</strong>，锁可以分为乐观锁与悲观锁。注意，这里说的的锁可以是数据库中的锁，也可以是 <code>Java</code>、<code>Python</code> 等开发语言中的锁技术。</p>
<a id="more"></a>

<h2 id="一、乐观锁与悲观锁"><a href="#一、乐观锁与悲观锁" class="headerlink" title="一、乐观锁与悲观锁"></a>一、乐观锁与悲观锁</h2><h3 id="1-1-悲观锁"><a href="#1-1-悲观锁" class="headerlink" title="1.1 悲观锁"></a>1.1 悲观锁</h3><p>悲观锁是一种悲观思想，即认为写多，遇到并发写的可能性高。悲观锁在持有数据的时候总会把<strong>资源</strong>或者<strong>数据</strong>锁住，这样其他线程想要请求这个资源的时候就会阻塞，直到等到悲观锁把资源释放为止。</p>
<blockquote>
<p>悲观锁的实现往往依靠数据库本身的锁功能实现。</p>
</blockquote>
<ul>
<li><p>常见悲观锁</p>
<ol>
<li>传统的关系型数据库里边就用到了很多这种锁机制，比如<strong>行锁</strong>，<strong>表锁</strong>、<strong>读锁</strong>、<strong>写锁</strong>等，都是<strong>在做操作之前先上锁</strong>。</li>
<li><code>Java</code> 中典型的悲观锁就是 <code>Synchronized</code>和 <code>ReentrantLock</code> 等独占锁(排他锁)。</li>
</ol>
</li>
</ul>
<h3 id="1-2-乐观锁"><a href="#1-2-乐观锁" class="headerlink" title="1.2 乐观锁"></a>1.2 乐观锁</h3><p>乐观锁是一种乐观思想，即认为读多写少，遇到并发写的可能性低。它总认为<strong>资源</strong>和<strong>数据</strong>不会被别人所修改，所以读取不会上锁。但是在进行写操作的时候会判断当前数据是否被修改过。</p>
<blockquote>
<p>乐观锁的实现方案一般来说有两种：版本号机制 和 <code>CAS</code> 实现 。</p>
</blockquote>
<ul>
<li><p>常见乐观锁</p>
<p>  数据库中的共享锁就是一种乐观锁。</p>
</li>
</ul>
<p><strong>乐观锁和悲观锁并不是一种真实存在的锁，而是一种设计思想。</strong></p>
<h3 id="1-3-乐观锁的实现方式"><a href="#1-3-乐观锁的实现方式" class="headerlink" title="1.3 乐观锁的实现方式"></a>1.3 乐观锁的实现方式</h3><p>乐观锁一般有两种实现方式：采用<code>版本号机制</code> 和 <code>CAS（Compare-and-Swap）</code>算法实现。</p>
<ul>
<li>版本号机制</li>
</ul>
<p>版本号机制是在数据表中加上一个 <code>version</code> 字段来实现的，表示数据被修改的次数，当执行写操作并且写入成功后，<code>version = version + 1</code>，当线程 <code>A</code> 要更新数据时，在读取数据的同时也会读取 <code>version</code> 值，在提交更新时，若刚才读取到的 <code>version</code> 值为当前数据库中的 <code>version</code> 值相等时才更新，否则重试更新操作，直到更新成功。</p>
<ul>
<li><code>CAS</code> 算法</li>
</ul>
<p><code>CAS</code> 是一种的无锁算法，即在不使用锁的情况下实现多线程之间的变量同步，也就是在没有线程被阻塞的情况下实现变量的同步，所以也叫非阻塞同步（<code>Non-blocking Synchronization</code>)</p>
<ul>
<li><p><code>CAS</code> 中涉及三个要素：</p>
<ul>
<li>需要读写的内存值 <code>V</code></li>
<li>进行比较的值 <code>A</code></li>
<li>拟写入的新值 <code>B</code></li>
</ul>
</li>
</ul>
<p><strong>当且仅当</strong>预期值 <code>A</code> 和内存值 <code>V</code> 相同时，将内存值 <code>V</code> 修改为 <code>B</code>，否则什么都不做。</p>
<h3 id="1-4-乐观锁的缺点"><a href="#1-4-乐观锁的缺点" class="headerlink" title="1.4 乐观锁的缺点"></a>1.4 乐观锁的缺点</h3><ul>
<li><code>ABA</code> 问题</li>
</ul>
<p>该说的是，如果一个变量第一次读取的值是 <code>A</code>，准备好需要对 <code>A</code> 进行写操作的时候，发现值还是 <code>A</code>。那么这种情况下，能认为 <code>A</code> 的值没有被改变过吗？</p>
<blockquote>
<p>可以是由 <code>A -&gt; B -&gt; A</code> 的这种情况，但是它只相信它看到的，因为第一次读取的值和目前的值相等，所以它就觉得没有变过。</p>
</blockquote>
<ul>
<li>循环开销大</li>
</ul>
<p>我们知道乐观锁在进行写操作的时候会判断是否能够写入成功，如果写入不成功将触发等待 -&gt; 重试机制，进行等待重试的锁，它不适用于长期获取不到锁的情况，而且，循环对于性能开销比较大。</p>
<h3 id="1-5-两种锁的使用场景"><a href="#1-5-两种锁的使用场景" class="headerlink" title="1.5 两种锁的使用场景"></a>1.5 两种锁的使用场景</h3><ol>
<li>一般来说，悲观锁不仅会对写操作加锁，还会对读操作加锁，所以它的性能比较低，但是写比较多的情况下需要使用悲观锁；</li>
<li>相对而言，乐观锁用于读多写少的情况，即很少发生冲突的场景，这样可以省去锁的开销，增加系统的吞吐量。</li>
</ol>
<h2 id="二、公平锁与非公平锁"><a href="#二、公平锁与非公平锁" class="headerlink" title="二、公平锁与非公平锁"></a>二、公平锁与非公平锁</h2><p><strong>根据线程获取锁的抢占机制</strong>，锁可以分为公平锁和非公平锁。</p>
<ul>
<li><p>公平锁：表示线程获取锁的顺序是按照线程请求锁的时间早晚来决定的，也就是最早请求锁的线程将最早获取到锁；</p>
</li>
<li><p>非公平锁：在运行时闯入，也就是先来不一定先得。</p>
</li>
</ul>
<p>在没有公平性需求的前提下尽量使用非公平锁，因为公平锁会带来性能开销。</p>
<h2 id="三、独占锁和共享锁"><a href="#三、独占锁和共享锁" class="headerlink" title="三、独占锁和共享锁"></a>三、独占锁和共享锁</h2><p><strong>根据锁只能被单个线程持有还是能被多个线程共同持有</strong>，锁可以分为独占锁和共享锁。</p>
<ul>
<li>独占锁：保证任何时候都<strong>只有一个线程能得到锁</strong>；</li>
<li>共享锁：可以同时由多个线程持有，它允许一个资源可以被多线程同时进行操作。</li>
</ul>
<h2 id="四、可重入锁和不可重入锁"><a href="#四、可重入锁和不可重入锁" class="headerlink" title="四、可重入锁和不可重入锁"></a>四、可重入锁和不可重入锁</h2><p>当一个线程要获取一个被其他线程持有的独占锁时，该线程会被阻塞，那么当一个线程再次获取它自己已经获取的锁时是否会被阻塞呢？</p>
<ol>
<li>如果不被阻塞，那么我们说该锁是可重入的，也就是只要该线程获取了该锁，那么可以无限次数（严格来说是有限次数）地进入被该锁锁住的代码。</li>
<li>反之，如果被阻塞，说明该锁只能获取一次，即为不可重入锁。</li>
</ol>
<h3 id="可重入锁的原理"><a href="#可重入锁的原理" class="headerlink" title="可重入锁的原理"></a>可重入锁的原理</h3><ol>
<li>在锁内部维护一个线程标示，用来标示该锁目前被哪个线程占用，然后关联一个计数器。一开始计数器值为 <code>0</code>，说明该锁没有被任何线程占用；</li>
<li>当一个线程获取了该锁时，计数器的值会变成 <code>1</code>，这时其他线程再来获取该锁时会发现锁的所有者不是自己而被阻塞挂起；</li>
<li>但是当获取了该锁的线程再次获取锁时发现锁拥有者是自己，就会把计数器值加 <code>+ 1</code>，当释放锁后计数器值 <code>- 1</code>；</li>
<li>当计数器值为 <code>0</code> 时，锁里面的线程标示被重置为 <code>null</code>，这时候被阻塞的线程会被唤醒来竞争获取该锁。</li>
</ol>
<h2 id="五、其他锁"><a href="#五、其他锁" class="headerlink" title="五、其他锁"></a>五、其他锁</h2><h3 id="5-1-自旋锁"><a href="#5-1-自旋锁" class="headerlink" title="5.1 自旋锁"></a>5.1 自旋锁</h3><p>自旋锁是指当一个线程在获取锁的时候，如果锁已经被其它线程获取，那么该线程将循环等待，然后不断的判断锁是否能够被成功获取，直到获取到锁才会退出循环。</p>
<h3 id="5-2-偏向锁-轻量级锁-重量级锁"><a href="#5-2-偏向锁-轻量级锁-重量级锁" class="headerlink" title="5.2 偏向锁/轻量级锁/重量级锁"></a>5.2 偏向锁/轻量级锁/重量级锁</h3><p><code>JVM</code> 为了提高锁的获取与释放效率，而做了以下优化</p>
<ul>
<li><p>分化锁的状态：</p>
<ul>
<li>无锁状态</li>
<li>偏向锁状态</li>
<li>轻量级锁状态</li>
<li>重量级锁状态</li>
</ul>
</li>
</ul>
<blockquote>
<p>说明：</p>
<ol>
<li>锁的状态是通过对象监视器在对象头中的字段来表明的。</li>
<li>四种状态会随着竞争的情况逐渐升级，而且是不可逆的过程，即不可降级。</li>
</ol>
</blockquote>
<ul>
<li><p>偏向锁</p>
<p>  偏向锁是指一段同步代码一直被一个线程所访问，那么该线程会自动获取锁。降低获取锁的代价。</p>
</li>
<li><p>轻量级锁</p>
<p>  轻量级锁是指当锁是偏向锁的时候，被另一个线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，提高性能。</p>
</li>
<li><p>重量级锁</p>
<p>  重量级锁是指当锁为轻量级锁的时候，另一个线程虽然是自旋，但自旋不会一直持续下去，当自旋一定次数的时候，还没有获取到锁，就会进入阻塞，该锁膨胀为重量级锁。重量级锁会让其他申请的线程进入阻塞，性能降低。</p>
</li>
</ul>
<h3 id="5-3分段锁"><a href="#5-3分段锁" class="headerlink" title="5.3分段锁"></a>5.3分段锁</h3><blockquote>
<p>分段锁其实是一种锁的设计，<strong>并不是具体的一种锁</strong>。</p>
</blockquote>
<p>我们一般有三种方式降低锁的竞争程度</p>
<ol>
<li>减少锁的持有时间；</li>
<li>降低锁的请求频率；</li>
<li>使用带有协调机制的独占锁，这些机制允许更高的并发性。</li>
</ol>
<p>在某些情况下我们可以将锁分解技术进一步扩展为<strong>一组独立对象上的锁进行分解</strong>，这成为分段锁。</p>
<p>例如：对于<code>ConcurrentHashMap</code>而言，其并发的实现就是通过分段锁的形式来实现高效的并发操作。</p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<p><a href="https://segmentfault.com/a/1190000017766364" target="_blank" rel="noopener">参考文章</a></p>
]]></content>
      <categories>
        <category>JDK</category>
        <category>并发编程</category>
      </categories>
      <tags>
        <tag>JUC</tag>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>【并发编程】相关概念</title>
    <url>/2020/09/09/feb9f357.html</url>
    <content><![CDATA[<p>世界就是这样一个矛盾体，并发编程能让我们充分地利用<code>CPU</code>资源，提升系统性能。但是同时也给我们带来了很多问题，比如线程上下文切换对性能消耗的问题、共享变量的线程安全问题、线程死锁问题和线程间通信等问题。</p>
<p>研究并行编程就是研究怎么在享受多线程编程给我们带来便利的同时又能规避多线程带来的坑。作为<code>Java</code>后端开发，我们更应该掌握好多线程编程，就要从基础概念出发。</p>
<a id="more"></a>

<p>世界就是这样一个矛盾体，并发编程能让我们充分地利用CPU资源，提升系统性能。但是同时也给我们带来了很多问题，比如线程上下文切换对性能消耗的问题、共享变量的线程安全问题、线程死锁问题和线程间通信等问题。研究并行编程就是研究怎么在享受多线程编程给我们带来便利的同时又能规避多线程带来的坑。作为一个Java后端开发程序员，我们更应该掌握好多线程编程，因为服务器端对性能的追求是非常高的。</p>
<h3 id="一、进程与线程"><a href="#一、进程与线程" class="headerlink" title="一、进程与线程"></a>一、进程与线程</h3><blockquote>
<p>在<code>Linux</code>中，线程与进程最大区别就是<strong>是否共享同一块地址空间</strong>，而且共享同一块地址空间的那一组线程将显现相同的<code>PID</code>号。</p>
</blockquote>
<h4 id="1-1-进程"><a href="#1-1-进程" class="headerlink" title="1.1 进程"></a>1.1 进程</h4><blockquote>
<p>我们开发写的代码称为程序，那么将开发的代码运行起来，称为进程。</p>
</blockquote>
<p>进程是申请一块内存空间,将数据放到内存空间中去, 是申请数据的过程。</p>
<p>进程是最小的资源管理单元。</p>
<ul>
<li>进程之间交互</li>
</ul>
<p>进程之间通过 <code>TCP</code>/<code>IP</code> 端口实现交互。</p>
<h4 id="1-2-线程"><a href="#1-2-线程" class="headerlink" title="1.2 线程"></a>1.2 线程</h4><ul>
<li>线程是操作系统能够进行运算调度的最小单位。</li>
</ul>
<p>线程是进程的一条流水线, 只用来执行程序,而不涉及到申请资源, 是程序的实际执行者。</p>
<p>线程是最小的执行单元。</p>
<ul>
<li>线程之间交互</li>
</ul>
<p>多个线程共享同一块内存, 通过共享的内存空间来进行交互。</p>
<h4 id="1-3-进程与线程的区别和联系"><a href="#1-3-进程与线程的区别和联系" class="headerlink" title="1.3 进程与线程的区别和联系"></a>1.3 进程与线程的区别和联系</h4><ol>
<li>一个进程至少包含一个线程，可以包含多个线程，这些线程共享这个进程的资源（比如堆区和方法区资源）。同时每个线程都拥有独立的运行栈和程序计数器，线程切换开销小。</li>
<li>多进程指的是操作系统同时运行多个程序，如当前操作系统中同时运行着QQ、IE、微信等程序。</li>
<li>多线程指的是同一进程中同时运行多个线程，如迅雷运行时，可以开启多个线程，同时进行多个文件的下载。</li>
</ol>
<p><img src="/File/Imgs/article/processes%20and%20threads%20.png" alt="进程与线程"></p>
<h4 id="1-4-线程号和进程号"><a href="#1-4-线程号和进程号" class="headerlink" title="1.4 线程号和进程号"></a>1.4 线程号和进程号</h4><ol>
<li><code>PID</code>: 进程<code>ID</code>。</li>
<li><code>TGID</code>: 线程组<code>ID</code>，也就是线程组<code>leader</code>的进程<code>ID</code>，等于<code>PID</code>。</li>
<li><code>LWP</code>: 线程<code>ID</code>。在用户态的命令(比如<code>ps</code>)中常用的显示方式。</li>
<li><code>TID</code>: 线程<code>ID</code>，等于<code>LWP</code>。<code>TID</code>在系统提供的接口函数中更常用，比如<code>syscall(SYS_gettid)</code>和<code>syscall(__NR_gettid)</code>。</li>
</ol>
<h3 id="二：同步和异步"><a href="#二：同步和异步" class="headerlink" title="二：同步和异步"></a>二：同步和异步</h3><h4 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1 概念"></a>2.1 概念</h4><blockquote>
<p>同步和异步通常用来形容一次方法调用。</p>
</blockquote>
<p>同步方法调用：调用者必须等到方法调用返回后，才能继续后续的行为。</p>
<p>异步方法调用：方法调用就会立即返回，调用方能立马往下继续执行。被调用的<strong>异步方法其实是由另外的线程进行执行的</strong>，如果这个异步方法有返回值的话可以通过某种通知的方式告知调用方。</p>
<h4 id="2-2-实现异步方法的方式"><a href="#2-2-实现异步方法的方式" class="headerlink" title="2.2 实现异步方法的方式"></a>2.2 实现异步方法的方式</h4><ol>
<li>回调函数模式：一个方法被调用后立马返回，调用结果通过回调函数返回给调用方；</li>
<li><code>MQ</code>（发布/订阅）：请求方将请求发送到<code>MQ</code>，请求处理方监听<code>MQ</code>处理这些请求，并将请求处理结果也返回给某个<code>MQ</code>，调用方监听这个<code>Queue</code>获取处理结果；</li>
<li>多线程处理模式：系统创建其他线程处理调用请求，比如<code>Spring</code>中的<code>@Async</code>注解标注的方法就是这种方法。</li>
</ol>
<h3 id="三：并发、并行、串行"><a href="#三：并发、并行、串行" class="headerlink" title="三：并发、并行、串行"></a>三：并发、并行、串行</h3><blockquote>
<p>并发和并行都可以用来表示两个或者多个任务一起执行，但是侧重点不一样。</p>
</blockquote>
<h4 id="3-1-并发"><a href="#3-1-并发" class="headerlink" title="3.1 并发"></a>3.1 并发</h4><ul>
<li><strong>并发</strong>：是指多个线程任务在同一个<code>CPU</code>上<strong>快速地轮换执行</strong>，由于切换的速度非常快，给人的感觉就是这些线程任务是在同时进行的，但其实并发<strong>只是一种逻辑上的同时进行</strong>。</li>
</ul>
<p><img src="/File/Imgs/article/concurrency.png" alt="并发"></p>
<p>这一张是并发的图，我们发现纵坐标某一时刻只有一个任务是在执行的，CPU在不断的切换线程，以极快的速度给人感觉是同时在执行。</p>
<h4 id="3-2-并行"><a href="#3-2-并行" class="headerlink" title="3.2 并行"></a>3.2 并行</h4><ul>
<li><strong>并行</strong>：是指多个线程任务在不同<code>CPU</code>上同时进行，是真正意义上的同时执行。</li>
</ul>
<p><img src="/File/Imgs/article/parallel.png" alt="并行"></p>
<p>这张图，则完美诠释了线程A、B、C同一时刻同时执行。</p>
<h4 id="3-3-串行"><a href="#3-3-串行" class="headerlink" title="3.3 串行"></a>3.3 串行</h4><p>串行: 一个程序完完整整的运行完, 再运行下一个进程。</p>
<h3 id="四：临界区和上下文切换"><a href="#四：临界区和上下文切换" class="headerlink" title="四：临界区和上下文切换"></a>四：临界区和上下文切换</h3><h4 id="4-1-临界区"><a href="#4-1-临界区" class="headerlink" title="4.1 临界区"></a>4.1 临界区</h4><p><code>临界区</code>通常指<strong>共享数据</strong>，可以被多个线程使用。当有线程进入到临界区时候，其他线程或者进程必须等待。</p>
<blockquote>
<p>比如这样一个程序片段：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 临界区</span></span><br><span class="line">        <span class="keyword">synchronized</span>&#123;</span><br><span class="line">             age++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-上下文切换"><a href="#4-2-上下文切换" class="headerlink" title="4.2 上下文切换"></a>4.2 上下文切换</h4><p>线程在 <code>CPU</code> 上运行之前需要 <code>CPU</code> 给这个线程分配时间片，当时间片运行完之后这个线程就会让出 <code>CPU</code> 资源给其他的线程运行。但是线程在将 <code>CPU</code> 资源让出之前会保存当前的任务状态以便下次获得 <code>CPU</code> 资源之后可以继续往下执行。所以<strong>线程从保存当前执行状态到再加载的过程称为一次上下文切换</strong>。</p>
<h4 id="4-3-减少上下文切换的措施"><a href="#4-3-减少上下文切换的措施" class="headerlink" title="4.3 减少上下文切换的措施"></a>4.3 减少上下文切换的措施</h4><ol>
<li><strong>无锁并发编程</strong>：多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一些办法来避免使用锁，如将数据的<code>ID</code>按照<code>Hash</code>算法取模分段，不同的线程处理不同段的数据；</li>
<li><strong>CAS算法</strong>：<code>Java</code>的<code>Atomic</code>包使用<code>CAS</code>算法来更新数据，而不需要加锁；</li>
<li><strong>使用最少线程</strong>：避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这样会造成大量线程都处于等待状态；</li>
<li><strong>协程</strong>：在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。</li>
</ol>
<h3 id="五：阻塞和非阻塞"><a href="#五：阻塞和非阻塞" class="headerlink" title="五：阻塞和非阻塞"></a>五：阻塞和非阻塞</h3><blockquote>
<p>阻塞和非阻塞通常被用来形容多线程间的相互影响。</p>
</blockquote>
<p>当一个线程占用了临界区资源，那么其它需要使用这个资源的线程都必须在这个临界区上等待。等待会导致线程挂起，这样就形成了阻塞。如果占用资源的线程一直没有释放资源，那么其它的线程在这个临界区上都不能继续工作。<br>相反，非阻塞表明多个线程之间的执行是不会相互影响的。</p>
<h3 id="六、死锁、饥饿、活锁和线程安全"><a href="#六、死锁、饥饿、活锁和线程安全" class="headerlink" title="六、死锁、饥饿、活锁和线程安全"></a>六、死锁、饥饿、活锁和线程安全</h3><h4 id="6-1-死锁"><a href="#6-1-死锁" class="headerlink" title="6.1 死锁"></a>6.1 死锁</h4><p>通俗地说，死锁是两个或者多个线程，相互占用对方需要的资源，而都不进行释放，导致彼此之间都相互等待对方释放资源，产生了无限制等待的现象。</p>
<blockquote>
<p>死锁一旦发生，如果没有外力介入，这种等待将永远存在，从而对程序产生严重的影响。</p>
</blockquote>
<ul>
<li>避免死锁的几个方式：</li>
</ul>
<ol>
<li>尽量不要一个线程同时占用多个锁；</li>
<li>多个线程加锁的顺序保持一致，尽量避免造成死锁的环路结构；</li>
<li>尝试使用定时锁，使用<code>lock.tryLock（timeout</code>）来替代使用内部锁机制；</li>
<li>对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况。</li>
</ol>
<h4 id="6-2-饥饿"><a href="#6-2-饥饿" class="headerlink" title="6.2 饥饿"></a>6.2 饥饿</h4><p>饥饿是指某一个或者多个线程因为种种原因无法获得所需要的资源，导致一直无法执行，比如它的线程优先级可能太低，而高优先级的线程不断抢占它需要的资源，导致低优先级线程无法工作。</p>
<blockquote>
<p>此外，某一个线程一直占着关键资源不放，导致其他需要这个资源的线程无法正常执行，这种情况也是饥饿的一种。</p>
</blockquote>
<p>与死锁相比，饥饿还是有可能在未来一段时间内解决的（比如，高优先级的线程已经完成任务，不再疯狂执行）。</p>
<h4 id="6-3-活锁"><a href="#6-3-活锁" class="headerlink" title="6.3 活锁"></a>6.3 活锁</h4><p>任务或者执行者没有被阻塞，由于某些条件没有满足，导致一直重复尝试、失败、尝试、失败。</p>
<blockquote>
<p>活锁和死锁的区别在于，处于活锁的实体时在不断改变状态，活锁有可能自行解开而死锁不能。</p>
</blockquote>
<h4 id="6-4-线程安全"><a href="#6-4-线程安全" class="headerlink" title="6.4 线程安全"></a>6.4 线程安全</h4><p>如果线程的随机调度顺序不影响某段代码的最后执行结果，那么我们认为这段代码是线程安全的。</p>
]]></content>
      <categories>
        <category>并发编程</category>
      </categories>
      <tags>
        <tag>并发编程</tag>
        <tag>并发</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 整合 Apache Dubbo</title>
    <url>/2020/08/01/db934a06.html</url>
    <content><![CDATA[<blockquote>
<p>注意，是 <code>Apache Dubbo</code>，不再是 <code>Alibaba Dubbo</code>。简单来说就是 <code>Alibaba</code> 将 <code>Dubbo</code> 移交给 <code>Apache</code> 开源社区进行维护。参见 <a href="https://github.com/apache/dubbo-spring-boot-project/blob/master/README_CN.md" target="_blank" rel="noopener">dubbo-spring-boot-project</a></p>
</blockquote>
<a id="more"></a>

<p><code>Apache Dubbo</code>是一款高性能、轻量级的开源 <code>Java</code> <code>RPC</code> 框架，它提供了三大核心能力：面向接口的远程方法调用，智能容错和负载均衡，以及服务自动注册和发现。</p>
<h2 id="一、本文示例说明"><a href="#一、本文示例说明" class="headerlink" title="一、本文示例说明"></a>一、本文示例说明</h2><h3 id="1-1-框架版本"><a href="#1-1-框架版本" class="headerlink" title="1.1 框架版本"></a>1.1 框架版本</h3><ul>
<li><code>Dubbo</code> 版本</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>Spring Boot</code> 版本</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-模块关系"><a href="#1-2-模块关系" class="headerlink" title="1.2 模块关系"></a>1.2 模块关系</h3><ul>
<li>根工程 <code>order</code>：管理工程信息；</li>
<li>子工程 <code>order-api</code>：定义<code>RPC</code>服务的接口、参数以及响应结果的结果集；</li>
<li>子工程 <code>order-provider</code>：<code>RPC</code>服务的提供端；</li>
<li>子工程 <code>order-consumer</code>：<code>RPC</code>服务的消费端，实际开发过程中实际情况是其它服务的调用该订单<code>RPC</code>服务</li>
</ul>
<h2 id="二、根工程"><a href="#二、根工程" class="headerlink" title="二、根工程"></a>二、根工程</h2><h3 id="2-1-创建项目-order"><a href="#2-1-创建项目-order" class="headerlink" title="2.1 创建项目 order"></a>2.1 创建项目 <code>order</code></h3><blockquote>
<p>我这里为了和之前老版本的<code>alibaba</code>的<code>dubbo</code>项目区分，文件名取为<code>apache-dubbo-demo</code>，<code>maven</code> 项目名称为<code>order</code>。</p>
</blockquote>
<p>该项目主要作用是定义工程信息、管理整个项目依赖版本等等，所以<code>src</code>目录不需要。</p>
<h3 id="2-2-pom-xml"><a href="#2-2-pom-xml" class="headerlink" title="2.2 pom.xml"></a>2.2 <code>pom.xml</code></h3><p>根工程中使用了<code>&lt;dependencyManagement&gt;</code>和<code>&lt;dependencies&gt;</code>进行依赖管理。</p>
<ol>
<li><code>&lt;dependencyManagement&gt;</code>：声明全局依赖，当子项目指定引用才会继承依赖；</li>
<li><code>&lt;dependencies&gt;</code>：声明全局依赖，子项目直接自动继承依赖。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 父级引用 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 基本信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Apache Dubbo 根项目<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.7.5<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">zookeeper.version</span>&gt;</span>3.4.14<span class="tag">&lt;/<span class="name">zookeeper.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 子项目 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>order-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>order-provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>order-consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--声明全局依赖（子项目需要显示的引用才会继承依赖）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- dubbo-start依赖 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--zookeeper 注册中心客户端引入 使用的是curator客户端 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-dependencies-zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--声明全局依赖（子项目不需要显示的引用，自动继承依赖）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- spring boot 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 打包插件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="三、order-api"><a href="#三、order-api" class="headerlink" title="三、order-api"></a>三、<code>order-api</code></h2><h3 id="3-1-项目依赖"><a href="#3-1-项目依赖" class="headerlink" title="3.1 项目依赖"></a>3.1 项目依赖</h3><blockquote>
<p>无需更多依赖，所以很简单。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>dubbo公共项目<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-封装-RPC-结果集"><a href="#3-2-封装-RPC-结果集" class="headerlink" title="3.2 封装 RPC 结果集"></a>3.2 封装 <code>RPC</code> 结果集</h3><ul>
<li>先封装一个返回码枚举类<code>ResultCodeEnum.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ResultCodeEnum &#123;</span><br><span class="line">    <span class="comment">/*** 通用部分 100 - 599***/</span></span><br><span class="line">    <span class="comment">// 成功请求</span></span><br><span class="line">    SUCCESS(<span class="number">200</span>, <span class="string">"successful"</span>),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*** 这里可以根据不同模块用不同的区级分开错误码，例如:  ***/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1000～1999 区间表示用户模块错误</span></span><br><span class="line">    <span class="comment">// 2000～2999 区间表示订单模块错误</span></span><br><span class="line">    <span class="comment">// 3000～3999 区间表示商品模块错误</span></span><br><span class="line">    <span class="comment">// 。。。</span></span><br><span class="line"></span><br><span class="line">    ORDER_NOT_FOUND(<span class="number">2000</span>, <span class="string">"order not found"</span>),</span><br><span class="line">    ;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultCodeEnum(Integer code, String msg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>先封装一个RPC 响应结果集<code>RpcResult.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RpcResult</span> &lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否响应成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器开始</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无参构造器(构造器私有，外部不可以直接创建)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RpcResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = <span class="number">200</span>;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有参构造器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RpcResult</span><span class="params">(T obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = <span class="number">200</span>;</span><br><span class="line">        <span class="keyword">this</span>.data = obj;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有参构造器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultCode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RpcResult</span><span class="params">(ResultCodeEnum resultCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.code = resultCode.getCode();</span><br><span class="line">        <span class="keyword">this</span>.message = resultCode.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构造器结束</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用返回成功（没有返回结果）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; RpcResult&lt;T&gt; <span class="title">success</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RpcResult();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回成功（有返回结果）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; RpcResult&lt;T&gt; <span class="title">success</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RpcResult&lt;T&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用返回失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; RpcResult&lt;T&gt; <span class="title">failure</span><span class="params">(ResultCodeEnum resultCode)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> RpcResult&lt;T&gt;(resultCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccess</span><span class="params">(Boolean success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(Integer code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"RpcResult&#123;"</span> +</span><br><span class="line">                <span class="string">"success="</span> + success +</span><br><span class="line">                <span class="string">", code="</span> + code +</span><br><span class="line">                <span class="string">", data="</span> + data +</span><br><span class="line">                <span class="string">", message='"</span> + message + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-编写一个-RPC-接口"><a href="#3-3-编写一个-RPC-接口" class="headerlink" title="3.3 编写一个 RPC 接口"></a>3.3 编写一个 <code>RPC</code> 接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDubboService</span> </span>&#123;</span><br><span class="line">    <span class="function">RpcResult&lt;OrderDomain&gt; <span class="title">getOrder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实体<code>OrderDomain.java</code>挺简单的，详见 <code>Github</code> 仓库。</p>
</blockquote>
<h2 id="四、order-provider"><a href="#四、order-provider" class="headerlink" title="四、order-provider"></a>四、<code>order-provider</code></h2><p>此子项目是一个服务类项目，也就是将接口服务注册到<code>zookeeper</code>注册中心供消费端调取使用。</p>
<h3 id="4-1-项目依赖"><a href="#4-1-项目依赖" class="headerlink" title="4.1 项目依赖"></a>4.1 项目依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Dubbo 服务提供者<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- zookeeper依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-dependencies-zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-服务实现接口"><a href="#4-2-服务实现接口" class="headerlink" title="4.2 服务实现接口"></a>4.2 服务实现接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDubboServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderDubboService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RpcResult&lt;OrderDomain&gt; <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RpcResult.success(<span class="keyword">new</span> OrderDomain(<span class="number">1</span>, <span class="number">10086</span>, LocalDateTime.now()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong><br><code>@Service</code> 是 <code>dubbo</code> 包下面的注解不是 <code>Spring</code> 里面的注解。</p>
<h3 id="4-3-项目配置"><a href="#4-3-项目配置" class="headerlink" title="4.3 项目配置"></a>4.3 项目配置</h3><ol>
<li><code>dubbo</code>  的配置直接用 <code>dubbo</code>，不再以 <code>Spring</code> 开头;</li>
<li><code>base-packages</code>：指定接口实现所在路径。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  # 服务端口</span><br><span class="line">  port: 7777</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-provider</span><br><span class="line"># dubbo 相关配置(dubbo 的配置不再以 Spring 开头)</span><br><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    # 应用名称</span><br><span class="line">    name: order-provider</span><br><span class="line">  scan:</span><br><span class="line">    # 接口实现者（服务实现）包</span><br><span class="line">    base-packages: cn.van.order.service.impl</span><br><span class="line">  # 注册中心信息</span><br><span class="line">  registry:</span><br><span class="line">    address: zookeeper://127.0.0.1:2181</span><br><span class="line">  protocol:</span><br><span class="line">    # 协议名称</span><br><span class="line">    name: dubbo</span><br><span class="line">    # 协议端口</span><br><span class="line">    port: 20880</span><br></pre></td></tr></table></figure>

<h2 id="五、order-consumer"><a href="#五、order-consumer" class="headerlink" title="五、order-consumer"></a>五、<code>order-consumer</code></h2><p>此子项目就是一个消费项目，比如商品模块、财务模块等等。</p>
<h3 id="5-1-项目依赖"><a href="#5-1-项目依赖" class="headerlink" title="5.1 项目依赖"></a>5.1 项目依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Dubbo 消费者<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van.order<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>order-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- web项目依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- dubbo依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- dubbo的zookeeper依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.dubbo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-dependencies-zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-测试接口"><a href="#5-2-测试接口" class="headerlink" title="5.2 测试接口"></a>5.2 测试接口</h3><p>模拟一个接口获取订单详情。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderConsumerController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Reference</span></span><br><span class="line">    OrderDubboService orderDubboService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"getOrder"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RpcResult <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderDubboService.getOrder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong><code>@Reference</code>引入的是 <code>Dubbo</code> 接口，所以是 <code>Dubbo</code> 的注解。</p>
<h3 id="5-3-配置文件"><a href="#5-3-配置文件" class="headerlink" title="5.3 配置文件"></a>5.3 配置文件</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7000</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: order-consumer</span><br><span class="line"># dubbo 相关配置</span><br><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    name: order-consumer</span><br><span class="line">  registry:</span><br><span class="line">    address: zookeeper://127.0.0.1:2181</span><br></pre></td></tr></table></figure>

<h2 id="六、测试"><a href="#六、测试" class="headerlink" title="六、测试"></a>六、测试</h2><p>一切就绪，如果在<code>order-consumer</code> 的测试接口能成功请求到数据，则证明 <code>Dubbo</code> 服务搭建成功。</p>
<h3 id="6-1-启动-zookeeper"><a href="#6-1-启动-zookeeper" class="headerlink" title="6.1 启动 zookeeper"></a>6.1 启动 <code>zookeeper</code></h3><p>我们选用<code>zookeeper</code>作为注册中心，因此启动项目之前需要先启动它。</p>
<h3 id="6-2-dubbo-admin"><a href="#6-2-dubbo-admin" class="headerlink" title="6.2 dubbo-admin"></a>6.2 <code>dubbo-admin</code></h3><p><code>dubbo-admin</code> 便于观察 <code>order-provider</code> 是否成功将接口注册，具体安装步骤详见<a href="https://github.com/apache/dubbo-admin/blob/develop/README_ZH.md" target="_blank" rel="noopener">apache/dubbo-admin</a></p>
<blockquote>
<p>默认端口：<code>8080</code>。</p>
</blockquote>
<h3 id="6-3-启动-dubbo-provider"><a href="#6-3-启动-dubbo-provider" class="headerlink" title="6.3 启动 dubbo-provider"></a>6.3 启动 <code>dubbo-provider</code></h3><p>成功启动后可以在<code>dubbo-admin</code>：已经成功将接口 <code>OrderService</code> 注册到 <code>zookeeper</code> 上如下：</p>
<p><img src="" alt="图一"></p>
<p>成功将借口注册到注册中心，说明<code>dubbo-provider</code> 注册成功。</p>
<h3 id="6-4-启动-order-cosumer"><a href="#6-4-启动-order-cosumer" class="headerlink" title="6.4 启动 order-cosumer"></a>6.4 启动 <code>order-cosumer</code></h3><p>启动消费者项目，在浏览器请求消费接口：<a href="http://localhost:7000/order/getOrder" target="_blank" rel="noopener">http://localhost:7000/order/getOrder</a>，成功返回数据如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"success"</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"code"</span>:<span class="number">200</span>,</span><br><span class="line">    <span class="attr">"data"</span>:&#123;</span><br><span class="line">        <span class="attr">"id"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"orderNum"</span>:<span class="number">10086</span>,</span><br><span class="line">        <span class="attr">"gmtCreate"</span>:<span class="string">"2020-05-06T11:59:45.535"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"message"</span>:<span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功请求到 <code>order-provider</code> 提供的数据，说明 <code>Dubbo</code> 搭建成功！</p>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>以上的完整代码我已上传到 <a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-dubbo/apache-dubbo-demo" target="_blank" rel="noopener">Github</a>，需要的可以自取测试，欢迎<code>star</code>！</p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 正则表达式详解</title>
    <url>/2020/06/10/dfc95706.html</url>
    <content><![CDATA[<blockquote>
<p>正则表达式定义了字符串的模式，可以用来搜索、编辑或处理文本。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、正则基础知识点"><a href="#一、正则基础知识点" class="headerlink" title="一、正则基础知识点"></a>一、正则基础知识点</h2><h3 id="1-1-元字符"><a href="#1-1-元字符" class="headerlink" title="1.1 元字符"></a>1.1 元字符</h3><p>元字符是构造正则表达式的一种基本元素。  </p>
<ul>
<li>几个常用的元字符：</li>
</ul>
<table>
<thead>
<tr>
<th>元字符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>.</td>
<td>匹配除换行符以外的任意字符</td>
</tr>
<tr>
<td>\w</td>
<td>匹配字母或数字或下划线或汉字</td>
</tr>
<tr>
<td>\s</td>
<td>匹配任意的空白符</td>
</tr>
<tr>
<td>\d</td>
<td>匹配数字</td>
</tr>
<tr>
<td>\b</td>
<td>匹配单词的开始或结束</td>
</tr>
<tr>
<td>^</td>
<td>匹配字符串的开始</td>
</tr>
<tr>
<td>$</td>
<td>匹配字符串的结束</td>
</tr>
</tbody></table>
<h3 id="1-2-重复限定符"><a href="#1-2-重复限定符" class="headerlink" title="1.2 重复限定符"></a>1.2 重复限定符</h3><p>正则表达式中一些重复限定符，把重复部分用合适的限定符替代。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>*</td>
<td>重复零次或更多次</td>
</tr>
<tr>
<td>+</td>
<td>重复一次或更多次</td>
</tr>
<tr>
<td>?</td>
<td>重复零次或一次</td>
</tr>
<tr>
<td>{n}</td>
<td>重复 n 次</td>
</tr>
<tr>
<td>{n,}</td>
<td>重复 n 次或更多次</td>
</tr>
<tr>
<td>{n,m}</td>
<td>重复 n 到 m 次</td>
</tr>
</tbody></table>
<h3 id="1-3-分组"><a href="#1-3-分组" class="headerlink" title="1.3 分组"></a>1.3 分组</h3><p>限定符是作用在与他左边最近的一个字符，如果我想要多个字符同时被限定那怎么办呢？</p>
<p><strong>正则表达式中用小括号 <code>()</code> 来做分组，也就是括号中的内容作为一个整体。</strong></p>
<h3 id="1-4-转义"><a href="#1-4-转义" class="headerlink" title="1.4 转义"></a>1.4 转义</h3><p>我们看到正则表达式用小括号来做分组，那么问题来了：</p>
<blockquote>
<p>如果要匹配的字符串中本身就包含小括号，那是不是冲突？应该怎么办？</p>
</blockquote>
<p>针对这种情况，正则提供了转义的方式，也就是要把这些元字符、限定符或者关键字转义成普通的字符，做法很简答，就是在要转义的字符前面加个斜杠，也就是 <code>\</code> 即可。</p>
<h3 id="1-5-条件或"><a href="#1-5-条件或" class="headerlink" title="1.5 条件或"></a>1.5 条件或</h3><p><strong>正则用符号 <code>|</code> 来表示或，也叫做分支条件，当满足正则里的分支条件的任何一种条件时，都会当成是匹配成功。</strong></p>
<h3 id="1-6-区间"><a href="#1-6-区间" class="headerlink" title="1.6 区间"></a>1.6 区间</h3><p>正则提供一个元字符中括号 <code>[]</code> 来表示区间条件。</p>
<ol>
<li>限定 <code>0</code> 到 <code>9</code> 可以写成 <code>[0-9]</code>；</li>
<li>限定 <code>A-Z</code> 写成 <code>[A-Z]</code>；</li>
<li>限定某些数字 <code>[165]</code>。</li>
</ol>
<h3 id="1-7-反义"><a href="#1-7-反义" class="headerlink" title="1.7 反义"></a>1.7 反义</h3><p>前面说到元字符的都是要匹配什么什么，当然如果你想反着来，不想匹配某些字符。</p>
<ul>
<li>常用的反义元字符：</li>
</ul>
<table>
<thead>
<tr>
<th>元字符</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>\W</td>
<td>匹配任意不是字母，数字，下划线，汉字的字符</td>
</tr>
<tr>
<td>\S</td>
<td>匹配任意不是空白符的字符</td>
</tr>
<tr>
<td>\D</td>
<td>匹配任意非数字的字符</td>
</tr>
<tr>
<td>\B</td>
<td>匹配不是单词开头或结束的位置</td>
</tr>
<tr>
<td>[^x]</td>
<td>匹配除了 x 以外的任意字符</td>
</tr>
<tr>
<td>[^aeiou]</td>
<td>匹配除了 aeiou 这几个字母以外的任意字符</td>
</tr>
</tbody></table>
<h2 id="二、Java-正则基础知识"><a href="#二、Java-正则基础知识" class="headerlink" title="二、Java 正则基础知识"></a>二、Java 正则基础知识</h2><h3 id="2-1-Pattern-类"><a href="#2-1-Pattern-类" class="headerlink" title="2.1 Pattern 类"></a>2.1 <code>Pattern</code> 类</h3><ul>
<li>定义</li>
</ul>
<p><code>Pattern</code> 对象是一个正则表达式的编译表示，它的构造方法是私有的,不可以直接创建，但可以通过 <code>Pattern.complie(String regex)</code> 简单工厂方法创建一个正则表达式。</p>
<ul>
<li>常用方法</li>
</ul>
<ol>
<li><code>complie(String regex)</code>：创建一个正则表达式对象；</li>
<li><code>pattern()</code>：返回正则表达式的字符串形式；</li>
<li><code>split(CharSequence input)</code>：用于分隔字符串,并返回一个<code>String[]</code> （<code>JDK</code> 中 <code>String.split(String regex)</code>就是通过<code>Pattern.split(CharSequence input)</code>实现的）；</li>
<li><code>matcher(String regex,CharSequence input)</code>：用于快速匹配字符串,该方法适合用于只匹配一次,且匹配全部字符串；</li>
<li><code>matcher(CharSequence input)</code>：返回一个 <code>Matcher</code> 对象。</li>
</ol>
<blockquote>
<p><code>Matcher</code> 类的构造方法也是私有的,不能随意创建,只能通过<code>Pattern.matcher(CharSequence input)</code>方法得到该类的实例.</p>
</blockquote>
<ul>
<li>小结</li>
</ul>
<p><code>Pattern</code> 类只能做一些简单的匹配操作,要想得到更强更便捷的正则匹配操作,那就需要将 <code>Pattern</code> 与 <code>Matcher</code> 一起使用。</p>
<h3 id="2-2-Matcher-类"><a href="#2-2-Matcher-类" class="headerlink" title="2.2 Matcher 类"></a>2.2 <code>Matcher</code> 类</h3><ul>
<li>定义</li>
</ul>
<p><code>Matcher</code> 对象是对输入字符串进行解释和匹配操作的引擎。与 <code>Pattern</code> 类一样，<code>Matcher</code> 也没有公共构造方法。你需要调用 <code>Pattern</code> 对象的 <code>matcher()</code> 方法来获得一个 <code>Matcher</code> 对象。</p>
<ul>
<li>常用方法</li>
</ul>
<blockquote>
<p><code>Matcher</code> 类提供三个匹配操作方法均返回 <code>boolean</code> 类型。</p>
</blockquote>
<ol>
<li><code>matches()</code>：对整个字符串进行匹配,只有整个字符串都匹配了才返回<code>true</code>；</li>
<li><code>lookingAt()</code>：对前面的字符串进行匹配,只有匹配到的字符串在最前面才返回 <code>true</code>；</li>
<li><code>find()</code>：对字符串进行匹配,匹配到的字符串可以在任何位置。</li>
</ol>
<h3 id="2-3-Matcher-类拓展"><a href="#2-3-Matcher-类拓展" class="headerlink" title="2.3 Matcher 类拓展"></a>2.3 <code>Matcher</code> 类拓展</h3><p>当使用<code>matches()</code>、<code>lookingAt()</code>、<code>find()</code> 执行匹配操作后,就可以利用以下三个方法得到更详细的信息.</p>
<ol>
<li><p><code>start()</code>：返回匹配到的子字符串在字符串中的索引位置；</p>
</li>
<li><p><code>end()</code>：返回匹配到的子字符串的最后一个字符在字符串中的索引位置；</p>
</li>
<li><p><code>group()</code>：返回匹配到的子字符串。</p>
</li>
</ol>
<ul>
<li><code>Matcher</code> 类同时提供了四个将匹配子串替换成指定字符串的方法：</li>
</ul>
<ol>
<li><code>replaceAll()</code> ;</li>
<li><code>replaceFirst()</code> ;</li>
<li><code>appendReplacement()</code> ;</li>
<li><code>appendTail()</code>。</li>
</ol>
<ul>
<li>小结</li>
</ul>
<p><code>Matcher</code> 类提供了对正则表达式的分组支持,以及对正则表达式的多次匹配支持。</p>
<h2 id="三、【推荐】正则工具类"><a href="#三、【推荐】正则工具类" class="headerlink" title="三、【推荐】正则工具类"></a>三、【推荐】正则工具类</h2><h3 id="3-1-正则表达式常量"><a href="#3-1-正则表达式常量" class="headerlink" title="3.1 正则表达式常量"></a>3.1 正则表达式常量</h3><p>为了便于管理正则表达式，专门用一个常量类存放正则表达式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegexConstant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：手机号（简单）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_MOBILE_SIMPLE = <span class="string">"^[1]\\d&#123;10&#125;$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：手机号（精确）</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;移动：134(0-8)、135、136、137、138、139、147、150、151、152、157、158、159、178、182、183、184、187、188&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;联通：130、131、132、145、155、156、175、176、185、186&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;电信：133、153、173、177、180、181、189&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;全球星：1349&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;虚拟运营商：170&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_MOBILE_EXACT = <span class="string">"^((13[0-9])|(14[5,7])|(15[0-3,5-9])|(17[0,3,5-8])|(18[0-9])|(147))\\d&#123;8&#125;$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：电话号码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_TEL = <span class="string">"^0\\d&#123;2,3&#125;[- ]?\\d&#123;7,8&#125;"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：身份证号码15位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_ID_CARD15 = <span class="string">"^[1-9]\\d&#123;7&#125;((0\\d)|(1[0-2]))(([0|1|2]\\d)|3[0-1])\\d&#123;3&#125;$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：身份证号码18位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_ID_CARD18 = <span class="string">"^[1-9]\\d&#123;5&#125;[1-9]\\d&#123;3&#125;((0\\d)|(1[0-2]))(([0|1|2]\\d)|3[0-1])\\d&#123;3&#125;([0-9Xx])$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：邮箱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_EMAIL = <span class="string">"^\\w+([-+.]\\w+)*@\\w+([-.]\\w+)*\\.\\w+([-.]\\w+)*$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_URL = <span class="string">"[a-zA-z]+://[^\\s]*"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：汉字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_ZH = <span class="string">"^[\\u4e00-\\u9fa5]+$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：用户名，取值范围为a-z,A-Z,0-9,"_",汉字，不能以"_"结尾,用户名必须是6-20位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_USERNAME = <span class="string">"^[\\w\\u4e00-\\u9fa5]&#123;6,20&#125;(?&lt;!_)$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：yyyy-MM-dd格式的日期校验，已考虑平闰年</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_DATE = <span class="string">"^(?:(?!0000)[0-9]&#123;4&#125;-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]&#123;2&#125;(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：IP地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_IP = <span class="string">"((2[0-4]\\d|25[0-5]|[01]?\\d\\d?)\\.)&#123;3&#125;(2[0-4]\\d|25[0-5]|[01]?\\d\\d?)"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：双字节字符(包括汉字在内)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_DOUBLE_BYTE_CHAR = <span class="string">"[^\\x00-\\xff]"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：空白行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_BLANK_LINE = <span class="string">"\\n\\s*\\r"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：QQ号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_QQ = <span class="string">"[1-9][0-9]&#123;4,&#125;"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：中国邮政编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_ZIP_CODE = <span class="string">"[1-9]\\d&#123;5&#125;(?!\\d)"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：正整数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_POSITIVE_INTEGER = <span class="string">"^[1-9]\\d*$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：负整数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_NEGATIVE_INTEGER = <span class="string">"^-[1-9]\\d*$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：整数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_INTEGER = <span class="string">"^-?[1-9]\\d*$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：非负整数(正整数 + 0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_NOT_NEGATIVE_INTEGER = <span class="string">"^[1-9]\\d*|0$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：非正整数（负整数 + 0）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_NOT_POSITIVE_INTEGER = <span class="string">"^-[1-9]\\d*|0$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：正浮点数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_POSITIVE_FLOAT = <span class="string">"^[1-9]\\d*\\.\\d*|0\\.\\d*[1-9]\\d*$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：负浮点数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_NEGATIVE_FLOAT = <span class="string">"^-[1-9]\\d*\\.\\d*|-0\\.\\d*[1-9]\\d*$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：只有数字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_NUMBER = <span class="string">"[0-9]*"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：字母、数字及下划线</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_NUMBER_LETTER = <span class="string">"^[0-9a-zA-Z-][\\w-_]&#123;1,&#125;$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：只有字母</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_LETTER = <span class="string">"^[A-Za-z]+$"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则：是否包含括号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REGEX_BRACKETS = <span class="string">".*[()\\[\\]&#123;&#125;（）]+.*"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 正则中需要被转义的关键字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Character[] KEYS_ARRAY = &#123;<span class="string">'$'</span>, <span class="string">'('</span>, <span class="string">')'</span>, <span class="string">'*'</span>, <span class="string">'+'</span>, <span class="string">'.'</span>, <span class="string">'['</span>, <span class="string">']'</span>, <span class="string">'?'</span>, <span class="string">'\\'</span>, <span class="string">'^'</span>, <span class="string">'&#123;'</span>, <span class="string">'&#125;'</span>, <span class="string">'|'</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Set&lt;Character&gt; RE_KEYS = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(KEYS_ARRAY));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-判断是否匹配正则"><a href="#3-2-判断是否匹配正则" class="headerlink" title="3.2 判断是否匹配正则"></a>3.2 判断是否匹配正则</h3><p>配合正则表达式进行判断是否匹配</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMatch</span><span class="params">(String regex, CharSequence input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> input != <span class="keyword">null</span> &amp;&amp; input.length() &gt; <span class="number">0</span> &amp;&amp; Pattern.matches(regex, input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">isMatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String input = <span class="string">"0571-69123456"</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isTel =  RegexUtil.isMatch(RegexConstant.REGEX_TEL, input);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, isTel);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">boolean</span> isPhone =  RegexUtil.isMatch(RegexConstant.REGEX_MOBILE_SIMPLE, input);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, isPhone);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-获取正则匹配的部分"><a href="#3-3-获取正则匹配的部分" class="headerlink" title="3.3 获取正则匹配的部分"></a>3.3 获取正则匹配的部分</h3><ul>
<li>返回结果是字符串</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMatches</span><span class="params">(String regex, CharSequence input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span> || input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuffer matches = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    Pattern pattern = Pattern.compile(regex);</span><br><span class="line">    Matcher matcher = pattern.matcher(input);</span><br><span class="line">    <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">        matches.append(matcher.group());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> matches.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回结果是集合</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Object&gt; <span class="title">getMatchesList</span><span class="params">(String regex, CharSequence input)</span> </span>&#123;</span><br><span class="line">    Pattern pattern = Pattern.compile(regex);</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span> || input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Object&gt; matches = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Matcher matcher = pattern.matcher(input);</span><br><span class="line">    <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!matcher.group().isEmpty()) &#123;</span><br><span class="line">            matches.add(matcher.group());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> matches;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getMatches</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String input = <span class="string">"0571-69123456"</span>;</span><br><span class="line">    String result = RegexUtil.getMatches(RegexConstant.REGEX_NUMBER, input);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, result);</span><br><span class="line">    List&lt;Object&gt; list = RegexUtil.getMatchesList(RegexConstant.REGEX_NUMBER, input);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-计算指定字符串中，匹配-pattern-的个数"><a href="#3-4-计算指定字符串中，匹配-pattern-的个数" class="headerlink" title="3.4 计算指定字符串中，匹配 pattern 的个数"></a>3.4 计算指定字符串中，匹配 pattern 的个数</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">(String regex, CharSequence input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == regex || input == <span class="keyword">null</span> || input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Pattern pattern = Pattern.compile(regex);</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> Matcher matcher = pattern.matcher(input);</span><br><span class="line">    <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!matcher.group().isEmpty()) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String input = <span class="string">"0571-69123456"</span>;</span><br><span class="line">    <span class="keyword">int</span> result = RegexUtil.count(RegexConstant.REGEX_NUMBER, input);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-替换正则匹配"><a href="#3-5-替换正则匹配" class="headerlink" title="3.5 替换正则匹配"></a>3.5 替换正则匹配</h3><ul>
<li>替换所有正则匹配的部分</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">replaceAll</span><span class="params">(String regex, String input, String replacement)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span> || input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Pattern.compile(regex).matcher(input).replaceAll(replacement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>替换正则匹配的第一部分</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">replaceFirst</span><span class="params">(String regex, String input, String replacement)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span> || input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Pattern.compile(regex).matcher(input).replaceFirst(replacement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>删除指定前缀，如果没有找到，则返回原文</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">delPre</span><span class="params">(String regex, CharSequence input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (regex == <span class="keyword">null</span> || input == <span class="keyword">null</span> ||input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Pattern pattern = Pattern.compile(regex, Pattern.DOTALL);</span><br><span class="line">    Matcher matcher = pattern.matcher(input);</span><br><span class="line">    <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">        <span class="keyword">return</span> input.toString().substring(matcher.end(), input.length());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> input.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String input = <span class="string">"0571-69123456-hz"</span>;</span><br><span class="line">    String result = RegexUtil.replaceAll(<span class="string">"-"</span>,input,<span class="string">"_"</span>);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, result);</span><br><span class="line">    result = RegexUtil.replaceFirst(<span class="string">"-"</span>,input,<span class="string">"_"</span>);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, result);</span><br><span class="line">    result = RegexUtil.delPre(<span class="string">"-"</span>,input);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-6-转义字符串"><a href="#3-6-转义字符串" class="headerlink" title="3.6 转义字符串"></a>3.6 转义字符串</h3><blockquote>
<p>将 <code>Java</code> 中的正则的关键字转义。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">escape</span><span class="params">(CharSequence input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="keyword">null</span> ||input.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">int</span> len = input.length();</span><br><span class="line">    <span class="keyword">char</span> current;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        current = input.charAt(i);</span><br><span class="line">        <span class="keyword">if</span> (RegexConstant.RE_KEYS.contains(current)) &#123;</span><br><span class="line">            builder.append(<span class="string">'\\'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        builder.append(current);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">escape</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String input = <span class="string">"$123.45"</span>;</span><br><span class="line">    String result = RegexUtil.escape(input);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整工具类详见 <a href="https://github.com/vanDusty/jdk/blob/master/JDK-Tool/src/main/java/cn/van/jdk/tool/verify/RegexUtil.java" target="_blank" rel="noopener">【RegexUtil.java】</a></p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>正则表达式是操作字符串的有效手段，但是在方便我们开发的同时，我们必须意识到：过多使用正则表达式会造成代码可读性下降。</p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<ol>
<li><a href="https://github.com/vanDusty/jdk/blob/master/JDK-Tool/src/main/java/cn/van/jdk/tool/verify/RegexUtil.java" target="_blank" rel="noopener">【Github 示例代码】</a></li>
<li><a href="http://www.regexplanet.com/advanced/java/index.html" target="_blank" rel="noopener">【Java 在线表达式工具】</a></li>
</ol>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 加密算法简介</title>
    <url>/2020/06/05/decad4be.html</url>
    <content><![CDATA[<blockquote>
<p>没有根基也许可以建一座小屋，但绝对不能造一座坚固的大厦。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h2><p>编程概念中的密码，就是<strong>对于要传递的信息按照某种规则进行转换，从而隐藏信息的内容</strong>。这种方法可以使机密信息得以在公开的渠道传递而不泄密。使用这种方法，要经过加密过程。在加密过程中我们需要知道下面的这些概念：</p>
<ul>
<li>原文：或者叫明文，就是被隐藏的文字；</li>
<li>加密法：指隐藏原文的法则；</li>
<li>密文：或者叫伪文，指对原文按照加密法处理过后生成的可公开传递的文字；</li>
<li>密钥：可能是数字、词汇，也可能是一些字母，或者这些东西的组合。</li>
</ul>
<p>加密的结果生成了密文，要想让接受者能够读懂这些密文，那么就要把加密法以及密钥告诉接受者；否则接受者无法对密文解密，也就无法读懂原文。</p>
<h2 id="二、加密算法"><a href="#二、加密算法" class="headerlink" title="二、加密算法"></a>二、加密算法</h2><h3 id="2-1-对称加密算法"><a href="#2-1-对称加密算法" class="headerlink" title="2.1 对称加密算法"></a>2.1 对称加密算法</h3><blockquote>
<p>对称加密指的就是加密和解密使用同一个秘钥，所以叫做对称加密。</p>
</blockquote>
<p>对称加密只有一个秘钥，作为私钥。常见的有：<code>DES</code>、<code>AES</code> 等等。</p>
<ul>
<li><p>加密过程</p>
<ol>
<li>加密：原文 + 秘钥 = 密文</li>
<li>解密：密文 - 秘钥 = 原文</li>
</ol>
</li>
<li><p>对称加密的优点</p>
<ol>
<li>算法公开；</li>
<li>计算量小；</li>
<li>加密速度快；</li>
<li>加密效率高。</li>
</ol>
</li>
<li><p>对称加密的缺点</p>
<p>  <strong>秘钥的管理和分发是非常困难的，不够安全。</strong></p>
<blockquote>
<ol>
<li>在数据传送前，发送方和接收方必须商定好秘钥，然后双方都必须要保存好秘钥，如果一方的秘钥被泄露了，那么加密的信息也就不安全了；</li>
<li>每对用户每次使用对称加密算法时，都需要使用其他人不知道的唯一秘钥，这会使得收、发双方所拥有的的钥匙数量巨大，秘钥管理也会成为双方的负担。</li>
</ol>
</blockquote>
</li>
</ul>
<h3 id="2-2-非对称加密算法"><a href="#2-2-非对称加密算法" class="headerlink" title="2.2 非对称加密算法"></a>2.2 非对称加密算法</h3><blockquote>
<p>非对称加密算法中加密和解密用的不是同一个秘钥，所以叫作非对称加密算法。</p>
</blockquote>
<ul>
<li>常见的非对称加密算法</li>
</ul>
<p><code>RSA</code>算法。</p>
<p>在非对称加密算法每个用户都有两把钥匙，一把公钥一把私钥。<strong>公钥是对外发布的，所有人都看的到；私钥是自己保存，每个人都只知道自己的私钥而不知道别人的</strong>。在非对称加密算法中有加密和解密、加签和验签的概念。</p>
<ul>
<li>加密和解密</li>
</ul>
<p>用该用户的公钥加密后只能该用户的私钥才能解密。这种情况下，<strong>公钥是用来加密信息的</strong>，确保只有特定的人才能解密该信息。所以这种我们称之为<strong>加密和解密</strong>。</p>
<ul>
<li>加签和验签</li>
</ul>
<p>还有第二种情况，<strong>公钥是用来解密信息的</strong>，确保让别人知道这条信息是真的由我发布的，是完整正确的。接收者由此可知这条信息确实来自于拥有私钥的某人，这被称作数字签名，公钥的形式就是数字证书。所以这种我们称之为<strong>加签和验签</strong>。</p>
<h3 id="2-3-摘要算法"><a href="#2-3-摘要算法" class="headerlink" title="2.3 摘要算法"></a>2.3 摘要算法</h3><p>数据摘要算法是密码学算法中非常重要的一个分支，它通过对所有数据提取指纹信息以实现数据签名、数据完整性校验等功能，由于其不可逆性，有时候会被用做敏感信息的加密。数据摘要算法也被称为哈希（<code>Hash</code>）算法或散列算法。</p>
<ul>
<li>特征</li>
</ul>
<p>消息摘要算法的主要特征是<strong>加密过程不需要密钥</strong>，并且经过加密的数据无法被解密，只有输入相同的明文数据经过相同的消息摘要算法才能得到相同的密文。（摘要可以比方为指纹，消息摘要算法就是要得到文件的唯一职位）</p>
<ul>
<li>特点</li>
</ul>
<p><strong>无论输入的消息有多长，计算出来的消息摘要的长度总是固定的。</strong>一般地，只要输入的消息不同，对其进行摘要以后产生的摘要消息也必不相同；但相同的输入必会产生相同的输出。只能进行正向的信息摘要，而无法从摘要中恢复出任何的消息，甚至根本就找不到任何与原信息相关的信息（不可逆性）。</p>
<p>好的摘要算法，没有人能从中找到 “碰撞” 或者说极度难找到，虽然 “碰撞” 是肯定存在的（碰撞即不同的内容产生相同的摘要）。</p>
<ul>
<li>应用</li>
</ul>
<p>一般地，把对一个信息的摘要称为该消息的指纹或数字签名。数字签名是保证信息的完整性和不可否认性的方法。数据的完整性是指信宿接收到的消息一定是信源发送的信息，而中间绝无任何更改；信息的不可否认性是指信源不能否认曾经发送过的信息。其实，通过数字签名还能实现对信源的身份识别（认证），即确定 “信源” 是否是信宿意定的通信伙伴。 数字签名应该具有唯一性，即不同的消息的签名是不一样的；同时还应具有不可伪造性，即不可能找到另一个消息，使其签名与已有的消息的签名一样；还应具有不可逆性，即无法根据签名还原被签名的消息的任何信息。这些特征恰恰都是消息摘要算法的特征，所以消息摘要算法适合作为<strong>数字签名算法</strong>。</p>
<ul>
<li>常见的消息摘要算法</li>
</ul>
<p><code>CRC</code>、<code>MD5</code>、<code>SHA</code>等等。</p>
<h2 id="三、Java-实现"><a href="#三、Java-实现" class="headerlink" title="三、Java 实现"></a>三、Java 实现</h2><h3 id="3-1-对称加密-AES"><a href="#3-1-对称加密-AES" class="headerlink" title="3.1 对称加密-AES"></a>3.1 对称加密-<code>AES</code></h3><p>分享一下<code>AES</code>加密工具类</p>
<ul>
<li><code>AESUtil.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AESUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥长度: 128, 192 or 256</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEY_SIZE = <span class="number">128</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密/解密算法名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ALGORITHM = <span class="string">"AES"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机数生成器（RNG）算法名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RNG_ALGORITHM = <span class="string">"SHA1PRNG"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据加密: 明文 -&gt; 密文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(String plainStr, String keyStr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] plainBytes = plainStr.getBytes();</span><br><span class="line">        <span class="keyword">byte</span>[] keyBytes = keyStr.getBytes();</span><br><span class="line">        <span class="comment">// 生成密钥对象</span></span><br><span class="line">        SecretKey secKey = generateKey(keyBytes);</span><br><span class="line">        <span class="comment">// 获取 AES 密码器</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(ALGORITHM);</span><br><span class="line">        <span class="comment">// 初始化密码器（加密模型）</span></span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, secKey);</span><br><span class="line">        <span class="comment">// 加密数据, 返回密文</span></span><br><span class="line">        <span class="keyword">byte</span>[] cipherBytes = cipher.doFinal(plainBytes);</span><br><span class="line">        <span class="keyword">return</span> bytesToHex(cipherBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据解密: 密文 -&gt; 明文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(String cipherStr, String keyStr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] cipherBytes = hexToByteArray(cipherStr);</span><br><span class="line">        <span class="keyword">byte</span>[] keyBytes = keyStr.getBytes();</span><br><span class="line">        <span class="comment">// 生成密钥对象</span></span><br><span class="line">        SecretKey secKey = generateKey(keyBytes);</span><br><span class="line">        <span class="comment">// 获取 AES 密码器</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(ALGORITHM);</span><br><span class="line">        <span class="comment">// 初始化密码器（解密模型）</span></span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, secKey);</span><br><span class="line">        <span class="comment">// 解密数据, 返回明文</span></span><br><span class="line">        <span class="keyword">byte</span>[] plainBytes = cipher.doFinal(cipherBytes);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(plainBytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成密钥对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key byte[] 类型参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> AES密钥对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SecretKey <span class="title">generateKey</span><span class="params">(<span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 创建安全随机数生成器</span></span><br><span class="line">        SecureRandom random = SecureRandom.getInstance(RNG_ALGORITHM);</span><br><span class="line">        <span class="comment">// 设置 密钥key的字节数组 作为安全随机数生成器的种子</span></span><br><span class="line">        random.setSeed(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 AES算法生成器</span></span><br><span class="line">        KeyGenerator gen = KeyGenerator.getInstance(ALGORITHM);</span><br><span class="line">        <span class="comment">// 初始化算法生成器</span></span><br><span class="line">        gen.init(KEY_SIZE, random);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成 AES密钥对象</span></span><br><span class="line">        <span class="keyword">return</span> gen.generateKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * byte数组转16进制</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes byte数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回16进制字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">bytesToHex</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span> aByte : bytes) &#123;</span><br><span class="line">            String hex = Integer.toHexString(aByte &amp; <span class="number">0xFF</span>);</span><br><span class="line">            <span class="keyword">if</span> (hex.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                sb.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(hex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 16进制转byte</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inHex 16进制字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> byte</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span> <span class="title">hexToByte</span><span class="params">(String inHex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">byte</span>) Integer.parseInt(inHex, <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 16进制转byte数组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inHex 16进制字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> byte数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] hexToByteArray(String inHex) &#123;</span><br><span class="line">        <span class="keyword">int</span> hexlen = inHex.length();</span><br><span class="line">        <span class="keyword">byte</span>[] result;</span><br><span class="line">        <span class="keyword">if</span> (hexlen % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//奇数</span></span><br><span class="line">            hexlen++;</span><br><span class="line">            result = <span class="keyword">new</span> <span class="keyword">byte</span>[(hexlen / <span class="number">2</span>)];</span><br><span class="line">            inHex = <span class="string">"0"</span> + inHex;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//偶数</span></span><br><span class="line">            result = <span class="keyword">new</span> <span class="keyword">byte</span>[(hexlen / <span class="number">2</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; hexlen; i += <span class="number">2</span>) &#123;</span><br><span class="line">            result[j] = hexToByte(inHex.substring(i, i + <span class="number">2</span>));</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">aesTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 原文内容</span></span><br><span class="line">    String content = <span class="string">"你好，我是要发送的数据"</span>;</span><br><span class="line">    <span class="comment">// AES加密/解密用的原始密码</span></span><br><span class="line">    String key = <span class="string">"secret"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出加密后的密文</span></span><br><span class="line">    String cipherString = AESUtil.encrypt(content, key);</span><br><span class="line">    logger.info(<span class="string">"AES 加密后的密文：[&#123;&#125;]"</span>, cipherString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出解密后的明文</span></span><br><span class="line">    String plainStr = AESUtil.decrypt(cipherString, key);</span><br><span class="line">    logger.info(<span class="string">"AES 解密后的明文：[&#123;&#125;]"</span>, plainStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-非对称加密-RSA"><a href="#3-2-非对称加密-RSA" class="headerlink" title="3.2 非对称加密-RSA"></a>3.2 非对称加密-<code>RSA</code></h3><p>分享一下<code>RSA</code>加密工具类。</p>
<ul>
<li><code>RSAUtil.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RSAUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥长度 于原文长度对应 以及越长速度越慢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> KEY_SIZE = <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于封装随机产生的公钥与私钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, String&gt; keyMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机生成密钥对</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">genKeyPair</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchAlgorithmException </span>&#123;</span><br><span class="line">        <span class="comment">// KeyPairGenerator 用于生成公钥和私钥对，基于RSA算法生成对象</span></span><br><span class="line">        KeyPairGenerator keyPairGen = KeyPairGenerator.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        <span class="comment">// 初始化密钥对生成器</span></span><br><span class="line">        keyPairGen.initialize(KEY_SIZE, <span class="keyword">new</span> SecureRandom());</span><br><span class="line">        <span class="comment">// 生成一个密钥对，保存在keyPair中</span></span><br><span class="line">        KeyPair keyPair = keyPairGen.generateKeyPair();</span><br><span class="line">        <span class="comment">// 得到私钥</span></span><br><span class="line">        RSAPrivateKey privateKey = (RSAPrivateKey) keyPair.getPrivate();</span><br><span class="line">        <span class="comment">// 得到公钥</span></span><br><span class="line">        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();</span><br><span class="line">        String publicKeyString = Base64.getEncoder().encodeToString(publicKey.getEncoded());</span><br><span class="line">        <span class="comment">// 得到私钥字符串</span></span><br><span class="line">        String privateKeyString = Base64.getEncoder().encodeToString(privateKey.getEncoded());</span><br><span class="line">        <span class="comment">// 将公钥和私钥保存到Map</span></span><br><span class="line">        <span class="comment">//0表示公钥</span></span><br><span class="line">        keyMap.put(<span class="number">0</span>, publicKeyString);</span><br><span class="line">        <span class="comment">//1表示私钥</span></span><br><span class="line">        keyMap.put(<span class="number">1</span>, privateKeyString);</span><br><span class="line">        <span class="keyword">return</span> keyMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RSA公钥加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str       加密字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> publicKey 公钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 密文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 加密过程中的异常信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encrypt</span><span class="params">(String str, String publicKey)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//base64编码的公钥</span></span><br><span class="line">        <span class="keyword">byte</span>[] decoded = Base64.getDecoder().decode(publicKey);</span><br><span class="line">        RSAPublicKey pubKey = (RSAPublicKey) KeyFactory.getInstance(<span class="string">"RSA"</span>).generatePublic(<span class="keyword">new</span> X509EncodedKeySpec(decoded));</span><br><span class="line">        <span class="comment">//RSA加密</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        cipher.init(Cipher.ENCRYPT_MODE, pubKey);</span><br><span class="line">        String outStr = Base64.getEncoder().encodeToString(cipher.doFinal(str.getBytes(<span class="string">"UTF-8"</span>)));</span><br><span class="line">        <span class="keyword">return</span> outStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RSA私钥解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str        加密字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> privateKey 私钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 明文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 解密过程中的异常信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decrypt</span><span class="params">(String str, String privateKey)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//64位解码加密后的字符串</span></span><br><span class="line">        <span class="keyword">byte</span>[] inputByte = Base64.getDecoder().decode(str);</span><br><span class="line">        <span class="comment">//base64编码的私钥</span></span><br><span class="line">        <span class="keyword">byte</span>[] decoded = Base64.getDecoder().decode(privateKey);</span><br><span class="line">        RSAPrivateKey priKey = (RSAPrivateKey) KeyFactory.getInstance(<span class="string">"RSA"</span>).generatePrivate(<span class="keyword">new</span> PKCS8EncodedKeySpec(decoded));</span><br><span class="line">        <span class="comment">//RSA解密</span></span><br><span class="line">        Cipher cipher = Cipher.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        cipher.init(Cipher.DECRYPT_MODE, priKey);</span><br><span class="line">        String outStr = <span class="keyword">new</span> String(cipher.doFinal(inputByte));</span><br><span class="line">        <span class="keyword">return</span> outStr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rsaTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//生成公钥和私钥</span></span><br><span class="line">    Map&lt;Integer, String&gt; keyMap = RSAUtil.genKeyPair();</span><br><span class="line">    logger.info(<span class="string">"公钥:[&#123;&#125;]"</span>, keyMap.get(<span class="number">0</span>));</span><br><span class="line">    logger.info(<span class="string">"私钥:[&#123;&#125;]"</span>, keyMap.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要加密的数据</span></span><br><span class="line">    String message = <span class="string">"你好，我是要发送的数据"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用公钥加密</span></span><br><span class="line">    String secret0 = RSAUtil.encrypt(message, keyMap.get(<span class="number">0</span>));</span><br><span class="line">    logger.info(<span class="string">"RSA 加密后的密文：[&#123;&#125;]"</span>, secret0);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用私钥解密</span></span><br><span class="line">    String secret1 = RSAUtil.decrypt(secret0, keyMap.get(<span class="number">1</span>));</span><br><span class="line">    logger.info(<span class="string">"RSA 解密后的明文：[&#123;&#125;]"</span>,secret1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-摘要算法加密"><a href="#3-3-摘要算法加密" class="headerlink" title="3.3 摘要算法加密"></a>3.3 摘要算法加密</h3><p>这里列举了一个工具类，其中包含<code>MD5</code>、<code>SHA1</code>、<code>SHA256</code> 三种加密算法。</p>
<ul>
<li><code>SummaryEncryptionUtil.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SummaryEncryptionUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MD5 = <span class="string">"MD5"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHA1 = <span class="string">"SHA1"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHA_256 = <span class="string">"SHA-256"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用来将字节转换成 16 进制表示的字符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span>[] HEX = &#123;<span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>,</span><br><span class="line">            <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MD5 加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str 待加密字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeWithMD5</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> encode(MD5, str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SHA1 加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str 待加密字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeWithSHA1</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> encode(SHA1, str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SHA-256 加密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str 待加密字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密后的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encodeWithSHA256</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> encode(SHA_256, str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过加密算法加密字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">encode</span><span class="params">(String algorithm, String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 生成一个指定算法加密计算摘要</span></span><br><span class="line">            MessageDigest messageDigest = MessageDigest.getInstance(algorithm);</span><br><span class="line">            messageDigest.update(str.getBytes());</span><br><span class="line">            <span class="keyword">return</span> getFormattedText(messageDigest.digest());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getFormattedText</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = bytes.length;</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(len * <span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 把密文转换成十六进制的字符串形式</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">            buf.append(HEX[(bytes[j] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0f</span>]);</span><br><span class="line">            buf.append(HEX[bytes[j] &amp; <span class="number">0x0f</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是：摘要算法都是单向加密，所以不存在解密操作。</p>
</blockquote>
<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">summaryTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 要加密的数据</span></span><br><span class="line">        String message = <span class="string">"你好，我是要发送的数据"</span>;</span><br><span class="line">        <span class="comment">// 使用公钥加密</span></span><br><span class="line">        String secret0 = SummaryEncryptionUtil.encodeWithMD5(message);</span><br><span class="line">        logger.info(<span class="string">"MD5 加密后的密文：[&#123;&#125;]"</span>, secret0);</span><br><span class="line">        <span class="comment">// 使用私钥解密</span></span><br><span class="line">        String secret1 = SummaryEncryptionUtil.encodeWithSHA1(message);</span><br><span class="line">        logger.info(<span class="string">"SHA1 解密后的明文：[&#123;&#125;]"</span>,secret1);</span><br><span class="line">        <span class="comment">// 使用私钥解密</span></span><br><span class="line">        String secret2 = SummaryEncryptionUtil.encodeWithSHA256(message);</span><br><span class="line">        logger.info(<span class="string">"SHA256 解密后的明文：[&#123;&#125;]"</span>,secret2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<p><a href="https://github.com/vanDusty/JDK/tree/master/JDK-Secret" target="_blank" rel="noopener">【Github 示例代码】</a></p>
<p>参考文章</p>
<ol>
<li><a href="https://juejin.im/post/5eba78e95188256d9f09656b" target="_blank" rel="noopener">关于加解密、加签验签的那些事</a></li>
<li><a href="https://juejin.im/post/5eb04c836fb9a0435e2c3581" target="_blank" rel="noopener">共享密钥加密与公开密钥加密</a></li>
</ol>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>密码学</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 坐标系转换工具</title>
    <url>/2020/05/15/55816be.html</url>
    <content><![CDATA[<blockquote>
<p>提供了百度坐标（<code>BD09</code>）、国测局坐标（火星坐标，<code>GCJ02</code>）、和<code>WGS84</code>坐标系之间的转换。</p>
</blockquote>
<a id="more"></a>


<h2 id="一、当前互联网地图的坐标系现状"><a href="#一、当前互联网地图的坐标系现状" class="headerlink" title="一、当前互联网地图的坐标系现状"></a>一、当前互联网地图的坐标系现状</h2><h3 id="1-1-WGS84：地球坐标"><a href="#1-1-WGS84：地球坐标" class="headerlink" title="1.1 WGS84：地球坐标"></a>1.1 <code>WGS84</code>：地球坐标</h3><ol>
<li>国际标准，从 <code>GPS</code> 设备中取出的数据的坐标系；</li>
<li>国际地图提供商使用的坐标系。</li>
</ol>
<h3 id="1-2-GCJ-02：火星坐标，也叫国测局坐标系"><a href="#1-2-GCJ-02：火星坐标，也叫国测局坐标系" class="headerlink" title="1.2 GCJ-02：火星坐标，也叫国测局坐标系"></a>1.2 <code>GCJ-02</code>：火星坐标，也叫国测局坐标系</h3><ol>
<li>中国标准，从国行移动设备中定位获取的坐标数据使用这个坐标系；</li>
<li>国家规定： 国内出版的各种地图系统（包括电子形式），必须至少采用<code>GCJ-02</code>对地理位置进行首次加密。</li>
</ol>
<h3 id="1-3-BD-09：百度坐标"><a href="#1-3-BD-09：百度坐标" class="headerlink" title="1.3 BD-09：百度坐标"></a>1.3 <code>BD-09</code>：百度坐标</h3><p>百度标准，百度 <code>SDK</code>，百度地图，<code>Geocoding</code> 使用。</p>
<h3 id="1-4-互联网在线地图使用的坐标系"><a href="#1-4-互联网在线地图使用的坐标系" class="headerlink" title="1.4 互联网在线地图使用的坐标系"></a>1.4 互联网在线地图使用的坐标系</h3><ul>
<li><p><code>WGS84</code>坐标系：谷歌国外地图、<code>OSM</code>地图等国外的地图一般都是这个</p>
</li>
<li><p><code>GCJ-02</code>坐标系：</p>
<ol>
<li><code>iOS</code> 地图（其实是高德）</li>
<li><code>Gogole</code>地图</li>
<li>搜搜、阿里云、高德地图</li>
</ol>
</li>
<li><p><code>BD-09</code>坐标系：当然只有百度地图</p>
</li>
</ul>
<h2 id="二、坐标系转换工具类"><a href="#二、坐标系转换工具类" class="headerlink" title="二、坐标系转换工具类"></a>二、坐标系转换工具类</h2><blockquote>
<p>如果恰好你在处理与地理定位相关的代码，如下是改造的的一个坐标系转换工具类，欢迎采用。</p>
</blockquote>
<p>所有转换都调用 <code>convertLatLonByCoordinate()</code>：将原本坐标系的经纬度转换成新的坐标系的经纬度。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CoordinateTransformUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> x_pi = <span class="number">3.14159265358979324</span> * <span class="number">3000.0</span> / <span class="number">180.0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * π</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> pi = <span class="number">3.1415926535897932384626</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 长半轴</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> a = <span class="number">6378245.0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扁率</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> ee = <span class="number">0.00669342162296594323</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> outOfChinaMin_lng = <span class="number">72.004</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> outOfChinaMax_lng = <span class="number">137.8347</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> outOfChinaMin_lat = <span class="number">0.8293</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">double</span> outOfChinaMax_lat = <span class="number">55.8271</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将原本坐标系的经纬度转换成新的坐标系的经纬度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newCoordinateType      新坐标系，如baidu，wgs84</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> originalCoordinateType 原坐标系，如wgs84</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng                    原经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat                    原纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 新坐标系的经纬度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] convertLatLonByCoordinate(String newCoordinateType, String originalCoordinateType, <span class="keyword">double</span> lng, <span class="keyword">double</span> lat) &#123;</span><br><span class="line">        <span class="keyword">if</span> (originalCoordinateType == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> bd09ToWgs84 = (originalCoordinateType.equalsIgnoreCase(<span class="string">"bd09"</span>) || originalCoordinateType.equalsIgnoreCase(<span class="string">"baidu"</span>)</span><br><span class="line">                &amp;&amp; (newCoordinateType.equalsIgnoreCase(<span class="string">"google"</span>)) || newCoordinateType.equalsIgnoreCase(<span class="string">"wgs84"</span>));</span><br><span class="line">        <span class="keyword">boolean</span> gcj02toWgs84 = (originalCoordinateType.equalsIgnoreCase(<span class="string">"gaode"</span>) || originalCoordinateType.equalsIgnoreCase(<span class="string">"gcj02"</span>)</span><br><span class="line">                &amp;&amp; (newCoordinateType.equalsIgnoreCase(<span class="string">"google"</span>)) || newCoordinateType.equalsIgnoreCase(<span class="string">"wgs84"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> wgs84ToBd09 = (originalCoordinateType.equalsIgnoreCase(<span class="string">"google"</span>) || originalCoordinateType.equalsIgnoreCase(<span class="string">"wgs84"</span>))</span><br><span class="line">                &amp;&amp; (newCoordinateType.equalsIgnoreCase(<span class="string">"bd09"</span>) || newCoordinateType.equalsIgnoreCase(<span class="string">"baidu"</span>));</span><br><span class="line">        <span class="keyword">boolean</span> gcj02ToBd09 = (originalCoordinateType.equalsIgnoreCase(<span class="string">"gaode"</span>) || originalCoordinateType.equalsIgnoreCase(<span class="string">"gcj02"</span>))</span><br><span class="line">                &amp;&amp; (newCoordinateType.equalsIgnoreCase(<span class="string">"bd09"</span>) || newCoordinateType.equalsIgnoreCase(<span class="string">"baidu"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> wgs84ToGcj02 = (originalCoordinateType.equalsIgnoreCase(<span class="string">"google"</span>) || originalCoordinateType.equalsIgnoreCase(<span class="string">"wgs84"</span>))</span><br><span class="line">                &amp;&amp; (newCoordinateType.equalsIgnoreCase(<span class="string">"gaode"</span>) || newCoordinateType.equalsIgnoreCase(<span class="string">"gcj02"</span>));</span><br><span class="line">        <span class="keyword">boolean</span> bd09ToGcj02 = (originalCoordinateType.equalsIgnoreCase(<span class="string">"bd09"</span>) || originalCoordinateType.equalsIgnoreCase(<span class="string">"baidu"</span>))</span><br><span class="line">                &amp;&amp; (newCoordinateType.equalsIgnoreCase(<span class="string">"gaode"</span>) || newCoordinateType.equalsIgnoreCase(<span class="string">"gcj02"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (originalCoordinateType.equals(newCoordinateType)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;lat, lng&#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bd09ToWgs84) &#123;</span><br><span class="line">            <span class="keyword">return</span> bd09ToWgs84(lng, lat);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gcj02toWgs84) &#123;</span><br><span class="line">            <span class="keyword">return</span> gcj02ToWgs84(lng, lat);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wgs84ToBd09) &#123;</span><br><span class="line">            <span class="keyword">return</span> wgs84ToBd09(lng, lat);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gcj02ToBd09) &#123;</span><br><span class="line">            <span class="keyword">return</span> gcj02ToBd09(lng, lat);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (wgs84ToGcj02) &#123;</span><br><span class="line">            <span class="keyword">return</span> wgs84togcj02(lng, lat);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bd09ToGcj02) &#123;</span><br><span class="line">            <span class="keyword">return</span> bd09ToGcj02(lng, lat);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 百度坐标系(BD-09)转WGS坐标</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng 百度坐标纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat 百度坐标经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> WGS84坐标数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] bd09ToWgs84(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat) &#123;</span><br><span class="line">        <span class="keyword">double</span>[] gcj = bd09ToGcj02(lng, lat);</span><br><span class="line">        <span class="keyword">double</span>[] wgs84 = gcj02ToWgs84(gcj[<span class="number">0</span>], gcj[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> wgs84;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WGS坐标转百度坐标系(BD-09)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng WGS84坐标系的经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat WGS84坐标系的纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 百度坐标数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] wgs84ToBd09(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat) &#123;</span><br><span class="line">        <span class="keyword">double</span>[] gcj = wgs84togcj02(lng, lat);</span><br><span class="line">        <span class="keyword">double</span>[] bd09 = gcj02ToBd09(gcj[<span class="number">0</span>], gcj[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> bd09;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 火星坐标系(GCJ-02)转百度坐标系(BD-09)</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 谷歌、高德——&gt;百度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng 火星坐标经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat 火星坐标纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 百度坐标数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] gcj02ToBd09(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat) &#123;</span><br><span class="line">        <span class="keyword">double</span> z = Math.sqrt(lng * lng + lat * lat) + <span class="number">0.00002</span> * Math.sin(lat * x_pi);</span><br><span class="line">        <span class="keyword">double</span> theta = Math.atan2(lat, lng) + <span class="number">0.000003</span> * Math.cos(lng * x_pi);</span><br><span class="line">        <span class="keyword">double</span> bdLng = z * Math.cos(theta) + <span class="number">0.0065</span>;</span><br><span class="line">        <span class="keyword">double</span> bdLat = z * Math.sin(theta) + <span class="number">0.006</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;bdLng, bdLat&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 百度坐标系(BD-09)转火星坐标系(GCJ-02)</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 百度——&gt;谷歌、高德</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bd_lon 百度坐标纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bd_lat 百度坐标经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 火星坐标数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] bd09ToGcj02(<span class="keyword">double</span> bd_lon, <span class="keyword">double</span> bd_lat) &#123;</span><br><span class="line">        <span class="keyword">double</span> x = bd_lon - <span class="number">0.0065</span>;</span><br><span class="line">        <span class="keyword">double</span> y = bd_lat - <span class="number">0.006</span>;</span><br><span class="line">        <span class="keyword">double</span> z = Math.sqrt(x * x + y * y) - <span class="number">0.00002</span> * Math.sin(y * x_pi);</span><br><span class="line">        <span class="keyword">double</span> theta = Math.atan2(y, x) - <span class="number">0.000003</span> * Math.cos(x * x_pi);</span><br><span class="line">        <span class="keyword">double</span> ggLng = z * Math.cos(theta);</span><br><span class="line">        <span class="keyword">double</span> ggLat = z * Math.sin(theta);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;ggLng, ggLat&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WGS84转GCJ02(火星坐标系)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng WGS84坐标系的经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat WGS84坐标系的纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 火星坐标数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] wgs84togcj02(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat) &#123;</span><br><span class="line">        <span class="keyword">if</span> (outOfChina(lng, lat)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;lng, lat&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> dlat = transformLat(lng - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);</span><br><span class="line">        <span class="keyword">double</span> dlng = transformLng(lng - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);</span><br><span class="line">        <span class="keyword">double</span> radLat = lat / <span class="number">180.0</span> * pi;</span><br><span class="line">        <span class="keyword">double</span> magic = Math.sin(radLat);</span><br><span class="line">        magic = <span class="number">1</span> - ee * magic * magic;</span><br><span class="line">        <span class="keyword">double</span> sqrtMagic = Math.sqrt(magic);</span><br><span class="line">        dlat = (dlat * <span class="number">180.0</span>) / ((a * (<span class="number">1</span> - ee)) / (magic * sqrtMagic) * pi);</span><br><span class="line">        dlng = (dlng * <span class="number">180.0</span>) / (a / sqrtMagic * Math.cos(radLat) * pi);</span><br><span class="line">        <span class="keyword">double</span> mglat = lat + dlat;</span><br><span class="line">        <span class="keyword">double</span> mglng = lng + dlng;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;mglng, mglat&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * GCJ02(火星坐标系)转GPS84</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng 火星坐标系的经度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat 火星坐标系纬度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> WGS84坐标数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] gcj02ToWgs84(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat) &#123;</span><br><span class="line">        <span class="keyword">if</span> (outOfChina(lng, lat)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;lng, lat&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> dlat = transformLat(lng - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);</span><br><span class="line">        <span class="keyword">double</span> dlng = transformLng(lng - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);</span><br><span class="line">        <span class="keyword">double</span> radlat = lat / <span class="number">180.0</span> * pi;</span><br><span class="line">        <span class="keyword">double</span> magic = Math.sin(radlat);</span><br><span class="line">        magic = <span class="number">1</span> - ee * magic * magic;</span><br><span class="line">        <span class="keyword">double</span> sqrtmagic = Math.sqrt(magic);</span><br><span class="line">        dlat = (dlat * <span class="number">180.0</span>) / ((a * (<span class="number">1</span> - ee)) / (magic * sqrtmagic) * pi);</span><br><span class="line">        dlng = (dlng * <span class="number">180.0</span>) / (a / sqrtmagic * Math.cos(radlat) * pi);</span><br><span class="line">        <span class="keyword">double</span> mglat = lat + dlat;</span><br><span class="line">        <span class="keyword">double</span> mglng = lng + dlng;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;lng * <span class="number">2</span> - mglng, lat * <span class="number">2</span> - mglat&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 纬度转换</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">transformLat</span><span class="params">(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> ret = -<span class="number">100.0</span> + <span class="number">2.0</span> * lng + <span class="number">3.0</span> * lat + <span class="number">0.2</span> * lat * lat + <span class="number">0.1</span> * lng * lat + <span class="number">0.2</span> * Math.sqrt(Math.abs(lng));</span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(<span class="number">6.0</span> * lng * pi) + <span class="number">20.0</span> * Math.sin(<span class="number">2.0</span> * lng * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;</span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(lat * pi) + <span class="number">40.0</span> * Math.sin(lat / <span class="number">3.0</span> * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;</span><br><span class="line">        ret += (<span class="number">160.0</span> * Math.sin(lat / <span class="number">12.0</span> * pi) + <span class="number">320</span> * Math.sin(lat * pi / <span class="number">30.0</span>)) * <span class="number">2.0</span> / <span class="number">3.0</span>;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 经度转换</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">transformLng</span><span class="params">(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> ret = <span class="number">300.0</span> + lng + <span class="number">2.0</span> * lat + <span class="number">0.1</span> * lng * lng + <span class="number">0.1</span> * lng * lat + <span class="number">0.1</span> * Math.sqrt(Math.abs(lng));</span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(<span class="number">6.0</span> * lng * pi) + <span class="number">20.0</span> * Math.sin(<span class="number">2.0</span> * lng * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;</span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(lng * pi) + <span class="number">40.0</span> * Math.sin(lng / <span class="number">3.0</span> * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;</span><br><span class="line">        ret += (<span class="number">150.0</span> * Math.sin(lng / <span class="number">12.0</span> * pi) + <span class="number">300.0</span> * Math.sin(lng / <span class="number">30.0</span> * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否在国内，不在国内不做偏移</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lng</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">outOfChina</span><span class="params">(<span class="keyword">double</span> lng, <span class="keyword">double</span> lat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (lng &lt; outOfChinaMin_lng || lng &gt; outOfChinaMax_lng) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lat &lt; outOfChinaMin_lat || lat &gt; outOfChinaMax_lat) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>例如：将百度坐标系的经纬度转换成国际标准坐标系的经纬度</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">convertLatLonByCoordinate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String newCoordinateType = <span class="string">"baidu"</span>;</span><br><span class="line">    String originalCoordinateType = <span class="string">"wgs84"</span>;</span><br><span class="line">    <span class="keyword">double</span> lng = <span class="number">115.25</span>;</span><br><span class="line">    <span class="keyword">double</span> lat = <span class="number">39.526128</span>;</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, CoordinateTransformUtil.convertLatLonByCoordinate(newCoordinateType, originalCoordinateType, lng, lat));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="【Github-示例代码】"><a href="#【Github-示例代码】" class="headerlink" title="【Github 示例代码】"></a><a href="https://github.com/vanDusty/jdk/blob/master/JDK-Tool/src/main/java/cn/van/jdk/tool/math/CoordinateTransformUtil.java" target="_blank" rel="noopener">【Github 示例代码】</a></h4><blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>坐标</tag>
      </tags>
  </entry>
  <entry>
    <title>【并发编程】JUC之Semaphore</title>
    <url>/2020/05/12/84baea38.html</url>
    <content><![CDATA[<p><code>Semaphore</code> 意思的信号量，它的作用是控制访问特定资源的线程数量。</p>
<a id="more"></a>


<h2 id="一、Semaphore"><a href="#一、Semaphore" class="headerlink" title="一、Semaphore"></a>一、<code>Semaphore</code></h2><p>信号量是对锁的扩展，不管是同步<code>synchronized</code>还是<code>ReentrantLock</code>，一次只能允许一个线程访问一个资源，但是信号量可以使得<strong>多个线程，同时访问一个资源</strong>。</p>
<h3 id="1-1-构造函数"><a href="#1-1-构造函数" class="headerlink" title="1.1 构造函数"></a>1.1 构造函数</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">boolean</span> fair)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>permits</code>：能同时申请多少个信号量，主要用来控制线程的并发数量，即同时有多少个线程可以访问资源；</li>
<li><code>fair</code>：是否公平，若<code>true</code>的话，下次执行的会是先进去等待的线程（先入先出）;</li>
</ol>
<h3 id="1-2-主要方法"><a href="#1-2-主要方法" class="headerlink" title="1.2 主要方法"></a>1.2 主要方法</h3><ol>
<li><code>acquire()</code>：获取许可执行，若无法获得，会持续等待，直到线程释放一个许可；</li>
<li><code>tryAcquire()</code>：尝试获得准入许可，得到返回<code>true</code>，没有返回<code>false</code>，不会持续等待；</li>
<li><code>tryAcquire(long timeout, TimeUnit unit)</code>：与<code>tryAcquire()</code>类似，但是会有一个等待的时间，超过时间立即返回；</li>
<li><code>release()</code>：释放许可，让其他线程获取许可执行。</li>
</ol>
<p>显然这个功能可以用于<strong>资源访问控制</strong>或者是<strong>限流</strong>的操作。</p>
<h2 id="二、Semaphore的使用"><a href="#二、Semaphore的使用" class="headerlink" title="二、Semaphore的使用"></a>二、<code>Semaphore</code>的使用</h2><p>首先，我们考虑下<code>Semaphore</code>是用来解决哪类问题的？</p>
<h3 id="2-1-CyclicBarrier和CountDownLatch无法解决的场景"><a href="#2-1-CyclicBarrier和CountDownLatch无法解决的场景" class="headerlink" title="2.1 CyclicBarrier和CountDownLatch无法解决的场景"></a>2.1 <code>CyclicBarrier</code>和<code>CountDownLatch</code>无法解决的场景</h3><p>前面我们已经介绍了<code>CyclicBarrier</code>和<code>CountDownLatch</code>，有哪些场景是这两个还无法解决的。</p>
<ul>
<li>场景一：抢车位</li>
</ul>
<p>无论是景区、商场还是住宅小区，停车场中的车位数量是一定的。当车位满了以后，想要进入停车场停车的车辆只能等待。等到其他车辆出来之后，才可以进入，即每个车辆必须只能停在其中一个位置上(互斥使用的)。</p>
<ul>
<li>场景二：海底捞吃火锅</li>
</ul>
<p>去海底捞吃火锅的时候，餐厅餐桌数量是固定的，假设有<code>3</code>桌。现在来了<code>10</code>桌客人，那么其他客人就需要在门口候餐区等待。当有其他桌吃完离开之后，进去一个。</p>
<ul>
<li><p><code>CyclicBarrier</code>和<code>CountDownLatch</code> 能否解决当前问题？</p>
<ol>
<li>根据<code>CountDownLatch</code>的特性：只能使用一次，这两种场景当然不能使用；</li>
<li><code>CyclicBarrier</code>：虽然可以使用多次，但是需要<code>reset()</code>之后才可以多次使用。意思就是：<strong>只有等餐厅里面<code>3</code>个桌的客人都吃完之后，才可以让其他人进来就餐的</strong>，显然也是不符合业务逻辑的。</li>
</ol>
</li>
</ul>
<h3 id="2-2-代码实战"><a href="#2-2-代码实战" class="headerlink" title="2.2 代码实战"></a>2.2 代码实战</h3><blockquote>
<p>以下代码以海底捞等位吃饭为例，即吃完一桌放一桌客人进来。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 假设有十桌客人准备就餐</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> tableCount = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 信号量，即餐厅只有3桌，仅能提供3桌客人同时就餐</span></span><br><span class="line">        Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>, <span class="keyword">true</span>);</span><br><span class="line">        Long startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 计数器，计算什么时候全部就餐结束</span></span><br><span class="line">        CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(tableCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= tableCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> count = i;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 获取资源，开始处理</span></span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    System.out.println(<span class="string">"第"</span> + count + <span class="string">"批桌客人开始就餐"</span>);</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">5</span>));</span><br><span class="line">                    System.out.println(<span class="string">"第"</span> + count + <span class="string">"批桌客人就餐结束"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// 处理结束，资源释放</span></span><br><span class="line">                    semaphore.release();</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">"线程"</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 等待全部客人就餐结束</span></span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        System.out.println(<span class="string">"所有客人就餐完毕，总耗时"</span> + (System.currentTimeMillis() - startTime) + <span class="string">"毫秒"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先我们申明了信号量为<code>3</code>，那么同时就可以有<code>3</code>个线程进入到临界区中;</li>
<li>当后续线程使用<code>acquire()</code>时候申请信号量，也必须有线程通过<code>release()</code>释放信号量。如果不释放，就意没有线程能进入。</li>
</ol>
<ul>
<li>结果打印如下</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">第1批桌客人开始就餐</span><br><span class="line">第3批桌客人开始就餐</span><br><span class="line">第2批桌客人开始就餐</span><br><span class="line">第1批桌客人就餐结束</span><br><span class="line">第4批桌客人开始就餐</span><br><span class="line">第2批桌客人就餐结束</span><br><span class="line">第5批桌客人开始就餐</span><br><span class="line">第3批桌客人就餐结束</span><br><span class="line">第6批桌客人开始就餐</span><br><span class="line">第4批桌客人就餐结束</span><br><span class="line">第7批桌客人开始就餐</span><br><span class="line">第7批桌客人就餐结束</span><br><span class="line">第8批桌客人开始就餐</span><br><span class="line">第8批桌客人就餐结束</span><br><span class="line">第5批桌客人就餐结束</span><br><span class="line">第6批桌客人就餐结束</span><br><span class="line">第10批桌客人开始就餐</span><br><span class="line">第10批桌客人就餐结束</span><br><span class="line">第9批桌客人开始就餐</span><br><span class="line">第9批桌客人就餐结束</span><br><span class="line">所有客人就餐完毕，总耗时7060毫秒</span><br></pre></td></tr></table></figure>

<p>从运行结果中，仅当有一个离开餐桌下一位才能进入餐厅就餐，达到我们预期。</p>
<h3 id="2-3-使用注意点"><a href="#2-3-使用注意点" class="headerlink" title="2.3 使用注意点"></a>2.3 使用注意点</h3><p>在使用<code>acquire()</code>获取资源，并处理结束后，需要在<code>finally</code>里面调用<code>release()</code>方法进行释放资源，如果不能正常释放资源，会导致<strong>信号量泄漏</strong>。</p>
<p><a href="https://github.com/vanDusty/JDK/tree/master/JDK-JUC/src/main/java/cn/van/jdk/juc/semaphore" target="_blank" rel="noopener">【Github 示例源码】</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
        <category>并发编程</category>
      </categories>
      <tags>
        <tag>JUC</tag>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>【并发编程】JUC之CyclicBarrier</title>
    <url>/2020/05/02/da9c61f3.html</url>
    <content><![CDATA[<p><code>CyclicBarrier</code> 是一种多线程并发控制工具，与<code>CountDownLatch</code>非常类似。它可以让一组线程到达栅栏时被阻塞，直到最后一个线程到达，才放行通过。比如斗地主，需要等待所有玩家进度条 <code>100%</code> 了，才能进入游戏。</p>
<a id="more"></a>


<h2 id="一、CyclicBarrier"><a href="#一、CyclicBarrier" class="headerlink" title="一、CyclicBarrier"></a>一、<code>CyclicBarrier</code></h2><h3 id="1-1-构造函数"><a href="#1-1-构造函数" class="headerlink" title="1.1 构造函数"></a>1.1 构造函数</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrier</span><span class="params">(<span class="keyword">int</span> parties)</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrier</span><span class="params">(<span class="keyword">int</span> parties, Runnable barrierAction)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>parties</code>：阻塞的线程数量，每个线程使用<code>await()</code>方法告诉<code>CyclicBarrier</code>我已经到达了屏障，然后当前线程被阻塞；</li>
<li><code>barrierAction</code>：当最后一个线程到达是先执行这个任务，再去执行后面的流程(优先执行<code>barrierAction</code>，再执行主流程，方便处理更复杂的业务场景)。</li>
</ol>
<h3 id="1-2-主要方法"><a href="#1-2-主要方法" class="headerlink" title="1.2 主要方法"></a>1.2 主要方法</h3><ol>
<li><code>int await()</code>：当前线程到达栅栏点等待，<code>parties</code>数目<code>-1</code>。注意：<strong>调用次数要和入参数量一致，否则会一直阻塞的等待</strong>；</li>
<li><code>int getParties()</code>：返回设置屏障外的线程数；</li>
<li><code>void reset()</code>：将屏障外的线程数重置，如果还有其他线程正在屏障等待，则会抛出<code>BrokenBarrierException</code>。</li>
</ol>
<h2 id="二、CyclicBarrier的使用"><a href="#二、CyclicBarrier的使用" class="headerlink" title="二、CyclicBarrier的使用"></a>二、<code>CyclicBarrier</code>的使用</h2><p><code>CyclicBarrier</code>用于使线程彼此等待，当不同的线程分别处理计算中的一部分服务，并且当所有线程都完成执行的时候，使用它，也就是说当多个线程执行不同的子任务并且需要组合这些子任务的输出来形成最终的输出，可以使用<code>CyclicBarrier</code>。完成执行后，线程调用<code>await()</code>方法并且等待其他线程到达栅栏。一旦所有的线程到达，<code>CyclicBarrier</code>就会为线程提供方法。</p>
<h3 id="2-1-CyclicBarrier应用场景例子"><a href="#2-1-CyclicBarrier应用场景例子" class="headerlink" title="2.1 CyclicBarrier应用场景例子"></a>2.1 <code>CyclicBarrier</code>应用场景例子</h3><p>接下来模拟斗地主玩家的载入：地主玩家初始化游戏、贫民玩家1初始化游戏和贫民玩家2初始化游戏都进行完成后才能进入游戏。</p>
<ul>
<li>【地主玩家】初始化游戏</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LandlordPlayer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CyclicBarrier cyclicBarrier;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LandlordPlayer</span><span class="params">(CyclicBarrier cyclicBarrier)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cyclicBarrier = cyclicBarrier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 地主玩家初始化游戏需要2秒</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            logger.info(<span class="string">"【地主玩家】进入游戏"</span>);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            logger.info(<span class="string">"【地主玩家】进入游戏失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>【贫民玩家1】初始化游戏</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FarmerPlayer1</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CyclicBarrier cyclicBarrier;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FarmerPlayer1</span><span class="params">(CyclicBarrier cyclicBarrier)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cyclicBarrier = cyclicBarrier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 贫民玩家1玩家初始化游戏需要3秒</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            logger.info(<span class="string">"【贫民玩家1】进入游戏"</span>);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            logger.info(<span class="string">"【贫民玩家1】进入游戏失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>【贫民玩家2】初始化游戏</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FarmerPlayer2</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CyclicBarrier cyclicBarrier;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FarmerPlayer2</span><span class="params">(CyclicBarrier cyclicBarrier)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cyclicBarrier = cyclicBarrier;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 贫民玩家2玩家初始化游戏需要3秒</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            logger.info(<span class="string">"【贫民玩家2】进入游戏"</span>);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">            logger.info(<span class="string">"【贫民玩家2】进入游戏失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>游戏加载流程</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cyclicBarrierDemo</span><span class="params">()</span> <span class="keyword">throws</span> BrokenBarrierException, InterruptedException </span>&#123;</span><br><span class="line">        Long startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 4个是因为还有一个主线程也在等待</span></span><br><span class="line">        logger.info(<span class="string">"所有玩家就绪，准备进入游戏"</span>);</span><br><span class="line">        CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">4</span>, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"所有玩家进度条100%，游戏读取中。。。。"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 注意：初始化线程数量（如果线程数少于所需线程，则会阻塞）</span></span><br><span class="line">        Executor executor = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        executor.execute(<span class="keyword">new</span> LandlordPlayer(cyclicBarrier));</span><br><span class="line">        executor.execute(<span class="keyword">new</span> FarmerPlayer2(cyclicBarrier));</span><br><span class="line">        executor.execute(<span class="keyword">new</span> FarmerPlayer1(cyclicBarrier));</span><br><span class="line">        cyclicBarrier.await();</span><br><span class="line">        <span class="comment">// 模拟游戏读取需要 1 秒</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        logger.info(<span class="string">"游戏加载成功，耗时[&#123;&#125;]毫秒，开始游戏...."</span>, System.currentTimeMillis() - startTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果打印如下</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">17:12:01.324 [main] ... - 所有玩家就绪，准备进入游戏</span><br><span class="line">17:12:03.337 [pool-1-thread-1] ... - 【地主玩家】进入游戏</span><br><span class="line">17:12:04.338 [pool-1-thread-3] ... - 【贫民玩家1】进入游戏</span><br><span class="line">17:12:04.338 [pool-1-thread-2] ... - 【贫民玩家2】进入游戏</span><br><span class="line">17:12:04.338 [pool-1-thread-2] ... - 所有玩家进度条100%，游戏读取中。。。。</span><br><span class="line">17:12:05.342 [main] ... - 游戏加载成功，耗时[4020]毫秒，开始游戏....</span><br></pre></td></tr></table></figure>

<p>由于多线程并发使各个玩家同时加载，整个游戏加载耗时 <code>4020</code> 毫秒，效率比较高。</p>
<h3 id="2-2-使用注意点"><a href="#2-2-使用注意点" class="headerlink" title="2.2 使用注意点"></a>2.2 使用注意点</h3><ol>
<li>相较于<code>CountDownLatch</code>，<code>CyclicBarrier</code> 可以重复使用，因为会去刷新 count 的数量；</li>
<li><code>await()</code>调用次数要和入参数量一致，否则会一直阻塞的等待。</li>
</ol>
<h3 id="2-3-CyclicBarrier和CountDownLatch的区别"><a href="#2-3-CyclicBarrier和CountDownLatch的区别" class="headerlink" title="2.3 CyclicBarrier和CountDownLatch的区别"></a>2.3 <code>CyclicBarrier</code>和<code>CountDownLatch</code>的区别</h3><ol>
<li><code>CountDownLatch</code>的计数器只能使用一次，而<code>CyclicBarrier</code>的计数器可以使用<code>reset()</code>方法重置，可以使用多次，所以<code>CyclicBarrier</code>能够处理更为复杂的场景；</li>
<li><code>CyclicBarrier</code>还提供了一些其他有用的方法，比如<code>getNumberWaiting()</code>方法可以获得<code>CyclicBarrier</code>阻塞的线程数量，<code>isBroken()</code>方法用来了解阻塞的线程是否被中断；</li>
<li><code>CountDownLatch</code>是只阻塞主线程，所有子线程全部执行完毕之后唤醒主线程去执行；而<code>CyclicBarrier</code>则是所有线程到达栅栏点都会阻塞等待，直到后一个到达才唤醒所有的阻塞线程。</li>
</ol>
<p><a href="https://github.com/vanDusty/JDK/tree/master/JDK-JUC/src/main/java/cn/van/jdk/juc/cyclicbarrier" target="_blank" rel="noopener">【Github 示例源码】</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
        <category>并发编程</category>
      </categories>
      <tags>
        <tag>JUC</tag>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>【并发编程】JUC之CountDownLatch</title>
    <url>/2020/05/01/a99f8c04.html</url>
    <content><![CDATA[<blockquote>
<p>当 <code>N</code> 个线程同时完成某项任务时，如何知道他们都已经执行完毕了。</p>
</blockquote>
<a id="more"></a>


<h2 id="一、CountDownLatch"><a href="#一、CountDownLatch" class="headerlink" title="一、CountDownLatch"></a>一、<code>CountDownLatch</code></h2><p><code>CountDownLatch</code> 是 <code>JDK 1.5</code>开始<code>concurrent</code>包里提供的，并发编程工具类。<br>可以把 <code>CountDownLatch</code> 看作一个多线程控制工具类，用于协调多个线程的同步，能让一个线程在等待其他线程执行完任务后，再继续执行。内部是通过一个计数器去完成实现。</p>
<h3 id="1-1-构造函数"><a href="#1-1-构造函数" class="headerlink" title="1.1 构造函数"></a>1.1 构造函数</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"count &lt; 0"</span>);</span><br><span class="line">    <span class="keyword">this</span>.sync = <span class="keyword">new</span> Sync(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>count</code>代表需要执行的线程数量,也是同步计数器初始化的数量，只有当同步计数值为<code>0</code>，主线程才会向下执行。</p>
<h3 id="1-2-主要方法"><a href="#1-2-主要方法" class="headerlink" title="1.2 主要方法"></a>1.2 主要方法</h3><ol>
<li><code>void await()</code>：调用改方法的线程会被挂起，直到<code>count</code>值为<code>0</code>;</li>
<li><code>boolean await(long timeout, TimeUnit unit)</code>：与上面的类似，只不过等待一定的时间后<code>count</code>值还没变为<code>0</code>的话就会继续执行;</li>
<li><code>void countDown()</code>：在计数值 <code>&gt; 0</code>的情况下，每当一个线程完成任务，计数减去<code>1</code>;</li>
<li><code>long getCount()</code>：获取计数器的值。</li>
</ol>
<blockquote>
<p>当计数器应该为<code>0</code>，所有的线程执行完自己的任务。在<code>CountDownLatch</code>等待的线程，可以继续执行的任务。</p>
</blockquote>
<h2 id="二、CountDownLatch的使用"><a href="#二、CountDownLatch的使用" class="headerlink" title="二、CountDownLatch的使用"></a>二、<code>CountDownLatch</code>的使用</h2><p>适用于一个任务的执行需要等待其他任务执行完毕，方可执行的场景。</p>
<blockquote>
<p><code>CountDownLatch</code>是一次性的，只能通过构造方法设置初始计数量，计数完了无法进行复位，不能达到复用。</p>
</blockquote>
<h3 id="2-1-CountDownLatch应用场景例子"><a href="#2-1-CountDownLatch应用场景例子" class="headerlink" title="2.1 CountDownLatch应用场景例子"></a>2.1 <code>CountDownLatch</code>应用场景例子</h3><p>丈夫和妻子一块儿去买菜，假设买蔬菜需要<code>5</code>秒，买肉需要<code>3</code>秒，如果丈夫和妻子分开去买，然后一块儿回家。</p>
<ul>
<li>妻子去蔬菜</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WifeTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CountDownLatch countDownLatch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WifeTask</span><span class="params">(CountDownLatch countDownLatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.countDownLatch = countDownLatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 买蔬菜需要5秒</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">            logger.info(<span class="string">"妻子蔬菜买好了"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            logger.info(<span class="string">"妻子蔬菜没买到"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (countDownLatch != <span class="keyword">null</span>) &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>丈夫去买肉</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HusbandTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CountDownLatch countDownLatch;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HusbandTask</span><span class="params">(CountDownLatch countDownLatch)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.countDownLatch = countDownLatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 买肉需要3秒</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">            logger.info(<span class="string">"丈夫肉买好了"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            logger.info(<span class="string">"丈夫肉没买到"</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (countDownLatch != <span class="keyword">null</span>) &#123;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>买好菜，在指定地点集合回家（回到主线程），计算耗时</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDownLatchDemo</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Long startTime = System.currentTimeMillis();</span><br><span class="line">        CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line">        logger.info(<span class="string">"夫妻分头去买菜"</span>);</span><br><span class="line">        <span class="comment">// 夫妻分头去买菜，夫妻买蔬菜(需要5秒)，丈夫卖肉(需要3秒)</span></span><br><span class="line">        Executor executor = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        executor.execute(<span class="keyword">new</span> HusbandTask(countDownLatch));</span><br><span class="line">        executor.execute(<span class="keyword">new</span> WifeTask(countDownLatch));</span><br><span class="line">        <span class="comment">// 挂起任务，等菜买好了再一起回家</span></span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        logger.info(<span class="string">"菜买好了，夫妻双双把家还，买菜合计耗时:&#123;&#125;毫秒"</span>, (System.currentTimeMillis() - startTime));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果打印如下</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">21:36:42.964 ... - 夫妻分头去买菜</span><br><span class="line">21:36:45.973 ... - 丈夫肉买好了</span><br><span class="line">21:36:47.972 ... - 妻子蔬菜买好了</span><br><span class="line">21:36:47.973 ... - 菜买好了，夫妻双双把家还，买菜合计耗时:5011毫秒</span><br></pre></td></tr></table></figure>

<p>通过<code>CountDownLatch</code>初始化计数器值为<code>2</code>，让夫妻两人各自去买菜，完成一项，计数器值减<code>1</code>，都买好后，计数器值为<code>0</code>，回到主线程，一起回家。</p>
<h3 id="2-2-CountDownLatch使用以及注意点"><a href="#2-2-CountDownLatch使用以及注意点" class="headerlink" title="2.2 CountDownLatch使用以及注意点"></a>2.2 <code>CountDownLatch</code>使用以及注意点</h3><ol>
<li>一旦<code>count</code>达到零，不能再用<code>CountDownLatch</code>(即不可复用)。</li>
<li>主线程通过调用<code>CountDownLatch.await()</code>方法等待<code>Latch</code>，而其他线程调用<code>CountDownLatch.countDown()</code>以通知它们已完成。</li>
<li>计数器必须和要执行的线程数匹配，如果计数器大于了要执行的线程数目，那么<code>count</code>最后不会为<code>0</code>，调用的主线程也不会继续执行，主线程将会一直处于等待状态。</li>
</ol>
<p><a href="https://github.com/vanDusty/JDK/tree/master/JDK-JUC/src/main/java/cn/van/jdk/juc/countdownlatch" target="_blank" rel="noopener">【Github 示例源码】</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
        <category>并发编程</category>
      </categories>
      <tags>
        <tag>JUC</tag>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 字符串拼接</title>
    <url>/2020/03/05/13a01a97.html</url>
    <content><![CDATA[<p>如何正确的拼接字符串，你真的清楚吗？</p>
<a id="more"></a>

<h2 id="一、字符串分割之split"><a href="#一、字符串分割之split" class="headerlink" title="一、字符串分割之split()"></a>一、字符串分割之<code>split()</code></h2><h3 id="1-1-理所应当的方式"><a href="#1-1-理所应当的方式" class="headerlink" title="1.1 理所应当的方式"></a>1.1 理所应当的方式</h3><p>如下代码，基本我们都会写：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String string = <span class="string">"风尘-博客"</span>;</span><br><span class="line">String[] arr = string.split(<span class="string">"-"</span>);</span><br><span class="line">String part1 = arr[<span class="number">0</span>];</span><br><span class="line">System.out.println(part1);</span><br><span class="line">String part2 = arr[<span class="number">1</span>];</span><br><span class="line">System.out.println(part2);</span><br></pre></td></tr></table></figure>

<p>打印结果也没毛病。但是，如果你遇到过这种：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String str = <span class="string">"风尘.博客"</span>;</span><br><span class="line">String[] strArr = str.split(<span class="string">"."</span>);</span><br><span class="line">String string1 = strArr[<span class="number">0</span>];</span><br><span class="line">System.out.println(string1);</span><br><span class="line">String string2 = strArr[<span class="number">1</span>];</span><br><span class="line">System.out.println(string2);</span><br></pre></td></tr></table></figure>

<p>再次运行，控制台就抛错：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">java.lang.ArrayIndexOutOfBoundsException: 0</span><br></pre></td></tr></table></figure>

<h3 id="1-2-正确的操作方式"><a href="#1-2-正确的操作方式" class="headerlink" title="1.2 正确的操作方式"></a>1.2 正确的操作方式</h3><p>追根溯源，看下源码。</p>
<p>很明显，<code>String.split(String regex)</code>方法中的参数<code>regex</code>是正则表达式分隔符。</p>
<ul>
<li>单个转义字符</li>
</ul>
<blockquote>
<p> <code>.</code> 、<code>$</code>、<code>|</code> 和 <code>*</code> 等转义字符，必须得加 <code>\\</code>或者使用 <code>Pattern.quote()</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trueMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String str = <span class="string">"风尘.博客"</span>;</span><br><span class="line">    String[] strArr = str.split(<span class="string">"\\."</span>);</span><br><span class="line">    <span class="comment">// 这一种写法也行</span></span><br><span class="line"><span class="comment">//        String[] strArr = str.split(Pattern.quote("."));</span></span><br><span class="line">    String string1 = strArr[<span class="number">0</span>];</span><br><span class="line">    System.out.println(string1);</span><br><span class="line">    String string2 = strArr[<span class="number">1</span>];</span><br><span class="line">    System.out.println(string2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>多个分隔符，可以用<code>|</code>作为连字符。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">upMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String str = <span class="string">"风尘.博客|你好"</span>;</span><br><span class="line">    String[] strArr = str.split(<span class="string">"\\.|\\|"</span>);</span><br><span class="line">    String string1 = strArr[<span class="number">0</span>];</span><br><span class="line">    System.out.println(string1);</span><br><span class="line">    String string2 = strArr[<span class="number">1</span>];</span><br><span class="line">    System.out.println(string2);</span><br><span class="line">    String string3 = strArr[<span class="number">2</span>];</span><br><span class="line">    System.out.println(string3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、字符串拼接"><a href="#二、字符串拼接" class="headerlink" title="二、字符串拼接"></a>二、字符串拼接</h2><p>字符串拼接是我们在<code>Java</code>代码中比较经常要做的事情，就是把多个字符串拼接到一起。</p>
<blockquote>
<p>我们都知道，<code>String</code>是<code>Java</code>中一个不可变的类，所以他一旦被实例化就无法被修改。</p>
</blockquote>
<h3 id="2-1-使用-拼接字符串"><a href="#2-1-使用-拼接字符串" class="headerlink" title="2.1 使用+拼接字符串"></a>2.1 使用<code>+</code>拼接字符串</h3><p>虽然字符串是不可变的，但是还是可以通过新建字符串的方式来进行字符串的拼接。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">plus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String str = <span class="string">"风尘"</span>;</span><br><span class="line">    String weChat = <span class="string">"博客"</span>;</span><br><span class="line">    String string = str + weChat;</span><br><span class="line">    logger.info(string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果拼接的字符串是 <code>null</code>，<code>+</code>号操作符会当做是一个<code>null</code>字符串来处理。</p>
</blockquote>
<h3 id="2-2-concat方式"><a href="#2-2-concat方式" class="headerlink" title="2.2 concat方式"></a>2.2 <code>concat</code>方式</h3><p>当两个量都为<code>String</code>类型且值不为<code>null</code>时，可以用<code>concat</code>方式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">concat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String str = <span class="string">"风尘"</span>;</span><br><span class="line">    String weChat = <span class="string">"博客"</span>;</span><br><span class="line">    String string = str.concat(weChat);</span><br><span class="line">    logger.info(string);</span><br><span class="line">    <span class="comment">// java.lang.NullPointerException</span></span><br><span class="line">    str.concat(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果拼接的字符串是 <code>null</code>，<code>concat</code> 时候就会抛出 <code>NullPointerException</code>。</p>
</blockquote>
<h3 id="2-3-StringBuffer-append"><a href="#2-3-StringBuffer-append" class="headerlink" title="2.3 StringBuffer.append()"></a>2.3 <code>StringBuffer.append()</code></h3><p>当需要拼接至少三个量的时候，可以考虑使用<code>StringBuffer.append()</code>以避免临时字符串的产生。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stringBuffer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuffer str = <span class="keyword">new</span> StringBuffer(<span class="string">"欢迎关注"</span>);</span><br><span class="line">    StringBuffer string = str.append(<span class="string">":"</span>).append(<span class="string">"风尘博客"</span>);</span><br><span class="line">    logger.info(string.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当<code>a</code>,<code>b</code>,<code>c</code>拼接起来会很长时，可以给在构造器中传入一个合适的预估容量以减少因扩展缓冲空间而带来的性能开销。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">StringBuffer buf = <span class="keyword">new</span> StringBuffer(a.length() + b.length() + c.length());</span><br></pre></td></tr></table></figure>

<h3 id="2-4-StringBuilder-append"><a href="#2-4-StringBuilder-append" class="headerlink" title="2.4 StringBuilder.append()"></a>2.4 <code>StringBuilder.append()</code></h3><p>其用法和<code>StringBuffer</code>类似,只不过 <code>StringBuffer</code> 是线程安全的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stringBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuilder str = <span class="keyword">new</span> StringBuilder(<span class="string">"欢迎关注"</span>);</span><br><span class="line">    StringBuilder string = str.append(<span class="string">":"</span>).append(<span class="string">"风尘博客"</span>);</span><br><span class="line">    logger.info(string.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-StringJoiner-add"><a href="#2-5-StringJoiner-add" class="headerlink" title="2.5 StringJoiner.add()"></a>2.5 <code>StringJoiner.add()</code></h3><p><code>StringJoiner</code>其实是通过<code>StringBuilder</code>实现的，所以他的性能和<code>StringBuilder</code>差不多，他也是非线程安全的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stringJoiner</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringJoiner str = <span class="keyword">new</span> StringJoiner(<span class="string">":"</span>);</span><br><span class="line">    str.add(<span class="string">"欢迎关注"</span>).add(<span class="string">"风尘博客"</span>);</span><br><span class="line">    logger.info(str.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们使用<code>StringJoiner(CharSequence delimiter)</code>初始化一个<code>StringJoiner</code>的时候，这个<code>delimiter</code>其实是分隔符，并不是可变字符串的初始值。</p>
<ul>
<li>集合进行字符串拼接</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listSplice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="string">"欢迎关注"</span>);</span><br><span class="line">    list.add(<span class="string">"风尘博客"</span>);</span><br><span class="line">    String str = list.stream().collect(Collectors.joining(<span class="string">":"</span>));</span><br><span class="line">    logger.info(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-String-类的-join-方法"><a href="#2-6-String-类的-join-方法" class="headerlink" title="2.6 String 类的 join 方法"></a>2.6 <code>String</code> 类的 <code>join</code> 方法</h3><blockquote>
<p>第一个参数为字符串连接符。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 第一个参数为字符串连接符。</span></span><br><span class="line">    String str = String.join(<span class="string">":"</span>,<span class="string">"欢迎关注"</span>,<span class="string">"风尘博客"</span>);</span><br><span class="line">    logger.info(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法是通过<code>StringJoiner</code>实现的。</p>
<h3 id="2-7-总结"><a href="#2-7-总结" class="headerlink" title="2.7 总结"></a>2.7 总结</h3><ol>
<li>如果只是简单的字符串拼接，考虑直接使用<code>+</code>即可；</li>
<li>在不考虑线程安全和同步的情况下，为了获得最高的性能，我们应尽量使用<code>StringBuilder</code>，反之使用<code>StringBuffer</code>；</li>
<li>如果是通过一个集合（如<code>List</code>）进行字符串拼接，则考虑使用<code>StringJoiner</code>。</li>
</ol>
<p><a href="https://github.com/vanDusty/jdk/blob/master/JDK-String/src/test/java/cn/van/jdk/string/splice/StringSpliceTest.java" target="_blank" rel="noopener">Github 示例代码</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>String</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring 计时器 StopWatch</title>
    <url>/2020/03/01/6900a0bb.html</url>
    <content><![CDATA[<blockquote>
<p>如果你也觉得<code>System.currentTimeMillis()</code>用起来太麻烦了，欢迎加入<code>StopWatch</code>的怀抱。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>在我们平时开发中，多多少少会遇到统计一段代码片段的耗时的情况，最简单的方法就是打印当前时间与执行完时间的差值。还可能会想到<code>AOP</code>，使用切面可以无侵入的实现，但是该方法统计粒度为方法级别，方法内部的各个任务耗时无法统计。</p>
<h2 id="二、Spring的StopWatch"><a href="#二、Spring的StopWatch" class="headerlink" title="二、Spring的StopWatch"></a>二、<code>Spring</code>的<code>StopWatch</code></h2><blockquote>
<p><code>spring-framework</code>提供了一个<code>StopWatch</code>类可以做类似任务执行时间控制，也就是封装了一个对开始时间，结束时间记录操作的<code>Java</code>类。</p>
</blockquote>
<p><code>StopWatch</code>对于秒、毫秒为单位方便计时的程序，假如我们手里面有几个在顺序上前后执行的几个任务，而且我们比较关心几个任务分别执行的时间占用状况，希望能够形成一个不太复杂的日志输出，<code>StopWatch</code>提供了这样的功能。</p>
<h3 id="2-1-开箱即用"><a href="#2-1-开箱即用" class="headerlink" title="2.1 开箱即用"></a>2.1 开箱即用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopWatchDemo</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">    StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line"></span><br><span class="line">    sw.start(<span class="string">"起床"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    sw.stop();</span><br><span class="line"></span><br><span class="line">    sw.start(<span class="string">"洗漱"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    sw.stop();</span><br><span class="line"></span><br><span class="line">    sw.start(<span class="string">"锁门"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    sw.stop();</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">"all cost info:&#123;&#125;"</span>,sw.prettyPrint());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>先<code>new</code>一个<code>StopWatch</code>然后将这个实例<code>start(&quot;任务名称&quot;)</code>；</li>
<li>一个任务执行完毕则执行<code>stop()</code>；</li>
<li>下一个任务开启前<code>start(“下一任务名称‘)</code>；</li>
<li>最后可以调用 <code>prettyPrint()</code>方法返回一个小型的报表，输出代码执行耗时，以及执行时间百分比。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">20:00:42.981 [main] INFO cn.van.spring.demo.StopWatchTest - all cost info:StopWatch '': running time (millis) = 3506</span><br><span class="line">-----------------------------------------</span><br><span class="line">ms     %     Task name</span><br><span class="line">-----------------------------------------</span><br><span class="line">01000  029%  起床</span><br><span class="line">02002  057%  洗漱</span><br><span class="line">00504  014%  锁门</span><br></pre></td></tr></table></figure>

<h3 id="2-2-更多用法"><a href="#2-2-更多用法" class="headerlink" title="2.2 更多用法"></a>2.2 更多用法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopWatchDemo</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">    StopWatch sw = <span class="keyword">new</span> StopWatch();</span><br><span class="line">    <span class="comment">// start 开始记录指定任务</span></span><br><span class="line">    sw.start(<span class="string">"起床"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// stop 停止记录</span></span><br><span class="line">    sw.stop();</span><br><span class="line"></span><br><span class="line">    sw.start(<span class="string">"洗漱"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    sw.stop();</span><br><span class="line"></span><br><span class="line">    sw.start(<span class="string">"锁门"</span>);</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    sw.stop();</span><br><span class="line">    <span class="comment">// 输出代码执行耗时，以及执行时间百分比。</span></span><br><span class="line">    log.info(<span class="string">"all cost info:&#123;&#125;"</span>,sw.prettyPrint());</span><br><span class="line">    <span class="comment">// 统计输出总耗时</span></span><br><span class="line">    log.info(<span class="string">"all costTime:&#123;&#125;"</span>,sw.getTotalTimeMillis());</span><br><span class="line">    <span class="comment">// 返回简短的总耗时描述</span></span><br><span class="line">    log.info(<span class="string">"fff:&#123;&#125;"</span>,sw.shortSummary());</span><br><span class="line">    <span class="comment">// 最后一个任务的名称/耗时</span></span><br><span class="line">    log.info(<span class="string">"last taskName:&#123;&#125;"</span>,sw.getLastTaskName());</span><br><span class="line">    log.info(<span class="string">"last taskInfo:&#123;&#125;"</span>,sw.getLastTaskTimeMillis());</span><br><span class="line">    <span class="comment">// 返回统计时间任务的数量</span></span><br><span class="line">    log.info(<span class="string">"last taskCount:&#123;&#125;"</span>,sw.getTaskCount());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>getTotalTimeSeconds()</code>:获取总耗时秒，同时也有获取毫秒的方法；</li>
<li><code>prettyPrint()</code>: 优雅的格式打印结果，表格形式；</li>
<li><code>shortSummary()</code>:返回简短的总耗时描述；</li>
<li><code>getTaskCount()</code>:返回统计时间任务的数量；</li>
<li><code>getLastTaskName()</code>/<code>getLastTaskTimeMillis()</code>: 返回最后一个任务对象的名称/耗时。</li>
</ol>
<p><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/util/StopWatch.html" target="_blank" rel="noopener">官方文档</a></p>
<h3 id="2-3-优缺点"><a href="#2-3-优缺点" class="headerlink" title="2.3 优缺点"></a>2.3 优缺点</h3><ul>
<li><p>优点</p>
<ol>
<li><code>spring</code>自带工具类，可直接使用；</li>
<li>代码实现简单，使用更简单；</li>
<li>统一归纳，展示每项任务耗时与占用总时间的百分比，展示结果直观；</li>
<li>性能消耗相对较小，并且最大程度的保证了<code>start</code>与<code>stop</code>之间的时间记录的准确性；</li>
<li>可在<code>start</code>时直接指定任务名字，从而更加直观的显示记录结果。</li>
</ol>
</li>
<li><p>缺点</p>
<ol>
<li>一个<code>StopWatch</code>实例一次只能开启一个<code>task</code>，不能同时<code>start</code>多个<code>task</code>，并且在该<code>task</code>未<code>stop</code>之前不能<code>start</code>一个新的<code>task</code>；</li>
<li>相较于<code>AOP</code>，代码入侵性强。</li>
</ol>
</li>
</ul>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>使用<code>Spring</code>提供的这个监视器，不仅可以省略大量的<code>System.currentTimeMillis()</code>及运算，而且它提供的<code>prettyPrint()</code>打印在日志里进行分析可以非常的直观。</p>
<p><a href="https://github.com/vanDusty/Frame-Home/blob/master/spring-case/spring-demo/src/test/java/cn/van/spring/demo/StopWatchTest.java" target="_blank" rel="noopener">Github 示例代码</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>计时</tag>
      </tags>
  </entry>
  <entry>
    <title>多账户登陆设计</title>
    <url>/2020/01/27/ff12c210.html</url>
    <content><![CDATA[<p>现在几乎大部分的<code>App</code>都支持使用多个第三方账号进行登录，如：微信、<code>QQ</code>、微博等，我们把此称为多账号统一登陆。而这些账号的表设计，流程设计至关重要，不然后续扩展性贼差。本文不提供任何代码实操，但是梳理一下博主根据我司账号模块的设计，提供思路，仅供参考。</p>
<a id="more"></a>

<h2 id="一、-自建的登陆体系"><a href="#一、-自建的登陆体系" class="headerlink" title="一、 自建的登陆体系"></a>一、 自建的登陆体系</h2><h3 id="1-1-手机号登陆注册"><a href="#1-1-手机号登陆注册" class="headerlink" title="1.1 手机号登陆注册"></a>1.1 手机号登陆注册</h3><blockquote>
<p>该设计的思路是每个手机号对应一个用户，手机号为必填项。</p>
</blockquote>
<p>流程：</p>
<ol>
<li>首先输入手机号，然后发送到服务端。先判断该手机号是否存在账号，如果没有，就会生成随机验证码，将手机号和验证码绑定到<code>Redis</code>中，并设置一定的过期时间（过期时间一般是5分钟，这就是我们一般手机验证码的有效期），最后将验证码通过短信发送给用户。</li>
<li>用户接收到验证码后，在界面填写验证码以及密码等基础信息，然后将这些数据发送服务端。服务端收到后，先判断在<code>Redis</code>里面这个手机号对应的验证码是否一致，，失败就返回错误码，成功就给用户创建一个账号和保存密码。</li>
<li>注册成功后，用户即可通过自己的<code>手机号+密码</code>进行登陆。 </li>
</ol>
<p>问题：</p>
<ol>
<li>用户体验差，需要完成获取验证码，填写验证码/密码/用户名等诸多的信息完成注册，然后才能使用；</li>
<li>容易遗忘密码，遗忘后，只能通过忘记密码来重新设置密码。</li>
</ol>
<h3 id="1-2-优化注册登陆"><a href="#1-2-优化注册登陆" class="headerlink" title="1.2 优化注册登陆"></a>1.2 优化注册登陆</h3><blockquote>
<p>该方案的思路是弱化密码的必填性，即无论用户是否注册过，可通过<code>手机号 + 验证码</code> 直接进行登陆(保留<code>手机号 + 密码</code>登录的方式)。</p>
</blockquote>
<p>流程：</p>
<ol>
<li>输入手机号，然后发送到服务端。服务端生成随机验证码，将手机号和验证码绑定到<code>Redis</code>中，并设置一定的过期时间（过期时间一般是5分钟，这就是我们一般手机验证码的有效期），最后将验证码通过短信发送给用户。</li>
<li>用户接收到验证码后，在界面只需填写收到的验证码，提交到服务端。服务端收到后，先判断在<code>Redis</code>里面这个手机号对应的验证码是否一致，失败就返回错误码，成功就直接登录。如果是老用户，直接拉取用户信息；如果是新用户，则提示他可以完善用户信息（不强制）。<ol start="3">
<li>用户通过<code>手机号 + 验证码</code>登录后，也可选择设置密码，然后就可以通过<code>手机号 + 密码</code>的方式登录，即：密码是非必填项。</li>
</ol>
</li>
</ol>
<p>用户表设计：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>user_name</th>
<th>user_password</th>
<th>user_mobile</th>
<th>state</th>
<th>more</th>
</tr>
</thead>
<tbody><tr>
<td>用户id</td>
<td>用户名</td>
<td>用户密码</td>
<td>手机号码</td>
<td>账号状态</td>
<td>其他信息</td>
</tr>
</tbody></table>
<h3 id="1-3-引入第三方账户方案"><a href="#1-3-引入第三方账户方案" class="headerlink" title="1.3 引入第三方账户方案"></a>1.3 引入第三方账户方案</h3><h4 id="1-3-1-微博登录"><a href="#1-3-1-微博登录" class="headerlink" title="1.3.1 微博登录"></a>1.3.1 微博登录</h4><p>进入 <code>Web2.0</code> 时代 ,微博开放了第三方网站登录, 产品说, 这个我们得要, 加个用微博帐号就能登录我们的<code>App</code>吧，而且得和我们自己的用户表关联。</p>
<p>流程：</p>
<ol>
<li>客户端调用微博登录的界面，进行输入用户名、密码，登录成功后，会返回<code>access_token</code>,通过<code>access_token</code>调取<code>API</code>接口获取用户信息。</li>
<li>服务端通过用户信息在我们用户表创建一个账号，以后，该第三方账号即可通过该微博账号直接进行登陆。</li>
</ol>
<p>微博用户信息表设计：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>user_id</th>
<th>uid</th>
<th>access_token</th>
</tr>
</thead>
<tbody><tr>
<td>主键id</td>
<td>用户id</td>
<td>微博唯一id</td>
<td>授权码</td>
</tr>
</tbody></table>
<h4 id="1-3-2-噩梦来临"><a href="#1-3-2-噩梦来临" class="headerlink" title="1.3.2 噩梦来临"></a>1.3.2 噩梦来临</h4><p>紧接着, <code>QQ</code>又开放用户登录了, 微信开放用户登录了，网易开发用户登录了。。。。。。一下子要接入好多家第三方登录了, 只能按照 “微博用户信息表” 新建一个表，重写一套各个第三方登录。</p>
<h2 id="二、-优化账号体系"><a href="#二、-优化账号体系" class="headerlink" title="二、 优化账号体系"></a>二、 优化账号体系</h2><h3 id="2-1-原账号体系分析"><a href="#2-1-原账号体系分析" class="headerlink" title="2.1 原账号体系分析"></a>2.1 原账号体系分析</h3><ol>
<li>自建登陆体系：无论 <code>手机号 + 密码</code> , 还是 <code>手机号 + 验证码</code> , 都是一种 <code>用户信息+密码</code> 的验证形式；</li>
<li>第三方登录：也是<code>用户信息+密码</code> 的形式, 用户信息即第三方系统中的 <code>ID</code>(第三方系统中的唯一标识), 密码即 <code>access_token</code>, 只不过是一种有使用时效定期修改的密码。</li>
</ol>
<h3 id="2-2-新的账号体系"><a href="#2-2-新的账号体系" class="headerlink" title="2.2 新的账号体系"></a>2.2 新的账号体系</h3><h4 id="2-2-1-数据表设计"><a href="#2-2-1-数据表设计" class="headerlink" title="2.2.1 数据表设计"></a>2.2.1 数据表设计</h4><p>用户基础信息表：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>nickname</th>
<th>avatar</th>
<th>more</th>
</tr>
</thead>
<tbody><tr>
<td>用户id</td>
<td>昵称</td>
<td>头像</td>
<td>其他信息</td>
</tr>
</tbody></table>
<p>用户授权信息表：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>user_id</th>
<th>identity_type</th>
<th>identifier</th>
<th>credential</th>
</tr>
</thead>
<tbody><tr>
<td>主键id</td>
<td>用户id</td>
<td>登录类型(手机号/邮箱) 或第三方应用名称 (微信/微博等)</td>
<td>手机号/邮箱/第三方的唯一标识</td>
<td>密码凭证 (自建账号的保存密码, 第三方的保存 token)</td>
</tr>
</tbody></table>
<p>说明：</p>
<ol>
<li>用户表分为 <code>用户基础信息表</code> + <code>用户授权信息表</code>；</li>
<li>用户信息表不保存任何密码, 不保存任何登录信息(如用户名, 手机号, 邮箱), 只留有昵称、头像等基础信息; 所有和授权相关,都放在用户信息授权表, <strong>用户信息表和用户授权表是一对多的关系</strong>。</li>
</ol>
<h4 id="2-2-2-登录流程"><a href="#2-2-2-登录流程" class="headerlink" title="2.2.2 登录流程"></a>2.2.2 登录流程</h4><ul>
<li><code>手机号 + 验证码</code></li>
</ul>
<p>沿用之前的方案。</p>
<ul>
<li><code>邮箱/手机号 + 密码</code>:</li>
</ul>
<p>用户填写 <code>邮箱/手机号 + 密码</code>; 请求登录的时候, 先判断类型, 如手机号登录为例：</p>
<p>使用 <code>type= &#39;phone&#39;</code> 结合 <code>identifier= &#39;手机号&#39;</code> 查找, 如有, 取出并判断 <code>password_hash</code> (密码)是否和该条目的 <code>credential</code> 相符, 相符则通过验证, 随后通过 <code>user_id</code> 获取用户信息;</p>
<ul>
<li>第三方登录, 如微信登录：</li>
</ul>
<p>查询<code>type= &#39;weixin&#39;</code> 结合 <code>identifier= &#39;微信 openId&#39;</code>, 如果有记录, 则直接登录成功, 并更新<code>token</code>; 假设与微信服务器通信不被劫持的情况下无需判断凭证问题。</p>
<h4 id="2-2-3-优缺点"><a href="#2-2-3-优缺点" class="headerlink" title="2.2.3 优缺点"></a>2.2.3 优缺点</h4><p>优点:</p>
<ol>
<li>登录类型无限扩展, 新增登录类型的开发成本显著降低;</li>
<li>原来条件下, 应用需要验证手机号是否已验证和邮箱是否已验证, 需要相对应多一个字段如 <code>phone_verified</code> 和 <code>email_verified</code>, 如今只要在 <code>user_auths</code> 表中增加一个统一的 <code>verified</code> 字段, 每种登录方式都可以直观看到是否已验证情况; </li>
<li>在 <code>user_auths</code> 添加相应的时间和 <code>IP</code> 地址, 就可以更加完整地跟踪用户的使用习惯, 比如:已经不使用微博登录两年多, 已经绑定微信 300天;</li>
<li>如果你说邮箱和手机号就是用户信息的组成部分, users 表尽管拓展, users 表里依然有email , phone , 但他们仅仅作为“展示用途”,和昵称,头像或者性别这些属性没有本质区别;</li>
<li>可按需绑定任意数量的同类型登录方式, 即一个用户可以绑定多个微信, 可以有多个邮箱, 可以有多个手机号。当然你也可以限制一种登录方式只有一条记录;</li>
</ol>
<p>缺点 :</p>
<ol>
<li>用户同时存在邮箱、用户名、手机号等多种站内登录方式时, 改密码时必须一起改, 否则就变成了<code>邮箱 + 新密码</code>, <code>手机号 + 旧密码</code>都可以登录, 肯定是很诡异的情况; </li>
<li>代码量增加了, 有些情况下逻辑判断增加了, 难度增大了; 举个例子, 无论用户是否已登录, 无论用户是否已注册过, 都是点击同一链接前往微博第三方授权后返回, 可能出现几种情况:<ol>
<li>该微博在本站未注册过, 很好, 直接给他注册关联并登录；</li>
<li>该微博已经在本站存在, 当前用户未登录, 直接登录成功；</li>
<li>该微博未在本站注册, 但当前用户已经登录并关联的是另一个微博帐号, 作何处理取决于是否允许绑定多个微博帐号；</li>
<li>该微博未在本站注册过, 当前用户已登录, 尝试进行绑定操作；</li>
<li>该微博已经注册, 用户又已使用该帐号登录, 为何他重复绑定自己;</li>
<li>该微博已经在本站存在, 但当前用户已经登录并关联的是另一个微博帐号, 作何处理? </li>
</ol>
</li>
</ol>
<h2 id="三、-一键登陆"><a href="#三、-一键登陆" class="headerlink" title="三、 一键登陆"></a>三、 一键登陆</h2><h3 id="3-1-背景"><a href="#3-1-背景" class="headerlink" title="3.1 背景"></a>3.1 背景</h3><p>回顾一下<code>手机号 + 验证码</code> 的登录方式：</p>
<ol>
<li>输入手机号、等待验证码短信、输入验证码、点击登录。整个流程走完可能需要 20 秒以上，操作也比较繁琐；</li>
<li>它是依赖短信网络的，因为如果收不到短信，也就登录不了了。</li>
<li>从安全角度考虑，还存在验证码泄漏的风险。如果有人知道了你的手机号，并且窃取到了验证码，那他也能登录你的账号了。</li>
</ol>
<p>但回过头来想一下，为什么我们需要验证码？验证码的作用就是确定这个手机号是你的，那除了使用短信，是否还有别的方式对手机号进行认证？</p>
<ol>
<li>如果能获取到当前使用的手机号，就能对用户输入的号码进行验证了。但出于安全考虑，客户端是无法直接获取到手机号的，运营商则可以通过 <code>SIM</code> 卡数据查询到。</li>
<li>现在运营商已经开放了相关的能力，现在我们可以在用户输入手机号后，通过调用运营商的接口，判断用户输入的手机号是否和本地号码一致。这样一来，用户就省去了等待验证码短信、输入验证码的过程，也不受短信网络的限制，简化了登录流程。</li>
<li>但再进一步想，如果运营商可以把当前的号码直接返回给我们，而不只是用于验证，那用户连手机号都不需要填了。</li>
</ol>
<p>这就是该部分的主角：<strong>一键登录</strong>。</p>
<h3 id="3-2-本机号码认证"><a href="#3-2-本机号码认证" class="headerlink" title="3.2 本机号码认证"></a>3.2 本机号码认证</h3><p>获取到当前手机使用的手机卡号，直接使用这个号码进行登录，这就是一键登录。</p>
<p>这种登录方式的好处是显而易见的。它可以更方便、快捷地完成注册、登录流程，将原本可能需要 20 秒的流程，缩短到了 2 秒左右，很大程度上提升了登录的用户体验。</p>
<p>主要步骤如下：</p>
<ol>
<li>SDK 初始化：调用 SDK 的初始化方法，传入项目在平台上的 AppKey 和 AppSecret。</li>
<li>唤起授权页：调用 SDK 唤起授权接口。SDK 会先向运营商发起获取手机号掩码的请求，请求成功后跳转到授权页。授权页会显示手机号掩码以及运营商协议给用户确认。</li>
<li>同意授权并登录：用户同意相关协议，点击授权页面的登录按钮，SDK 会请求本次取号的 token，请求成功后将 token 返回给客户端。</li>
<li>取号：将获取到的 token 发送到我们自己的服务器，由服务器携带 token 调用运营商一键登录的接口，调用成功就返回手机号码了。服务器用手机号进行登录或注册操作，返回操作结果给客户端，完成一键登录。</li>
</ol>
<p>目前阿里云已经提供了该方式并可兼容三大运营商的号码，详见<a href="https://help.aliyun.com/document_detail/121113.html?spm=a2c4g.11186623.6.554.386517eau11jSe" target="_blank" rel="noopener">阿里云SDK</a></p>
<h2 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h2><p>博主看来，没有最好的方案，选择适用当前系统的设计即可。不要深究孰优孰劣，鞋合不合脚，只有脚知道。</p>
]]></content>
      <categories>
        <category>代码设计</category>
      </categories>
      <tags>
        <tag>账号系统</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 泛型</title>
    <url>/2020/01/18/959c49ba.html</url>
    <content><![CDATA[<p><code>Java</code> 泛型（<code>generics</code>）是 <code>JDK 1.5</code> 中引入的一个新特性, 泛型提供了<strong>编译时类型安全检测机制</strong>，该机制允许开发者在编译时检测到非法的类型。</p>
<a id="more"></a>


<h3 id="1-1-什么是泛型？"><a href="#1-1-什么是泛型？" class="headerlink" title="1.1 什么是泛型？"></a>1.1 什么是泛型？</h3><ul>
<li>泛型，即<strong>参数化类型</strong>。</li>
</ul>
<p>一提到参数，最熟悉的就是定义方法时有形参，然后调用此方法时传递实参。那么参数化类型怎么理解呢？顾名思义，就是将类型由原来的具体的类型参数化，类似于方法中的变量参数，此时类型也定义成参数形式（可以称之为类型形参），然后在使用/调用时传入具体的类型（类型实参）。</p>
<ul>
<li><strong>泛型的本质是为了参数化类型</strong></li>
</ul>
<p>在不创建新的类型的情况下，通过泛型指定的不同类型来控制形参具体限制的类型。也就是说在泛型使用过程中，操作的数据类型被指定为一个参数，这种参数类型可以用在类、接口和方法中，分别被称为泛型类、泛型接口、泛型方法。</p>
<h3 id="1-2-举个栗子："><a href="#1-2-举个栗子：" class="headerlink" title="1.2 举个栗子："></a>1.2 举个栗子：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    list.add(<span class="string">"风尘博客"</span>);</span><br><span class="line">    list.add(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; list.size();i++)&#123;</span><br><span class="line">        String item = (String)list.get(i);</span><br><span class="line">        log.info(<span class="string">"item:&#123;&#125;"</span>, item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>毫无疑问，程序的运行结果会以崩溃结束：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">java.lang.ClassCastException: java.lang.Integer cannot be cast to java.lang.String</span><br></pre></td></tr></table></figure>

<p><code>ArrayList</code>可以存放任意类型，例子中先添加了一个<code>String</code>类型，又添加了一个<code>Integer</code>类型。使用时都以<code>String</code>的方式使用，因此程序崩溃了。为了解决类似这样的问题（在编译阶段就可以解决），泛型应运而生。</p>
<h3 id="1-3-特性"><a href="#1-3-特性" class="headerlink" title="1.3 特性"></a>1.3 特性</h3><blockquote>
<p>泛型只在编译阶段有效</p>
</blockquote>
<ol>
<li>在编译的时候能够检查类型安全，并且所有的强制转换都是自动和隐式的；</li>
<li>在逻辑上看以看成是多个不同的类型，实际上都是相同的基本类型。</li>
</ol>
<h2 id="二、泛型的使用"><a href="#二、泛型的使用" class="headerlink" title="二、泛型的使用"></a>二、泛型的使用</h2><p>泛型有三种使用方式，分别为：泛型类、泛型接口、泛型方法。</p>
<h3 id="2-1-泛型类"><a href="#2-1-泛型类" class="headerlink" title="2.1 泛型类"></a>2.1 泛型类</h3><p>泛型类型用于类的定义中，被称为泛型类。通过泛型可以完成对一组类的操作对外开放相同的接口。最典型的就是各种容器类，如：<code>List</code>、<code>Set</code>、<code>Map</code>。</p>
<h4 id="2-1-1-一个最普通的泛型类"><a href="#2-1-1-一个最普通的泛型类" class="headerlink" title="2.1.1 一个最普通的泛型类"></a>2.1.1 一个最普通的泛型类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericClass</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key这个成员变量的类型为T,T的类型由外部指定</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 泛型构造方法形参key的类型也为T，T的类型由外部指定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericClass</span><span class="params">(T key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 泛型方法getKey()的返回值类型为T，T的类型由外部指定</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：</p>
<ol>
<li>此处<code>T</code>可以随便写为任意标识，常见的如<code>T</code>、<code>E</code>、<code>K</code>、<code>V</code>等形式的参数常用于表示泛型；</li>
<li>在实例化泛型类时，必须指定<code>T</code>的具体类型。</li>
</ol>
</blockquote>
<h4 id="2-1-2-泛型的使用"><a href="#2-1-2-泛型的使用" class="headerlink" title="2.1.2 泛型的使用"></a>2.1.2 泛型的使用</h4><ul>
<li>指定泛型类型</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericDemoWithType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//泛型的类型参数只能是类类型（包括自定义类），不能是简单类型，比如这里Integer改为int编译将不通过</span></span><br><span class="line">    GenericClass&lt;Integer&gt; integerGeneric = <span class="keyword">new</span> GenericClass&lt;Integer&gt;(<span class="number">123456</span>);</span><br><span class="line">    logger.info(<span class="string">"integerGeneric key is:&#123;&#125;"</span>, integerGeneric.getKey());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//传入的实参类型需与泛型的类型参数类型相同，即为String.</span></span><br><span class="line">    GenericClass&lt;String&gt; stringGeneric = <span class="keyword">new</span> GenericClass&lt;String&gt;(<span class="string">"风尘博客"</span>);</span><br><span class="line">    logger.info(<span class="string">"stringGeneric key is:&#123;&#125;"</span>, stringGeneric.getKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不指定泛型类型</li>
</ul>
<p>如果不传入泛型类型实参的话，在泛型类中使用泛型的方法或成员变量定义的类型可以为任何的类型。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">genericDemoWithOutType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    GenericClass generic = <span class="keyword">new</span> GenericClass(<span class="string">"111111"</span>);</span><br><span class="line">    logger.info(<span class="string">"generic key is:&#123;&#125;"</span>, generic.getKey());</span><br><span class="line">    GenericClass generic1 = <span class="keyword">new</span> GenericClass(<span class="number">4444</span>);</span><br><span class="line">    logger.info(<span class="string">"generic1 key is:&#123;&#125;"</span>, generic1.getKey());</span><br><span class="line">    GenericClass generic2 = <span class="keyword">new</span> GenericClass(<span class="number">55.55</span>);</span><br><span class="line">    logger.info(<span class="string">"generic2 key is:&#123;&#125;"</span>, generic2.getKey());</span><br><span class="line">    GenericClass generic3 = <span class="keyword">new</span> GenericClass(<span class="keyword">false</span>);</span><br><span class="line">    logger.info(<span class="string">"generic3 key is:&#123;&#125;"</span>, generic3.getKey());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-3-泛型类小结"><a href="#2-1-3-泛型类小结" class="headerlink" title="2.1.3 泛型类小结"></a>2.1.3 泛型类小结</h4><ol>
<li>泛型的类型参数只能是类类型，不能是简单类型;</li>
<li>不能对确切的泛型类型使用<code>instanceof</code>操作。</li>
</ol>
<h3 id="2-2-泛型接口"><a href="#2-2-泛型接口" class="headerlink" title="2.2 泛型接口"></a>2.2 泛型接口</h3><p>泛型接口与泛型类的定义及使用基本相同。泛型接口常被用在各种类的生产器中，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GeneratorInterface</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当实现泛型接口的类，未传入泛型实参时</li>
</ul>
<blockquote>
<p>未传入泛型实参时，与泛型类的定义相同，在声明类的时候，需将泛型的声明也一起加到类中。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FruitGenerator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">GeneratorInterface</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当实现泛型接口的类，传入泛型实参</li>
</ul>
<blockquote>
<p>在实现类实现泛型接口时，如已将泛型类型传入实参类型，则所有使用泛型的地方都要替换成传入的实参类型。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VegetablesGenerator</span> <span class="keyword">implements</span> <span class="title">GeneratorInterface</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String[] vegetables = <span class="keyword">new</span> String[]&#123;<span class="string">"Potato"</span>, <span class="string">"Tomato"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random rand = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">return</span> vegetables[rand.nextInt(<span class="number">2</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-泛型方法"><a href="#2-3-泛型方法" class="headerlink" title="2.3 泛型方法"></a>2.3 泛型方法</h3><p>在<code>java</code>中,泛型类的定义非常简单，但是泛型方法就比较复杂了。</p>
<blockquote>
<p>我们见到的大多数泛型类中的成员方法也都使用了泛型，有的甚至泛型类中也包含着泛型方法。</p>
</blockquote>
<ul>
<li>泛型类和泛型方法的区别</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>泛型类</th>
<th>泛型方法</th>
</tr>
</thead>
<tbody><tr>
<td>区别</td>
<td>是在实例化类的时候指明泛型的具体类型</td>
<td>是在调用方法的时候指明泛型的具体类型</td>
</tr>
</tbody></table>
<h4 id="2-3-1-定义"><a href="#2-3-1-定义" class="headerlink" title="2.3.1 定义"></a>2.3.1 定义</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">keyName</span><span class="params">(GenericMethod&lt;T&gt; container)</span></span>&#123;</span><br><span class="line">    T test = container.getKey();</span><br><span class="line">    <span class="keyword">return</span> test;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先在<code>public</code>与返回值之间的<code>&lt;T&gt;</code>必不可少，这表明这是一个泛型方法，并且声明了一个泛型<code>T</code>；</li>
<li>这个<code>T</code>可以出现在这个泛型方法的任意位置；</li>
<li>泛型的数量也可以为任意多个。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericMethod</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericMethod</span><span class="params">(T key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里虽然在方法中使用了泛型，但是这并不是一个泛型方法，</span></span><br><span class="line"><span class="comment">     * 这只是类中一个普通的成员方法，只不过他的返回值是在声明泛型类已经声明过的泛型，</span></span><br><span class="line"><span class="comment">     * 所以在这个方法中才可以继续使用 T 这个泛型。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这才是一个真正的泛型方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">keyName</span><span class="params">(GenericMethod&lt;T&gt; container)</span></span>&#123;</span><br><span class="line">        T test = container.getKey();</span><br><span class="line">        <span class="keyword">return</span> test;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这也不是一个泛型方法，这就是一个普通的方法，只是使用了Generic&lt;Number&gt;这个泛型类做形参而已。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showKeyValue1</span><span class="params">(GenericMethod&lt;Number&gt; obj)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这也不是一个泛型方法，这也是一个普通的方法，只不过使用了泛型通配符?</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showKeyValue2</span><span class="params">(GenericMethod&lt;?&gt; obj)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该方法编译器会报错</span></span><br><span class="line"><span class="comment">     * 虽然我们声明了&lt;T&gt;,也表明了这是一个可以处理泛型的类型的泛型方法。</span></span><br><span class="line"><span class="comment">     * 但是只声明了泛型类型T，并未声明泛型类型E，因此编译器并不知道该如何处理E这个类型。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> container</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    public &lt;T&gt; T showKeyName(GenericMethod&lt;E&gt; container)&#123;</span></span><br><span class="line"><span class="comment">//        return null;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-泛型方法的使用"><a href="#2-3-2-泛型方法的使用" class="headerlink" title="2.3.2 泛型方法的使用"></a>2.3.2 泛型方法的使用</h4><p>泛型方法可以出现杂任何地方和任何场景中使用，但是有一种情况是非常特殊的，<strong>泛型方法出现在泛型类中</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericMethodTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span>  <span class="title">Fruit</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"fruit"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> <span class="keyword">extends</span> <span class="title">Fruit</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"apple"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Person"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">GenerateTest</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show_1</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">            logger.info(t.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在泛型类中声明了一个泛型方法，使用泛型E，这种泛型E可以为任意类型。可以类型与T相同，也可以不同。</span></span><br><span class="line">        <span class="comment">//由于泛型方法在声明的时候会声明泛型&lt;E&gt;，因此即使在泛型类中并未声明泛型，编译器也能够正确识别泛型方法中识别的泛型。</span></span><br><span class="line">        <span class="keyword">public</span> &lt;E&gt; <span class="function"><span class="keyword">void</span> <span class="title">show_3</span><span class="params">(E t)</span></span>&#123;</span><br><span class="line">            logger.info(t.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在泛型类中声明了一个泛型方法，使用泛型T，注意这个T是一种全新的类型，可以与泛型类中声明的T不是同一种类型。</span></span><br><span class="line">        <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">show_2</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">            logger.info(t.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Apple apple = <span class="keyword">new</span> Apple();</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line"></span><br><span class="line">        GenerateTest&lt;Fruit&gt; generateTest = <span class="keyword">new</span> GenerateTest&lt;&gt;();</span><br><span class="line">        <span class="comment">//apple是Fruit的子类，所以这里可以</span></span><br><span class="line">        generateTest.show_1(apple);</span><br><span class="line">        <span class="comment">//编译器会报错，因为泛型类型实参指定的是Fruit，而传入的实参类是Person</span></span><br><span class="line">        <span class="comment">//generateTest.show_1(person);</span></span><br><span class="line">        <span class="comment">//使用这两个方法都可以成功</span></span><br><span class="line">        generateTest.show_2(apple);</span><br><span class="line">        generateTest.show_2(person);</span><br><span class="line">        <span class="comment">//使用这两个方法也都可以成功</span></span><br><span class="line">        generateTest.show_3(apple);</span><br><span class="line">        generateTest.show_3(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-静态方法与泛型"><a href="#2-3-3-静态方法与泛型" class="headerlink" title="2.3.3 静态方法与泛型"></a>2.3.3 静态方法与泛型</h4><p><strong>静态方法无法访问类上定义的泛型；如果静态方法操作的引用数据类型不确定的时候，必须要将泛型定义在方法上。</strong></p>
<p>如果写成如下,编译器会报错</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>正确写法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(T t)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-4-泛型方法小结"><a href="#2-3-4-泛型方法小结" class="headerlink" title="2.3.4 泛型方法小结"></a>2.3.4 泛型方法小结</h4><p>泛型方法能使方法独立于类而产生变化，以下是一个基本的指导原则：</p>
<blockquote>
<p>无论何时，如果你能做到，你就该尽量使用泛型方法。也就是说，如果使用泛型方法将整个类泛型化，那么就应该使用泛型方法。另外对于一个<code>static</code>的方法而已，无法访问泛型类型的参数。所以如果<code>static</code>方法要使用泛型能力，就必须使其成为泛型方法。</p>
</blockquote>
<h2 id="三、泛型通配符"><a href="#三、泛型通配符" class="headerlink" title="三、泛型通配符"></a>三、泛型通配符</h2><p>我们在定义泛型类，泛型方法，泛型接口的时候经常会碰见很多不同的通配符，比如 <code>T</code>、<code>E</code>、<code>K</code>、<code>V</code> 等等，这些通配符又都是什么意思呢？</p>
<h3 id="3-1-常用的-T、E、K、V、？"><a href="#3-1-常用的-T、E、K、V、？" class="headerlink" title="3.1 常用的 T、E、K、V、？"></a>3.1 常用的 <code>T</code>、<code>E</code>、<code>K</code>、<code>V</code>、<code>？</code></h3><p>本质上这些都是通配符，没啥区别，只不过是编码时的一种约定俗成的东西。比如上述代码中的 <code>T</code> ，我们可以换成 <code>A-Z</code> 之间的任何一个字母都可以，并不会影响程序的正常运行，但是如果换成其他的字母代替 <code>T</code> ，在可读性上可能会弱一些。通常情况下，<code>T</code>，<code>E</code>，<code>K</code>，<code>V</code>，<code>？</code> 是这样约定的：</p>
<ol>
<li><code>？</code>：表示不确定的 <code>java</code> 类型；</li>
<li><code>T (type)</code>：表示具体的一个<code>java</code>类型；</li>
<li><code>K V (key value)</code>：分别代表<code>java</code>键值中的<code>Key</code>/<code>Value</code>；</li>
<li><code>E (element)</code>：代表<code>Element</code>。</li>
</ol>
<h3 id="3-2-无界通配符"><a href="#3-2-无界通配符" class="headerlink" title="3.2 ?无界通配符"></a>3.2 <code>?</code>无界通配符</h3><p>对于不确定或者不关心实际要操作的类型，可以使用无限制通配符（尖括号里一个问号，即 <code>&lt;?&gt;</code> ），表示可以持有任何类型。</p>
<h3 id="3-3-上界通配符-lt-extends-E-gt"><a href="#3-3-上界通配符-lt-extends-E-gt" class="headerlink" title="3.3 上界通配符 &lt;? extends E&gt;"></a>3.3 上界通配符 <code>&lt;? extends E&gt;</code></h3><blockquote>
<p>上界：用 <code>extends</code> 关键字声明，表示参数化的类型可能是所指定的类型，或者是此类型的子类。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showKeyValue</span><span class="params">(GenericClass&lt;? extends Number&gt; obj)</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">"value is &#123;&#125;"</span>, obj.getKey());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testForUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    GenericClass&lt;String&gt; generic1 = <span class="keyword">new</span> GenericClass&lt;String&gt;(<span class="string">"11111"</span>);</span><br><span class="line">    GenericClass&lt;Integer&gt; generic2 = <span class="keyword">new</span> GenericClass&lt;Integer&gt;(<span class="number">2222</span>);</span><br><span class="line">    GenericClass&lt;Float&gt; generic3 = <span class="keyword">new</span> GenericClass&lt;Float&gt;(<span class="number">2.4f</span>);</span><br><span class="line">    GenericClass&lt;Double&gt; generic4 = <span class="keyword">new</span> GenericClass&lt;Double&gt;(<span class="number">2.56</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*// 这一行代码编译器会提示错误，因为String类型并不是Number类型的子类</span></span><br><span class="line"><span class="comment">    showKeyValue(generic1);*/</span></span><br><span class="line"></span><br><span class="line">    showKeyValue(generic2);</span><br><span class="line">    showKeyValue(generic3);</span><br><span class="line">    showKeyValue(generic4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在类型参数中使用 <code>extends</code> 表示这个泛型中的参数必须是 <code>E</code> 或者 <code>E</code> 的子类，这样有两个好处：</p>
<ol>
<li>如果传入的类型不是 <code>E</code> 或者 <code>E</code> 的子类，编译不成功；</li>
<li>泛型中可以使用 <code>E</code> 的方法，要不然还得强转成 <code>E</code> 才能使用。</li>
</ol>
<h3 id="3-4-下界通配符-lt-super-E-gt"><a href="#3-4-下界通配符-lt-super-E-gt" class="headerlink" title="3.4 下界通配符 &lt; ? super E&gt;"></a>3.4 下界通配符 <code>&lt; ? super E&gt;</code></h3><blockquote>
<p>下界: 用 <code>super</code> 进行声明，表示参数化的类型可能是所指定的类型，或者是此类型的父类型，直至 <code>Object</code></p>
</blockquote>
<p>在类型参数中使用 <code>super</code> 表示这个泛型中的参数必须是 <code>E</code> 或者 <code>E</code> 的父类。</p>
<p><strong>泛型的上下边界添加，必须与泛型的声明在一起</strong></p>
<h3 id="3-5-和-T-的区别"><a href="#3-5-和-T-的区别" class="headerlink" title="3.5 ? 和 T 的区别"></a>3.5 <code>?</code> 和 <code>T</code> 的区别</h3><p><code>?</code>和 <code>T</code> 都表示不确定的类型，区别在于我们可以对 <code>T</code> 进行操作，但是对 <code>?</code> 不行，比如如下这种 ：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 可以</span></span><br><span class="line">T t = operate();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不可以</span></span><br><span class="line">？ car = operate();</span><br></pre></td></tr></table></figure>

<p>即：<code>T</code> 是一个确定的类型，通常用于泛型类和泛型方法的定义，<code>?</code>是一个不确定的类型，通常用于泛型方法的调用代码和形参，不能用于定义类和泛型方法。</p>
<h3 id="3-6-Class-lt-T-gt-和-Class-lt-gt-区别"><a href="#3-6-Class-lt-T-gt-和-Class-lt-gt-区别" class="headerlink" title="3.6 Class&lt;T&gt; 和 Class&lt;?&gt; 区别"></a>3.6 <code>Class&lt;T&gt;</code> 和 <code>Class&lt;?&gt;</code> 区别</h3><p><code>Class&lt;T&gt;</code> 在实例化的时候，<code>T</code> 要替换成具体类。<code>Class&lt;?&gt;</code> 它是个通配泛型，<code>?</code>可以代表任何类型，所以主要用于声明时的限制情况。比如，我们可以这样做申明：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 可以</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; clazz;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不可以，因为 T 需要指定类型</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;T&gt; clazzT;</span><br></pre></td></tr></table></figure>

<p>所以当不知道定声明什么类型的 <code>Class</code> 的时候可以定义一 个<code>Class&lt;?&gt;</code>。<br>那如果也想 <code>public Class&lt;T&gt; clazzT</code>; 这样的话，就必须让当前的类也指定 <code>T</code> ，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Wildcard</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; clazz;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class&lt;T&gt; clazzT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、泛型中值得注意的地方"><a href="#四、泛型中值得注意的地方" class="headerlink" title="四、泛型中值得注意的地方"></a>四、泛型中值得注意的地方</h2><h3 id="4-1-类型擦除"><a href="#4-1-类型擦除" class="headerlink" title="4.1 类型擦除"></a>4.1 类型擦除</h3><blockquote>
<p>泛型信息只存在于代码编译阶段，在进入 <code>JVM</code> 之前，与泛型相关的信息会被擦除掉，专业术语叫做类型擦除。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericTypeErase</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; l1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;Integer&gt; l2 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        System.out.println(l1.getClass() == l2.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印的结果为 <code>true</code>；是因为 <code>List&lt;String&gt;</code>和 <code>List&lt;Integer&gt;</code>在 <code>jvm</code> 中的 <code>Class</code> 都是 <code>List.class</code>，泛型信息被擦除了。</p>
<h3 id="4-2-泛型类或者泛型方法中，不接受-8-种基本数据类型"><a href="#4-2-泛型类或者泛型方法中，不接受-8-种基本数据类型" class="headerlink" title="4.2 泛型类或者泛型方法中，不接受 8 种基本数据类型"></a>4.2 泛型类或者泛型方法中，不接受 <code>8</code> 种基本数据类型</h3><p>需要使用它们对应的包装类。</p>
<h3 id="4-3-Java-不能创建具体类型的泛型数组"><a href="#4-3-Java-不能创建具体类型的泛型数组" class="headerlink" title="4.3 Java 不能创建具体类型的泛型数组"></a>4.3 <code>Java</code> 不能创建具体类型的泛型数组</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Integer&gt;[] li2 = <span class="keyword">new</span> ArrayList&lt;Integer&gt;[];</span><br><span class="line">List&lt;Boolean&gt; li3 = <span class="keyword">new</span> ArrayList&lt;Boolean&gt;[];</span><br></pre></td></tr></table></figure>

<p><code>List&lt;Integer&gt;</code>和 <code>List&lt;Boolean&gt;</code>在 <code>jvm</code> 中等同于<code>List&lt;Object&gt;</code>，所有的类型信息都被擦除，程序也无法分辨一个数组中的元素类型具体是 <code>List&lt;Integer&gt;</code>类型还是 <code>List&lt;Boolean&gt;</code>类型。</p>
<h3 id="4-4-强烈建议大家使用泛型"><a href="#4-4-强烈建议大家使用泛型" class="headerlink" title="4.4 强烈建议大家使用泛型"></a>4.4 强烈建议大家使用泛型</h3><p>它抽离了数据类型与代码逻辑，本意是提高程序代码的简洁性和可读性，并提供可能的编译时类型转换安全检测功能。</p>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p><a href="https://github.com/vanDusty/JDK/tree/master/JDK-Generic" target="_blank" rel="noopener">Githu 示例代码</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><ol>
<li><a href="https://blog.csdn.net/s10461/article/details/53941091" target="_blank" rel="noopener">java 泛型详解-绝对是对泛型方法讲解最详细的，没有之一</a></li>
<li><a href="https://juejin.im/post/5d5789d26fb9a06ad0056bd9#comment" target="_blank" rel="noopener">聊一聊-JAVA 泛型中的通配符 T，E，K，V，？</a></li>
</ol>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>语法</tag>
        <tag>泛型</tag>
      </tags>
  </entry>
  <entry>
    <title>BeanUtils 如何拷贝 List？</title>
    <url>/2020/01/12/dad4e656.html</url>
    <content><![CDATA[<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>我们在<code>DO</code>、<code>Model</code>、<code>VO</code>层数据间可能经常转换数据:</p>
<ol>
<li><code>Entity</code>对应的是持久层数据结构（一般是数据库表的映射模型）;</li>
<li><code>Model</code> 对应的是业务层的数据结构;</li>
<li><code>VO</code> 就是<code>Controller</code>和客户端交互的数据结构。</li>
</ol>
<a id="more"></a>

<blockquote>
<p>例如：数据库查询出来的用户信息(表的映射模型)是<code>UserDO</code>，但是我们需要传递给客户端的是<code>UserVO</code>,这时候就需要把<code>UserDO</code>实例的属性一个一个赋值到<code>UserVO</code>实例中。</p>
</blockquote>
<p><strong>在这些数据结构之间很大一部分属性都可能会相同，也可能不同。</strong></p>
<h2 id="二、数据拷贝"><a href="#二、数据拷贝" class="headerlink" title="二、数据拷贝"></a>二、数据拷贝</h2><h3 id="2-1、数据模型"><a href="#2-1、数据模型" class="headerlink" title="2.1、数据模型"></a>2.1、数据模型</h3><ul>
<li><code>UserDO.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer sex;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDO</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDO</span><span class="params">(Long userId, String userName, Integer age, Integer sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userId = userId;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>UserVO.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong><br><code>UserDO.java</code> 和<code>UserVO.java</code> 最后一个字段<code>sex</code>类型不一样，分别是：<code>Integer</code>/<code>String</code></p>
<h3 id="2-2、常规使用-BeanUtils"><a href="#2-2、常规使用-BeanUtils" class="headerlink" title="2.2、常规使用-BeanUtils"></a>2.2、常规使用-<code>BeanUtils</code></h3><p><code>Spring</code> 提供了 <code>org.springframework.beans.BeanUtils</code> 类进行快速赋值。</p>
<p>例如：我们把数据库查询出来的<code>UserDO.java</code> 拷贝到 <code>UserVO.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commonCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserDO userDO = <span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>);</span><br><span class="line">    UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">    BeanUtils.copyProperties(userDO, userVO);</span><br><span class="line">    log.info(<span class="string">"userVO:&#123;&#125;"</span>,userVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志打印：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVO:UserVO(userId=1, userName=Van, age=18, sex=null)</span><br></pre></td></tr></table></figure>

<p>通过打印结果我们可以发现：除了类型不同的<code>sex</code>，其他数值都成功拷贝。</p>
<h3 id="2-3、集合拷贝"><a href="#2-3、集合拷贝" class="headerlink" title="2.3、集合拷贝"></a>2.3、集合拷贝</h3><p>刚刚拷贝的是一个对象，但是有时候我们想拷贝一组<code>UerDO.java</code>，是一个集合的时候就不能这样直接赋值了。如果还按照这种逻辑，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyFalse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">18</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    BeanUtils.copyProperties(userDOList, userVOList);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>日志打印如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVOList:[]</span><br></pre></td></tr></table></figure>

<p>通过日志可以发现，直接拷贝集合是无效的，那么怎么解决呢？</p>
<h2 id="三、集合拷贝"><a href="#三、集合拷贝" class="headerlink" title="三、集合拷贝"></a>三、集合拷贝</h2><h3 id="3-1、暴力拷贝（不推荐）"><a href="#3-1、暴力拷贝（不推荐）" class="headerlink" title="3.1、暴力拷贝（不推荐）"></a>3.1、暴力拷贝（不推荐）</h3><blockquote>
<p>将需要拷贝的集合遍历，暴力拷贝。</p>
</blockquote>
<ul>
<li>测试方式</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyCommon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">20</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.forEach(userDO -&gt;&#123;</span><br><span class="line">        UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">        BeanUtils.copyProperties(userDO, userVO);</span><br><span class="line">        userVOList.add(userVO);</span><br><span class="line">    &#125;);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVOList:[UserVO(userId=1, userName=Van, age=18, sex=null), UserVO(userId=2, userName=VanVan, age=20, sex=null)]</span><br></pre></td></tr></table></figure>

<p>虽然该方式可以解决，但是一点都不优雅，特别是写起来麻烦。</p>
<h3 id="3-2、优雅拷贝（本文推荐）"><a href="#3-2、优雅拷贝（本文推荐）" class="headerlink" title="3.2、优雅拷贝（本文推荐）"></a>3.2、优雅拷贝（<strong>本文推荐</strong>）</h3><p>通过<code>JDK 8</code> 的函数式接口封装<code>org.springframework.beans.BeanUtils</code></p>
<ul>
<li>定义一个函数式接口</li>
</ul>
<p>函数式接口里是可以包含默认方法，这里我们定义默认回调方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanCopyUtilCallBack</span> &lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义默认回调方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">callBack</span><span class="params">(S t, T s)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>封装一个数据拷贝工具类 <code>BeanCopyUtil.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanCopyUtil</span> <span class="keyword">extends</span> <span class="title">BeanUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 集合数据的拷贝</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sources: 数据源类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target: 目标类::new(eg: UserVO::new)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S, T&gt; <span class="function">List&lt;T&gt; <span class="title">copyListProperties</span><span class="params">(List&lt;S&gt; sources, Supplier&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> copyListProperties(sources, target, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 带回调函数的集合数据的拷贝（可自定义字段拷贝规则）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sources: 数据源类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target: 目标类::new(eg: UserVO::new)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callBack: 回调函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S, T&gt; <span class="function">List&lt;T&gt; <span class="title">copyListProperties</span><span class="params">(List&lt;S&gt; sources, Supplier&lt;T&gt; target, BeanCopyUtilCallBack&lt;S, T&gt; callBack)</span> </span>&#123;</span><br><span class="line">        List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(sources.size());</span><br><span class="line">        <span class="keyword">for</span> (S source : sources) &#123;</span><br><span class="line">            T t = target.get();</span><br><span class="line">            copyProperties(source, t);</span><br><span class="line">            list.add(t);</span><br><span class="line">            <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 回调</span></span><br><span class="line">                callBack.callBack(source, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>简单拷贝测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">20</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = BeanCopyUtil.copyListProperties(userDOList, UserVO::<span class="keyword">new</span>);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVOList:[UserVO(userId=1, userName=Van, age=18, sex=null), UserVO(userId=2, userName=VanVan, age=20, sex=null)]</span><br></pre></td></tr></table></figure>

<p>通过如上方法，我们基本实现了集合的拷贝，但是从返回结果我们可以发现：<strong>属性不同的字段无法拷贝</strong>。所以，我们这里需要借助刚定义的回调方法实现自定义转换。</p>
<ul>
<li>性别枚举类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SexEnum &#123;</span><br><span class="line">    UNKNOW(<span class="string">"未设置"</span>,<span class="number">0</span>),</span><br><span class="line">    MEN(<span class="string">"男生"</span>, <span class="number">1</span>),</span><br><span class="line">    WOMAN(<span class="string">"女生"</span>,<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    SexEnum(String desc, <span class="keyword">int</span> code) &#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SexEnum <span class="title">getDescByCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        SexEnum[] typeEnums = values();</span><br><span class="line">        <span class="keyword">for</span> (SexEnum value : typeEnums) &#123;</span><br><span class="line">            <span class="keyword">if</span> (code == value.getCode()) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>带回调函数的拷贝</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyUpWithCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">20</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = BeanCopyUtil.copyListProperties(userDOList, UserVO::<span class="keyword">new</span>, (userDO, userVO) -&gt;&#123;</span><br><span class="line">        <span class="comment">// 这里可以定义特定的转换规则</span></span><br><span class="line">        userVO.setSex(SexEnum.getDescByCode(userDO.getSex()).getDesc());</span><br><span class="line">    &#125;);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">... userVOList:[UserVO(userId=1, userName=Van, age=18, sex=男生), UserVO(userId=2, userName=VanVan, age=20, sex=女生)]</span><br></pre></td></tr></table></figure>

<p>通过打印结果可以发现，<code>UserDO.java</code> 中<code>Integer</code>类型的<code>sex</code>复制到<code>UserVO.java</code>成了<code>String</code>类型的男生/女生。</p>
<h2 id="四、技术交流"><a href="#四、技术交流" class="headerlink" title="四、技术交流"></a>四、技术交流</h2><p><a href="https://github.com/vanDusty/Spring-Home/tree/master/spring-case/bean-copy" target="_blank" rel="noopener">Github 源码</a></p>
]]></content>
      <categories>
        <category>BeanCopy</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>BeanCopy</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 函数式编程之 Lambda</title>
    <url>/2020/01/03/985b9754.html</url>
    <content><![CDATA[<p><code>Java</code>是一门强大的面向对象的语言，除了<code>8</code>种基本的数据类型，其他一切皆为对象。因此，在<code>Java</code>中定义函数或方法都离不开对象，也就意味着很难直接将方法或函数像参数一样传递，而<code>Java8</code>中的<code>Lambda</code>表达式解决了这个问题。</p>
<a id="more"></a>

<h2 id="一、为什么需要Lambda？"><a href="#一、为什么需要Lambda？" class="headerlink" title="一、为什么需要Lambda？"></a>一、为什么需要<code>Lambda</code>？</h2><p>简单的来说，引入<code>Lambda</code>就是为了简化代码，允许把函数作为一个方法的参数传递进方法中。</p>
<h3 id="1-1-真的简化了？"><a href="#1-1-真的简化了？" class="headerlink" title="1.1 真的简化了？"></a>1.1 真的简化了？</h3><blockquote>
<p>示例：如果想把某个接口的实现类作为参数传递给一个方法会怎么做？</p>
</blockquote>
<ul>
<li><code>JDK 8</code>以前</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">general</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 用匿名内部类的方式来创建线程</span></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"公众号：风尘博客！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Lambda</code> 写法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lambda</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 使用Lambda来创建线程</span></span><br><span class="line">    <span class="keyword">new</span> Thread(() -&gt; System.out.println(<span class="string">"公众号：风尘博客！"</span>)).run();</span><br><span class="line">&#125;</span><br><span class="line">```    </span><br><span class="line">### 1.2 `Lambda`表达式是什么？</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">`Java`中，**将方法作为参数进行传递的方式被称为`Lambda`表达式**。</span><br><span class="line"></span><br><span class="line">### 1.3 `Lambda` 表达式语法结构 </span><br><span class="line"></span><br><span class="line">`Lambda`其实是一个箭头函数，也可称为匿名函数:`-&gt;`</span><br><span class="line"></span><br><span class="line">箭头操作符将`Lambda`表达式分成了两部分：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 左侧：`Lambda`表达式的参数列表(接口中抽象方法的参数列表)</span><br><span class="line"><span class="number">1</span>. 右侧：`Lambda`表达式中所需执行的功能(`Lambda`体，对抽象方法的实现)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 1.4 语法格式</span><br><span class="line"></span><br><span class="line">- 无参，无返回值，`Lambda` 体只需一条语句。</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noParam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Runnable r1 = () -&gt; logger.info(<span class="string">"noParam Test!"</span>);</span><br><span class="line">    r1.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Lambda</code> 需要一个参数，参数的小括号可以省略。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">oneParam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Consumer&lt;String&gt; con = (s) -&gt; logger.info(s);</span></span><br><span class="line">    <span class="comment">// 参数的小括号可以省略。</span></span><br><span class="line">    Consumer&lt;String&gt; con = s -&gt; logger.info(s);</span><br><span class="line">    con.accept(<span class="string">"oneParam Test!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li><code>Lambda</code> 需要多个参数，并且有返回值。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">params</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Comparator&lt;Integer&gt; com = (x, y) -&gt; &#123;</span><br><span class="line">        logger.info(<span class="string">"params Test!"</span>);</span><br><span class="line">        <span class="comment">// 比较x/y的大小</span></span><br><span class="line">        <span class="keyword">return</span> Integer.compare(x, y);</span><br><span class="line">    &#125;;</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, com.compare(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>当 <code>Lambda</code> 体只有一条语句时，<code>return</code> 与大括号可以省略。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">one</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Comparator&lt;Integer&gt; com = (x, y) -&gt; Integer.compare(x, y);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, com.compare(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">&gt; 上面几条示例好像有一个共性：参数列表的数据类型都没写，这是为什么呢？</span><br><span class="line"></span><br><span class="line">### 1.5 类型推断</span><br><span class="line"></span><br><span class="line">`Lambda` 表达式中的参数类型都是由编译器推断得出的。</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">typeInference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Integer 类型可以省略</span></span><br><span class="line">    Comparator&lt;Integer&gt; com = (Integer x, Integer y) -&gt; &#123;</span><br><span class="line">        logger.info(<span class="string">"函数式接口"</span>);</span><br><span class="line">        <span class="keyword">return</span> Integer.compare(x, y);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 类型推断</span></span><br><span class="line">    BinaryOperator&lt;Long&gt; addImplicit = (x, y) -&gt; x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Lambda</code> 表达式中无需指定类型，程序依然可 以编译，这是因为 <code>javac</code>根据程序的上下文，在后台 推断出了参数的类型。<code>Lambda</code> 表达式的类型依赖于上下文环境，是由编译器推断出来的。</p>
<h3 id="1-6-小节"><a href="#1-6-小节" class="headerlink" title="1.6 小节"></a>1.6 小节</h3><p><code>Lambda</code>表达式使得<code>Java</code>拥有了函数式编程的能力，但在<code>Java</code>中<code>Lambda</code>表达式是对象，它必须依附于一类特别的对象类型——函数式接口(<code>functional interface</code>)。</p>
<h2 id="二、函数式接口"><a href="#二、函数式接口" class="headerlink" title="二、函数式接口"></a>二、函数式接口</h2><p>函数接口是只有一个抽象方法的接口，用作 <code>Lambda</code> 表达式的类型。使用<code>@FunctionalInterface</code>注解修饰的类，编译器会检测该类是否只有一个抽象方法或接口，否则，会报错。可以有多个默认方法，静态方法。</p>
<p><code>JDK8</code>在 <code>java.util.function</code> 中定义了几个标准的函数式接口，供我们使用。</p>
<h3 id="2-1-Java-内置四大核心函数式接口"><a href="#2-1-Java-内置四大核心函数式接口" class="headerlink" title="2.1 Java 内置四大核心函数式接口"></a>2.1 <code>Java</code> 内置四大核心函数式接口</h3><table>
<thead>
<tr>
<th>函数式接口</th>
<th>参数类型</th>
<th>返回类型</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>Consumer&lt;T&gt;</td>
<td>T</td>
<td>void</td>
<td>对类型为T的对象应用操作，包含方法：void accept(T t)</td>
</tr>
<tr>
<td>Supplier&lt;T&gt;</td>
<td>无</td>
<td>T</td>
<td>返回类型为T的对象，包 含方法：T get();</td>
</tr>
<tr>
<td>Function&lt;T,R&gt;</td>
<td>T</td>
<td>R</td>
<td>对类型为T的对象应用操作，并返回结果。结果是R类型的对象。包含方法：R apply(T t);</td>
</tr>
<tr>
<td>Predicate&lt;T&gt;</td>
<td>T</td>
<td>boolean</td>
<td>确定类型为T的对象是否满足某约束，并返回 boolean 值。包含方法 boolean test(T t);</td>
</tr>
</tbody></table>
<ul>
<li>消费型接口</li>
</ul>
<p><code>void accept(T t);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumerDemo</span><span class="params">(Integer value, Consumer&lt;Integer&gt; consumer)</span> </span>&#123;</span><br><span class="line">    consumer.accept(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>供给型接口</li>
</ul>
<p><code>T get();</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">supplierDemo</span><span class="params">(<span class="keyword">int</span> num, Supplier&lt;Integer&gt; supplier)</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">        Integer n = supplier.get();</span><br><span class="line">        list.add(n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>函数型接口</li>
</ul>
<p><code>R apply(T t);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">functionDemo</span><span class="params">(String str, Function&lt;String, String&gt; function)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> function.apply(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断言型接口</li>
</ul>
<p><code>boolean test(T t);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">predicateDemo</span><span class="params">(List&lt;String&gt; list, Predicate&lt;String&gt; predicate)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; newList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String s : list) &#123;</span><br><span class="line">        <span class="keyword">if</span> (predicate.test(s)) &#123;</span><br><span class="line">            newList.add(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-自定义函数式接口"><a href="#2-2-自定义函数式接口" class="headerlink" title="2.2 自定义函数式接口"></a>2.2 自定义函数式接口</h3><p>我们可以在任意函数式接口上使用 <code>@FunctionalInterface</code> 注解， 这样做可以检查它是否是一个函数式接口，同时 <code>javadoc</code> 也会包含一条声明，说明这个接口是一个函数式接口。</p>
<ul>
<li><code>SelfFunctionalInterface.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SelfFunctionalInterface</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">getValue</span><span class="params">(T t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义函数式接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">selfFunctionalInterface</span><span class="params">(SelfFunctionalInterface&lt;String&gt; selfFunctionalInterface, String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> selfFunctionalInterface.getValue(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-函数接口测试"><a href="#2-3-函数接口测试" class="headerlink" title="2.3 函数接口测试"></a>2.3 函数接口测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">functionDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 修改参数</span></span><br><span class="line">    consumerDemo(<span class="number">3</span>, s -&gt; logger.info(<span class="string">"result:[&#123;&#125;]"</span>,s * <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成10个以内的随机数</span></span><br><span class="line">    List&lt;Integer&gt; numList = supplierDemo(<span class="number">10</span>, () -&gt; (<span class="keyword">int</span>)(<span class="number">100</span> * Math.random()));</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,numList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理字符串</span></span><br><span class="line">    String str1 = functionDemo(<span class="string">"Hello!风尘博客"</span>, s -&gt; s.substring(<span class="number">6</span>));</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,str1);</span><br><span class="line">    String str2 = functionDemo(<span class="string">"vanDusty"</span>, s -&gt; s.toUpperCase());</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,str2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将满足条件的字符串放入集合</span></span><br><span class="line">    List&lt;String&gt; list = Arrays.asList(<span class="string">"hello"</span>, <span class="string">"van"</span>, <span class="string">"function"</span>, <span class="string">"predicate"</span>);</span><br><span class="line">    List&lt;String&gt; newList = predicateDemo(list, s -&gt; s.length() &gt; <span class="number">5</span>);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,newList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 字符串转大写</span></span><br><span class="line">    String newStr = selfFunctionalInterface((str) -&gt; str.toUpperCase(), <span class="string">"abc"</span>);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,newStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、方法引用和构造器引用"><a href="#三、方法引用和构造器引用" class="headerlink" title="三、方法引用和构造器引用"></a>三、方法引用和构造器引用</h2><h3 id="3-1-方法引用"><a href="#3-1-方法引用" class="headerlink" title="3.1 方法引用"></a>3.1 方法引用</h3><p>方法引用是指通过方法的名字来指向一个方法。</p>
<h4 id="3-1-1-方法引用使用的前提条件是什么呢？"><a href="#3-1-1-方法引用使用的前提条件是什么呢？" class="headerlink" title="3.1.1 方法引用使用的前提条件是什么呢？"></a>3.1.1 方法引用使用的前提条件是什么呢？</h4><ol>
<li>方法引用所引用的方法的参数列表必须要和函数式接口中抽象方法的参数列表相同（完全一致）；</li>
<li>方法引用所引用的方法的的返回值必须要和函数式接口中抽象方法的返回值相同（完全一致）。</li>
</ol>
<h4 id="3-1-2-方法引用三种格式"><a href="#3-1-2-方法引用三种格式" class="headerlink" title="3.1.2 方法引用三种格式"></a>3.1.2 方法引用三种格式</h4><ul>
<li>实例对象名::实例方法名</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">instanceMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserDomain user = <span class="keyword">new</span> UserDomain(<span class="number">1L</span>, <span class="string">"Van"</span>);</span><br><span class="line"></span><br><span class="line">    Supplier&lt;String&gt; sup = () -&gt; user.getUserName();</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,sup.get());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等价于</span></span><br><span class="line">    Supplier&lt;String&gt; supplier = user::getUserName;</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,supplier.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>类名::静态方法名</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">staticMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Comparator&lt;Integer&gt; com = (x, y) -&gt; Integer.compare(x, y);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,com.compare(<span class="number">3</span>, <span class="number">9</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等价于</span></span><br><span class="line">    Comparator&lt;Integer&gt; com2 = Integer::compare;</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,com2.compare(<span class="number">3</span>, <span class="number">9</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>类名::实例方法名</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">instanceMethodObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserDomain user = <span class="keyword">new</span> UserDomain(<span class="number">1L</span>, <span class="string">"Van"</span>);</span><br><span class="line"></span><br><span class="line">    Function&lt;UserDomain, String&gt; fun = (e) -&gt; e.getUserName();</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,fun.apply(user));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等价于</span></span><br><span class="line">    Function&lt;UserDomain, String&gt; fun2 = UserDomain::getUserName;</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>,fun2.apply(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-构造器引用"><a href="#3-2-构造器引用" class="headerlink" title="3.2 构造器引用"></a>3.2 构造器引用</h3><ol>
<li>前提：构造器参数列表要与接口中抽象方法的参数列表一致！</li>
<li>语法格式：<code>类名 :: new</code></li>
</ol>
<ul>
<li>构造器引用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">object</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// UserDomain 中必须有一个 UserDomain(String userName) 的构造器,下同</span></span><br><span class="line">    Function&lt;String, UserDomain&gt; fun = (n) -&gt; <span class="keyword">new</span> UserDomain(n);</span><br><span class="line">    fun.apply(<span class="string">"Van"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等价于</span></span><br><span class="line">    Function&lt;String, UserDomain&gt; function = UserDomain::<span class="keyword">new</span>;</span><br><span class="line">    function.apply(<span class="string">"Van"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 带两个参数的构造器引用就要用BiFunction，多个参数的话，还可以自定义一个这样的函数式接口</span></span><br><span class="line">    BiConsumer&lt;Long, String&gt; biConsumer = UserDomain::<span class="keyword">new</span>;</span><br><span class="line">    biConsumer.accept(<span class="number">1L</span>, <span class="string">"Van"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数组引用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">array</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//传统Lambda实现</span></span><br><span class="line">    Function&lt;Integer, <span class="keyword">int</span>[]&gt; function = (i) -&gt; <span class="keyword">new</span> <span class="keyword">int</span>[i];</span><br><span class="line">    <span class="keyword">int</span>[] apply = function.apply(<span class="number">10</span>);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, apply.length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数组类型引用实现</span></span><br><span class="line">    function = <span class="keyword">int</span>[]::<span class="keyword">new</span>;</span><br><span class="line">    apply = function.apply(<span class="number">100</span>);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, apply.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、-总结"><a href="#四、-总结" class="headerlink" title="四、 总结"></a>四、 总结</h2><p><a href="https://github.com/vanDusty/JDK/tree/master/JDK-Lambda/src/test/java/cn/van/jdk/lambda" target="_blank" rel="noopener">Github 示例代码</a></p>
<p><code>Lambda</code>表达式是<code>Java</code>对于函数式编程的温和转变，面向对象编程和函数式编程不是互相对立的，结合使用能够更加有效地帮助我们管理程序的复杂性。</p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>Lambda</tag>
        <tag>语法</tag>
      </tags>
  </entry>
  <entry>
    <title>彻底消灭if-else嵌套</title>
    <url>/2020/01/01/7b2533d5.html</url>
    <content><![CDATA[<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><h3 id="1-1-反面教材"><a href="#1-1-反面教材" class="headerlink" title="1.1 反面教材"></a>1.1 反面教材</h3><p>不知大家有没遇到过像<strong>横放着的金字塔</strong>一样的<code>if-else</code>嵌套：</p>
<a id="more"></a>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                        </span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>if-else</code>作为每种编程语言都不可或缺的条件语句，我们在编程时会大量的用到。</p>
<p>但<code>if-else</code>一般不建议嵌套超过三层，如果一段代码存在过多的<code>if-else</code>嵌套，代码的可读性就会急速下降，后期维护难度也大大提高。</p>
<h3 id="2-2-亲历的重构"><a href="#2-2-亲历的重构" class="headerlink" title="2.2 亲历的重构"></a>2.2 亲历的重构</h3><p>前阵子重构了<strong>服务费收费规则</strong>，重构前的<code>if-else</code>嵌套如下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Double <span class="title">commonMethod</span><span class="params">(Integer type, Double amount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">3</span> == type) &#123;</span><br><span class="line">        <span class="comment">// 计算费用</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 此处省略200行代码，包含n个if-else，下同。。。</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.00</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">2</span> == type) &#123;</span><br><span class="line">        <span class="comment">// 计算费用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">6.66</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">1</span> == type) &#123;</span><br><span class="line">        <span class="comment">// 计算费用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">8.88</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == type)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9.99</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"please input right value"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们都写过类似的代码，回想起被 <code>if-else</code> 支配的恐惧，如果有新需求：新增计费规则或者修改既定计费规则，无所下手。</p>
<h3 id="2-3-追根溯源"><a href="#2-3-追根溯源" class="headerlink" title="2.3 追根溯源"></a>2.3 追根溯源</h3><ul>
<li>我们来分析下代码多分支的原因</li>
</ul>
<ol>
<li>业务判断</li>
<li>空值判断</li>
<li>状态判断</li>
</ol>
<ul>
<li>如何处理呢？</li>
</ul>
<ol>
<li>在有多种算法相似的情况下，利用策略模式，把业务判断消除，各子类实现同一个接口，只关注自己的实现（<strong>本文核心</strong>）；</li>
<li>尽量把所有空值判断放在外部完成，内部传入的变量由外部接口保证不为空，从而减少空值判断(可参考<a href="https://juejin.im/post/5d79201c6fb9a06b084d216d" target="_blank" rel="noopener">如何从 if-else 的参数校验中解放出来？</a>)；</li>
<li>把分支状态信息预先缓存在<code>Map</code>里，直接<code>get</code>获取具体值，消除分支（本文也有体现）。</li>
</ol>
<ul>
<li>来看看简化后的业务调用</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CalculationUtil.getFee(type, amount)</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">serviceFeeHolder.getFee(type, amount)</span><br></pre></td></tr></table></figure>

<p>是不是超级简单，下面介绍两种实现方式（文末附示例代码）。</p>
<h2 id="二、通用部分"><a href="#二、通用部分" class="headerlink" title="二、通用部分"></a>二、通用部分</h2><h3 id="2-1-需求概括"><a href="#2-1-需求概括" class="headerlink" title="2.1 需求概括"></a>2.1 需求概括</h3><p>我们拥有很多公司会员，暂且分为普通会员、初级会员、中级会员和高级会员，会员级别不同计费规则不同。该模块负责计算会员所需的缴纳的服务费。</p>
<h3 id="2-2-会员枚举"><a href="#2-2-会员枚举" class="headerlink" title="2.2 会员枚举"></a>2.2 会员枚举</h3><blockquote>
<p>用于维护会员类型。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> MemberEnum &#123;</span><br><span class="line"></span><br><span class="line">    ORDINARY_MEMBER(<span class="number">0</span>, <span class="string">"普通会员"</span>),</span><br><span class="line">    JUNIOR_MEMBER(<span class="number">1</span>, <span class="string">"初级会员"</span>),</span><br><span class="line">    INTERMEDIATE_MEMBER(<span class="number">2</span>, <span class="string">"中级会员"</span>),</span><br><span class="line">    SENIOR_MEMBER(<span class="number">3</span>, <span class="string">"高级会员"</span>),</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> code;</span><br><span class="line">    String desc;</span><br><span class="line"></span><br><span class="line">    MemberEnum(<span class="keyword">int</span> code, String desc) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-定义一个策略接口"><a href="#2-3-定义一个策略接口" class="headerlink" title="2.3 定义一个策略接口"></a>2.3 定义一个策略接口</h3><p>该接口包含两个方法：</p>
<ol>
<li><code>compute(Double amount)</code>：各计费规则的抽象</li>
<li><code>getType()</code>：获取枚举中维护的会员级别</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计费规则</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Double <span class="title">compute</span><span class="params">(Double amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取会员级别</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Integer <span class="title">getType</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、非框架实现"><a href="#三、非框架实现" class="headerlink" title="三、非框架实现"></a>三、非框架实现</h2><h3 id="3-1-项目依赖"><a href="#3-1-项目依赖" class="headerlink" title="3.1 项目依赖"></a>3.1 项目依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-不同计费规则的实现"><a href="#3-2-不同计费规则的实现" class="headerlink" title="3.2 不同计费规则的实现"></a>3.2 不同计费规则的实现</h3><p>这里四个子类实现了策略接口，其中 <code>compute()</code>方法实现各个级别会员的计费逻辑，<code>getType()</code>指定了该类所属的会员级别。</p>
<ul>
<li>普通会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrdinaryMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算普通会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">9.99</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.ORDINARY_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>初级会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JuniorMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算初级会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">8.88</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.JUNIOR_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>中级会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntermediateMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算中级会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">6.66</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.INTERMEDIATE_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>高级会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeniorMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算高级会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.01</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.SENIOR_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-核心工厂"><a href="#3-3-核心工厂" class="headerlink" title="3.3 核心工厂"></a>3.3 核心工厂</h3><p>创建一个工厂类<code>ServiceFeeFactory.java</code>，该工厂类管理所有的策略接口实现类。具体见代码注释。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFeeFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, FeeService&gt; map;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceFeeFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 该工厂管理所有的策略接口实现类</span></span><br><span class="line">        List&lt;FeeService&gt; feeServices = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        feeServices.add(<span class="keyword">new</span> OrdinaryMember());</span><br><span class="line">        feeServices.add(<span class="keyword">new</span> JuniorMember());</span><br><span class="line">        feeServices.add(<span class="keyword">new</span> IntermediateMember());</span><br><span class="line">        feeServices.add(<span class="keyword">new</span> SeniorMember());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把所有策略实现的集合List转为Map</span></span><br><span class="line">        map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (FeeService feeService : feeServices) &#123;</span><br><span class="line">            map.put(feeService.getType(), feeService);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 静态内部类单例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Holder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ServiceFeeFactory instance = <span class="keyword">new</span> ServiceFeeFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在构造方法的时候，初始化好 需要的 ServiceFeeFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServiceFeeFactory <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据会员的级别type 从map获取相应的策略实现类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FeeService <span class="title">get</span><span class="params">(Integer type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-工具类"><a href="#3-4-工具类" class="headerlink" title="3.4 工具类"></a>3.4 工具类</h3><p>新建通过一个工具类管理计费规则的调用，并对不符合规则的公司级别输入抛<code>IllegalArgumentException</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculationUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 暴露给用户的的计算方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 会员级别标示（参见 MemberEnum）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 当前交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 该级别会员所需缴纳的费用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException 会员级别输入错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Double <span class="title">getFee</span><span class="params">(<span class="keyword">int</span> type, Double money)</span> </span>&#123;</span><br><span class="line">        FeeService strategy = ServiceFeeFactory.getInstance().get(type);</span><br><span class="line">        <span class="keyword">if</span> (strategy == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"please input right value"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> strategy.compute(money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心是<strong>通过<code>Map</code>的<code>get()</code>方法，根据传入 <code>type</code>，即可获取到对应会员类型计费规则的实现，从而减少了<code>if-else</code>的业务判断。</strong></p>
<h3 id="3-5-测试"><a href="#3-5-测试" class="headerlink" title="3.5 测试"></a>3.5 测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Double fees = upMethod(<span class="number">1</span>,<span class="number">20000.00</span>);</span><br><span class="line">        System.out.println(fees);</span><br><span class="line">        <span class="comment">// 会员级别超范围，抛 IllegalArgumentException</span></span><br><span class="line">        Double feee = upMethod(<span class="number">5</span>, <span class="number">20000.00</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">upMethod</span><span class="params">(Integer type, Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// getFee（）是暴露给用户的的计算方法</span></span><br><span class="line">        <span class="keyword">return</span> CalculationUtil.getFee(type, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">8.88</span><br><span class="line">java.lang.IllegalArgumentException: please input right value</span><br></pre></td></tr></table></figure>

<h2 id="四、Spring-Boot-实现"><a href="#四、Spring-Boot-实现" class="headerlink" title="四、Spring Boot 实现"></a>四、<code>Spring Boot</code> 实现</h2><blockquote>
<p>上述方法无非是借助策略模式+工厂模式+单例模式实现，但是实际场景中，我们都已经集成了<code>Spring Boot</code>，这一段就看一下如何借助<code>Spring Boot</code>更简单实现本次的优化。</p>
</blockquote>
<h3 id="4-1-项目依赖"><a href="#4-1-项目依赖" class="headerlink" title="4.1 项目依赖"></a>4.1 项目依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-不同计费规则的实现"><a href="#4-2-不同计费规则的实现" class="headerlink" title="4.2 不同计费规则的实现"></a>4.2 不同计费规则的实现</h3><p>这部分是与上面区别在于：<strong>把策略的实现类得是交给Spring 容器管理</strong></p>
<ul>
<li>普通会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrdinaryMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算普通会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">9.99</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.ORDINARY_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>初级会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JuniorMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算初级会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">8.88</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.JUNIOR_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>中级会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntermediateMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算中级会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">6.66</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.INTERMEDIATE_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>高级会员计费规则</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeniorMember</span> <span class="keyword">implements</span> <span class="title">FeeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算高级会员所需缴费的金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 会员的交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">compute</span><span class="params">(Double amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 具体的实现根据业务需求修改</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.01</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MemberEnum.SENIOR_MEMBER.getCode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-别名转换"><a href="#4-3-别名转换" class="headerlink" title="4.3 别名转换"></a>4.3 别名转换</h3><blockquote>
<p>思考：程序如何通过一个标识，怎么识别解析这个标识，找到对应的策略实现类？</p>
</blockquote>
<p>我的方案是：在配置文件中制定，便于维护。</p>
<ul>
<li><code>application.yml</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">alias:</span><br><span class="line">  aliasMap:</span><br><span class="line">    first: ordinaryMember</span><br><span class="line">    second: juniorMember</span><br><span class="line">    third: intermediateMember</span><br><span class="line">    fourth: seniorMember</span><br></pre></td></tr></table></figure>

<ul>
<li><code>AliasEntity.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"alias"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliasEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, String&gt; aliasMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap&lt;String, String&gt; <span class="title">getAliasMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAliasMap</span><span class="params">(HashMap&lt;String, String&gt; aliasMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.aliasMap = aliasMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据描述获取该会员对应的别名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEntity</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> aliasMap.get(desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该类为了便于读取配置，因为存入的是<code>Map</code>的<code>key-value</code>值，<code>key</code>存的是描述，<code>value</code>是各级别会员<code>Bean</code>的别名。</p>
</blockquote>
<h3 id="4-4-策略工厂"><a href="#4-4-策略工厂" class="headerlink" title="4.4 策略工厂"></a>4.4 策略工厂</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceFeeHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将 Spring 中所有实现 ServiceFee 的接口类注入到这个Map中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, FeeService&gt; serviceFeeMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AliasEntity aliasEntity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取该会员应当缴纳的费用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc 会员标志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money 交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException 会员级别输入错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">getFee</span><span class="params">(String desc, Double money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getBean(desc).compute(money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取会员标志（枚举中的数字）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desc 会员标志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException 会员级别输入错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getBean(desc).getType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> FeeService <span class="title">getBean</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据配置中的别名获取该策略的实现类</span></span><br><span class="line">        FeeService entStrategy = serviceFeeMap.get(aliasEntity.getEntity(type));</span><br><span class="line">        <span class="keyword">if</span> (entStrategy == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 找不到对应的策略的实现类，抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"please input right value"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entStrategy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>亮点</strong>：</p>
<ol>
<li>将 <code>Spring</code>中所有 <code>ServiceFee.java</code> 的实现类注入到<code>Map</code>中，不同策略通过其不同的<code>key</code>获取其实现类；</li>
<li>找不到对应的策略的实现类，抛出<code>IllegalArgumentException</code>异常。</li>
</ol>
<h3 id="4-5-测试"><a href="#4-5-测试" class="headerlink" title="4.5 测试"></a>4.5 测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">DemoTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ServiceFeeHolder serviceFeeHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 计算应缴纳费用</span></span><br><span class="line">        System.out.println(serviceFeeHolder.getFee(<span class="string">"second"</span>, <span class="number">1.333</span>));</span><br><span class="line">        <span class="comment">// 获取会员标志</span></span><br><span class="line">        System.out.println(serviceFeeHolder.getType(<span class="string">"second"</span>));</span><br><span class="line">        <span class="comment">// 会员描述错误，抛 IllegalArgumentException</span></span><br><span class="line">        System.out.println(serviceFeeHolder.getType(<span class="string">"zero"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">8.88</span><br><span class="line">1</span><br><span class="line">java.lang.IllegalArgumentException: please input right value</span><br></pre></td></tr></table></figure>

<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>两种方案主要参考了设计模式中的<strong>策略模式</strong>，因为策略模式刚好符合本场景：</p>
<ol>
<li>系统中有很多类，而他们的区别仅仅在于他们的行为不同。</li>
<li>一个系统需要动态地在几种算法中选择一种。</li>
</ol>
<h3 id="5-1-策略模式角色"><a href="#5-1-策略模式角色" class="headerlink" title="5.1 策略模式角色"></a>5.1 策略模式角色</h3><p><img src="https://user-gold-cdn.xitu.io/2020/2/28/170878d0ec4647c0?w=764&h=329&f=jpeg&s=27512" alt="风尘博客"></p>
<ul>
<li><code>Context</code>: 环境类</li>
</ul>
<blockquote>
<p><code>Context</code>叫做上下文角色，起承上启下封装作用，屏蔽高层模块对策略、算法的直接访问，封装可能存在的变化，对应本文的<code>ServiceFeeFactory.java</code>。</p>
</blockquote>
<ul>
<li><code>Strategy</code>: 抽象策略类</li>
</ul>
<blockquote>
<p>定义算法的接口，对应本文的<code>FeeService.java</code>。</p>
</blockquote>
<ul>
<li><code>ConcreteStrategy</code>: 具体策略类</li>
</ul>
<blockquote>
<p>实现具体策略的接口，对应本文的<code>OrdinaryMember.java</code>/<code>JuniorMember.java</code>/<code>IntermediateMember.java</code>/<code>SeniorMember.java</code>。</p>
</blockquote>
<h3 id="5-2-示例代码及参考文章"><a href="#5-2-示例代码及参考文章" class="headerlink" title="5.2 示例代码及参考文章"></a>5.2 示例代码及参考文章</h3><ol>
<li><a href="https://github.com/vanDusty/Design-Patterns/tree/master/strategy-factory-single-demo" target="_blank" rel="noopener">非框架版</a></li>
<li><a href="https://github.com/vanDusty/Design-Patterns/tree/master/strategy-spring" target="_blank" rel="noopener">Spring Boot 框架版</a></li>
<li><a href="https://juejin.im/post/5d79201c6fb9a06b084d216d" target="_blank" rel="noopener">如何从 if-else 的参数校验中解放出来？</a></li>
</ol>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>if else</tag>
        <tag>工厂模式</tag>
        <tag>策略模式</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 时间日期API之 LocalDate</title>
    <url>/2019/12/23/d1d764a8.html</url>
    <content><![CDATA[<p><code>JDK 1.8</code> 已经出来好多年了，<code>LocalDate</code>、<code>LocalDateTime</code>、<code>LocalTime</code> 不比 <code>Date</code> 香吗？</p>
<a id="more"></a>

<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p><code>jdk 1.8</code> 之前， <code>Java</code> 时间使用<code>java.util.Date</code> 和 <code>java.util.Calendar</code> 类。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Date today = <span class="keyword">new</span> Date();</span><br><span class="line">System.out.println(today);</span><br><span class="line">	</span><br><span class="line"> <span class="comment">// 转为字符串</span></span><br><span class="line">SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">String todayStr = sdf.format(today);</span><br><span class="line">System.out.println(todayStr);</span><br></pre></td></tr></table></figure>

<p><code>Date</code> 的几个问题：</p>
<ol>
<li>如果不格式化，<code>Date</code>打印出的日期可读性差；</li>
<li>可以使用 <code>SimpleDateFormat</code> 对时间进行格式化，但 <code>SimpleDateFormat</code> 是线程不安全的（阿里巴巴开发手册中禁用<code>static</code>修饰<code>SimpleDateFormat</code>）；</li>
<li><code>Date</code>对时间处理比较麻烦，比如想获取某年、某月、某星期，以及 <code>n</code> 天以后的时间，如果用<code>Date</code>来处理的话真是太难了，并且 <code>Date</code> 类的 <code>getYear()</code>、<code>getMonth()</code> 这些方法都被弃用了；</li>
</ol>
<h2 id="二、JDK-1-8-新的日期时间类型"><a href="#二、JDK-1-8-新的日期时间类型" class="headerlink" title="二、JDK 1.8 新的日期时间类型"></a>二、<code>JDK 1.8</code> 新的日期时间类型</h2><blockquote>
<p><code>Java8</code>引入的新的一系列<code>API</code>，对时间日期的处理提供了更好的支持，清楚的定义了时间日期的一些概念，比如说，瞬时时间（<code>Instant</code>）,持续时间（<code>duration</code>），日期（<code>date</code>），时间（<code>time</code>），时区（<code>time-zone</code>）以及时间段（<code>Period</code>）。</p>
</blockquote>
<ol>
<li><code>LocalDate</code>：不包含时间的日期，比如<code>2019-10-14</code>。可以用来存储生日，周年纪念日，入职日期等。</li>
<li><code>LocalTime</code>：与<code>LocalDate</code>想对照，它是不包含日期的时间。</li>
<li><code>LocalDateTime</code>：包含了日期及时间，没有偏移信息（时区）。</li>
<li><code>ZonedDateTime</code>：包含时区的完整的日期时间，偏移量是以<code>UTC</code>/格林威治时间为基准的。</li>
<li><code>Instant</code>：时间戳，与<code>System.currentTimeMillis()</code>类似。</li>
<li><code>Duration</code>：表示一个时间段。</li>
<li><code>Period</code>：用来表示以年月日来衡量一个时间段。</li>
<li><code>DateTimeFormatter</code>：新的日期解析格式化类。</li>
</ol>
<h3 id="2-1-LocalDate"><a href="#2-1-LocalDate" class="headerlink" title="2.1 LocalDate"></a>2.1 <code>LocalDate</code></h3><p><code>LocalDate</code>类内只包含日期，不包含具体时间。只需要表示日期而不包含时间，就可以使用它。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">localDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前年月日</span></span><br><span class="line">    LocalDate today = LocalDate.now();</span><br><span class="line">    logger.info(<span class="string">"当前年月日：[&#123;&#125;]"</span>,today);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取年的两种方式</span></span><br><span class="line">    <span class="keyword">int</span> thisYear = today.getYear();</span><br><span class="line">    <span class="keyword">int</span> thisYearAnother = today.get(ChronoField.YEAR);</span><br><span class="line">    logger.info(<span class="string">"今年是：[&#123;&#125;]年"</span>,thisYear);</span><br><span class="line">    logger.info(<span class="string">"今年是：[&#123;&#125;]年"</span>,thisYearAnother);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取月</span></span><br><span class="line">    Month thisMonth = today.getMonth();</span><br><span class="line">    logger.info(<span class="string">"这个月是：[&#123;&#125;]月"</span>,thisMonth.toString());</span><br><span class="line">    <span class="comment">// 这是今年的第几个月(两种写法)</span></span><br><span class="line">    <span class="keyword">int</span> monthOfYear = today.getMonthValue();</span><br><span class="line">    <span class="comment">// int monthOfYear = today.get(ChronoField.MONTH_OF_YEAR);</span></span><br><span class="line">    logger.info(<span class="string">"这个月是今年的第[&#123;&#125;]个月"</span>,monthOfYear);</span><br><span class="line">    <span class="comment">// 月份的天数</span></span><br><span class="line">    <span class="keyword">int</span> length = today.lengthOfMonth();</span><br><span class="line">    logger.info(<span class="string">"这个月有[&#123;&#125;]天"</span>,length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取日的两种方式</span></span><br><span class="line">    <span class="keyword">int</span> thisDay = today.getDayOfMonth();</span><br><span class="line">    <span class="keyword">int</span> thisDayAnother = today.get(ChronoField.DAY_OF_MONTH);</span><br><span class="line">    logger.info(<span class="string">"今天是这个月的第[&#123;&#125;]天"</span>,thisDay);</span><br><span class="line">    logger.info(<span class="string">"今天是这个月的第[&#123;&#125;]天"</span>,thisDayAnother);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取星期</span></span><br><span class="line">    DayOfWeek thisDayOfWeek = today.getDayOfWeek();</span><br><span class="line">    logger.info(<span class="string">"今天是[&#123;&#125;]"</span>,thisDayOfWeek.toString());</span><br><span class="line">    <span class="comment">// 今天是这周的第几天</span></span><br><span class="line">    <span class="keyword">int</span> dayOfWeek = today.get(ChronoField.DAY_OF_WEEK);</span><br><span class="line">    logger.info(<span class="string">"今天是这周的第[&#123;&#125;]天"</span>,dayOfWeek);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否为闰年</span></span><br><span class="line">    <span class="keyword">boolean</span> leapYear = today.isLeapYear();</span><br><span class="line">    logger.info(<span class="string">"今年是闰年：[&#123;&#125;]"</span>,leapYear);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造指定的年月日</span></span><br><span class="line">    LocalDate anotherDay = LocalDate.of(<span class="number">2008</span>, <span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line">    logger.info(<span class="string">"指定年月日：[&#123;&#125;]"</span>,anotherDay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-LocalTime"><a href="#2-2-LocalTime" class="headerlink" title="2.2 LocalTime"></a>2.2 <code>LocalTime</code></h3><p><code>LocalTime</code>只会获取时间，不获取日期。<code>LocalTime</code>和<code>LocalDate</code>类似，区别在于<code>LocalDate</code>不包含具体时间，而<code>LocalTime</code>不包含具体日期。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">localTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前时间</span></span><br><span class="line">    LocalTime nowTime = LocalTime.now();</span><br><span class="line">    logger.info(<span class="string">"当前时间：[&#123;&#125;]"</span>,nowTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取小时的两种方式</span></span><br><span class="line">    <span class="keyword">int</span> hour = nowTime.getHour();</span><br><span class="line">    <span class="keyword">int</span> thisHour = nowTime.get(ChronoField.HOUR_OF_DAY);</span><br><span class="line">    logger.info(<span class="string">"当前时：[&#123;&#125;]"</span>,hour);</span><br><span class="line">    logger.info(<span class="string">"当前时：[&#123;&#125;]"</span>,thisHour);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取分的两种方式</span></span><br><span class="line">    <span class="keyword">int</span> minute = nowTime.getMinute();</span><br><span class="line">    <span class="keyword">int</span> thisMinute = nowTime.get(ChronoField.MINUTE_OF_HOUR);</span><br><span class="line">    logger.info(<span class="string">"当前分：[&#123;&#125;]"</span>,minute);</span><br><span class="line">    logger.info(<span class="string">"当前分：[&#123;&#125;]"</span>,thisMinute);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取秒的两种方式</span></span><br><span class="line">    <span class="keyword">int</span> second = nowTime.getSecond();</span><br><span class="line">    <span class="keyword">int</span> thisSecond = nowTime.get(ChronoField.SECOND_OF_MINUTE);</span><br><span class="line">    logger.info(<span class="string">"当前秒：[&#123;&#125;]"</span>,second);</span><br><span class="line">    logger.info(<span class="string">"当前秒：[&#123;&#125;]"</span>,thisSecond);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造指定时间(最多可到纳秒)</span></span><br><span class="line">    LocalTime anotherTime = LocalTime.of(<span class="number">20</span>, <span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line">    logger.info(<span class="string">"构造指定时间：[&#123;&#125;]"</span>,anotherTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-LocalDateTime"><a href="#2-3-LocalDateTime" class="headerlink" title="2.3 LocalDateTime"></a>2.3 <code>LocalDateTime</code></h3><p><code>LocalDateTime</code>表示日期和时间组合。可以通过of()方法直接创建，也可以调用<code>LocalDate</code>的<code>atTime()</code>方法或<code>LocalTime</code>的<code>atDate()</code>方法将<code>LocalDate</code>或<code>LocalTime</code>合并成一个<code>LocalDateTime</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">localDateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前日期和时间</span></span><br><span class="line">    LocalDateTime today = LocalDateTime.now();</span><br><span class="line">    logger.info(<span class="string">"现在是：[&#123;&#125;]"</span>,today);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建指定日期和时间</span></span><br><span class="line">    LocalDateTime anotherDay = LocalDateTime.of(<span class="number">2008</span>, Month.AUGUST, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line">    logger.info(<span class="string">"创建的指定时间是：[&#123;&#125;]"</span>,anotherDay);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接日期和时间</span></span><br><span class="line">    <span class="comment">// 使用当前日期，指定时间生成的 LocalDateTime</span></span><br><span class="line">    LocalDateTime thisTime = LocalTime.now().atDate(LocalDate.of(<span class="number">2008</span>, <span class="number">8</span>, <span class="number">8</span>));</span><br><span class="line">    logger.info(<span class="string">"拼接的日期是：[&#123;&#125;]"</span>,thisTime);</span><br><span class="line">    <span class="comment">// 使用当前日期，指定时间生成的 LocalDateTime</span></span><br><span class="line">    LocalDateTime thisDay = LocalDate.now().atTime(LocalTime.of(<span class="number">12</span>, <span class="number">24</span>, <span class="number">12</span>));</span><br><span class="line">    logger.info(<span class="string">"拼接的日期是：[&#123;&#125;]"</span>,thisDay);</span><br><span class="line">    <span class="comment">// 指定日期和时间生成 LocalDateTime</span></span><br><span class="line">    LocalDateTime thisDayAndTime = LocalDateTime.of(LocalDate.of(<span class="number">2008</span>, <span class="number">8</span>, <span class="number">8</span>), LocalTime.of(<span class="number">12</span>, <span class="number">24</span>, <span class="number">12</span>));</span><br><span class="line">    logger.info(<span class="string">"拼接的日期是：[&#123;&#125;]"</span>,thisDayAndTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取LocalDate</span></span><br><span class="line">    LocalDate todayDate = today.toLocalDate();</span><br><span class="line">    logger.info(<span class="string">"今天日期是：[&#123;&#125;]"</span>,todayDate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取LocalTime</span></span><br><span class="line">    LocalTime todayTime = today.toLocalTime();</span><br><span class="line">    logger.info(<span class="string">"现在时间是：[&#123;&#125;]"</span>,todayTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-Instant"><a href="#2-4-Instant" class="headerlink" title="2.4 Instant"></a>2.4 <code>Instant</code></h3><p><code>Instant</code>用于一个获取时间戳，与<code>System.currentTimeMillis()</code>类似，但<code>Instant</code>可以精确到纳秒。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">instantDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Instant对象</span></span><br><span class="line">    Instant instant = Instant.now();</span><br><span class="line">    <span class="comment">// 通过ofEpochSecond方法创建(第一个参数表示秒，第二个参数表示纳秒)</span></span><br><span class="line">    Instant another = Instant.ofEpochSecond(<span class="number">365</span> * <span class="number">24</span> * <span class="number">60</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取到秒数</span></span><br><span class="line">    <span class="keyword">long</span> currentSecond = instant.getEpochSecond();</span><br><span class="line">    logger.info(<span class="string">"获取到秒数：[&#123;&#125;]"</span>, currentSecond);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取到毫秒数</span></span><br><span class="line">    <span class="keyword">long</span> currentMilli = instant.toEpochMilli();</span><br><span class="line">    logger.info(<span class="string">"获取到毫秒数：[&#123;&#125;]"</span>, currentMilli);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-Duration"><a href="#2-5-Duration" class="headerlink" title="2.5 Duration"></a>2.5 <code>Duration</code></h3><p><code>Duration</code>的内部实现与<code>Instant</code>类似，但<code>Duration</code>表示时间段，通过<code>between</code>方法创建，还可以通过<code>of()</code>方法创建。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">durationDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalDateTime from = LocalDateTime.now();</span><br><span class="line">    LocalDateTime to = LocalDateTime.now().plusDays(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 通过between()方法创建</span></span><br><span class="line">    Duration duration = Duration.between(from, to);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, duration);</span><br><span class="line">    <span class="comment">// 通过of()方法创建,该方法参数为时间段长度和时间单位。</span></span><br><span class="line">    <span class="comment">// 7天</span></span><br><span class="line">    Duration duration1 = Duration.of(<span class="number">7</span>, ChronoUnit.DAYS);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, duration1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 60秒</span></span><br><span class="line">    Duration duration2 = Duration.of(<span class="number">60</span>, ChronoUnit.SECONDS);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, duration2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-Period"><a href="#2-5-Period" class="headerlink" title="2.5 Period"></a>2.5 <code>Period</code></h3><p><code>Period</code>与<code>Duration</code>类似，获取一个时间段，只不过单位为年月日，也可以通过<code>of</code>方法和<code>between</code>方法创建，<code>between</code>方法接收的参数为<code>LocalDate</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">periodDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过of方法</span></span><br><span class="line">    Period period = Period.of(<span class="number">2012</span>, <span class="number">12</span>, <span class="number">24</span>);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, period);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过between方法</span></span><br><span class="line">    Period period1 = Period.between(LocalDate.now(), LocalDate.of(<span class="number">2020</span>,<span class="number">12</span>,<span class="number">31</span>));</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, period1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、时间操作"><a href="#三、时间操作" class="headerlink" title="三、时间操作"></a>三、时间操作</h2><h3 id="3-1-时间比较"><a href="#3-1-时间比较" class="headerlink" title="3.1 时间比较"></a>3.1 时间比较</h3><blockquote>
<p><code>isBefore()</code>和<code>isAfter()</code>判断给定的时间或日期是在另一个时间/日期之前还是之后。<br>以<code>LocalDate</code>为例，<code>LocalDateTime</code>/<code>LocalTime</code>同理。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalDate thisDay = LocalDate.of(<span class="number">2008</span>, <span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line">    LocalDate otherDay = LocalDate.of(<span class="number">2018</span>, <span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// 晚于</span></span><br><span class="line">    <span class="keyword">boolean</span> isAfter = thisDay.isAfter(otherDay);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, isAfter);</span><br><span class="line">    <span class="comment">// 早于</span></span><br><span class="line">    <span class="keyword">boolean</span> isBefore = thisDay.isBefore(otherDay);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, isBefore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-增加-减少年数、月数、天数"><a href="#3-2-增加-减少年数、月数、天数" class="headerlink" title="3.2 增加/减少年数、月数、天数"></a>3.2 增加/减少年数、月数、天数</h3><blockquote>
<p>以<code>LocalDateTime</code>为例，<code>LocalDate</code>/<code>LocalTime</code>同理。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">plusAndMinus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 增加</span></span><br><span class="line">    LocalDateTime today = LocalDateTime.now();</span><br><span class="line">    LocalDateTime nextYearDay = today.plusYears(<span class="number">1</span>);</span><br><span class="line">    logger.info(<span class="string">"下一年的今天是：[&#123;&#125;]"</span>, nextYearDay);</span><br><span class="line">    LocalDateTime nextMonthDay = today.plus(<span class="number">1</span>, ChronoUnit.MONTHS);</span><br><span class="line">    logger.info(<span class="string">"下一个月的今天是：[&#123;&#125;]"</span>, nextMonthDay);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//减少</span></span><br><span class="line">    LocalDateTime lastMonthDay = today.minusMonths(<span class="number">1</span>);</span><br><span class="line">    LocalDateTime lastYearDay = today.minus(<span class="number">1</span>, ChronoUnit.YEARS);</span><br><span class="line">    logger.info(<span class="string">"一个月前是：[&#123;&#125;]"</span>, lastMonthDay);</span><br><span class="line">    logger.info(<span class="string">"一年前是：[&#123;&#125;]"</span>, lastYearDay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-时间修改"><a href="#3-3-时间修改" class="headerlink" title="3.3 时间修改"></a>3.3 时间修改</h3><blockquote>
<p>通过<code>with()</code>修改时间</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">edit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalDateTime today = LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 修改年为2012年</span></span><br><span class="line">    LocalDateTime thisYearDay = today.withYear(<span class="number">2012</span>);</span><br><span class="line">    logger.info(<span class="string">"修改年后的时间为：[&#123;&#125;]"</span>, thisYearDay);</span><br><span class="line">    <span class="comment">// 修改为12月</span></span><br><span class="line">    LocalDateTime thisMonthDay = today.with(ChronoField.MONTH_OF_YEAR, <span class="number">12</span>);</span><br><span class="line">    logger.info(<span class="string">"修改月后的时间为：[&#123;&#125;]"</span>, thisMonthDay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-时间计算"><a href="#3-4-时间计算" class="headerlink" title="3.4 时间计算"></a>3.4 时间计算</h3><blockquote>
<p>通过 <code>TemporalAdjusters</code> 的静态方法 和 <code>Duration</code> 计算时间</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TemporalAdjusters 的静态方法</span></span><br><span class="line">    LocalDate today = LocalDate.now();</span><br><span class="line">    <span class="comment">// 获取今年的第一天</span></span><br><span class="line">    LocalDate date = today.with(firstDayOfYear());</span><br><span class="line">    logger.info(<span class="string">"今年的第一天是：[&#123;&#125;]"</span>, date);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Duration 计算</span></span><br><span class="line">    LocalDateTime from = LocalDateTime.now();</span><br><span class="line">    LocalDateTime to = LocalDateTime.now().plusMonths(<span class="number">1</span>);</span><br><span class="line">    Duration duration = Duration.between(from, to);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 区间统计换算</span></span><br><span class="line">    <span class="comment">// 总天数</span></span><br><span class="line">    <span class="keyword">long</span> days = duration.toDays();</span><br><span class="line">    logger.info(<span class="string">"相隔:[&#123;&#125;]天"</span>, days);</span><br><span class="line">    <span class="comment">// 小时数</span></span><br><span class="line">    <span class="keyword">long</span> hours = duration.toHours();</span><br><span class="line">    logger.info(<span class="string">"相隔:[&#123;&#125;]小时"</span>, hours);</span><br><span class="line">    <span class="comment">// 分钟数</span></span><br><span class="line">    <span class="keyword">long</span> minutes = duration.toMinutes();</span><br><span class="line">    logger.info(<span class="string">"相隔:[&#123;&#125;]分钟"</span>, minutes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TemporalAdjusters</code>的更多方法</li>
</ul>
<table>
<thead>
<tr>
<th>方法名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>dayOfWeekInMonth()</code></td>
<td>返回同一个月中每周的第几天</td>
</tr>
<tr>
<td><code>firstDayOfMonth()</code></td>
<td>返回当月的第一天</td>
</tr>
<tr>
<td><code>firstDayOfNextMonth()</code></td>
<td>返回下月的第一天</td>
</tr>
<tr>
<td><code>firstDayOfNextYear()</code></td>
<td>返回下一年的第一天</td>
</tr>
<tr>
<td><code>firstDayOfYear()</code></td>
<td>返回本年的第一天</td>
</tr>
<tr>
<td><code>firstInMonth()</code></td>
<td>返回同一个月中第一个星期几</td>
</tr>
<tr>
<td><code>lastDayOfMonth()</code></td>
<td>返回当月的最后一天</td>
</tr>
<tr>
<td><code>lastDayOfNextMonth()</code></td>
<td>返回下月的最后一天</td>
</tr>
<tr>
<td><code>lastDayOfNextYear()</code></td>
<td>返回下一年的最后一天</td>
</tr>
<tr>
<td><code>lastDayOfYear()</code></td>
<td>返回本年的最后一天</td>
</tr>
<tr>
<td><code>lastInMonth()</code></td>
<td>返回同一个月中最后一个星期几</td>
</tr>
<tr>
<td><code>next()</code> / <code>previous()</code></td>
<td>返回后一个/前一个给定的星期几</td>
</tr>
<tr>
<td><code>nextOrSame()</code> / <code>previousOrSame()</code></td>
<td>返回后一个/前一个给定的星期几，如果这个值满足条件，直接返回</td>
</tr>
</tbody></table>
<h2 id="四、时间日期格式化"><a href="#四、时间日期格式化" class="headerlink" title="四、时间日期格式化"></a>四、时间日期格式化</h2><h3 id="4-1-格式化时间"><a href="#4-1-格式化时间" class="headerlink" title="4.1 格式化时间"></a>4.1 格式化时间</h3><blockquote>
<p><code>DateTimeFormatter</code>默认提供了多种格式化方式，如果默认提供的不能满足要求，可以通过<code>DateTimeFormatter</code>的<code>ofPattern</code>方法创建自定义格式化方式。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">format</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalDate today = LocalDate.now();</span><br><span class="line">    <span class="comment">// 两种默认格式化时间方式</span></span><br><span class="line">    String todayStr1 = today.format(DateTimeFormatter.BASIC_ISO_DATE);</span><br><span class="line">    String todayStr2 = today.format(DateTimeFormatter.ISO_LOCAL_DATE);</span><br><span class="line">    logger.info(<span class="string">"格式化时间：[&#123;&#125;]"</span>, todayStr1);</span><br><span class="line">    logger.info(<span class="string">"格式化时间：[&#123;&#125;]"</span>, todayStr2);</span><br><span class="line">    <span class="comment">//自定义格式化</span></span><br><span class="line">    DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(<span class="string">"dd/MM/yyyy"</span>);</span><br><span class="line">    String todayStr3 = today.format(dateTimeFormatter);</span><br><span class="line">    logger.info(<span class="string">"自定义格式化时间：[&#123;&#125;]"</span>, todayStr3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-解析时间"><a href="#4-2-解析时间" class="headerlink" title="4.2 解析时间"></a>4.2 解析时间</h3><blockquote>
<p>4.1 中以何种方式格式化，这里需以同样方式解析。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LocalDate date1 = LocalDate.parse(<span class="string">"20080808"</span>, DateTimeFormatter.BASIC_ISO_DATE);</span><br><span class="line">    LocalDate date2 = LocalDate.parse(<span class="string">"2008-08-08"</span>, DateTimeFormatter.ISO_LOCAL_DATE);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, date1);</span><br><span class="line">    logger.info(<span class="string">"result:[&#123;&#125;]"</span>, date2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、周期性事件"><a href="#五、周期性事件" class="headerlink" title="五、周期性事件"></a>五、周期性事件</h2><h3 id="5-1-MonthDay"><a href="#5-1-MonthDay" class="headerlink" title="5.1 MonthDay"></a>5.1 <code>MonthDay</code></h3><blockquote>
<p>每年都会发生的事件(忽略年份),例如生日</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate createTime = LocalDate.of(<span class="number">2018</span>, <span class="number">2</span>, <span class="number">14</span>);</span><br><span class="line">MonthDay birthday = MonthDay.of(createTime.getMonthValue(), createTime.getDayOfMonth());</span><br><span class="line"></span><br><span class="line">MonthDay todayMonthDay = MonthDay.from(LocalDate.now()); <span class="comment">// 获取今天的月日</span></span><br><span class="line"><span class="keyword">if</span>(todayMonthDay.equals(birthday))&#123;</span><br><span class="line">    logger.info(<span class="string">"Many Many happy today!!"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    logger.info(<span class="string">"Sorry, today is not your birthday"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-2-YearMonth"><a href="#5-2-YearMonth" class="headerlink" title="5.2 YearMonth"></a>5.2 <code>YearMonth</code></h3><blockquote>
<p>表示信用卡到期日等等周期性时间，这个类还可以返回当月的天数，在判断<code>2</code>月有<code>28</code>天还是<code>29</code>天时非常有用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">YearMonth currentYearMonth = YearMonth.now();</span><br><span class="line">    logger.info(<span class="string">"Days in month year [&#123;&#125;]:[&#123;&#125;]"</span>, currentYearMonth, currentYearMonth.lengthOfMonth());</span><br><span class="line">    YearMonth creditCardExpiry = YearMonth.of(<span class="number">2018</span>, Month.FEBRUARY); <span class="comment">// 指定时间</span></span><br><span class="line">    logger.info(<span class="string">"Your credit card expires on [&#123;&#125;]"</span>, creditCardExpiry);</span><br></pre></td></tr></table></figure>

<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><blockquote>
<p><code>LocalDate</code> 相较于<code>Date</code></p>
</blockquote>
<ol>
<li><code>Instant</code> 的精确度更高，可以精确到纳秒级;</li>
<li><code>Duration</code> 可以便捷得到时间段内的天数、小时数等;</li>
<li><code>LocalDateTime</code> 能够快速地获取年、月、日、下一月等;</li>
<li><code>TemporalAdjusters</code> 类中包含许多常用的静态方法，避免自己编写工具类;</li>
<li>与<code>Date</code>的格式化方式<code>SimpleDateFormat</code>相比，<code>DateTimeFormatter</code>是线程安全的。</li>
</ol>
<p><a href="https://github.com/vanDusty/jdk/blob/master/JDK-Date/src/test/java/cn/van/jdk/date/LocalDateTest.java" target="_blank" rel="noopener">Github 示例代码</a></p>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>时间日期</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis 分页： + 拦截器实现</title>
    <url>/2019/12/11/5ee4191f.html</url>
    <content><![CDATA[<p>两种方式：<code>Pagehelper</code> 分页和自己实现，根据实际情况自己选用吧。</p>
<a id="more"></a>

<h2 id="一、分页插件-Pagehelper"><a href="#一、分页插件-Pagehelper" class="headerlink" title="一、分页插件 Pagehelper"></a>一、分页插件 <code>Pagehelper</code></h2><p><code>PageHelper</code>是<code>Mybatis</code>的一个分页插件，非常好用！</p>
<h3 id="1-1-Spring-Boot-依赖"><a href="#1-1-Spring-Boot-依赖" class="headerlink" title="1.1 Spring Boot 依赖"></a>1.1 <code>Spring Boot</code> 依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pagehelper 分页插件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以这么引入</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>latest version<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-PageHelper-配置"><a href="#1-2-PageHelper-配置" class="headerlink" title="1.2 PageHelper 配置"></a>1.2 <code>PageHelper</code> 配置</h3><p>配置文件增加<code>PageHelper</code>的配置，主要设置了分页方言和支持接口参数传递分页参数，如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">pagehelper:</span><br><span class="line">  # 指定数据库</span><br><span class="line">  helper-dialect: mysql</span><br><span class="line">  # 默认是false。启用合理化时，如果pageNum<span class="tag">&lt;<span class="name">1会查询第一页，如果pageNum</span>&gt;</span>pages（最大页数）会查询最后一页。禁用合理化时，如果pageNum<span class="tag">&lt;<span class="name">1或pageNum</span>&gt;</span>pages会返回空数据</span><br><span class="line">  reasonable: false</span><br><span class="line">  # 是否支持接口参数来传递分页参数，默认false</span><br><span class="line">  support-methods-arguments: true</span><br><span class="line">  # 为了支持startPage(Object params)方法，增加了该参数来配置参数映射，用于从对象中根据属性名取值， 可以配置 pageNum,pageSize,count,pageSizeZero,reasonable，不配置映射的用默认值， 默认值为pageNum=pageNum;pageSize=pageSize;count=countSql;reasonable=reasonable;pageSizeZero=pageSizeZero</span><br><span class="line">  params: count=countSql</span><br><span class="line">  row-bounds-with-count: true</span><br></pre></td></tr></table></figure>

<blockquote>
<p>项目完整配置文件详见文<a href="https://github.com/vanDusty/mybatis-Home/blob/master/mybatis-case/mybatis-pagehelper/src/main/resources/application.yml" target="_blank" rel="noopener">mybatis-pagehelper</a>。</p>
</blockquote>
<h3 id="1-3-如何分页"><a href="#1-3-如何分页" class="headerlink" title="1.3 如何分页"></a>1.3 如何分页</h3><p>只有紧跟在<code>PageHelper.startPage</code>方法后的第一个<code>Mybatis</code>的查询（<code>Select</code>）方法会自动分页!!!!</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectForPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 第几页</span></span><br><span class="line">    <span class="keyword">int</span> currentPage = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 每页数量</span></span><br><span class="line">    <span class="keyword">int</span> pageSize = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    String orderBy = <span class="string">"id desc"</span>;</span><br><span class="line">    PageHelper.startPage(currentPage, pageSize, orderBy);</span><br><span class="line">    List&lt;UserInfoPagehelperDO&gt; users = userInfoPagehelperMapper.selectList();</span><br><span class="line">    PageInfo&lt;UserInfoPagehelperDO&gt; userPageInfo = <span class="keyword">new</span> PageInfo&lt;&gt;(users);</span><br><span class="line">    log.info(<span class="string">"userPageInfo:&#123;&#125;"</span>, userPageInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">...: userPageInfo:PageInfo&#123;pageNum=2, pageSize=5, size=1, startRow=6, endRow=6, total=6, pages=2, list=Page&#123;count=true, pageNum=2, pageSize=5, startRow=5, endRow=10, total=6, pages=2, reasonable=false, pageSizeZero=false&#125;[UserInfoPagehelperDO&#123;id=1, userName='null', age=22, createTime=null&#125;], prePage=1, nextPage=0, isFirstPage=false, isLastPage=true, hasPreviousPage=true, hasNextPage=false, navigatePages=8, navigateFirstPage=1, navigateLastPage=2, navigatepageNums=[1, 2]&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的返回结果包括数据、是否为第一页/最后一页、总页数、总记录数，详见<a href="https://github.com/pagehelper/Mybatis-PageHelper" target="_blank" rel="noopener">Mybatis-PageHelper</a></p>
</blockquote>
<p><a href="https://github.com/vanDusty/Mybatis-Home/tree/master/mybatis-case/mybatis-pagehelper" target="_blank" rel="noopener">Pagehelper 分页完整示例</a></p>
<h2 id="二、Mybatis-拦截器实现分页"><a href="#二、Mybatis-拦截器实现分页" class="headerlink" title="二、Mybatis 拦截器实现分页"></a>二、<code>Mybatis</code> 拦截器实现分页</h2><h3 id="2-1-Mybatis-拦截器"><a href="#2-1-Mybatis-拦截器" class="headerlink" title="2.1 Mybatis 拦截器"></a>2.1 <code>Mybatis</code> 拦截器</h3><p><a href="https://mybatis.org/mybatis-3/zh/configuration.html#plugins" target="_blank" rel="noopener">Mybatis 官网</a>【插件】部分有以下描述：</p>
<ol>
<li>通过 <code>MyBatis</code> 提供的强大机制，使用插件是非常简单的，只需实现 <code>Interceptor</code> 接口，并指定想要拦截的方法签名即可。</li>
<li><code>MyBatis</code> 允许你在已映射语句执行过程中的某一点进行拦截调用。默认情况下，<code>MyBatis</code> 允许使用插件来拦截的方法调用包括：</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Executor (update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</span><br><span class="line">ParameterHandler (getParameterObject, setParameters)</span><br><span class="line">ResultSetHandler (handleResultSets, handleOutputParameters)</span><br><span class="line">StatementHandler (prepare, parameterize, batch, update, query)</span><br></pre></td></tr></table></figure>

<p>即：我们可以通过拦截器的方式，实现<code>MyBatis</code>插件(数据分页)</p>
<blockquote>
<p>接下来重点演示我如何使用了拦截器实现分页。</p>
</blockquote>
<h3 id="2-2-调用形式"><a href="#2-2-调用形式" class="headerlink" title="2.2 调用形式"></a>2.2 调用形式</h3><blockquote>
<p>在看如何实现之前，我们先看看如何使用：</p>
</blockquote>
<p>照抄 <code>PageHelper</code> 的设计，先调用一个静态方法，对下面第一个方法的<code>sql</code>语句进行拦截，在<code>new</code>一个分页对象时自动处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectForPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 该查询进行分页，指定第几页和每页数量</span></span><br><span class="line">    PageInterceptor.startPage(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    List&lt;UserInfoDO&gt; all = dao.findAll();</span><br><span class="line">    PageResult&lt;UserInfoDO&gt; result = <span class="keyword">new</span> PageResult&lt;&gt;(all);</span><br><span class="line">    <span class="comment">// 分页结果打印</span></span><br><span class="line">    System.out.println(<span class="string">"总记录数："</span> + result.getTotal());</span><br><span class="line">    System.out.println(result.getData().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们主要看看实现步骤。</p>
<h3 id="2-3-数据库方言"><a href="#2-3-数据库方言" class="headerlink" title="2.3 数据库方言"></a>2.3 数据库方言</h3><blockquote>
<p>定义好一个方言接口，不同的数据使用不同的方言实现</p>
</blockquote>
<ul>
<li><code>Dialect.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Dialect</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取count SQL语句</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetSql</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">getCountSql</span><span class="params">(String targetSql)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"select count(1) from (%s) tmp_count"</span>, targetSql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取limit SQL语句</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetSql</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> offset</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getLimitSql</span><span class="params">(String targetSql, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mysql</code> 分页方言</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlDialect</span> <span class="keyword">implements</span> <span class="title">Dialect</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATTERN = <span class="string">"%s limit %s, %s"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATTERN_FIRST = <span class="string">"%s limit %s"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLimitSql</span><span class="params">(String targetSql, <span class="keyword">int</span> offset, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (offset == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> String.format(PATTERN_FIRST, targetSql, limit);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> String.format(PATTERN, targetSql, offset, limit);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-拦截器核心逻辑"><a href="#2-4-拦截器核心逻辑" class="headerlink" title="2.4 拦截器核心逻辑"></a>2.4 拦截器核心逻辑</h3><blockquote>
<p>该部分完整代码见 <a href="https://github.com/vanDusty/mybatis-Home/blob/master/mybatis-case/mybatis-pageable/src/main/java/cn/van/mybatis/pageable/page/PageInterceptor.java" target="_blank" rel="noopener">PageInterceptor.java</a></p>
</blockquote>
<ul>
<li>分页辅助参数内部类 <code>PageParam.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PageParam</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前页</span></span><br><span class="line">    <span class="keyword">int</span> pageNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分页开始位置</span></span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分页数量</span></span><br><span class="line">    <span class="keyword">int</span> limit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 总数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> totalSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 总页数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> totalPage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>查询总记录数</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">queryTotal</span><span class="params">(MappedStatement mappedStatement, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Connection connection = <span class="keyword">null</span>;</span><br><span class="line">    PreparedStatement countStmt = <span class="keyword">null</span>;</span><br><span class="line">    ResultSet rs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        connection = mappedStatement.getConfiguration().getEnvironment().getDataSource().getConnection();</span><br><span class="line"></span><br><span class="line">        String countSql = <span class="keyword">this</span>.dialect.getCountSql(boundSql.getSql());</span><br><span class="line"></span><br><span class="line">        countStmt = connection.prepareStatement(countSql);</span><br><span class="line">        BoundSql countBoundSql = <span class="keyword">new</span> BoundSql(mappedStatement.getConfiguration(), countSql,</span><br><span class="line">                boundSql.getParameterMappings(), boundSql.getParameterObject());</span><br><span class="line"></span><br><span class="line">        setParameters(countStmt, mappedStatement, countBoundSql, boundSql.getParameterObject());</span><br><span class="line"></span><br><span class="line">        rs = countStmt.executeQuery();</span><br><span class="line">        <span class="keyword">long</span> totalCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">            totalCount = rs.getLong(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> totalCount;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        log.error(<span class="string">"查询总记录数出错"</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rs.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                log.error(<span class="string">"exception happens when doing: ResultSet.close()"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (countStmt != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                countStmt.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                log.error(<span class="string">"exception happens when doing: PreparedStatement.close()"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                log.error(<span class="string">"exception happens when doing: Connection.close()"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对分页<code>SQL</code>参数<code>?</code>设值</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setParameters</span><span class="params">(PreparedStatement ps, MappedStatement mappedStatement, BoundSql boundSql,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Object parameterObject)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    ParameterHandler parameterHandler = <span class="keyword">new</span> DefaultParameterHandler(mappedStatement, parameterObject, boundSql);</span><br><span class="line">    parameterHandler.setParameters(ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>利用方言接口替换原始的<code>SQL</code>语句</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> MappedStatement <span class="title">copyFromMappedStatement</span><span class="params">(MappedStatement ms, SqlSource newSqlSource)</span> </span>&#123;</span><br><span class="line">    MappedStatement.Builder builder = <span class="keyword">new</span> MappedStatement.Builder(ms.getConfiguration(), ms.getId(), newSqlSource, ms.getSqlCommandType());</span><br><span class="line"></span><br><span class="line">    builder.resource(ms.getResource());</span><br><span class="line">    builder.fetchSize(ms.getFetchSize());</span><br><span class="line">    builder.statementType(ms.getStatementType());</span><br><span class="line">    builder.keyGenerator(ms.getKeyGenerator());</span><br><span class="line">    <span class="keyword">if</span> (ms.getKeyProperties() != <span class="keyword">null</span> &amp;&amp; ms.getKeyProperties().length != <span class="number">0</span>) &#123;</span><br><span class="line">        StringBuffer keyProperties = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span> (String keyProperty : ms.getKeyProperties()) &#123;</span><br><span class="line">            keyProperties.append(keyProperty).append(<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        keyProperties.delete(keyProperties.length() - <span class="number">1</span>, keyProperties.length());</span><br><span class="line">        builder.keyProperty(keyProperties.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setStatementTimeout()</span></span><br><span class="line">    builder.timeout(ms.getTimeout());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setStatementResultMap()</span></span><br><span class="line">    builder.parameterMap(ms.getParameterMap());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setStatementResultMap()</span></span><br><span class="line">    builder.resultMaps(ms.getResultMaps());</span><br><span class="line">    builder.resultSetType(ms.getResultSetType());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//setStatementCache()</span></span><br><span class="line">    builder.cache(ms.getCache());</span><br><span class="line">    builder.flushCacheRequired(ms.isFlushCacheRequired());</span><br><span class="line">    builder.useCache(ms.isUseCache());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>计算总页数</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countPage</span><span class="params">(<span class="keyword">int</span> totalSize, <span class="keyword">int</span> offset)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> totalPageTemp = totalSize / offset;</span><br><span class="line">    <span class="keyword">int</span> plus = (totalSize % offset) == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    totalPageTemp = totalPageTemp + plus;</span><br><span class="line">    <span class="keyword">if</span> (totalPageTemp &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        totalPageTemp = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> totalPageTemp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>供调用的静态分页方法</li>
</ul>
<blockquote>
<p>我这里设计的，页数是从<code>1</code>开始的，如果习惯用<code>0</code>开始，可以自己修改。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startPage</span><span class="params">(<span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> offset = (pageNum-<span class="number">1</span>) * pageSize;</span><br><span class="line">    <span class="keyword">int</span> limit = pageSize;</span><br><span class="line">    PageInterceptor.PageParam pageParam = <span class="keyword">new</span> PageInterceptor.PageParam();</span><br><span class="line">    pageParam.offset = offset;</span><br><span class="line">    pageParam.limit = limit;</span><br><span class="line">    pageParam.pageNum = pageNum;</span><br><span class="line">    PARAM_THREAD_LOCAL.set(pageParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="2-5-分页结果集"><a href="#2-5-分页结果集" class="headerlink" title="2.5 分页结果集"></a>2.5 分页结果集</h3><blockquote>
<p>为了便于结果封装，我这里自己封装了一个比较全的分页结果集，包含太多的东西了，自己慢慢看下面的属性吧（自认为比较全了，欢迎打脸）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageResult</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否为第一页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isFirstPage = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否为最后一页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isLastPage = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前页</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每页的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageSize;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalSize;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总页数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalPage;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 结果集</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageResult</span><span class="params">(List&lt;T&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        PageInterceptor.PageParam pageParam = PageInterceptor.PARAM_THREAD_LOCAL.get();</span><br><span class="line">        <span class="keyword">if</span> (pageParam != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pageNum = pageParam.pageNum;</span><br><span class="line">            pageSize = pageParam.limit;</span><br><span class="line">            totalSize = pageParam.totalSize;</span><br><span class="line">            totalPage = pageParam.totalPage;</span><br><span class="line">            isFirstPage = (pageNum == <span class="number">1</span>);</span><br><span class="line">            isLastPage = (pageNum == totalPage);</span><br><span class="line">            PageInterceptor.PARAM_THREAD_LOCAL.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getPageNum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pageNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPageNum</span><span class="params">(Integer pageNum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pageNum = pageNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getPageSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPageSize</span><span class="params">(Integer pageSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getTotalSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> totalSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotalSize</span><span class="params">(Integer totalSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.totalSize = totalSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getTotalPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> totalPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotalPage</span><span class="params">(Integer totalPage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.totalPage = totalPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(List&lt;T&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getFirstPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isFirstPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirstPage</span><span class="params">(Boolean firstPage)</span> </span>&#123;</span><br><span class="line">        isFirstPage = firstPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getLastPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isLastPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLastPage</span><span class="params">(Boolean lastPage)</span> </span>&#123;</span><br><span class="line">        isLastPage = lastPage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PageResult&#123;"</span> +</span><br><span class="line">                <span class="string">"isFirstPage="</span> + isFirstPage +</span><br><span class="line">                <span class="string">", isLastPage="</span> + isLastPage +</span><br><span class="line">                <span class="string">", pageNum="</span> + pageNum +</span><br><span class="line">                <span class="string">", pageSize="</span> + pageSize +</span><br><span class="line">                <span class="string">", totalSize="</span> + totalSize +</span><br><span class="line">                <span class="string">", totalPage="</span> + totalPage +</span><br><span class="line">                <span class="string">", data="</span> + data +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="2-6-简单测试下"><a href="#2-6-简单测试下" class="headerlink" title="2.6 简单测试下"></a>2.6 简单测试下</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectForPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 该查询进行分页，指定第几页和每页数量</span></span><br><span class="line">    PageInterceptor.startPage(<span class="number">1</span>,<span class="number">4</span>);</span><br><span class="line">    List&lt;UserInfoDO&gt; all = userMapper.findAll();</span><br><span class="line">    PageResult&lt;UserInfoDO&gt; result = <span class="keyword">new</span> PageResult&lt;&gt;(all);</span><br><span class="line">    <span class="comment">// 分页结果打印</span></span><br><span class="line">    log.info(<span class="string">"总记录数：&#123;&#125;"</span>, result.getTotalSize());</span><br><span class="line">    log.info(<span class="string">"list：&#123;&#125;"</span>, result.getData());</span><br><span class="line">    log.info(<span class="string">"result:&#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用方法基本<code>1.3</code>完全一致吧，只是封装成了我自己的分页结果集。</p>
</blockquote>
<ul>
<li>日志如下：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">....: ==&gt;  Preparing: SELECT id, user_name, age, create_time FROM user_info_pageable limit 4 </span><br><span class="line">....: ==&gt; Parameters: </span><br><span class="line">....: <span class="tag">&lt;<span class="name">==</span>      <span class="attr">Total:</span> <span class="attr">4</span></span></span><br><span class="line"><span class="tag"><span class="attr">....:</span> 总记录数：<span class="attr">6</span></span></span><br><span class="line"><span class="tag"><span class="attr">....:</span> <span class="attr">list</span>：[<span class="attr">UserInfoDO</span>(<span class="attr">id</span>=<span class="string">1,</span> <span class="attr">userName</span>=<span class="string">张三,</span> <span class="attr">age</span>=<span class="string">22,</span> <span class="attr">createTime</span>=<span class="string">2019-10-08T20:52:46),</span> <span class="attr">UserInfoDO</span>(<span class="attr">id</span>=<span class="string">2,</span> <span class="attr">userName</span>=<span class="string">李四,</span> <span class="attr">age</span>=<span class="string">21,</span> <span class="attr">createTime</span>=<span class="string">2019-12-23T20:22:54),</span> <span class="attr">UserInfoDO</span>(<span class="attr">id</span>=<span class="string">3,</span> <span class="attr">userName</span>=<span class="string">王二,</span> <span class="attr">age</span>=<span class="string">22,</span> <span class="attr">createTime</span>=<span class="string">2019-12-23T20:23:15),</span> <span class="attr">UserInfoDO</span>(<span class="attr">id</span>=<span class="string">4,</span> <span class="attr">userName</span>=<span class="string">马五,</span> <span class="attr">age</span>=<span class="string">20,</span> <span class="attr">createTime</span>=<span class="string">2019-12-23T20:23:15)]</span></span></span><br><span class="line"><span class="tag"><span class="attr">....:</span> <span class="attr">result:PageResult</span>&#123;<span class="attr">isFirstPage</span>=<span class="string">true,</span> <span class="attr">isLastPage</span>=<span class="string">false,</span> <span class="attr">pageNum</span>=<span class="string">1,</span> <span class="attr">pageSize</span>=<span class="string">4,</span> <span class="attr">totalSize</span>=<span class="string">6,</span> <span class="attr">totalPage</span>=<span class="string">2,</span> <span class="attr">data</span>=<span class="string">[UserInfoDO(id</span>=<span class="string">1,</span> <span class="attr">userName</span>=<span class="string">张三,</span> <span class="attr">age</span>=<span class="string">22,</span> <span class="attr">createTime</span>=<span class="string">2019-10-08T20:52:46),</span> <span class="attr">UserInfoDO</span>(<span class="attr">id</span>=<span class="string">2,</span> <span class="attr">userName</span>=<span class="string">李四,</span> <span class="attr">age</span>=<span class="string">21,</span> <span class="attr">createTime</span>=<span class="string">2019-12-23T20:22:54),</span> <span class="attr">UserInfoDO</span>(<span class="attr">id</span>=<span class="string">3,</span> <span class="attr">userName</span>=<span class="string">王二,</span> <span class="attr">age</span>=<span class="string">22,</span> <span class="attr">createTime</span>=<span class="string">2019-12-23T20:23:15),</span> <span class="attr">UserInfoDO</span>(<span class="attr">id</span>=<span class="string">4,</span> <span class="attr">userName</span>=<span class="string">马五,</span> <span class="attr">age</span>=<span class="string">20,</span> <span class="attr">createTime</span>=<span class="string">2019-12-23T20:23:15)]&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>通过日志分析，发现普通的<code>SELECT * FROM user_info_pageable</code> 被重新组装成<code>SELECT * FROM user_info_pageable limit 4</code>,说明拦截器实现的分页成功。</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>两种方式：<code>Pagehelper</code> 分页和自己实现，根据实际情况自己选用吧。</p>
<ol>
<li><a href="https://github.com/vanDusty/Frame-Home/tree/master/mybatis-case/mybatis-pagehelper" target="_blank" rel="noopener"><code>Pagehelper</code> 分页示例代码</a></li>
<li><a href="https://github.com/vanDusty/Frame-Home/tree/master/mybatis-case/mybatis-pageable" target="_blank" rel="noopener"><code>Mybatis</code> 拦截器实现分页示例代码</a></li>
</ol>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>分布式全局唯一ID生成策略​</title>
    <url>/2019/12/08/dbc7452d.html</url>
    <content><![CDATA[<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>分布式系统中我们会对一些数据量大的业务进行分拆，如：用户表，订单表。因为数据量巨大一张表无法承接，就会对其进行分库分表。<br>但一旦涉及到分库分表，就会引申出分布式系统中唯一主键<code>ID</code>的生成问题。</p>
<a id="more"></a>

<h3 id="1-1-唯一ID的特性"><a href="#1-1-唯一ID的特性" class="headerlink" title="1.1 唯一ID的特性"></a>1.1 唯一ID的特性</h3><ol>
<li>全局唯一：整个系统<code>ID</code>唯一;</li>
<li>趋势有序： <code>ID</code>是数字类型，而且是趋势递增;<code>ID</code>简短，查询效率快。</li>
<li>高可用：<code>ID</code>是一条数据的唯一标识，如果<code>ID</code>生成失败，则影响很大，业务执行不下去；</li>
<li>信息安全：<code>ID</code>虽然趋势有序，但是不可以被看出规则，免得被爬取信息。</li>
</ol>
<h3 id="1-2-递增与趋势递增"><a href="#1-2-递增与趋势递增" class="headerlink" title="1.2 递增与趋势递增"></a>1.2 递增与趋势递增</h3><table>
<thead>
<tr>
<th>种类</th>
<th>递增</th>
<th>趋势递增</th>
</tr>
</thead>
<tbody><tr>
<td>区别</td>
<td>第一次生成的<code>ID</code>为<code>12</code>，下一次生成的<code>ID</code>是<code>13</code>，再下一次生成的<code>ID</code>是<code>14</code>。</td>
<td>在一段时间内，生成的<code>ID</code>是递增的趋势，如：在<code>【0-1000】</code>区间内的时候，<code>ID</code>生成有可能第一次是<code>12</code>，第二次是<code>10</code>，第三次是<code>14</code>。</td>
</tr>
</tbody></table>
<h2 id="二、方案"><a href="#二、方案" class="headerlink" title="二、方案"></a>二、方案</h2><h3 id="2-1-UUID"><a href="#2-1-UUID" class="headerlink" title="2.1 UUID"></a>2.1 UUID</h3><p><code>UUID</code>全称:<code>Universally Unique Identifier</code>。标准型式包含32个16进制数字，以连字号分为五段，形式为<code>8-4-4-4-12</code>的36个字符，示例：<code>9628f6e9-70ca-45aa-9f7c-77afe0d26e05</code>。</p>
<ul>
<li>优点：</li>
</ul>
<ol>
<li>代码实现简单;</li>
<li>本机生成，没有性能问题;</li>
<li>全球唯一的<code>ID</code>，所以迁移数据容易。</li>
</ol>
<ul>
<li>缺点：</li>
</ul>
<ol>
<li>每次生成的<code>ID</code>是无序的，无法保证趋势递增;</li>
<li><code>UUID</code>的字符串存储，查询效率慢;</li>
<li>存储空间大;</li>
<li><code>ID</code>本身无业务含义，不可读。</li>
</ol>
<ul>
<li>应用场景：</li>
</ul>
<ol>
<li>类似生成token令牌的场景;</li>
<li>不适用一些要求有趋势递增的ID场景,不适合作为高性能需求的场景下的数据库主键。</li>
</ol>
<blockquote>
<p>也有在线生成<code>UUID</code>的网站，如果你的项目上用到了<code>UUID</code>，可以用来生成临时的测试数据。<a href="https://www.uuidgenerator.net/" target="_blank" rel="noopener">https://www.uuidgenerator.net</a></p>
</blockquote>
<h3 id="2-2-MySQL-主键自增"><a href="#2-2-MySQL-主键自增" class="headerlink" title="2.2 MySQL 主键自增"></a>2.2 MySQL 主键自增</h3><p>利用了<code>MySQL</code>的主键自增<code>auto_increment</code>，默认每次<code>ID</code>加<code>1</code>。</p>
<ul>
<li>优点：</li>
</ul>
<ol>
<li>数字化，<code>ID</code>递增;</li>
<li>查询效率高;</li>
<li>具有一定的业务可读。</li>
</ol>
<ul>
<li>缺点：</li>
</ul>
<ol>
<li>存在单点问题，如果<code>MySQL</code>挂了，就没法生成<code>ID</code>了;</li>
<li>数据库压力大，高并发抗不住。</li>
</ol>
<h3 id="2-3-MySQL多实例主键自增"><a href="#2-3-MySQL多实例主键自增" class="headerlink" title="2.3 MySQL多实例主键自增"></a>2.3 MySQL多实例主键自增</h3><p>这个方案就是解决<code>MySQL</code>的单点问题，在<code>auto_increment</code>基本上面，设置<code>step</code>步长</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/7/16edf827eecbc4d3?w=1304&h=1068&f=png&s=418606" alt="风尘博客"></p>
<p>如上，每台的初始值分别为<code>1</code>,<code>2</code>,<code>3</code>…<code>N</code>，步长为<code>N</code>（这个案例步长为<code>4</code>）</p>
<ul>
<li>优点：解决了单点问题;</li>
<li>缺点：一旦把步长定好后，就无法扩容；而且单个数据库的压力大，数据库自身性能无法满足高并发。</li>
<li>应用场景：数据不需要扩容的场景。</li>
</ul>
<h3 id="2-4-基于Redis实现"><a href="#2-4-基于Redis实现" class="headerlink" title="2.4 基于Redis实现"></a>2.4 基于Redis实现</h3><ul>
<li><p>单机：<code>Redis</code>的<code>incr</code>函数在单机上是原子操作，可以保证唯一且递增。</p>
</li>
<li><p>集群：单机<code>Redis</code>可能无法支撑高并发。集群情况下，可以使用步长的方式。比如有5个<code>Redis</code>节点组成的集群，它们生成的<code>ID</code>分别为：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A: 1,6,11,16,21</span><br><span class="line">B: 2,7,12,17,22</span><br><span class="line">C: 3,8,13,18,23</span><br><span class="line">D: 4,9,14,19,24</span><br><span class="line">E: 5,10,15,20,25</span><br></pre></td></tr></table></figure>

<ul>
<li>优点：有序递增，可读性强。</li>
<li>缺点：占用带宽，每次要向<code>Redis</code>进行请求。</li>
</ul>
<h3 id="2-5-SnowFlake-方案"><a href="#2-5-SnowFlake-方案" class="headerlink" title="2.5 SnowFlake 方案"></a>2.5 SnowFlake 方案</h3><p><code>SnowFlake</code>是<code>twitter</code>开源的分布式<code>ID</code>生成算法。</p>
<ul>
<li>雪花<code>ID</code>结构</li>
</ul>
<p><code>SnowFlake</code>算法生成<code>ID</code>固定是一个<code>long</code>型的数字，一个<code>long</code>型占<code>8</code>个字节，也就是<code>64</code>个<code>bit</code>，原始<code>SnowFlake</code>算法中对于<code>bit</code>的分配如下图：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/7/16edf827f01a1afe?w=1021&h=346&f=png&s=72831" alt="雪花算法"></p>
<ol>
<li>第一个<code>bit</code>位是标识部分，在<code>Java</code>中由于<code>long</code>的最高位是符号位，正数是<code>0</code>，负数是<code>1</code>，一般生成的<code>ID</code>为正数，所以固定为<code>0</code>。</li>
<li>时间戳部分占<code>41bit</code>，这个是毫秒级的时间，一般实现上不会存储当前的时间戳，而是时间戳的差值（当前时间-固定的开始时间），这样可以使产生的<code>ID</code>从更小值开始；<code>41</code>位的时间戳可以使用<code>69</code>年；</li>
<li>工作机器<code>id</code>占<code>10bit</code>，这里比较灵活，比如，可以使用前<code>5</code>位作为数据中心机房标识，后<code>5</code>位作为单机房机器标识，可以部署<code>1024</code>个节点。</li>
<li>序列号部分占<code>12bit</code>，支持同一毫秒内同一个节点可以生成<code>4096</code>个<code>ID</code>。</li>
</ol>
<ul>
<li>优点</li>
</ul>
<ol>
<li>毫秒数在高位，自增序列在低位，ID趋势递增。</li>
<li>以服务方式部署，可以做高可用。</li>
<li>根据业务分配bit位，灵活。</li>
</ol>
<ul>
<li>缺点</li>
</ul>
<ol>
<li>每台机器的时钟不同，当时钟回拨可能会发生重复ID。</li>
<li>当数据量大时，需要对ID取模分库分表，在跨毫秒时，序列号总是归0，会发生取模后分布不均衡。</li>
</ol>
<h2 id="三、优化方案之数据库自增方案"><a href="#三、优化方案之数据库自增方案" class="headerlink" title="三、优化方案之数据库自增方案"></a>三、优化方案之数据库自增方案</h2><h3 id="3-1、改造数据库主键自增"><a href="#3-1、改造数据库主键自增" class="headerlink" title="3.1、改造数据库主键自增"></a>3.1、改造数据库主键自增</h3><p>数据库的自增主键的特性，可以实现分布式<code>ID</code>，适合做<code>userId</code>，正好符合如何永不迁移数据和避免热点? 但这个方案有严重的问题：</p>
<ol>
<li>一旦步长定下来，不容易扩容;</li>
<li>数据库压力山大。</li>
</ol>
<ul>
<li>为什么压力大？</li>
</ul>
<p>因为我们每次获取<code>ID</code>的时候，都要去数据库请求一次。那我们可以不可以不要每次去取？</p>
<p><strong>可以请求数据库得到<code>ID</code>的时候，可设计成获得的<code>ID</code>是一个<code>ID</code>区间段。</strong><br><img src="https://user-gold-cdn.xitu.io/2019/12/7/16edf827f025cf6a?w=1344&h=1194&f=png&s=510838" alt=""></p>
<ul>
<li>上图<code>ID</code>规则表含义：</li>
</ul>
<ol>
<li><code>id</code>表示为主键，无业务含义;</li>
<li><code>biz_tag</code>为了表示业务，因为整体系统中会有很多业务需要生成<code>ID</code>，这样可以共用一张表维护;</li>
<li><code>max_id</code>表示现在整体系统中已经分配的最大<code>ID</code>;</li>
<li><code>desc</code>描述;</li>
<li><code>update_time</code>表示每次取的<code>ID</code>时间;</li>
</ol>
<ul>
<li>整体流程：</li>
</ul>
<ol>
<li>【用户服务】在注册一个用户时，需要一个用户<code>ID</code>；会请求【生成<code>ID</code>服务(是独立的应用)】的接口;</li>
<li>【生成<code>ID</code>服务】会去查询数据库，找到<code>user_tag</code>的<code>id</code>，现在的<code>max_id</code>为<code>0</code>，<code>step=1000</code>;</li>
<li>【生成<code>ID</code>服务】把<code>max_id</code>和<code>step</code>返回给【用户服务】；并且把<code>max_id</code>更新为<code>max_id = max_id + step</code>，即更新为<code>1000</code>;</li>
<li>【用户服务】获得<code>max_id=0</code>，<code>step=1000</code>;</li>
<li>这个用户服务可以用<code>ID=【max_id + 1，max_id+step】</code>区间的<code>ID</code>，即为<code>【1，1000】</code>;</li>
<li>【用户服务】会把这个区间保存到<code>jvm</code>中;</li>
<li>【用户服务】需要用到<code>ID</code>的时候，在区间<code>【1，1000】</code>中依次获取<code>ID</code>，可采用<code>AtomicLong</code>中的<code>getAndIncrement</code>方法;</li>
<li>如果把区间的值用完了，再去请求【生产<code>ID</code>服务】接口，获取到<code>max_id</code>为<code>1000</code>，即可以用<code>【max_id + 1，max_id+step】</code>区间的<code>ID</code>，即为<code>【1001，2000】</code>。</li>
</ol>
<ol>
<li>该方案就非常完美的解决了数据库自增的问题，而且可以自行定义<code>max_id</code>的起点，和<code>step</code>步长，非常方便扩容；</li>
<li>也解决了数据库压力的问题，因为在一段区间内，是在<code>jvm</code>内存中获取的，而不需要每次请求数据库。即使数据库宕机了，系统也不受影响，<code>ID</code>还能维持一段时间。</li>
</ol>
<h3 id="3-2-竞争问题"><a href="#3-2-竞争问题" class="headerlink" title="3.2 竞争问题"></a>3.2 竞争问题</h3><p>以上方案中，如果是多个用户服务，同时获取<code>ID</code>，同时去请求【ID服务】，在获取<code>max_id</code>的时候会存在并发问题。如:</p>
<blockquote>
<p>用户服务<code>A</code>，取到的<code>max_id=1000</code> ;用户服务<code>B</code>取到的也是<code>max_id=1000</code>，那就出现了问题，<code>ID</code>重复了。</p>
</blockquote>
<p>解决方案是：加分布式锁，保证同一时刻只有一个用户服务获取<code>max_id</code>。</p>
<h3 id="3-3-突发阻塞问题"><a href="#3-3-突发阻塞问题" class="headerlink" title="3.3 突发阻塞问题"></a>3.3 突发阻塞问题</h3><p><img src="https://user-gold-cdn.xitu.io/2019/12/7/16edf827f08c1547?w=1314&h=1184&f=png&s=508691" alt="风尘博客"></p>
<p>因为竞争问题，所有只有一个用户服务去操作数据库，其他二个会被阻塞。出现的现象就是一会儿突然系统耗时变长，怎么去解决？</p>
<ul>
<li>双<code>buffer</code>方案</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/7/16edf827f1c5dd76?w=1322&h=810&f=png&s=561586" alt="风尘博客"></p>
<p>流程如下：</p>
<ol>
<li>当前获取<code>ID</code>在<code>buffer1</code>中，每次获取<code>ID</code>在<code>buffer1</code>中获取;</li>
<li>当<code>buffer1</code>中的<code>ID</code>已经使用到了<code>100</code>，也就是达到区间的<code>10%</code>;</li>
<li>达到了<code>10%</code>，先判断<code>buffer2</code>中有没有去获取过，如果没有就立即发起请求获取<code>ID</code>线程，此线程把获取到的<code>ID</code>，设置到<code>buffer2</code>中;</li>
<li>如果<code>buffer1</code>用完了，会自动切换到<code>buffer2</code>;</li>
<li><code>buffer2</code>用到<code>10%</code>了，也会启动线程再次获取，设置到<code>buffer1</code>中;</li>
<li>依次往返。</li>
</ol>
<h3 id="3-4-小结"><a href="#3-4-小结" class="headerlink" title="3.4 小结"></a>3.4 小结</h3><ol>
<li>双<code>buffer</code>的方案就达到了业务场景用的<code>ID</code>，都是在<code>jvm</code>内存中获得的，从此不需要到数据库中获取了,数据库宕机时长长点儿也没太大影响了。</li>
<li>因为会有一个线程，会观察什么时候去自动获取。两个<code>buffer</code>之间自行切换使用，就解决了突发阻塞的问题。</li>
</ol>
<h2 id="四、雪花ID实现"><a href="#四、雪花ID实现" class="headerlink" title="四、雪花ID实现"></a>四、雪花ID实现</h2><p>在大厂里，其实并没有直接使用<code>SnowFlake</code>，而是进行了改造，因为<code>SnowFlake</code>算法中最难实践的就是工作机器<code>id</code>，原始的<code>SnowFlake</code>算法需要人工去为每台机器去指定一个机器<code>id</code>，并配置在某个地方从而让<code>SnowFlake</code>从此处获取机器<code>id</code>。但是在大厂里，机器是很多的，人力成本太大且容易出错，所以大厂对<code>SnowFlake</code>进行了改造。</p>
<h3 id="4-1-美团（Leaf）"><a href="#4-1-美团（Leaf）" class="headerlink" title="4.1 美团（Leaf）"></a>4.1 美团（Leaf）</h3><p>美团的<code>Leaf</code>就是一个分布式<code>ID</code>生成框架。它非常全面，即支持号段模式，也支持<code>SnowFlake</code>模式。<code>Leaf</code> 提供两种生成的<code>ID</code>的方式，你可以同时开启两种方式，也可以指定开启某种方式（默认两种方式为关闭状态）。</p>
<p>详见：<a href="https://github.com/Meituan-Dianping/Leaf/blob/master/README_CN.md" target="_blank" rel="noopener">Leaf 使用说明</a></p>
<h3 id="4-2-我的实现"><a href="#4-2-我的实现" class="headerlink" title="4.2 我的实现"></a>4.2 我的实现</h3><blockquote>
<p>根据这个算法的逻辑，只需要将这个算法用<code>Java</code>语言实现出来，封装为一个工具方法，我们自己在各个业务应用可以直接使用该工具方法来获取分布式<code>ID</code>，只需保证每个业务应用有自己的工作机器<code>ID</code>即可，而不需要单独去搭建一个获取分布式<code>ID</code>的应用。</p>
</blockquote>
<ul>
<li>雪花<code>ID</code>工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnowFlakeUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 起始的时间戳:这个时间戳自己随意获取，比如自己代码的时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> START_TIMESTAMP = <span class="number">1288834974657L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每一部分占用的位数</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列号占用的位数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> SEQUENCE_BIT = <span class="number">12</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 机器标识占用的位数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MACHINE_BIT = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据中心占用的位数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DATA_CENTER_BIT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每一部分的最大值：先进行左移运算，再同-1进行异或运算；异或：相同位置相同结果为0，不同结果为1</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用位运算计算出最大支持的数据中心数量：31</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_DATACENTER_NUM = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; DATA_CENTER_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用位运算计算出最大支持的机器数量：31</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_MACHINE_NUM = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; MACHINE_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用位运算计算出12位能存储的最大正整数：4095</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_SEQUENCE = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; SEQUENCE_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每一部分向左的位移</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 机器标志较序列号的偏移量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MACHINE_LEFT = SEQUENCE_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据中心较机器标志的偏移量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DATA_CENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间戳较数据中心的偏移量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> TIMESTAMP_LEFT = DATA_CENTER_LEFT + DATA_CENTER_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据中心</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> datacenterId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 机器标识</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> machineId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> sequence = <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上一次时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> lastStamp = -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此处无参构造私有，同时没有给出有参构造，在于避免以下两点问题：</span></span><br><span class="line"><span class="comment">     * 1、私有化避免了通过new的方式进行调用，主要是解决了在for循环中通过new的方式调用产生的id不一定唯一问题问题，因为用于			 记录上一次时间戳的lastStmp永远无法得到比对；</span></span><br><span class="line"><span class="comment">     * 2、没有给出有参构造在第一点的基础上考虑了一套分布式系统产生的唯一序列号应该是基于相同的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SnowFlakeUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得下一个ID(该方法是线程安全的)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">nextId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** 获取当前时间戳 */</span></span><br><span class="line">        <span class="keyword">long</span> currStamp = timeGen();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 如果当前时间小于上一次ID生成的时间戳，说明系统时钟回退过，这时候应当抛出异常 */</span></span><br><span class="line">         <span class="keyword">if</span> (currStamp &lt; lastStamp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Clock moved backwards.  Refusing to generate id"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** 如果是同一时间（相同毫秒内）生成的，则进行毫秒内序列 */</span></span><br><span class="line">        <span class="keyword">if</span> (currStamp == lastStamp) &#123;</span><br><span class="line">            <span class="comment">//相同毫秒内，序列号自增</span></span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; MAX_SEQUENCE;</span><br><span class="line">            <span class="comment">//同一毫秒的序列数已经达到最大</span></span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="comment">/** 阻塞到下一个毫秒,获得新的时间戳赋值给当前时间戳 */</span></span><br><span class="line">                currStamp = tilNextMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//时间戳改变，毫秒内序列号置为0</span></span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** 当前时间戳存档记录，用于下次产生id时对比是否为相同时间戳 */</span></span><br><span class="line">        lastStamp = currStamp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移位并通过或运算拼到一起组成64位的ID</span></span><br><span class="line">        <span class="comment">//时间戳部分</span></span><br><span class="line">        <span class="keyword">return</span> (currStamp - START_TIMESTAMP) &lt;&lt; TIMESTAMP_LEFT</span><br><span class="line">                <span class="comment">// 数据中心部分</span></span><br><span class="line">                | datacenterId &lt;&lt; DATA_CENTER_LEFT</span><br><span class="line">                <span class="comment">// 机器标识部分</span></span><br><span class="line">                | machineId &lt;&lt; MACHINE_LEFT</span><br><span class="line">                <span class="comment">// 序列号部分</span></span><br><span class="line">                | sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 阻塞到下一个毫秒，直到获得新的时间戳</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 当前时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">tilNextMillis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> timestamp = timeGen();</span><br><span class="line">        <span class="keyword">while</span> (timestamp &lt;= lastStamp) &#123;</span><br><span class="line">            timestamp = timeGen();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">timeGen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>此处无参构造私有，同时没有给出有参构造，在于避免以下两点问题：</p>
<ol>
<li>私有化避免了通过<code>new</code>的方式进行调用，主要是解决了在<code>for</code>循环中通过<code>new</code>的方式调用产生的<code>ID</code>不一定唯一问题问题，因为用于记录上一次时间戳的<code>lastStamp</code>永远无法得到比对；</li>
<li>没有给出有参构造在第一点的基础上考虑了一套分布式系统产生的唯一序列号应该是基于相同的参数。</li>
</ol>
<ul>
<li>测试方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">snowFlakeID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Long uniqueId = SnowFlakeUtil.nextId();</span><br><span class="line">    log.info(<span class="string">"uniqueId:&#123;&#125;"</span>, uniqueId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">20:39:02.121 [main] INFO cn.van.unique.id.UniqueIdTest - uniqueId:1203217335414947840</span><br></pre></td></tr></table></figure>

<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><h3 id="5-1-其他实现方式"><a href="#5-1-其他实现方式" class="headerlink" title="5.1 其他实现方式"></a>5.1 其他实现方式</h3><p>还有一些其他的<code>ID</code>生成方案，比如：</p>
<ol>
<li>滴滴：时间+起点编号+车牌号;</li>
<li>淘宝订单：时间戳+用户<code>ID</code></li>
<li>其他电商：时间戳+下单渠道+用户<code>ID</code>，有的会加上订单第一个商品的<code>ID</code>;</li>
<li><code>MongoDB</code> 的<code>ID</code>：通过<code>时间+机器码+pid+inc</code>共12个字节，<code>4+3+2+3</code>的方式最终标识成一个24长度的十六进制字符。</li>
</ol>
<h3 id="5-2-示例源码"><a href="#5-2-示例源码" class="headerlink" title="5.2 示例源码"></a>5.2 示例源码</h3><p><a href="https://github.com/vanDusty/Distributed/blob/master/unique-id/src/main/java/cn/van/unique/id/utils/SnowFlakeUtil.java" target="_blank" rel="noopener">Gihub 示例源码</a></p>
<h3 id="5-3-参考文章"><a href="#5-3-参考文章" class="headerlink" title="5.3 参考文章"></a>5.3 参考文章</h3><ol>
<li><a href="https://www.cnblogs.com/nicerblog/p/11466442.html" target="_blank" rel="noopener">大型互联网公司分布式ID方案总结</a></li>
<li><a href="https://juejin.im/post/5c75132f51882562276c5065" target="_blank" rel="noopener">Twitter雪花算法SnowFlake算法的java实现</a></li>
</ol>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>并发</tag>
        <tag>ID</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 科学运算之 BigDecimal</title>
    <url>/2019/11/16/770dcfc3.html</url>
    <content><![CDATA[<p>如果在资金计算中，还在使用 <code>+</code>、<code>-</code>、<code>*</code>、<code>\</code> 计算，我想你该离删库跑路不远了。</p>
<a id="more"></a>

<h2 id="一、BigDecimal的产生背景"><a href="#一、BigDecimal的产生背景" class="headerlink" title="一、BigDecimal的产生背景"></a>一、<code>BigDecimal</code>的产生背景</h2><p>首先我们先来看如下代码示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, <span class="number">0.06</span> + <span class="number">0.01</span>);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, <span class="number">1.0</span> - <span class="number">0.42</span>);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, <span class="number">4.015</span> * <span class="number">100</span>);</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, <span class="number">303.1</span> / <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">result:0.06999999999999999</span><br><span class="line">result:0.5800000000000001</span><br><span class="line">result:401.49999999999994</span><br><span class="line">result:0.30310000000000004</span><br></pre></td></tr></table></figure>

<p>问题在哪里呢？原因在于<strong>我们的计算机是二进制的，浮点数是没有办法用二进制进行精确表示</strong>。</p>
<p><code>Java</code>的<code>float</code>只能用来进行科学计算或工程计算，在大多数的商业计算中，一般采用<code>java.math.BigDecimal</code>类来进行精确计算。</p>
<h2 id="二、正确运用BigDecimal"><a href="#二、正确运用BigDecimal" class="headerlink" title="二、正确运用BigDecimal"></a>二、正确运用<code>BigDecimal</code></h2><h3 id="2-1-BigDecimal常量"><a href="#2-1-BigDecimal常量" class="headerlink" title="2.1 BigDecimal常量"></a>2.1 <code>BigDecimal</code>常量</h3><p><code>BigDecimal</code>定义了几个常用的值，<code>0</code>、<code>1</code>、<code>10</code>，静态的，可以通过类名直接引用如：<code>BigDecimal.ZERO</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The value 0, with a scale of 0.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>  1.5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal ZERO =</span><br><span class="line">    zeroThroughTen[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The value 1, with a scale of 0.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>  1.5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal ONE =</span><br><span class="line">    zeroThroughTen[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The value 10, with a scale of 0.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span>  1.5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BigDecimal TEN =</span><br><span class="line">    zeroThroughTen[<span class="number">10</span>];</span><br></pre></td></tr></table></figure>


<h3 id="2-2-构造方法"><a href="#2-2-构造方法" class="headerlink" title="2.2 构造方法"></a>2.2 构造方法</h3><p><code>BigDecimal</code> 有<code>4</code>个常用构造方法</p>
<ol>
<li><code>new BigDecimal(int)</code> 创建一个具有参数所指定整数值的对象；</li>
<li><code>new BigDecimal(double)</code> 创建一个具有参数所指定双精度值的对象；</li>
<li><code>new BigDecimal(long)</code> 创建一个具有参数所指定长整数值的对象；</li>
<li><code>new BigDecimal(String)</code> 创建一个具有参数所指定以字符串表示的数值的对象。</li>
</ol>
<h3 id="2-3-BigDecimal运算一般步骤"><a href="#2-3-BigDecimal运算一般步骤" class="headerlink" title="2.3 BigDecimal运算一般步骤"></a>2.3 <code>BigDecimal</code>运算一般步骤</h3><p>在使用<code>BigDecimal</code>类来进行计算的时候，主要三个步骤：</p>
<ol>
<li>用<code>float</code>或者<code>double</code>变量构建<code>BigDecimal</code>对象。</li>
<li>通过调用<code>BigDecimal</code>的加，减，乘，除等相应的方法进行算术运算。</li>
<li>把<code>BigDecimal</code>对象转换成<code>float</code>，<code>double</code>，<code>int</code>等类型。</li>
</ol>
<h2 id="三、常用方法详解"><a href="#三、常用方法详解" class="headerlink" title="三、常用方法详解"></a>三、常用方法详解</h2><p>在一般开发过程中，我们数据库中存储的数据都是<code>float</code>和<code>double</code>类型的。我封装了一个工具类，该工具类提供加、减、乘、除、向上取值、向下取值等运算。</p>
<h3 id="3-1-普通加减乘除"><a href="#3-1-普通加减乘除" class="headerlink" title="3.1 普通加减乘除"></a>3.1 普通加减乘除</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认除法运算精度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEF_DIV_SCALE = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 精确的加法运算。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v1 被加数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v2 加数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 两个参数的和</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">add</span><span class="params">(Double v1, Double v2)</span> </span>&#123;</span><br><span class="line">    BigDecimal b1 = BigDecimal.valueOf(v1);</span><br><span class="line">    BigDecimal b2 = BigDecimal.valueOf(v2);</span><br><span class="line">    <span class="keyword">return</span> b1.add(b2).doubleValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 精确的减法运算。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v1 被减数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v2 减数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 两个参数的差</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">sub</span><span class="params">(Double v1, Double v2)</span> </span>&#123;</span><br><span class="line">    BigDecimal b1 = BigDecimal.valueOf(v1);</span><br><span class="line">    BigDecimal b2 = BigDecimal.valueOf(v2);</span><br><span class="line">    <span class="keyword">return</span> b1.subtract(b2).doubleValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 精确的乘法运算。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v1 被乘数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v2 乘数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 两个参数的积</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">mul</span><span class="params">(Double v1, Double v2)</span> </span>&#123;</span><br><span class="line">    BigDecimal b1 = BigDecimal.valueOf(v1);</span><br><span class="line">    BigDecimal b2 = BigDecimal.valueOf(v2);</span><br><span class="line">    <span class="keyword">return</span> b1.multiply(b2).doubleValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * （相对）精确的除法运算，当发生除不尽的情况时，默认精确到小数点以后10位，以后的数字四舍五入。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v1 被除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v2 除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 两个参数的商</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">div</span><span class="params">(Double v1, Double v2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> div(v1, v2, DEF_DIV_SCALE, RoundingMode.HALF_UP);</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">### 3.2 按照精度四舍五入或者向上/向下取整</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 得到计算结果后四舍五入</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale 精度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 例如保留三位小数：0.646464 =》 0.646</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">roundHalfUp</span><span class="params">(<span class="keyword">double</span> val, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    BigDecimal dec = BigDecimal.valueOf(val);</span><br><span class="line">    <span class="keyword">return</span> dec.setScale(scale, BigDecimal.ROUND_HALF_UP).doubleValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 得到计算结果后向上取整</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val   val</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale 精度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 例如保留三位小数：0.646464 =》 0.647</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">roundUp</span><span class="params">(<span class="keyword">double</span> val, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    BigDecimal dec = BigDecimal.valueOf(val);</span><br><span class="line">    <span class="keyword">return</span> dec.setScale(scale, RoundingMode.UP).doubleValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 得到计算结果后向下取整</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val   val</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale 精度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 例如保留三位小数：0.646464 =》 0.646</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">roundDown</span><span class="params">(<span class="keyword">double</span> val, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    BigDecimal dec = BigDecimal.valueOf(val);</span><br><span class="line">    <span class="keyword">return</span> dec.setScale(scale, RoundingMode.DOWN).doubleValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 除法运算加上向上取整。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v1    被除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v2    除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale 精度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">divOfUp</span><span class="params">(Double v1, Double v2, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> div(v1, v2, scale, RoundingMode.UP);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 除法运算加上向下取整。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v1    被除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v2    除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale 精度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">divOfDown</span><span class="params">(Double v1, Double v2, <span class="keyword">int</span> scale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> div(v1, v2, scale, RoundingMode.DOWN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提供（相对）精确的除法运算。当发生除不尽的情况时，由 scale 参数指定精度，roundingMode 指定取舍方式。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v1           被除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> v2           除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> scale        表示表示需要精确到小数点以后几位。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roundingMode 指定取舍方式。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 两个参数的商</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">div</span><span class="params">(<span class="keyword">double</span> v1, <span class="keyword">double</span> v2, <span class="keyword">int</span> scale, RoundingMode roundingMode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果精确范围小于0，抛出异常信息</span></span><br><span class="line">    <span class="keyword">if</span> (scale &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The scale must be a positive integer or zero"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    BigDecimal b1 = BigDecimal.valueOf(v1);</span><br><span class="line">    BigDecimal b2 = BigDecimal.valueOf(v2);</span><br><span class="line">    <span class="keyword">return</span> b1.divide(b2, scale, roundingMode).doubleValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-如果正好是除以或乘以整十"><a href="#3-3-如果正好是除以或乘以整十" class="headerlink" title="3.3 如果正好是除以或乘以整十"></a>3.3 如果正好是除以或乘以整十</h3><p>有时候，比如人民币的分/圆/万计算，我们正好是除以或者乘以百/万的计算，除了加法和减法，<code>BigDecimal</code> 提供直接移动小数点的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 小数点向右移动指定位数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val   被乘数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index 移动位数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 例如向右移动四位小数：1000.01 =》 1000010.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">movePointRight</span><span class="params">(Double val, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    BigDecimal value = BigDecimal.valueOf(val);</span><br><span class="line">    <span class="keyword">return</span> value.movePointRight(index).doubleValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 小数点向左移动指定位数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> val   被除数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index 移动位数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 例如向左移动四位小数：1000.01 =》 1.00001</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">movePointLeft</span><span class="params">(Double val, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    BigDecimal value = BigDecimal.valueOf(val);</span><br><span class="line">    <span class="keyword">return</span> value.movePointLeft(index).doubleValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-BigDecimal-大小比较"><a href="#3-4-BigDecimal-大小比较" class="headerlink" title="3.4 BigDecimal 大小比较"></a>3.4 <code>BigDecimal</code> 大小比较</h3><p>在比较两个<code>BigDecimal</code>的值是否相等时，必须使用<code>compareTo()</code>方法来比较，它根据两个值的大小分别返回<code>-1</code>、<code>1</code>和 <code>0</code>，分别表示小于、大于和等于。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compareDecimal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BigDecimal v1 = BigDecimal.valueOf(<span class="number">1.21</span>);</span><br><span class="line">    BigDecimal v2 = BigDecimal.valueOf(<span class="number">1.22</span>);</span><br><span class="line">    BigDecimal v3 = BigDecimal.valueOf(<span class="number">1.22</span>);</span><br><span class="line">    <span class="comment">// -1:小于、1:大于、0:等于</span></span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, v1.compareTo(v2));</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, v2.compareTo(v1));</span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, v2.compareTo(v3));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5BigDecimal精度也丢失"><a href="#3-5BigDecimal精度也丢失" class="headerlink" title="3.5BigDecimal精度也丢失"></a>3.5<code>BigDecimal</code>精度也丢失</h3><p>仔细的你一定发现了，在工具类中使用<code>BigDecimal</code>中，都是使用<code>BigDecimal</code> 的 <code>valueOf()</code>创建对象的，而<code>valueOf()</code> 的内部实现是</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BigDecimal <span class="title">valueOf</span><span class="params">(<span class="keyword">double</span> val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(Double.toString(val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>及构造器用的是<code>new BigDecimal(String)</code>，因为其他的如<code>new BigDecimal(int)</code>/<code>new BigDecimal(long)</code>/<code>new BigDecimal(double)</code>，还是会发生精度丢失的问题。</p>
<ul>
<li>示例</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">precisionLose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BigDecimal v1 = <span class="keyword">new</span> BigDecimal(<span class="number">1.01</span>);</span><br><span class="line">    BigDecimal v2 = <span class="keyword">new</span> BigDecimal(<span class="number">1.02</span>);</span><br><span class="line">    BigDecimal v3 = <span class="keyword">new</span> BigDecimal(<span class="string">"1.01"</span>);</span><br><span class="line">    BigDecimal v4 = <span class="keyword">new</span> BigDecimal(<span class="string">"1.02"</span>);</span><br><span class="line">    <span class="comment">// 2.0300000000000000266453525910037569701671600341796875</span></span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, v1.add(v2));</span><br><span class="line">    <span class="comment">// 2.03</span></span><br><span class="line">    logger.info(<span class="string">"result:&#123;&#125;"</span>, v3.add(v4));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><ol>
<li><p><code>BigDecimal</code>用于表示精确的小数，常用于财务计算；</p>
</li>
<li><p>比较<code>BigDecimal</code>的值是否相等，必须使用<code>compareTo()</code>而不能使用<code>equals()</code>。</p>
</li>
</ol>
<h3 id="【Github-示例代码】"><a href="#【Github-示例代码】" class="headerlink" title="【Github 示例代码】"></a><a href="https://github.com/vanDusty/jdk/blob/master/JDK-Tool/src/main/java/cn/van/jdk/tool/math/BigDecimalUtil.java" target="_blank" rel="noopener">【Github 示例代码】</a></h3><blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>运算</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 整合JWT</title>
    <url>/2019/10/04/540271f6.html</url>
    <content><![CDATA[<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p><code>JWT</code>全称是：<code>json web token</code>。它将用户信息加密到<code>token</code>里，服务器不保存任何用户信息。服务器通过使用保存的密钥验证<code>token</code>的正确性，只要正确即通过验证。</p>
<a id="more"></a>

<h3 id="1-1-优点"><a href="#1-1-优点" class="headerlink" title="1.1 优点"></a>1.1 优点</h3><ol>
<li>简洁: 可以通过<code>URL</code>、<code>POST</code>参数或者在<code>HTTP header</code>发送，因为数据量小，传输速度也很快；</li>
<li>自包含：负载中可以包含用户所需要的信息，避免了多次查询数据库；</li>
<li>因为<code>Token</code>是以<code>JSON</code>加密的形式保存在客户端的，所以<code>JWT</code>是跨语言的，原则上任何<code>web</code>形式都支持；</li>
<li>不需要在服务端保存会话信息，特别适用于分布式微服务。</li>
</ol>
<h3 id="1-2-缺点"><a href="#1-2-缺点" class="headerlink" title="1.2 缺点"></a>1.2 缺点</h3><ol>
<li>无法作废已颁布的令牌；</li>
<li>不易应对数据过期。</li>
</ol>
<h2 id="二、Jwt消息构成"><a href="#二、Jwt消息构成" class="headerlink" title="二、Jwt消息构成"></a>二、<code>Jwt</code>消息构成</h2><h3 id="2-1-组成"><a href="#2-1-组成" class="headerlink" title="2.1 组成"></a>2.1 组成</h3><p>一个<code>token</code>分<code>3</code>部分，按顺序为</p>
<ol>
<li>头部（<code>header</code>)</li>
<li>载荷（<code>payload</code>)</li>
<li>签证（<code>signature</code>)</li>
</ol>
<p>三部分之间用<code>.</code>号做分隔。例如：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiIxYzdiY2IzMS02ODFlLTRlZGYtYmU3Yy0wOTlkODAzM2VkY2UiLCJleHAiOjE1Njk3Mjc4OTF9.wweMzyB3tSQK34Jmez36MmC5xpUh15Ni3vOV_SGCzJ8</span><br></pre></td></tr></table></figure>

<h3 id="2-2-header"><a href="#2-2-header" class="headerlink" title="2.2 header"></a>2.2 header</h3><p><code>Jwt</code>的头部承载两部分信息：</p>
<ol>
<li>声明类型，这里是<code>Jwt</code>；</li>
<li>声明加密的算法 通常直接使用 <code>HMAC SHA256</code>。</li>
</ol>
<p><code>JWT</code>里验证和签名使用的算法列表如下：</p>
<table>
<thead>
<tr>
<th>JWS</th>
<th>算法名称</th>
</tr>
</thead>
<tbody><tr>
<td>HS256</td>
<td>HMAC256</td>
</tr>
<tr>
<td>HS384</td>
<td>HMAC384</td>
</tr>
<tr>
<td>HS512</td>
<td>HMAC512</td>
</tr>
<tr>
<td>RS256</td>
<td>RSA256</td>
</tr>
<tr>
<td>RS384</td>
<td>RSA384</td>
</tr>
<tr>
<td>RS512</td>
<td>RSA512</td>
</tr>
<tr>
<td>ES256</td>
<td>ECDSA256</td>
</tr>
<tr>
<td>ES384</td>
<td>ECDSA384</td>
</tr>
<tr>
<td>ES512</td>
<td>ECDSA512</td>
</tr>
</tbody></table>
<h3 id="2-3-playload"><a href="#2-3-playload" class="headerlink" title="2.3 playload"></a>2.3 <code>playload</code></h3><p>载荷就是存放有效信息的地方。基本上填<code>2</code>种类型数据</p>
<ol>
<li>标准中注册的声明的数据；</li>
<li>自定义数据。</li>
</ol>
<p>由这2部分内部做<code>base64</code>加密。</p>
<ul>
<li>标准中注册的声明 (建议但不强制使用)</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">iss: jwt签发者</span><br><span class="line">sub: jwt所面向的用户</span><br><span class="line">aud: 接收jwt的一方</span><br><span class="line">exp: jwt的过期时间，这个过期时间必须要大于签发时间</span><br><span class="line">nbf: 定义在什么时间之前，该jwt都是不可用的.</span><br><span class="line">iat: jwt的签发时间</span><br><span class="line">jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义数据:存放我们想放在<code>token</code>中存放的<code>key-value</code>值</li>
</ul>
<h3 id="2-4-signature"><a href="#2-4-signature" class="headerlink" title="2.4 signature"></a>2.4 <code>signature</code></h3><p><code>JWT</code>的第三部分是一个签证信息，这个签证信息由三部分组成<br><code>base64</code>加密后的<code>header</code>和<code>base64</code>加密后的<code>payload</code>连接组成的字符串，然后通过<code>header</code>中声明的加密方式进行加盐<code>secret</code>组合加密，然后就构成了<code>JWT</code>的第三部分。</p>
<h2 id="三、Spring-Boot和JWT集成示例"><a href="#三、Spring-Boot和JWT集成示例" class="headerlink" title="三、Spring Boot和JWT集成示例"></a>三、<code>Spring Boot</code>和<code>JWT</code>集成示例</h2><p>示例代码采用：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-项目依赖"><a href="#2-1-项目依赖" class="headerlink" title="2.1 项目依赖"></a>2.1 项目依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>1.8.4<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-自定义注解-JwtToken"><a href="#3-2-自定义注解-JwtToken" class="headerlink" title="3.2 自定义注解@JwtToken"></a>3.2 自定义注解<code>@JwtToken</code></h3><blockquote>
<p>加上该注解的接口需要登录才能访问</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> JwtToken &#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Jwt-认证工具类JwtUtil-java"><a href="#3-3-Jwt-认证工具类JwtUtil-java" class="headerlink" title="3.3 Jwt 认证工具类JwtUtil.java"></a>3.3 Jwt 认证工具类<code>JwtUtil.java</code></h3><blockquote>
<p>主要用来生成签名、校验签名和通过签名获取信息</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过期时间5分钟</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> EXPIRE_TIME = <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt 密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECRET = <span class="string">"jwt_secret"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成签名，五分钟后过期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sign</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Date date = <span class="keyword">new</span> Date(System.currentTimeMillis() + EXPIRE_TIME);</span><br><span class="line">            Algorithm algorithm = Algorithm.HMAC256(SECRET);</span><br><span class="line">            <span class="keyword">return</span> JWT.create()</span><br><span class="line">                    <span class="comment">// 将 userDTO id 保存到 token 里面</span></span><br><span class="line">                    .withAudience(userId)</span><br><span class="line">                    <span class="comment">// 五分钟后token过期</span></span><br><span class="line">                    .withExpiresAt(date)</span><br><span class="line">                    <span class="comment">// token 的密钥</span></span><br><span class="line">                    .sign(algorithm);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据token获取userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUserId</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String userId = JWT.decode(token).getAudience().get(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> userId;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JWTDecodeException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSign</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Algorithm algorithm = Algorithm.HMAC256(SECRET);</span><br><span class="line">            JWTVerifier verifier = JWT.require(algorithm)</span><br><span class="line">                    <span class="comment">// .withClaim("username", username)</span></span><br><span class="line">                    .build();</span><br><span class="line">            DecodedJWT jwt = verifier.verify(token);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JWTVerificationException exception) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"token 无效，请重新获取"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-拦截器拦截带有注解的接口"><a href="#3-4-拦截器拦截带有注解的接口" class="headerlink" title="3.4 拦截器拦截带有注解的接口"></a>3.4 拦截器拦截带有注解的接口</h3><ul>
<li><code>JwtInterceptor.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object object)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从 http 请求头中取出 token</span></span><br><span class="line">        String token = httpServletRequest.getHeader(<span class="string">"token"</span>);</span><br><span class="line">        <span class="comment">// 如果不是映射到方法直接通过</span></span><br><span class="line">        <span class="keyword">if</span>(!(object <span class="keyword">instanceof</span> HandlerMethod))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        HandlerMethod handlerMethod=(HandlerMethod)object;</span><br><span class="line">        Method method=handlerMethod.getMethod();</span><br><span class="line">        <span class="comment">//检查有没有需要用户权限的注解</span></span><br><span class="line">        <span class="keyword">if</span> (method.isAnnotationPresent(JwtToken<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">            JwtToken jwtToken = method.getAnnotation(JwtToken<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (jwtToken.required()) &#123;</span><br><span class="line">                <span class="comment">// 执行认证</span></span><br><span class="line">                <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"无token，请重新登录"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 获取 token 中的 userId</span></span><br><span class="line">                String userId = JwtUtil.getUserId(token);</span><br><span class="line">                System.out.println(<span class="string">"用户id:"</span> + userId);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 验证 token</span></span><br><span class="line">                JwtUtil.checkSign(token);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注册拦截器：<code>WebConfig.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加jwt拦截器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(jwtInterceptor())</span><br><span class="line">                <span class="comment">// 拦截所有请求，通过判断是否有 @JwtToken 注解 决定是否需要登录</span></span><br><span class="line">                .addPathPatterns(<span class="string">"/**"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt拦截器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtInterceptor <span class="title">jwtInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-全局异常捕获"><a href="#3-5-全局异常捕获" class="headerlink" title="3.5 全局异常捕获"></a>3.5 全局异常捕获</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Object</span> <span class="title">handleException</span>(<span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        String msg = e.getMessage();</span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span> || msg.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">            msg = <span class="string">"服务器出错"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject.put(<span class="string">"message"</span>, msg);</span><br><span class="line">        <span class="keyword">return</span> jsonObject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-6-接口"><a href="#3-6-接口" class="headerlink" title="3.6 接口"></a>3.6 接口</h3><ul>
<li><code>JwtController.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/jwt"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录并获取token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> passWord</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">login</span><span class="params">( String userName, String passWord)</span></span>&#123;</span><br><span class="line">        JSONObject jsonObject=<span class="keyword">new</span> JSONObject();</span><br><span class="line">        <span class="comment">// 检验用户是否存在(为了简单，这里假设用户存在，并制造一个uuid假设为用户id)</span></span><br><span class="line">        String userId = UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">// 生成签名</span></span><br><span class="line">        String token= JwtUtil.sign(userId);</span><br><span class="line">        Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        userInfo.put(<span class="string">"userId"</span>, userId);</span><br><span class="line">        userInfo.put(<span class="string">"userName"</span>, userName);</span><br><span class="line">        userInfo.put(<span class="string">"passWord"</span>, passWord);</span><br><span class="line">        jsonObject.put(<span class="string">"token"</span>, token);</span><br><span class="line">        jsonObject.put(<span class="string">"userDTO"</span>, userInfo);</span><br><span class="line">        <span class="keyword">return</span> jsonObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该接口需要带签名才能访问</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JwtToken</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getMessage"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"你已通过验证"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-7-Postman测试接口"><a href="#3-7-Postman测试接口" class="headerlink" title="3.7 Postman测试接口"></a>3.7 <code>Postman</code>测试接口</h3><h4 id="3-7-1-在没token的情况下访问jwt-getMessage接口"><a href="#3-7-1-在没token的情况下访问jwt-getMessage接口" class="headerlink" title="3.7.1 在没token的情况下访问jwt/getMessage接口"></a>3.7.1 在没<code>token</code>的情况下访问<code>jwt/getMessage</code>接口</h4><ul>
<li>请求方式：<code>GET</code></li>
<li>请求参数：无</li>
<li>请求地址：<a href="http://localhost:8080/jwt/getMessage" target="_blank" rel="noopener">http://localhost:8080/jwt/getMessage</a></li>
<li>返回结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "message": "无token，请重新登录"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-7-2-先登录，在访问jwt-getMessage接口"><a href="#2-7-2-先登录，在访问jwt-getMessage接口" class="headerlink" title="2.7.2 先登录，在访问jwt/getMessage接口"></a>2.7.2 先登录，在访问<code>jwt/getMessage</code>接口</h4><ul>
<li>登录请求及结果，详见下图：</li>
</ul>
<p><img src="/File/Imgs/jwt_1.png" alt="风尘博客"></p>
<p>登录后得到签名如箭头处</p>
<ul>
<li>在请求头加上签名，然后再请求<code>jwt/getMessage</code>接口</li>
</ul>
<p><img src="/File/Imgs/jwt_2.png" alt="风尘博客"></p>
<p>请求通过，测试成功！</p>
<h4 id="4-7-3-过期后再次访问"><a href="#4-7-3-过期后再次访问" class="headerlink" title="4.7.3 过期后再次访问"></a>4.7.3 过期后再次访问</h4><blockquote>
<p>我们设置的签名过期时间是五分钟，五分钟后再次访问<code>jwt/getMessage</code>接口,结果如下：</p>
</blockquote>
<p><img src="/File/Imgs/jwt_3.png" alt="风尘博客"></p>
<p>通过结果，我们发现时间到了，签名失效，说明该方案通过。</p>
<h2 id="五、-源码"><a href="#五、-源码" class="headerlink" title="五、 源码"></a>五、 源码</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-certification/jwt-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>JWT</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring 对象属性拷贝方式总结</title>
    <url>/2019/10/02/747d9a37.html</url>
    <content><![CDATA[<p>当get/set太繁琐时；当BeanUtils无法拷贝集合时；当。。。可能，你需要好好看看这篇文章。文末附完整示例代码。</p>
<a id="more"></a>

<h1 id="对象属性拷贝"><a href="#对象属性拷贝" class="headerlink" title="对象属性拷贝"></a>对象属性拷贝</h1><p>在做业务的时候，为了隔离变化，我们会将<code>DAO</code>查询出来的<code>DO</code>和对前端提供的<code>DTO</code>隔离开来。大概<code>90%</code>的时候，它们的结构都是类似的；但是我们很不喜欢写很多冗长的<code>b.setF1(a.getF1())</code>这样的代码，于是我们需要简化对象拷贝方式。</p>
<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><h3 id="1-1-对象拷贝概念"><a href="#1-1-对象拷贝概念" class="headerlink" title="1.1 对象拷贝概念"></a>1.1 对象拷贝概念</h3><p><code>Java</code>中，数据类型分为值类型（基本数据类型）和引用类型，值类型包括<code>int</code>、<code>double</code>、<code>byte</code>、<code>boolean</code>、<code>char</code>等简单数据类型，引用类型包括类、接口、数组等复杂类型。</p>
<p>对象拷贝分为<strong>浅拷贝(浅克隆)</strong>与<strong>深拷贝(深克隆)</strong>。</p>
<ul>
<li>浅拷贝与深拷贝差异</li>
</ul>
<table>
<thead>
<tr>
<th>分类</th>
<th>浅拷贝</th>
<th>深拷贝</th>
</tr>
</thead>
<tbody><tr>
<td>区别</td>
<td>创建一个新对象，然后将当前对象的非静态字段复制到该新对象，如果字段是值类型的，那么对该字段执行复制；如果该字段是引用类型的话，则复制<strong>引用但不复制引用的对象</strong>。因此，原始对象及其副本引用同一个对象。</td>
<td>创建一个新对象，然后将当前对象的非静态字段复制到该新对象，无论该字段是值类型的还是引用类型，都<strong>复制独立的一份</strong>。当你修改其中一个对象的任何内容时，都不会影响另一个对象的内容。</td>
</tr>
</tbody></table>
<blockquote>
<p>参考文章：<a href="https://www.cnblogs.com/ysocean/p/8482979.html" target="_blank" rel="noopener">Java的深拷贝和浅拷贝</a></p>
</blockquote>
<h3 id="1-2-为什么需要拷贝对象"><a href="#1-2-为什么需要拷贝对象" class="headerlink" title="1.2 为什么需要拷贝对象"></a>1.2 为什么需要拷贝对象</h3><ol>
<li><code>Entity</code>对应的是持久层数据结构（一般是数据库表的映射模型）;</li>
<li><code>Model</code> 对应的是业务层的数据结构;</li>
<li><code>VO</code> 就是<code>Controller</code>和客户端交互的数据结构。</li>
</ol>
<blockquote>
<p>例如：数据库查询出来的用户信息(表的映射模型)是<code>UserDO</code>，但是我们需要传递给客户端的是<code>UserVO</code>,这时候就需要把<code>UserDO</code>实例的属性一个一个赋值到<code>UserVO</code>实例中。</p>
</blockquote>
<p><strong>在这些数据结构之间很大一部分属性都可能会相同，也可能不同。</strong></p>
<h3 id="1-3-有哪些拷贝方式"><a href="#1-3-有哪些拷贝方式" class="headerlink" title="1.3 有哪些拷贝方式"></a>1.3 有哪些拷贝方式</h3><ol>
<li><code>org.springframework.beans.BeanUtils</code> ；</li>
<li><code>org.springframework.cglib.beans.BeanCopier</code>；</li>
<li><code>ma.glasnost.orika</code>；</li>
<li><code>org.mapstruct</code>（<strong>强烈推荐</strong>）。</li>
</ol>
<h2 id="二、BeanUtils"><a href="#二、BeanUtils" class="headerlink" title="二、BeanUtils"></a>二、<code>BeanUtils</code></h2><blockquote>
<p><code>Spring</code>中的<code>BeanUtils</code>，其中实现的方式很简单，就是对两个对象中相同名字的属性进行简单<code>get/set</code>，仅检查属性的可访问性。</p>
</blockquote>
<p><a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/BeanUtils.html" target="_blank" rel="noopener">BeanUtils 源码</a></p>
<p>可以看到, 成员变量赋值是基于目标对象的成员列表, 并且会跳过<code>ignore</code>的以及在源对象中不存在的, 所以这个方法是安全的, 不会因为两个对象之间的结构差异导致错误, 但是必须保证同名的两个成员变量类型相同。</p>
<h3 id="2-1、单个对象拷贝"><a href="#2-1、单个对象拷贝" class="headerlink" title="2.1、单个对象拷贝"></a>2.1、单个对象拷贝</h3><p>我们把数据库查询出来的<code>UserDO.java</code> 拷贝到 <code>UserVO.java</code>。直接使用<code>BeanUtils.copyProperties()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commonCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserDO userDO = <span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>);</span><br><span class="line">    UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">    BeanUtils.copyProperties(userDO, userVO);</span><br><span class="line">    log.info(<span class="string">"userVO:&#123;&#125;"</span>,userVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVO:UserVO(userId=1, userName=Van, age=18, sex=null)</span><br></pre></td></tr></table></figure>

<h3 id="2-2、集合拷贝"><a href="#2-2、集合拷贝" class="headerlink" title="2.2、集合拷贝"></a>2.2、集合拷贝</h3><p>刚刚拷贝的是一个对象，但是有时候我们想拷贝一组<code>UerDO.java</code>，是一个集合的时候就不能这样直接赋值了。如果还按照这种逻辑，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyFalse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">18</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    BeanUtils.copyProperties(userDOList, userVOList);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVOList:[]</span><br></pre></td></tr></table></figure>

<p>通过日志可以发现，直接拷贝集合是无效的，那么怎么解决呢？</p>
<h3 id="2-3-暴力拷贝（不推荐）"><a href="#2-3-暴力拷贝（不推荐）" class="headerlink" title="2.3 暴力拷贝（不推荐）"></a>2.3 暴力拷贝（不推荐）</h3><blockquote>
<p>将需要拷贝的集合遍历，暴力拷贝。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyCommon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">20</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.forEach(userDO -&gt;&#123;</span><br><span class="line">        UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">        BeanUtils.copyProperties(userDO, userVO);</span><br><span class="line">        userVOList.add(userVO);</span><br><span class="line">    &#125;);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVOList:[UserVO(userId=1, userName=Van, age=18, sex=null), UserVO(userId=2, userName=VanVan, age=20, sex=null)]</span><br></pre></td></tr></table></figure>

<p>虽然该方式可以解决，但是一点都不优雅，特别是写起来麻烦。</p>
<h3 id="2-4-优雅拷贝（本文推荐）"><a href="#2-4-优雅拷贝（本文推荐）" class="headerlink" title="2.4 优雅拷贝（本文推荐）"></a>2.4 优雅拷贝（<strong>本文推荐</strong>）</h3><p>通过<code>JDK 8</code> 的函数式接口封装<code>org.springframework.beans.BeanUtils</code></p>
<ul>
<li>定义一个函数式接口</li>
</ul>
<p>函数式接口里是可以包含默认方法，这里我们定义默认回调方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanUtilCopyCallBack</span> &lt;<span class="title">S</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义默认回调方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">callBack</span><span class="params">(S t, T s)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>封装一个工具类 <code>BeanUtilCopy.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanUtilCopy</span> <span class="keyword">extends</span> <span class="title">BeanUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 集合数据的拷贝</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sources: 数据源类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target: 目标类::new(eg: UserVO::new)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S, T&gt; <span class="function">List&lt;T&gt; <span class="title">copyListProperties</span><span class="params">(List&lt;S&gt; sources, Supplier&lt;T&gt; target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> copyListProperties(sources, target, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 带回调函数的集合数据的拷贝（可自定义字段拷贝规则）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sources: 数据源类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target: 目标类::new(eg: UserVO::new)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callBack: 回调函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S, T&gt; <span class="function">List&lt;T&gt; <span class="title">copyListProperties</span><span class="params">(List&lt;S&gt; sources, Supplier&lt;T&gt; target, BeanUtilCopyCallBack&lt;S, T&gt; callBack)</span> </span>&#123;</span><br><span class="line">        List&lt;T&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(sources.size());</span><br><span class="line">        <span class="keyword">for</span> (S source : sources) &#123;</span><br><span class="line">            T t = target.get();</span><br><span class="line">            copyProperties(source, t);</span><br><span class="line">            list.add(t);</span><br><span class="line">            <span class="keyword">if</span> (callBack != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 回调</span></span><br><span class="line">                callBack.callBack(source, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>简单拷贝测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">20</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = BeanUtilCopy.copyListProperties(userDOList, UserVO::<span class="keyword">new</span>);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">.... userVOList:[UserVO(userId=1, userName=Van, age=18, sex=null), UserVO(userId=2, userName=VanVan, age=20, sex=null)]</span><br></pre></td></tr></table></figure>

<p>通过如上方法，我们基本实现了集合的拷贝，但是从返回结果我们可以发现：<strong>属性不同的字段无法拷贝</strong>。</p>
<p><strong>注意：</strong><br><code>UserDO.java</code> 和<code>UserVO.java</code> 最后一个字段<code>sex</code>类型不一样，分别是：<code>Integer</code>/<code>String</code></p>
<blockquote>
<p><strong>优化一下</strong></p>
</blockquote>
<ul>
<li>新增性别枚举类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SexEnum &#123;</span><br><span class="line">    UNKNOW(<span class="string">"未设置"</span>,<span class="number">0</span>),</span><br><span class="line">    MEN(<span class="string">"男生"</span>, <span class="number">1</span>),</span><br><span class="line">    WOMAN(<span class="string">"女生"</span>,<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    SexEnum(String desc, <span class="keyword">int</span> code) &#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SexEnum <span class="title">getDescByCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        SexEnum[] typeEnums = values();</span><br><span class="line">        <span class="keyword">for</span> (SexEnum value : typeEnums) &#123;</span><br><span class="line">            <span class="keyword">if</span> (code == value.getCode()) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>带特定转换的集合拷贝</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listCopyUpWithCallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">1L</span>, <span class="string">"Van"</span>, <span class="number">18</span>, <span class="number">1</span>));</span><br><span class="line">    userDOList.add(<span class="keyword">new</span> UserDO(<span class="number">2L</span>, <span class="string">"VanVan"</span>, <span class="number">20</span>, <span class="number">2</span>));</span><br><span class="line">    List&lt;UserVO&gt; userVOList = BeanUtilCopy.copyListProperties(userDOList, UserVO::<span class="keyword">new</span>, (userDO, userVO) -&gt; &#123;</span><br><span class="line">        <span class="comment">// 这里可以定义特定的转换规则</span></span><br><span class="line">        userVO.setSex(SexEnum.getDescByCode(userDO.getSex()).getDesc());</span><br><span class="line">    &#125;);</span><br><span class="line">    log.info(<span class="string">"userVOList:&#123;&#125;"</span>,userVOList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">... userVOList:[UserVO(userId=1, userName=Van, age=18, sex=男生), UserVO(userId=2, userName=VanVan, age=20, sex=女生)]</span><br></pre></td></tr></table></figure>

<p>通过打印结果可以发现，<code>UserDO.java</code> 中<code>Integer</code>类型的<code>sex</code>复制到<code>UserVO.java</code>成了<code>String</code>类型的男生/女生。</p>
<h3 id="2-5-小结"><a href="#2-5-小结" class="headerlink" title="2.5 小结"></a>2.5 小结</h3><p>该方法是我们用的最多的方案，这里简单封装下，可以方便集合类型对象的拷贝，平常使用基本够用，仅供参考。</p>
<ol>
<li><a href="https://github.com/vanDusty/Spring-Home/blob/master/spring-case/bean-copy/src/test/java/cn/van/spring/copy/beanutils/BeanUtilsTest.java" target="_blank" rel="noopener">该部分测试代码</a></li>
<li><a href="https://github.com/vanDusty/Spring-Home/tree/master/spring-case/bean-copy/src/main/java/cn/van/spring/copy/beanutils" target="_blank" rel="noopener">完整代码地址</a></li>
</ol>
<h2 id="三、BeanCopier"><a href="#三、BeanCopier" class="headerlink" title="三、BeanCopier"></a>三、<code>BeanCopier</code></h2><p><code>BeanCopier</code>是用于在两个<code>bean</code>之间进行属性拷贝的。<code>BeanCopier</code>支持两种方式:</p>
<ol>
<li>一种是不使用<code>Converter</code>的方式，仅对两个<code>bean</code>间属性名和类型完全相同的变量进行拷贝;</li>
<li>另一种则引入<code>Converter</code>，可以对某些特定属性值进行特殊操作。</li>
</ol>
<h3 id="3-1-常规使用"><a href="#3-1-常规使用" class="headerlink" title="3.1 常规使用"></a>3.1 常规使用</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">normalCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟查询出数据</span></span><br><span class="line">    UserDO userDO = DataUtil.createData();</span><br><span class="line">    log.info(<span class="string">"拷贝前：userDO:&#123;&#125;"</span>, userDO);</span><br><span class="line">    <span class="comment">// 第一个参数：源对象， 第二个参数：目标对象，第三个参数：是否使用自定义转换器（下面会介绍），下同</span></span><br><span class="line">    BeanCopier b = BeanCopier.create(UserDO<span class="class">.<span class="keyword">class</span>, <span class="title">UserDTO</span>.<span class="title">class</span>, <span class="title">false</span>)</span>;</span><br><span class="line">    UserDTO userDTO = <span class="keyword">new</span> UserDTO();</span><br><span class="line">    b.copy(userDO, userDTO, <span class="keyword">null</span>);</span><br><span class="line">    log.info(<span class="string">"拷贝后：userDTO:&#123;&#125;"</span>, userDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">...... 拷贝前：userDO:UserDO(id=1, userName=Van, sex=0, gmtBroth=2019-11-02T18:24:24.077, balance=100)</span><br><span class="line">...... 拷贝后：userDTO:UserDTO(id=1, userName=Van, sex=null)</span><br></pre></td></tr></table></figure>


<p>通过结果发现：<code>UserDO</code>的<code>int</code>类型的<code>sex</code>无法拷贝到<code>UserDTO</code>的<code>Integer</code>的<code>sex</code>。</p>
<p>即：<strong><code>BeanCopier</code>只拷贝名称和类型都相同的属性。</strong></p>
<blockquote>
<p>即使源类型是原始类型(<code>int</code>, <code>short</code>和<code>char</code>等)，目标类型是其包装类型(<code>Integer</code>, <code>Short</code>和<code>Character</code>等)，或反之：都不会被拷贝。 </p>
</blockquote>
<h3 id="3-2-自定义转换器"><a href="#3-2-自定义转换器" class="headerlink" title="3.2 自定义转换器"></a>3.2 自定义转换器</h3><p>通过<code>3.1</code>可知，当源和目标类的属性类型不同时，不能拷贝该属性，此时我们可以通过实现<code>Converter</code>接口来自定义转换器</p>
<ul>
<li>目标对象属性类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDomain</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以下两个字段用户模拟自定义转换</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String gmtBroth;</span><br><span class="line">    <span class="keyword">private</span> String balance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实现<code>Converter</code>接口来自定义属性转换</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="class"><span class="keyword">class</span> <span class="title">UserDomainConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 时间转换的格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DateTimeFormatter dtf = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义属性转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 源对象属性类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 目标对象里属性对应set方法名,eg.setId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 目标对象属性类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">convert</span><span class="params">(Object value, Class target, Object context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> LocalDateTime) &#123;</span><br><span class="line">            LocalDateTime date = (LocalDateTime) value;</span><br><span class="line">            <span class="keyword">return</span> dtf.format(date);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> BigDecimal) &#123;</span><br><span class="line">            BigDecimal bd = (BigDecimal) value;</span><br><span class="line">            <span class="keyword">return</span> bd.toPlainString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更多类型转换请自定义</span></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类型不同,使用Converter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">converterTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟查询出数据</span></span><br><span class="line">    UserDO userDO = DataUtil.createData();</span><br><span class="line">    log.info(<span class="string">"拷贝前：userDO:&#123;&#125;"</span>, userDO);</span><br><span class="line">    BeanCopier copier = BeanCopier.create(UserDO<span class="class">.<span class="keyword">class</span>, <span class="title">UserDomain</span>.<span class="title">class</span>, <span class="title">true</span>)</span>;</span><br><span class="line">    UserDomainConverter converter = <span class="keyword">new</span> UserDomainConverter();</span><br><span class="line">    UserDomain userDomain = <span class="keyword">new</span> UserDomain();</span><br><span class="line">    copier.copy(userDO, userDomain, converter);</span><br><span class="line">    log.info(<span class="string">"拷贝后：userDomain:&#123;&#125;"</span>, userDomain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">...... 拷贝前：userDO:UserDO(id=1, userName=Van, gmtBroth=2019-11-02T19:51:11.985, balance=100)</span><br><span class="line">...... 拷贝后：userDomain:UserDomain(id=1, userName=Van, gmtBroth=2019-11-02 19:51:11, balance=100)</span><br></pre></td></tr></table></figure>

<ul>
<li>注意</li>
</ul>
<ol>
<li>一旦使用<code>Converter</code>，<code>BeanCopier</code>只使用<code>Converter</code>定义的规则去拷贝属性，所以在<code>convert()</code>方法中要考虑所有的属性；</li>
<li>毫无疑问，使用<code>Converter</code>会使对象拷贝速度变慢。</li>
</ol>
<h3 id="3-3-缓存BeanCopier实例提升性能"><a href="#3-3-缓存BeanCopier实例提升性能" class="headerlink" title="3.3 缓存BeanCopier实例提升性能"></a>3.3 缓存<code>BeanCopier</code>实例提升性能</h3><p><code>BeanCopier</code>拷贝速度快，性能瓶颈出现在创建<code>BeanCopier</code>实例的过程中。 所以，把创建过的<code>BeanCopier</code>实例放到缓存中，下次可以直接获取，提升性能。</p>
<ul>
<li>测试代码</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beanCopierWithCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;UserDO&gt; userDOList = DataUtil.createDataList(<span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    userDOList.forEach(userDO -&gt; &#123;</span><br><span class="line">        UserDTO userDTO = <span class="keyword">new</span> UserDTO();</span><br><span class="line">        copy(userDO, userDTO);</span><br><span class="line">        userDTOS.add(userDTO);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存 BeanCopier</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, BeanCopier&gt; BEAN_COPIERS = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(Object srcObj, Object destObj)</span> </span>&#123;</span><br><span class="line">    String key = genKey(srcObj.getClass(), destObj.getClass());</span><br><span class="line">    BeanCopier copier = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!BEAN_COPIERS.containsKey(key)) &#123;</span><br><span class="line">        copier = BeanCopier.create(srcObj.getClass(), destObj.getClass(), <span class="keyword">false</span>);</span><br><span class="line">        BEAN_COPIERS.put(key, copier);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        copier = BEAN_COPIERS.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    copier.copy(srcObj, destObj, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">genKey</span><span class="params">(Class&lt;?&gt; srcClazz, Class&lt;?&gt; destClazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> srcClazz.getName() + destClazz.getName();</span><br><span class="line">&#125;</span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">### 3.3 `BeanCopier`总结</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 当源类和目标类的属性名称、类型都相同，拷贝没问题。</span><br><span class="line"><span class="number">2</span>. 当源对象和目标对象的属性名称相同、类型不同,那么名称相同而类型不同的属性不会被拷贝。注意，原始类型（`<span class="keyword">int</span>`，`<span class="keyword">short</span>`，`<span class="keyword">char</span>`）和 他们的包装类型，在这里都被当成了不同类型，因此不会被拷贝。</span><br><span class="line"><span class="number">3</span>. 源类或目标类的`setter`比`getter`少，拷贝没问题，此时`setter`多余，但是不会报错。</span><br><span class="line"><span class="number">4</span>. 源类和目标类有相同的属性（两者的`getter`都存在），但是目标类的`setter`不存在，此时会抛出`NullPointerException`。</span><br><span class="line"><span class="number">5</span>. 加缓存可以提升拷贝速度。</span><br><span class="line"></span><br><span class="line">### 3.4 示例代码</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. [该部分测试代码](https:<span class="comment">//github.com/vanDusty/Spring-Home/blob/master/spring-case/bean-copy/src/test/java/cn/van/spring/copy/beancopier/BeanCopierTest.java)</span></span><br><span class="line"><span class="number">1</span>. [完整代码地址](https:<span class="comment">//github.com/vanDusty/Spring-Home/tree/master/spring-case/bean-copy/src/main/java/cn/van/spring/copy/beancopier)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 四、`Orika`</span><br><span class="line"></span><br><span class="line">`Orika` 是 `Java Bean` 映射框架，可以实现从一个对象递归拷贝数据至另一个对象。它的优点是：**名字相同类型不同**也能直接复制。</span><br><span class="line"></span><br><span class="line">### 4.1 所需依赖</span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;ma.glasnost.orika&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;orika-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.5.4&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-映射工具类"><a href="#4-2-映射工具类" class="headerlink" title="4.2 映射工具类"></a>4.2 映射工具类</h3><p>使用枚举实现的单例模式创建一个映射工具类，便于测试。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> MapperUtils &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认字段工厂</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MapperFactory MAPPER_FACTORY = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认字段实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MapperFacade MAPPER_FACADE = MAPPER_FACTORY.getMapperFacade();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认字段实例集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, MapperFacade&gt; CACHE_MAPPER_FACADE_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 映射实体（默认字段）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toClass 映射类对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    数据（对象）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 映射类对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E, T&gt; <span class="function">E <span class="title">map</span><span class="params">(Class&lt;E&gt; toClass, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MAPPER_FACADE.map(data, toClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 映射实体（自定义配置）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toClass   映射类对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data      数据（对象）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configMap 自定义配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 映射类对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E, T&gt; <span class="function">E <span class="title">map</span><span class="params">(Class&lt;E&gt; toClass, T data, Map&lt;String, String&gt; configMap)</span> </span>&#123;</span><br><span class="line">        MapperFacade mapperFacade = <span class="keyword">this</span>.getMapperFacade(toClass, data.getClass(), configMap);</span><br><span class="line">        <span class="keyword">return</span> mapperFacade.map(data, toClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 映射集合（默认字段）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toClass 映射类对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    数据（集合）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 映射类对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E, T&gt; <span class="function">List&lt;E&gt; <span class="title">mapAsList</span><span class="params">(Class&lt;E&gt; toClass, Collection&lt;T&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MAPPER_FACADE.mapAsList(data, toClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 映射集合（自定义配置）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toClass   映射类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data      数据（集合）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configMap 自定义配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 映射类对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;E, T&gt; <span class="function">List&lt;E&gt; <span class="title">mapAsList</span><span class="params">(Class&lt;E&gt; toClass, Collection&lt;T&gt; data, Map&lt;String, String&gt; configMap)</span> </span>&#123;</span><br><span class="line">        T t = data.stream().findFirst().orElseThrow(() -&gt; <span class="keyword">new</span> ExceptionInInitializerError(<span class="string">"映射集合，数据集合为空"</span>));</span><br><span class="line">        MapperFacade mapperFacade = <span class="keyword">this</span>.getMapperFacade(toClass, t.getClass(), configMap);</span><br><span class="line">        <span class="keyword">return</span> mapperFacade.mapAsList(data, toClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取自定义映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toClass   映射类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataClass 数据映射类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configMap 自定义配置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 映射类对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> &lt;E, T&gt; <span class="function">MapperFacade <span class="title">getMapperFacade</span><span class="params">(Class&lt;E&gt; toClass, Class&lt;T&gt; dataClass, Map&lt;String, String&gt; configMap)</span> </span>&#123;</span><br><span class="line">        String mapKey = dataClass.getCanonicalName() + <span class="string">"_"</span> + toClass.getCanonicalName();</span><br><span class="line">        MapperFacade mapperFacade = CACHE_MAPPER_FACADE_MAP.get(mapKey);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(mapperFacade)) &#123;</span><br><span class="line">            MapperFactory factory = <span class="keyword">new</span> DefaultMapperFactory.Builder().build();</span><br><span class="line">            ClassMapBuilder classMapBuilder = factory.classMap(dataClass, toClass);</span><br><span class="line">            configMap.forEach(classMapBuilder::field);</span><br><span class="line">            classMapBuilder.byDefault().register();</span><br><span class="line">            mapperFacade = factory.getMapperFacade();</span><br><span class="line">            CACHE_MAPPER_FACADE_MAP.put(mapKey, mapperFacade);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mapperFacade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个工具类中主要有四个方法：</li>
</ul>
<ol>
<li><p><code>map(Class toClass, T data)</code>：普通的映射实体，主要映射名称相同（类型可以不同）的字段；</p>
</li>
<li><p><code>map(Class toClass, T data, Map&lt;String, String&gt; configMap)</code>：自定义配置的映射，映射名称不同时，自定义映射对应名称；</p>
</li>
<li><p><code>mapAsList(Class toClass, Collection data)</code>：普通的集合的映射；</p>
</li>
<li><p><code>mapAsList(Class toClass, Collection data, Map&lt;String, String&gt; configMap)</code>：自定义的集合映射，自定义映射对应名称。</p>
</li>
</ol>
<h3 id="4-3-简单测试"><a href="#4-3-简单测试" class="headerlink" title="4.3 简单测试"></a>4.3 简单测试</h3><ul>
<li>拷贝名称相同类型可不同的属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">normalCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟查询出数据</span></span><br><span class="line">    UserDO userDO = DataUtil.createData();</span><br><span class="line">    log.info(<span class="string">"拷贝前：userDO:&#123;&#125;"</span>, userDO);</span><br><span class="line">    <span class="comment">// 第一个参数：源对象， 第二个参数：目标对象，第三个参数：是否使用自定义转换器（下面会介绍），下同</span></span><br><span class="line">    UserDTO userDTO = MapperUtils.INSTANCE.map(UserDTO<span class="class">.<span class="keyword">class</span>, <span class="title">userDO</span>)</span>;;</span><br><span class="line">    log.info(<span class="string">"拷贝后：userDTO:&#123;&#125;"</span>, userDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>字段名称不同，带翻译</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">converterTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟查询出数据</span></span><br><span class="line">    UserDO userDO = DataUtil.createData();</span><br><span class="line">    Map&lt;String, String&gt; config = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 自定义配置(balance 转 balances)</span></span><br><span class="line">    config.put(<span class="string">"balance"</span>, <span class="string">"balances"</span>);</span><br><span class="line">    log.info(<span class="string">"拷贝前：userDO:&#123;&#125;"</span>, userDO);</span><br><span class="line">    UserDomain userDomain = MapperUtils.INSTANCE.map(UserDomain<span class="class">.<span class="keyword">class</span>, <span class="title">userDO</span>, <span class="title">config</span>)</span>;</span><br><span class="line">    log.info(<span class="string">"拷贝后：userDomain:&#123;&#125;"</span>, userDomain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝集合</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beanCopierWithCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserDO&gt; userDOList = DataUtil.createDataList(<span class="number">3</span>);</span><br><span class="line">    log.info(<span class="string">"拷贝前：userDOList:&#123;&#125;"</span>, userDOList);</span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = MapperUtils.INSTANCE.mapAsList(UserDTO<span class="class">.<span class="keyword">class</span>,<span class="title">userDOList</span>)</span>;</span><br><span class="line">    log.info(<span class="string">"拷贝后：userDTOS:&#123;&#125;"</span>, userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、MapStruct"><a href="#五、MapStruct" class="headerlink" title="五、MapStruct"></a>五、<code>MapStruct</code></h2><p><code>MapStruct</code> 是一个自动生成 <code>bean</code> 映射类的<strong>代码生成器</strong>。<code>MapStruct</code> 还能够在不同的数据类型之间进行转换。</p>
<h3 id="5-1-所需依赖"><a href="#5-1-所需依赖" class="headerlink" title="5.1 所需依赖"></a>5.1 所需依赖</h3><ul>
<li><code>mapstruct-jdk8</code></li>
</ul>
<blockquote>
<p>包含所需的注释，例如<code>@Mapping</code>。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>mapstruct-processor</code></li>
</ul>
<blockquote>
<p>在编译，生成映射器实现的注释处理器。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-如何使用？"><a href="#5-2-如何使用？" class="headerlink" title="5.2 如何使用？"></a>5.2 如何使用？</h3><p>您所要做的就是定义一个<code>mapper</code>接口，该接口声明任何所需的映射方法。在编译期间，<code>MapStruct</code>将生成此接口的实现。此实现使用普通的<code>Java</code>方法调用来在源对象和目标对象之间进行映射。</p>
<ul>
<li>创建<code>Mapper</code></li>
</ul>
<p>利用<code>@Mapper</code>注解标注该接口/抽象类是被<code>MapStruct</code>自动映射的，只有存在该注解才会将内部的接口方法自动实现。</p>
<ul>
<li>获取<code>Mapper</code></li>
</ul>
<p><code>MapStruct</code>为我们提供了多种的获取<code>Mapper</code>的方式，习惯用默认配置：采用<code>Mappers</code>通过动态工厂内部反射机制完成<code>Mapper</code>实现类的获取。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">UserConvertUtils INSTANCE = Mappers.getMapper(UserConvertUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>完整的一个转换器<code>demo</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserConvertUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    UserConvertUtils INSTANCE = Mappers.getMapper(UserConvertUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通的映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDO UserDO数据持久层类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据传输类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">UserDTO <span class="title">doToDTO</span><span class="params">(UserDO userDO)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型转换的映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDO UserDO数据持久层类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据传输类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Mappings</span>(&#123;</span><br><span class="line">            <span class="meta">@Mapping</span>(target = <span class="string">"gmtBroth"</span>, source = <span class="string">"gmtBroth"</span>, dateFormat = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>),</span><br><span class="line">            <span class="meta">@Mapping</span>(target = <span class="string">"balances"</span>, source = <span class="string">"balance"</span>),</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function">UserDTO <span class="title">doToDtoWithConvert</span><span class="params">(UserDO userDO)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一般拷贝</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">normalCopy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟查询出数据</span></span><br><span class="line">    UserDO userDO = DataUtil.createData();</span><br><span class="line">    log.info(<span class="string">"拷贝前：userDO:&#123;&#125;"</span>, userDO);</span><br><span class="line">    UserDTO userDTO = UserConvertUtils.INSTANCE.doToDTO(userDO);</span><br><span class="line">    log.info(<span class="string">"拷贝后：userDTO:&#123;&#125;"</span>, userDTO);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 包含类型转换的拷贝</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doToDtoWithConvert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 模拟查询出数据</span></span><br><span class="line">    UserDO userDO = DataUtil.createData();</span><br><span class="line">    log.info(<span class="string">"拷贝前：userDO:&#123;&#125;"</span>, userDO);</span><br><span class="line">    UserDTO userDTO = UserConvertUtils.INSTANCE.doToDtoWithConvert(userDO);</span><br><span class="line">    log.info(<span class="string">"拷贝后：userDTO:&#123;&#125;"</span>, userDTO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>打印映射结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">一般拷贝:</span><br><span class="line">...拷贝前：userDO:UserDO(id=1, userName=Van, gmtBroth=2020-04-21T21:38:39.376, balance=100)</span><br><span class="line">...拷贝后：userDTO:UserDTO(id=1, userName=Van, gmtBroth=2020-04-21T21:38:39.376, balances=null)</span><br><span class="line">包含类型转换的拷贝:</span><br><span class="line">...拷贝前：userDO:UserDO(id=1, userName=Van, gmtBroth=2020-04-21T21:05:19.282, balance=100)</span><br><span class="line">...拷贝后：userDTO:UserDTO(id=1, userName=Van, gmtBroth=2020-04-21 21:05:19, balances=100)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过打印结果可以发现：相较于前者，包含类型转换的拷贝可以自定义转换属性和时间格式等。</p>
</blockquote>
<h3 id="5-3-MapStruct-注解的关键词"><a href="#5-3-MapStruct-注解的关键词" class="headerlink" title="5.3 MapStruct 注解的关键词"></a>5.3 <code>MapStruct</code> 注解的关键词</h3><ol>
<li><code>@Mapper</code>：只有在接口加上这个注解， <code>MapStruct</code> 才会去实现该接口；</li>
<li><code>@Mappings</code>：配置多个<code>@Mapping</code>；</li>
<li><code>@Mapping</code>：属性映射，若源对象属性与目标对象名字一致，会自动映射对应属性：</li>
</ol>
<blockquote>
</blockquote>
<ol>
<li><code>source</code>：源属性；</li>
<li><code>target</code>：目标属性；</li>
<li><code>dateFormat</code>：字符串与日期之间相互转换；</li>
<li><code>ignore</code>: 忽略这个，某个属性不想映射，可以加个 <code>ignore=true</code>；</li>
</ol>
<h3 id="5-4-多对一"><a href="#5-4-多对一" class="headerlink" title="5.4 多对一"></a>5.4 多对一</h3><p><code>MapStruct</code> 可以将几种类型的对象映射为另外一种类型，比如将多个 <code>DO</code> 对象转换为 <code>DTO</code>。</p>
<p>详见：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">UserDTO <span class="title">doAndInfoToDto</span><span class="params">(UserDO userDO, UserInfoDO userInfoDO)</span></span>;</span><br></pre></td></tr></table></figure>


<h3 id="5-5-为什么要用-MapStruct"><a href="#5-5-为什么要用-MapStruct" class="headerlink" title="5.5 为什么要用 MapStruct"></a>5.5 为什么要用 <code>MapStruct</code></h3><p>与手工编写映射代码相比，<code>MapStruct</code>通过生成繁琐且易于编写的代码来节省时间。遵循约定优于配置方法，<code>MapStruct</code>使用合理的默认值，但在配置或实现特殊行为时会采取措施。</p>
<p>与动态映射框架相比，<code>MapStruct</code>具有以下优势：</p>
<ol>
<li>通过使用普通方法调用而不是反射来快速执行</li>
<li>编译时类型安全：只能映射相互映射的对象和属性，不会将订单实体意外映射到客户<code>DTO</code>等。</li>
<li>在构建时清除错误报告，如果映射不完整（并非所有目标属性都已映射）映射不正确（找不到合适的映射方法或类型转换）</li>
</ol>
<h3 id="5-6-示例代码"><a href="#5-6-示例代码" class="headerlink" title="5.6 示例代码"></a>5.6 示例代码</h3><ol>
<li><a href="https://github.com/vanDusty/Spring-Home/blob/master/spring-case/bean-copy/src/test/java/cn/van/spring/copy/mapstruct/MapStructTest.java" target="_blank" rel="noopener">该部分测试代码</a></li>
<li><a href="https://github.com/vanDusty/Spring-Home/tree/master/spring-case/bean-copy/src/main/java/cn/van/spring/copy/mapstruct" target="_blank" rel="noopener">完整代码地址</a></li>
</ol>
<h2 id="六、更多"><a href="#六、更多" class="headerlink" title="六、更多"></a>六、更多</h2><p>通过四种属性拷贝的方式，加上自己手动<code>get/set</code>，仅给出以下建议：</p>
<ol>
<li>简单拷贝直接使用<code>get/set</code>；</li>
<li>属性值过多的拷贝且已经使用<code>Spring</code>的情况下，使用<code>BeanUtils</code>;</li>
<li>属性拷贝比较麻烦，存在转译且对拷贝速度有要求时使用<code>MapStruct</code>(性能几乎等同于直接<code>get/set</code>)。</li>
</ol>
<p>具体性能，参考文章：<a href="https://juejin.im/post/5c9d5cd1e51d455788281089" target="_blank" rel="noopener">Java Bean Copy 性能大比拼</a></p>
<p><a href="https://github.com/vanDusty/Frame-Home/tree/master/spring-case/bean-copy" target="_blank" rel="noopener">该模块完整 Github 示例源码</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Bean</tag>
      </tags>
  </entry>
  <entry>
    <title>以商品超卖为例讲解分布式锁</title>
    <url>/2019/09/23/7a650ee1.html</url>
    <content><![CDATA[<blockquote>
<p>本案例主要讲解<code>Redis</code>实现分布式锁的两种实现方式：<code>Jedis</code>实现、<code>Redisson</code>实现。网上关于这方面讲解太多了，Van自认为文笔没他们好，还是用示例代码说明。</p>
</blockquote>
<a id="more"></a>

<h1 id="一、jedis-实现"><a href="#一、jedis-实现" class="headerlink" title="一、jedis 实现"></a>一、<code>jedis</code> 实现</h1><blockquote>
<p>该方案只考虑<code>Redis</code>单机部署的场景</p>
</blockquote>
<h2 id="1-1-加锁"><a href="#1-1-加锁" class="headerlink" title="1.1 加锁"></a>1.1 加锁</h2><h3 id="1-1-1-原理"><a href="#1-1-1-原理" class="headerlink" title="1.1.1 原理"></a>1.1.1 原理</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jedis.set(String key, String value, String nxxx, String expx, <span class="keyword">int</span> time)</span><br></pre></td></tr></table></figure>

<ol>
<li><code>key</code>: 使用<code>key</code>来当锁，因为<code>key</code>是唯一的;</li>
<li><code>value</code>: 我传的是唯一值（<code>UUID</code>），很多童鞋可能不明白，有<code>key</code>作为锁不就够了吗，为什么还要用到<code>value</code>？原因是分布式锁要满足<strong>解铃还须系铃人</strong>：通过给<code>value</code>赋值为<code>requestId</code>，我们就知道这把锁是哪个请求加的了，在解锁的时候要验证<code>value</code>值，不能误解锁;</li>
<li><code>nxxx</code>: 这个参数我填的是<code>NX</code>，意思是<code>SET IF NOT EXIST</code>，即当<code>key</code>不存在时，我们进行<code>set</code>操作；若<code>key</code>已经存在，则不做任何操作；</li>
<li><code>expx</code>: 这个参数我传的是<code>PX</code>，意思是我们要给这个<code>key</code>加一个过期的设置，具体时间由第五个参数决定;</li>
<li><code>time</code>: 与第四个参数相呼应，代表<code>key</code>的过期时间。</li>
</ol>
<h3 id="1-1-2-小结"><a href="#1-1-2-小结" class="headerlink" title="1.1.2 小结"></a>1.1.2 小结</h3><ul>
<li><code>set()</code>加入了<code>NX</code>参数，可以保证如果已有<code>key</code>存在，则函数不会调用成功，也就是只有一个客户端能持有锁，满足互斥性;</li>
<li>其次，由于我们对锁设置了过期时间，即使锁的持有者后续发生崩溃而没有解锁，锁也会因为到了过期时间而自动解锁（即<code>key</code>被删除），不会发生死锁;</li>
<li>最后，因为我们将<code>value</code>赋值为<code>requestId</code>，代表加锁的客户端请求标识，那么在客户端在解锁的时候就可以进行校验是否是同一个客户端。</li>
</ul>
<h2 id="1-2-释放锁"><a href="#1-2-释放锁" class="headerlink" title="1.2 释放锁"></a>1.2 释放锁</h2><blockquote>
<p>释放锁时需要验证<code>value</code>值，也就是说我们在获取锁的时候需要设置一个<code>value</code>，不能直接用<code>del key</code>这种粗暴的方式，因为直接<code>del key</code>任何客户端都可以进行解锁了，所以解锁时，我们需要判断锁是否是自己的(基于<code>value</code>值来判断)</p>
</blockquote>
<ol>
<li>首先,写了一个简单<code>Lua</code>脚本代码,作用是：获取锁对应的<code>value</code>值，检查是否与<code>requestId</code>相等，如果相等则删除锁（解锁）;</li>
<li>然后,将<code>Lua</code>代码传到<code>jedis.eval()</code>方法里，并使参数<code>KEYS[1]</code>赋值为<code>lockKey</code>，<code>ARGV[1]</code>赋值为<code>requestId</code>。<code>eval()</code>方法是将<code>Lua</code>代码交给Redis服务端执行。</li>
</ol>
<h2 id="1-3-案例（家庭多人领取奖励的场景）"><a href="#1-3-案例（家庭多人领取奖励的场景）" class="headerlink" title="1.3 案例（家庭多人领取奖励的场景）"></a>1.3 案例（家庭多人领取奖励的场景）</h2><blockquote>
<p>这里放出的是关键代码，详细可运行的代码可至文末地址下载示例代码。</p>
</blockquote>
<h3 id="1-3-1-准备"><a href="#1-3-1-准备" class="headerlink" title="1.3.1 准备"></a>1.3.1 准备</h3><p>该案例模拟家庭内多人通过领取一个奖励，但是只能有一个人能领取成功，不能重复领取（之前做过奖励模块的需求）</p>
<ul>
<li><code>family_reward_record</code>表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`family_reward_record`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键id'</span>,</span><br><span class="line">  <span class="string">`family_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line">  <span class="string">`reward_type`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'1'</span> <span class="keyword">COMMENT</span> <span class="string">'商品库存数量'</span>,</span><br><span class="line">  <span class="string">`state`</span> <span class="built_in">int</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'商品状态'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'入库时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">270</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_unicode_ci <span class="keyword">COMMENT</span>=<span class="string">'家庭领取奖励表（家庭内多人只能有一个人能领取成功，不能重复领取）'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>application.yml</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql://47.98.178.84:3306/dev</span><br><span class="line">    username: dev</span><br><span class="line">    password: password</span><br><span class="line">    driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">  redis:</span><br><span class="line">    host: 47.98.178.84</span><br><span class="line">    port: 6379</span><br><span class="line">    password: password</span><br><span class="line">    timeout: 2000</span><br><span class="line"># mybatis</span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:mapper/*.xml</span><br><span class="line">  type-aliases-package: cn.van.mybatis.demo.entity</span><br></pre></td></tr></table></figure>

<h3 id="1-3-2-核心实现"><a href="#1-3-2-核心实现" class="headerlink" title="1.3.2 核心实现"></a>1.3.2 核心实现</h3><ul>
<li>Jedis 单机配置类 - <code>RedisConfig.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.host&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.timeout&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> timeout;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisPool <span class="title">redisPoolFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JedisPool(jedisPoolConfig, host, port, timeout);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisPool(jedisPoolConfig, host, port, timeout, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"redisTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, Visibility.ANY);</span><br><span class="line">        objectMapper.enableDefaultTyping(DefaultTyping.NON_FINAL);</span><br><span class="line"></span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        jsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        redisTemplate.setDefaultSerializer(jsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>分布式锁工具类 - <code>RedisDistributedLock.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisDistributedLock</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功获取锁标示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCK_SUCCESS = <span class="string">"OK"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功解锁标示</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Long RELEASE_SUCCESS = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JedisPool jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis 数据存储过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> expireTime = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 尝试获取分布式锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey 锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockValue 请求标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否获取成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String lockKey, String lockValue)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            String result = jedis.set(lockKey, lockValue, <span class="string">"NX"</span>, <span class="string">"PX"</span>, expireTime);</span><br><span class="line">            <span class="keyword">if</span> (LOCK_SUCCESS.equals(result)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)&#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放分布式锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey 锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockValue 请求标识</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否释放成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">unLock</span><span class="params">(String lockKey, String lockValue)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            String script = <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line">            Object result = jedis.eval(script, Collections.singletonList(lockKey), Collections.singletonList(lockValue));</span><br><span class="line">            <span class="keyword">if</span> (RELEASE_SUCCESS.equals(result)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)&#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不加锁时：模拟 <code>familyId = 1</code> 的家庭同时领取奖励</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">receiveAward</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Long familyId = <span class="number">1L</span>;</span><br><span class="line">    Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">16</span>);</span><br><span class="line">    params.put(<span class="string">"familyId"</span>, familyId);</span><br><span class="line">    params.put(<span class="string">"rewardType"</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> count = familyRewardRecordMapper.selectCountByFamilyIdAndRewardType(params);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        FamilyRewardRecordDO recordDO = <span class="keyword">new</span> FamilyRewardRecordDO(familyId,<span class="number">1</span>,<span class="number">0</span>,LocalDateTime.now());</span><br><span class="line">        <span class="keyword">int</span> num = familyRewardRecordMapper.insert(recordDO);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> HttpResult.success();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.failure(-<span class="number">1</span>, <span class="string">"记录插入失败"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpResult.success(<span class="string">"该记录已存在"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>加锁的实现：模拟 <code>familyId = 2</code> 的家庭同时领取奖励</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">receiveAwardLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Long familyId = <span class="number">2L</span>;</span><br><span class="line">    Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">16</span>);</span><br><span class="line">    params.put(<span class="string">"familyId"</span>, familyId);</span><br><span class="line">    params.put(<span class="string">"rewardType"</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> count = familyRewardRecordMapper.selectCountByFamilyIdAndRewardType(params);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有记录则创建领取记录</span></span><br><span class="line">        FamilyRewardRecordDO recordDO = <span class="keyword">new</span> FamilyRewardRecordDO(familyId,<span class="number">1</span>,<span class="number">0</span>,LocalDateTime.now());</span><br><span class="line">        <span class="comment">// 分布式锁的key(familyId + rewardType)</span></span><br><span class="line">        String lockKey = recordDO.getFamilyId() + <span class="string">"_"</span> + recordDO.getRewardType();</span><br><span class="line">        <span class="comment">// 分布式锁的value(唯一值)</span></span><br><span class="line">        String lockValue = createUUID();</span><br><span class="line">        <span class="keyword">boolean</span> lockStatus = redisLock.tryLock(lockKey, lockValue);</span><br><span class="line">        <span class="comment">// 锁被占用</span></span><br><span class="line">        <span class="keyword">if</span> (!lockStatus) &#123;</span><br><span class="line">            log.info(<span class="string">"锁已经占用了"</span>);</span><br><span class="line">            <span class="keyword">return</span> HttpResult.failure(-<span class="number">1</span>,<span class="string">"失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 不管多个请求，加锁之后，只会有一个请求能拿到锁，进行插入操作</span></span><br><span class="line">        log.info(<span class="string">"拿到了锁，当前时刻:&#123;&#125;"</span>,System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> num = familyRewardRecordMapper.insert(recordDO);</span><br><span class="line">        <span class="keyword">if</span> (num != <span class="number">1</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"数据插入失败！"</span>);</span><br><span class="line">            <span class="keyword">return</span> HttpResult.failure(-<span class="number">1</span>, <span class="string">"数据插入失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"数据插入成功！准备解锁..."</span>);</span><br><span class="line">        <span class="keyword">boolean</span> unLockState = redisLock.unLock(lockKey,lockValue);</span><br><span class="line">        <span class="keyword">if</span> (!unLockState) &#123;</span><br><span class="line">            log.info(<span class="string">"解锁失败！"</span>);</span><br><span class="line">            <span class="keyword">return</span> HttpResult.failure(-<span class="number">1</span>, <span class="string">"解锁失败！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"解锁成功！"</span>);</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success();</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">"该记录已存在"</span>);</span><br><span class="line">    <span class="keyword">return</span> HttpResult.success(<span class="string">"该记录已存在"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">createUUID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UUID uuid = UUID.randomUUID();</span><br><span class="line">    String str = uuid.toString().replace(<span class="string">"-"</span>, <span class="string">"_"</span>);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-3-测试"><a href="#1-3-3-测试" class="headerlink" title="1.3.3 测试"></a>1.3.3 测试</h3><blockquote>
<p>我采用的是<code>JMeter</code>工具进行测试，加锁和不加锁的情况都设置成：五次并发请求。 </p>
</blockquote>
<h4 id="1-3-3-1-不加锁"><a href="#1-3-3-1-不加锁" class="headerlink" title="1.3.3.1 不加锁"></a>1.3.3.1 不加锁</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 家庭成员领取奖励（不加锁）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/receiveAward"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">receiveAward</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> redisLockService.receiveAward();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>请求方式：<code>POST</code></li>
<li>请求地址：<a href="http://localhost:8080/redisLock/receiveAward" target="_blank" rel="noopener">http://localhost:8080/redisLock/receiveAward</a></li>
<li>返回结果：插入了五条记录</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/22/16d5954bbfcd6d44?w=1098&h=380&f=png&s=168694" alt=""></p>
<h4 id="1-3-3-2-加锁"><a href="#1-3-3-2-加锁" class="headerlink" title="1.3.3.2 加锁"></a>1.3.3.2 加锁</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 家庭成员领取奖励（加锁）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/receiveAwardLock"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">receiveAwardLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> redisLockService.receiveAwardLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>请求方式：<code>POST</code></li>
<li>请求地址：<a href="http://localhost:8080/redisLock/receiveAwardLock" target="_blank" rel="noopener">http://localhost:8080/redisLock/receiveAwardLock</a></li>
<li>返回结果：只插入了一条记录</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/22/16d595509316deb1?w=1092&h=492&f=png&s=201895" alt=""></p>
<blockquote>
<p>通过对比，说明分布式锁起作用了。</p>
</blockquote>
<h2 id="1-4-小结"><a href="#1-4-小结" class="headerlink" title="1.4 小结"></a>1.4 小结</h2><p>我上家使用的就是这种加锁方式，看上去很OK，实际上在<code>Redis</code>集群的时候会出现问题，比如：</p>
<p><code>A</code>客户端在<code>Redis</code>的<code>master</code>节点上拿到了锁，但是这个加锁的<code>key</code>还没有同步到<code>slave</code>节点，<code>master</code>故障，发生故障转移，一个<code>slave</code>节点升级为<code>master</code>节点，<code>B</code>客户端也可以获取同个<code>key</code>的锁，但客户端<code>A</code>也已经拿到锁了，这就导致多个客户端都拿到锁。</p>
<p>正因为如此，<code>Redis</code>作者<code>antirez</code>基于分布式环境下提出了一种更高级的分布式锁的实现方式：<code>Redlock</code>。</p>
<h1 id="二、Redlock实现"><a href="#二、Redlock实现" class="headerlink" title="二、Redlock实现"></a>二、<code>Redlock</code>实现</h1><h2 id="2-1-原理"><a href="#2-1-原理" class="headerlink" title="2.1 原理"></a>2.1 原理</h2><p><code>antirez</code>提出的<code>Redlock</code>算法大概是这样的：</p>
<p>在<code>Redis</code>的分布式环境中，我们假设有<code>N</code>个<code>Redis master</code>。这些节点完全互相独立，不存在主从复制或者其他集群协调机制。我们确保将在<code>N</code>个实例上使用与在<code>Redis</code>单实例下相同方法获取和释放锁。现在我们假设有<code>5</code>个<code>Redis master</code>节点，同时我们需要在<code>5</code>台服务器上面运行这些<code>Redis</code>实例，这样保证他们不会同时都宕掉。</p>
<h3 id="2-1-1-加锁"><a href="#2-1-1-加锁" class="headerlink" title="2.1.1 加锁"></a>2.1.1 加锁</h3><p>为了取到锁，客户端应该执行以下操作(<code>RedLock</code>算法加锁步骤):</p>
<ol>
<li>获取当前<code>Unix</code>时间，以毫秒为单位;</li>
<li>依次尝试从<code>5</code>个实例，使用相同的<code>key</code>和具有唯一性的<code>value</code>（例如<code>UUID</code>）获取锁。当向<code>Redis</code>请求获取锁时，客户端应该设置一个网络连接和响应超时时间，这个超时时间应该小于锁的失效时间。例如你的锁自动失效时间为<code>10</code>秒，则超时时间应该在<code>5-50</code>毫秒之间。这样可以避免服务器端<code>Redis</code>已经挂掉的情况下，客户端还在死死地等待响应结果。如果服务器端没有在规定时间内响应，客户端应该尽快尝试去另外一个<code>Redis</code>实例请求获取锁;</li>
<li>客户端使用当前时间减去开始获取锁时间（步骤<code>1</code>记录的时间）就得到获取锁使用的时间。当且仅当从大多数（<code>N/2+1</code>，这里是<code>3</code>个节点）的<code>Redis</code>节点都取到锁，并且使用的时间小于锁失效时间时，锁才算获取成功;</li>
<li>如果取到了锁，<code>key</code>的真正有效时间等于有效时间减去获取锁所使用的时间（步骤<code>3</code>计算的结果）。</li>
<li>如果因为某些原因，获取锁失败（没有在至少<code>N/2+1</code>个<code>Redis</code>实例取到锁或者取锁时间已经超过了有效时间），客户端应该在所有的<code>Redis</code>实例上进行解锁（即便某些<code>Redis</code>实例根本就没有加锁成功，防止某些节点获取到锁但是客户端没有得到响应而导致接下来的一段时间不能被重新获取锁）。</li>
</ol>
<h3 id="2-1-2-解锁"><a href="#2-1-2-解锁" class="headerlink" title="2.1.2 解锁"></a>2.1.2 解锁</h3><p>向所有的<code>Redis</code>实例发送释放锁命令即可，不用关心之前有没有从<code>Redis</code>实例成功获取到锁.</p>
<h2 id="2-2-案例（商品超卖为例）"><a href="#2-2-案例（商品超卖为例）" class="headerlink" title="2.2 案例（商品超卖为例）"></a>2.2 案例（商品超卖为例）</h2><blockquote>
<p>这部分以最常见的案例：抢购时的商品超卖（库存数减少为负数）为例</p>
</blockquote>
<h3 id="2-2-1-准备"><a href="#2-2-1-准备" class="headerlink" title="2.2.1 准备"></a>2.2.1 准备</h3><ul>
<li><code>good</code>表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`good`</span> (</span><br><span class="line">                      <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键id'</span>,</span><br><span class="line">                      <span class="string">`good_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line">                      <span class="string">`good_counts`</span> <span class="built_in">int</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品库存'</span>,</span><br><span class="line">                      <span class="string">`create_time`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">                      PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">3</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'商品表'</span>;</span><br><span class="line"><span class="comment">-- 插入两条测试数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`good`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'哇哈哈'</span>, <span class="number">5</span>, <span class="string">'2019-09-20 17:39:04'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`good`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'卫龙'</span>, <span class="number">5</span>, <span class="string">'2019-09-20 17:39:06'</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>配置文件跟上面一样</li>
</ul>
<h3 id="2-2-2-核心实现"><a href="#2-2-2-核心实现" class="headerlink" title="2.2.2 核心实现"></a>2.2.2 核心实现</h3><ul>
<li><code>Redisson</code> 配置类 <code>RedissonConfig.java</code></li>
</ul>
<blockquote>
<p>我这里配置的是单机，更多配置详见<a href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95" target="_blank" rel="noopener">https://github.com/redisson/redisson/wiki/配置</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedissonConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.host&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.redis.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RedissonClient,单机模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redissonSentinel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//支持单机，主从，哨兵，集群等模式,此为单机模式</span></span><br><span class="line">        </span><br><span class="line">        Config config = <span class="keyword">new</span> Config();</span><br><span class="line">        config.useSingleServer()</span><br><span class="line">                .setAddress(<span class="string">"redis://"</span> + host + <span class="string">":"</span> + port)</span><br><span class="line">                .setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不加锁时</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">saleGoods</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 以指定goodId = 1：哇哈哈为例</span></span><br><span class="line">    Long goodId = <span class="number">1L</span>;</span><br><span class="line">    GoodDO goodDO = goodMapper.selectByPrimaryKey(goodId);</span><br><span class="line">    <span class="keyword">int</span> goodStock = goodDO.getGoodCounts();</span><br><span class="line">    <span class="keyword">if</span> (goodStock &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        goodMapper.saleOneGood(goodId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>加锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">saleGoodsLock</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 以指定goodId = 2：卫龙为例</span></span><br><span class="line">    Long goodId = <span class="number">2L</span>;</span><br><span class="line">    GoodDO goodDO = goodMapper.selectByPrimaryKey(goodId);</span><br><span class="line">    <span class="keyword">int</span> goodStock = goodDO.getGoodCounts();</span><br><span class="line">    String key = goodDO.getGoodName();</span><br><span class="line">    log.info(<span class="string">"&#123;&#125;剩余总库存,&#123;&#125;件"</span>, key,goodStock);</span><br><span class="line">    <span class="comment">// 将商品的实时库存放在redis 中，便于读取</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, Integer.toString(goodStock));</span><br><span class="line">    <span class="comment">// redisson 锁 的key</span></span><br><span class="line">    String lockKey = goodDO.getId() +<span class="string">"_"</span> + key;</span><br><span class="line">    RLock lock = redissonClient.getLock(lockKey);</span><br><span class="line">    <span class="comment">// 设置60秒自动释放锁  （默认是30秒自动过期）</span></span><br><span class="line">    lock.lock(<span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">// 此步开始，串行销售</span></span><br><span class="line">    <span class="keyword">int</span> stock = Integer.parseInt(stringRedisTemplate.opsForValue().get(key));</span><br><span class="line">    <span class="comment">// 如果缓存中库存量大于1，可以继续销售</span></span><br><span class="line">    <span class="keyword">if</span> (stock &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">        goodDO.setGoodCounts(stock - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> num = goodMapper.saleOneGood(goodId);</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 减库存成功，将缓存同步</span></span><br><span class="line">            stringRedisTemplate.opsForValue().set(key,Integer.toString((stock-<span class="number">1</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;,当前库存,&#123;&#125;件"</span>, key,stock);</span><br><span class="line">    &#125;</span><br><span class="line">    lock.unlock();</span><br><span class="line">    <span class="keyword">return</span> HttpResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-测试"><a href="#2-3-测试" class="headerlink" title="2.3 测试"></a>2.3 测试</h3><blockquote>
<p>采用的是<code>JMeter</code>工具进行测试，初始化的时候两个商品的库存设置都是：<code>5</code>;所以这里加锁和不加锁的情况都设置成：十次并发请求。</p>
</blockquote>
<h4 id="2-3-1-不加锁"><a href="#2-3-1-不加锁" class="headerlink" title="2.3.1 不加锁"></a>2.3.1 不加锁</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 售卖商品(不加锁)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/saleGoods"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">saleGoods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> redisLockService.saleGoods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>请求方式：<code>POST</code></li>
<li>请求地址：<a href="http://localhost:8080/redisLock/saleGoods" target="_blank" rel="noopener">http://localhost:8080/redisLock/saleGoods</a></li>
<li>返回结果：<code>id =1</code>的商品库存减为<code>-5</code></li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/22/16d59556925bf3ad?w=926&h=270&f=png&s=96527" alt=""></p>
<h4 id="2-3-2-加锁"><a href="#2-3-2-加锁" class="headerlink" title="2.3.2 加锁"></a>2.3.2 加锁</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 售卖商品(加锁)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/saleGoodsLock"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpResult <span class="title">saleGoodsLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> redisLockService.saleGoodsLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>请求方式：<code>POST</code></li>
<li>请求地址：<a href="http://localhost:8080/redisLock/saleGoodsLock" target="_blank" rel="noopener">http://localhost:8080/redisLock/saleGoodsLock</a></li>
<li>返回结果：<code>id =1</code>的商品库存减为<code>0</code></li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/9/22/16d5955af6a8149c?w=1322&h=810&f=png&s=561586" alt=""></p>
<h4 id="2-3-3-小结"><a href="#2-3-3-小结" class="headerlink" title="2.3.3 小结"></a>2.3.3 小结</h4><p>通过<code>2.3.1</code>和<code>2.3.2</code>的结果对比很明显：前者出现了超卖情况，库存数卖到了<code>-5</code>，这是决不允许的；而加了锁的情况后，库存只会减少到<code>0</code>，便不再销售。</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p><strong>再次说明：以上代码不全，如需尝试，请前往Van 的 Github 查看完整示例代码</strong></p>
<p>第一种基于<code>Redis</code>的分布式锁并不适合用于生产环境。<code>Redisson</code> 可用于生产环境。当然，分布式的选择还有<code>Zookeeper</code>的选项，Van后续会整理出来供大家参考。</p>
<p><a href="https://github.com/vanDusty/Distributed/tree/master/distributed-lock" target="_blank" rel="noopener">Github 示例源码</a></p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>分布式锁</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 集成 zxing 生成二维码</title>
    <url>/2019/09/09/43054a00.html</url>
    <content><![CDATA[<p>在网站开发中,经常会遇到要生成二维码的情况,比如要使用微信支付、网页登录等.</p>
<a id="more"></a>

<ul>
<li>二维码应用场景</li>
</ul>
<ol>
<li>信息获取（名片、地图、<code>WIFI</code>密码、资料）</li>
<li>网站跳转（跳转到微博、手机网站、网站）</li>
<li>广告推送（用户扫码，直接浏览商家推送的视频、音频广告）</li>
<li>手机电商（用户扫码、手机直接购物下单）</li>
<li>防伪溯源（用户扫码、即可查看生产地；同时后台可以获取最终消费地)</li>
<li>优惠促销（用户扫码，下载电子优惠券，抽奖）</li>
<li>会员管理（用户手机上获取电子会员信息、<code>VIP</code>服务）</li>
<li>手机支付（扫描商品二维码，通过银行或第三方支付提供的手机端通道完成支付）</li>
<li>账号登录（扫描二维码进行各个网站或软件的登录）</li>
<li>……</li>
</ol>
<h2 id="一、示例代码"><a href="#一、示例代码" class="headerlink" title="一、示例代码"></a>一、示例代码</h2><blockquote>
<p>本文使用的是<code>Google</code>的<code>zxing</code>工具类</p>
</blockquote>
<h3 id="1-1-pom-xml"><a href="#1-1-pom-xml" class="headerlink" title="1.1 pom.xml"></a>1.1 <code>pom.xml</code></h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 二维码支持包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>1.8.4<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-application-yml"><a href="#1-2-application-yml" class="headerlink" title="1.2 application.yml"></a>1.2 <code>application.yml</code></h3><p>对于<code>logo</code>配置和二维码的配置，我放在配置文件中了。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">qr:</span></span><br><span class="line">  <span class="attr">code:</span></span><br><span class="line">    <span class="attr">charset:</span> <span class="string">utf-8</span></span><br><span class="line">    <span class="attr">width:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">height:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">logoWidth:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">logoHeight:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">picType:</span> <span class="string">jpg</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-二维码配置类"><a href="#1-3-二维码配置类" class="headerlink" title="1.3 二维码配置类"></a>1.3 二维码配置类</h3><p>为了便于注入生成二维码的属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QrCodeConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qr.code.charset&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String configCharset;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qr.code.width&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer configWidth;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qr.code.height&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer configHeight;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qr.code.logoWidth&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer configLogoWidth;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qr.code.logoHeight&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer configLogoHeight;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qr.code.picType&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String configPicType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String charset;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成二维码的宽</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer width;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成二维码的高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer height;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * logo的宽</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer logoWidth;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * logo的高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer logoHeight;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成二维码图片的格式 png, jpg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String picType;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCharset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        charset = <span class="keyword">this</span>.configCharset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        width = <span class="keyword">this</span>.configWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        height = <span class="keyword">this</span>.configHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogoWidth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logoWidth = <span class="keyword">this</span>.configLogoWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogoHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logoHeight = <span class="keyword">this</span>.configLogoHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPicType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        picType = <span class="keyword">this</span>.configPicType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-生成二维码的工具类"><a href="#1-4-生成二维码的工具类" class="headerlink" title="1.4 生成二维码的工具类"></a>1.4 生成二维码的工具类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QrCodeUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成二维码图片</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content      二维码内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imgPath      中间log地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> needCompress 是否压缩</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BufferedImage <span class="title">createImage</span><span class="params">(String content, String imgPath, <span class="keyword">boolean</span> needCompress)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Hashtable hints = <span class="keyword">new</span> Hashtable();</span><br><span class="line"></span><br><span class="line">        hints.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.H);</span><br><span class="line">        hints.put(EncodeHintType.CHARACTER_SET, QrCodeConfiguration.charset);</span><br><span class="line">        hints.put(EncodeHintType.MARGIN, <span class="number">1</span>);</span><br><span class="line">        BitMatrix bitMatrix = <span class="keyword">new</span> MultiFormatWriter().encode(content, BarcodeFormat.QR_CODE, QrCodeConfiguration.width, QrCodeConfiguration.height,</span><br><span class="line">                hints);</span><br><span class="line">        <span class="keyword">int</span> width = bitMatrix.getWidth();</span><br><span class="line">        <span class="keyword">int</span> height = bitMatrix.getHeight();</span><br><span class="line">        BufferedImage image = <span class="keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; width; x++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; height; y++) &#123;</span><br><span class="line">                image.setRGB(x, y, bitMatrix.get(x, y) ? <span class="number">0xFF000000</span> : <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (imgPath == <span class="keyword">null</span> || <span class="string">""</span>.equals(imgPath)) &#123;</span><br><span class="line">            <span class="keyword">return</span> image;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 插入图片</span></span><br><span class="line">        QrCodeUtil.insertImage(image, imgPath, needCompress);</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入LOGO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imgPath      二维码图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imgPath      LOGO图片地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> needCompress 是否压缩</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">insertImage</span><span class="params">(BufferedImage source, String imgPath, <span class="keyword">boolean</span> needCompress)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(imgPath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            System.err.println(<span class="string">""</span> + imgPath + <span class="string">"   该文件不存在！"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Image src = ImageIO.read(<span class="keyword">new</span> File(imgPath));</span><br><span class="line">        <span class="keyword">int</span> width = src.getWidth(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">int</span> height = src.getHeight(<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// 压缩logo</span></span><br><span class="line">        <span class="keyword">if</span> (needCompress) &#123;</span><br><span class="line">            <span class="keyword">if</span> (width &gt; QrCodeConfiguration.logoWidth) &#123;</span><br><span class="line">                width = QrCodeConfiguration.logoWidth;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (height &gt; QrCodeConfiguration.logoHeight) &#123;</span><br><span class="line">                height = QrCodeConfiguration.logoHeight;</span><br><span class="line">            &#125;</span><br><span class="line">            Image image = src.getScaledInstance(width, height, Image.SCALE_SMOOTH);</span><br><span class="line">            BufferedImage tag = <span class="keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);</span><br><span class="line">            Graphics g = tag.getGraphics();</span><br><span class="line">            <span class="comment">// 绘制缩小后的图</span></span><br><span class="line">            g.drawImage(image, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>);</span><br><span class="line">            g.dispose();</span><br><span class="line">            src = image;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 插入LOGO</span></span><br><span class="line">        Graphics2D graph = source.createGraphics();</span><br><span class="line">        <span class="keyword">int</span> x = (QrCodeConfiguration.width - width) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> y = (QrCodeConfiguration.height - height) / <span class="number">2</span>;</span><br><span class="line">        graph.drawImage(src, x, y, width, height, <span class="keyword">null</span>);</span><br><span class="line">        Shape shape = <span class="keyword">new</span> RoundRectangle2D.Float(x, y, width, width, <span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line">        graph.setStroke(<span class="keyword">new</span> BasicStroke(<span class="number">3f</span>));</span><br><span class="line">        graph.draw(shape);</span><br><span class="line">        graph.dispose();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建文件夹， mkdirs会自动创建多层目录，区别于mkdir．(mkdir如果父目录不存在则会抛出异常)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> destPath</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mkdirs</span><span class="params">(String destPath)</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(destPath);</span><br><span class="line">        <span class="comment">// 当文件夹不存在时，mkdirs会自动创建多层目录，区别于mkdir．(mkdir如果父目录不存在则会抛出异常)</span></span><br><span class="line">        <span class="keyword">if</span> (!file.exists() &amp;&amp; !file.isDirectory()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成带logo二维码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content      二维码的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imgPath      中间log地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> output</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> needCompress 是否压缩</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(String content, String imgPath, OutputStream output, <span class="keyword">boolean</span> needCompress)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        BufferedImage image = QrCodeUtil.createImage(content, imgPath, needCompress);</span><br><span class="line">        ImageIO.write(image, QrCodeConfiguration.picType, output);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成不带log 二维码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 二维码的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> output</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(String content, OutputStream output)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        QrCodeUtil.encode(content, <span class="keyword">null</span>, output, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、测试"><a href="#二、测试" class="headerlink" title="二、测试"></a>二、测试</h2><h3 id="2-1-QrCodeController-java"><a href="#2-1-QrCodeController-java" class="headerlink" title="2.1 QrCodeController.java"></a>2.1 <code>QrCodeController.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/qrCode"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QrCodeController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成 普通二维码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/getCommonQRCode"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCommonQRCode</span><span class="params">(HttpServletResponse response, String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ServletOutputStream stream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = response.getOutputStream();</span><br><span class="line">            <span class="comment">//使用工具类生成二维码</span></span><br><span class="line">            QrCodeUtil.encode(url, stream);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stream.flush();</span><br><span class="line">                stream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成 带有logo二维码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/getQRCodeWithLogo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getQRCodeWithLogo</span><span class="params">(HttpServletResponse response, String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ServletOutputStream stream = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = response.getOutputStream();</span><br><span class="line">            <span class="comment">// logo 地址</span></span><br><span class="line">            String logoPath = Thread.currentThread().getContextClassLoader().getResource(<span class="string">""</span>).getPath()</span><br><span class="line">                    + <span class="string">"templates"</span> + File.separator + <span class="string">"advator.jpg"</span>;</span><br><span class="line">            <span class="comment">// String logoPath = "springboot-demo-list/qr-code/src/main/resources/templates/advator.jpg";</span></span><br><span class="line">            <span class="comment">//使用工具类生成二维码</span></span><br><span class="line">            QrCodeUtil.encode(url, logoPath, stream, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stream.flush();</span><br><span class="line">                stream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-二维码生成"><a href="#2-2-二维码生成" class="headerlink" title="2.2 二维码生成"></a>2.2 二维码生成</h3><p>启动项目，依次访问如下地址，获取两种二维码：</p>
<ul>
<li>获取普通二维码</li>
</ul>
<p><a href="https://localhost:8080/qrCode/getCommonQRCode?url=https://www.dustyblog.cn" target="_blank" rel="noopener">http://localhost:8080/qrCode/getCommonQRCode?url=http://www.dustyblog.cn</a></p>
<ul>
<li>获取带<code>logo</code>的二维码</li>
</ul>
<p><a href="http://localhost:8080/qrCode/getQRCodeWithLogo?url=https://www.dustyblog.cn" target="_blank" rel="noopener">http://localhost:8080/qrCode/getQRCodeWithLogo?url=https://www.dustyblog.cn</a></p>
<ul>
<li>扫码测试，直达风尘博客。</li>
</ul>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p><a href="https://github.com/vanDusty/SpringBoot-Home/blob/master/springboot-demo-file/zxing-code" target="_blank" rel="noopener">Githu 示例源码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>验证码</tag>
      </tags>
  </entry>
  <entry>
    <title>跟我学设计模式之工厂模式</title>
    <url>/2019/09/03/2d578a82.html</url>
    <content><![CDATA[<p>工厂模式应用非常之广，在<code>JDK</code>底层源码以及各大主流框架中随处可见，一般以<code>Factory</code>结尾命名的类，比如<code>Mybatis</code>中的<code>SqlSessionFactory</code>，<code>Spring</code>中的<code>BeanFactory</code>等，都是工厂模式的典型代表。</p>
<a id="more"></a>

<h2 id="一、简单工厂模式"><a href="#一、简单工厂模式" class="headerlink" title="一、简单工厂模式"></a>一、简单工厂模式</h2><h3 id="1-1-概念"><a href="#1-1-概念" class="headerlink" title="1.1 概念"></a>1.1 概念</h3><p>简单工厂模式又称为静态工厂模式，属于设计模式中的创建型模式。简单工厂模式通过对外提供一个静态方法来统一为类创建实例，目的是实现类与类之间解耦:客户端不需要知道这个对象是如何被穿创建出来的，只需要调用简单工厂模式的方法来统一创建就可以了，从而明确了各个类的职责。</p>
<h3 id="1-2-示例"><a href="#1-2-示例" class="headerlink" title="1.2 示例"></a>1.2 示例</h3><p>简单工厂模式，以生产汽车轮胎为例。</p>
<h4 id="1-2-1-实体类"><a href="#1-2-1-实体类" class="headerlink" title="1.2.1 实体类"></a>1.2.1 实体类</h4><ul>
<li>轮胎通用属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tire</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String common;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>奔驰车轮胎</li>
</ul>
<blockquote>
<p>包含通用属性外还有自己的特有属性</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TireForBenz</span> <span class="keyword">extends</span> <span class="title">Tire</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Tire tire;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 特有属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String benz;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TireForBenz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.benz = <span class="string">"得到 Benz 轮胎"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span>+<span class="keyword">this</span>.benz +<span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>宝马车轮胎</li>
</ul>
<blockquote>
<p>包含通用属性外还有自己的特有属性</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TireForBwm</span> <span class="keyword">extends</span> <span class="title">Tire</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Tire tire;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 特有属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String bwm;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TireForBwm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bwm = <span class="string">"得到 Bwm 轮胎"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span>+<span class="keyword">this</span>.bwm +<span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-2-生产工艺"><a href="#1-2-2-生产工艺" class="headerlink" title="1.2.2 生产工艺"></a>1.2.2 生产工艺</h4><ul>
<li>生产轮胎的抽象方法，各个产线有自己的方式生产</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TireFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Tire <span class="title">produceTire</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>奔驰汽车轮胎产线</li>
</ul>
<blockquote>
<p>重写生产轮胎的方法返回奔驰型轮胎。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BenzTireFactory</span> <span class="keyword">implements</span> <span class="title">TireFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产奔驰轮胎</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tire <span class="title">produceTire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"奔驰轮胎生产中。。。"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TireForBenz();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>宝马汽车轮胎产线</li>
</ul>
<blockquote>
<p>重写生产轮胎的方法返回宝马型轮胎。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BwmTireFactory</span> <span class="keyword">implements</span> <span class="title">TireFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产宝马轮胎</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TireForBwm <span class="title">produceTire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"宝马轮胎生产中。。。"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TireForBwm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-3-轮胎工厂类"><a href="#1-2-3-轮胎工厂类" class="headerlink" title="1.2.3 轮胎工厂类"></a>1.2.3 轮胎工厂类</h4><blockquote>
<p>通过传入的品牌名称调用相应产线生产相应品牌的轮胎</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleFactoryMode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TireFactory <span class="title">produceCar</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"BenzTireFactory"</span>.equals(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BenzTireFactory();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"BwmTireFactory"</span>.equals(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BwmTireFactory();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-4-测试"><a href="#1-2-4-测试" class="headerlink" title="1.2.4 测试"></a>1.2.4 测试</h4><blockquote>
<p>客户端通过工厂类获取实例对象。</p>
</blockquote>
<ul>
<li>测试方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">simpleFactoryModeTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 造奔驰轮胎</span></span><br><span class="line">    TireFactory benz = SimpleFactoryMode.produceCar(<span class="string">"BenzTireFactory"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != benz) &#123;</span><br><span class="line">        benz.produceTire();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"工厂暂时无法生产奔驰轮胎"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 造宝马轮胎</span></span><br><span class="line">    TireFactory bwm = SimpleFactoryMode.produceCar(<span class="string">"BwmTireFactory"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != bwm) &#123;</span><br><span class="line">        bwm.produceTire();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"工厂暂时无法生产宝马轮胎"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 造本田汽轮胎(工厂无该方法)</span></span><br><span class="line">    TireFactory honda = SimpleFactoryMode.produceCar(<span class="string">"Honda"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != honda) &#123;</span><br><span class="line">        honda.produceTire();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"工厂暂时无法生产本田轮胎"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">奔驰轮胎生产中。。。</span><br><span class="line">宝马轮胎生产中。。。</span><br><span class="line">工厂暂时无法生产本田轮胎</span><br></pre></td></tr></table></figure>

<p>该方式确实能完成不同品牌的轮胎生产，但是，有个问题：<strong>方法参数是字符串，可控性有待提升。</strong></p>
<h3 id="1-3-简单工厂模式优化"><a href="#1-3-简单工厂模式优化" class="headerlink" title="1.3 简单工厂模式优化"></a>1.3 简单工厂模式优化</h3><blockquote>
<p>不要通过传入的字符串来判断需要创建对象，而是客户端想要创建什么对象，只需要传入具体的实现类就可以了，然后通过<code>Java</code>的反射来创建对象。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TireFactory <span class="title">produceCar</span><span class="params">(Class&lt;? extends TireFactory&gt; clazz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 通过Java的反射来创建对象</span></span><br><span class="line">        <span class="keyword">return</span> clazz.newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次创建对象都是通过反射来创建的，所以在性能上是有一定的损耗。</p>
<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">simpleFactoryModeUpgradeTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 造奔驰轮胎</span></span><br><span class="line">    TireFactory benzTire = SimpleFactoryMode.produceCar(BenzTireFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    TireForBenz benz = (TireForBenz) benzTire.produceTire();</span><br><span class="line">    System.out.println(benz.toString());</span><br><span class="line">    <span class="comment">// 造宝马轮胎</span></span><br><span class="line">    TireFactory bwmTire = SimpleFactoryMode.produceCar(BwmTireFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    TireForBwm bwm = (TireForBwm) bwmTire.produceTire();</span><br><span class="line">    System.out.println(bwm.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">奔驰轮胎生产中。。。</span><br><span class="line">[得到 Benz 轮胎]</span><br><span class="line">宝马轮胎生产中。。。</span><br><span class="line">[得到 Bwm 轮胎]</span><br></pre></td></tr></table></figure>

<h3 id="1-4-小结"><a href="#1-4-小结" class="headerlink" title="1.4 小结"></a>1.4 小结</h3><p>简单工厂模式确实在一定程度上实现代码的解耦，而这种解耦的特点在于，这种模式将对象的创建和使用分离。这种模式的本质在于通过一个传入的参数，做<code>if...else</code>判断，来达到返回不同类型对象的目的。缺点也很明显，不符合<a href="https://juejin.im/post/5dd67b8ff265da47b60c03fe" target="_blank" rel="noopener">开闭原则</a>（比如新增一个保时捷轮胎的生产，除了需要增加实体和生产方法，还需要修改工厂类<code>SimpleFactoryMode.java</code>）。因此，如果需要增加新的类型，就不得不去修改原来的代码，违反开闭原则。</p>
<ul>
<li>简单工厂模式优点：</li>
</ul>
<ol>
<li>简单优化了软件体系结构，明确了各自功能模块的职责和权利；</li>
<li>通过工厂类，外界不需要直接创建具体产品对象，只需要负责消费，不需要关心内部如何创建对象。</li>
</ol>
<ul>
<li>简单工厂模式缺点：</li>
</ul>
<ol>
<li>改进前的简单工厂模式全部创建逻辑都集中在一个工厂类中，能创建的类只能是考虑到的，如果需要添加新的类，就必须改变工厂类了;</li>
<li>改进前的简单工厂模式随着具体产品的不断增多，可能会出现共产类根据不同条件创建不同实例的需求，这种对条件的判断和对具体产品类型的判断交错在一起，很难避免功能模块的蔓延，对系统的维护和扩展不利;</li>
<li>改进后的简单工厂模式主要是使用反射效率会低一些。</li>
</ol>
<h2 id="二、工厂方法模式"><a href="#二、工厂方法模式" class="headerlink" title="二、工厂方法模式"></a>二、工厂方法模式</h2><ul>
<li>简单工厂模式之所以违反开闭原则，关键在于什么？</li>
</ul>
<p>那就是它把所有对象的创建都集中在同一个工厂类里面了，因此，当新增一个新对象时，必然会需要修改这个共享工厂类，违反开闭原则自然不可避免。</p>
<ul>
<li>解决方案</li>
</ul>
<p>既然问题关键在于，所有对象的创建都跟这个唯一的工厂类耦合了，那我每个对象各自都配置一个单独的工厂类，这个工厂类只创建各自类型的对象，那这样不就解决耦合的问题了吗？</p>
<h3 id="2-1-概念"><a href="#2-1-概念" class="headerlink" title="2.1 概念"></a>2.1 概念</h3><p>工厂方法模式是指定义一个创建对象的接口，但<strong>让实现这个接口的类来决定实例化哪个类</strong>。工厂方法让类的实例化推迟到子类中进行。在工厂方法模式中用户只需要关心所需产品对应的工厂，无须关心创建细节，而且加入新的产品符合开闭原则。</p>
<h3 id="2-2-示例"><a href="#2-2-示例" class="headerlink" title="2.2 示例"></a>2.2 示例</h3><p>工厂方法模式，以生产发动机为例。</p>
<h4 id="2-2-1-实体"><a href="#2-2-1-实体" class="headerlink" title="2.2.1 实体"></a>2.2.1 实体</h4><ul>
<li>发动机的通用属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Engine</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 型号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String common;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>奔驰发动机</li>
</ul>
<blockquote>
<p>包含通用属性外还有自己的特有属性</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EngineForBenz</span> <span class="keyword">extends</span> <span class="title">Engine</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Engine engine;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 特有属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String benz;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EngineForBenz</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.benz = <span class="string">"得到 Benz 发动机"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span>+<span class="keyword">this</span>.benz +<span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>宝马发动机</li>
</ul>
<blockquote>
<p>包含通用属性外还有自己的特有属性</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EngineForBwm</span> <span class="keyword">extends</span> <span class="title">Engine</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Engine engine;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 特有属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String bwm;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EngineForBwm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bwm = <span class="string">"得到 Bwm 发动机"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"["</span>+<span class="keyword">this</span>.bwm +<span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-生产工艺（发动机的工厂类）"><a href="#2-2-2-生产工艺（发动机的工厂类）" class="headerlink" title="2.2.2 生产工艺（发动机的工厂类）"></a>2.2.2 生产工艺（发动机的工厂类）</h4><ul>
<li>抽象工厂类，定义生产发动机的方法，各个产线自己的去实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EngineFactory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Engine <span class="title">produceEngine</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建奔驰子工厂，实现其的工艺</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BenzEngineFactory</span> <span class="keyword">implements</span> <span class="title">EngineFactory</span>&lt;<span class="title">EngineForBenz</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产奔驰发动机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Engine <span class="title">produceEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"奔驰发动机生产中。。。"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EngineForBenz();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建宝马子工厂，实现其的工艺</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BwmEngineFactory</span> <span class="keyword">implements</span> <span class="title">EngineFactory</span>&lt;<span class="title">EngineForBwm</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产宝马发动机</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Engine <span class="title">produceEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"宝马发动机生产中。。。"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EngineForBwm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-测试"><a href="#2-2-3-测试" class="headerlink" title="2.2.3 测试"></a>2.2.3 测试</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">factoryModeTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 造奔驰发动机</span></span><br><span class="line">    EngineFactory car = <span class="keyword">new</span> BenzEngineFactory();</span><br><span class="line">    EngineForBenz benz = (EngineForBenz) car.produceEngine();</span><br><span class="line">    System.out.println(benz.toString());</span><br><span class="line">    <span class="comment">// 造宝马发动机</span></span><br><span class="line">    EngineFactory carFactory = <span class="keyword">new</span> BwmEngineFactory();</span><br><span class="line">    EngineForBwm bwm = (EngineForBwm) carFactory.produceEngine();</span><br><span class="line">    System.out.println(bwm.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">奔驰发动机生产中。。。</span><br><span class="line">[得到 Benz 发动机]</span><br><span class="line">宝马发动机生产中。。。</span><br><span class="line">[得到 Bwm 发动机]</span><br></pre></td></tr></table></figure>

<h3 id="2-3-小结"><a href="#2-3-小结" class="headerlink" title="2.3 小结"></a>2.3 小结</h3><p>工厂方法模式轻松解决了简单工厂模式的问题，符合开闭原则。在上面例子中，当需要新增一个保时捷汽车，此时只需要提供一个对应的<code>EngineForBSJ.java</code>实现<code>produceEngine()</code>方法即可，对于原先代码再不需要做任何修改。</p>
<p>但是每个类型的对象都会有一个与之对应的工厂类。如果对象的类型非常多，意味着会需要创建很多的工厂实现类，造成类数量膨胀，对后续维护带来一些麻烦。</p>
<ul>
<li>缺点</li>
</ul>
<ol>
<li>客户端（应用层）不依赖于产品类实例如何被创建、实现等细节；</li>
<li>一个类通过其子类来指定创建哪个对象。</li>
</ol>
<ul>
<li>缺点</li>
</ul>
<ol>
<li>类的个数容易过多，增加复杂度；</li>
<li>增加了系统的抽象性和理解难度。</li>
</ol>
<h2 id="三、抽象工厂模式"><a href="#三、抽象工厂模式" class="headerlink" title="三、抽象工厂模式"></a>三、抽象工厂模式</h2><p>抽象工厂模式出现，就是为了解决上述工厂方法模式存在的问题，可以看成是工厂方法模式的升级。</p>
<h3 id="3-1-背景"><a href="#3-1-背景" class="headerlink" title="3.1 背景"></a>3.1 背景</h3><ul>
<li>类数量膨胀的情景</li>
</ul>
<p>工厂方法模式创建的对象其实归根到底都是同一类对象。以汽车生产为例，无论是轮胎还是发动机，都是汽车生产的一部分，都是属于汽车生产的过程。如下图：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/2/16ec756a342065cc?w=797&h=609&f=png&s=22530" alt="风尘博客"></p>
<p>由上图我们可以发现，虽然分为奔驰车和宝马车，但是从工厂方法角度，他们都属于汽车这一类别，这就导致了需要单独为每一个零件指定各自的工厂类，从而导致了类数量膨胀的问题。</p>
<ul>
<li>解决方案</li>
</ul>
<p>既然这样，我们可以把每类汽车指定一个工厂，然后再让不同产线去生产他需要的产品，如下图</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/3/16ec757205840ab1?w=791&h=609&f=png&s=21730" alt="风尘博客"></p>
<p>这样当每一类物品组件数量特别多，可以把它称为<strong>产品族</strong>。抽象工厂模式就是为了创建一系列以产品族为单位的对象，这样在需要创建大量系列对象时可以大大提高开发效率，降低维护成本。</p>
<h3 id="3-2-示例"><a href="#3-2-示例" class="headerlink" title="3.2 示例"></a>3.2 示例</h3><blockquote>
<p>因为奔驰轮胎/宝马轮胎/奔驰发动机/宝马发动机的实体在前面已经创建过，这里就直接用了。</p>
</blockquote>
<h4 id="3-2-1-汽车工厂类-顶层抽象工厂类"><a href="#3-2-1-汽车工厂类-顶层抽象工厂类" class="headerlink" title="3.2.1 汽车工厂类(顶层抽象工厂类)"></a>3.2.1 汽车工厂类(顶层抽象工厂类)</h4><blockquote>
<p>该类已包含轮胎/发动机生产，具体实体键一/二中相关实体。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CarFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 准备生产</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产轮胎</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Tire <span class="title">produceTire</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产发动机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Engine <span class="title">produceEngine</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-奔驰汽车产品族（奔驰汽车工厂类）"><a href="#3-2-2-奔驰汽车产品族（奔驰汽车工厂类）" class="headerlink" title="3.2.2 奔驰汽车产品族（奔驰汽车工厂类）"></a>3.2.2 奔驰汽车产品族（奔驰汽车工厂类）</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BenzCarFactory</span> <span class="keyword">implements</span> <span class="title">CarFactory</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"----------------------- 奔驰汽车准备生产 -----------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tire <span class="title">produceTire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"正在生产奔驰轮胎"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TireForBenz();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Engine <span class="title">produceEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"正在生产奔驰发动机"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EngineForBenz();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-宝马汽车产品族（宝马汽车工厂类）"><a href="#3-2-2-宝马汽车产品族（宝马汽车工厂类）" class="headerlink" title="3.2.2 宝马汽车产品族（宝马汽车工厂类）"></a>3.2.2 宝马汽车产品族（宝马汽车工厂类）</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BwmCarFactory</span> <span class="keyword">implements</span> <span class="title">CarFactory</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"----------------------- 宝马汽车准备生产 -----------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tire <span class="title">produceTire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"正在生产宝马轮胎"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TireForBwm();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Engine <span class="title">produceEngine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"正在生产宝马发动机"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EngineForBwm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-3-测试"><a href="#3-2-3-测试" class="headerlink" title="3.2.3 测试"></a>3.2.3 测试</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">abstractFactoryModeTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 生产奔驰整车的零部件</span></span><br><span class="line">    CarFactory benz = <span class="keyword">new</span> BenzCarFactory();</span><br><span class="line">    benz.init();</span><br><span class="line">    TireForBenz benzTire = (TireForBenz) benz.produceTire();</span><br><span class="line">    System.out.println(benzTire.toString());</span><br><span class="line"></span><br><span class="line">    EngineForBenz benzEngine = (EngineForBenz) benz.produceEngine();</span><br><span class="line">    System.out.println(benzEngine.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成宝马整车的零部件d</span></span><br><span class="line">    CarFactory bwm = <span class="keyword">new</span> BwmCarFactory();</span><br><span class="line">    bwm.init();</span><br><span class="line">    TireForBwm bwmTire = (TireForBwm) bwm.produceTire();</span><br><span class="line">    System.out.println(bwmTire.toString());</span><br><span class="line"></span><br><span class="line">    EngineForBwm bwmEngine = (EngineForBwm) bwm.produceEngine();</span><br><span class="line">    System.out.println(bwmEngine.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">----------------------- 奔驰汽车准备生产 -----------------------</span><br><span class="line">正在生产奔驰轮胎</span><br><span class="line">[得到 Benz 轮胎]</span><br><span class="line">正在生产奔驰发动机</span><br><span class="line">[得到 Benz 发动机]</span><br><span class="line">----------------------- 宝马汽车准备生产 -----------------------</span><br><span class="line">正在生产宝马轮胎</span><br><span class="line">[得到 Bwm 轮胎]</span><br><span class="line">正在生产宝马发动机</span><br><span class="line">[得到 Bwm 发动机]</span><br></pre></td></tr></table></figure>

<h3 id="3-3-思考"><a href="#3-3-思考" class="headerlink" title="3.3 思考"></a>3.3 思考</h3><p>既然说抽象工厂模式是工厂方法模式的升级，那到底升级了啥？</p>
<p>其实是<strong>由原来的单一产品的生产升级成为了系列产品的生产</strong>。设想一下，假设上面汽车的例子中，每一品牌汽车中就只生产一种部件，比如就只生产发动机，不生产轮胎等其他组件了，如下图</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/12/3/16ec757830f58e1f?w=791&h=609&f=png&s=23331" alt=""></p>
<p>发现了什么没有？<strong>抽象工厂模式居然转变为我们之前讲过的工厂方法模式</strong>了！换句话说，当你的产品族中只生产一种产品的时候，你的抽象工厂模式其实已经退化为工厂方法模式了。反过来说，当生产多种产品时，工厂方法模式就进化为抽象工厂模式。</p>
<h3 id="3-4-小结"><a href="#3-4-小结" class="headerlink" title="3.4 小结"></a>3.4 小结</h3><p>抽象工厂模式在创建大量系列对象时可以大大提高开发效率，就是为生产产品族而生的，而对于生产单一产品却无能为力。</p>
<p>如果需要添加一个新的产品族，那就简单了，比如新增一个保时捷汽车，那就只需要添加一个保时捷汽车的工厂实现类就好了，并不会对原有的代码造成任何影响。</p>
<p>但是，如果假设在汽车中，我需要再加一个组件，比如倒车影像，怎么操作？你需要在<code>CarFactory</code>接口中添加返回倒车影像对象的接口。这一加不得了了……<strong>所有品牌汽车实现类全部需要修改并追加该方法的实现，违反了开闭原则</strong>。</p>
<ul>
<li>抽象工厂模式优点：</li>
</ul>
<p>创建大量系列对象时可以大大提高开发效率，降低维护成本。</p>
<ul>
<li>抽象工厂模式缺点：</li>
</ul>
<ol>
<li>规定了所有可能被创建的产品集合，产品族中扩展新的产品困难，需要修改抽象工厂的接口；</li>
<li>增加了系统的抽象性和理解难度。</li>
</ol>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><h3 id="4-1-如何选择"><a href="#4-1-如何选择" class="headerlink" title="4.1 如何选择"></a>4.1 如何选择</h3><blockquote>
<p>工厂模式的三种形式都介绍完了，那我们实际开发中该如何去选择呢？</p>
</blockquote>
<ol>
<li>从设计原则来说，简单工厂模式不符合开闭原则。但是很神奇，在实际场景中，简单工厂模式确实用的最多的。</li>
<li>工厂方法模式是专门用于解决单个对象创建工作，本身模式没问题，也符合开闭原则。但是存在工厂类数量膨胀的问题。如果需要创建的工厂类不是很多，是一种不错的选择。</li>
<li>抽象工厂模式天生就是为生产产品族而生的。所以如果你需要创建的对象非常之多，但是对象之间存在明显产品族特征，那么这个时候用抽象工厂模式非常合适。</li>
</ol>
<h3 id="4-2-示例源码"><a href="#4-2-示例源码" class="headerlink" title="4.2 示例源码"></a>4.2 示例源码</h3><p><a href="https://github.com/vanDusty/Design-Patterns/tree/master/factory-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>工厂模式</tag>
      </tags>
  </entry>
  <entry>
    <title>跟我学设计模式之单例模式</title>
    <url>/2019/08/21/884f19cf.html</url>
    <content><![CDATA[<h2 id="一、设计模式"><a href="#一、设计模式" class="headerlink" title="一、设计模式"></a>一、设计模式</h2><h3 id="1-1-设计模式是什么？"><a href="#1-1-设计模式是什么？" class="headerlink" title="1.1 设计模式是什么？"></a>1.1 设计模式是什么？</h3><ol>
<li>设计模式是解决特定问题的一系列套路，是前辈们的代码设计经验的总结，具有一定的普遍性，可以反复使用。其目的是为了提高代码的可重用性、代码的可读性和代码的可靠性。</li>
<li>设计模式的本质是面向对象设计原则的实际运用，是对类的封装性、继承性和多态性以及类的关联关系和组合关系的充分理解。</li>
</ol>
<a id="more"></a>

<h3 id="1-2-为什么要使用设计模式？"><a href="#1-2-为什么要使用设计模式？" class="headerlink" title="1.2 为什么要使用设计模式？"></a>1.2 为什么要使用设计模式？</h3><p>项目的需求是永远在变的，为了应对这种变化，使得我们的代码能够轻易的实现解耦和拓展。</p>
<h3 id="1-3-设计模式类型"><a href="#1-3-设计模式类型" class="headerlink" title="1.3 设计模式类型"></a>1.3 设计模式类型</h3><ul>
<li>创建型模式</li>
</ul>
<p>创建型模式的主要关注点是<strong>怎样创建对象</strong>，它的主要特点是<strong>将对象的创建与使用分离</strong>。这样可以降低系统的耦合度，使用者不需要关注对象的创建细节。</p>
<ul>
<li>结构型模式</li>
</ul>
<p>结构型模式描述如何将类或对象按某种布局组成更大的结构。它分为<strong>类结构型模式和对象结构型模式</strong>，前者采用继承机制来组织接口和类，后者釆用组合或聚合来组合对象。</p>
<ul>
<li>行为型模式</li>
</ul>
<p>行为型模式用于描述程序在运行时复杂的流程控制，即描述多个类或对象之间怎样相互协作共同完成单个对象都无法单独完成的任务，它涉及算法与对象间职责的分配。它分为<strong>类行为模式和对象行为模式</strong>，前者采用继承机制来在类间分派行为，后者采用组合或聚合在对象间分配行为。</p>
<table>
<thead>
<tr>
<th>创建型模式</th>
<th>结构型模式</th>
<th>行为型模式</th>
</tr>
</thead>
<tbody><tr>
<td>单例模式、抽象工厂模式、建造者模式、工厂模式、原型模式</td>
<td>适配器模式、桥接模式、装饰模式、组合模式、外观模式、享元模式、代理模式</td>
<td>模版方法模式、命令模式、迭代器模式、观察者模式、中介者模式、备忘录模式、解释器模式、状态模式、策略模式、职责链模式(责任链模式)、访问者模式</td>
</tr>
</tbody></table>
<h2 id="二、面向对象设计的六大设计原则"><a href="#二、面向对象设计的六大设计原则" class="headerlink" title="二、面向对象设计的六大设计原则"></a>二、面向对象设计的六大设计原则</h2><h3 id="2-1-开闭原则"><a href="#2-1-开闭原则" class="headerlink" title="2.1 开闭原则"></a>2.1 开闭原则</h3><p>一个软件实体如类、模块和函数应该对扩展开放，对修改关闭</p>
<ul>
<li>解读</li>
</ul>
<ol>
<li>用抽象构建框架，用实现扩展细节；</li>
<li>不以改动原有类的方式来实现新需求，而是应该以实现事先抽象出来的接口（或具体类继承抽象类）的方式来实现。</li>
</ol>
<ul>
<li>优点</li>
</ul>
<ol>
<li>可以在不改动原有代码的前提下给程序扩展功能，增加了程序的可扩展性；</li>
<li>同时也降低了程序的维护成本。</li>
</ol>
<h3 id="2-2-单一职责原则"><a href="#2-2-单一职责原则" class="headerlink" title="2.2 单一职责原则"></a>2.2 单一职责原则</h3><p>一个类只允许有一个职责，即只有一个导致该类变更的原因。</p>
<ul>
<li>解读</li>
</ul>
<ol>
<li><p>类职责的变化往往就是导致类变化的原因：也就是说如果一个类具有多种职责，就会有多种导致这个类变化的原因，从而导致这个类的维护变得困难；</p>
</li>
<li><p>往往在软件开发中随着需求的不断增加，可能会给原来的类添加一些本来不属于它的一些职责，从而违反了单一职责原则。<strong>如果我们发现当前类的职责不仅仅有一个，就应该将本来不属于该类真正的职责分离出去</strong>；</p>
</li>
<li><p>不仅仅是类，函数（方法）也要遵循单一职责原则，即：<strong>一个函数（方法）只做一件事情</strong>。如果发现一个函数（方法）里面有不同的任务，则需要将不同的任务以另一个函数（方法）的形式分离出去。</p>
</li>
</ol>
<ul>
<li>优点</li>
</ul>
<ol>
<li>提高代码的可读性，更实际性地更降低了程序出错的风险；</li>
<li>有利于bug的追踪，降低了程序的维护成本。</li>
</ol>
<h3 id="2-3-依赖倒置原则"><a href="#2-3-依赖倒置原则" class="headerlink" title="2.3 依赖倒置原则"></a>2.3 依赖倒置原则</h3><ol>
<li>依赖抽象，而不是依赖实现;</li>
<li>抽象不应该依赖细节；细节应该依赖抽象;</li>
<li>高层模块不能依赖低层模块，二者都应该依赖抽象。</li>
</ol>
<ul>
<li>解读</li>
</ul>
<ol>
<li>面向接口编程，而不是面向实现编程；</li>
<li>尽量不要从具体的类派生，而是以继承抽象类或实现接口来实现；</li>
<li>关于高层模块与低层模块的划分可以按照决策能力的高低进行划分。业务层自然就处于上层模块，逻辑层和数据层自然就归类为底层。</li>
</ol>
<ul>
<li>优点</li>
</ul>
<ol>
<li>通过抽象来搭建框架，建立类和类的关联，以减少类间的耦合性；</li>
<li>以抽象搭建的系统要比以具体实现搭建的系统更加稳定，扩展性更高，同时也便于维护。</li>
</ol>
<ul>
<li>里氏替换原则</li>
</ul>
<p>子类可以扩展父类的功能，但不能改变父类原有的功能。也就是说，子类继承父类时，除添加新的方法完成新增功能外，尽量不要重写父类的方法。</p>
<h3 id="2-4-接口隔离原则"><a href="#2-4-接口隔离原则" class="headerlink" title="2.4 接口隔离原则"></a>2.4 接口隔离原则</h3><p>多个特定的客户端接口要好于一个通用性的总接口。</p>
<ul>
<li>解读</li>
</ul>
<ol>
<li>客户端不应该依赖它不需要实现的接口；</li>
<li>不建立庞大臃肿的接口，应尽量细化接口，接口中的方法应该尽量少。</li>
</ol>
<blockquote>
<p>注意：接口的粒度也不能太小。如果过小，则会造成接口数量过多，使设计复杂化。</p>
</blockquote>
<ul>
<li>优点</li>
</ul>
<p>避免同一个接口里面包含不同类职责的方法，接口责任划分更加明确，符合<strong>高内聚低耦合</strong>的思想。</p>
<h3 id="2-5-迪米特法则（最少知道原则）"><a href="#2-5-迪米特法则（最少知道原则）" class="headerlink" title="2.5 迪米特法则（最少知道原则）"></a>2.5 迪米特法则（最少知道原则）</h3><p>一个对象应该对尽可能少的对象有接触，也就是只接触那些真正需要接触的对象。</p>
<ul>
<li>解读</li>
</ul>
<p>一个类应该只和它的成员变量，方法的输入，返回参数中的类作交流，而不应该引入其他的类（间接交流）。</p>
<ul>
<li>优点</li>
</ul>
<p>可以良好地降低类与类之间的耦合，减少类与类之间的关联程度，让类与类之间的协作更加直接。</p>
<h3 id="2-6-组合聚合复用原则"><a href="#2-6-组合聚合复用原则" class="headerlink" title="2.6 组合聚合复用原则"></a>2.6 组合聚合复用原则</h3><p>所有引用基类的地方必须能透明地使用其子类的对象，也就是说子类对象可以替换其父类对象，而程序执行效果不变。</p>
<p>-解读</p>
<p>在继承体系中，子类中可以增加自己特有的方法，也可以实现父类的抽象方法，但是不能重写父类的非抽象方法，否则该继承关系就不是一个正确的继承关系。</p>
<ul>
<li>优点</li>
</ul>
<p>可以检验继承使用的正确性，约束继承在使用上的泛滥。</p>
<h2 id="三、-单例模式概念"><a href="#三、-单例模式概念" class="headerlink" title="三、 单例模式概念"></a>三、 单例模式概念</h2><h3 id="3-1-单例模式是什么？"><a href="#3-1-单例模式是什么？" class="headerlink" title="3.1 单例模式是什么？"></a>3.1 单例模式是什么？</h3><p>单例模式就是在程序运行中只实例化一次，创建一个全局唯一对象。有点像 <code>Java</code> 的静态变量，但是单例模式要优于静态变量：</p>
<ol>
<li>静态变量在程序启动的时候<code>JVM</code>就会进行加载，如果不使用，会造成大量的资源浪费；</li>
<li>单例模式能够实现懒加载，能够在使用实例的时候才去创建实例。</li>
</ol>
<p>开发工具类库中的很多工具类都应用了单例模式，比例线程池、缓存、日志对象等，它们都只需要创建一个对象，如果创建多份实例，可能会带来不可预知的问题，比如资源的浪费、结果处理不一致等问题。</p>
<h3 id="3-2-为什么要使用单例模式？"><a href="#3-2-为什么要使用单例模式？" class="headerlink" title="3.2 为什么要使用单例模式？"></a>3.2 为什么要使用单例模式？</h3><p>单例模式属于设计模式三大分类中的第一类——创建型模式，跟对象的创建相关。也就是说，这个模式在创建对象的同时，还致力于控制创建对象的数量，是的，只能创建一个实例，多的不要。</p>
<p>👉那么问题来了，我们为什么要控制对象创建的个数？</p>
<ol>
<li>有些场景下，不使用单例模式，会导致系统同一时刻出现多个状态缺乏同步，用户自然无法判断当前处于什么状态；</li>
<li>通过控制创建对象的数量，可以节约系统资源开销（像线程、数据库连接等）；</li>
<li>全局数据共享。 </li>
</ol>
<h3 id="3-3-单例的实现思路"><a href="#3-3-单例的实现思路" class="headerlink" title="3.3 单例的实现思路"></a>3.3 单例的实现思路</h3><ol>
<li>静态化实例对象；</li>
<li>私有化构造方法，禁止通过构造方法创建实例；</li>
<li>提供一个公共的静态方法，用来返回唯一实例。</li>
</ol>
<h2 id="四、-饿汉模式"><a href="#四、-饿汉模式" class="headerlink" title="四、 饿汉模式"></a>四、 饿汉模式</h2><p>在定义静态属性时，直接实例化了对象</p>
<h3 id="4-1-示例"><a href="#4-1-示例" class="headerlink" title="4.1 示例"></a>4.1 示例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungryMode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 利用静态变量来存储唯一实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HungryMode instance = <span class="keyword">new</span> HungryMode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有化构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungryMode</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 里面可以有很多操作</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供公开获取实例接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungryMode <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-饿汉模式的优点"><a href="#4-2-饿汉模式的优点" class="headerlink" title="4.2 饿汉模式的优点"></a>4.2 饿汉模式的优点</h3><p>由于使用了<code>static</code>关键字，保证了在引用这个变量时，关于这个变量的所以写入操作都完成，所以保证了<code>JVM</code>层面的线程安全。</p>
<h3 id="4-3-饿汉模式的缺点"><a href="#4-3-饿汉模式的缺点" class="headerlink" title="4.3 饿汉模式的缺点"></a>4.3 饿汉模式的缺点</h3><p>不能实现懒加载，造成空间浪费：如果一个类比较大，我们在初始化的时就加载了这个类，但是我们长时间没有使用这个类，这就导致了内存空间的浪费。</p>
<blockquote>
<p>所以，能不能只有用到 <code>getInstance()</code>方法，才会去初始化单例类，才会加载单例类中的数据。所以就有了：<strong>懒汉式</strong>。</p>
</blockquote>
<h2 id="五、懒汉模式"><a href="#五、懒汉模式" class="headerlink" title="五、懒汉模式"></a>五、懒汉模式</h2><p>懒汉模式是一种偷懒的模式，在程序初始化时不会创建实例，只有在使用实例的时候才会创建实例，所以懒汉模式解决了饿汉模式带来的空间浪费问题。</p>
<h3 id="5-1-懒汉模式的一般实现"><a href="#5-1-懒汉模式的一般实现" class="headerlink" title="5.1 懒汉模式的一般实现"></a>5.1 懒汉模式的一般实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMode</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义静态变量时，未初始化实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazyMode instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有化构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyMode</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 里面可以有很多操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供公开获取实例接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LazyMode <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 使用时，先判断实例是否为空，如果实例为空，则实例化对象</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> LazyMode();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这种实现在多线程的情况下是不安全的，有可能会出现多份实例的情况：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">    instance = <span class="keyword">new</span> LazyMode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设有两个线程同时进入到上面这段代码，因为没有任何资源保护措施，所以两个线程可以同时判断的 <code>instance</code> 都为空，都将去初始化实例，所以就会出现多份实例的情况。</p>
<h3 id="5-2-懒汉模式的优化"><a href="#5-2-懒汉模式的优化" class="headerlink" title="5.2 懒汉模式的优化"></a>5.2 懒汉模式的优化</h3><p>我们给<code>getInstance()</code>方法加上<code>synchronized</code>关键字，使得<code>getInstance()</code>方法成为受保护的资源就能够解决多份实例的问题。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyModeSynchronized</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义静态变量时，未初始化实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LazyModeSynchronized instance;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有化构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazyModeSynchronized</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 里面可以有很多操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供公开获取实例接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> LazyModeSynchronized <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 添加class类锁，影响了性能，加锁之后将代码进行了串行化，</span></span><br><span class="line"><span class="comment">         * 我们的代码块绝大部分是读操作，在读操作的情况下，代码线程是安全的</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> LazyModeSynchronized();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-懒汉模式的优点"><a href="#5-3-懒汉模式的优点" class="headerlink" title="5.3 懒汉模式的优点"></a>5.3 懒汉模式的优点</h3><p>实现了懒加载，节约了内存空间。</p>
<h3 id="5-4-懒汉模式的缺点"><a href="#5-4-懒汉模式的缺点" class="headerlink" title="5.4 懒汉模式的缺点"></a>5.4 懒汉模式的缺点</h3><ol>
<li>在不加锁的情况下，线程不安全，可能出现多份实例；</li>
<li>在加锁的情况下，会使程序串行化，使系统有严重的性能问题。</li>
</ol>
<p>懒汉模式中加锁的问题，对于<code>getInstance()</code>方法来说，绝大部分的操作都是读操作，读操作是线程安全的，所以我们没必让每个线程必须持有锁才能调用该方法，我们需要调整加锁的问题。由此也产生了一种新的实现模式：<strong>双重检查锁模式</strong>。</p>
<h2 id="六、双重检查锁模式"><a href="#六、双重检查锁模式" class="headerlink" title="六、双重检查锁模式"></a>六、双重检查锁模式</h2><h3 id="6-1-双重检查锁模式的一般实现"><a href="#6-1-双重检查锁模式的一般实现" class="headerlink" title="6.1 双重检查锁模式的一般实现"></a>6.1 双重检查锁模式的一般实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleCheckLockMode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DoubleCheckLockMode instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有化构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DoubleCheckLockMode</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供公开获取实例接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DoubleCheckLockMode <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 第一次判断，如果这里为空，不进入抢锁阶段，直接返回实例</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DoubleCheckLockMode<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="comment">// 抢到锁之后再次判断是否为空</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> DoubleCheckLockMode();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>双重检查锁模式解决了单例、性能、线程安全问题，但是这种写法同样存在问题：在多线程的情况下，可能会出现空指针问题，出现问题的原因是<code>JVM</code>在实例化对象的时候会进行优化和指令重排序操作。</p>
<h3 id="6-2-什么是指令重排？"><a href="#6-2-什么是指令重排？" class="headerlink" title="6.2 什么是指令重排？"></a>6.2 什么是指令重排？</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">SingletonObject</span><span class="params">()</span></span>&#123;</span><br><span class="line">	  <span class="comment">// 第一步</span></span><br><span class="line">     <span class="keyword">int</span> x = <span class="number">10</span>;</span><br><span class="line">	  <span class="comment">// 第二步</span></span><br><span class="line">     <span class="keyword">int</span> y = <span class="number">30</span>;</span><br><span class="line">     <span class="comment">// 第三步</span></span><br><span class="line">     Object o = <span class="keyword">new</span> Object(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的构造函数<code>SingletonObject()</code>，<code>JVM</code> 会对它进行指令重排序，所以执行顺序可能会乱掉，但是不管是那种执行顺序，<code>JVM</code> 最后都会保证所以实例都完成实例化。 <strong>如果构造函数中操作比较多时，为了提升效率，<code>JVM</code> 会在构造函数里面的属性未全部完成实例化时，就返回对象</strong>。双重检测锁出现空指针问题的原因就是出现在这里，当某个线程获取锁进行实例化时，其他线程就直接获取实例使用，由于<code>JVM</code>指令重排序的原因，其他线程获取的对象也许不是一个完整的对象，所以在使用实例的时候就<strong>会出现空指针异常问题</strong>。</p>
<h3 id="6-3-双重检查锁模式优化"><a href="#6-3-双重检查锁模式优化" class="headerlink" title="6.3 双重检查锁模式优化"></a>6.3 双重检查锁模式优化</h3><p>要解决双重检查锁模式带来空指针异常的问题，只需要使用<code>volatile</code>关键字，<code>volatile</code>关键字严格遵循<code>happens-before</code>原则，即：在读操作前，写操作必须全部完成。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleCheckLockModelVolatile</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加volatile关键字，保证在读操作前，写操作必须全部完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> DoubleCheckLockModelVolatile instance;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有化构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DoubleCheckLockModelVolatile</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供公开获取实例接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DoubleCheckLockModelVolatile <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DoubleCheckLockModelVolatile<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> DoubleCheckLockModelVolatile();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="七、静态内部类模式"><a href="#七、静态内部类模式" class="headerlink" title="七、静态内部类模式"></a>七、静态内部类模式</h2><p>静态内部类模式也称单例持有者模式，实例由内部类创建，由于 <code>JVM</code> 在加载外部类的过程中, 是不会加载静态内部类的, 只有内部类的属性/方法被调用时才会被加载, 并初始化其静态属性。静态属性由<code>static</code>修饰，保证只被实例化一次，并且严格保证实例化顺序。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticInnerClassMode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StaticInnerClassMode</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单例持有者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceHolder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span>  <span class="keyword">final</span> <span class="keyword">static</span> StaticInnerClassMode instance = <span class="keyword">new</span> StaticInnerClassMode();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供公开获取实例接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StaticInnerClassMode <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用内部类属性</span></span><br><span class="line">        <span class="keyword">return</span> InstanceHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式跟饿汉式方式采用的机制类似，但又有不同。两者都是采用了类装载的机制来保证初始化实例时只有一个线程。不同的地方：</p>
<ol>
<li>饿汉式方式是只要<code>Singleton</code>类被装载就会实例化，没有<code>Lazy-Loading</code>的作用；</li>
<li>静态内部类方式在<code>Singleton</code>类被装载时并不会立即实例化，而是在需要实例化时，调用<code>getInstance()</code>方法，才会装载<code>SingletonInstance</code>类，从而完成<code>Singleton</code>的实例化。</li>
</ol>
<p>类的静态属性只会在第一次加载类的时候初始化，所以在这里，<code>JVM</code>帮助我们保证了线程的安全性，在类进行初始化时，别的线程是无法进入的。</p>
<p>所以这种方式<strong>在没有加任何锁的情况下，保证了多线程下的安全，并且没有任何性能影响和空间的浪费</strong>。</p>
<h2 id="八、枚举类实现单例模式"><a href="#八、枚举类实现单例模式" class="headerlink" title="八、枚举类实现单例模式"></a>八、枚举类实现单例模式</h2><p>因为枚举类型是线程安全的，并且只会装载一次，设计者充分的利用了枚举的这个特性来实现单例模式，枚举的写法非常简单，而且枚举类型是所用单例实现中<strong>唯一一种不会被破坏的单例实现模式</strong>。</p>
<h3 id="8-1-示例"><a href="#8-1-示例" class="headerlink" title="8.1 示例"></a>8.1 示例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumerationMode</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">EnumerationMode</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 枚举类型是线程安全的，并且只会装载一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> Singleton&#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> EnumerationMode instance;</span><br><span class="line"></span><br><span class="line">        Singleton()&#123;</span><br><span class="line">            instance = <span class="keyword">new</span> EnumerationMode();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> EnumerationMode <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EnumerationMode <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Singleton.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-2-适用场合："><a href="#8-2-适用场合：" class="headerlink" title="8.2 适用场合："></a>8.2 适用场合：</h3><ol>
<li>需要频繁的进行创建和销毁的对象；</li>
<li>创建对象时耗时过多或耗费资源过多，但又经常用到的对象；</li>
<li>工具类对象；</li>
<li>频繁访问数据库或文件的对象。</li>
</ol>
<h2 id="九、单例模式的问题及解决办法"><a href="#九、单例模式的问题及解决办法" class="headerlink" title="九、单例模式的问题及解决办法"></a>九、单例模式的问题及解决办法</h2><p>除枚举方式外, 其他方法都会通过反射的方式破坏单例</p>
<h3 id="9-1-单例模式的破坏"><a href="#9-1-单例模式的破坏" class="headerlink" title="9.1 单例模式的破坏"></a>9.1 单例模式的破坏</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 以静态内部类实现为例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">singletonTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Constructor constructor = StaticInnerClassMode<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredConstructor</span>()</span>;</span><br><span class="line">    constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    StaticInnerClassMode obj1 = StaticInnerClassMode.getInstance();</span><br><span class="line">    StaticInnerClassMode obj2 = StaticInnerClassMode.getInstance();</span><br><span class="line">    StaticInnerClassMode obj3 = (StaticInnerClassMode) constructor.newInstance();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"输出结果为："</span>+obj1.hashCode()+<span class="string">","</span> +obj2.hashCode()+<span class="string">","</span>+obj3.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">输出结果为：1454171136,1454171136,1195396074</span><br></pre></td></tr></table></figure>

<p>从输出的结果我们就可以看出<code>obj1</code>和<code>obj2</code>为同一对象，<code>obj3</code>为新对象。<code>obj3</code>是我们通过反射机制，进而调用了私有的构造函数，然后产生了一个新的对象。</p>
<h3 id="9-2-如何阻止单例破坏"><a href="#9-2-如何阻止单例破坏" class="headerlink" title="9.2 如何阻止单例破坏"></a>9.2 如何阻止单例破坏</h3><p>可以在构造方法中进行判断，若已有实例, 则阻止生成新的实例，解决办法如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticInnerClassModeProtection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StaticInnerClassModeProtection</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(StaticInnerClassModeProtection<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(flag == <span class="keyword">false</span>)&#123;</span><br><span class="line">                flag = <span class="keyword">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"实例已经存在，请通过 getInstance()方法获取！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单例持有者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InstanceHolder</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span>  <span class="keyword">final</span> <span class="keyword">static</span> StaticInnerClassModeProtection instance = <span class="keyword">new</span> StaticInnerClassModeProtection();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供公开获取实例接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StaticInnerClassModeProtection <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 调用内部类属性</span></span><br><span class="line">        <span class="keyword">return</span> InstanceHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在构造方法中进行判断，若存在则抛出RuntimeException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Constructor constructor = StaticInnerClassModeProtection<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredConstructor</span>()</span>;</span><br><span class="line">    constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    StaticInnerClassModeProtection obj1 = StaticInnerClassModeProtection.getInstance();</span><br><span class="line">    StaticInnerClassModeProtection obj2 = StaticInnerClassModeProtection.getInstance();</span><br><span class="line">    StaticInnerClassModeProtection obj3 = (StaticInnerClassModeProtection) constructor.newInstance();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"输出结果为："</span>+obj1.hashCode()+<span class="string">","</span> +obj2.hashCode()+<span class="string">","</span>+obj3.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制台打印：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Caused by: java.lang.RuntimeException: 实例已经存在，请通过 getInstance()方法获取！</span><br><span class="line">	at cn.van.singleton.demo.mode.StaticInnerClassModeProtection.&lt;init&gt;(StaticInnerClassModeProtection.java:22)</span><br><span class="line">	... 35 more</span><br></pre></td></tr></table></figure>


<h2 id="十、总结"><a href="#十、总结" class="headerlink" title="十、总结"></a>十、总结</h2><h3 id="10-1-各种实现的对比"><a href="#10-1-各种实现的对比" class="headerlink" title="10.1 各种实现的对比"></a>10.1 各种实现的对比</h3><table>
<thead>
<tr>
<th>名称</th>
<th>饿汉模式</th>
<th>懒汉模式</th>
<th>双重检查锁模式</th>
<th>静态内部类实现</th>
<th>枚举类实现</th>
</tr>
</thead>
<tbody><tr>
<td>可用性</td>
<td>可用</td>
<td>不推荐使用</td>
<td>推荐使用</td>
<td>推荐使用</td>
<td>推荐使用</td>
</tr>
<tr>
<td>特点</td>
<td>不能实现懒加载，可能造成空间浪费</td>
<td>不加锁线程不安全；加锁性能差</td>
<td>线程安全；延迟加载；效率较高</td>
<td>避免了线程不安全，延迟加载，效率高。</td>
<td>写法简单；线程安全；只装载一次</td>
</tr>
</tbody></table>
<h3 id="10-2-示例代码地址"><a href="#10-2-示例代码地址" class="headerlink" title="10.2 示例代码地址"></a>10.2 示例代码地址</h3><p><a href="https://github.com/vanDusty/Design-Patterns/tree/master/singleton-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
<h3 id="10-3-参考文章"><a href="#10-3-参考文章" class="headerlink" title="10.3 参考文章"></a>10.3 参考文章</h3><p><a href="https://juejin.im/post/5b9526c1e51d450e69731dc2#heading-61" target="_blank" rel="noopener">面向对象设计的六大设计原则</a></p>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>单例模式</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 参数校验之 Validator</title>
    <url>/2019/08/19/9557ef76.html</url>
    <content><![CDATA[<blockquote>
<p>在开发中经常需要写一些字段校验的代码，比如非空，长度限制，邮箱格式验证等等，导致充满了<code>if-else</code> 的代码,不仅相当冗长,而且很让人抓狂。</p>
</blockquote>
<p><code>hibernate validator</code>（<a href="http://hibernate.org/validator/documentation/" target="_blank" rel="noopener">官方文档</a>）提供了一套比较完善、便捷的验证实现方式。它定义了很多常用的校验注解，我们可以直接将这些注解加在我们<code>JavaBean</code>的属性上面，就可以在需要校验的时候进行校验了。在<code>Spring Boot</code> 火热的现在，该工具已经包含在<code>spring-boot-starter-web</code>中，不需额外引入其他包。</p>
<a id="more"></a>

<h2 id="一、快速入门"><a href="#一、快速入门" class="headerlink" title="一、快速入门"></a>一、快速入门</h2><h3 id="1-1-在UserDTO中声明要检查的参数"><a href="#1-1-在UserDTO中声明要检查的参数" class="headerlink" title="1.1 在UserDTO中声明要检查的参数"></a>1.1 在<code>UserDTO</code>中声明要检查的参数</h3><blockquote>
<p>校验说明见代码中注释</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     性别（不校验）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     用户名（校验：不能为空，不能超过20个字符串）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"用户名不能为空"</span>)</span><br><span class="line">    <span class="meta">@Length</span>(max = <span class="number">20</span>, message = <span class="string">"用户名不能超过20个字符"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 手机号（校验：不能为空且按照正则校验格式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"手机号不能为空"</span>)</span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^[1][3,4,5,6,7,8,9][0-9]&#123;9&#125;$"</span>, message = <span class="string">"手机号格式有误"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     邮箱（校验：不能唯恐且校验邮箱格式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"联系邮箱不能为空"</span>)</span><br><span class="line">    <span class="meta">@Email</span>(message = <span class="string">"邮箱格式不对"</span>)</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-接口处声明要检查的参数"><a href="#1-2-接口处声明要检查的参数" class="headerlink" title="1.2 接口处声明要检查的参数"></a>1.2 接口处声明要检查的参数</h3><blockquote>
<p>需要在<code>Controller</code>层的入参位置用<code>@Validated</code> 注解声明</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorDemoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注解参数校验案例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">test</span><span class="params">(@Validated UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的<code>HttpResult</code> 是<code>Van</code> 自己封装的一个结果集，详见文末<code>Github</code>地址的源码。</p>
</blockquote>
<h3 id="1-3-Web全局异常捕获"><a href="#1-3-Web全局异常捕获" class="headerlink" title="1.3 Web全局异常捕获"></a>1.3 Web全局异常捕获</h3><p><code>@Valid</code> 在 <code>Spring Boot</code>中进行绑定参数校验时会抛出异常,需要在<code>Spring Boot</code>中处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法参数校验</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BindException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">HttpResult</span> <span class="title">handleMethodArgumentNotValidException</span>(<span class="title">BindException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> HttpResult.failure(<span class="number">400</span>,e.getBindingResult().getFieldError().getDefaultMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">HttpResult</span> <span class="title">handleException</span>(<span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> HttpResult.failure(<span class="number">400</span>, <span class="string">"系统繁忙,请稍后再试"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-测试"><a href="#1-4-测试" class="headerlink" title="1.4 测试"></a>1.4 测试</h3><blockquote>
<p>测试工具采用的<code>postman</code></p>
</blockquote>
<ul>
<li>请求方式：POST</li>
<li>请求地址：<a href="localhost:8080/demo/test">localhost:8080/demo/test</a></li>
<li>请求参数：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">userName:Van</span><br><span class="line">mobile:17098705205</span><br><span class="line">email:123</span><br></pre></td></tr></table></figure>
<ul>
<li>返回结果：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;success&quot;: false,</span><br><span class="line">    &quot;code&quot;: 400,</span><br><span class="line">    &quot;data&quot;: null,</span><br><span class="line">    &quot;message&quot;: &quot;邮箱格式不对&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>说明</li>
</ul>
<ol>
<li>更多注解，请各位自行尝试；</li>
<li>测试结果证明：参数校验生效，且按照我们设定的结果集返回异常信息。</li>
</ol>
<h3 id="1-5-常见的校验注解"><a href="#1-5-常见的校验注解" class="headerlink" title="1.5 常见的校验注解"></a>1.5 常见的校验注解</h3><ol>
<li><code>@Null</code>：被注释的元素必须为 <code>null</code>     </li>
<li><code>@NotNull</code>：被注释的元素必须不为 <code>null</code>    </li>
<li><code>@AssertTrue</code>：被注释的元素必须为 <code>true</code>    </li>
<li><code>@AssertFalse</code>：被注释的元素必须为 <code>false</code>    </li>
<li><code>@Min(value)</code>：被注释的元素必须是一个数字，其值必须大于等于指定的最小值</li>
<li><code>@Max(value)</code>：被注释的元素必须是一个数字，其值必须小于等于指定的最大值</li>
<li><code>@DecimalMin(value)</code>：被注释的元素必须是一个数字，其值必须大于等于指定的最小值</li>
<li><code>@DecimalMax(value)</code>：被注释的元素必须是一个数字，其值必须小于等于指定的最大值</li>
<li><code>@Size(max=, min=)</code>：被注释的元素的大小必须在指定的范围内     </li>
<li><code>@Digits (integer, fraction)</code>：被注释的元素必须是一个数字，其值必须在可接受的范围内</li>
<li><code>@Past</code>：被注释的元素必须是一个过去的日期<br><code>@Future</code>：被注释的元素必须是一个将来的日期     </li>
<li><code>@Pattern(regex=,flag=)</code>：被注释的元素必须符合指定的正则表达式</li>
<li><code>@NotBlank(message =)</code>：验证字符串非<code>null</code>，且长度必须大于<code>0</code></li>
<li><code>@Email</code>：被注释的元素必须是电子邮箱地址     </li>
<li><code>@Length(min=,max=)</code>：被注释的字符串的大小必须在指定的范围内     </li>
<li><code>@NotEmpty</code>：被注释的字符串的必须非空     </li>
<li><code>@Range(min=,max=,message=)</code>：被注释的元素必须在合适的范围内</li>
</ol>
<h2 id="二、自定义注解校验"><a href="#二、自定义注解校验" class="headerlink" title="二、自定义注解校验"></a>二、自定义注解校验</h2><p><code>hibernate validator</code> 自带的注解可以搞定简单的参数校验，加上正则的写法，能解决绝大多数参数校验情况。但是，有些情况，比如：校验是否登录，就需要我们自定义注解校验了。为了方便测试，我这里以身份证校验为例完成自定义校验的过程。</p>
<h3 id="2-1-身份证校验工具类"><a href="#2-1-身份证校验工具类" class="headerlink" title="2.1 身份证校验工具类"></a>2.1 身份证校验工具类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdCardValidatorUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String codeAndCity[][] = &#123;&#123;<span class="string">"11"</span>, <span class="string">"北京"</span>&#125;, &#123;<span class="string">"12"</span>, <span class="string">"天津"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"13"</span>, <span class="string">"河北"</span>&#125;, &#123;<span class="string">"14"</span>, <span class="string">"山西"</span>&#125;, &#123;<span class="string">"15"</span>, <span class="string">"内蒙古"</span>&#125;, &#123;<span class="string">"21"</span>, <span class="string">"辽宁"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"22"</span>, <span class="string">"吉林"</span>&#125;, &#123;<span class="string">"23"</span>, <span class="string">"黑龙江"</span>&#125;, &#123;<span class="string">"31"</span>, <span class="string">"上海"</span>&#125;, &#123;<span class="string">"32"</span>, <span class="string">"江苏"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"33"</span>, <span class="string">"浙江"</span>&#125;, &#123;<span class="string">"34"</span>, <span class="string">"安徽"</span>&#125;, &#123;<span class="string">"35"</span>, <span class="string">"福建"</span>&#125;, &#123;<span class="string">"36"</span>, <span class="string">"江西"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"37"</span>, <span class="string">"山东"</span>&#125;, &#123;<span class="string">"41"</span>, <span class="string">"河南"</span>&#125;, &#123;<span class="string">"42"</span>, <span class="string">"湖北"</span>&#125;, &#123;<span class="string">"43"</span>, <span class="string">"湖南"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"44"</span>, <span class="string">"广东"</span>&#125;, &#123;<span class="string">"45"</span>, <span class="string">"广西"</span>&#125;, &#123;<span class="string">"46"</span>, <span class="string">"海南"</span>&#125;, &#123;<span class="string">"50"</span>, <span class="string">"重庆"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"51"</span>, <span class="string">"四川"</span>&#125;, &#123;<span class="string">"52"</span>, <span class="string">"贵州"</span>&#125;, &#123;<span class="string">"53"</span>, <span class="string">"云南"</span>&#125;, &#123;<span class="string">"54"</span>, <span class="string">"西藏"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"61"</span>, <span class="string">"陕西"</span>&#125;, &#123;<span class="string">"62"</span>, <span class="string">"甘肃"</span>&#125;, &#123;<span class="string">"63"</span>, <span class="string">"青海"</span>&#125;, &#123;<span class="string">"64"</span>, <span class="string">"宁夏"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"65"</span>, <span class="string">"新疆"</span>&#125;, &#123;<span class="string">"71"</span>, <span class="string">"台湾"</span>&#125;, &#123;<span class="string">"81"</span>, <span class="string">"香港"</span>&#125;, &#123;<span class="string">"82"</span>, <span class="string">"澳门"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"91"</span>, <span class="string">"国外"</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cityCode[] = &#123;<span class="string">"11"</span>, <span class="string">"12"</span>, <span class="string">"13"</span>, <span class="string">"14"</span>, <span class="string">"15"</span>, <span class="string">"21"</span>, <span class="string">"22"</span>,</span><br><span class="line">            <span class="string">"23"</span>, <span class="string">"31"</span>, <span class="string">"32"</span>, <span class="string">"33"</span>, <span class="string">"34"</span>, <span class="string">"35"</span>, <span class="string">"36"</span>, <span class="string">"37"</span>, <span class="string">"41"</span>, <span class="string">"42"</span>, <span class="string">"43"</span>,</span><br><span class="line">            <span class="string">"44"</span>, <span class="string">"45"</span>, <span class="string">"46"</span>, <span class="string">"50"</span>, <span class="string">"51"</span>, <span class="string">"52"</span>, <span class="string">"53"</span>, <span class="string">"54"</span>, <span class="string">"61"</span>, <span class="string">"62"</span>, <span class="string">"63"</span>,</span><br><span class="line">            <span class="string">"64"</span>, <span class="string">"65"</span>, <span class="string">"71"</span>, <span class="string">"81"</span>, <span class="string">"82"</span>, <span class="string">"91"</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每位加权因子</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> power[] = &#123;<span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第18位校检码</span></span><br><span class="line">    <span class="keyword">private</span> String verifyCode[] = &#123;<span class="string">"1"</span>, <span class="string">"0"</span>, <span class="string">"X"</span>, <span class="string">"9"</span>, <span class="string">"8"</span>, <span class="string">"7"</span>, <span class="string">"6"</span>, <span class="string">"5"</span>,</span><br><span class="line">            <span class="string">"4"</span>, <span class="string">"3"</span>, <span class="string">"2"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证所有的身份证的合法性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idcard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidatedAllIdcard</span><span class="params">(String idcard)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (idcard.length() == <span class="number">15</span>) &#123;</span><br><span class="line">            idcard = convertIdcarBy15bit(idcard);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isValidate18Idcard(idcard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将15位的身份证转成18位身份证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idcard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">convertIdcarBy15bit</span><span class="params">(String idcard)</span> </span>&#123;</span><br><span class="line">        String idcard17 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 非15位身份证</span></span><br><span class="line">        <span class="keyword">if</span> (idcard.length() != <span class="number">15</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isDigital(idcard)) &#123;</span><br><span class="line">            <span class="comment">// 获取出生年月日</span></span><br><span class="line">            String birthday = idcard.substring(<span class="number">6</span>, <span class="number">12</span>);</span><br><span class="line">            Date birthdate = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                birthdate = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyMMdd"</span>).parse(birthday);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Calendar cday = Calendar.getInstance();</span><br><span class="line">            cday.setTime(birthdate);</span><br><span class="line">            String year = String.valueOf(cday.get(Calendar.YEAR));</span><br><span class="line"></span><br><span class="line">            idcard17 = idcard.substring(<span class="number">0</span>, <span class="number">6</span>) + year + idcard.substring(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">char</span> c[] = idcard17.toCharArray();</span><br><span class="line">            String checkCode = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != c) &#123;</span><br><span class="line">                <span class="keyword">int</span> bit[] = <span class="keyword">new</span> <span class="keyword">int</span>[idcard17.length()];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将字符数组转为整型数组</span></span><br><span class="line">                bit = converCharToInt(c);</span><br><span class="line">                <span class="keyword">int</span> sum17 = <span class="number">0</span>;</span><br><span class="line">                sum17 = getPowerSum(bit);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取和值与11取模得到余数进行校验码</span></span><br><span class="line">                checkCode = getCheckCodeBySum(sum17);</span><br><span class="line">                <span class="comment">// 获取不到校验位</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == checkCode) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将前17位与第18位校验码拼接</span></span><br><span class="line">                idcard17 += checkCode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 身份证包含数字</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> idcard17;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idCard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidate18Idcard</span><span class="params">(String idCard)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非18位为假</span></span><br><span class="line">        <span class="keyword">if</span> (idCard.length() != <span class="number">18</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取前17位</span></span><br><span class="line">        String idcard17 = idCard.substring(<span class="number">0</span>, <span class="number">17</span>);</span><br><span class="line">        <span class="comment">// 获取第18位</span></span><br><span class="line">        String idcard18Code = idCard.substring(<span class="number">17</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="keyword">char</span> c[] = <span class="keyword">null</span>;</span><br><span class="line">        String checkCode = <span class="string">""</span>;</span><br><span class="line">        <span class="comment">// 是否都为数字</span></span><br><span class="line">        <span class="keyword">if</span> (isDigital(idcard17)) &#123;</span><br><span class="line">            c = idcard17.toCharArray();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != c) &#123;</span><br><span class="line">            <span class="keyword">int</span> bit[] = <span class="keyword">new</span> <span class="keyword">int</span>[idcard17.length()];</span><br><span class="line">            bit = converCharToInt(c);</span><br><span class="line">            <span class="keyword">int</span> sum17 = <span class="number">0</span>;</span><br><span class="line">            sum17 = getPowerSum(bit);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将和值与11取模得到余数进行校验码判断</span></span><br><span class="line">            checkCode = getCheckCodeBySum(sum17);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == checkCode) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将身份证的第18位与算出来的校码进行匹配，不相等就为假</span></span><br><span class="line">            <span class="keyword">if</span> (!idcard18Code.equalsIgnoreCase(checkCode)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 18位身份证号码的基本数字和位数验校</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idCard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">is18Idcard</span><span class="params">(String idCard)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Pattern.matches(<span class="string">"^[1-9]\\d&#123;5&#125;[1-9]\\d&#123;3&#125;((0\\d)|(1[0-2]))(([0|1|2]\\d)|3[0-1])\\d&#123;3&#125;([\\d|x|X]&#123;1&#125;)$"</span>, idCard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数字验证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDigital</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str == <span class="keyword">null</span> || <span class="string">""</span>.equals(str) ? <span class="keyword">false</span> : str.matches(<span class="string">"^[0-9]*$"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将身份证的每位和对应位的加权因子相乘之后，再得到和值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPowerSum</span><span class="params">(<span class="keyword">int</span>[] bit)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (power.length != bit.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bit.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; power.length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == j) &#123;</span><br><span class="line">                    sum = sum + bit[i] * power[j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将和值与11取模得到余数进行校验码判断</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sum17</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 校验位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCheckCodeBySum</span><span class="params">(<span class="keyword">int</span> sum17)</span> </span>&#123;</span><br><span class="line">        String checkCode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (sum17 % <span class="number">11</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                checkCode = <span class="string">"2"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                checkCode = <span class="string">"3"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                checkCode = <span class="string">"4"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                checkCode = <span class="string">"5"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                checkCode = <span class="string">"6"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                checkCode = <span class="string">"7"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                checkCode = <span class="string">"8"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                checkCode = <span class="string">"9"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                checkCode = <span class="string">"x"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                checkCode = <span class="string">"0"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                checkCode = <span class="string">"1"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> checkCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将字符数组转为整型数组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> c</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NumberFormatException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] converCharToInt(<span class="keyword">char</span>[] c) <span class="keyword">throws</span> NumberFormatException &#123;</span><br><span class="line">        <span class="keyword">int</span>[] a = <span class="keyword">new</span> <span class="keyword">int</span>[c.length];</span><br><span class="line">        <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> temp : c) &#123;</span><br><span class="line">            a[k++] = Integer.parseInt(String.valueOf(temp));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String idCardForFalse = <span class="string">"350583199108290106"</span>;</span><br><span class="line">        String idCardForTrue = <span class="string">"350583197106150219"</span>;</span><br><span class="line">        <span class="keyword">if</span> (IdCardValidatorUtils.isValidatedAllIdcard(idCardForTrue)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"身份证校验正确"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"身份证校验错误！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-自定义注解"><a href="#2-2-自定义注解" class="headerlink" title="2.2 自定义注解"></a>2.2 自定义注解</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.PARAMETER, ElementType.FIELD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = IdentityCardNumberValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">IdentityCardNumber</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "身份证号码格式不正确"</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>仔细的你会发现，相对于一般的自定义注解，该注解：<br><code>@Constraint(validatedBy = IdentityCardNumberValidator.class)</code>,该注解的作用就是调用身份证校验的工具。</p>
</blockquote>
<h3 id="2-3-在UserDTO-需要校验的字段添加声明"><a href="#2-3-在UserDTO-需要校验的字段添加声明" class="headerlink" title="2.3 在UserDTO 需要校验的字段添加声明"></a>2.3 在<code>UserDTO</code> 需要校验的字段添加声明</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 身份证号（校验：自定义注解校验）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@IdentityCardNumber</span></span><br><span class="line"><span class="keyword">private</span> String idNumber;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-控制层接口"><a href="#2-4-控制层接口" class="headerlink" title="2.4 控制层接口"></a>2.4 控制层接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/custom"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorCustomController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义注解参数校验案例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">test</span><span class="params">(@Validated UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-自定义注解的测试"><a href="#2-5-自定义注解的测试" class="headerlink" title="2.5 自定义注解的测试"></a>2.5 自定义注解的测试</h3><ul>
<li>请求方式：POST</li>
<li>请求地址：<a href="localhost:8080/private/test">localhost:8080/private/test</a></li>
<li>请求参数：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">userName:Van</span><br><span class="line">mobile:17098705205</span><br><span class="line">email:110@qq.com</span><br><span class="line">idNumber:350583199108290106</span><br></pre></td></tr></table></figure>
<ul>
<li>返回结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"success"</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="string">"data"</span>: <span class="keyword">null</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"身份证号码格式不正确"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、分组校验"><a href="#三、分组校验" class="headerlink" title="三、分组校验"></a>三、分组校验</h2><p>除了上述的校验外，可能还有这种需求：</p>
<p>在创建用户信息时，不需要校验<code>userId</code>;但在更新用户信息时，需要校验<code>userId</code>,而用户名，邮箱等两种情况都得校验。这种情况，就可以<strong>分组校验</strong>来解决了。</p>
<h3 id="3-1-定义分组接口"><a href="#3-1-定义分组接口" class="headerlink" title="3.1  定义分组接口"></a>3.1  定义分组接口</h3><ul>
<li><code>Create.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.validation.groups.Default;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Create</span> <span class="keyword">extends</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Update.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.validation.groups.Default;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Update</span> <span class="keyword">extends</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-在UserDTO-需要校验的字段添加声明"><a href="#3-2-在UserDTO-需要校验的字段添加声明" class="headerlink" title="3.2 在UserDTO 需要校验的字段添加声明"></a>3.2 在<code>UserDTO</code> 需要校验的字段添加声明</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 用户id(只有在有Update分组中校验非空)</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @NotNull(message &#x3D; &quot;id 不能为空&quot;, groups &#x3D; Update.class)</span><br><span class="line">    private Long userId;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-控制层入参位置进行声明"><a href="#3-3-控制层入参位置进行声明" class="headerlink" title="3.3 控制层入参位置进行声明"></a>3.3 控制层入参位置进行声明</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/groups"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorGroupsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新数据，需要传入userID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">updateData</span><span class="params">(@Validated(Update.class)</span>UserDTO userDTO) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据，不需要传入userID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">createData</span><span class="params">(@Validated(Create.class)</span>UserDTO userDTO) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-分组校验的测试-新增测试"><a href="#3-4-分组校验的测试-新增测试" class="headerlink" title="3.4 分组校验的测试-新增测试"></a>3.4 分组校验的测试-新增测试</h3><ul>
<li>请求方式：POST</li>
<li>请求地址：<a href="localhost:8080/groups/create">localhost:8080/groups/create</a></li>
<li>请求参数：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">userName:Van</span><br><span class="line">mobile:17098705205</span><br><span class="line">email:110@qq.com</span><br><span class="line">idNumber:350583197106150219</span><br><span class="line">userId:</span><br></pre></td></tr></table></figure>
<ul>
<li>返回结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"success"</span>: <span class="keyword">true</span>,</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"userId"</span>: <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">"sex"</span>: <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">"userName"</span>: <span class="string">"Van"</span>,</span><br><span class="line">        <span class="string">"mobile"</span>: <span class="string">"17098705205"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"110@qq.com"</span>,</span><br><span class="line">        <span class="string">"idNumber"</span>: <span class="string">"350583197106150219"</span>,</span><br><span class="line">        <span class="string">"passWord"</span>: <span class="keyword">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"message"</span>: <span class="keyword">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求成功，说明新增请求，不检验<code>userId</code>，即<code>userId</code>可以为空。</p>
<h3 id="3-5-分组校验的测试-更新测试"><a href="#3-5-分组校验的测试-更新测试" class="headerlink" title="3.5 分组校验的测试-更新测试"></a>3.5 分组校验的测试-更新测试</h3><ul>
<li>请求方式：POST</li>
<li>请求地址：<a href="localhost:8080/groups/update">localhost:8080/groups/update</a></li>
<li>请求参数：同上（3.4）</li>
<li>返回结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"success"</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="string">"data"</span>: <span class="keyword">null</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"id 不能为空"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求失败，说明更新请求，检验<code>userId</code>，即<code>userId</code>不能为空。</p>
<blockquote>
<p>结合 3.4 与 3.5 的测试结果，说明分组校验成功。</p>
</blockquote>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>希望大家写的每一行代码都是业务需要，而不是无聊且无穷无尽的参数校验。</p>
<p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-list/validator-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>参数校验</tag>
      </tags>
  </entry>
  <entry>
    <title>如何从 if-else 的参数校验中解放出来？</title>
    <url>/2019/08/12/14d44deb.html</url>
    <content><![CDATA[<h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><blockquote>
<p>在开发中经常需要写一些字段校验的代码，比如非空，长度限制，邮箱格式验证等等，导致充满了<code>if-else</code> 的代码,不仅相当冗长,而且很让人抓狂。</p>
</blockquote>
<a id="more"></a>

<p><code>hibernate validator</code>（<a href="http://hibernate.org/validator/documentation/" target="_blank" rel="noopener">官方文档</a>）提供了一套比较完善、便捷的验证实现方式。它定义了很多常用的校验注解，我们可以直接将这些注解加在我们<code>JavaBean</code>的属性上面，就可以在需要校验的时候进行校验了。在<code>Spring Boot</code> 火热的现在，该工具已经包含在<code>spring-boot-starter-web</code>中，不需额外引入其他包。</p>
<h3 id="一、快速入门"><a href="#一、快速入门" class="headerlink" title="一、快速入门"></a>一、快速入门</h3><h4 id="1-1-在UserDTO中声明要检查的参数"><a href="#1-1-在UserDTO中声明要检查的参数" class="headerlink" title="1.1 在UserDTO中声明要检查的参数"></a>1.1 在<code>UserDTO</code>中声明要检查的参数</h4><blockquote>
<p>校验说明见代码中注释</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDTO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     性别（不校验）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     用户名（校验：不能为空，不能超过20个字符串）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"用户名不能为空"</span>)</span><br><span class="line">    <span class="meta">@Length</span>(max = <span class="number">20</span>, message = <span class="string">"用户名不能超过20个字符"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 手机号（校验：不能为空且按照正则校验格式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"手机号不能为空"</span>)</span><br><span class="line">    <span class="meta">@Pattern</span>(regexp = <span class="string">"^[1][3,4,5,6,7,8,9][0-9]&#123;9&#125;$"</span>, message = <span class="string">"手机号格式有误"</span>)</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     邮箱（校验：不能唯恐且校验邮箱格式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NotBlank</span>(message = <span class="string">"联系邮箱不能为空"</span>)</span><br><span class="line">    <span class="meta">@Email</span>(message = <span class="string">"邮箱格式不对"</span>)</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-接口处声明要检查的参数"><a href="#1-2-接口处声明要检查的参数" class="headerlink" title="1.2 接口处声明要检查的参数"></a>1.2 接口处声明要检查的参数</h4><blockquote>
<p>需要在<code>Controller</code>层的入参位置用<code>@Validated</code> 注解声明</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorDemoController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注解参数校验案例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">test</span><span class="params">(@Validated UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的<code>HttpResult</code> 是Van 自己封装的一个结果集，详见文末Github地址的源码。</p>
</blockquote>
<h4 id="1-3-Web全局异常捕获"><a href="#1-3-Web全局异常捕获" class="headerlink" title="1.3 Web全局异常捕获"></a>1.3 Web全局异常捕获</h4><p><code>@Valid</code> 在 <code>Spring Boot</code>中进行绑定参数校验时会抛出异常,需要在<code>Spring Boot</code>中处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法参数校验</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BindException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">HttpResult</span> <span class="title">handleMethodArgumentNotValidException</span>(<span class="title">BindException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> HttpResult.failure(<span class="number">400</span>,e.getBindingResult().getFieldError().getDefaultMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">HttpResult</span> <span class="title">handleException</span>(<span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> HttpResult.failure(<span class="number">400</span>, <span class="string">"系统繁忙,请稍后再试"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-4-测试"><a href="#1-4-测试" class="headerlink" title="1.4 测试"></a>1.4 测试</h4><blockquote>
<p>测试工具采用的<code>postman</code></p>
</blockquote>
<ul>
<li>请求方式：POST</li>
<li>请求地址：localhost:8080/demo/test</li>
<li>请求参数：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">userName:Van</span><br><span class="line">mobile:17098705205</span><br><span class="line">email:123</span><br></pre></td></tr></table></figure>
<ul>
<li>返回结果：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;success&quot;: false,</span><br><span class="line">    &quot;code&quot;: 400,</span><br><span class="line">    &quot;data&quot;: null,</span><br><span class="line">    &quot;message&quot;: &quot;邮箱格式不对&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>说明</li>
</ul>
<ol>
<li>更多注解，请各位自行尝试；</li>
<li>测试结果证明：参数校验生效，且按照我们设定的结果集返回异常信息。</li>
</ol>
<h4 id="1-5-常见的校验注解"><a href="#1-5-常见的校验注解" class="headerlink" title="1.5 常见的校验注解"></a>1.5 常见的校验注解</h4><ol>
<li><code>@Null</code>：被注释的元素必须为 <code>null</code>     </li>
<li><code>@NotNull</code>：被注释的元素必须不为 <code>null</code>    </li>
<li><code>@AssertTrue</code>：被注释的元素必须为 <code>true</code>    </li>
<li><code>@AssertFalse</code>：被注释的元素必须为 <code>false</code>    </li>
<li><code>@Min(value)</code>：被注释的元素必须是一个数字，其值必须大于等于指定的最小值</li>
<li><code>@Max(value)</code>：被注释的元素必须是一个数字，其值必须小于等于指定的最大值</li>
<li><code>@DecimalMin(value)</code>：被注释的元素必须是一个数字，其值必须大于等于指定的最小值</li>
<li><code>@DecimalMax(value)</code>：被注释的元素必须是一个数字，其值必须小于等于指定的最大值</li>
<li><code>@Size(max=, min=)</code>：被注释的元素的大小必须在指定的范围内     </li>
<li><code>@Digits (integer, fraction)</code>：被注释的元素必须是一个数字，其值必须在可接受的范围内</li>
<li><code>@Past</code>：被注释的元素必须是一个过去的日期<br><code>@Future</code>：被注释的元素必须是一个将来的日期     </li>
<li><code>@Pattern(regex=,flag=)</code>：被注释的元素必须符合指定的正则表达式</li>
<li><code>@NotBlank(message =)</code>：验证字符串非<code>null</code>，且长度必须大于0     </li>
<li><code>@Email</code>：被注释的元素必须是电子邮箱地址     </li>
<li><code>@Length(min=,max=)</code>：被注释的字符串的大小必须在指定的范围内     </li>
<li><code>@NotEmpty</code>：被注释的字符串的必须非空     </li>
<li><code>@Range(min=,max=,message=)</code>：被注释的元素必须在合适的范围内</li>
</ol>
<h3 id="二、自定义注解校验"><a href="#二、自定义注解校验" class="headerlink" title="二、自定义注解校验"></a>二、自定义注解校验</h3><p><code>hibernate validator</code> 自带的注解可以搞定简单的参数校验，加上正则的写法，能解决绝大多数参数校验情况。但是，有些情况，比如：校验是否登录，就需要我们自定义注解校验了。为了方便测试，我这里以身份证校验为例完成自定义校验的过程。</p>
<h4 id="2-1-身份证校验工具类"><a href="#2-1-身份证校验工具类" class="headerlink" title="2.1 身份证校验工具类"></a>2.1 身份证校验工具类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdCardValidatorUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String codeAndCity[][] = &#123;&#123;<span class="string">"11"</span>, <span class="string">"北京"</span>&#125;, &#123;<span class="string">"12"</span>, <span class="string">"天津"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"13"</span>, <span class="string">"河北"</span>&#125;, &#123;<span class="string">"14"</span>, <span class="string">"山西"</span>&#125;, &#123;<span class="string">"15"</span>, <span class="string">"内蒙古"</span>&#125;, &#123;<span class="string">"21"</span>, <span class="string">"辽宁"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"22"</span>, <span class="string">"吉林"</span>&#125;, &#123;<span class="string">"23"</span>, <span class="string">"黑龙江"</span>&#125;, &#123;<span class="string">"31"</span>, <span class="string">"上海"</span>&#125;, &#123;<span class="string">"32"</span>, <span class="string">"江苏"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"33"</span>, <span class="string">"浙江"</span>&#125;, &#123;<span class="string">"34"</span>, <span class="string">"安徽"</span>&#125;, &#123;<span class="string">"35"</span>, <span class="string">"福建"</span>&#125;, &#123;<span class="string">"36"</span>, <span class="string">"江西"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"37"</span>, <span class="string">"山东"</span>&#125;, &#123;<span class="string">"41"</span>, <span class="string">"河南"</span>&#125;, &#123;<span class="string">"42"</span>, <span class="string">"湖北"</span>&#125;, &#123;<span class="string">"43"</span>, <span class="string">"湖南"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"44"</span>, <span class="string">"广东"</span>&#125;, &#123;<span class="string">"45"</span>, <span class="string">"广西"</span>&#125;, &#123;<span class="string">"46"</span>, <span class="string">"海南"</span>&#125;, &#123;<span class="string">"50"</span>, <span class="string">"重庆"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"51"</span>, <span class="string">"四川"</span>&#125;, &#123;<span class="string">"52"</span>, <span class="string">"贵州"</span>&#125;, &#123;<span class="string">"53"</span>, <span class="string">"云南"</span>&#125;, &#123;<span class="string">"54"</span>, <span class="string">"西藏"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"61"</span>, <span class="string">"陕西"</span>&#125;, &#123;<span class="string">"62"</span>, <span class="string">"甘肃"</span>&#125;, &#123;<span class="string">"63"</span>, <span class="string">"青海"</span>&#125;, &#123;<span class="string">"64"</span>, <span class="string">"宁夏"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"65"</span>, <span class="string">"新疆"</span>&#125;, &#123;<span class="string">"71"</span>, <span class="string">"台湾"</span>&#125;, &#123;<span class="string">"81"</span>, <span class="string">"香港"</span>&#125;, &#123;<span class="string">"82"</span>, <span class="string">"澳门"</span>&#125;,</span><br><span class="line">            &#123;<span class="string">"91"</span>, <span class="string">"国外"</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cityCode[] = &#123;<span class="string">"11"</span>, <span class="string">"12"</span>, <span class="string">"13"</span>, <span class="string">"14"</span>, <span class="string">"15"</span>, <span class="string">"21"</span>, <span class="string">"22"</span>,</span><br><span class="line">            <span class="string">"23"</span>, <span class="string">"31"</span>, <span class="string">"32"</span>, <span class="string">"33"</span>, <span class="string">"34"</span>, <span class="string">"35"</span>, <span class="string">"36"</span>, <span class="string">"37"</span>, <span class="string">"41"</span>, <span class="string">"42"</span>, <span class="string">"43"</span>,</span><br><span class="line">            <span class="string">"44"</span>, <span class="string">"45"</span>, <span class="string">"46"</span>, <span class="string">"50"</span>, <span class="string">"51"</span>, <span class="string">"52"</span>, <span class="string">"53"</span>, <span class="string">"54"</span>, <span class="string">"61"</span>, <span class="string">"62"</span>, <span class="string">"63"</span>,</span><br><span class="line">            <span class="string">"64"</span>, <span class="string">"65"</span>, <span class="string">"71"</span>, <span class="string">"81"</span>, <span class="string">"82"</span>, <span class="string">"91"</span>&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每位加权因子</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> power[] = &#123;<span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第18位校检码</span></span><br><span class="line">    <span class="keyword">private</span> String verifyCode[] = &#123;<span class="string">"1"</span>, <span class="string">"0"</span>, <span class="string">"X"</span>, <span class="string">"9"</span>, <span class="string">"8"</span>, <span class="string">"7"</span>, <span class="string">"6"</span>, <span class="string">"5"</span>,</span><br><span class="line">            <span class="string">"4"</span>, <span class="string">"3"</span>, <span class="string">"2"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证所有的身份证的合法性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idcard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidatedAllIdcard</span><span class="params">(String idcard)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (idcard.length() == <span class="number">15</span>) &#123;</span><br><span class="line">            idcard = convertIdcarBy15bit(idcard);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isValidate18Idcard(idcard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将15位的身份证转成18位身份证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idcard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">convertIdcarBy15bit</span><span class="params">(String idcard)</span> </span>&#123;</span><br><span class="line">        String idcard17 = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 非15位身份证</span></span><br><span class="line">        <span class="keyword">if</span> (idcard.length() != <span class="number">15</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isDigital(idcard)) &#123;</span><br><span class="line">            <span class="comment">// 获取出生年月日</span></span><br><span class="line">            String birthday = idcard.substring(<span class="number">6</span>, <span class="number">12</span>);</span><br><span class="line">            Date birthdate = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                birthdate = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyMMdd"</span>).parse(birthday);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            Calendar cday = Calendar.getInstance();</span><br><span class="line">            cday.setTime(birthdate);</span><br><span class="line">            String year = String.valueOf(cday.get(Calendar.YEAR));</span><br><span class="line"></span><br><span class="line">            idcard17 = idcard.substring(<span class="number">0</span>, <span class="number">6</span>) + year + idcard.substring(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">char</span> c[] = idcard17.toCharArray();</span><br><span class="line">            String checkCode = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != c) &#123;</span><br><span class="line">                <span class="keyword">int</span> bit[] = <span class="keyword">new</span> <span class="keyword">int</span>[idcard17.length()];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将字符数组转为整型数组</span></span><br><span class="line">                bit = converCharToInt(c);</span><br><span class="line">                <span class="keyword">int</span> sum17 = <span class="number">0</span>;</span><br><span class="line">                sum17 = getPowerSum(bit);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取和值与11取模得到余数进行校验码</span></span><br><span class="line">                checkCode = getCheckCodeBySum(sum17);</span><br><span class="line">                <span class="comment">// 获取不到校验位</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == checkCode) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 将前17位与第18位校验码拼接</span></span><br><span class="line">                idcard17 += checkCode;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 身份证包含数字</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> idcard17;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idCard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isValidate18Idcard</span><span class="params">(String idCard)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 非18位为假</span></span><br><span class="line">        <span class="keyword">if</span> (idCard.length() != <span class="number">18</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取前17位</span></span><br><span class="line">        String idcard17 = idCard.substring(<span class="number">0</span>, <span class="number">17</span>);</span><br><span class="line">        <span class="comment">// 获取第18位</span></span><br><span class="line">        String idcard18Code = idCard.substring(<span class="number">17</span>, <span class="number">18</span>);</span><br><span class="line">        <span class="keyword">char</span> c[] = <span class="keyword">null</span>;</span><br><span class="line">        String checkCode = <span class="string">""</span>;</span><br><span class="line">        <span class="comment">// 是否都为数字</span></span><br><span class="line">        <span class="keyword">if</span> (isDigital(idcard17)) &#123;</span><br><span class="line">            c = idcard17.toCharArray();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != c) &#123;</span><br><span class="line">            <span class="keyword">int</span> bit[] = <span class="keyword">new</span> <span class="keyword">int</span>[idcard17.length()];</span><br><span class="line">            bit = converCharToInt(c);</span><br><span class="line">            <span class="keyword">int</span> sum17 = <span class="number">0</span>;</span><br><span class="line">            sum17 = getPowerSum(bit);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将和值与11取模得到余数进行校验码判断</span></span><br><span class="line">            checkCode = getCheckCodeBySum(sum17);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == checkCode) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将身份证的第18位与算出来的校码进行匹配，不相等就为假</span></span><br><span class="line">            <span class="keyword">if</span> (!idcard18Code.equalsIgnoreCase(checkCode)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 18位身份证号码的基本数字和位数验校</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> idCard</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">is18Idcard</span><span class="params">(String idCard)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Pattern.matches(<span class="string">"^[1-9]\\d&#123;5&#125;[1-9]\\d&#123;3&#125;((0\\d)|(1[0-2]))(([0|1|2]\\d)|3[0-1])\\d&#123;3&#125;([\\d|x|X]&#123;1&#125;)$"</span>, idCard);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数字验证</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDigital</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str == <span class="keyword">null</span> || <span class="string">""</span>.equals(str) ? <span class="keyword">false</span> : str.matches(<span class="string">"^[0-9]*$"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将身份证的每位和对应位的加权因子相乘之后，再得到和值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPowerSum</span><span class="params">(<span class="keyword">int</span>[] bit)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (power.length != bit.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bit.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; power.length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == j) &#123;</span><br><span class="line">                    sum = sum + bit[i] * power[j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将和值与11取模得到余数进行校验码判断</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sum17</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 校验位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCheckCodeBySum</span><span class="params">(<span class="keyword">int</span> sum17)</span> </span>&#123;</span><br><span class="line">        String checkCode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (sum17 % <span class="number">11</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">                checkCode = <span class="string">"2"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">                checkCode = <span class="string">"3"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                checkCode = <span class="string">"4"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                checkCode = <span class="string">"5"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                checkCode = <span class="string">"6"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                checkCode = <span class="string">"7"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                checkCode = <span class="string">"8"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                checkCode = <span class="string">"9"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                checkCode = <span class="string">"x"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                checkCode = <span class="string">"0"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                checkCode = <span class="string">"1"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> checkCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将字符数组转为整型数组</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> c</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NumberFormatException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] converCharToInt(<span class="keyword">char</span>[] c) <span class="keyword">throws</span> NumberFormatException &#123;</span><br><span class="line">        <span class="keyword">int</span>[] a = <span class="keyword">new</span> <span class="keyword">int</span>[c.length];</span><br><span class="line">        <span class="keyword">int</span> k = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> temp : c) &#123;</span><br><span class="line">            a[k++] = Integer.parseInt(String.valueOf(temp));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String idCardForFalse = <span class="string">"350583199108290106"</span>;</span><br><span class="line">        String idCardForTrue = <span class="string">"350583197106150219"</span>;</span><br><span class="line">        <span class="keyword">if</span> (IdCardValidatorUtils.isValidatedAllIdcard(idCardForTrue)) &#123;</span><br><span class="line">            System.out.println(<span class="string">"身份证校验正确"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"身份证校验错误！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-2-自定义注解"><a href="#2-2-自定义注解" class="headerlink" title="2.2 自定义注解"></a>2.2 自定义注解</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.PARAMETER, ElementType.FIELD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = IdentityCardNumberValidator<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">IdentityCardNumber</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "身份证号码格式不正确"</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>仔细的你会发现，相对于一般的自定义注解，该注解：<br><code>@Constraint(validatedBy = IdentityCardNumberValidator.class)</code>,该注解的作用就是调用身份证校验的工具。</p>
</blockquote>
<h4 id="2-3-在UserDTO-需要校验的字段添加声明"><a href="#2-3-在UserDTO-需要校验的字段添加声明" class="headerlink" title="2.3 在UserDTO 需要校验的字段添加声明"></a>2.3 在<code>UserDTO</code> 需要校验的字段添加声明</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 身份证号（校验：自定义注解校验）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@IdentityCardNumber</span></span><br><span class="line"><span class="keyword">private</span> String idNumber;</span><br></pre></td></tr></table></figure>

<h4 id="2-4-控制层接口"><a href="#2-4-控制层接口" class="headerlink" title="2.4 控制层接口"></a>2.4 控制层接口</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/custom"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorCustomController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义注解参数校验案例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">test</span><span class="params">(@Validated UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-5-自定义注解的测试"><a href="#2-5-自定义注解的测试" class="headerlink" title="2.5 自定义注解的测试"></a>2.5 自定义注解的测试</h4><ul>
<li>请求方式：POST</li>
<li>请求地址：localhost:8080/private/test</li>
<li>请求参数：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">userName:Van</span><br><span class="line">mobile:17098705205</span><br><span class="line">email:110@qq.com</span><br><span class="line">idNumber:350583199108290106</span><br></pre></td></tr></table></figure>
<ul>
<li>返回结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"success"</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="string">"data"</span>: <span class="keyword">null</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"身份证号码格式不正确"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三、分组校验"><a href="#三、分组校验" class="headerlink" title="三、分组校验"></a>三、分组校验</h3><p>除了上述的校验外，可能还有这种需求：</p>
<p>在创建用户信息时，不需要校验<code>userId</code>;但在更新用户信息时，需要校验<code>userId</code>,而用户名，邮箱等两种情况都得校验。这种情况，就可以<strong>分组校验</strong>来解决了。</p>
<h4 id="3-1-定义分组接口"><a href="#3-1-定义分组接口" class="headerlink" title="3.1  定义分组接口"></a>3.1  定义分组接口</h4><ul>
<li><code>Create.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.validation.groups.Default;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Create</span> <span class="keyword">extends</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Update.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.validation.groups.Default;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Update</span> <span class="keyword">extends</span> <span class="title">Default</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-在UserDTO-需要校验的字段添加声明"><a href="#3-2-在UserDTO-需要校验的字段添加声明" class="headerlink" title="3.2 在UserDTO 需要校验的字段添加声明"></a>3.2 在<code>UserDTO</code> 需要校验的字段添加声明</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 用户id(只有在有Update分组中校验非空)</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @NotNull(message &#x3D; &quot;id 不能为空&quot;, groups &#x3D; Update.class)</span><br><span class="line">    private Long userId;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-控制层入参位置进行声明"><a href="#3-3-控制层入参位置进行声明" class="headerlink" title="3.3 控制层入参位置进行声明"></a>3.3 控制层入参位置进行声明</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/groups"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorGroupsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新数据，需要传入userID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">updateData</span><span class="params">(@Validated(Update.class)</span>UserDTO userDTO) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增数据，不需要传入userID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">createData</span><span class="params">(@Validated(Create.class)</span>UserDTO userDTO) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(userDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-分组校验的测试-新增测试"><a href="#3-4-分组校验的测试-新增测试" class="headerlink" title="3.4 分组校验的测试-新增测试"></a>3.4 分组校验的测试-新增测试</h4><ul>
<li>请求方式：POST</li>
<li>请求地址：localhost:8080/groups/create</li>
<li>请求参数：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">userName:Van</span><br><span class="line">mobile:17098705205</span><br><span class="line">email:110@qq.com</span><br><span class="line">idNumber:350583197106150219</span><br><span class="line">userId:</span><br></pre></td></tr></table></figure>
<ul>
<li>返回结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"success"</span>: <span class="keyword">true</span>,</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">        <span class="string">"userId"</span>: <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">"sex"</span>: <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">"userName"</span>: <span class="string">"Van"</span>,</span><br><span class="line">        <span class="string">"mobile"</span>: <span class="string">"17098705205"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">"110@qq.com"</span>,</span><br><span class="line">        <span class="string">"idNumber"</span>: <span class="string">"350583197106150219"</span>,</span><br><span class="line">        <span class="string">"passWord"</span>: <span class="keyword">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"message"</span>: <span class="keyword">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求成功，说明新增请求，不检验<code>userId</code>，即<code>userId</code>可以为空。</p>
<h4 id="3-5-分组校验的测试-更新测试"><a href="#3-5-分组校验的测试-更新测试" class="headerlink" title="3.5 分组校验的测试-更新测试"></a>3.5 分组校验的测试-更新测试</h4><ul>
<li>请求方式：POST</li>
<li>请求地址：localhost:8080/groups/update</li>
<li>请求参数：同上（3.4）</li>
<li>返回结果：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"success"</span>: <span class="keyword">false</span>,</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">400</span>,</span><br><span class="line">    <span class="string">"data"</span>: <span class="keyword">null</span>,</span><br><span class="line">    <span class="string">"message"</span>: <span class="string">"id 不能为空"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求失败，说明更新请求，检验<code>userId</code>，即<code>userId</code>不能为空。</p>
<blockquote>
<p>结合 3.4 与 3.5 的测试结果，说明分组校验成功。</p>
</blockquote>
<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>希望大家写的每一行代码都是业务需要，而不是无聊且无穷无尽的参数校验。</p>
<p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-parameter/validator-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>代码设计</category>
      </categories>
      <tags>
        <tag>validator</tag>
        <tag>if else</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 发送邮件</title>
    <url>/2019/08/12/b7188264.html</url>
    <content><![CDATA[<p>发送邮件应该是网站的必备拓展功能之一，注册验证、忘记密码或者是给用户发送营销信息。</p>
<a id="more"></a>

<h2 id="一、邮件协议"><a href="#一、邮件协议" class="headerlink" title="一、邮件协议"></a>一、邮件协议</h2><p>在收发邮件的过程中，需要遵守相关的协议，其中主要有：</p>
<ol>
<li>发送电子邮件的协议：<code>SMTP</code>；</li>
<li>接收电子邮件的协议：<code>POP3</code>和<code>IMAP</code>。</li>
</ol>
<h3 id="1-1-什么是SMTP？"><a href="#1-1-什么是SMTP？" class="headerlink" title="1.1 什么是SMTP？"></a>1.1 什么是<code>SMTP</code>？</h3><p><code>SMTP</code>全称为<code>Simple Mail Transfer Protocol</code>（简单邮件传输协议），它是一组用于从源地址到目的地址传输邮件的规范，通过它来控制邮件的中转方式。<code>SMTP</code>认证要求必须提供账号和密码才能登陆服务器，其设计目的在于避免用户受到垃圾邮件的侵扰。</p>
<h3 id="1-2-什么是IMAP？"><a href="#1-2-什么是IMAP？" class="headerlink" title="1.2 什么是IMAP？"></a>1.2 什么是<code>IMAP</code>？</h3><p><code>IMAP</code>全称为<code>Internet Message Access Protocol</code>（互联网邮件访问协议），<code>IMAP</code>允许从邮件服务器上获取邮件的信息、下载邮件等。<code>IMAP</code>与<code>POP</code>类似，都是一种邮件获取协议。</p>
<h3 id="1-3-什么是POP3？"><a href="#1-3-什么是POP3？" class="headerlink" title="1.3 什么是POP3？"></a>1.3 什么是<code>POP3</code>？</h3><p><code>POP3</code>全称为<code>Post Office Protocol 3</code>（邮局协议），<code>POP3</code>支持客户端远程管理服务器端的邮件。<code>POP3</code>常用于<strong>离线</strong>邮件处理，即允许客户端下载服务器邮件，然后服务器上的邮件将会被删除。目前很多<code>POP3</code>的邮件服务器只提供下载邮件功能，服务器本身并不删除邮件，这种属于改进版的<code>POP3</code>协议。</p>
<h3 id="1-4-IMAP和POP3协议有什么不同呢？"><a href="#1-4-IMAP和POP3协议有什么不同呢？" class="headerlink" title="1.4 IMAP和POP3协议有什么不同呢？"></a>1.4 <code>IMAP</code>和<code>POP3</code>协议有什么不同呢？</h3><p>两者最大的区别在于，<code>IMAP</code>允许双向通信，即在客户端的操作会反馈到服务器上，例如在客户端收取邮件、标记已读等操作，服务器会跟着同步这些操作。而对于<code>POP</code>协议虽然也允许客户端下载服务器邮件，但是在客户端的操作并不会同步到服务器上面的，例如在客户端收取或标记已读邮件，服务器不会同步这些操作。</p>
<p>本文主要演示了<code>Spring Boot</code>整合邮件功能，包括发送简单文本邮件、附件邮件、模板邮件。</p>
<h2 id="二、初始化配置"><a href="#二、初始化配置" class="headerlink" title="二、初始化配置"></a>二、初始化配置</h2><h3 id="2-1-开启邮件服务"><a href="#2-1-开启邮件服务" class="headerlink" title="2.1 开启邮件服务"></a>2.1 开启邮件服务</h3><blockquote>
<p>本文仅以<code>QQ</code>邮箱和<code>163</code>邮箱为例。</p>
</blockquote>
<ol>
<li><a href="https://service.mail.qq.com/cgi-bin/help?subtype=1&&no=1001256&&id=28" target="_blank" rel="noopener"><code>QQ</code>邮箱 开启邮件服务文档</a></li>
<li><a href="http://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac2cda80145a1742516" target="_blank" rel="noopener"><code>163</code>邮箱 开启邮件服务文档</a></li>
</ol>
<h3 id="2-2-pom-xml"><a href="#2-2-pom-xml" class="headerlink" title="2.2 pom.xml"></a>2.2 <code>pom.xml</code></h3><blockquote>
<p>正常我们会用<code>JavaMail</code>相关<code>api</code>来写发送邮件的相关代码，但现在<code>Spring Boot</code>提供了一套更简易使用的封装。</p>
</blockquote>
<ol>
<li><code>spring-boot-starter-mail</code>:<code>Spring Boot</code> 邮件服务；</li>
<li><code>spring-boot-starter-thymeleaf</code>:使用 <code>Thymeleaf</code>制作邮件模版。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- test 包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mail --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--使用 Thymeleaf 制作邮件模板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>1.8.4<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-application-yml"><a href="#2-3-application-yml" class="headerlink" title="2.3 application.yml"></a>2.3 <code>application.yml</code></h3><p><code>spring-boot-starter-mail</code> 的配置由 <code>MailProperties</code> 配置类提供。</p>
<p>针对不同的邮箱的配置略有不同，以下是<code>QQ</code>邮箱和<code>163</code>邮箱的配置。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">#spring:</span><br><span class="line">#  mail:</span><br><span class="line">#    # QQ 邮箱 https://service.mail.qq.com/cgi-bin/help?subtype=1&amp;&amp;no=1001256&amp;&amp;id=28</span><br><span class="line">#    host: smtp.qq.com</span><br><span class="line">#    # 邮箱账号</span><br><span class="line">#    username: van93@qq.com</span><br><span class="line">#    # 邮箱授权码（不是密码）</span><br><span class="line">#    password: password</span><br><span class="line">#    default-encoding: UTF-8</span><br><span class="line">#    properties:</span><br><span class="line">#      mail:</span><br><span class="line">#        smtp:</span><br><span class="line">#          auth: true</span><br><span class="line">#          starttls:</span><br><span class="line">#            enable: true</span><br><span class="line">#            required: true</span><br><span class="line">spring:</span><br><span class="line">  mail:</span><br><span class="line">    # 163 邮箱 http://help.mail.163.com/faqDetail.do?code=d7a5dc8471cd0c0e8b4b8f4f8e49998b374173cfe9171305fa1ce630d7f67ac2cda80145a1742516</span><br><span class="line">    host: smtp.163.com</span><br><span class="line">    # 邮箱账号</span><br><span class="line">    username: 17098705205@163.com</span><br><span class="line">    # 邮箱授权码（不是密码）</span><br><span class="line">    password: password</span><br><span class="line">    default-encoding: UTF-8</span><br><span class="line">    properties:</span><br><span class="line">      mail:</span><br><span class="line">        smtp:</span><br><span class="line">          auth: true</span><br><span class="line">          starttls:</span><br><span class="line">            enable: true</span><br><span class="line">            required: true</span><br></pre></td></tr></table></figure>

<h3 id="2-4-邮件信息类"><a href="#2-4-邮件信息类" class="headerlink" title="2.4 邮件信息类"></a>2.4 邮件信息类</h3><blockquote>
<p>来保存发送邮件时的邮件主题、邮件内容等信息</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Mail</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件发送人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件接收人 （多个邮箱则用逗号","隔开）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String receiver;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件主题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 附件/文件地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String filePath;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 附件/文件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否有附件（默认没有）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isTemplate = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模版名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String emailTemplateName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模版内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Context emailTemplateContext;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、发送邮件的实现"><a href="#三、发送邮件的实现" class="headerlink" title="三、发送邮件的实现"></a>三、发送邮件的实现</h2><h3 id="3-1-检查输入的邮件配置"><a href="#3-1-检查输入的邮件配置" class="headerlink" title="3.1 检查输入的邮件配置"></a>3.1 检查输入的邮件配置</h3><blockquote>
<p>校验邮件收信人、邮件主题和邮件内容这些必填项</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkMail</span><span class="params">(Mail mail)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(mail.getReceiver())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"邮件收信人不能为空"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(mail.getSubject())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"邮件主题不能为空"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(mail.getText()) &amp;&amp; <span class="keyword">null</span> == mail.getEmailTemplateContext()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"邮件内容不能为空"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-将邮件保存到数据库"><a href="#3-2-将邮件保存到数据库" class="headerlink" title="3.2 将邮件保存到数据库"></a>3.2 将邮件保存到数据库</h3><p>发送结束后将邮件保存到数据库，便于统计和追查邮件问题。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Mail <span class="title">saveMail</span><span class="params">(Mail mail)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// todo 发送成功/失败将邮件信息同步到数据库</span></span><br><span class="line">    <span class="keyword">return</span> mail;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-发送邮件"><a href="#3-3-发送邮件" class="headerlink" title="3.3 发送邮件"></a>3.3 发送邮件</h3><ul>
<li>发送纯文本邮件</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSimpleMail</span><span class="params">(Mail mail)</span></span>&#123;</span><br><span class="line">    checkMail(mail);</span><br><span class="line">    SimpleMailMessage mailMessage = <span class="keyword">new</span> SimpleMailMessage();</span><br><span class="line">    mailMessage.setFrom(sender);</span><br><span class="line">    mailMessage.setTo(mail.getReceiver());</span><br><span class="line">    mailMessage.setSubject(mail.getSubject());</span><br><span class="line">    mailMessage.setText(mail.getText());</span><br><span class="line">    mailSender.send(mailMessage);</span><br><span class="line">    saveMail(mail);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ul>
<li>发送邮件并携带附件</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAttachmentsMail</span><span class="params">(Mail mail)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line">    checkMail(mail);</span><br><span class="line">    MimeMessage mimeMessage = mailSender.createMimeMessage();</span><br><span class="line">    MimeMessageHelper helper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage, <span class="keyword">true</span>);</span><br><span class="line">    helper.setFrom(sender);</span><br><span class="line">    helper.setTo(mail.getReceiver());</span><br><span class="line">    helper.setSubject(mail.getSubject());</span><br><span class="line">    helper.setText(mail.getText());</span><br><span class="line">    File file = <span class="keyword">new</span> File(mail.getFilePath());</span><br><span class="line">    helper.addAttachment(file.getName(), file);</span><br><span class="line">    mailSender.send(mimeMessage);</span><br><span class="line">    saveMail(mail);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>发送模版邮件</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendTemplateMail</span><span class="params">(Mail mail)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line">    checkMail(mail);</span><br><span class="line">    <span class="comment">// templateEngine 替换掉动态参数，生产出最后的html</span></span><br><span class="line">    String emailContent = templateEngine.process(mail.getEmailTemplateName(), mail.getEmailTemplateContext());</span><br><span class="line"></span><br><span class="line">    MimeMessage mimeMessage = mailSender.createMimeMessage();</span><br><span class="line"></span><br><span class="line">    MimeMessageHelper helper = <span class="keyword">new</span> MimeMessageHelper(mimeMessage, <span class="keyword">true</span>);</span><br><span class="line">    helper.setFrom(sender);</span><br><span class="line">    helper.setTo(mail.getReceiver());</span><br><span class="line">    helper.setSubject(mail.getSubject());</span><br><span class="line">    helper.setText(emailContent, <span class="keyword">true</span>);</span><br><span class="line">    mailSender.send(mimeMessage);</span><br><span class="line">    saveMail(mail);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、测试及优化"><a href="#四、测试及优化" class="headerlink" title="四、测试及优化"></a>四、测试及优化</h2><h3 id="4-1-单元测试"><a href="#4-1-单元测试" class="headerlink" title="4.1 单元测试"></a>4.1 单元测试</h3><ol>
<li>测试附件邮件时，附件放在<code>static</code>文件夹下；</li>
<li>测试模版邮件时，模版放在<code>file</code>文件夹下。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MailServiceTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    MailService mailService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送纯文本邮件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSimpleMail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Mail mail = <span class="keyword">new</span> Mail();</span><br><span class="line"><span class="comment">//        mail.setReceiver("17098705205@163.com");</span></span><br><span class="line">        mail.setReceiver(<span class="string">"van93@qq.com"</span>);</span><br><span class="line">        mail.setSubject(<span class="string">"测试简单邮件"</span>);</span><br><span class="line">        mail.setText(<span class="string">"测试简单内容"</span>);</span><br><span class="line">        mailService.sendSimpleMail(mail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送邮件并携带附件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAttachmentsMail</span><span class="params">()</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line">        Mail mail = <span class="keyword">new</span> Mail();</span><br><span class="line"><span class="comment">//        mail.setReceiver("17098705205@163.com");</span></span><br><span class="line">        mail.setReceiver(<span class="string">"van93@qq.com"</span>);</span><br><span class="line">        mail.setSubject(<span class="string">"测试附件邮件"</span>);</span><br><span class="line">        mail.setText(<span class="string">"附件邮件内容"</span>);</span><br><span class="line">        mail.setFilePath(<span class="string">"file/dusty_blog.jpg"</span>);</span><br><span class="line">        mailService.sendAttachmentsMail(mail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试模版邮件邮件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendTemplateMail</span><span class="params">()</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line">        Mail mail = <span class="keyword">new</span> Mail();</span><br><span class="line"><span class="comment">//        mail.setReceiver("17098705205@163.com");</span></span><br><span class="line">        mail.setReceiver(<span class="string">"van93@qq.com"</span>);</span><br><span class="line">        mail.setSubject(<span class="string">"测试模版邮件邮件"</span>);</span><br><span class="line">        <span class="comment">//创建模版正文</span></span><br><span class="line">        Context context = <span class="keyword">new</span> Context();</span><br><span class="line">        <span class="comment">// 设置模版需要更换的参数</span></span><br><span class="line">        context.setVariable(<span class="string">"verifyCode"</span>, <span class="string">"6666"</span>);</span><br><span class="line">        mail.setEmailTemplateContext(context);</span><br><span class="line">        <span class="comment">// 模版名称(模版位置位于templates目录下)</span></span><br><span class="line">        mail.setEmailTemplateName(<span class="string">"emailTemplate"</span>);</span><br><span class="line">        mailService.sendTemplateMail(mail);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-优化"><a href="#4-2-优化" class="headerlink" title="4.2 优化"></a>4.2 优化</h3><p>因为平时发送邮件还有抄送/密送等需求，这里，封装一个实体和工具类，便于直接调用邮件服务。</p>
<ul>
<li>邮件信息类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailDomain</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件发送人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件接收人 （多个邮箱则用逗号","隔开）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String receiver;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件主题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String subject;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮件内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String text;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抄送（多个邮箱则用逗号","隔开）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String cc;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密送（多个邮箱则用逗号","隔开）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String bcc;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 附件/文件地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String filePath;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 附件/文件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否有附件（默认没有）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isTemplate = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模版名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String emailTemplateName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模版内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Context emailTemplateContext;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送时间(可指定未来发送时间)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date sentDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>邮件工具类</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JavaMailSender mailSender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    TemplateEngine templateEngine;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.mail.username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String sender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建复杂邮件信息类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mail</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> MessagingException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMail</span><span class="params">(MailDomain mail)</span> <span class="keyword">throws</span> MessagingException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//true表示支持复杂类型</span></span><br><span class="line">        MimeMessageHelper messageHelper = <span class="keyword">new</span> MimeMessageHelper(mailSender.createMimeMessage(), <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//邮件发信人从配置项读取</span></span><br><span class="line">        mail.setSender(sender);</span><br><span class="line">        <span class="comment">//邮件发信人</span></span><br><span class="line">        messageHelper.setFrom(mail.getSender());</span><br><span class="line">        <span class="comment">//邮件收信人</span></span><br><span class="line">        messageHelper.setTo(mail.getReceiver().split(<span class="string">","</span>));</span><br><span class="line">        <span class="comment">//邮件主题</span></span><br><span class="line">        messageHelper.setSubject(mail.getSubject());</span><br><span class="line">        <span class="comment">//邮件内容</span></span><br><span class="line">        <span class="keyword">if</span> (mail.getIsTemplate()) &#123;</span><br><span class="line">            <span class="comment">// templateEngine 替换掉动态参数，生产出最后的html</span></span><br><span class="line">            String emailContent = templateEngine.process(mail.getEmailTemplateName(), mail.getEmailTemplateContext());</span><br><span class="line">            messageHelper.setText(emailContent, <span class="keyword">true</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            messageHelper.setText(mail.getText());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//抄送</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(mail.getCc())) &#123;</span><br><span class="line">            messageHelper.setCc(mail.getCc().split(<span class="string">","</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//密送</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(mail.getBcc())) &#123;</span><br><span class="line">            messageHelper.setCc(mail.getBcc().split(<span class="string">","</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//添加邮件附件</span></span><br><span class="line">        <span class="keyword">if</span> (mail.getFilePath() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(mail.getFilePath());</span><br><span class="line">            messageHelper.addAttachment(file.getName(), file);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//发送时间</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(mail.getSentDate())) &#123;</span><br><span class="line">            messageHelper.setSentDate(mail.getSentDate());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//正式发送邮件</span></span><br><span class="line">        mailSender.send(messageHelper.getMimeMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检测邮件信息类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mail</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkMail</span><span class="params">(MailDomain mail)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(mail.getReceiver())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"邮件收信人不能为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(mail.getSubject())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"邮件主题不能为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(mail.getText()) &amp;&amp; <span class="keyword">null</span> == mail.getEmailTemplateContext()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"邮件内容不能为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将邮件保存到数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mail</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> MailDomain <span class="title">saveMail</span><span class="params">(MailDomain mail)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// todo 发送成功/失败将邮件信息同步到数据库</span></span><br><span class="line">        <span class="keyword">return</span> mail;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>具体的测试详见<a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-list/send-mail" target="_blank" rel="noopener">Github 示例代码</a>，这里就不贴出来了。</p>
</blockquote>
<h2 id="五、-总结及延伸"><a href="#五、-总结及延伸" class="headerlink" title="五、 总结及延伸"></a>五、 总结及延伸</h2><h3 id="5-1-异步发送"><a href="#5-1-异步发送" class="headerlink" title="5.1 异步发送"></a>5.1 异步发送</h3><p>很多时候邮件发送并不是我们主业务必须关注的结果，比如通知类、提醒类的业务可以允许延时或者失败。这个时候可以采用异步的方式来发送邮件，加快主交易执行速度，在实际项目中可以采用<code>MQ</code>发送邮件相关参数，监听到消息队列之后启动发送邮件。</p>
<h3 id="5-2-发送失败情况"><a href="#5-2-发送失败情况" class="headerlink" title="5.2 发送失败情况"></a>5.2 发送失败情况</h3><p>因为各种原因，总会有邮件发送失败的情况，比如：邮件发送过于频繁、网络异常等。在出现这种情况的时候，我们一般会考虑重新重试发送邮件，会分为以下几个步骤来实现：</p>
<ol>
<li>接收到发送邮件请求，首先记录请求并且入库；</li>
<li>调用邮件发送接口发送邮件，并且将发送结果记录入库；</li>
<li>启动定时系统扫描时间段内，未发送成功并且重试次数小于<code>3</code>次的邮件，进行再次发送。</li>
</ol>
<h3 id="5-3-其他问题"><a href="#5-3-其他问题" class="headerlink" title="5.3 其他问题"></a>5.3 其他问题</h3><p>邮件端口问题和附件大小问题。</p>
<h3 id="5-4-示例代码地址"><a href="#5-4-示例代码地址" class="headerlink" title="5.4 示例代码地址"></a>5.4 示例代码地址</h3><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-list/send-mail" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>邮件</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis 数据源灵活切换</title>
    <url>/2019/07/31/84b29986.html</url>
    <content><![CDATA[<p>在业务场景中，随着数据量迅速增长，一个库一个表已经满足不了我们的需求的时候，我们就会考虑分库分表的操作，本文主要介绍 <code>Mybatis</code> 动态数据源切换，可用于读写分离或多库存储。</p>
<a id="more"></a>

<h2 id="一、开始项目"><a href="#一、开始项目" class="headerlink" title="一、开始项目"></a>一、开始项目</h2><h3 id="1-1-数据库准备"><a href="#1-1-数据库准备" class="headerlink" title="1.1 数据库准备"></a>1.1 数据库准备</h3><p>我这里操作两个数据库（<code>master</code>/<code>slave</code>），首先都在两个库中插入同一个表，<code>sql</code>如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</span><br><span class="line">  <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户名'</span>,</span><br><span class="line">  <span class="string">`pass_word`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`user_sex`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'性别'</span>,</span><br><span class="line">  <span class="string">`nick_name`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</span><br><span class="line">  <span class="string">`gmt_create`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<p>为了区分，<code>master</code> 库和 <code>slave</code> 分别插入一条不同的数据：</p>
<ul>
<li><code>master</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'master'</span>, <span class="string">'password'</span>, <span class="string">'男'</span>, <span class="string">'主库'</span>, <span class="string">'2019-04-10 16:24:14'</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>slave</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'slave'</span>, <span class="string">'password'</span>, <span class="string">'女'</span>, <span class="string">'从库'</span>, <span class="string">'2019-04-10 16:24:14'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-2-pom-xml"><a href="#1-2-pom-xml" class="headerlink" title="1.2 pom.xml"></a>1.2 <code>pom.xml</code></h3><p>通过<code>AOP</code>注解切换数据源，需要<code>AOP</code>包，使用<code>druid</code>连接池，<code>mysql</code> + <code>mybatis</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- aop 依赖 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- druid连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>1.8.4<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-application-yml"><a href="#1-3-application-yml" class="headerlink" title="1.3 application.yml"></a>1.3 <code>application.yml</code></h3><p>配置了 <code>master</code> 和 <code>slave</code> 两个库，这里也可以使用两种不同类型的数据库，如<code>mysql + postgrapsql</code>，连接池使用 <code>druid</code> 。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    # 主数据源</span><br><span class="line">    master:</span><br><span class="line">      url: jdbc:mysql://47.98.178.84:3306/master</span><br><span class="line">      username: master</span><br><span class="line">      password: password</span><br><span class="line">    # 其他数据源（可多个）</span><br><span class="line">    slave:</span><br><span class="line">      url: jdbc:mysql://47.98.178.84:3306/slave</span><br><span class="line">      username: slave</span><br><span class="line">      password: password</span><br><span class="line"># mybatis sql 日志</span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    cn:</span><br><span class="line">      van:</span><br><span class="line">        annotation:</span><br><span class="line">          multipleDataSource:</span><br><span class="line">            mapper: debug</span><br></pre></td></tr></table></figure>

<h2 id="二、多数据源配置"><a href="#二、多数据源配置" class="headerlink" title="二、多数据源配置"></a>二、多数据源配置</h2><h3 id="2-1-数据源枚举"><a href="#2-1-数据源枚举" class="headerlink" title="2.1 数据源枚举"></a>2.1 数据源枚举</h3><p>我这里有两个数据源，我们用枚举类来代替，方便我们后续扩展和管理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DynamicDSEnum &#123;</span><br><span class="line">    MASTER(<span class="number">1</span>,<span class="string">"master"</span>),</span><br><span class="line">    SLAVE(<span class="number">2</span>,<span class="string">"slave"</span>),</span><br><span class="line">    </span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    DynamicDSEnum(Integer code, String desc) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(Integer code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-数据源配置"><a href="#2-2-数据源配置" class="headerlink" title="2.2 数据源配置"></a>2.2 数据源配置</h3><p>这里配置了两个数据源，主库：<code>masterDS</code> 和 从库：<code>slaveDS</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.master"</span>)</span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"masterDS"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">masterDS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.slave"</span>)</span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"slaveDS"</span>)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">slaveDS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DruidDataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主从动态配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DynamicDataSource <span class="title">dynamicDS</span><span class="params">(@Qualifier(<span class="string">"masterDS"</span>)</span> DataSource masterDataSource,</span></span><br><span class="line"><span class="function">                                       @<span class="title">Autowired</span><span class="params">(required = <span class="keyword">false</span>)</span> @<span class="title">Qualifier</span><span class="params">(<span class="string">"slaveDS"</span>)</span> DataSource slaveDataSource) </span>&#123;</span><br><span class="line">        DynamicDataSource dynamicDataSource = <span class="keyword">new</span> DynamicDataSource();</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">        targetDataSources.put(DynamicDSEnum.MASTER.getDesc(), masterDataSource);</span><br><span class="line">        <span class="keyword">if</span> (slaveDataSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetDataSources.put(DynamicDSEnum.SLAVE.getDesc(), slaveDataSource);</span><br><span class="line">        &#125;</span><br><span class="line">        dynamicDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">        dynamicDataSource.setDefaultTargetDataSource(masterDataSource);</span><br><span class="line">        <span class="keyword">return</span> dynamicDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">sessionFactory</span><span class="params">(@Qualifier(<span class="string">"dynamicDS"</span>)</span> DataSource dynamicDataSource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setMapperLocations(</span><br><span class="line">                <span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath*:mapper/*Mapper.xml"</span>));</span><br><span class="line">        bean.setDataSource(dynamicDataSource);</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">sqlTemplate</span><span class="params">(@Qualifier(<span class="string">"sessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"dataSourceTx"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">dataSourceTx</span><span class="params">(@Qualifier(<span class="string">"dynamicDS"</span>)</span> DataSource dynamicDataSource) </span>&#123;</span><br><span class="line">        DataSourceTransactionManager dataSourceTransactionManager = <span class="keyword">new</span> DataSourceTransactionManager();</span><br><span class="line">        dataSourceTransactionManager.setDataSource(dynamicDataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSourceTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-设置路由"><a href="#2-3-设置路由" class="headerlink" title="2.3 设置路由"></a>2.3 设置路由</h3><p>用于记录当前线程使用的数据源的<code>key</code>是什么，以及记录所有注册成功的数据源的key的集合。用 <code>ThreadLocal</code> 保存数据源的信息到每个线程中，方便我们需要时获取。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceContextHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; DYNAMIC_DATASOURCE_CONTEXT = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String datasourceType)</span> </span>&#123;</span><br><span class="line">        DYNAMIC_DATASOURCE_CONTEXT.set(datasourceType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DYNAMIC_DATASOURCE_CONTEXT.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DYNAMIC_DATASOURCE_CONTEXT.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-获取路由"><a href="#2-4-获取路由" class="headerlink" title="2.4 获取路由"></a>2.4 获取路由</h3><p><code>Spring</code>提供一个接口，名为<code>AbstractRoutingDataSource</code>的抽象类，我们只需要重写<code>determineCurrentLookupKey</code>方法就可以通知<code>Spring</code>用<code>key</code>获取当前的数据源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceContextHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、通过AOP注解实现数据源动态切换"><a href="#三、通过AOP注解实现数据源动态切换" class="headerlink" title="三、通过AOP注解实现数据源动态切换"></a>三、通过<code>AOP</code>注解实现数据源动态切换</h2><h3 id="3-1-切换数据源的注解"><a href="#3-1-切换数据源的注解" class="headerlink" title="3.1 切换数据源的注解"></a>3.1 切换数据源的注解</h3><p>为了可以方便切换数据源，我们可以写一个注解，注解中包含数据源对应的枚举值，默认是主库，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DS &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果没设置数据源，默认 用 master 库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">DynamicDSEnum <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> DynamicDSEnum.MASTER</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">clear</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-切换数据源切面"><a href="#3-2-切换数据源切面" class="headerlink" title="3.2 切换数据源切面"></a>3.2 切换数据源切面</h3><p>对有注解的方法做切换数据源的操作。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class DataSourceAspect &#123;</span><br><span class="line"></span><br><span class="line">    @Pointcut(&quot;@annotation(cn.van.multipledata.demo.annotation.DS)&quot;)</span><br><span class="line">    public void dataSourceAspect() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Around(&quot;dataSourceAspect()&quot;)</span><br><span class="line">    public Object around(ProceedingJoinPoint pjp) throws Throwable &#123;</span><br><span class="line">        boolean clear &#x3D; true;</span><br><span class="line">        try &#123;</span><br><span class="line">            Method method &#x3D; this.getMethod(pjp);</span><br><span class="line">            DS DS &#x3D; method.getAnnotation(DS.class);</span><br><span class="line">            clear &#x3D; DS.clear();</span><br><span class="line">            DataSourceContextHolder.set(DS.value().getDesc());</span><br><span class="line">            log.info(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;数据源切换至：&#123;&#125;&quot;, DS.value().getDesc());</span><br><span class="line">            return pjp.proceed();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (clear) &#123;</span><br><span class="line">                DataSourceContextHolder.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Method getMethod(JoinPoint pjp) &#123;</span><br><span class="line">        MethodSignature signature &#x3D; (MethodSignature) pjp.getSignature();</span><br><span class="line">        return signature.getMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、测试多数据源配置"><a href="#四、测试多数据源配置" class="headerlink" title="四、测试多数据源配置"></a>四、测试多数据源配置</h2><p><code>UserService.java</code>两个方法<code>selectMaster()</code>、<code>selectSlave()</code>及其实现；分别查询 <code>master</code> 和 <code>slave</code> 库的数据。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"userService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">selectMaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DS</span>(value = DynamicDSEnum.SLAVE)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">selectSlave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-查询-master-库"><a href="#4-1-查询-master-库" class="headerlink" title="4.1 查询 master 库"></a>4.1 查询 <code>master</code> 库</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectMaster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserInfo&gt; users = userService.selectMaster();</span><br><span class="line">    log.info(<span class="string">"master-users:&#123;&#125;"</span>, users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">....: master-users:[User&#123;id=1, userName='master', passWord='password', userSex='男', nickName='主库', gmtCreate=2019-04-11T05:24:14&#125;]</span><br></pre></td></tr></table></figure>

<h3 id="4-2-查询-slave-库"><a href="#4-2-查询-slave-库" class="headerlink" title="4.2 查询 slave 库"></a>4.2 查询 <code>slave</code> 库</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectSlave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;UserInfo&gt; users = userService.selectSlave();</span><br><span class="line">    log.info(<span class="string">"slave-users:&#123;&#125;"</span>, users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试结果：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">...: slave-users:[User&#123;id=2, userName='slave', passWord='password', userSex='女', nickName='从库', gmtCreate=2019-04-11T05:24:14&#125;]</span><br></pre></td></tr></table></figure>


<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>相较于另一篇文章，该方式虽然配置麻烦，但是如果新增数据源，配置更简单。文中代码不全，文章代码，详见</p>
<p><a href="https://github.com/vanDusty/Frame-Home/tree/master/mybatis-case/multipledata-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
        <tag>多数据源</tag>
      </tags>
  </entry>
  <entry>
    <title>高并发下浏览量入库设计</title>
    <url>/2019/07/21/b4fd6b8b.html</url>
    <content><![CDATA[<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><blockquote>
<p>文章浏览量统计，<code>low</code>的做法是：用户每次浏览，前端会发送一个<code>GET</code>请求获取一篇文章详情时，会把这篇文章的浏览量<code>+1</code>，存进数据库里。</p>
</blockquote>
<a id="more"></a>
<h3 id="1-1-这么做，有几个问题："><a href="#1-1-这么做，有几个问题：" class="headerlink" title="1.1 这么做，有几个问题："></a>1.1 这么做，有几个问题：</h3><ol>
<li>在GET请求的业务逻辑里进行了数据的写操作！</li>
<li>并发高的话，数据库压力太大；</li>
<li>同时，如果文章做了缓存和搜索引擎如<code>ElasticSearch</code>的存储，同步更新缓存和<code>ElasticSearch</code>更新同步更新太耗时，不更新就会导致数据不一致性。</li>
</ol>
<h3 id="1-2-解决方案"><a href="#1-2-解决方案" class="headerlink" title="1.2 解决方案"></a>1.2 解决方案</h3><ul>
<li><code>HyperLogLog</code></li>
</ul>
<p><code>HyperLogLog</code>是<code>Probabilistic data Structures</code>的一种，这类数据结构的基本大的思路就是使用统计概率上的算法，牺牲数据的精准性来节省内存的占用空间及提升相关操作的性能。</p>
<ul>
<li><p>设计思路</p>
<ol>
<li>为保证真实的博文浏览量，根据用户访问的<code>ip</code>和文章<code>id</code>,进行唯一校验，即同一个用户多次访问同一篇文章，改文章访问量只增加1；</li>
<li>将用户的浏览量用<code>opsForHyperLogLog().add(key,value)</code>的存储在<code>Redis</code>中，在半夜浏览量低的时候，通过定时任务，将浏览量更新至数据库中。</li>
</ol>
</li>
</ul>
<h2 id="二、-手把手实现"><a href="#二、-手把手实现" class="headerlink" title="二、 手把手实现"></a>二、 手把手实现</h2><h3 id="2-1-项目配置"><a href="#2-1-项目配置" class="headerlink" title="2.1 项目配置"></a>2.1 项目配置</h3><ul>
<li><code>sql</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`article`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`article`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'标题'</span>,</span><br><span class="line">  <span class="string">`content`</span> <span class="built_in">varchar</span>(<span class="number">1024</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'内容'</span>,</span><br><span class="line">  <span class="string">`url`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'地址'</span>,</span><br><span class="line">	<span class="string">`views`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'浏览量'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> article <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'测试文章'</span>,<span class="string">'content'</span>,<span class="string">'url'</span>,<span class="number">10</span>,<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>插入了一条数据，并设计访问量已经为<code>10</code>了，便于测试。</p>
</blockquote>
<ul>
<li>项目依赖<code>pom.xml</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>application.yml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 数据库配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://47.98.178.84:3306/dev</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.98</span><span class="number">.178</span><span class="number">.84</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">60s</span>  <span class="comment"># 连接超时时间，2.0 中该参数的类型为Duration，这里在配置的时候需要指明单位</span></span><br><span class="line">    <span class="comment"># 连接池配置，2.0中直接使用jedis或者lettuce配置连接池（使用lettuce，依赖中必须包含commons-pool2包）</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="comment"># 最大空闲连接数</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">500</span></span><br><span class="line">        <span class="comment"># 最小空闲连接数</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment"># 等待可用连接的最大时间，负数为不限制</span></span><br><span class="line">        <span class="attr">max-wait:</span>  <span class="string">-1s</span></span><br><span class="line">        <span class="comment"># 最大活跃连接数，负数为不限制</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line"><span class="comment">#  type-aliases-package: cn.van.redis.view.entity</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-浏览量的切面设计"><a href="#2-2-浏览量的切面设计" class="headerlink" title="2.2 浏览量的切面设计"></a>2.2 浏览量的切面设计</h3><ul>
<li>自定义一个注解，用于新增文章浏览量到<code>Redis</code>中</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.PARAMETER, ElementType.METHOD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PageView &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 描述</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">description</span><span class="params">()</span>  <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>切面处理</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> @Aspect</span><br><span class="line">@Configuration</span><br><span class="line">@Slf4j</span><br><span class="line">public class PageViewAspect &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisUtils redisUtil;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 切入点</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Pointcut(&quot;@annotation(cn.van.redis.view.annotation.PageView)&quot;)</span><br><span class="line">    public void PageViewAspect() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 切入处理</span><br><span class="line">     * @param joinPoint</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Around(&quot;PageViewAspect()&quot;)</span><br><span class="line">    public  Object around(ProceedingJoinPoint joinPoint) &#123;</span><br><span class="line">        Object[] object &#x3D; joinPoint.getArgs();</span><br><span class="line">        Object articleId &#x3D; object[0];</span><br><span class="line">        log.info(&quot;articleId:&#123;&#125;&quot;, articleId);</span><br><span class="line">        Object obj &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            String ipAddr &#x3D; IpUtils.getIpAddr();</span><br><span class="line">            log.info(&quot;ipAddr:&#123;&#125;&quot;, ipAddr);</span><br><span class="line">            String key &#x3D; &quot;articleId_&quot; + articleId;</span><br><span class="line">            &#x2F;&#x2F; 浏览量存入redis中</span><br><span class="line">            Long num &#x3D; redisUtil.add(key,ipAddr);</span><br><span class="line">            if (num &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                log.info(&quot;该ip:&#123;&#125;,访问的浏览量已经新增过了&quot;, ipAddr);</span><br><span class="line">            &#125;</span><br><span class="line">            obj &#x3D; joinPoint.proceed();</span><br><span class="line">        &#125; catch (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>工具类<code>RedisUtils.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span>  <span class="class"><span class="keyword">class</span> <span class="title">RedisUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 可以传一个值 或多个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(String... key)</span> </span>&#123;</span><br><span class="line">        redisTemplate.delete(key[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">add</span><span class="params">(String key, Object... value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().add(key,value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">size</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().size(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>工具类 <code>IpUtils.java</code></li>
</ul>
<blockquote>
<p>该工具类我在<code>Mac</code>下测试没问题，<code>Windows</code>下如果有问题，请反馈给我</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getIpAddr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Enumeration&lt;NetworkInterface&gt; allNetInterfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">            InetAddress ip = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> (allNetInterfaces.hasMoreElements()) &#123;</span><br><span class="line">                NetworkInterface netInterface = (NetworkInterface) allNetInterfaces.nextElement();</span><br><span class="line">                <span class="keyword">if</span> (netInterface.isLoopback() || netInterface.isVirtual() || !netInterface.isUp()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Enumeration&lt;InetAddress&gt; addresses = netInterface.getInetAddresses();</span><br><span class="line">                    <span class="keyword">while</span> (addresses.hasMoreElements()) &#123;</span><br><span class="line">                        ip = addresses.nextElement();</span><br><span class="line">                        <span class="keyword">if</span> (ip != <span class="keyword">null</span> &amp;&amp; ip <span class="keyword">instanceof</span> Inet4Address) &#123;</span><br><span class="line">                            log.info(<span class="string">"获取到的ip地址：&#123;&#125;"</span>, ip.getHostAddress());</span><br><span class="line">                            <span class="keyword">return</span> ip.getHostAddress();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"获取ip地址失败，&#123;&#125;"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-同步任务ArticleViewTask-java"><a href="#2-3-同步任务ArticleViewTask-java" class="headerlink" title="2.3 同步任务ArticleViewTask.java"></a>2.3 同步任务<code>ArticleViewTask.java</code></h3><blockquote>
<p><code>ArticleService.java</code>里面的代码比较简单，详见文末源码。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleViewTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtils redisUtil;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ArticleService articleService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 每天凌晨一点执行</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron = <span class="string">"0 0 1 * * ? "</span>)</span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor=Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">createHyperLog</span>() </span>&#123;</span><br><span class="line">        log.info(<span class="string">"浏览量入库开始"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;Long&gt; list = articleService.getAllArticleId();</span><br><span class="line">        list.forEach(articleId -&gt;&#123;</span><br><span class="line">            <span class="comment">// 获取每一篇文章在redis中的浏览量，存入到数据库中</span></span><br><span class="line">            String key  = <span class="string">"articleId_"</span>+articleId;</span><br><span class="line">            Long view = redisUtil.size(key);</span><br><span class="line">            <span class="keyword">if</span>(view&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                ArticleDO articleDO = articleService.getById(articleId);</span><br><span class="line">                Long views = view + articleDO.getViews();</span><br><span class="line">                articleDO.setViews(views);</span><br><span class="line">                <span class="keyword">int</span> num = articleService.updateArticleById(articleDO);</span><br><span class="line">                <span class="keyword">if</span> (num != <span class="number">0</span>) &#123;</span><br><span class="line">                    log.info(<span class="string">"数据库更新后的浏览量为：&#123;&#125;"</span>, views);</span><br><span class="line">                    redisUtil.del(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        log.info(<span class="string">"浏览量入库结束"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="2-4-测试接口PageController-java"><a href="#2-4-测试接口PageController-java" class="headerlink" title="2.4 测试接口PageController.java"></a>2.4 测试接口<code>PageController.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleService articleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtils redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问一篇文章时，增加其浏览量:重点在的注解</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> articleId：文章id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PageView</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/&#123;articleId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getArticle</span><span class="params">(@PathVariable(<span class="string">"articleId"</span>)</span> Long articleId) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            ArticleDO blog = articleService.getById(articleId);</span><br><span class="line">            log.info(<span class="string">"articleId = &#123;&#125;"</span>, articleId);</span><br><span class="line">            String key = <span class="string">"articleId_"</span>+articleId;</span><br><span class="line">            Long view = redisUtil.size(key);</span><br><span class="line">            log.info(<span class="string">"redis 缓存中浏览数：&#123;&#125;"</span>, view);</span><br><span class="line">            <span class="comment">//直接从缓存中获取并与之前的数量相加</span></span><br><span class="line">            Long views = view + blog.getViews();</span><br><span class="line">            log.info(<span class="string">"文章总浏览数：&#123;&#125;"</span>, views);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="keyword">return</span>  <span class="string">"error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里，具体的<code>Service</code>中的方法因为都被我放在<code>Controller</code>中处理了，所以就是剩下简单的<code>Mapper</code>调用了，这里就不浪费时间了，详见文末源码。（按理说，这些逻辑处理，应该放在<code>Service</code>处理的，请按实际情况优化）</p>
</blockquote>
<h2 id="三、-测试"><a href="#三、-测试" class="headerlink" title="三、 测试"></a>三、 测试</h2><p>启动项目，测试访问量，先请求<a href="http://localhost:8080/1" target="_blank" rel="noopener">http://localhost:8080/1</a>,日志打印如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">2019-03-2623:50:50.047  INFO 2970 --- [nio-8080-exec-1]  cn.van.redis.view.aspect.PageViewAspect  : articleId:1</span><br><span class="line">2019-03-2623:50:50.047  INFO 2970 --- [nio-8080-exec-1] cn.van.redis.view.utils.IpUtils          : 获取到的ip地址：192.168.1.104</span><br><span class="line">2019-03-2623:50:50.047  INFO 2970 --- [nio-8080-exec-1] cn.van.redis.view.aspect.PageViewAspect  : ipAddr:192.168.1.104</span><br><span class="line">2019-03-2623:50:50.139  INFO 2970 --- [nio-8080-exec-1] io.lettuce.core.EpollProvider            : Starting without optional epoll library</span><br><span class="line">2019-03-2623:50:50.140  INFO 2970 --- [nio-8080-exec-1] io.lettuce.core.KqueueProvider           : Starting without optional kqueue library</span><br><span class="line">2019-03-2623:50:50.349  INFO 2970 --- [nio-8080-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...</span><br><span class="line">2019-03-2623:50:50.833  INFO 2970 --- [nio-8080-exec-1] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.</span><br><span class="line">2019-03-2623:50:50.872  INFO 2970 --- [nio-8080-exec-1] c.v.r.v.web.controller.PageController    : articleId = 1</span><br><span class="line">2019-03-2623:50:50.899  INFO 2970 --- [nio-8080-exec-1] c.v.r.v.web.controller.PageController    : redis 缓存中浏览数：1</span><br><span class="line">2019-03-2623:50:50.900  INFO 2970 --- [nio-8080-exec-1] c.v.r.v.web.controller.PageController    : 文章总浏览数：11</span><br></pre></td></tr></table></figure>

<p>观察一下，数据库，访问量确实没有增加，本机再次访问，发现，日志打印如下:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">2019-03-2623:51:14.658  INFO 2970 --- [nio-8080-exec-3] </span><br><span class="line">cn.van.redis.view.aspect.PageViewAspect  : articleId:1</span><br><span class="line">2019-03-2623:51:14.658  INFO 2970 --- [nio-8080-exec-3] cn.van.redis.view.utils.IpUtils          : 获取到的ip地址：192.168.1.104</span><br><span class="line">2019-03-2623:51:14.658  INFO 2970 --- [nio-8080-exec-3] cn.van.redis.view.aspect.PageViewAspect  : ipAddr:192.168.1.104</span><br><span class="line">2019-03-2623:51:14.692  INFO 2970 --- [nio-8080-exec-3] cn.van.redis.view.aspect.PageViewAspect  : 该ip:192.168.1.104,访问的浏览量已经新增过了</span><br><span class="line">2019-03-2623:51:14.752  INFO 2970 --- [nio-8080-exec-3] c.v.r.v.web.controller.PageController    : articleId = 1</span><br><span class="line">2019-03-2623:51:14.760  INFO 2970 --- [nio-8080-exec-3] c.v.r.v.web.controller.PageController    : redis 缓存中浏览数：1</span><br><span class="line">2019-03-2623:51:14.761  INFO 2970 --- [nio-8080-exec-3] c.v.r.v.web.controller.PageController    : 文章总浏览数：11</span><br></pre></td></tr></table></figure>


<ul>
<li>定时任务触发，日志打印如下</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">2019-03-27 01:00:00.265  INFO 2974 --- [   scheduling-1] cn.van.redis.view.task.ArticleViewTask   : 浏览量入库开始</span><br><span class="line">2019-03-27 01:00:00.448  INFO 2974 --- [   scheduling-1] io.lettuce.core.EpollProvider            : Starting without optional epoll library</span><br><span class="line">2019-03-27 01:00:00.449  INFO 2974 --- [   scheduling-1] io.lettuce.core.KqueueProvider           : Starting without optional kqueue library</span><br><span class="line">2019-03-27 01:00:00.663  INFO 2974 --- [   scheduling-1] cn.van.redis.view.task.ArticleViewTask   : 数据库更新后的浏览量为：11</span><br><span class="line">2019-03-27 01:00:00.682  INFO 2974 --- [   scheduling-1] cn.van.redis.view.task.ArticleViewTask   : 浏览量入库结束</span><br></pre></td></tr></table></figure>

<p>观察一下数据库，发现数据库中的浏览量增加到<code>11</code>，同时，<code>Redis</code>中的浏览量没了，说明成功！</p>
<h3 id="四、源码地址"><a href="#四、源码地址" class="headerlink" title="四、源码地址"></a>四、源码地址</h3><p><a href="https://github.com/vanDusty/Distributed/tree/master/concurrency-pageviews" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>分布式</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>并发</tag>
        <tag>分布式</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 图片验证码及校验</title>
    <url>/2019/07/15/dd6a59cb.html</url>
    <content><![CDATA[<h2 id="一、思路"><a href="#一、思路" class="headerlink" title="一、思路"></a>一、思路</h2><ol>
<li>后端生成数字和字母混搭的指定位数的验证码，存储在<code>Redis</code>中；</li>
<li>将生成的验证码画成图片并转换成<code>base64</code>字符，和<code>Redis</code> 验证码的<code>key</code> 一块返给前端；</li>
<li>前端登录时候，把验证码传给后端，后端    取出 <code>Redis</code>中的值进行对比。</li>
</ol>
<a id="more"></a>

<h2 id="二、示例代码"><a href="#二、示例代码" class="headerlink" title="二、示例代码"></a>二、示例代码</h2><h3 id="2-1-项目依赖和配置"><a href="#2-1-项目依赖和配置" class="headerlink" title="2.1 项目依赖和配置"></a>2.1 项目依赖和配置</h3><ul>
<li><code>pom.xml</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>application.yml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.98</span><span class="number">.178</span><span class="number">.84</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">60s</span>  <span class="comment"># 连接超时时间，2.0 中该参数的类型为Duration，这里在配置的时候需要指明单位</span></span><br><span class="line">    <span class="comment"># 连接池配置，2.0中直接使用jedis或者lettuce配置连接池（使用lettuce，依赖中必须包含commons-pool2包）</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="comment"># 最大空闲连接数</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">500</span></span><br><span class="line">        <span class="comment"># 最小空闲连接数</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment"># 等待可用连接的最大时间，负数为不限制</span></span><br><span class="line">        <span class="attr">max-wait:</span>  <span class="string">-1s</span></span><br><span class="line">        <span class="comment"># 最大活跃连接数，负数为不限制</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-生成图片验证码工具类"><a href="#2-2-生成图片验证码工具类" class="headerlink" title="2.2 生成图片验证码工具类"></a>2.2 生成图片验证码工具类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImgValidateCodeUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码的宽</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> width = <span class="number">160</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码的高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> height = <span class="number">40</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码的干扰线数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> lineSize = <span class="number">30</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码词典</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String randomString = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyz"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取字体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Font <span class="title">getFont</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Font(<span class="string">"Times New Roman"</span>, Font.ROMAN_BASELINE, <span class="number">40</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取颜色</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bc</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Color <span class="title">getRandomColor</span><span class="params">(<span class="keyword">int</span> fc, <span class="keyword">int</span> bc)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        fc = Math.min(fc, <span class="number">255</span>);</span><br><span class="line">        bc = Math.min(bc, <span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> r = fc + random.nextInt(bc - fc - <span class="number">16</span>);</span><br><span class="line">        <span class="keyword">int</span> g = fc + random.nextInt(bc - fc - <span class="number">14</span>);</span><br><span class="line">        <span class="keyword">int</span> b = fc + random.nextInt(bc - fc - <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Color(r, g, b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制干扰线</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> g</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">drawLine</span><span class="params">(Graphics g)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = random.nextInt(width);</span><br><span class="line">        <span class="keyword">int</span> y = random.nextInt(height);</span><br><span class="line">        <span class="keyword">int</span> xl = random.nextInt(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">int</span> yl = random.nextInt(<span class="number">10</span>);</span><br><span class="line">        g.drawLine(x, y, x + xl, y + yl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取随机字符</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getRandomString</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">        num = num &gt; <span class="number">0</span> ? num : randomString.length();</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(randomString.charAt(random.nextInt(num)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绘制字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> g</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> randomStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">drawString</span><span class="params">(Graphics g, String randomStr, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        g.setFont(getFont());</span><br><span class="line">        g.setColor(getRandomColor(<span class="number">108</span>, <span class="number">190</span>));</span><br><span class="line">        String rand = getRandomString(random.nextInt(randomString.length()));</span><br><span class="line">        randomStr += rand;</span><br><span class="line">        g.translate(random.nextInt(<span class="number">3</span>), random.nextInt(<span class="number">6</span>));</span><br><span class="line">        g.drawString(rand, <span class="number">40</span> * i + <span class="number">10</span>, <span class="number">25</span>);</span><br><span class="line">        <span class="keyword">return</span> randomStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成随机图片，返回 base64 字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">getImgCodeBaseCode</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// BufferedImage类是具有缓冲区的Image类,Image类是用于描述图像信息的类</span></span><br><span class="line">        BufferedImage image = <span class="keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_BGR);</span><br><span class="line">        Graphics g = image.getGraphics();</span><br><span class="line">        g.fillRect(<span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">        <span class="comment">// 获取颜色</span></span><br><span class="line">        g.setColor(getRandomColor(<span class="number">105</span>, <span class="number">189</span>));</span><br><span class="line">        <span class="comment">// 获取字体</span></span><br><span class="line">        g.setFont(getFont());</span><br><span class="line">        <span class="comment">// 绘制干扰线</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lineSize; i++) &#123;</span><br><span class="line">            drawLine(g);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 绘制随机字符</span></span><br><span class="line">        String randomCode = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            randomCode = drawString(g, randomCode, i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"验证码是："</span> + randomCode);</span><br><span class="line">        g.dispose();</span><br><span class="line"></span><br><span class="line">        result.put(<span class="string">"imgCode"</span>, randomCode);</span><br><span class="line"></span><br><span class="line">        String base64Code = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//返回 base64</span></span><br><span class="line">            ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            ImageIO.write(image, <span class="string">"PNG"</span>, bos);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line">            Base64.Encoder encoder = Base64.getEncoder();</span><br><span class="line">            base64Code = encoder.encodeToString(bytes);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        result.put(<span class="string">"data"</span>, <span class="string">"data:image/png;base64,"</span> + base64Code);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>说明：</li>
</ul>
<ol>
<li>为了方便，本案例中：验证码的字体/宽/高/干扰线数量等参数直接写死了，当然，你可以放在配置文件中做成可配置项；</li>
<li>同样是为了方便，本案例中：验证码词典直接取的是0-9数字以及所有小写字母，可根据自己的需要更改或者也可作为可配置项。</li>
</ol>
<h3 id="2-3-测试接口"><a href="#2-3-测试接口" class="headerlink" title="2.3 测试接口"></a>2.3 测试接口</h3><p>为了便于测试，我这里封装了几个<code>RestFul</code>接口。(存/取缓存等业务操作，应该放在业务层中，这里也是为了偷懒，直接放在控制层里面了)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/code"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成图片验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getImgCode"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getImgCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取 4位数验证码</span></span><br><span class="line">            result= ImgValidateCodeUtil.getImgCodeBaseCode(<span class="number">4</span>);</span><br><span class="line">            <span class="comment">// 将验证码存入redis 中（有效时长5分钟）</span></span><br><span class="line">            cacheImgCode(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imgCodeKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imgCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/checkImgCode"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">checkImgCode</span><span class="params">(String imgCodeKey, String imgCode)</span> </span>&#123;</span><br><span class="line">        String cacheCode = redisTemplate.opsForValue().get(imgCodeKey);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == cacheCode) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"图片验证码已过期，请重新获取"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cacheCode.equals(imgCode.toLowerCase())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"验证码输入正确"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"验证码输入错误"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将验证码存入redis 中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cacheImgCode</span><span class="params">(Map&lt;String, String&gt; result)</span> </span>&#123;</span><br><span class="line">        String imgCode = result.get(<span class="string">"imgCode"</span>);</span><br><span class="line">        UUID randomUUID = UUID.randomUUID();</span><br><span class="line">        String imgCodeKey = randomUUID.toString();</span><br><span class="line">        System.out.println(<span class="string">"imgCodeKey:"</span> + imgCodeKey);</span><br><span class="line">        <span class="comment">// 图片验证码有效时间 ：5 分钟</span></span><br><span class="line">        redisTemplate.opsForValue().set(imgCodeKey, imgCode, <span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line">        result.put(<span class="string">"imgCodeKey"</span>, imgCodeKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、测试及总结"><a href="#三、测试及总结" class="headerlink" title="三、测试及总结"></a>三、测试及总结</h2><h3 id="3-1-获取图片验证码"><a href="#3-1-获取图片验证码" class="headerlink" title="3.1 获取图片验证码"></a>3.1 获取图片验证码</h3><ul>
<li>请求类型： <code>GET</code></li>
<li>请求地址： <a href="http://localhost:8080/code/getImgCode" target="_blank" rel="noopener">获取图片验证码url</a></li>
<li>返回结果： </li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "data": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAAoCAIAAAD2TmbPAAACvElEQVR42u3cuWrEMBAGYL1zCKTZPl2qFCEsgbR5SMUgWIyO8Rz/yJLWxk02XiH78+gY2RuiYXv7+s32eG2DbQGla6zH7f4KOR9UOc8O7BG4QOOL2QTs1CxjVS5mJbBrpwsnuYwXB14plN9/bhpg0cn76SYGPwxjyZ/fL9ve/ybeUKu7LIL5J99hUrSXtpBk5aSi1AWeAtzSFTEH/j1e6pbzYIj6vhpVJxQ5s7SkiwKuGpcVO9RlGgd+U1bl9DBuVeD+95H2RyUfn2y7U8/30HUFlsauHphg5gPDW+89ZALOPnFi3uueAsyx14+iM2aasGVsHDS1IIndSbc/MDO+rdOkxMwJ0NYxlr5TAQwxLnWx2MQFOWTLgOlry50HK4Czw+DMxH/XBs6M6WuLBOYcpmMuCbNC+jTU2GGzMekB64NTVVDAutMr8eYChifUkH0wNoKdgKvHDDhNgjCDB1kewNJTreLRQTz1PBgVvlG02ICNYFHucDFgYyj3AOYMpEW5QyNwmdhCdXhOwGpmfS66PzCfmROdWXorghYfXYEVzNIFJdl6MB9Yd5KHWWgCuBXlrTKlKw1+wPz6KFYMTQv+9vBlMquB6WvHCZ1uwB66EfhEB3zFcH/ppcCt9bjDEV952IDAom9hnqp0fcxDAZyJcgbtrTtgEGBCl17hhj0X7ffUe3VxkNatNs6c0dyYESyK3cw7xBk2/mIDc/DCZ64C9/TWtcyACD4dmJ9/1mUV0recVpOAuvQBiwD7JQhPBObrrgZsNLMbjzAp4syaZu2Dy6FTN+P+U17jo3dzR3DnUB5Td0Hg1sAYPv+eXXfiCFZMfsZkNr5yseY0yWO07Md8WILrnRQmchVNfOFxhmWm/7yAfV9X8WbOkuSurfQETfRoI2RItJVZcacgnqMPXvhF/ZL5GYHj6j/G4NdW/wMQ1li94E5Z4gAAAABJRU5ErkJggg==",</span><br><span class="line">    "imgCodeKey": "26393d5c-5d56-4ac3-bf38-c2cac1f33181",</span><br><span class="line">    "imgCode": "6pt2"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>说明：验证码是<code>6pt2</code>，前端可以直接拿<code>data</code>中的数值直接展示，即为图片验证码，如下：</li>
</ul>
<img src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAAoCAIAAAD2TmbPAAACvElEQVR42u3cuWrEMBAGYL1zCKTZPl2qFCEsgbR5SMUgWIyO8Rz/yJLWxk02XiH78+gY2RuiYXv7+s32eG2DbQGla6zH7f4KOR9UOc8O7BG4QOOL2QTs1CxjVS5mJbBrpwsnuYwXB14plN9/bhpg0cn76SYGPwxjyZ/fL9ve/ybeUKu7LIL5J99hUrSXtpBk5aSi1AWeAtzSFTEH/j1e6pbzYIj6vhpVJxQ5s7SkiwKuGpcVO9RlGgd+U1bl9DBuVeD+95H2RyUfn2y7U8/30HUFlsauHphg5gPDW+89ZALOPnFi3uueAsyx14+iM2aasGVsHDS1IIndSbc/MDO+rdOkxMwJ0NYxlr5TAQwxLnWx2MQFOWTLgOlry50HK4Czw+DMxH/XBs6M6WuLBOYcpmMuCbNC+jTU2GGzMekB64NTVVDAutMr8eYChifUkH0wNoKdgKvHDDhNgjCDB1kewNJTreLRQTz1PBgVvlG02ICNYFHucDFgYyj3AOYMpEW5QyNwmdhCdXhOwGpmfS66PzCfmROdWXorghYfXYEVzNIFJdl6MB9Yd5KHWWgCuBXlrTKlKw1+wPz6KFYMTQv+9vBlMquB6WvHCZ1uwB66EfhEB3zFcH/ppcCt9bjDEV952IDAom9hnqp0fcxDAZyJcgbtrTtgEGBCl17hhj0X7ffUe3VxkNatNs6c0dyYESyK3cw7xBk2/mIDc/DCZ64C9/TWtcyACD4dmJ9/1mUV0recVpOAuvQBiwD7JQhPBObrrgZsNLMbjzAp4syaZu2Dy6FTN+P+U17jo3dzR3DnUB5Td0Hg1sAYPv+eXXfiCFZMfsZkNr5yseY0yWO07Md8WILrnRQmchVNfOFxhmWm/7yAfV9X8WbOkuSurfQETfRoI2RItJVZcacgnqMPXvhF/ZL5GYHj6j/G4NdW/wMQ1li94E5Z4gAAAABJRU5ErkJggg=="/>

<h3 id="3-2-校验图片验证码"><a href="#3-2-校验图片验证码" class="headerlink" title="3.2 校验图片验证码"></a>3.2 校验图片验证码</h3><ul>
<li><p>请求类型： <code>GET</code></p>
</li>
<li><p>请求地址： <a href="http://localhost:8080/code/checkImgCode?imgCode=6pt2&imgCodeKey=26393d5c-5d56-4ac3-bf38-c2cac1f33181" target="_blank" rel="noopener">校验图片验证码url</a></p>
</li>
<li><p>返回结果：验证码输入正确/验证码输入错误/图片验证码已过期，请重新获取</p>
</li>
<li><p>说明：前端需将请求验证码时返回的<code>imgCodeKey</code> 字段的值以及用户数据的验证码请求到后端，进行校验；验证码有效期为五分钟，可按照实际需求配置。</p>
</li>
</ul>
<p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-list/imgValidateCode" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>验证码</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 整合阿里云短信验证码</title>
    <url>/2019/07/11/985e0324.html</url>
    <content><![CDATA[<blockquote>
<p>相比于腾讯云的短信服务，阿里云的短信好像更高大上一些，例如：阿里云控制台可以直接生成<code>Java/Node.js/Go/Php</code>等语言的 <a href="https://api.aliyun.com/new#/?product=Dysmsapi&api=SendSms&params=%7B%22RegionId%22%3A%22cn-hangzhou%22%2C%22PhoneNumbers%22%3A%22%22%2C%22SignName%22%3A%22%22%2C%22TemplateCode%22%3A%22%22%7D&tab=DEMO&lang=JAVA" target="_blank" rel="noopener">ApiDemo</a>,并可以在线测试。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、阿里云短信控制台"><a href="#一、阿里云短信控制台" class="headerlink" title="一、阿里云短信控制台"></a>一、阿里云短信控制台</h2><p>跟腾讯云类似，需要一系列的注册，创建<code>AccessId</code>、<code>AccessKey</code>、签名、短信模板以及等待认证，这些，都是在项目配置中需要用到的。</p>
<blockquote>
<p>更多内容，详见 <a href="https://help.aliyun.com/document_detail/112148.html?spm=a2c4g.11186623.6.632.61ff50a4nXbDFp" target="_blank" rel="noopener">Java SDK</a>，这里就不多赘述了</p>
</blockquote>
<h2 id="二、项目示例"><a href="#二、项目示例" class="headerlink" title="二、项目示例"></a>二、项目示例</h2><h3 id="2-1-pom-xml"><a href="#2-1-pom-xml" class="headerlink" title="2.1 pom.xml"></a>2.1 <code>pom.xml</code></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!-- 阿里云 SDK --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.aliyun&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;aliyun-java-sdk-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.1.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!-- lombok--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;optional&gt;true&lt;&#x2F;optional&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--fastjson--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.2.32&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-application-yml"><a href="#2-2-application-yml" class="headerlink" title="2.2 application.yml"></a>2.2 <code>application.yml</code></h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">aliyun:</span><br><span class="line">  sms:</span><br><span class="line">    accessKeyId: accessKeyId</span><br><span class="line">    accessKeySecret: accessKeySecret</span><br><span class="line">    signName: 风尘博客</span><br><span class="line">    templateCode: SMS_170181587</span><br><span class="line">    smsEffectiveTime: 5</span><br></pre></td></tr></table></figure>

<h3 id="2-3-封装一个参数实体SmsParams-java"><a href="#2-3-封装一个参数实体SmsParams-java" class="headerlink" title="2.3 封装一个参数实体SmsParams.java"></a>2.3 封装一个参数实体<code>SmsParams.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsParams</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String verifyCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号码(多个手机号以英文状态下","分割)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phoneNumbers;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SmsParams</span><span class="params">(String phoneNumbers, String verifyCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.phoneNumbers = phoneNumbers;</span><br><span class="line">        <span class="keyword">this</span>.verifyCode = verifyCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-封装发送验证码的工具类AliYunSmsUtils-java"><a href="#2-4-封装发送验证码的工具类AliYunSmsUtils-java" class="headerlink" title="2.4 封装发送验证码的工具类AliYunSmsUtils.java"></a>2.4 封装发送验证码的工具类<code>AliYunSmsUtils.java</code></h3><blockquote>
<p>官网<code>SDK</code> 有：单发短信、群发短信以及拉取短信回执等方式发送验证码，我这里只演示最常用的单发短信。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AliYunSmsUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主账号AccessKey的ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.sms.accessKeyId&#125;"</span>)</span><br><span class="line">    String accessKeyId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主账号AccessKey的Secret</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.sms.accessKeySecret&#125;"</span>)</span><br><span class="line">    String accessKeySecret;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 签名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.sms.signName&#125;"</span>)</span><br><span class="line">    String signName ;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信模板ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;aliyun.sms.templateCode&#125;"</span>)</span><br><span class="line">    String templateCode ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产品名称:云通信短信API产品,开发者无需替换</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String product = <span class="string">"Dysmsapi"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产品域名,开发者无需替换</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String domain = <span class="string">"dysmsapi.aliyuncs.com"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统规定参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String action = <span class="string">"SendSms"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信发送接口，支持在一次请求中向多个不同的手机号码发送同样内容的短信。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> smsParams</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendSms</span><span class="params">(SmsParams smsParams)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 初始化acsClient</span></span><br><span class="line">        DefaultProfile profile = DefaultProfile.getProfile(<span class="string">"cn-hangzhou"</span>, accessKeyId, accessKeySecret);</span><br><span class="line">        IAcsClient client = <span class="keyword">new</span> DefaultAcsClient(profile);</span><br><span class="line"></span><br><span class="line">        CommonRequest request = <span class="keyword">new</span> CommonRequest();</span><br><span class="line">        request.setMethod(MethodType.POST);</span><br><span class="line">        request.setDomain(domain);</span><br><span class="line">        request.setVersion(<span class="string">"2017-05-25"</span>);</span><br><span class="line">        request.setAction(action);</span><br><span class="line">        request.putQueryParameter(<span class="string">"RegionId"</span>, <span class="string">"cn-hangzhou"</span>);</span><br><span class="line">        request.putQueryParameter(<span class="string">"SignName"</span>, signName);</span><br><span class="line">        request.putQueryParameter(<span class="string">"TemplateCode"</span>, templateCode);</span><br><span class="line"></span><br><span class="line">        Map&lt;String,String&gt; map = <span class="keyword">new</span> HashMap(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"code"</span> , smsParams.getVerifyCode());</span><br><span class="line">        <span class="comment">// 短信模板变量对应的实际值，JSON格式。</span></span><br><span class="line">        request.putQueryParameter(<span class="string">"TemplateParam"</span>, JSON.toJSONString(map));</span><br><span class="line">        <span class="comment">// 支持对多个手机号码发送短信，手机号码之间以英文逗号（,）分隔。上限为1000个手机号码</span></span><br><span class="line">        request.putQueryParameter(<span class="string">"PhoneNumbers"</span>, smsParams.getPhoneNumbers());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CommonResponse response = client.getCommonResponse(request);</span><br><span class="line">            System.out.println(response.getHttpStatus());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServerException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getErrMsg();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.getErrMsg();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-测试发送验证码"><a href="#2-5-测试发送验证码" class="headerlink" title="2.5 测试发送验证码"></a>2.5 测试发送验证码</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SmsTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    AliYunSmsUtils aliYunSmsUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendSms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 生成随机的六位数验证码</span></span><br><span class="line">        Random random = <span class="keyword">new</span> Random(<span class="number">4</span>);</span><br><span class="line">        Integer verifyCode = random.nextInt(<span class="number">1000000</span>);</span><br><span class="line">        SmsParams smsParams = <span class="keyword">new</span> SmsParams(<span class="string">"17098705205"</span>,verifyCode.toString());</span><br><span class="line">        System.out.println(<span class="string">"生成的验证码为："</span> + verifyCode);</span><br><span class="line">        String str = aliYunSmsUtils.sendSms(smsParams);</span><br><span class="line">        System.out.println(<span class="string">"发送结果："</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>手机上接收到消息如下：</p>
<blockquote>
<p>【风尘博客】你的验证码为<code>971862</code>，该验证码<code>5</code>分钟内有效，请保护好您的验证码,如非本人操作，请忽略本短信。</p>
</blockquote>
<p>说明发送成功！</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-sms/aliyunSms" target="_blank" rel="noopener">https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-sms/aliyunSms</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>验证码</tag>
        <tag>短信</tag>
        <tag>阿里云</tag>
      </tags>
  </entry>
  <entry>
    <title>Java ThreadLocal 入门篇</title>
    <url>/2019/07/05/9db6abad.html</url>
    <content><![CDATA[<p><code>ThreadLocal</code>是<code>JDK</code>包提供的，从名字来看，<code>ThreadLocal</code>意思就是本地线程的意思。</p>
<a id="more"></a>


<h2 id="一、定义"><a href="#一、定义" class="headerlink" title="一、定义"></a>一、定义</h2><p><code>ThreadLocal</code>是<code>JDK</code>包提供的，从名字来看，<code>ThreadLocal</code>意思就是本地线程的意思。</p>
<h3 id="1-1-是什么？"><a href="#1-1-是什么？" class="headerlink" title="1.1 是什么？"></a>1.1 是什么？</h3><p>要想知道他是个啥，我们看看<code>ThreadLocal</code>的源码（基于<code>JDK 1.8</code>）中对这个类的介绍：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">This class provides thread-local variables.  These variables differ from</span><br><span class="line">their normal counterparts in that each thread that accesses one (via its</span><br><span class="line">&#123;@code get&#125; or &#123;@code set&#125; method) has its own, independently initialized</span><br><span class="line">copy of the variable.  &#123;@code ThreadLocal&#125; instances are typically private</span><br><span class="line">static fields in classes that wish to associate state with a thread (e.g.,</span><br><span class="line">a user ID or Transaction ID).</span><br></pre></td></tr></table></figure>

<p>大致能够总结出：</p>
<ol>
<li><code>TreadLocal</code>可以给我们提供一个线程内的局部变量，而且这个变量与一般的变量还不同，<strong>它是每个线程独有的</strong>，与其他线程互不干扰的；</li>
<li><code>ThreadLocal</code> 与普通变量的区别在于：每个使用该变量的线程都会初始化一个完全独立的实例副本。<code>ThreadLocal</code> 变量通常被<code>private static</code>修饰。当一个线程结束时，它所使用的所有 <code>ThreadLocal</code> 相对的实例副本都会被回收；</li>
<li>简单说<code>ThreadLocal</code>就是一种以空间换时间的做法，在每个<code>Thread</code>里面维护了一个<code>ThreadLocal.ThreadLocalMap</code>，<strong>把数据进行隔离，每个线程的数据不共享</strong>，自然就没有线程安全方面的问题了.</li>
</ol>
<h3 id="1-2-ThreadLocal的API"><a href="#1-2-ThreadLocal的API" class="headerlink" title="1.2 ThreadLocal的API"></a>1.2 <code>ThreadLocal</code>的<code>API</code></h3><p><code>ThreadLocal</code>定义了四个方法:</p>
<ol>
<li><code>get()</code>:返回此线程局部变量当前副本中的值；</li>
<li><code>set(T value)</code>:将线程局部变量当前副本中的值设置为指定值；</li>
<li><code>initialValue()</code>:返回此线程局部变量当前副本中的初始值；</li>
<li><code>remove()</code>:移除此线程局部变量当前副本中的值。</li>
</ol>
<ul>
<li><code>set()</code>和<code>initialValue()</code>区别</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th><code>set()</code></th>
<th><code>initialValue()</code></th>
</tr>
</thead>
<tbody><tr>
<td>定义</td>
<td>为这个线程设置一个新值</td>
<td>该方法用于设置初始值，并且在调用<code>get()</code>方法时才会被触发，所以是懒加载。但是如果在<code>get()</code>之前进行了<code>set()</code>操作，这样就不会调用</td>
</tr>
<tr>
<td>区别</td>
<td>如果对象生成的时机不由我们控制的时候使用 <code>set()</code> 方式</td>
<td>对象初始化的时机由我们控制的时候使用<code>initialValue()</code> 方式</td>
</tr>
</tbody></table>
<h2 id="二、实现原理"><a href="#二、实现原理" class="headerlink" title="二、实现原理"></a>二、实现原理</h2><p><code>ThreadLocal</code>有一个特别重要的静态内部类<code>ThreadLocalMap</code>，该类才是实现线程隔离机制的关键。</p>
<ul>
<li>每个线程的本地变量不是存放在<code>ThreadLocal</code>实例里面，而是存放在调用线程的<code>threadLocals</code>变量里面，也就是说：<code>ThreadLocal</code>类型的本地变量存放在具体的线程内存空间中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</span><br><span class="line">ThreadLocal.ThreadLocalMap inheritableThreadLocals = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>Thread</code>类中有两个<code>ThreadLocalMap</code>类型的变量，分别是<code>threadLocals</code>和<code>inheritableThreadLocals</code>，而<code>ThreadLocalMap</code>是一个定制化的<code>Hashmap</code>，专门用来存储线程本地变量。在默认情况下，每个线程中的这两个变量都为<code>null</code>，只有当前线程第一次调用<code>ThreadLocal</code>的<code>set()</code>或者<code>get()</code>方法时才会创建它们。</p>
<p>  <img src="/File/Imgs/article/ThreadLoal%20for%20Principle.png" alt="风尘博客"></p>
</li>
<li><p><code>ThreadLocal</code>就是一个工具壳，它通过<code>set()</code>方法把<code>value</code>值放入调用线程的<code>threadLocals</code>里面并存放起来，当调用线程调用它的<code>get()</code>方法时，再从当前线程的<code>threadLocals</code>变量里面将其拿出来使用。</p>
</li>
<li><p>如果调用线程一直不终止，那么这个本地变量会一直存放在调用线程的<code>threadLocals</code>变量里面，所以当不需要使用本地变量时可以通过调用<code>ThreadLocal</code>变量的<code>remove()</code>方法，从当前线程的<code>threadLocals</code>里面删除该本地变量。</p>
</li>
</ul>
<p>另外<code>Thread</code>里面的<code>threadLocals</code>被设计为<code>Map</code>结构是因为每个线程可以关联多个<code>ThreadLocal</code>变量。</p>
<h3 id="原理小结"><a href="#原理小结" class="headerlink" title="原理小结"></a>原理小结</h3><ol>
<li>每个<code>Thread</code>维护着一个<code>ThreadLocalMap</code>的引用；</li>
<li><code>ThreadLocalMap</code>是<code>ThreadLocal</code>的内部类，用<code>Entry</code>来进行存储；</li>
<li>调用<code>ThreadLocal</code>的<code>set()</code>方法时，实际上就是往<code>ThreadLocalMap</code>设置值，<code>key</code>是<code>ThreadLocal</code>对象，值是传递进来的对象；</li>
<li>调用<code>ThreadLocal</code>的<code>get()</code>方法时，实际上就是往<code>ThreadLocalMap</code>获取值，<code>key</code>是<code>ThreadLocal</code>对象；</li>
<li><code>ThreadLocal</code>本身并不存储值，它只是作为一个<code>key</code>来让线程从<code>ThreadLocalMa</code>p获取<code>value</code>。</li>
</ol>
<h2 id="三、使用场景"><a href="#三、使用场景" class="headerlink" title="三、使用场景"></a>三、使用场景</h2><h3 id="3-1-ThreadLocal的作用"><a href="#3-1-ThreadLocal的作用" class="headerlink" title="3.1 ThreadLocal的作用"></a>3.1 <code>ThreadLocal</code>的作用</h3><ul>
<li>保存线程上下文信息，在任意需要的地方可以获取.</li>
</ul>
<p>由于<code>ThreadLocal</code>的特性，同一线程在某地方进行设置，在随后的任意地方都可以获取到。从而可以用来保存线程上下文信息。</p>
<ul>
<li>线程安全的，避免某些情况需要考虑线程安全必须同步带来的性能损失.</li>
</ul>
<h3 id="3-2-场景一：独享对象"><a href="#3-2-场景一：独享对象" class="headerlink" title="3.2 场景一：独享对象"></a>3.2 场景一：独享对象</h3><p>每个线程需要一个独享对象（通常是工具类，典型需要使用的类有<code>SimpleDateFormat</code>和<code>Random</code>）</p>
<p>这类场景阿里规范里面也提到了：</p>
<p><img src="/File/Imgs/article/ThreaLocal%20for%20Alibaba.png" alt="风尘博客"></p>
<h3 id="3-3-场景二：当前信息需要被线程内的所有方法共享"><a href="#3-3-场景二：当前信息需要被线程内的所有方法共享" class="headerlink" title="3.3 场景二：当前信息需要被线程内的所有方法共享"></a>3.3 场景二：当前信息需要被线程内的所有方法共享</h3><p>每个线程内需要保存全局变量（例如在拦截器中获取用户信息），可以让不同方法直接使用，避免参数传递的麻烦。</p>
<p><img src="/File/Imgs/article/ThreadLocal%20for%20Params.png" alt="风尘博客"></p>
<h3 id="3-4-使用ThreadLocal的好处"><a href="#3-4-使用ThreadLocal的好处" class="headerlink" title="3.4 使用ThreadLocal的好处"></a>3.4 使用<code>ThreadLocal</code>的好处</h3><ol>
<li>达到线程安全的目的；</li>
<li>不需要加锁，执行效率高；</li>
<li>更加节省内存，节省开销；</li>
<li>免去传参的繁琐，降低代码耦合度。</li>
</ol>
<h2 id="四、问题"><a href="#四、问题" class="headerlink" title="四、问题"></a>四、问题</h2><h3 id="4-1-内存泄漏问题"><a href="#4-1-内存泄漏问题" class="headerlink" title="4.1 内存泄漏问题"></a>4.1 内存泄漏问题</h3><blockquote>
<p>内存泄露：某个对象不会再被使用，但是该对象的内存却无法被收回</p>
</blockquote>
<ul>
<li>正常情况</li>
</ul>
<p>当<code>Thread</code>运行结束后，<code>ThreadLocal</code>中的<code>value</code>会被回收，因为没有任何强引用了。</p>
<ul>
<li>非正常情况</li>
</ul>
<p>当<code>Thread</code>一直在运行始终不结束，强引用就不会被回收，存在以下调用链</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Thread--&gt;ThreadLocalMap--&gt;Entry(key为null)--&gt;value</span><br></pre></td></tr></table></figure>

<p>因为调用链中的 <code>value</code> 和 <code>Thread</code> 存在强引用，所以<code>value</code>无法被回收，就有可能出现<code>OOM</code>。</p>
<p><strong>如何避免内存泄漏(阿里规范)</strong></p>
<p>调用<code>remove()</code>方法，就会删除对应的<code>Entry</code>对象，可以避免内存泄漏，所以使用完<code>ThreadLocal</code>后，要调用<code>remove()</code>方法。</p>
<p><img src="/File/Imgs/article/ThreadLocal%20for%20OOM.png" alt="风尘博客"></p>
<h3 id="4-2-ThreadLocal的空指针问题"><a href="#4-2-ThreadLocal的空指针问题" class="headerlink" title="4.2 ThreadLocal的空指针问题"></a>4.2 <code>ThreadLocal</code>的空指针问题</h3><ul>
<li><code>ThreadLocalNPE.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalNPE</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ThreadLocal&lt;Long&gt; longThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        longThreadLocal.set(Thread.currentThread().getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前返回值为基本类型，会报空指针异常，如果改成包装类型Long就不会出错</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> longThreadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>空指针测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">threadLocalNPE</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ThreadLocalNPE threadLocalNPE = <span class="keyword">new</span> ThreadLocalNPE();</span><br><span class="line">    <span class="comment">//如果get方法返回值为基本类型，则会报空指针异常，如果是包装类型就不会出错</span></span><br><span class="line">    System.out.println(threadLocalNPE.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>get()</code>方法返回值为基本类型，则会报空指针异常；如果是包装类型就不会出错。这是因为基本类型和包装类型存在装箱和拆箱的关系，所以，我们必须将<code>get()</code>方法返回值使用包装类型。</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ol>
<li><a href="https://www.cnblogs.com/ithuangqing/p/12114581.html" target="_blank" rel="noopener">再也不学Threadlocal了，看这一篇就忘不掉了（万字总结）</a></li>
<li><a href="https://juejin.im/post/5e0d8765f265da5d332cde44#comment" target="_blank" rel="noopener">使用 ThreadLocal 一次解决老大难问题</a></li>
</ol>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>ThreadLocal</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 整合腾讯云短信验证码</title>
    <url>/2019/06/29/6cff4232.html</url>
    <content><![CDATA[<blockquote>
<p>短信业务在我们日常使用的软件或者网站，应该算是无处不在的功能模块，比如注册、验证码功能。国内有很多互联网公司都提供短信业务，比如阿里、腾讯、七牛。本篇文章提及的是腾讯提供的短信服务。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、腾讯短信服务"><a href="#一、腾讯短信服务" class="headerlink" title="一、腾讯短信服务"></a>一、腾讯短信服务</h2><p>腾讯提供的短信业务，<strong>提供每个月100 的免费额度（已下线）</strong>，用来测试足够了。打开<a href="https://console.cloud.tencent.com/sms/smslist" target="_blank" rel="noopener">https://console.cloud.tencent.com/sms/smslist</a>，在腾讯短信服务的页面，进行简单的注册以及简单的配置：创建签名和模板等，然后采用官方提供的<code>SDK</code>，调用接口即可。详细配置参见文章：<a href="https://mp.weixin.qq.com/s/kWR-awfOutRZNAmpxvNzQA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/kWR-awfOutRZNAmpxvNzQA</a></p>
<h2 id="二、SpringBoot-发送短信验证码"><a href="#二、SpringBoot-发送短信验证码" class="headerlink" title="二、SpringBoot 发送短信验证码"></a>二、<code>SpringBoot</code> 发送短信验证码</h2><h3 id="2-1-项目配置文件"><a href="#2-1-项目配置文件" class="headerlink" title="2.1 项目配置文件"></a>2.1 项目配置文件</h3><ul>
<li><code>pom.xml</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vaadin.external.google<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>android-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 腾讯云sdk--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.qcloudsms<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>qcloudsms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--fastjson--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>application.yml</code></li>
</ul>
<blockquote>
<p>该配置在注册腾讯云以及配置后，可以在控制台拿到这些数据。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tx:</span><br><span class="line">  sms:</span><br><span class="line">    appId: appId</span><br><span class="line">    appKey: appKey</span><br><span class="line">    templateId: 1</span><br><span class="line">    smsSign: 风尘博客</span><br><span class="line">    smsEffectiveTime: 5</span><br></pre></td></tr></table></figure>

<h3 id="2-2-封装一个验证码实体类SmsParams"><a href="#2-2-封装一个验证码实体类SmsParams" class="headerlink" title="2.2 封装一个验证码实体类SmsParams"></a>2.2 封装一个验证码实体类<code>SmsParams</code></h3><blockquote>
<p>这里为了简单，我只保留了必备的两个字断手机号和验证码，实际项目中还包括验证码类型、项目名称等等，请根据实际需要扩展。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Data</span><br><span class="line">@Accessors(chain &#x3D; true)</span><br><span class="line">public class SmsParams &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 验证码</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private String verifyCode;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 手机号码</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private String phone;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public SmsParams(String phone, String verifyCode) &#123;</span><br><span class="line">       this.phone &#x3D; phone;</span><br><span class="line">       this.verifyCode &#x3D; verifyCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line"></span><br><span class="line">### 2.3 封装发送验证码的工具类&#96;TxCloudSmsUtil&#96;</span><br><span class="line"></span><br><span class="line">&gt; 官网&#96;SDK&#96; 有：单发短信、指定模板 &#96;ID&#96; 单发短信、群发短信、指定模板群发短信以及拉取短信回执和短信回复状态（个人用户无法体验）等方式发送验证码，我这里只演示最常用的&quot;指定模板 &#96;ID&#96; 单发短信&quot;。</span><br></pre></td></tr></table></figure>
<p>@Component<br>public class TxCloudSmsUtil {</p>
<pre><code>// 短信应用 SDK AppID
@Value(&quot;${tx.sms.appId}&quot;)
int appId; // 1400开头

// 短信应用SDK AppKey
@Value(&quot;${tx.sms.appKey}&quot;)
String appKey;

// 短信模板ID，需要在短信应用中申请
@Value(&quot;${tx.sms.templateId}&quot;)
int templateId ; // NOTE: 真实的模板ID需要在短信控制台中申请
//我这里 templateId 对应的内容是&quot;您的验证码是: {1}&quot;
// 签名
@Value(&quot;${tx.sms.smsSign}&quot;)
String smsSign ; // NOTE: 签名参数使用的是`签名内容`，而不是`签名ID`。这里的签名&quot;腾讯云&quot;只是一个示例，真实的签名需要在短信控制台申请

@Value(&quot;${tx.sms.smsEffectiveTime}&quot;)
String smsEffectiveTime ;

/**
 * 指定模板 ID 单发短信
 * @param smsParams
 */
public String sendSms(SmsParams smsParams) {
    String rep = &quot;error&quot;;
    try {
        String verifyCode = smsParams.getVerifyCode();
        // 数组具体的元素个数和模板中变量个数必须一致，例如示例中templateId:5678对应一个变量，参数数组中元素个数也必须是一个
        String[] params = {verifyCode,smsEffectiveTime};
        SmsSingleSender smsSingleSender = new SmsSingleSender(appId, appKey);
        // 签名参数未提供或者为空时，会使用默认签名发送短信
        SmsSingleSenderResult smsSingleSenderResult = smsSingleSender.sendWithParam(&quot;86&quot;, smsParams.getPhone(),
                templateId, params, smsSign, &quot;&quot;, &quot;&quot;);
        System.out.println(smsSingleSenderResult);
        // 如果返回码不是0，说明配置有错，返回错误信息
        if (smsSingleSenderResult.result == 0) {
            rep = &quot;success&quot;;
        } else {
            rep = smsSingleSenderResult.errMsg;
        }
    } catch (HTTPException e) {
        // HTTP响应码错误
        e.printStackTrace();
    } catch (JSONException e) {
        // json解析错误
        e.printStackTrace();
    } catch (IOException e) {
        // 网络IO错误
        e.printStackTrace();
    }catch (Exception e) {
        // 网络IO错误
        e.printStackTrace();
    }
    return rep;
}</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">简单解释下，我这里封装的方法，如果短信发送成功，返回&#96;success&#96;，失败会返回&#96;smsSingleSenderResult.errMsg&#96;的详细原因（判断依据是：成功发送到返回码是：&#96;0&#96;）。实际运用中，可以在调用的地方对返回结果进行处理。</span><br><span class="line"></span><br><span class="line">### 2.4 测试发送验证码</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">@SpringBootTest</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">public class SmsTest &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    TxCloudSmsUtil txCloudSmsUtil;</span><br><span class="line">    @Test</span><br><span class="line">    public void testSms() &#123;</span><br><span class="line">        &#x2F;&#x2F; 生成随机的六位数验证码</span><br><span class="line">        Random random &#x3D; new Random(4);</span><br><span class="line">        Integer verifyCode &#x3D; random.nextInt(1000000);</span><br><span class="line">        SmsParams smsParams &#x3D; new SmsParams(&quot;17098705205&quot;,verifyCode.toString());</span><br><span class="line">        System.out.println(&quot;生成的验证码为：&quot; + verifyCode);</span><br><span class="line">        &#x2F;&#x2F; smsParams.setPhone(&quot;17098705205&quot;).setVerifyCode();</span><br><span class="line">        String str &#x3D; txCloudSmsUtil.sendSms(smsParams);</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>手机上接收到消息如下：</p>
<blockquote>
<p>【风尘博客】你的验证码为<code>971862</code>，该验证码<code>5</code>分钟内有效，请保护好您的验证码,如非本人操作，请忽略本短信。</p>
</blockquote>
<p>说明发送成功！</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-sms/tencentCloudSms" target="_blank" rel="noopener">Github 示例代码</a></p>
<p><a href="https://cloud.tencent.com/document/product/382/13613#%E5%8D%95%E5%8F%91%E7%9F%AD%E4%BF%A1" target="_blank" rel="noopener">Java SDK文档</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>验证码</tag>
        <tag>短信</tag>
        <tag>腾讯云</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 整合七牛云上传文件</title>
    <url>/2019/06/21/13487beb.html</url>
    <content><![CDATA[<blockquote>
<p>如果还没有七牛云账户，请先去<a href="https://portal.qiniu.com/signup?code=1hmackwtyy7o2" target="_blank" rel="noopener">七牛云注册</a>，本文不详细介绍七牛云的具体使用，只介绍如何将图片上传到七牛云并返回访问链接。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、项目配置"><a href="#一、项目配置" class="headerlink" title="一、项目配置"></a>一、项目配置</h2><h3 id="1-1-项目所依赖的jar包"><a href="#1-1-项目所依赖的jar包" class="headerlink" title="1.1 项目所依赖的jar包"></a>1.1 项目所依赖的<code>jar</code>包</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 七牛云 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.qiniu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>qiniu-java-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Swagger-ui配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-yml项目配置文件中七牛云账户相关的密钥"><a href="#1-2-yml项目配置文件中七牛云账户相关的密钥" class="headerlink" title="1.2 yml项目配置文件中七牛云账户相关的密钥"></a>1.2 <code>yml</code>项目配置文件中七牛云账户相关的密钥</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 七牛云相关配置</span></span><br><span class="line"><span class="attr">qinNiuCloud:</span></span><br><span class="line">  <span class="attr">ACCESS_KEY:</span> <span class="string">你的ACCESS_KEY</span></span><br><span class="line">  <span class="attr">SECRET_KEY:</span> <span class="string">你的SECRET_KEY</span></span><br><span class="line">  <span class="attr">bucketName:</span> <span class="string">你的空间名称</span></span><br><span class="line">  <span class="attr">bucketNameUrl:</span> <span class="string">该空间对应的域名</span></span><br><span class="line">  <span class="attr">imgStyle:</span> <span class="string">自定义的图片样式（本文未用到）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传图片的限制</span></span><br><span class="line"><span class="attr">upload:</span></span><br><span class="line">  <span class="attr">maxSize:</span> <span class="number">3.0</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-新建七牛云配置文件类QiNiuCloudConfiguration-java"><a href="#1-3-新建七牛云配置文件类QiNiuCloudConfiguration-java" class="headerlink" title="1.3 新建七牛云配置文件类QiNiuCloudConfiguration.java"></a>1.3 新建七牛云配置文件类<code>QiNiuCloudConfiguration.java</code></h3><blockquote>
<p>稍微解释一下该类的必要性，<code>QiNiuCloudConfiguration</code>的作用是将配置文件中数据转换成静态数据，详细介绍见下篇文章。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QiNiuCloudConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置账号的AK和SK</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  String accessKey;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String secretKEY;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 要上传的空间和上传空间域名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String bucketName;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String bucketNameUrl;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片处理的格式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String imgStyle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制上传图片的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Double MB = <span class="number">1024.0</span>*<span class="number">1024.0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Double maxSize;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qinNiuCloud.ACCESS_KEY&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tempAccessKey;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qinNiuCloud.SECRET_KEY&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tempSecretKEY;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qinNiuCloud.bucketName&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tempBucketName;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qinNiuCloud.bucketNameUrl&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tempBucketNameUrl;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;qinNiuCloud.imgStyle&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String tempImgStyle;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;upload.maxSize&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Double tempMaxSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 被<span class="doctag">@PostConstruct</span>修饰的方法会在服务器加载Servle的时候运行，并且只会被服务器执行一次。</span></span><br><span class="line"><span class="comment">     * PostConstruct在构造函数之后执行,init()方法之前执行。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        accessKey = <span class="keyword">this</span>.tempAccessKey;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecretKEY</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        secretKEY = <span class="keyword">this</span>.tempSecretKEY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBucketName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bucketName = <span class="keyword">this</span>.tempBucketName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBucketNameUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bucketNameUrl = <span class="keyword">this</span>.tempBucketNameUrl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImgStyle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        imgStyle = <span class="keyword">this</span>.tempImgStyle;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        maxSize = <span class="keyword">this</span>.tempMaxSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-4-Swagger2-配置"><a href="#1-4-Swagger2-配置" class="headerlink" title="1.4 Swagger2 配置"></a>1.4 <code>Swagger2</code> 配置</h3><blockquote>
<p>为了方便测试，本项目集成了<code>Swagger2</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2Config</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">// 指定controller存放的目录路径</span></span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"cn.van.qiniu.web.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line"><span class="comment">//                .globalOperationParameters(pars);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                <span class="comment">// 文档标题</span></span><br><span class="line">                .title(<span class="string">"这里是Swagger文档标题"</span>)</span><br><span class="line">                <span class="comment">// 文档描述</span></span><br><span class="line">                .description(<span class="string">"这里是文档描述"</span>)</span><br><span class="line">                .termsOfServiceUrl(<span class="string">"https://www.dusty.vip"</span>)</span><br><span class="line">                .version(<span class="string">"v1.0"</span>)<span class="comment">//定义版本号</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、-上传图片业务"><a href="#二、-上传图片业务" class="headerlink" title="二、 上传图片业务"></a>二、 上传图片业务</h2><h3 id="2-1-七牛上传工具类-QiNiuCloudUtil-java"><a href="#2-1-七牛上传工具类-QiNiuCloudUtil-java" class="headerlink" title="2.1 七牛上传工具类 QiNiuCloudUtil.java"></a>2.1 七牛上传工具类 <code>QiNiuCloudUtil.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QiNiuCloudUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置账号的AK和SK</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACCESS_KEY = QiNiuCloudConfiguration.accessKey;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECRET_KEY = QiNiuCloudConfiguration.secretKEY;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 要上传的空间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String bucketName = QiNiuCloudConfiguration.bucketName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传空间域名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String bucketNameUrl = QiNiuCloudConfiguration.bucketNameUrl;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Auth auth = Auth.create(ACCESS_KEY, SECRET_KEY);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义的图片样式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String imgStyle = QiNiuCloudConfiguration.imgStyle;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUpToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//生成凭证</span></span><br><span class="line">        <span class="keyword">return</span> auth.uploadToken(bucketName, <span class="keyword">null</span>, <span class="number">3600</span>, <span class="keyword">new</span> StringMap().put(<span class="string">"insertOnly"</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  base64方式上传</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> base64 ：图片编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName：图片名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">uploadPicByBase64</span><span class="params">(<span class="keyword">byte</span>[] base64, String fileName)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String file64 = Base64.encodeToString(base64, <span class="number">0</span>);</span><br><span class="line">        Integer length = base64.length;</span><br><span class="line">        String dateStr = LocalDate.now().toString();</span><br><span class="line">        <span class="comment">// 将当前日期拼接在文件名称中</span></span><br><span class="line">        fileName = dateStr + <span class="string">"/"</span> + fileName;</span><br><span class="line">        String url = <span class="string">"http://upload.qiniu.com/putb64/"</span> + length + <span class="string">"/key/"</span>+ UrlSafeBase64.encodeToString(fileName);</span><br><span class="line">        <span class="comment">//非华东空间需要根据注意事项 : 修改上传域名</span></span><br><span class="line">        RequestBody requestBody = RequestBody.create(<span class="keyword">null</span>, file64);</span><br><span class="line">        Request request = <span class="keyword">new</span> Request.Builder()</span><br><span class="line">                .url(url)</span><br><span class="line">                .addHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/octet-stream"</span>)</span><br><span class="line">                .addHeader(<span class="string">"Authorization"</span>, <span class="string">"UpToken "</span> + getUpToken())</span><br><span class="line">                .post(requestBody).build();</span><br><span class="line">        OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</span><br><span class="line">        okhttp3.Response response = client.newCall(request).execute();</span><br><span class="line">        <span class="comment">// 上传成功返回图片地址</span></span><br><span class="line">        <span class="keyword">return</span> response.isSuccessful()?(<span class="string">"http://"</span> + bucketNameUrl + <span class="string">"/"</span> + fileName):<span class="string">"Up Img Failed"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-接口"><a href="#2-2-接口" class="headerlink" title="2.2 接口"></a>2.2 接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/upload"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"七牛云上传接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QiNiuCloudController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 限制上传图片的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Double Mb = QiNiuCloudConfiguration.MB;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Double maxSize = QiNiuCloudConfiguration.maxSize;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"上传图片到七牛云"</span>)</span><br><span class="line">    <span class="meta">@PostMapping</span>(value=<span class="string">"/uploadToQiNiu"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">uploadImg</span><span class="params">(@RequestParam(<span class="string">"file"</span>)</span> MultipartFile image) </span>&#123;</span><br><span class="line">        String result = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(!image.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkSize(image)) &#123;</span><br><span class="line">                <span class="comment">//超出限制大小</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">"OUT OF SIZE"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String widthAndHeight = <span class="keyword">this</span>.getWidthAndHeight(image);</span><br><span class="line">            <span class="keyword">if</span> ((<span class="string">"ERROR"</span>).equals(widthAndHeight)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"ERROR"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = image.getBytes();</span><br><span class="line">                <span class="comment">// 用随机字符串当做图片名存储</span></span><br><span class="line">                String imageName = UUID.randomUUID().toString();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//使用base64方式上传到七牛云</span></span><br><span class="line">                    result = QiNiuCloudUtil.uploadPicByBase64(bytes, imageName);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">//上传失败</span></span><br><span class="line">                result = <span class="string">"UPLOAD FAILED！"</span>;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 图片为空</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"EMPTY！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验大小，上传图片不能大于指定大小</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkSize</span><span class="params">(MultipartFile file)</span></span>&#123;</span><br><span class="line">        <span class="comment">//校验大小</span></span><br><span class="line">        <span class="keyword">double</span> ratio = file.getSize() / Mb;</span><br><span class="line">        <span class="keyword">return</span> ratio &gt; maxSize ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取图片宽高拼接字符串：?width=100&amp;height=200</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getWidthAndHeight</span><span class="params">(MultipartFile file)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream inputStream = file.getInputStream();</span><br><span class="line">            BufferedImage image = ImageIO.read(inputStream);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == image)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"ERROR"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> width = image.getWidth();</span><br><span class="line">            <span class="keyword">int</span> height = image.getHeight();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"?width="</span>+width+<span class="string">"&amp;height="</span>+height;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三、测试及源码"><a href="#三、测试及源码" class="headerlink" title="三、测试及源码"></a>三、测试及源码</h2><p>启动项目，访问<code>swagger</code>地址 <a href="http://localhost:8080/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html</a></p>
<h3 id="3-1-测试上传接口"><a href="#3-1-测试上传接口" class="headerlink" title="3.1 测试上传接口"></a>3.1 测试上传接口</h3><ol>
<li>打开上上传图片的接口，上传一张本地的图片</li>
<li>成功上传，返回访问该图片的链接地址，如：<a href="http://qiniu.dusty.vip/2019-09-25/6726943a-9047-4006-bee1-04e9c50eb8e4" target="_blank" rel="noopener">http:/qiniu.dusty.vip/2019-09-25/6726943a-9047-4006-bee1-04e9c50eb8e4</a></li>
<li>进入七牛云上该项目对应的空间，发现该图片是否存在。</li>
</ol>
<h3 id="3-2-访问图片"><a href="#3-2-访问图片" class="headerlink" title="3.2 访问图片"></a>3.2 访问图片</h3><p>打开返回的链接地址，即可访问该图片。</p>
<p>如：<a href="http://qiniu.dusty.vip/2019-06-25/8281ac0c-ded5-478f-8c9f-db5d6939b745" target="_blank" rel="noopener">http://qiniu.dusty.vip/2019-06-25/8281ac0c-ded5-478f-8c9f-db5d6939b745</a></p>
<h2 id="四、开源地址"><a href="#四、开源地址" class="headerlink" title="四、开源地址"></a>四、开源地址</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-qiniu" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>图床</tag>
        <tag>七牛云</tag>
      </tags>
  </entry>
  <entry>
    <title>MyBatis 模糊查询</title>
    <url>/2019/06/15/a40ca0a9.html</url>
    <content><![CDATA[<p>模糊查询也是数据库<code>SQL</code>中使用频率很高的<code>SQL</code>语句，使用<code>MyBatis</code>来进行更加灵活的模糊查询。</p>
<a id="more"></a>

<h2 id="一、数据准备"><a href="#一、数据准备" class="headerlink" title="一、数据准备"></a>一、数据准备</h2><h3 id="1-1-sql"><a href="#1-1-sql" class="headerlink" title="1.1 sql"></a>1.1 <code>sql</code></h3><blockquote>
<p>相见<a href="https://github.com/vanDusty/Mybatis-Home/blob/master/mybatis-case/mybatis-demo/file/mybatis-demo-like.sql" target="_blank" rel="noopener">mybatis-demo-like.sql</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_info_like`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_info_like`</span> (</span><br><span class="line">                           <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键id'</span>,</span><br><span class="line">                           <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'账户名称'</span>,</span><br><span class="line">                           <span class="string">`pass_word`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'登录密码'</span>,</span><br><span class="line">                           <span class="string">`nick_name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</span><br><span class="line">                           <span class="string">`mobile`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'手机号'</span>,</span><br><span class="line">                           <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'邮箱地址'</span>,</span><br><span class="line">                           <span class="string">`gmt_create`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">                           <span class="string">`gmt_update`</span> <span class="built_in">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span>,</span><br><span class="line">                           PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ROW_FORMAT=DYNAMIC <span class="keyword">COMMENT</span> <span class="string">'Mybatis like'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of user_info_like</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_like`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'Van'</span>, <span class="string">'123456'</span>, <span class="string">'风尘'</span>, <span class="string">'12580'</span>, <span class="literal">NULL</span>, <span class="string">'2020-02-01 14:52:12'</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_like`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'zhangsan'</span>, <span class="string">'123456'</span>, <span class="string">'张三'</span>, <span class="string">'12580'</span>, <span class="literal">NULL</span>, <span class="string">'2020-01-02 14:52:12'</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_like`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">'lisi'</span>, <span class="string">'123456'</span>, <span class="string">'李四'</span>, <span class="string">'12580'</span>, <span class="literal">NULL</span>, <span class="string">'2020-02-01 14:52:12'</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_like`</span> <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">'wanger'</span>, <span class="string">'123456'</span>, <span class="string">'王二'</span>, <span class="string">'12580'</span>, <span class="literal">NULL</span>, <span class="string">'2020-02-02 15:48:34'</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_like`</span> <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">'wangwu'</span>, <span class="string">'123456'</span>, <span class="string">'王五'</span>, <span class="string">'12580'</span>, <span class="literal">NULL</span>, <span class="string">'2020-02-02 15:48:56'</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>


<h3 id="1-2-UserInfoLikeDO-java"><a href="#1-2-UserInfoLikeDO-java" class="headerlink" title="1.2 UserInfoLikeDO.java"></a>1.2 <code>UserInfoLikeDO.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoLikeDO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String passWord;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime gmtCreate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime gmtUpdate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassWord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> passWord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassWord</span><span class="params">(String passWord)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.passWord = passWord;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNickName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nickName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNickName</span><span class="params">(String nickName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nickName = nickName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMobile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMobile</span><span class="params">(String mobile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mobile = mobile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getGmtCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gmtCreate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGmtCreate</span><span class="params">(LocalDateTime gmtCreate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gmtCreate = gmtCreate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalDateTime <span class="title">getGmtUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gmtUpdate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGmtUpdate</span><span class="params">(LocalDateTime gmtUpdate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gmtUpdate = gmtUpdate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"UserInfoLikeDO&#123;"</span> +</span><br><span class="line">                <span class="string">"id="</span> + id +</span><br><span class="line">                <span class="string">", userName='"</span> + userName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", passWord='"</span> + passWord + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", nickName='"</span> + nickName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", mobile='"</span> + mobile + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", email='"</span> + email + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", gmtCreate="</span> + gmtCreate +</span><br><span class="line">                <span class="string">", gmtUpdate="</span> + gmtUpdate +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二、模糊查询的四种方式"><a href="#二、模糊查询的四种方式" class="headerlink" title="二、模糊查询的四种方式"></a>二、模糊查询的四种方式</h2><h3 id="2-1-直接传参法"><a href="#2-1-直接传参法" class="headerlink" title="2.1 直接传参法"></a>2.1 直接传参法</h3><p>将要查询的关键字<code>keyword</code>,在代码中拼接好要查询的格式，如<code>%keyword%</code>,然后直接作为参数传入<code>mapper.xml</code>的映射文件中。</p>
<ul>
<li>测试代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String nickName = <span class="string">"%"</span> + <span class="string">"王"</span> + <span class="string">"%"</span>;</span><br><span class="line">    List&lt;UserInfoLikeDO&gt; list = userInfoLikeMapper.selectByKeyWord(nickName);</span><br><span class="line">    log.info(<span class="string">"UserList:&#123;&#125;"</span>, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">List&lt;UserInfoDO&gt; <span class="title">selectByKeyWord</span><span class="params">(String nickName)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 映射文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByKeyWord"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"Base_Column_List"</span> /&gt;</span></span><br><span class="line">  from user_info_like</span><br><span class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != '' and nickName != null"</span>&gt;</span></span><br><span class="line">      and nick_name like #&#123;nickName&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-使用-代替"><a href="#2-2-使用-代替" class="headerlink" title="2.2 使用${...}代替#{...}"></a>2.2 使用<code>${...}</code>代替<code>#{...}</code></h3><p>我们都知道，<code>${}</code>解析过来的参数值不带单引号，<code>#{}</code>解析传过来参数带单引号。</p>
<ul>
<li>测试代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">selectByWordTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String nickName =<span class="string">"王"</span>;</span><br><span class="line">    List&lt;UserInfoLikeDO&gt; list = userInfoLikeMapper.selectByWord(nickName);</span><br><span class="line">    log.info(<span class="string">"UserList:&#123;&#125;"</span>, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">List&lt;UserInfoDO&gt; <span class="title">selectByWord</span><span class="params">(String nickName)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 映射文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByWord"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"Base_Column_List"</span> /&gt;</span></span><br><span class="line">  from user_info_like</span><br><span class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != '' and nickName != null"</span>&gt;</span></span><br><span class="line">      and nick_name like '%$&#123;nickName&#125;%'</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-CONCAT（）函数"><a href="#2-3-CONCAT（）函数" class="headerlink" title="2.3 CONCAT（）函数"></a>2.3 <code>CONCAT（）</code>函数</h3><p><code>MySQL</code>的 <code>CONCAT()</code>函数用于将多个字符串连接成一个字符串，是最重要的<code>mysql</code>函数之一。</p>
<ul>
<li>测试代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">concatTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String nickName = <span class="string">"王"</span>;</span><br><span class="line">    List&lt;UserInfoLikeDO&gt; list = userInfoLikeMapper.selectForConcat(nickName);</span><br><span class="line">    log.info(<span class="string">"UserList:&#123;&#125;"</span>, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">List&lt;UserInfoDO&gt; <span class="title">selectForConcat</span><span class="params">(String nickName)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 映射文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectForConcat"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"Base_Column_List"</span> /&gt;</span></span><br><span class="line">  from user_info_like</span><br><span class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != '' and nickName != null"</span>&gt;</span></span><br><span class="line">      and nick_name like CONCAT('%',#&#123;nickName&#125;,'%')</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4-Mybatis的bind"><a href="#2-4-Mybatis的bind" class="headerlink" title="2.4 Mybatis的bind"></a>2.4 <code>Mybatis</code>的<code>bind</code></h3><p><code>bind</code>:可以将<code>OGNL</code>表达式的值绑定到一个变量中，方便后来引用这个变量的值。</p>
<ul>
<li>测试代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bindTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String nickName = <span class="string">"王"</span>;</span><br><span class="line">    List&lt;UserInfoLikeDO&gt; list = userInfoLikeMapper.selectForBind(nickName);</span><br><span class="line">    log.info(<span class="string">"UserList:&#123;&#125;"</span>, list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 接口</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function">List&lt;UserInfoDO&gt; <span class="title">selectForBind</span><span class="params">(String nickName)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Mapper</code> 映射文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectForBind"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bind</span> <span class="attr">name</span>=<span class="string">"keyWord"</span> <span class="attr">value</span>=<span class="string">"'%' + nickName + '%'"</span> /&gt;</span></span><br><span class="line">  select</span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"Base_Column_List"</span> /&gt;</span></span><br><span class="line">  from user_info_like</span><br><span class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"nickName != '' and nickName != null"</span>&gt;</span></span><br><span class="line">      and nick_name like #&#123;keyWord&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>说明</li>
</ul>
<p>文中省略了的<code>BaseResultMap</code>/<code>Base_Column_List</code>等，详见<a href="https://github.com/vanDusty/Mybatis-Home/blob/master/mybatis-case/mybatis-demo/src/main/resources/mapper/UserInfoLikeMapper.xml" target="_blank" rel="noopener">UserInfoLikeMapper.xml</a></p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><ol>
<li>推荐使用<code>CONCAT（）</code>函数或者 <code>bind</code> 的方式；</li>
<li>注意关键词中有<code>%</code>、<code>_</code>这些特殊字符如何处理。</li>
</ol>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<p><a href="https://github.com/vanDusty/Frame-Home/blob/master/mybatis-case/mybatis-demo/src/test/java/cn/van/mybatis/demo/like/MybatisLikeTest.java" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>MyBatis</category>
      </categories>
      <tags>
        <tag>MyBatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 获取主机工具类</title>
    <url>/2019/06/08/bab28af9.html</url>
    <content><![CDATA[<p>拿到本机 <code>IP</code>不是一件困难的事，但是拿到正确的就比较难了。</p>
<a id="more"></a>


<h3 id="一、一般方式"><a href="#一、一般方式" class="headerlink" title="一、一般方式"></a>一、一般方式</h3><p><a href="https://www.runoob.com/java/net-localip.html" target="_blank" rel="noopener">【菜鸟教程】</a>中直接通过 <code>java.net.InetAddress</code>类获取，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      InetAddress addr = InetAddress.getLocalHost();</span><br><span class="line">      System.out.println(<span class="string">"Local HostAddress: </span></span><br><span class="line"><span class="string">      "</span>+addr.getHostAddress());</span><br><span class="line">      String hostname = addr.getHostName();</span><br><span class="line">      System.out.println(<span class="string">"Local host name: "</span>+hostname);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式获取的主机名没啥问题，<strong>但获取到的<code>IP</code>地址却有待考量</strong>：如果一台机器有多个网卡，他获取的<code>IP</code>是谁的呢？</p>
<blockquote>
<p>事实上，上面输出的<code>IP</code>是我虚拟机<code>IP</code>地址，既不是我有线网卡的地址，也不是我无线网卡的地址。</p>
</blockquote>
<h3 id="二、推荐使用"><a href="#二、推荐使用" class="headerlink" title="二、推荐使用"></a>二、推荐使用</h3><p>利用 <code>java.net.NetworkInterface</code> 获取，提供常用的静态方法如下：</p>
<ol>
<li><code>getLocalHostAddress()</code>：返回本机 <code>IP</code></li>
<li><code>getLocalHostName()</code>：返回主机名</li>
<li><code>getLocalInetAddress</code>：返回 <code>InetAddress</code></li>
<li><code>isWindowsOS()</code>：判断操作系统是否是 <code>Windows</code></li>
<li><code>isMacOS()</code>：判断操作系统是否是 <code>MacOS</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalHostUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InetAddress inetAddress;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回 InetAddress</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InetAddress <span class="title">getLocalInetAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inetAddress == <span class="keyword">null</span>) &#123;</span><br><span class="line">            load();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inetAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回本机IP</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getLocalHostAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inetAddress == <span class="keyword">null</span>) &#123;</span><br><span class="line">            load();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inetAddress.getHostAddress();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回主机名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getLocalHostName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inetAddress == <span class="keyword">null</span>) &#123;</span><br><span class="line">            load();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> InetAddress.getLocalHost().getHostName();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> inetAddress.getHostName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断操作系统是否是 Windows</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isWindowsOS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isWindowsOS = <span class="keyword">false</span>;</span><br><span class="line">        String osName = getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">        <span class="keyword">if</span> (osName.toLowerCase().indexOf(<span class="string">"windows"</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            isWindowsOS = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isWindowsOS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断操作系统是否是 MacOS</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMacOS</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isWindowsOS = <span class="keyword">false</span>;</span><br><span class="line">        String osName = getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">        <span class="keyword">if</span> (osName.toLowerCase().indexOf(<span class="string">"mac"</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            isWindowsOS = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isWindowsOS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InetAddress <span class="title">findValidateIp</span><span class="params">(List&lt;Address&gt; addresses)</span> </span>&#123;</span><br><span class="line">        InetAddress local = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> size = addresses.size();</span><br><span class="line">        <span class="keyword">int</span> maxWeight = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            Address address = addresses.get(i);</span><br><span class="line">            <span class="keyword">if</span> (address.isInet4Address()) &#123;</span><br><span class="line">                <span class="keyword">int</span> weight = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (address.isSiteLocalAddress()) &#123;</span><br><span class="line">                    weight += <span class="number">8</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (address.isLinkLocalAddress()) &#123;</span><br><span class="line">                    weight += <span class="number">4</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (address.isLoopbackAddress()) &#123;</span><br><span class="line">                    weight += <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (address.hasHostName()) &#123;</span><br><span class="line">                    weight += <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (weight &gt; maxWeight) &#123;</span><br><span class="line">                    maxWeight = weight;</span><br><span class="line">                    local = address.getAddress();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> local;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        String value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        value = System.getProperty(name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            value = System.getenv(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String ip = getProperty(<span class="string">"host.ip"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ip != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inetAddress = InetAddress.getByName(ip);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                System.err.println(e);</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;NetworkInterface&gt; nis = Collections.list(NetworkInterface.getNetworkInterfaces());</span><br><span class="line">            List&lt;Address&gt; addresses = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            InetAddress local = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 遍历网络接口</span></span><br><span class="line">                <span class="keyword">for</span> (NetworkInterface ni : nis) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ni.isUp() &amp;&amp; !ni.isLoopback()) &#123;</span><br><span class="line">                        List&lt;InetAddress&gt; list = Collections.list(ni.getInetAddresses());</span><br><span class="line">                        <span class="comment">// 遍历网络地址</span></span><br><span class="line">                        <span class="keyword">for</span> (InetAddress address : list) &#123;</span><br><span class="line">                            addresses.add(<span class="keyword">new</span> Address(address, ni));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                local = findValidateIp(addresses);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">            inetAddress = local;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">            <span class="comment">// ignore it</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Address</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> InetAddress inetAddress;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> loopback;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Address</span><span class="params">(InetAddress address, NetworkInterface ni)</span> </span>&#123;</span><br><span class="line">            inetAddress = address;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ni != <span class="keyword">null</span> &amp;&amp; ni.isLoopback()) &#123;</span><br><span class="line">                    loopback = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">                <span class="comment">// ignore it</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> InetAddress <span class="title">getAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> inetAddress;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasHostName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !inetAddress.getHostName().equals(inetAddress.getHostAddress());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLinkLocalAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !loopback &amp;&amp; inetAddress.isLinkLocalAddress();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLoopbackAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> loopback || inetAddress.isLoopbackAddress();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSiteLocalAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !loopback &amp;&amp; inetAddress.isSiteLocalAddress();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInet4Address</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> inetAddress <span class="keyword">instanceof</span> Inet4Address;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/vanDusty/jdk/blob/master/JDK-Tool/src/main/java/cn/van/jdk/tool/net/LocalHostUtil.java" target="_blank" rel="noopener">【Github 示例代码】</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>IP</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis 配置多数据源最简解决方案</title>
    <url>/2019/05/05/bf70c360.html</url>
    <content><![CDATA[<blockquote>
<p>现在主流的多数据源切换方式有：<code>AOP</code> 动态切换来做多数据源或者升级成<code>Mybatis-Plus</code>可以简单的配置多数据源，偶然见到大佬整理的很简单的多数据源的配置，改进一下，分享出来。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、项目准备"><a href="#一、项目准备" class="headerlink" title="一、项目准备"></a>一、项目准备</h2><h3 id="1-1-pom-xml"><a href="#1-1-pom-xml" class="headerlink" title="1.1 pom.xml"></a>1.1 <code>pom.xml</code></h3><blockquote>
<p>没有特殊的依赖，<code>mysql</code>  + <code>mybatis</code> + <code>druid</code></p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- druid连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-application-yml"><a href="#1-2-application-yml" class="headerlink" title="1.2 application.yml"></a>1.2 <code>application.yml</code></h3><p>我这里配置两个数据源：<code>master</code> 库和一个 <code>slave</code> 库，其中 <code>master</code>是默认库。可以有多个从库，自己去扩展吧，按照<code>slave</code> 库配置，再新增一个配置类即可。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    druid:</span><br><span class="line">      master: # 主数据源</span><br><span class="line">        username: master</span><br><span class="line">        password: password</span><br><span class="line">        driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        jdbc-url: jdbc:mysql:&#x2F;&#x2F;47.98.178.84:3306&#x2F;master</span><br><span class="line">        initialSize: 5</span><br><span class="line">        minIdle: 5</span><br><span class="line">        maxActive: 20</span><br><span class="line">      slave: # 第二个数据源</span><br><span class="line">        username: slave</span><br><span class="line">        password: password</span><br><span class="line">        driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        jdbc-url: jdbc:mysql:&#x2F;&#x2F;47.98.178.84:3306&#x2F;slave</span><br><span class="line">        initialSize: 5</span><br><span class="line">        minIdle: 5</span><br><span class="line">        maxActive: 20</span><br></pre></td></tr></table></figure>

<h3 id="1-3-初始化表"><a href="#1-3-初始化表" class="headerlink" title="1.3 初始化表"></a>1.3 初始化表</h3><blockquote>
<p>因为我的测试是在两个库分别插入数据，所以需要分别在两个库新建结构相同的表，<code>sql</code>如下：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键'</span>,</span><br><span class="line">  <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户名'</span>,</span><br><span class="line">  <span class="string">`pass_word`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`user_sex`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'性别'</span>,</span><br><span class="line">  <span class="string">`nick_name`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'昵称'</span>,</span><br><span class="line">  <span class="string">`gmt_create`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h2 id="二、数据源配置"><a href="#二、数据源配置" class="headerlink" title="二、数据源配置"></a>二、数据源配置</h2><h3 id="2-1-主数据源配置"><a href="#2-1-主数据源配置" class="headerlink" title="2.1 主数据源配置"></a>2.1 主数据源配置</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = <span class="string">"cn.van.mybatis.multipledata.simple.mapper.master"</span>, sqlSessionTemplateRef  = <span class="string">"masterSqlSessionTemplate"</span>)</span><br><span class="line"><span class="comment">// 指定主库扫描的 dao包，并给 dao层注入指定的 SqlSessionTemplate</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSource1Config</span> </span>&#123;</span><br><span class="line"><span class="comment">//    首先创建 DataSource</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"masterDataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.druid.master"</span>)</span><br><span class="line">    <span class="meta">@Primary</span> <span class="comment">// 指定是主库</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">testDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//  然后创建 SqlSessionFactory</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"masterSqlSessionFactory"</span>)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">testSqlSessionFactory</span><span class="params">(@Qualifier(<span class="string">"masterDataSource"</span>)</span> DataSource dataSource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        bean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath:mapper/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//  再创建事务</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"masterTransactionManager"</span>)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">testTransactionManager</span><span class="params">(@Qualifier(<span class="string">"masterDataSource"</span>)</span> DataSource dataSource) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//  最后包装到 SqlSessionTemplate 中</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"masterSqlSessionTemplate"</span>)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">testSqlSessionTemplate</span><span class="params">(@Qualifier(<span class="string">"masterSqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>首先创建 <code>DataSource</code>，然后创建 <code>SqlSessionFactory</code>，再创建事务，最后包装到 <code>SqlSessionTemplate</code> 中；</li>
<li><code>@MapperScan(basePackages = &quot;***&quot;, sqlSessionTemplateRef  = &quot;***&quot;)</code>:指定主库扫描的 <code>mapper</code> 文件，并注入指定的 <code>SqlSessionTemplate</code>,同时<code>SqlSessionFactory</code>的<code>bean</code>中指定<code>xml</code>文件位置;</li>
<li><code>@Primary</code> 说明指定了主库。</li>
</ol>
<h3 id="2-2-从库数据源配置"><a href="#2-2-从库数据源配置" class="headerlink" title="2.2 从库数据源配置"></a>2.2 从库数据源配置</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = <span class="string">"cn.van.mybatis.multipledata.simple.mapper.slave"</span>, sqlSessionTemplateRef  = <span class="string">"db2SqlSessionTemplate"</span>)</span><br><span class="line"><span class="comment">// 指定分库扫描的 dao包，并给 dao层注入指定的 SqlSessionTemplate</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSource2Config</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    首先创建 DataSource</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"db2DataSource"</span>)</span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource.druid.slave"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">testDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  然后创建 SqlSessionFactory</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"db2SqlSessionFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">testSqlSessionFactory</span><span class="params">(@Qualifier(<span class="string">"db2DataSource"</span>)</span> DataSource dataSource) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean bean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dataSource);</span><br><span class="line">        bean.setMapperLocations(<span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath:mapper/*.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  再创建事务</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"db2TransactionManager"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">testTransactionManager</span><span class="params">(@Qualifier(<span class="string">"db2DataSource"</span>)</span> DataSource dataSource) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  最后包装到 SqlSessionTemplate 中</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"db2SqlSessionTemplate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionTemplate <span class="title">testSqlSessionTemplate</span><span class="params">(@Qualifier(<span class="string">"db2SqlSessionFactory"</span>)</span> SqlSessionFactory sqlSessionFactory) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相对于主库的配置，不同点有：</p>
<ol>
<li>方法上没有<code>@Primary</code>的注解，说明是从库，(如果需要扩展，按照次配置新增即可)；</li>
<li><code>@MapperScan(basePackages = &quot;***&quot;, sqlSessionTemplateRef  = &quot;***&quot;)</code>:指定主库扫描的 <code>mapper</code>包 不同；</li>
<li><code>@ConfigurationProperties(prefix = &quot;spring.datasource.druid.**&quot;)</code>：指定的数据源不同。</li>
</ol>
<h2 id="三、简单测试"><a href="#三、简单测试" class="headerlink" title="三、简单测试"></a>三、简单测试</h2><h3 id="3-1-业务层接口"><a href="#3-1-业务层接口" class="headerlink" title="3.1 业务层接口"></a>3.1 业务层接口</h3><blockquote>
<p>这里的接口方法比较简单，主要是两个：将数据插入主库和从库，完整代码见文末。</p>
</blockquote>
<ul>
<li><code>TestService.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 插入主库</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertMater</span><span class="params">(UserInfo userInfo)</span></span>;</span><br><span class="line">    <span class="comment">// 插入从库</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertSlave</span><span class="params">(UserInfo userInfo)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>TestServiceImpl.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServiceImpl</span> <span class="keyword">implements</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    User1Mapper user1Mapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    User2Mapper user2Mapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertMater</span><span class="params">(UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">        user1Mapper.insert(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertSlave</span><span class="params">(UserInfo userInfo)</span> </span>&#123;</span><br><span class="line">        user2Mapper.insert(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>mapper</code> 接口和映射文件<code>xml</code>很简单，这里就不放出来了。</p>
</blockquote>
<h3 id="3-2-单元测试"><a href="#3-2-单元测试" class="headerlink" title="3.2 单元测试"></a>3.2 单元测试</h3><ul>
<li>往主库（<code>master</code>） 新增数据</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertMater</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">    userInfo.setUserName(<span class="string">"master"</span>);</span><br><span class="line">    userInfo.setPassWord(<span class="string">"password"</span>);</span><br><span class="line">    userInfo.setUserSex(<span class="string">"男"</span>);</span><br><span class="line">    testService.insertMater(userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>往从库（<code>slave</code>） 新增数据</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertSlave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">    userInfo.setUserName(<span class="string">"slave"</span>);</span><br><span class="line">    userInfo.setPassWord(<span class="string">"password"</span>);</span><br><span class="line">    userInfo.setUserSex(<span class="string">"女"</span>);</span><br><span class="line">    testService.insertSlave(userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>经过测试，分别在在 <code>master</code> 库和 <code>slave</code> 库新增了不同的数据，证明我们的多数据源生效。</p>
</blockquote>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>如果你觉得：我只是想找一个简单的多数据支持而已，使用<code>AOP</code>配置多数据源有点小复杂，欢迎尝试该方式。</p>
<p><a href="https://github.com/vanDusty/Frame-Home/tree/master/mybatis-case/multipledata-simple" target="_blank" rel="noopener">Github 示例源码</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<p>参考文章：<a href="http://www.ityouknow.com/springboot/2016/11/25/spring-boot-multi-mybatis.html" target="_blank" rel="noopener">Spring Boot(七)：Mybatis 多数据源最简解决方案</a></p>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
        <tag>多数据源</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 整合 Alibaba Dubbo</title>
    <url>/2019/04/23/89fa83a3.html</url>
    <content><![CDATA[<p>该篇主要是 <code>Spring Boot</code> 整合 <code>Alibaba Dubbo</code>，最新的<code>Apache Dubbo</code>见另一篇。</p>
<a id="more"></a>

<h2 id="一、项目搭建"><a href="#一、项目搭建" class="headerlink" title="一、项目搭建"></a>一、项目搭建</h2><h3 id="1-1-新建主项目-dubbo"><a href="#1-1-新建主项目-dubbo" class="headerlink" title="1.1 新建主项目-dubbo"></a>1.1 新建主项目-<code>dubbo</code></h3><ul>
<li><code>pom.xml</code> 中放入整个项目都需要的依赖。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--在这里设置打包类型为pom，作用是为了实现多模块项目--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这里是我们子模块的设置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>dubbo-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>dubbo-provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>dubbo-consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 第一步：添加SpringBoot的parent --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 设置我们项目的一些版本属性 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.5.5<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">zkclient.version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">zkclient.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.4<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 声明一些项目依赖管理，方便我们的依赖版本管理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&amp;lt;!&amp;ndash; Springboot依赖 &amp;ndash;&amp;gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Springboot-web依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用lombok实现JavaBean的get、set、toString、hashCode、equals等方法的自动生成  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Dubbo依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;dubbo.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- zookeeper的客户端依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;zkclient.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-创建子模块-暴露服务接口项目dubbo-api"><a href="#1-2-创建子模块-暴露服务接口项目dubbo-api" class="headerlink" title="1.2 创建子模块-暴露服务接口项目dubbo-api"></a>1.2 创建子模块-暴露服务接口项目<code>dubbo-api</code></h3><ul>
<li><code>pom.xml</code> 暂时不包含特有依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-创建子模块-生产者项目dubbo-provider"><a href="#1-3-创建子模块-生产者项目dubbo-provider" class="headerlink" title="1.3 创建子模块-生产者项目dubbo-provider"></a>1.3 创建子模块-生产者项目<code>dubbo-provider</code></h3><ul>
<li><code>pom.xml</code> 暂时不包含特有依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-4-创建子模块-消费者项目dubbo-consumer"><a href="#1-4-创建子模块-消费者项目dubbo-consumer" class="headerlink" title="1.4 创建子模块-消费者项目dubbo-consumer"></a>1.4 创建子模块-消费者项目<code>dubbo-consumer</code></h3><ul>
<li><code>pom.xml</code> 暂时不包含特有依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.van<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="二、子项目：dubbo-api"><a href="#二、子项目：dubbo-api" class="headerlink" title="二、子项目：dubbo-api"></a>二、子项目：<code>dubbo-api</code></h2><h3 id="2-1-创建一个服务暴露实体类"><a href="#2-1-创建一个服务暴露实体类" class="headerlink" title="2.1 创建一个服务暴露实体类"></a>2.1 创建一个服务暴露实体类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> */</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDomain</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-创建需要dubbo暴露的接口"><a href="#2-2-创建需要dubbo暴露的接口" class="headerlink" title="2.2 创建需要dubbo暴露的接口"></a>2.2 创建需要<code>dubbo</code>暴露的接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DubboService</span> </span>&#123;</span><br><span class="line">    <span class="function">UserDomain <span class="title">findUser</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、子项目：dubbo-provider"><a href="#三、子项目：dubbo-provider" class="headerlink" title="三、子项目：dubbo-provider"></a>三、子项目：<code>dubbo-provider</code></h2><h3 id="3-1-首先实现我们在dubbo-api上定义的接口"><a href="#3-1-首先实现我们在dubbo-api上定义的接口" class="headerlink" title="3.1 首先实现我们在dubbo-api上定义的接口"></a>3.1 首先实现我们在<code>dubbo-api</code>上定义的接口</h3><p>创建一个<code>DubboServiceImpl</code>类并实现 <code>DubboService</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"dubboService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboServiceImpl</span> <span class="keyword">implements</span> <span class="title">DubboService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDomain <span class="title">findUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 模拟查询出一条数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        UserDomain userDomain = <span class="keyword">new</span> UserDomain();</span><br><span class="line">        userDomain.setId(<span class="number">1001</span>);</span><br><span class="line">        userDomain.setUsername(<span class="string">"scott"</span>);</span><br><span class="line">        userDomain.setPassword(<span class="string">"tiger"</span>);</span><br><span class="line">        userDomain.setAge(<span class="number">20</span>);</span><br><span class="line">        userDomain.setGender(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> userDomain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-dubbo提供者配置"><a href="#3-2-dubbo提供者配置" class="headerlink" title="3.2 dubbo提供者配置"></a>3.2 <code>dubbo</code>提供者配置</h3><p>在<code>resources</code>下创建一个<code>dubbo</code>文件夹，在<code>config</code>下创建<code>spring-dubbo.xml</code>配置文件。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"$&#123;dubbo.application.name&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注册中心的ip地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">"zookeeper"</span> <span class="attr">address</span>=<span class="string">"$&#123;dubbo.registry.address&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 协议/端口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"$&#123;dubbo.protocol.port&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 暴露的接口 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">ref</span>=<span class="string">"dubboService"</span> <span class="attr">interface</span>=<span class="string">"cn.van.dubbo.service.DubboService"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">timeout</span>=<span class="string">"3000"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意：需要在启动类上将该文件配置注入：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ImportResource</span>(&#123;<span class="string">"classpath:dubbo/spring-dubbo.xml"</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="3-3-application-yml配置"><a href="#3-3-application-yml配置" class="headerlink" title="3.3 application.yml配置"></a>3.3 <code>application.yml</code>配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># dubbo 相关配置</span><br><span class="line">dubbo:</span><br><span class="line">  application:</span><br><span class="line">    name: provider</span><br><span class="line">  registry:</span><br><span class="line">    address: 127.0.0.1:2181</span><br><span class="line">  protocol:</span><br><span class="line">    port: 20880</span><br></pre></td></tr></table></figure>

<h2 id="四、子项目：dubbo-consumer"><a href="#四、子项目：dubbo-consumer" class="headerlink" title="四、子项目：dubbo-consumer"></a>四、子项目：<code>dubbo-consumer</code></h2><h3 id="4-1-新建一个测试接口"><a href="#4-1-新建一个测试接口" class="headerlink" title="4.1 新建一个测试接口"></a>4.1 新建一个测试接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/consumer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DubboService dubboService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/getInfo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDomain <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dubboService.findUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-dubbo-消费者配置"><a href="#4-2-dubbo-消费者配置" class="headerlink" title="4.2 dubbo 消费者配置"></a>4.2 <code>dubbo</code> 消费者配置</h3><p>在<code>resources</code>下创建一个<code>dubbo</code>文件夹，在<code>config</code>下创建<code>spring-dubbo.xml</code>配置文件。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 应用名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"consumer"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注册中心的ip地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">protocol</span>=<span class="string">"zookeeper"</span> <span class="attr">address</span>=<span class="string">"$&#123;dubbo.registry.address&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 消费方用什么协议获取服务（用dubbo协议在20880端口暴露服务）--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"$&#123;dubbo.protocol.port&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 消费的服务 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"dubboService"</span> <span class="attr">interface</span>=<span class="string">"cn.van.dubbo.service.DubboService"</span> <span class="attr">check</span>=<span class="string">"false"</span> <span class="attr">timeout</span>=<span class="string">"5000"</span> <span class="attr">lazy</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意：需要在启动类上将该文件配置注入：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ImportResource</span>(&#123;<span class="string">"classpath:dubbo/spring-dubbo.xml"</span>&#125;)</span><br></pre></td></tr></table></figure>


<h3 id="4-3-application-yml配置"><a href="#4-3-application-yml配置" class="headerlink" title="4.3 application.yml配置"></a>4.3 <code>application.yml</code>配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  # 指定端口号</span><br><span class="line">  port: 8090</span><br><span class="line">  servlet:</span><br><span class="line">    # 指定项目地址</span><br><span class="line">    context-path: &#x2F;dubbo</span><br><span class="line"># dubbo 相关配置</span><br><span class="line">dubbo:</span><br><span class="line">  registry:</span><br><span class="line">    address: 127.0.0.1:2181</span><br><span class="line">  protocol:</span><br><span class="line">    port: 20880</span><br></pre></td></tr></table></figure>

<h2 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a>五、测试</h2><ol>
<li>启动<code>zookeeper</code>；</li>
<li>启动提供者项目<code>dubbo-provider</code></li>
<li>启动消费者项目<code>dubbo-consumer</code></li>
<li>测试，访问如下借口</li>
</ol>
<p><a href="http://localhost:8090/dubbo/consumer/getInfo" target="_blank" rel="noopener">http://localhost:8090/dubbo/consumer/getInfo</a></p>
<p>返回数据如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "id":1001,</span><br><span class="line">    "username":"scott",</span><br><span class="line">    "password":"tiger",</span><br><span class="line">    "age":20,</span><br><span class="line">    "gender":0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明消费者消费到提供者提供的服务。</p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-dubbo/alibaba-dubbo-demo" target="_blank" rel="noopener">Github 完整示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis 逆向工程自动生成代码</title>
    <url>/2019/04/01/113795ed.html</url>
    <content><![CDATA[<blockquote>
<p>本文主要介绍使用<code>Maven</code>插件的方式自动生成<code>Mybatis</code>相应的实体、<code>Mapper</code>、映射文件等，能应付简单的<code>CRUD</code>（<code>Create</code>/<code>Retrieve</code>/ <code>Update</code>/<code>Delete</code>）</p>
</blockquote>
<a id="more"></a>

<h2 id="一、上手使用"><a href="#一、上手使用" class="headerlink" title="一、上手使用"></a>一、上手使用</h2><h3 id="1-1-引入MyBatis-Generator的Maven插件"><a href="#1-1-引入MyBatis-Generator的Maven插件" class="headerlink" title="1.1 引入MyBatis Generator的Maven插件"></a>1.1 引入<code>MyBatis Generator</code>的<code>Maven</code>插件</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis自动生成代码插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 是否覆盖，true表示会替换生成的JAVA文件，false则不覆盖 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--mysql驱动包--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.45<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-2-数据库配置"><a href="#1-2-数据库配置" class="headerlink" title="1.2 数据库配置"></a>1.2 数据库配置</h3><blockquote>
<p>为了便于配置表及实体名称，我把<code>generatorConfig.xml</code>中的表名和实体名称放在这里了。</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">spring.datasource.url=jdbc:mysql://47.98.178.84:3306/root?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line"><span class="string">spring.datasource.username=root</span></span><br><span class="line"><span class="string">spring.datasource.password=password</span></span><br><span class="line"><span class="string">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="comment">#生成的实体类的包名</span></span><br><span class="line"><span class="string">projectPath=cn.van.mybatis.generator</span></span><br><span class="line"><span class="comment"># 数据库表名</span></span><br><span class="line"><span class="string">tableName=user_info_generator</span></span><br><span class="line"><span class="comment"># 实体名</span></span><br><span class="line"><span class="string">modelName=UserInfoGenerator</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-配置generatorConfig-xml"><a href="#1-3-配置generatorConfig-xml" class="headerlink" title="1.3 配置generatorConfig.xml"></a>1.3 配置<code>generatorConfig.xml</code></h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">generatorConfiguration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 导入配置文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"application.properties"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    context:生成一组对象的环境</span></span><br><span class="line"><span class="comment">    id:必选，上下文id，用于在生成错误时提示</span></span><br><span class="line"><span class="comment">    defaultModelType:指定生成对象的样式</span></span><br><span class="line"><span class="comment">        1，conditional：类似hierarchical；</span></span><br><span class="line"><span class="comment">        2，flat：所有内容（主键，blob）等全部生成在一个对象中；</span></span><br><span class="line"><span class="comment">        3，hierarchical：主键生成一个XXKey对象(key class)，Blob等单独生成一个对象，其他简单属性在一个对象中(record class)</span></span><br><span class="line"><span class="comment">    targetRuntime:</span></span><br><span class="line"><span class="comment">        1，MyBatis3：默认的值，生成基于MyBatis3.x以上版本的内容，包括XXXBySample；</span></span><br><span class="line"><span class="comment">        2，MyBatis3Simple：类似MyBatis3，只是不生成XXXBySample；</span></span><br><span class="line"><span class="comment">    introspectedColumnImpl：类全限定名，用于扩展MBG</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- defaultModelType="flat" 设置复合主键时不单独为主键创建实体 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"MySql"</span> <span class="attr">defaultModelType</span>=<span class="string">"flat"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3Simple"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 生成的POJO实现java.io.Serializable接口 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">"org.mybatis.generator.plugins.SerializablePlugin"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--注释--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 将数据库中表的字段描述信息添加到注释 --&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;property name="addRemarkComments" value="true"/&gt;--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 注释里不添加日期 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressDate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressAllComments"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据库连接，直接通过$&#123;&#125;读取application.properties里的配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbcConnection</span></span></span><br><span class="line"><span class="tag">                <span class="attr">driverClass</span>=<span class="string">"$&#123;spring.datasource.driver-class-name&#125;"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">connectionURL</span>=<span class="string">"$&#123;spring.datasource.url&#125;"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">userId</span>=<span class="string">"$&#123;spring.datasource.username&#125;"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">password</span>=<span class="string">"$&#123;spring.datasource.password&#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 非必需，类型处理器，在数据库类型和java类型之间的转换控制--&gt;</span><span class="comment">&lt;!--一般保持默认--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"forceBigDecimals"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 生成实体对象，并将类放到cn.van.generator.entity包下 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"cn.van.mybatis.generator.entity"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 是否允许子包，即targetPackage.schemaName.tableName --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 是否对model添加 构造函数 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"constructorBased"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 是否对类CHAR类型的列的数据进行trim操作 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"trimStrings"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 建立的Model对象是否 不可改变  即生成的Model对象不会有 setter方法，只有构造方法 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"immutable"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生成mapper xml文件，并放到resources下的mapper文件夹下 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"mapper"</span>  <span class="attr">targetProject</span>=<span class="string">"src/main/resources"</span>&gt;</span><span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生成mapper xml对应dao接口，放到cn.van.generator.mapper包下--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"cn.van.mybatis.generator.mapper"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span> <span class="attr">type</span>=<span class="string">"XMLMAPPER"</span>&gt;</span><span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 选择一个table来生成相关文件，可以有一个或多个table，必须要有table元素</span></span><br><span class="line"><span class="comment">            选择的table会生成一下文件：</span></span><br><span class="line"><span class="comment">            1，SQL map文件</span></span><br><span class="line"><span class="comment">            2，生成一个主键类；</span></span><br><span class="line"><span class="comment">            3，除了BLOB和主键的其他字段的类；</span></span><br><span class="line"><span class="comment">            4，包含BLOB的类；</span></span><br><span class="line"><span class="comment">            5，一个用户生成动态查询的条件类（selectByExample, deleteByExample），可选；</span></span><br><span class="line"><span class="comment">            6，Mapper接口（可选）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            tableName（必要）：要生成对象的表名；</span></span><br><span class="line"><span class="comment">            注意：大小写敏感问题。正常情况下，MBG会自动的去识别数据库标识符的大小写敏感度，在一般情况下，MBG会</span></span><br><span class="line"><span class="comment">                根据设置的schema，catalog或tablename去查询数据表，按照下面的流程：</span></span><br><span class="line"><span class="comment">                1，如果schema，catalog或tablename中有空格，那么设置的是什么格式，就精确的使用指定的大小写格式去查询；</span></span><br><span class="line"><span class="comment">                2，否则，如果数据库的标识符使用大写的，那么MBG自动把表名变成大写再查找；</span></span><br><span class="line"><span class="comment">                3，否则，如果数据库的标识符使用小写的，那么MBG自动把表名变成小写再查找；</span></span><br><span class="line"><span class="comment">                4，否则，使用指定的大小写格式查询；</span></span><br><span class="line"><span class="comment">            另外的，如果在创建表的时候，使用的""把数据库对象规定大小写，就算数据库标识符是使用的大写，在这种情况下也会使用给定的大小写来创建表名；</span></span><br><span class="line"><span class="comment">            这个时候，请设置delimitIdentifiers="true"即可保留大小写格式；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            可选：</span></span><br><span class="line"><span class="comment">            1，schema：数据库的schema；</span></span><br><span class="line"><span class="comment">            2，catalog：数据库的catalog；</span></span><br><span class="line"><span class="comment">            3，alias：为数据表设置的别名，如果设置了alias，那么生成的所有的SELECT SQL语句中，列名会变成：alias_actualColumnName</span></span><br><span class="line"><span class="comment">            4，domainObjectName：生成的domain类的名字，如果不设置，直接使用表名作为domain类的名字；可以设置为somepck.domainName，那么会自动把domainName类再放到somepck包里面；</span></span><br><span class="line"><span class="comment">            5，enableInsert（默认true）：指定是否生成insert语句；</span></span><br><span class="line"><span class="comment">            6，enableSelectByPrimaryKey（默认true）：指定是否生成按照主键查询对象的语句（就是getById或get）；</span></span><br><span class="line"><span class="comment">            7，enableSelectByExample（默认true）：MyBatis3Simple为false，指定是否生成动态查询语句；</span></span><br><span class="line"><span class="comment">            8，enableUpdateByPrimaryKey（默认true）：指定是否生成按照主键修改对象的语句（即update)；</span></span><br><span class="line"><span class="comment">            9，enableDeleteByPrimaryKey（默认true）：指定是否生成按照主键删除对象的语句（即delete）；</span></span><br><span class="line"><span class="comment">            10，enableDeleteByExample（默认true）：MyBatis3Simple为false，指定是否生成动态删除语句；</span></span><br><span class="line"><span class="comment">            11，enableCountByExample（默认true）：MyBatis3Simple为false，指定是否生成动态查询总条数语句（用于分页的总条数查询）；</span></span><br><span class="line"><span class="comment">            12，enableUpdateByExample（默认true）：MyBatis3Simple为false，指定是否生成动态修改语句（只修改对象中不为空的属性）；</span></span><br><span class="line"><span class="comment">            13，modelType：参考context元素的defaultModelType，相当于覆盖；</span></span><br><span class="line"><span class="comment">            14，delimitIdentifiers：参考tableName的解释，注意，默认的delimitIdentifiers是双引号，如果类似MYSQL这样的数据库，使用的是`（反引号，那么还需要设置context的beginningDelimiter和endingDelimiter属性）</span></span><br><span class="line"><span class="comment">            15，delimitAllColumns：设置是否所有生成的SQL中的列名都使用标识符引起来。默认为false，delimitIdentifiers参考context的属性</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            注意，table里面很多参数都是对javaModelGenerator，context等元素的默认属性的一个复写；</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- table标签可以有多个，至少一个，tableName指定表名，可以使用_和%通配符 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- domainObjectName/mapperName 可以自定义实体名称和Mapper名称 enable**:不生成复杂的sql --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"tbl_user"</span> <span class="attr">domainObjectName</span> = <span class="string">"UserDO"</span> <span class="attr">mapperName</span>=<span class="string">"UserMapper"</span>  <span class="attr">enableCountByExample</span>=<span class="string">"false"</span> <span class="attr">enableUpdateByExample</span>=<span class="string">"false"</span> <span class="attr">enableDeleteByExample</span>=<span class="string">"false"</span> <span class="attr">enableSelectByExample</span>=<span class="string">"false"</span> <span class="attr">selectByExampleQueryId</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 是否只生成entity对象 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"modelOnly"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 数据库中表名有时我们都会带个前缀，而实体又不想带前缀，这个配置可以把实体的前缀去掉 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">domainObjectRenamingRule</span> <span class="attr">searchString</span>=<span class="string">"^Tbl"</span> <span class="attr">replaceString</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="二、-自动生成代码"><a href="#二、-自动生成代码" class="headerlink" title="二、 自动生成代码"></a>二、 自动生成代码</h1><ul>
<li>利用 <code>idea</code> 插件：</li>
</ul>
<p><code>idea</code> - <code>Maven</code> - <code>Plugins</code> - <code>mybatis-generator</code> - <code>mybatis-generator-generate</code></p>
<ul>
<li>执行 <code>maven</code> 命令</li>
</ul>
<p><code>mvn mybatis-generator:generate</code></p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p><a href="https://github.com/vanDusty/Frame-Home/tree/master/mybatis-case/mybatis-generator" target="_blank" rel="noopener">Github 示例代码</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<p>参考文章：<a href="https://www.cnblogs.com/throwable/p/12046848.html" target="_blank" rel="noopener">Mybatis代码生成器Mybatis-Generator使用详解</a></p>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 配置 Redis</title>
    <url>/2019/03/25/25bbf14c.html</url>
    <content><![CDATA[<blockquote>
<p>作为目前最火的的<code>NoSql</code>数据库,<code>Redis</code>现在已成为后台开发人员的标配，本文主要主要介绍<code>SpringBoot 2.*</code>和 <code>Redis</code> 的整合。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、Spring-Data-Redis"><a href="#一、Spring-Data-Redis" class="headerlink" title="一、Spring Data Redis"></a>一、<code>Spring Data Redis</code></h2><blockquote>
<p>在 <code>Spring Boot</code> 中，默认集成的 <code>Redis</code> 是 <code>Spring Data Redis</code>，默认底层的连接池使用了 <code>lettuce</code> ，开发者可以自行修改为自己的熟悉的，例如 <code>Jedis</code>。</p>
</blockquote>
<p><code>Spring Data Redis</code> 针对 <code>Redis</code> 提供了非常方便的操作模板 <code>RedisTemplate</code>。</p>
<h3 id="1-1-RedisTemplate中定义了5种数据结构操作"><a href="#1-1-RedisTemplate中定义了5种数据结构操作" class="headerlink" title="1.1 RedisTemplate中定义了5种数据结构操作"></a>1.1 <code>RedisTemplate</code>中定义了<code>5</code>种数据结构操作</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">redisTemplate.opsForValue();　　<span class="comment">//操作字符串</span></span><br><span class="line">redisTemplate.opsForHash();　　 <span class="comment">//操作hash</span></span><br><span class="line">redisTemplate.opsForList();　　 <span class="comment">//操作list</span></span><br><span class="line">redisTemplate.opsForSet();　　  <span class="comment">//操作set</span></span><br><span class="line">redisTemplate.opsForZSet();　 　<span class="comment">//操作有序set</span></span><br></pre></td></tr></table></figure>

<p>当然，我们平时用的最多的可能是<code>StringRedisTemplate</code>，那这个<code>StringRedisTemplate</code>是何许人也？</p>
<h3 id="1-2-StringRedisTemplate与RedisTemplate"><a href="#1-2-StringRedisTemplate与RedisTemplate" class="headerlink" title="1.2 StringRedisTemplate与RedisTemplate"></a>1.2 <code>StringRedisTemplate</code>与<code>RedisTemplate</code></h3><ol>
<li><code>StringRedisTemplate</code>继承自<code>RedisTemplate</code>;</li>
<li><strong>两者的数据是不共通的</strong>：<code>StringRedisTemplate</code>只能管理<code>StringRedisTemplate</code>里面的数据，同样，<code>RedisTemplate</code>只能管理<code>RedisTemplate</code>中的数据；</li>
<li><code>RedisTemplate</code>中存取数据都是字节数组；<code>StringRedisTemplate</code>中存取数据都是字符串。</li>
</ol>
<h2 id="二、上手实战"><a href="#二、上手实战" class="headerlink" title="二、上手实战"></a>二、上手实战</h2><h3 id="2-1-导入依赖"><a href="#2-1-导入依赖" class="headerlink" title="2.1 导入依赖"></a>2.1 导入依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要手动引入 commos-pool2 的依赖，因为默认的连接池<code>lettuce</code>需要该依赖。</p>
</blockquote>
<h3 id="2-2-application-yml中redis参数配置"><a href="#2-2-application-yml中redis参数配置" class="headerlink" title="2.2 application.yml中redis参数配置"></a>2.2 <code>application.yml</code>中<code>redis</code>参数配置</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.98</span><span class="number">.178</span><span class="number">.84</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">60s</span>  <span class="comment"># 连接超时时间，2.0 中该参数的类型为Duration，这里在配置的时候需要指明单位</span></span><br><span class="line">    <span class="comment"># 连接池配置，2.0中直接使用jedis或者lettuce配置连接池（使用lettuce，依赖中必须包含commons-pool2包）</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="comment"># 最大空闲连接数</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">500</span></span><br><span class="line">        <span class="comment"># 最小空闲连接数</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment"># 等待可用连接的最大时间，负数为不限制</span></span><br><span class="line">        <span class="attr">max-wait:</span>  <span class="string">-1s</span></span><br><span class="line">        <span class="comment"># 最大活跃连接数，负数为不限制</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-Redis配置类-RedisConfig"><a href="#2-3-Redis配置类-RedisConfig" class="headerlink" title="2.3 Redis配置类-RedisConfig"></a>2.3 <code>Redis</code>配置类-<code>RedisConfig</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(RedisOperations<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableCaching</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 采用RedisCacheManager作为缓存管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> factory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 生成一个默认配置，通过config对象即可对缓存进行自定义配置</span></span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line">        <span class="comment">// 设置缓存的默认过期时间，也是使用Duration设置</span></span><br><span class="line">        config = config.entryTtl(Duration.ofMinutes(<span class="number">1</span>))</span><br><span class="line">                .disableCachingNullValues();     <span class="comment">// 不缓存空值</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置一个初始化的缓存空间set集合</span></span><br><span class="line">        Set&lt;String&gt; cacheNames =  <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        cacheNames.add(<span class="string">"my-redis-cache1"</span>);</span><br><span class="line">        cacheNames.add(<span class="string">"my-redis-cache2"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对每个缓存空间应用不同的配置</span></span><br><span class="line">        Map&lt;String, RedisCacheConfiguration&gt; configMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        configMap.put(<span class="string">"my-redis-cache1"</span>, config);</span><br><span class="line">        configMap.put(<span class="string">"my-redis-cache2"</span>, config.entryTtl(Duration.ofSeconds(<span class="number">120</span>)));</span><br><span class="line">        <span class="comment">// 使用自定义的缓存配置初始化一个cacheManager</span></span><br><span class="line">        RedisCacheManager cacheManager = RedisCacheManager.builder(factory)</span><br><span class="line">                <span class="comment">// 注意这两句的调用顺序，一定要先调用该方法设置初始化的缓存名，再初始化相关的配置</span></span><br><span class="line">                .initialCacheNames(cacheNames)</span><br><span class="line">                .withInitialCacheConfigurations(configMap)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@ConditionalOnClass(RedisOperations.class)</code>表示：该配置在 <code>RedisOperations</code> 存在的情况下才会生效(即项目中引入了 <code>Spring Data Redis</code>)</p>
</blockquote>
<h3 id="2-4-测试类"><a href="#2-4-测试类" class="headerlink" title="2.4 测试类"></a>2.4 测试类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">StringCacheTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(StringCacheTest<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试 StringRedisTemplate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stringRedisTemplateTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">"name"</span>,<span class="string">"redis测试"</span>);</span><br><span class="line">        String name = stringRedisTemplate.opsForValue().get(<span class="string">"name"</span>);</span><br><span class="line">        logger.info(name);</span><br><span class="line">        stringRedisTemplate.delete(<span class="string">"name"</span>);</span><br><span class="line">        name = stringRedisTemplate.opsForValue().get(<span class="string">"name"</span>);</span><br><span class="line">        logger.info(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试 RedisTemplate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">redisTemplateTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">"name"</span>,<span class="string">"redis测试"</span>);</span><br><span class="line">        String name = (String) redisTemplate.opsForValue().get(<span class="string">"name"</span>);</span><br><span class="line">        logger.info(name);</span><br><span class="line">        redisTemplate.delete(<span class="string">"name"</span>);</span><br><span class="line">        name = (String) redisTemplate.opsForValue().get(<span class="string">"name"</span>);</span><br><span class="line">        logger.info(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><h3 id="3-1-Redis-可视化客户端-rdm"><a href="#3-1-Redis-可视化客户端-rdm" class="headerlink" title="3.1 Redis 可视化客户端  rdm"></a>3.1 <code>Redis</code> 可视化客户端  <code>rdm</code></h3><blockquote>
<p>通常情况下，我们可以在命令行下查看 <code>Redis</code> 数据库，但是可视化工具能更真实地让我们看到数据的结构。</p>
</blockquote>
<p>这里分享我用的一个<code>Mac</code>版的客户端，打开<a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-redis/file/redis-desktop-manager-0.8.3-2550.dmg" target="_blank" rel="noopener">链接</a>，点击 <strong>Download</strong> 即可下载。</p>
<h3 id="3-2-示例源码"><a href="#3-2-示例源码" class="headerlink" title="3.2 示例源码"></a>3.2 示例源码</h3><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-redis/redis-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 统一格式返回-全局异常处理</title>
    <url>/2019/03/23/88181d97.html</url>
    <content><![CDATA[<h2 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h2><p>在分布式、微服务盛行的今天，绝大部分项目都采用的微服务框架，前后端分离方式。前端和后端进行交互，前端按照约定请求<code>URL</code>路径，并传入相关参数，后端服务器接收请求，进行业务处理，返回数据给前端。</p>
<p>所以统一接口的返回值，保证接口返回值的幂等性很重要，本文主要介绍博主当前使用的结果集。</p>
<a id="more"></a>

<h2 id="二、统一格式设计"><a href="#二、统一格式设计" class="headerlink" title="二、统一格式设计"></a>二、统一格式设计</h2><h3 id="2-1-统一结果的一般形式"><a href="#2-1-统一结果的一般形式" class="headerlink" title="2.1 统一结果的一般形式"></a>2.1 统一结果的一般形式</h3><ul>
<li>示例：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	# 是否响应成功</span><br><span class="line">	success: true,</span><br><span class="line">	# 响应状态码</span><br><span class="line">	code: 200,		</span><br><span class="line">	# 响应数据</span><br><span class="line">	data: Object</span><br><span class="line">	# 返回错误信息</span><br><span class="line">	message: "",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-结果类枚举"><a href="#2-2-结果类枚举" class="headerlink" title="2.2 结果类枚举"></a>2.2 结果类枚举</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ResultCodeEnum &#123;</span><br><span class="line">    <span class="comment">/*** 通用部分 100 - 599***/</span></span><br><span class="line">    <span class="comment">// 成功请求</span></span><br><span class="line">    SUCCESS(<span class="number">200</span>, <span class="string">"successful"</span>),</span><br><span class="line">    <span class="comment">// 重定向</span></span><br><span class="line">    REDIRECT(<span class="number">301</span>, <span class="string">"redirect"</span>),</span><br><span class="line">    <span class="comment">// 资源未找到</span></span><br><span class="line">    NOT_FOUND(<span class="number">404</span>, <span class="string">"not found"</span>),</span><br><span class="line">    <span class="comment">// 服务器错误</span></span><br><span class="line">    SERVER_ERROR(<span class="number">500</span>,<span class="string">"server error"</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*** 这里可以根据不同模块用不同的区级分开错误码，例如:  ***/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1000～1999 区间表示用户模块错误</span></span><br><span class="line">    <span class="comment">// 2000～2999 区间表示订单模块错误</span></span><br><span class="line">    <span class="comment">// 3000～3999 区间表示商品模块错误</span></span><br><span class="line">    <span class="comment">// 。。。</span></span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultCodeEnum(Integer code, String msg) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>code</code>：响应状态码</li>
</ul>
<p>一般小伙伴们是在开发的时候需要什么，就添加什么。<strong>但是</strong>，为了规范，我们应当参考<code>HTTP</code>请求返回的状态码。</p>
<table>
<thead>
<tr>
<th></th>
<th>code区间</th>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1**</td>
<td>100-199</td>
<td>信息</td>
<td>服务器接收到请求，需要请求者继续执行操作</td>
</tr>
<tr>
<td>2**</td>
<td>200-299</td>
<td>成功</td>
<td>请求被成功接收并处理</td>
</tr>
<tr>
<td>3**</td>
<td>300-399</td>
<td>重定向</td>
<td>需要进一步的操作以完成请求</td>
</tr>
<tr>
<td>4**</td>
<td>400-499</td>
<td>客户端错误</td>
<td>请求包含语法错误或无法完成请求</td>
</tr>
<tr>
<td>5**</td>
<td>500-599</td>
<td>服务器错误</td>
<td>服务器在处理的时候发生错误</td>
</tr>
</tbody></table>
<p>常见的<code>HTTP</code>状态码：</p>
<ol>
<li><code>200</code> - 请求成功；</li>
<li><code>301</code> - 资源（网页等）被永久转移到其它<code>URL</code>；</li>
<li><code>404</code> - 请求的资源（网页等）不存在；</li>
<li><code>500</code> - 内部服务器错误。</li>
</ol>
<ul>
<li><code>message</code>：错误信息</li>
</ul>
<p>在发生错误时，如何友好的进行提示？</p>
<ol>
<li>根据<code>code</code> 给予对应的错误码定位；</li>
<li>把错误描述记录到<code>message</code>中，便于接口调用者更详细的了解错误。</li>
</ol>
<h3 id="2-3-统一结果类"><a href="#2-3-统一结果类" class="headerlink" title="2.3 统一结果类"></a>2.3 统一结果类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpResult</span> &lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否响应成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应状态码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器开始</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无参构造器(构造器私有，外部不可以直接创建)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = <span class="number">200</span>;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有参构造器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpResult</span><span class="params">(T obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = <span class="number">200</span>;</span><br><span class="line">        <span class="keyword">this</span>.data = obj;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有参构造器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultCode</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HttpResult</span><span class="params">(ResultCodeEnum resultCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.code = resultCode.getCode();</span><br><span class="line">        <span class="keyword">this</span>.message = resultCode.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构造器结束</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用返回成功（没有返回结果）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; HttpResult&lt;T&gt; <span class="title">success</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpResult();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回成功（有返回结果）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; HttpResult&lt;T&gt; <span class="title">success</span><span class="params">(T data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HttpResult&lt;T&gt;(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用返回失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> resultCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span>&lt;T&gt; HttpResult&lt;T&gt; <span class="title">failure</span><span class="params">(ResultCodeEnum resultCode)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> HttpResult&lt;T&gt;(resultCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">getSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccess</span><span class="params">(Boolean success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(Integer code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"HttpResult&#123;"</span> +</span><br><span class="line">                <span class="string">"success="</span> + success +</span><br><span class="line">                <span class="string">", code="</span> + code +</span><br><span class="line">                <span class="string">", data="</span> + data +</span><br><span class="line">                <span class="string">", message='"</span> + message + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>说明：</strong></p>
<ol>
<li>构造器私有，外部不可以直接创建；</li>
<li>只可以调用统一返回类的静态方法返回对象；</li>
<li><code>success</code> 是一个<code>Boolean</code> 值，通过这个值，可以直接观察到该次请求是否成功；</li>
<li><code>data</code> 表示响应数据，用于请求成功后，返回客户端需要的数据。</li>
</ol>
<h2 id="三、测试及总结"><a href="#三、测试及总结" class="headerlink" title="三、测试及总结"></a>三、测试及总结</h2><h3 id="3-1-简单的接口测试"><a href="#3-1-简单的接口测试" class="headerlink" title="3.1 简单的接口测试"></a>3.1 简单的接口测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/httpRest"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"统一结果测试"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpRestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"通用返回成功（没有返回结果）"</span>, httpMethod = <span class="string">"GET"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/success"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">success</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"返回成功（有返回结果）"</span>, httpMethod = <span class="string">"GET"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/successWithData"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">successWithData</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success(<span class="string">"风尘博客"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"通用返回失败"</span>, httpMethod = <span class="string">"GET"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/failure"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">failure</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.failure(ResultCodeEnum.NOT_FOUND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里 <code>Swagger</code>以及<code>SpringMVC</code>的配置就没贴出来了，详见Github 示例代码。</p>
</blockquote>
<h3 id="3-2-返回结果"><a href="#3-2-返回结果" class="headerlink" title="3.2 返回结果"></a>3.2 返回结果</h3><p><a href="http://localhost:8080/swagger-ui.html#/" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html#/</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "code": 200,</span><br><span class="line">  "success": true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "code": 200,</span><br><span class="line">  "data": "风尘博客",</span><br><span class="line">  "success": true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "code": 404,</span><br><span class="line">  "message": "not found",</span><br><span class="line">  "success": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="四、全局异常处理"><a href="#四、全局异常处理" class="headerlink" title="四、全局异常处理"></a>四、全局异常处理</h2><blockquote>
<p>使用统一返回结果时，还有一种情况，就是程序的报错是由于运行时异常导致的结果，有些异常是我们在业务中抛出的，有些是无法提前预知。</p>
</blockquote>
<p>因此，我们需要定义一个统一的全局异常，在<code>Controller</code>捕获所有异常，并且做适当处理，并作为一种结果返回。</p>
<h3 id="4-1-设计思路："><a href="#4-1-设计思路：" class="headerlink" title="4.1 设计思路："></a>4.1 设计思路：</h3><ol>
<li>自定一个异常类（如：<code>TokenVerificationException</code>），捕获针对项目或业务的异常;</li>
<li>使用<code>@ExceptionHandler</code>注解捕获自定义异常和通用异常；</li>
<li>使用<code>@ControllerAdvice</code>集成<code>@ExceptionHandler</code>的方法到一个类中；</li>
<li>异常的对象信息补充到统一结果枚举中；</li>
</ol>
<h3 id="4-2-自定义异常"><a href="#4-2-自定义异常" class="headerlink" title="4.2 自定义异常"></a>4.2 自定义异常</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenVerificationException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 有参构造器，返回码在枚举类中，这里可以指定错误信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TokenVerificationException</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-统一异常处理器"><a href="#4-3-统一异常处理器" class="headerlink" title="4.3 统一异常处理器"></a>4.3 统一异常处理器</h3><p><code>@ControllerAdvice</code>注解是一种作用于控制层的切面通知（<code>Advice</code>），能够将通用的<code>@ExceptionHandler</code>、<code>@InitBinder</code>和<code>@ModelAttributes</code>方法收集到一个类型，并应用到所有控制器上。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常捕获</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e 捕获的异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 封装的返回对象</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">HttpResult</span> <span class="title">handlerException</span>(<span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        ResultCodeEnum resultCodeEnum;</span><br><span class="line">        <span class="comment">// 自定义异常</span></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TokenVerificationException) &#123;</span><br><span class="line">            resultCodeEnum = ResultCodeEnum.TOKEN_VERIFICATION_ERROR;</span><br><span class="line">            resultCodeEnum.setMessage(getConstraintViolationErrMsg(e));</span><br><span class="line">            log.error(<span class="string">"tokenVerificationException：&#123;&#125;"</span>, resultCodeEnum.getMessage());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 其他异常，当我们定义了多个异常时，这里可以增加判断和记录</span></span><br><span class="line">            resultCodeEnum = ResultCodeEnum.SERVER_ERROR;</span><br><span class="line">            resultCodeEnum.setMessage(e.getMessage());</span><br><span class="line">            log.error(<span class="string">"common exception:&#123;&#125;"</span>, JSON.toJSONString(e));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> HttpResult.failure(resultCodeEnum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取错误信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getConstraintViolationErrMsg</span><span class="params">(Exception ex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// validTest1.id: id必须为正数</span></span><br><span class="line">        <span class="comment">// validTest1.id: id必须为正数, validTest1.name: 长度必须在有效范围内</span></span><br><span class="line">        String message = ex.getMessage();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> startIdx = message.indexOf(<span class="string">": "</span>);</span><br><span class="line">            <span class="keyword">if</span> (startIdx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                startIdx = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> endIdx = message.indexOf(<span class="string">", "</span>);</span><br><span class="line">            <span class="keyword">if</span> (endIdx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                endIdx = message.length();</span><br><span class="line">            &#125;</span><br><span class="line">            message = message.substring(startIdx, endIdx);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            log.info(<span class="string">"ex caught"</span>, throwable);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>说明</li>
</ul>
<ol>
<li>我使用的是<code>@RestControllerAdvice</code> ，等同于<code>@ControllerAdvice</code> + <code>@ResponseBody</code></li>
<li>错误枚举类这里省略了，详见<a href="https://github.com/vanDusty/SpringBoot-Home/blob/master/springboot-demo-restful/rest-api/src/main/java/cn/van/restful/enunm/ResultCodeEnum.java" target="_blank" rel="noopener">Github代码</a>。</li>
</ol>
<h2 id="五、测试及总结"><a href="#五、测试及总结" class="headerlink" title="五、测试及总结"></a>五、测试及总结</h2><h3 id="5-1-测试接口"><a href="#5-1-测试接口" class="headerlink" title="5.1 测试接口"></a>5.1 测试接口</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/exception"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"异常测试接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionRestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"业务异常(token 异常)"</span>, httpMethod = <span class="string">"GET"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/token"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">token</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 模拟业务层抛出 token 异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TokenVerificationException(<span class="string">"token 已经过期"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"其他异常"</span>, httpMethod = <span class="string">"GET"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/errorException"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpResult <span class="title">errorException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//这里故意造成一个其他异常，并且不进行处理</span></span><br><span class="line">        Integer.parseInt(<span class="string">"abc123"</span>);</span><br><span class="line">        <span class="keyword">return</span> HttpResult.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="5-2-返回结果"><a href="#5-2-返回结果" class="headerlink" title="5.2 返回结果"></a>5.2 返回结果</h3><p><a href="http://localhost:8080/swagger-ui.html#/" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html#/</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "code": 500,</span><br><span class="line">  "message": "For input string: \"abc123\"",</span><br><span class="line">  "success": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "code": 4000,</span><br><span class="line">  "message": "token 已经过期",</span><br><span class="line">  "success": false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-小结"><a href="#5-3-小结" class="headerlink" title="5.3 小结"></a>5.3 小结</h3><p><code>@RestControllerAdvice</code>和<code>@ExceptionHandler</code>会捕获所有<code>Rest</code>接口的异常并封装成我们定义的<code>HttpResult</code>的结果集返回，但是：<strong>处理不了拦截器里的异常</strong></p>
<h3 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h3><p>没有哪一种方案是适用于各种情况的，如：分页情况，还可以增加返回分页结果的静态方案，具体实现，这里就不展示了。所以，适合自己的，具有一定可读性都是很好的，欢迎持不同意见的大佬给出意见建议。</p>
<h3 id="6-1-示例代码"><a href="#6-1-示例代码" class="headerlink" title="6.1 示例代码"></a>6.1 示例代码</h3><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-restful/rest-api" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>RestFul</tag>
        <tag>异常</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 实现定时任务</title>
    <url>/2019/03/09/e04b0a96.html</url>
    <content><![CDATA[<h2 id="一、定时任务实现的几种方式："><a href="#一、定时任务实现的几种方式：" class="headerlink" title="一、定时任务实现的几种方式："></a>一、定时任务实现的几种方式：</h2><ul>
<li><p><code>Timer</code></p>
<p>  这是<code>java</code>自带的<code>java.util.Timer</code>类，这个类允许你调度一个<code>java.util.TimerTask</code>任务。使用这种方式可以让你的程序按照某一个频度执行，但不能在指定时间运行。一般用的较少。</p>
</li>
<li><p><code>ScheduledExecutorService</code></p>
<p>  也<code>jdk</code>自带的一个类；是基于线程池设计的定时任务类,每个调度任务都会分配到线程池中的一个线程去执行,也就是说,任务是并发执行,互不影响。</p>
</li>
<li><p><code>Spring Task</code></p>
<p>  <code>Spring3.0</code>以后自带的<code>task</code>，可以将它看成一个轻量级的<code>Quartz</code>，而且使用起来比<code>Quartz</code>简单许多。</p>
</li>
<li><p><code>Quartz</code></p>
<p>  这是一个功能比较强大的的调度器，可以让你的程序在指定时间执行，也可以按照某一个频度执行，配置起来稍显复杂。</p>
</li>
</ul>
<a id="more"></a>

<h2 id="二、基于Spring-Boot的定时任务"><a href="#二、基于Spring-Boot的定时任务" class="headerlink" title="二、基于Spring Boot的定时任务"></a>二、基于<code>Spring Boot</code>的定时任务</h2><blockquote>
<p>使用<code>Spring Boot</code> 自带的定时任务，只需要添加相应的注解就可以实现。</p>
</blockquote>
<h3 id="2-1-导包"><a href="#2-1-导包" class="headerlink" title="2.1 导包"></a>2.1 导包</h3><blockquote>
<p>仅需<code>Spring Boot</code> 依赖包即可</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-启动类启用定时"><a href="#2-2-启动类启用定时" class="headerlink" title="2.2 启动类启用定时"></a>2.2 启动类启用定时</h3><p>在启动类上面加上<code>@EnableScheduling</code>即可开启定时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableScheduling</span> <span class="comment">// 开启定时</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootDemoTimeTaskApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(SpringBootDemoTimeTaskApplication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootDemoTimeTaskApplication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        logger.info(<span class="string">"SpringBootDemoTimeTaskApplication start!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-定时任务实现类SchedulerTask"><a href="#2-3-定时任务实现类SchedulerTask" class="headerlink" title="2.3 定时任务实现类SchedulerTask"></a>2.3 定时任务实现类<code>SchedulerTask</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerTask</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(SchedulerTask<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scheduled</span>(fixedRate = 6000) ：上一次开始执行时间点之后6秒再执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scheduled</span>(fixedDelay = 6000) ：上一次执行完毕时间点之后6秒再执行</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scheduled</span>(initialDelay=1000, fixedRate=6000) ：第一次延迟1秒后执行，之后按fixedRate的规则每6秒执行一次</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scheduled</span>(cron=""):详见cron表达式http://www.pppet.net/</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedRate = <span class="number">5000</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduled1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"=====&gt;&gt;&gt;&gt;&gt;使用fixedRate执行定时任务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedDelay = <span class="number">10000</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduled2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"=====&gt;&gt;&gt;&gt;&gt;使用fixedDelay执行定时任务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron=<span class="string">"*/6 * * * * ?"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduled3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">"使用cron执行定时任务"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2019-03-09 17:33:05.681  INFO 7752 --- [           main] c.v.t.SpringBootDemoTimeTaskApplication  : SpringBootDemoTimeTaskApplication start!</span><br><span class="line">2019-03-09 17:33:06.002  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : 使用cron执行定时任务</span><br><span class="line">2019-03-09 17:33:10.680  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedRate执行定时任务</span><br><span class="line">2019-03-09 17:33:12.003  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : 使用cron执行定时任务</span><br><span class="line">2019-03-09 17:33:15.676  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedRate执行定时任务</span><br><span class="line">2019-03-09 17:33:15.676  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedDelay执行定时任务</span><br><span class="line">2019-03-09 17:33:18.002  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : 使用cron执行定时任务</span><br><span class="line">2019-03-09 17:33:20.677  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedRate执行定时任务</span><br><span class="line">2019-03-09 17:33:24.002  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : 使用cron执行定时任务</span><br><span class="line">2019-03-09 17:33:25.680  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedRate执行定时任务</span><br><span class="line">2019-03-09 17:33:25.681  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedDelay执行定时任务</span><br><span class="line">2019-03-09 17:33:30.005  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : 使用cron执行定时任务</span><br><span class="line">2019-03-09 17:33:30.680  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedRate执行定时任务</span><br><span class="line">2019-03-09 17:33:35.680  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedRate执行定时任务</span><br><span class="line">2019-03-09 17:33:35.682  INFO 7752 --- [   scheduling-1] cn.van.task.service.SchedulerTask        : &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;&gt;&gt;&gt;&gt;使用fixedDelay执行定时任务</span><br></pre></td></tr></table></figure>

<h3 id="2-4-执行时间的配置"><a href="#2-4-执行时间的配置" class="headerlink" title="2.4 执行时间的配置"></a>2.4 执行时间的配置</h3><p>在上面的定时任务中，我们在方法上使用<code>@Scheduled</code>注解来设置任务的执行时间，并且使用三种属性配置方式：</p>
<ol>
<li><code>fixedRate</code>：定义一个按一定频率执行的定时任务</li>
<li><code>fixedDelay</code>：定义一个按一定频率执行的定时任务，与上面不同的是，改属性可以配合initialDelay， 定义该任务延迟执行时间。</li>
<li><code>cron</code>：通过表达式来配置任务执行时间–<a href="http://cron.qqe2.com/" target="_blank" rel="noopener">在线cron表达式生成器</a></li>
</ol>
<h2 id="三、多线程执行定时任务"><a href="#三、多线程执行定时任务" class="headerlink" title="三、多线程执行定时任务"></a>三、多线程执行定时任务</h2><blockquote>
<p><code>Spring Boot</code>定时任务默认单线程，可以看到三个定时任务都已经执行，并且使同一个线程中(<code>scheduling-1</code>)串行执行，如果只有一个定时任务，这样做肯定没问题，当定时任务增多，<strong>如果一个任务卡死，会导致其他任务也无法执行</strong>。</p>
</blockquote>
<h3 id="3-1-多线程配置类-AsyncConfig-class"><a href="#3-1-多线程配置类-AsyncConfig-class" class="headerlink" title="3.1 多线程配置类 AsyncConfig.class"></a>3.1 多线程配置类 <code>AsyncConfig.class</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> <span class="comment">// 表明该类是一个配置类</span></span><br><span class="line"><span class="meta">@EnableAsync</span> <span class="comment">// 开启异步事件的支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;myProps.corePoolSize&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> corePoolSize;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;myProps.maxPoolSize&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxPoolSize;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;myProps.queueCapacity&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> queueCapacity;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">taskExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        executor.setCorePoolSize(corePoolSize);</span><br><span class="line">        executor.setMaxPoolSize(maxPoolSize);</span><br><span class="line">        executor.setQueueCapacity(queueCapacity);</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-配置文件application-yml中添加多线程配置"><a href="#3-2-配置文件application-yml中添加多线程配置" class="headerlink" title="3.2 配置文件application.yml中添加多线程配置"></a>3.2 配置文件<code>application.yml</code>中添加多线程配置</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">myProps:</span></span><br><span class="line">  <span class="attr">corePoolSize:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">maxPoolSize:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">queueCapacity:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h3 id="3-3-在定时任务的类或者方法上添加-Async"><a href="#3-3-在定时任务的类或者方法上添加-Async" class="headerlink" title="3.3 在定时任务的类或者方法上添加@Async"></a>3.3 在定时任务的类或者方法上添加<code>@Async</code></h3><blockquote>
<p>此时，可让每一个任务都是在不同的线程中，启动项目，日志打印如下：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">16</span>:<span class="number">54.855</span>  INFO <span class="number">10782</span> --- [           main] c.v.t.SpringBootDemoTimeTaskApplication  : SpringBootDemoTimeTaskApplication start!</span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">16</span>:<span class="number">55.015</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">1</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">00.002</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">2</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">2</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">00.002</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">3</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">05.003</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">4</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">06.005</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">5</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">2</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">10.004</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">6</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">12.005</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">7</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">2</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">15.006</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">8</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">18.004</span>  INFO <span class="number">10782</span> --- [ taskExecutor-<span class="number">9</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">2</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">11</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">20.004</span>  INFO <span class="number">10782</span> --- [taskExecutor-<span class="number">10</span>] cn.van.task.service.SchedulerTask        : =====&gt;&gt;&gt;&gt;&gt;使用cron执行定时任务-<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>日志打印证明了我的预测，至此，多线程中执行定时任务完毕！</p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-list/task-demo" target="_blank" rel="noopener">Github 示例源码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>定时任务</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis 整合 Druid 监控</title>
    <url>/2019/02/24/af5103d3.html</url>
    <content><![CDATA[<blockquote>
<p><code>Druid</code>是什么?</p>
<ol>
<li><code>Druid</code>是一个<code>JDBC</code>组件库，包括数据库连接池、<code>SQL Parser</code>等组件;</li>
<li><code>DruidDataSource</code>是最好的数据库连接池;</li>
<li><code>Druid</code>能够提供强大的监控(可视化)和扩展功能。</li>
</ol>
</blockquote>
<a id="more"></a>

<h2 id="一、初始化项目"><a href="#一、初始化项目" class="headerlink" title="一、初始化项目"></a>一、初始化项目</h2><h3 id="1-1-sql"><a href="#1-1-sql" class="headerlink" title="1.1 sql"></a>1.1 <code>sql</code></h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_info_druid`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_info_druid`</span> (</span><br><span class="line">                           <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span> <span class="keyword">COMMENT</span> <span class="string">'自增主键'</span>,</span><br><span class="line">                           <span class="string">`user_name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户名'</span>,</span><br><span class="line">                           <span class="string">`user_age`</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'用户年龄'</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span> <span class="string">'mybatis-druid'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_druid`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'张三'</span>, <span class="number">27</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_druid`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'李四'</span>, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_info_druid`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">'王五'</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1-2-pom-xml"><a href="#1-2-pom-xml" class="headerlink" title="1.2 pom.xml"></a>1.2 <code>pom.xml</code></h3><blockquote>
<p>引入<code>Swagger</code>相关包是为了方便测试。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- druid连接池--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>1.8.4<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Swagger-ui配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h3 id="1-3-application-yml"><a href="#1-3-application-yml" class="headerlink" title="1.3 application.yml"></a>1.3 <code>application.yml</code></h3><blockquote>
<p>这里需要注意的是最下面是我们<code>druid</code>管理账户及密码。</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://47.98.178.84:3306/van_mybatis</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">username</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用druid数据源</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="comment"># 配置获取连接等待超时的时间</span></span><br><span class="line">    <span class="comment"># 下面为连接池的补充设置，应用到上面所有数据源中</span></span><br><span class="line">    <span class="comment"># 初始化大小，最小，最大</span></span><br><span class="line">    <span class="attr">initialSize:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># 配置获取连接等待超时的时间</span></span><br><span class="line">    <span class="attr">maxWait:</span> <span class="number">60000</span></span><br><span class="line">    <span class="comment"># 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span></span><br><span class="line">    <span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">60000</span></span><br><span class="line">    <span class="comment"># 配置一个连接在池中最小生存的时间，单位是毫秒</span></span><br><span class="line">    <span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">30000</span></span><br><span class="line">    <span class="attr">validationQuery:</span> <span class="string">select</span> <span class="string">'x'</span></span><br><span class="line">    <span class="attr">testWhileIdle:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">testOnBorrow:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">testOnReturn:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 打开PSCache，并且指定每个连接上PSCache的大小</span></span><br><span class="line">    <span class="attr">poolPreparedStatements:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">maxPoolPreparedStatementPerConnectionSize:</span> <span class="number">20</span></span><br><span class="line">    <span class="comment"># 配置监控统计拦截的filters，去掉后监控界面sql无法统计，'wall'用于防火墙</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">stat,wall,slf4j</span></span><br><span class="line">    <span class="comment"># 通过connectProperties属性来打开mergeSql功能；慢SQL记录</span></span><br><span class="line">    <span class="attr">connectionProperties:</span> <span class="string">druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000</span></span><br><span class="line">    <span class="comment"># 合并多个DruidDataSource的监控数据</span></span><br><span class="line">    <span class="attr">useGlobalDataSourceStat:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mybatis</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">cn.van.mybatis.druid.entity</span></span><br><span class="line"><span class="comment"># mybatis log</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">cn:</span></span><br><span class="line">      <span class="attr">van:</span></span><br><span class="line">        <span class="attr">mybatis:</span></span><br><span class="line">          <span class="attr">druid:</span></span><br><span class="line">            <span class="attr">mapper:</span> <span class="string">debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># druid 相关配置放这里</span></span><br><span class="line"><span class="attr">druid:</span> </span><br><span class="line">  <span class="comment"># 管理用户账号</span></span><br><span class="line">  <span class="attr">login:</span> </span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<h2 id="二、Druid-配置"><a href="#二、Druid-配置" class="headerlink" title="二、Druid 配置"></a>二、<code>Druid</code> 配置</h2><blockquote>
<p><code>UserInfoDruidDO.java</code>、<code>UserInfoDruidMapper.java</code>、<code>UserInfoDruidMapper.xml</code>省略了，详见<a href="https://github.com/vanDusty/mybatis-Home/tree/master/mybatis-case/mybatis-druid" target="_blank" rel="noopener">mybatis-druid</a></p>
</blockquote>
<h3 id="2-1-DruidConfig-java"><a href="#2-1-DruidConfig-java" class="headerlink" title="2.1 DruidConfig.java"></a>2.1 <code>DruidConfig.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DruidConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;druid.login.username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;druid.login.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_PREFIX = <span class="string">"spring.datasource"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  主要实现WEB监控的配置处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">druidServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"enter DruidConfig ............"</span>);</span><br><span class="line">        ServletRegistrationBean servletRegistrationBean = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> StatViewServlet(), <span class="string">"/druid/*"</span>);</span><br><span class="line">        servletRegistrationBean.addUrlMappings(<span class="string">"/druid/*"</span>);</span><br><span class="line">        <span class="comment">// IP白名单，多个用逗号分割， 如果allow没有配置或者为空，则允许所有访问</span></span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">"allow"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line">        <span class="comment">// IP黑名单(共同存在时，deny优先于allow)</span></span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">"deny"</span>, <span class="string">"192.168.1.100"</span>);</span><br><span class="line">        <span class="comment">//控制台管理用户</span></span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">"loginUsername"</span>, username);</span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">"loginPassword"</span>, password);</span><br><span class="line">        <span class="comment">//是否能够重置数据 禁用HTML页面上的“Reset All”功能</span></span><br><span class="line">        servletRegistrationBean.addInitParameter(<span class="string">"resetEnable"</span>, <span class="string">"false"</span>);</span><br><span class="line">        <span class="keyword">return</span> servletRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">filterRegistrationBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> FilterRegistrationBean(<span class="keyword">new</span> WebStatFilter());</span><br><span class="line">        <span class="comment">//所有请求进行监控处理</span></span><br><span class="line">        filterRegistrationBean.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        <span class="comment">//添加不需要忽略的格式信息</span></span><br><span class="line">        filterRegistrationBean.addInitParameter(<span class="string">"exclusions"</span>, <span class="string">"*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"</span>);</span><br><span class="line">        <span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入yml中配置的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = DB_PREFIX)</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">IDataSourceProperties</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line">        <span class="keyword">private</span> String username;</span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">        <span class="keyword">private</span> String driverClassName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> initialSize;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> minIdle;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxActive;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxWait;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> timeBetweenEvictionRunsMillis;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> minEvictableIdleTimeMillis;</span><br><span class="line">        <span class="keyword">private</span> String validationQuery;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> testWhileIdle;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> testOnBorrow;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> testOnReturn;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> poolPreparedStatements;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxPoolPreparedStatementPerConnectionSize;</span><br><span class="line">        <span class="keyword">private</span> String filters;</span><br><span class="line">        <span class="keyword">private</span> String connectionProperties;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span>     <span class="comment">//声明其为Bean实例</span></span><br><span class="line">        <span class="meta">@Primary</span>  <span class="comment">//在同样的DataSource中，首先使用被标注的DataSource</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            DruidDataSource datasource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">            datasource.setUrl(url);</span><br><span class="line">            datasource.setUsername(username);</span><br><span class="line">            datasource.setPassword(password);</span><br><span class="line">            datasource.setDriverClassName(driverClassName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//configuration</span></span><br><span class="line">            datasource.setInitialSize(initialSize);</span><br><span class="line">            datasource.setMinIdle(minIdle);</span><br><span class="line">            datasource.setMaxActive(maxActive);</span><br><span class="line">            datasource.setMaxWait(maxWait);</span><br><span class="line">            datasource.setTimeBetweenEvictionRunsMillis(timeBetweenEvictionRunsMillis);</span><br><span class="line">            datasource.setMinEvictableIdleTimeMillis(minEvictableIdleTimeMillis);</span><br><span class="line">            datasource.setValidationQuery(validationQuery);</span><br><span class="line">            datasource.setTestWhileIdle(testWhileIdle);</span><br><span class="line">            datasource.setTestOnBorrow(testOnBorrow);</span><br><span class="line">            datasource.setTestOnReturn(testOnReturn);</span><br><span class="line">            datasource.setPoolPreparedStatements(poolPreparedStatements);</span><br><span class="line">            datasource.setMaxPoolPreparedStatementPerConnectionSize(maxPoolPreparedStatementPerConnectionSize);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                datasource.setFilters(filters);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">"druid configuration initialization filter: "</span> + e);</span><br><span class="line">            &#125;</span><br><span class="line">            datasource.setConnectionProperties(connectionProperties);</span><br><span class="line">            <span class="keyword">return</span> datasource;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>这里需要注意的</strong></p>
<ol>
<li><code>username</code>、<code>password</code> 放在配置文件中，用于<code>Druid</code>控制台访问的登陆；</li>
<li>内部类<code>IDataSourceProperties.java</code> 读取的是我们配置文件中的<code>druid</code>配置，注意字段的一一对应。    </li>
</ol>
<h3 id="2-2-控制层接口"><a href="#2-2-控制层接口" class="headerlink" title="2.2 控制层接口"></a>2.2 控制层接口</h3><blockquote>
<p>为了便于测试，我引用了<code>Swagger</code>方便测试</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/mybatisDruid"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = &#123;<span class="string">"Druid 测试"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DruidController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    UserInfoDruidMapper userInfoDruidMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/selectOne"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserInfoDruidDO <span class="title">selectOne</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoDruidMapper.selectByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/selectAll"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfoDruidDO&gt; <span class="title">selectAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoDruidMapper.selectAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三、使用"><a href="#三、使用" class="headerlink" title="三、使用"></a>三、使用</h2><h3 id="3-1-请求接口"><a href="#3-1-请求接口" class="headerlink" title="3.1 请求接口"></a>3.1 请求接口</h3><p><a href="http://localhost:8082/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8082/swagger-ui.html</a></p>
<p>请求两个接口，如果配置没错，这里应该可以请求到数据。</p>
<h3 id="3-2-查看-Druid-监控"><a href="#3-2-查看-Druid-监控" class="headerlink" title="3.2 查看 Druid 监控"></a>3.2 查看 <code>Druid</code> 监控</h3><p>访问<a href="http://localhost:8082/druid/login.html" target="_blank" rel="noopener">http://localhost:8082/druid/login.html</a></p>
<p>输入设置的用户名和密码即可访问<code>Druid</code>面板，里面有啥功能，自己去看吧。</p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p><a href="https://github.com/vanDusty/Frame-Home/tree/master/mybatis-case/mybatis-druid" target="_blank" rel="noopener">Github 完整示例</a></p>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
<p>参考文章：<a href="https://github.com/alibaba/druid/wiki/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">Druid 问题文档</a></p>
]]></content>
      <categories>
        <category>Mybatis</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 处理跨域请求</title>
    <url>/2019/02/21/69fe966b.html</url>
    <content><![CDATA[<h2 id="一、跨域背景"><a href="#一、跨域背景" class="headerlink" title="一、跨域背景"></a>一、跨域背景</h2><h3 id="1-1-何为跨域？"><a href="#1-1-何为跨域？" class="headerlink" title="1.1 何为跨域？"></a>1.1 何为跨域？</h3><p><code>Url</code>的一般格式： </p>
<p><code>协议 + 域名（子域名 + 主域名） + 端口号 + 资源地址</code></p>
<a id="more"></a>

<p>示例：</p>
<p><code>https://www.dustyblog.cn:8080/say/Hello</code> 是由</p>
<p><code>https</code> + <code>www</code> + <code>dustyblog.cn</code> + <code>8080</code> + <code>say/Hello</code><br>组成。</p>
<blockquote>
<p>只要协议，子域名，主域名，端口号这四项组成部分中有一项不同，就可以认为是不同的域，不同的域之间互相访问资源，就被称之为跨域。</p>
</blockquote>
<h3 id="1-2-一次正常的请求"><a href="#1-2-一次正常的请求" class="headerlink" title="1.2 一次正常的请求"></a>1.2 一次正常的请求</h3><ul>
<li><code>Controller</code>层代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsTestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/sayHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello world !"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>启动项目，测试请求</li>
</ul>
<p>浏览器打开<a href="localhost:8080/demo/sayHello">localhost:8080/demo/sayHello</a></p>
<p>可以打印出<code>hello world</code></p>
<h3 id="1-3-跨域测试"><a href="#1-3-跨域测试" class="headerlink" title="1.3 跨域测试"></a>1.3 跨域测试</h3><blockquote>
<p>以<code>Chrome</code>为例：</p>
</blockquote>
<ul>
<li><p>打开任意网站，如：<a href="https://blog.csdn.net/weixin_42036952/article/details/88564647" target="_blank" rel="noopener">https://blog.csdn.net</a></p>
</li>
<li><p>按<code>F12</code>，打开【开发者工具】，在里面的【Console】可以直接输入<code>js</code>代码测试；</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> token= <span class="string">"LtSFVqKxvpS1nPARxS2lpUs2Q2IpGstidMrS8zMhNV3rT7RKnhLN6d2FFirkVEzVIeexgEHgI/PtnynGqjZlyGkJa4+zYIXxtDMoK/N+AB6wtsskYXereH3AR8kWErwIRvx+UOFveH3dgmdw1347SYjbL/ilGKX5xkoZCbfb1f0=,LZkg22zbNsUoHAgAUapeBn541X5OHUK7rLVNHsHWDM/BA4DCIP1f/3Bnu4GAElQU6cds/0fg9Li5cSPHe8pyhr1Ii/TNcUYxqHMf9bHyD6ugwOFTfvlmtp6RDopVrpG24RSjJbWy2kUOOjjk5uv6FUTmbrSTVoBEzAXYKZMM2m4=,R4QeD2psvrTr8tkBTjnnfUBw+YR4di+GToGjWYeR7qZk9hldUVLlZUsEEPWjtBpz+UURVmplIn5WM9Ge29ft5aS4oKDdPlIH8kWNIs9Y3r9TgH3MnSUTGrgayaNniY9Ji5wNZiZ9cE2CFzlxoyuZxOcSVfOxUw70ty0ukLVM/78="</span>;</span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">'GET'</span>, <span class="string">'http://127.0.0.1:8080/demo/sayHello'</span>);</span><br><span class="line">xhr.setRequestHeader(<span class="string">"x-access-token"</span>,token);</span><br><span class="line">xhr.send(<span class="literal">null</span>);</span><br><span class="line">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = e.target;</span><br><span class="line">    <span class="built_in">console</span>.log(xhr.responseText);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>输入完后直接按回车键就可以返回结果:</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">Access to XMLHttpRequest at <span class="string">'http://127.0.0.1:8080/demo/sayHello'</span> </span><br><span class="line"><span class="keyword">from</span> origin <span class="string">'https://blog.csdn.net'</span> has been blocked by CORS policy: </span><br><span class="line">No <span class="string">'Access-Control-Allow-Origin'</span> header is present on the requested resource.</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">该结果表明：该请求在`</span>https:<span class="comment">//blog.csdn.net`域名下请求失败！</span></span><br><span class="line"></span><br><span class="line">## 二、解决方案</span><br><span class="line"></span><br><span class="line">### 2.1 `Cors`是什么</span><br><span class="line"></span><br><span class="line">&gt; <span class="string">`CORS`</span>全称为<span class="string">`Cross Origin Resource Sharing`</span>（跨域资源共享）, 每一个页面需要返回一个名为<span class="string">`Access-Control-Allow-Origin`</span>的http头来允许外域的站点访问，你可以仅仅暴露有限的资源和有限的外域站点访问。</span><br><span class="line"></span><br><span class="line">我们可以理解为：如果一个请求需要允许跨域访问，则需要在<span class="string">`http`</span>头中设置<span class="string">`Access-Control-Allow-Origin`</span>来决定需要允许哪些站点来访问。如假设需要允许[https:<span class="comment">//www.dustyblog.c](https://www.dustyblog.cn)这个站点的请求跨域，则可以设置：</span></span><br><span class="line"></span><br><span class="line"><span class="string">`Access-Control-Allow-Origin:https://www.dustyblog.cn。`</span></span><br><span class="line"></span><br><span class="line">### 2.2 方案一：使用`@CrossOrigin`注解</span><br><span class="line"></span><br><span class="line">#### 2.2.1 在`Controller`上使用`@CrossOrigin`注解</span><br><span class="line"></span><br><span class="line">&gt; 该类下的所有接口都可以通过跨域访问</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`java</span></span><br><span class="line"><span class="string">@RequestMapping("/demo2")</span></span><br><span class="line"><span class="string">@RestController</span></span><br><span class="line"><span class="string">//@CrossOrigin //所有域名均可访问该类下所有接口</span></span><br><span class="line"><span class="string">@CrossOrigin("https://blog.csdn.net") // 只有指定域名可以访问该类下所有接口</span></span><br><span class="line"><span class="string">public class CorsTest2Controller &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @GetMapping("/sayHello")</span></span><br><span class="line"><span class="string">    public String sayHello() &#123;</span></span><br><span class="line"><span class="string">        return "hello world --- 2";</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里指定当前的<code>CorsTest2Controller</code>中所有的方法可以处理<code>https://csdn.net</code>域上的请求,这里可以测试一下：</p>
<ul>
<li>在<a href="https://blog.csdn.net/weixin_42036952/article/details/88564647" target="_blank" rel="noopener">https://blog.csdn.net</a>页面打开调试窗口，输入(注意：这里请求地址是<code>/demo2</code>，请区别于<code>1.2</code> 案例中的<code>/demo</code>)</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> token= <span class="string">"LtSFVqKxvpS1nPARxS2lpUs2Q2IpGstidMrS8zMhNV3rT7RKnhLN6d2FFirkVEzVIeexgEHgI/PtnynGqjZlyGkJa4+zYIXxtDMoK/N+AB6wtsskYXereH3AR8kWErwIRvx+UOFveH3dgmdw1347SYjbL/ilGKX5xkoZCbfb1f0=,LZkg22zbNsUoHAgAUapeBn541X5OHUK7rLVNHsHWDM/BA4DCIP1f/3Bnu4GAElQU6cds/0fg9Li5cSPHe8pyhr1Ii/TNcUYxqHMf9bHyD6ugwOFTfvlmtp6RDopVrpG24RSjJbWy2kUOOjjk5uv6FUTmbrSTVoBEzAXYKZMM2m4=,R4QeD2psvrTr8tkBTjnnfUBw+YR4di+GToGjWYeR7qZk9hldUVLlZUsEEPWjtBpz+UURVmplIn5WM9Ge29ft5aS4oKDdPlIH8kWNIs9Y3r9TgH3MnSUTGrgayaNniY9Ji5wNZiZ9cE2CFzlxoyuZxOcSVfOxUw70ty0ukLVM/78="</span>;</span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">'GET'</span>, <span class="string">'http://127.0.0.1:8080/demo2/sayHello'</span>);</span><br><span class="line">xhr.setRequestHeader(<span class="string">"x-access-token"</span>,token);</span><br><span class="line">xhr.send(<span class="literal">null</span>);</span><br><span class="line">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = e.target;</span><br><span class="line">    <span class="built_in">console</span>.log(xhr.responseText);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回结果：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ƒ (e) &#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = e.target;</span><br><span class="line">    <span class="built_in">console</span>.log(xhr.responseText);</span><br><span class="line">&#125;</span><br><span class="line">VM156:<span class="number">8</span> hello world --- <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>说明跨域成功！</p>
<ul>
<li>换个域名测试一下看跨域是否还有效，在<a href="https://www.baidu.com" target="_blank" rel="noopener">https://www.baidu.com</a>按照上述方法测试一下，返回结果：</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">OPTIONS http:<span class="comment">//127.0.0.1:8080/demo2/sayHello 403</span></span><br><span class="line">(anonymous)</span><br><span class="line">Access to XMLHttpRequest at <span class="string">'http://127.0.0.1:8080/demo2/sayHello'</span> </span><br><span class="line"><span class="keyword">from</span> origin <span class="string">'http://www.cnblogs.com'</span> has been blocked by CORS policy: </span><br><span class="line">Response to preflight request doesn<span class="string">'t pass access control check: </span></span><br><span class="line"><span class="string">No '</span>Access-Control-Allow-Origin<span class="string">' header is present on the requested resource.</span></span><br></pre></td></tr></table></figure>

<p>说明跨域失败！证明该方案成功指定了部分域名能跨域！</p>
<h3 id="2-3-方案二：CORS全局配置-实现WebMvcConfigurer"><a href="#2-3-方案二：CORS全局配置-实现WebMvcConfigurer" class="headerlink" title="2.3 方案二：CORS全局配置-实现WebMvcConfigurer"></a>2.3 方案二：<code>CORS</code>全局配置-实现<code>WebMvcConfigurer</code></h3><ul>
<li>新建跨域配置类：<code>CorsConfig.java</code>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跨域配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebMvcConfigurer <span class="title">corsConfigurer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line">                registry.addMapping(<span class="string">"/**"</span>).</span><br><span class="line">                        allowedOrigins(<span class="string">"https://www.dustyblog.cn"</span>). <span class="comment">//允许跨域的域名，可以用*表示允许任何域名使用</span></span><br><span class="line">                        allowedMethods(<span class="string">"*"</span>). <span class="comment">//允许任何方法（post、get等）</span></span><br><span class="line">		                allowedHeaders(<span class="string">"*"</span>). <span class="comment">//允许任何请求头</span></span><br><span class="line">                        allowCredentials(<span class="keyword">true</span>). <span class="comment">//带上cookie信息</span></span><br><span class="line">                        exposedHeaders(HttpHeaders.SET_COOKIE).maxAge(<span class="number">3600L</span>); <span class="comment">//maxAge(3600)表明在3600秒内，不需要再发送预检验请求，可以缓存该结果</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试，在允许访问的域名<a href="https://www.dustyblog.cn/" target="_blank" rel="noopener">https://www.dustyblog.cn/</a>控制台输入(注意，这里请求的是<code>http://127.0.0.1:8080/demo3</code>)：</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> token= <span class="string">"LtSFVqKxvpS1nPARxS2lpUs2Q2IpGstidMrS8zMhNV3rT7RKnhLN6d2FFirkVEzVIeexgEHgI/PtnynGqjZlyGkJa4+zYIXxtDMoK/N+AB6wtsskYXereH3AR8kWErwIRvx+UOFveH3dgmdw1347SYjbL/ilGKX5xkoZCbfb1f0=,LZkg22zbNsUoHAgAUapeBn541X5OHUK7rLVNHsHWDM/BA4DCIP1f/3Bnu4GAElQU6cds/0fg9Li5cSPHe8pyhr1Ii/TNcUYxqHMf9bHyD6ugwOFTfvlmtp6RDopVrpG24RSjJbWy2kUOOjjk5uv6FUTmbrSTVoBEzAXYKZMM2m4=,R4QeD2psvrTr8tkBTjnnfUBw+YR4di+GToGjWYeR7qZk9hldUVLlZUsEEPWjtBpz+UURVmplIn5WM9Ge29ft5aS4oKDdPlIH8kWNIs9Y3r9TgH3MnSUTGrgayaNniY9Ji5wNZiZ9cE2CFzlxoyuZxOcSVfOxUw70ty0ukLVM/78="</span>;</span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">'GET'</span>, <span class="string">'http://127.0.0.1:8080/demo3/sayHello'</span>);</span><br><span class="line">xhr.setRequestHeader(<span class="string">"x-access-token"</span>,token);</span><br><span class="line">xhr.send(<span class="literal">null</span>);</span><br><span class="line">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = e.target;</span><br><span class="line">    <span class="built_in">console</span>.log(xhr.responseText);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">ƒ (e) &#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = e.target;</span><br><span class="line">    <span class="built_in">console</span>.log(xhr.responseText);</span><br><span class="line">&#125;</span><br><span class="line">VM433:<span class="number">8</span> hello world --- <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>说明跨域成功，换个网址如<a href="https://www.baidu.com" target="_blank" rel="noopener">https://www.baidu.com</a>测试依旧出现需要跨域的错误提示，证明该配置正确，该方案测试通过。</p>
<h3 id="2-3-拦截器实现"><a href="#2-3-拦截器实现" class="headerlink" title="2.3 拦截器实现"></a>2.3 拦截器实现</h3><p>通过实现<code>Fiter</code>接口在请求中添加一些<code>Header</code>来解决跨域的问题</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletResponse res = (HttpServletResponse) response;</span><br><span class="line">        res.addHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">        res.addHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span><br><span class="line">        res.addHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET, POST, DELETE, PUT"</span>);</span><br><span class="line">        res.addHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type,X-CAF-Authorization-Token,sessionToken,X-TOKEN"</span>);</span><br><span class="line">        <span class="keyword">if</span> (((HttpServletRequest) request).getMethod().equals(<span class="string">"OPTIONS"</span>)) &#123;</span><br><span class="line">            response.getWriter().println(<span class="string">"ok"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、源码地址"><a href="#三、源码地址" class="headerlink" title="三、源码地址"></a>三、源码地址</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-list/cross-domain%20" target="_blank" rel="noopener">Github 示例代码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>跨域</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 整合 Logback 异步打印 Web 请求参数</title>
    <url>/2019/02/12/7e5b5007.html</url>
    <content><![CDATA[<blockquote>
<p>本文介绍：日志输出到文件并根据<code>LEVEL</code>级别将日志分类保存到不同文件、通过异步输出日志减少磁盘<code>IO</code>提高性能</p>
</blockquote>
<a id="more"></a>

<h2 id="一、Logback"><a href="#一、Logback" class="headerlink" title="一、Logback"></a>一、<code>Logback</code></h2><h3 id="1-1-背景"><a href="#1-1-背景" class="headerlink" title="1.1 背景"></a>1.1 背景</h3><p><code>Logback</code>是由<code>log4j</code>创始人设计的另一个开源日志组件，它分为下面下个模块：</p>
<ol>
<li><code>logback-core</code>：其它两个模块的基础模块</li>
<li><code>logback-classic</code>：它是<code>log4j</code>的一个改良版本，同时它完整实现了<code>slf4j API</code>使你可以很方便地更换成其它日志系统如<code>log4j</code>或<code>JDK14 Logging</code></li>
<li><code>logback-access</code>：访问模块与<code>Servlet</code>容器集成提供通过<code>Http</code>来访问日志的功能</li>
</ol>
<h3 id="1-2-日志级别"><a href="#1-2-日志级别" class="headerlink" title="1.2 日志级别"></a>1.2 日志级别</h3><blockquote>
<p>包括：<code>TRACE</code>、<code>DEBUG</code>、<code>INFO</code>、<code>WARN</code> 和 <code>ERROR</code>。</p>
</blockquote>
<h4 id="1-2-1-TRACE"><a href="#1-2-1-TRACE" class="headerlink" title="1.2.1 TRACE"></a>1.2.1 <code>TRACE</code></h4><p>特别详细的系统运行完成信息，业务代码中，不要使用。(除非有特殊用意，否则请使用<code>DEBUG</code>级别替代)</p>
<h4 id="1-2-2-DEBUG"><a href="#1-2-2-DEBUG" class="headerlink" title="1.2.2 DEBUG"></a>1.2.2 <code>DEBUG</code></h4><ol>
<li>可以填写所有的想知道的相关信息(但不代表可以随便写，<code>debug</code>信息要有意义,最好有相关参数)；</li>
<li>生产环境需要关闭<code>DEBUG</code>信息</li>
<li>如果在生产情况下需要开启<code>DEBUG</code>,需要使用开关进行管理，不能一直开启。</li>
</ol>
<h4 id="1-2-3-INFO"><a href="#1-2-3-INFO" class="headerlink" title="1.2.3 INFO"></a>1.2.3 <code>INFO</code></h4><ul>
<li><p>系统运行信息</p>
<ol>
<li><code>Service</code>方法中对于系统/业务状态的变更；</li>
<li>主要逻辑中的分步骤。</li>
</ol>
</li>
<li><p>外部接口部分</p>
<ol>
<li>客户端请求参数；</li>
<li>调用第三方时的调用参数和调用结果。</li>
</ol>
</li>
<li><p>说明</p>
</li>
</ul>
<ol>
<li>并不是所有的<code>Service</code>都进行出入口打点记录,单一、简单<code>Service</code>是没有意义的；</li>
<li>对于复杂的业务逻辑，需要进行日志打点，以及埋点记录，比如电商系统中的下订单逻辑，以及<code>OrderAction</code>操作(业务状态变更)；</li>
<li>对于整个系统的提供出的接口，使用<code>INFO</code>记录入参；</li>
<li>如果所有的<code>Service</code>为<code>SOA</code>架构，那么可以看成是一个外部接口提供方，那么必须记录入参；</li>
<li>调用其他第三方服务时，所有的出参和入参是必须要记录的(因为你很难追溯第三方模块发生的问题)。</li>
</ol>
<h4 id="1-2-4-WARN"><a href="#1-2-4-WARN" class="headerlink" title="1.2.4 WARN"></a>1.2.4 <code>WARN</code></h4><ul>
<li><p>不应该出现但是不影响程序、当前请求正常运行的异常情况:</p>
<ol>
<li>有容错机制的时候出现的错误情况；</li>
<li>找不到配置文件，但是系统能自动创建配置文件；</li>
</ol>
</li>
<li><p>即将接近临界值的时候，例如：缓存池占用达到警告线；</p>
</li>
<li><p>业务异常的记录,比如:当接口抛出业务异常时，应该记录此异常。</p>
</li>
</ul>
<h4 id="1-2-5-ERROR"><a href="#1-2-5-ERROR" class="headerlink" title="1.2.5 ERROR"></a>1.2.5 <code>ERROR</code></h4><p>影响到程序正常运行、当前请求正常运行的异常情况:</p>
<ol>
<li>打开配置文件失败；</li>
<li>所有第三方对接的异常(包括第三方返回错误码)；</li>
<li>所有影响功能使用的异常，包括:<code>SQLException</code>和除了业务异常之外的所有异常(<code>RuntimeException</code>和<code>Exception</code>)。</li>
</ol>
<blockquote>
<p>不应该出现的情况:<br>如果进行了抛出异常操作，请不要记录<code>ERROR</code>日志，由最终处理方进行处理：</p>
</blockquote>
<p>反例(<strong>不要这么做</strong>):</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">  String errorMessage=String.format(<span class="string">"Error while reading information of user [%s]"</span>,userName);</span><br><span class="line">  logger.error(errorMessage,ex);</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> UserServiceException(errorMessage,ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h2 id="二、SpringBoot-中-logback"><a href="#二、SpringBoot-中-logback" class="headerlink" title="二、SpringBoot 中 logback"></a>二、<code>SpringBoot</code> 中 <code>logback</code></h2><h3 id="2-1-背景"><a href="#2-1-背景" class="headerlink" title="2.1 背景"></a>2.1 背景</h3><ol>
<li><code>SpringBoot</code>工程自带<code>logback</code>和<code>slf4j</code>的依赖，所以重点放在编写配置文件上，需要引入什么依赖，日志依赖冲突统统都不需要我们管了;</li>
<li><code>logback</code>框架会默认加载<code>classpath</code>下命名为<code>logback-spring</code>或<code>logback</code>的配置文件。</li>
<li>将所有日志都存储在一个文件中文件大小也随着应用的运行越来越大并且不好排查问题，正确的做法应该是将<code>ERROR</code>日志和其他日志分开，并且不同级别的日志根据时间段进行记录存储。</li>
</ol>
<h3 id="2-1-logback-spring-xml"><a href="#2-1-logback-spring-xml" class="headerlink" title="2.1 logback-spring.xml"></a>2.1 <code>logback-spring.xml</code></h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 属性文件:在配置文件中找到对应的配置项 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">"context"</span> <span class="attr">name</span>=<span class="string">"logPath"</span> <span class="attr">source</span>=<span class="string">"logging.path"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 输出到控制台 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE-LOG"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.PatternLayout"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>[%d&#123;yyyy-MM-dd' 'HH:mm:ss.sss&#125;] [%C] [%t] [%L] [%-5p] %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 获取比info级别高(包括info级别)但除error级别的日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"INFO-LOG"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定过滤策略 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.LevelFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 指定日志输出格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>[%d&#123;yyyy-MM-dd' 'HH:mm:ss.sss&#125;] [%C] [%t] [%L] [%-5p] %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 指定收集策略：滚动策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 指定生成日志保存地址 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;logPath&#125;/info.%d.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"ERROR-LOG"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定过滤策略 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.ThresholdFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 指定日志输出格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>[%d&#123;yyyy-MM-dd' 'HH:mm:ss.sss&#125;] [%C] [%t] [%L] [%-5p] %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定收集策略：滚动策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--指定生成日志保存地址 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;logPath&#125;/error.%d.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 异步输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"ASYNC-INFO"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.AsyncAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 不丢失日志.默认的,如果队列的80%已满,则会丢弃TRACT、DEBUG、INFO级别的日志 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">discardingThreshold</span>&gt;</span>0<span class="tag">&lt;/<span class="name">discardingThreshold</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 更改默认的队列的深度,该值会影响性能.默认值为256 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">queueSize</span>&gt;</span>256<span class="tag">&lt;/<span class="name">queueSize</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 添加附加的appender,最多只能添加一个 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"INFO-LOG"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"ASYNC-ERROR"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.AsyncAppender"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 不丢失日志.默认的,如果队列的80%已满,则会丢弃TRACT、DEBUG、INFO级别的日志 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">discardingThreshold</span>&gt;</span>0<span class="tag">&lt;/<span class="name">discardingThreshold</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 更改默认的队列的深度,该值会影响性能.默认值为256 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">queueSize</span>&gt;</span>256<span class="tag">&lt;/<span class="name">queueSize</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 添加附加的appender,最多只能添加一个 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ERROR-LOG"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 指定最基础的日志输出级别 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE-LOG"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"INFO-LOG"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ERROR-LOG"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="三、在Web请求做入参-出参打印"><a href="#三、在Web请求做入参-出参打印" class="headerlink" title="三、在Web请求做入参/出参打印"></a>三、在<code>Web</code>请求做入参/出参打印</h2><h3 id="3-1-项目配置"><a href="#3-1-项目配置" class="headerlink" title="3.1 项目配置"></a>3.1 项目配置</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8088</span><br><span class="line"># 日志输出文件地址</span><br><span class="line">logging:</span><br><span class="line">  path: ./springboot-demo-log/logback-demo/logs</span><br></pre></td></tr></table></figure>

<h3 id="3-2-定义一个切面WebLogAspect"><a href="#3-2-定义一个切面WebLogAspect" class="headerlink" title="3.2 定义一个切面WebLogAspect"></a>3.2 定义一个切面<code>WebLogAspect</code></h3><blockquote>
<p>详见文中注释</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebLogAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进入方法时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long startTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法结束时间戳(计时)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long endTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebLogAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义请求日志切入点，其切入点表达式有多种匹配方式,这里是指定路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * cn.van.log.logback.web.controller.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">webLogPointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知：</span></span><br><span class="line"><span class="comment">     * 1. 在执行目标方法之前执行，比如请求接口之前的登录验证;</span></span><br><span class="line"><span class="comment">     * 2. 在前置通知中设置请求日志信息，如开始时间，请求参数，注解内容等</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"webLogPointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接收到请求，记录请求内容</span></span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest request = attributes.getRequest();</span><br><span class="line">        <span class="comment">//获取请求头中的User-Agent</span></span><br><span class="line">        UserAgent userAgent = UserAgent.parseUserAgentString(request.getHeader(<span class="string">"User-Agent"</span>));</span><br><span class="line">        <span class="comment">//打印请求的内容</span></span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">"请求开始时间：&#123;&#125;"</span> , LocalDateTime.now());</span><br><span class="line">        log.info(<span class="string">"请求Url : &#123;&#125;"</span> , request.getRequestURL().toString());</span><br><span class="line">        log.info(<span class="string">"请求方式 : &#123;&#125;"</span> , request.getMethod());</span><br><span class="line">        log.info(<span class="string">"请求ip : &#123;&#125;"</span> , request.getRemoteAddr());</span><br><span class="line">        log.info(<span class="string">"请求参数 : &#123;&#125;"</span> , Arrays.toString(joinPoint.getArgs()));</span><br><span class="line">        <span class="comment">// 系统信息</span></span><br><span class="line">        log.info(<span class="string">"浏览器：&#123;&#125;"</span>, userAgent.getBrowser().toString());</span><br><span class="line">        log.info(<span class="string">"浏览器版本：&#123;&#125;"</span>, userAgent.getBrowserVersion());</span><br><span class="line">        log.info(<span class="string">"操作系统: &#123;&#125;"</span>, userAgent.getOperatingSystem().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回通知：</span></span><br><span class="line"><span class="comment">     * 1. 在目标方法正常结束之后执行</span></span><br><span class="line"><span class="comment">     * 1. 在返回通知中补充请求日志信息，如返回时间，方法耗时，返回值，并且保存日志信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ret</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AfterReturning</span>(returning = <span class="string">"ret"</span>, pointcut = <span class="string">"webLogPointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterReturning</span><span class="params">(Object ret)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        endTime = System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">"请求结束时间：&#123;&#125;"</span> , LocalDateTime.now());</span><br><span class="line">        log.info(<span class="string">"请求耗时：&#123;&#125;ms"</span> , (endTime - startTime));</span><br><span class="line">        <span class="comment">// 处理完请求，返回内容</span></span><br><span class="line">        log.info(<span class="string">"请求返回 : &#123;&#125;"</span> , ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常通知：</span></span><br><span class="line"><span class="comment">     * 1. 在目标方法非正常结束，发生异常或者抛出异常时执行</span></span><br><span class="line"><span class="comment">     * 1. 在异常通知中设置异常信息，并将其保存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(value = <span class="string">"webLogPointcut()"</span>, throwing = <span class="string">"throwable"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterThrowing</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 保存异常日志记录</span></span><br><span class="line">        log.error(<span class="string">"发生异常时间：&#123;&#125;"</span> , LocalDateTime.now());</span><br><span class="line">        log.error(<span class="string">"抛出异常：&#123;&#125;"</span> , throwable.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-两个测试接口"><a href="#3-3-两个测试接口" class="headerlink" title="3.3 两个测试接口"></a>3.3 两个测试接口</h3><blockquote>
<p>包含一个正常请求接口和异常接口。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/log"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试正常请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/normal/&#123;msg&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">(@PathVariable String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试抛异常</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/exception/&#123;msg&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getException</span><span class="params">(@PathVariable String msg)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 故意造出一个异常</span></span><br><span class="line">        Integer.parseInt(<span class="string">"abc123"</span>);</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-启动项目测试"><a href="#3-4-启动项目测试" class="headerlink" title="3.4 启动项目测试"></a>3.4 启动项目测试</h3><ul>
<li>正常请求</li>
</ul>
<p>打开浏览器，访问<a href="http://localhost:8088/log/normal/hello" target="_blank" rel="noopener">http://localhost:8088/log/normal/hello</a></p>
<p>日志打印如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [65] [INFO ] 请求开始时间：2019-02-24T22:37:50.892</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [66] [INFO ] 请求Url : http://localhost:8088/log/normal/hello</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [67] [INFO ] 请求方式 : GET</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [68] [INFO ] 请求ip : 0:0:0:0:0:0:0:1</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [70] [INFO ] 请求参数 : [hello]</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [72] [INFO ] 浏览器：CHROME</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [73] [INFO ] 浏览器版本：76.0.3809.100</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [74] [INFO ] 操作系统: MAC_OS_X</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [88] [INFO ] 请求结束时间：2019-02-24T22:37:50.901</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [89] [INFO ] 请求耗时：14</span><br><span class="line">[2019-02-24 22:37:50.050] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-1] [91] [INFO ] 请求返回 : hello</span><br></pre></td></tr></table></figure>

<ul>
<li>异常请求</li>
</ul>
<p>访问：<a href="http://localhost:8088/log/exception/hello" target="_blank" rel="noopener">http://localhost:8088/log/exception/hello</a></p>
<p>日志打印如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [65] [INFO ] 请求开始时间：2019-02-24T22:39:57.728</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [66] [INFO ] 请求Url : http://localhost:8088/log/exception/hello</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [67] [INFO ] 请求方式 : GET</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [68] [INFO ] 请求ip : 0:0:0:0:0:0:0:1</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [70] [INFO ] 请求参数 : [hello]</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [72] [INFO ] 浏览器：CHROME</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [73] [INFO ] 浏览器版本：76.0.3809.100</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [74] [INFO ] 操作系统: MAC_OS_X</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [104] [ERROR] 发生异常时间：2019-02-24T22:39:57.731</span><br><span class="line">[2019-02-24 22:39:57.057] [cn.van.log.aop.logback.WebLogAspect] [http-nio-8088-exec-9] [105] [ERROR] 抛出异常：For input string: "abc123"</span><br><span class="line">[2019-02-24 22:39:57.057] [org.apache.juli.logging.DirectJDKLog] [http-nio-8088-exec-9] [175] [ERROR] Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.NumberFormatException: For input string: "abc123"] with root cause</span><br><span class="line">java.lang.NumberFormatException: For input string: "abc123"</span><br></pre></td></tr></table></figure>

<h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><ol>
<li><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-log/logback-demo" target="_blank" rel="noopener">Github 示例代码</a></li>
</ol>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>日志</tag>
        <tag>AOP</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 配置 Swagger2</title>
    <url>/2019/01/29/407a3637.html</url>
    <content><![CDATA[<h2 id="一、背景介绍"><a href="#一、背景介绍" class="headerlink" title="一、背景介绍"></a>一、背景介绍</h2><h3 id="1-1-Swagger-介绍"><a href="#1-1-Swagger-介绍" class="headerlink" title="1.1 Swagger 介绍"></a>1.1 <code>Swagger</code> 介绍</h3><p><code>Swagger</code> 是一套基于 <code>OpenAPI</code> 规范构建的开源工具，可以帮助我们设计、构建、记录以及使用 <code>Rest API</code>。<code>Swagger</code> 主要包含了以下三个部分：</p>
<ol>
<li><code>Swagger Editor</code>：基于浏览器的编辑器，我们可以使用它编写我们 <code>OpenAPI</code> 规范。</li>
<li><code>Swagger UI</code>：它会将我们编写的 <code>OpenAPI</code> 规范呈现为交互式的 <code>API</code> 文档，后文我将使用浏览器来查看并且操作我们的 <code>Rest API</code>。</li>
<li><code>Swagger Codegen</code>：它可以通过为 <code>OpenAPI</code>（以前称为 Swagger）规范定义的任何 <code>API</code> 生成服务器存根和客户端 <code>SDK</code> 来简化构建过程。</li>
</ol>
<a id="more"></a>

<h3 id="1-2-Swagger-优缺点"><a href="#1-2-Swagger-优缺点" class="headerlink" title="1.2 Swagger 优缺点"></a>1.2 <code>Swagger</code> 优缺点</h3><ul>
<li>优点</li>
</ul>
<ol>
<li>易用性好。<code>Swagger UI</code>提供很好的<code>API</code>接口的<code>UI</code>界面，可以很方面的进行<code>API</code>接口的调用;</li>
<li>时效性和可维护性好，<code>API</code>文档随着代码变更而变更。 <code>Swagger</code>是根据注解来生成文<code>API</code>档的，我们可以在变更代码的时候顺便更改相应的注解即可；</li>
<li>易于测试，可以将文档规范导入相关的工具（例如 <code>SoapUI</code>）, 这些工具将会为我们自动地创建自动化测试。</li>
</ol>
<ul>
<li>缺点</li>
</ul>
<ol>
<li>重复利用性差，因为<code>Swagger</code>毕竟是网页打开，在进行接口测试的时候很多参数无法进行保存，因此不易于重复利用。</li>
<li>复杂的场景不易模拟，比如使用<code>token</code>鉴权的，可能每次都需要先模拟登录，再来进行接口调用。</li>
</ol>
<h3 id="1-3-Swagger-相关地址"><a href="#1-3-Swagger-相关地址" class="headerlink" title="1.3 Swagger 相关地址"></a>1.3 <code>Swagger</code> 相关地址</h3><ol>
<li><code>Swagger</code>官网：<a href="http://swagger.io" target="_blank" rel="noopener">http://swagger.io</a></li>
<li><code>Swagger</code>的<code>GitHub</code>地址：<a href="https://github.com/swagger-api" target="_blank" rel="noopener">https://github.com/swagger-api</a></li>
</ol>
<h2 id="二、上手使用"><a href="#二、上手使用" class="headerlink" title="二、上手使用"></a>二、上手使用</h2><h3 id="2-1-项目准备"><a href="#2-1-项目准备" class="headerlink" title="2.1 项目准备"></a>2.1 项目准备</h3><ul>
<li>项目依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!--Swagger-ui配置--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.springfox&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;springfox-swagger2&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.9.2&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.springfox&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;springfox-swagger-ui&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.9.2&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;!-- lombok --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;scope&gt;1.8.4&lt;&#x2F;scope&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>项目配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 项目端口和项目路径</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/swagger</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-Swagger2-配置"><a href="#2-2-Swagger2-配置" class="headerlink" title="2.2 Swagger2 配置"></a>2.2 Swagger2 配置</h3><blockquote>
<p>在启动的时候添加<code>@EnableSwagger2</code>注解开启，然后再使用<code>@Bean</code>注解初始化一些相应的配置。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2Config</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">// 指定controller存放的目录路径</span></span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"cn.van.swagger.demo.web.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                <span class="comment">// 文档标题</span></span><br><span class="line">                .title(<span class="string">"这里是Swagger2构建Restful APIs"</span>)</span><br><span class="line">                <span class="comment">// 文档描述</span></span><br><span class="line">                .description(<span class="string">"这里是文档描述"</span>)</span><br><span class="line">                .termsOfServiceUrl(<span class="string">"https://www.dustyblog.cn"</span>)</span><br><span class="line">                <span class="comment">//定义版本号</span></span><br><span class="line">                .version(<span class="string">"v1.0"</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-接口编写（控制器）"><a href="#2-3-接口编写（控制器）" class="headerlink" title="2.3 接口编写（控制器）"></a>2.3 接口编写（控制器）</h3><p><code>Swagger</code> 主要的使用就是在控制层这块，它是通过一些注解来为接口提供<code>API</code>文档。下列是<code>Swagger</code>的一些注解说明，更详细的可以查看官方的wiki文档。</p>
<ol>
<li><code>@Api</code> ：将类标记为<code>Swagger</code>资源，并给该类增加说明</li>
<li><code>@ApiOperation</code> :注解来给接口方法增加说明；</li>
<li><code>@ApiImplicitParam</code> ：表示<code>API</code>操作中的单个参数。</li>
<li><code>@ApiImplicitParams</code> ：一个包装器，允许列出多个<code>ApiImplicitParam</code>对象。</li>
<li><code>@ApiModel</code> ：提供有关<code>Swagger</code>模型的其他信息，比如描述<code>POJO</code>对象。</li>
<li><code>@ApiModelProperty</code> ： 添加和操作模型属性的数据。</li>
<li><code>@ApiOperation</code> ： 描述针对特定路径的操作或通常是<code>HTTP</code>方法。</li>
<li><code>@ApiParam</code> ： 为操作参数添加其他元数据。</li>
<li><code>@ApiResponse</code> ： 描述操作的可能响应。</li>
<li><code>@ApiResponses</code> ： 一个包装器，允许列出多个<code>ApiResponse</code>对象。</li>
<li><code>@Authorization</code> ： 声明要在资源或操作上使用的授权方案。</li>
<li><code>@AuthorizationScope</code> ： 描述<code>OAuth2</code>授权范围。</li>
<li><code>@ResponseHeader</code> ： 表示可以作为响应的一部分提供的标头。</li>
<li><code>@ApiProperty</code> ： 描述<code>POJO</code>对象中的属性值。</li>
<li><code>@ApiError</code> ： 接口错误所返回的信息</li>
</ol>
<p>官方<code>wiki</code>文档地址:</p>
<p><a href="https://github.com/swagger-api/swagger-core/wiki/Swagger-2.X---Annotations" target="_blank" rel="noopener">https://github.com/swagger-api/swagger-core/wiki/Swagger-2.X—Annotations</a></p>
<h4 id="2-3-1-参数实体UserDTO"><a href="#2-3-1-参数实体UserDTO" class="headerlink" title="2.3.1 参数实体UserDTO"></a>2.3.1 参数实体<code>UserDTO</code></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span>(value = <span class="string">"用户信息对象"</span>, description = <span class="string">"姓名、性别、年龄"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDTO</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"主键id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户名"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户性别"</span>)</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"用户年龄"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 隐藏字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"隐藏字段"</span>,hidden = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> String extra;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-接口方法示例"><a href="#2-3-2-接口方法示例" class="headerlink" title="2.3.2 接口方法示例"></a>2.3.2 接口方法示例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/swagger"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"Swagger接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  无参方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"无参方法"</span>, httpMethod = <span class="string">"GET"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/sayHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello Swagger!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单参方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiImplicitParam</span>( name = <span class="string">"id"</span>, value = <span class="string">"主键id"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"单参方法"</span>, httpMethod = <span class="string">"POST"</span>)</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/hasParam"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">hasParam</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多参方法(required = true可指定某个参数为必填)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiImplicitParams</span>(&#123;</span><br><span class="line">            <span class="meta">@ApiImplicitParam</span>( name = <span class="string">"id"</span>, value = <span class="string">"主键id"</span>, required = <span class="keyword">true</span>),</span><br><span class="line">            <span class="meta">@ApiImplicitParam</span>( name = <span class="string">"userName"</span>, value = <span class="string">"用户名"</span>, required = <span class="keyword">true</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"多参方法"</span>, httpMethod = <span class="string">"POST"</span>)</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/hasParams"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hasParams</span><span class="params">(Long id, String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数是实体类的方法（需要在实体类中增加注解进行参数说明）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"实体参数方法"</span>, httpMethod = <span class="string">"PUT"</span>)</span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"/entityParam"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDTO <span class="title">entityParam</span><span class="params">(@RequestBody UserDTO userDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 被忽略的接口，该接口不会在Swagger上显示</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(path = <span class="string">"/ignore"</span>)</span><br><span class="line">    <span class="meta">@ApiIgnore</span>(value = <span class="string">"这是被忽略的接口，将不会在Swagger上显示"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ignoreApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"测试"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-测试"><a href="#2-4-测试" class="headerlink" title="2.4 测试"></a>2.4 测试</h3><p>启动项目，打开<code>swagger</code>接口地址：<a href="http://localhost:8081/swagger/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8081/swagger/swagger-ui.html</a></p>
<h2 id="三、配置多个接口路径的配置"><a href="#三、配置多个接口路径的配置" class="headerlink" title="三、配置多个接口路径的配置"></a>三、配置多个接口路径的配置</h2><h3 id="3-1-分析"><a href="#3-1-分析" class="headerlink" title="3.1 分析"></a>3.1 分析</h3><p>根据上面的配置文件可知单个接口路径的配置是：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">**.apis(RequestHandlerSelectors.basePackage(<span class="string">"cn.van.swagger.group.web.controller"</span>))</span><br></pre></td></tr></table></figure>

<p>那我们就来参考一下<code>RequestHandlerSelectors.java</code>的源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestHandlerSelectors</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RequestHandlerSelectors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate&lt;RequestHandler&gt; <span class="title">any</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Predicates.alwaysTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate&lt;RequestHandler&gt; <span class="title">none</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Predicates.alwaysFalse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate&lt;RequestHandler&gt; <span class="title">withMethodAnnotation</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends Annotation&gt; annotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Predicate&lt;RequestHandler&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(RequestHandler input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> input.isAnnotatedWith(annotation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate&lt;RequestHandler&gt; <span class="title">withClassAnnotation</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends Annotation&gt; annotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Predicate&lt;RequestHandler&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(RequestHandler input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (Boolean)RequestHandlerSelectors.declaringClass(input).transform(RequestHandlerSelectors.annotationPresent(annotation)).or(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Function&lt;Class&lt;?&gt;, Boolean&gt; annotationPresent(<span class="keyword">final</span> Class&lt;? extends Annotation&gt; annotation) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Function&lt;Class&lt;?&gt;, Boolean&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">apply</span><span class="params">(Class&lt;?&gt; input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> input.isAnnotationPresent(annotation);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Function&lt;Class&lt;?&gt;, Boolean&gt; handlerPackage(<span class="keyword">final</span> String basePackage) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Function&lt;Class&lt;?&gt;, Boolean&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">apply</span><span class="params">(Class&lt;?&gt; input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ClassUtils.getPackageName(input).startsWith(basePackage);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Predicate 匹配RequestHandler，并为处理程序方法的类提供基本包名.</span></span><br><span class="line"><span class="comment">   * predicate 包括与所提供的basePackage匹配的所有请求处理程序</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> basePackage - base package of the classes</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> this</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate&lt;RequestHandler&gt; <span class="title">basePackage</span><span class="params">(<span class="keyword">final</span> String basePackage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Predicate&lt;RequestHandler&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(RequestHandler input)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (Boolean)RequestHandlerSelectors.declaringClass(input).transform(RequestHandlerSelectors.handlerPackage(basePackage)).or(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Optional&lt;? extends Class&lt;?&gt;&gt; declaringClass(RequestHandler input) &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.fromNullable(input.declaringClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到 <code>Swagger</code> 是通过 <code>Predicate</code> 的<code>apply()</code> 方法的返回值来判断是非匹配的,所以我们的方案是：<strong>通过改造<code>basePackage()</code>方法来实现多包扫描</strong></p>
<h3 id="3-2-验证"><a href="#3-2-验证" class="headerlink" title="3.2 验证"></a>3.2 验证</h3><ul>
<li><code>Swagger2Config.java</code>多包扫描配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2Config</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义分隔符</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATE = <span class="string">";"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">// 指定controller存放的目录路径</span></span><br><span class="line">                <span class="comment">// 单个路径</span></span><br><span class="line">                <span class="comment">// .apis(RequestHandlerSelectors.basePackage("cn.van.swagger.group.web.controller"))</span></span><br><span class="line">                <span class="comment">// 多个路径</span></span><br><span class="line">                .apis(basePackage(<span class="string">"cn.van.swagger.group.web.controller"</span> + SEPARATE +<span class="string">"cn.van.swagger.group.api"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                <span class="comment">// 文档标题</span></span><br><span class="line">                .title(<span class="string">"这里是Swagger2构建Restful APIs"</span>)</span><br><span class="line">                <span class="comment">// 文档描述</span></span><br><span class="line">                .description(<span class="string">"这里是文档描述"</span>)</span><br><span class="line">                .termsOfServiceUrl(<span class="string">"https://www.dustyblog.cn"</span>)</span><br><span class="line">                <span class="comment">//定义版本号</span></span><br><span class="line">                .version(<span class="string">"v1.0"</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate&lt;RequestHandler&gt; <span class="title">basePackage</span><span class="params">(<span class="keyword">final</span> String basePackage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> input -&gt; declaringClass(input).transform(handlerPackage(basePackage)).or(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Function&lt;Class&lt;?&gt;, Boolean&gt; handlerPackage(<span class="keyword">final</span> String basePackage)     &#123;</span><br><span class="line">        <span class="keyword">return</span> input -&gt; &#123;</span><br><span class="line">            <span class="comment">// 循环判断匹配</span></span><br><span class="line">            <span class="keyword">for</span> (String strPackage : basePackage.split(SEPARATE)) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> isMatch = input.getPackage().getName().startsWith(strPackage);</span><br><span class="line">                <span class="keyword">if</span> (isMatch) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Optional&lt;? extends Class&lt;?&gt;&gt; declaringClass(RequestHandler input) &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.fromNullable(input.declaringClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="3-3-测试"><a href="#3-3-测试" class="headerlink" title="3.3 测试"></a>3.3 测试</h3><ul>
<li>在<code>api</code>包下建立另一个接口类：<code>MultipleController.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/swagger2"</span>)</span><br><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"第二个包的Swagger接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipleController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  无参方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/sayHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello MultipleController!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动项目，查看<code>Swagger</code>接口</li>
</ul>
<p><img src="/File/Imgs/swagger_group_0.png" alt="风尘博客-0"></p>
<p>由上图可知扫描到两个路径的接口，说明配置多个接口路径成功！</p>
<h2 id="四、接口分组"><a href="#四、接口分组" class="headerlink" title="四、接口分组"></a>四、接口分组</h2><h3 id="4-1-背景"><a href="#4-1-背景" class="headerlink" title="4.1 背景"></a>4.1 背景</h3><p>我们在 <code>Spring Boot</code>中定义各个接口是以<code>Controller</code>作为第一级维度来进行组织的，<code>Controller</code>与具体接口之间的关系是<strong>一对多</strong>的关系。我们通常将同属一个模块的接口定义在一个<code>Controller</code>里。</p>
<p>默认情况下，<code>Swagger</code>是以<code>Controller</code>为单位，对接口进行分组管理的，这个分组的元素在<code>Swagger</code>中称为<code>Tag</code>。但是这里的<code>Tag</code>与接口的关系并不是一对多的，它<strong>支持更丰富的多对多关系</strong>。</p>
<h3 id="4-2-默认分组"><a href="#4-2-默认分组" class="headerlink" title="4.2 默认分组"></a>4.2 默认分组</h3><p>默认情况下，<code>Swagger</code>是如何根据<code>Controller</code>来组织<code>Tag</code>与接口关系的。例如，定义两个<code>Controller</code>：</p>
<ul>
<li><code>TeacherController.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"教师工作"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/teacher"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TeacherController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/teaching"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"教书"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">teaching</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"teaching...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/preparing"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"备课"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">preparing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"preparing...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>StudentController.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"学生任务"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/student"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"学习"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/study"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">study</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"study...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目，查看此时<code>Swagger</code>接口</p>
<p><img src="/File/Imgs/swagger_group_1.png" alt="Swagger 分组-1"></p>
<p>到这里，我们还都只是<code>Tag</code>与<code>Controller</code><strong>一一对应</strong>。</p>
<h3 id="4-3-合并分组"><a href="#4-3-合并分组" class="headerlink" title="4.3 合并分组"></a>4.3 合并分组</h3><p><code>Swagger</code>中还支持更灵活的分组，查看<code>@Api</code>源码，<code>tags</code>属性其实是个数组类型：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Api &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    String[] tags() <span class="keyword">default</span> &#123;<span class="string">""</span>&#125;;</span><br><span class="line">	...    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此可以推测：<strong>可以通过定义同名的<code>Tag</code>来汇总<code>Controller</code>中的接口</strong>。</p>
<h3 id="上手验证"><a href="#上手验证" class="headerlink" title="上手验证"></a><strong>上手验证</strong></h3><ul>
<li><p>定义一个<code>Tag</code>为“教学管理”，让这个分组同时包含教师工作和学生任务的所有接口。</p>
</li>
<li><p><code>TeacherController.java</code></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api</span>(tags = &#123;<span class="string">"教师工作"</span>, <span class="string">"教学管理"</span>&#125;)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/teacher"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TeacherController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/teaching"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"教书"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">teaching</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"teaching...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/preparing"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"备课"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">preparing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"preparing...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>StudentController.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api</span>(tags = &#123;<span class="string">"学生任务"</span>, <span class="string">"教学管理"</span>&#125;)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/student"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"学习"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/study"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">study</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"study...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动项目，<code>Swagger</code>接口如下:</li>
</ul>
<p><img src="/File/Imgs/swagger_group_2.png" alt="Swagger 分组-2"></p>
<p>此时，学生和教师的接口均在<strong>教学管理</strong>之下，说明该方案下合并分组成功。</p>
<h3 id="4-4-精准分组"><a href="#4-4-精准分组" class="headerlink" title="4.4 精准分组"></a>4.4 精准分组</h3><blockquote>
<p>通过<code>@Api</code>可以实现将指定<code>Controller</code>中的所有接口合并到一个<code>Tag</code>中，但是如果产品希望:<strong>教学管理</strong>接口下包含<strong>学生任务</strong>中所有接口以及<strong>教师工作</strong>管理中的接口<code>teaching</code>（<strong>不包含接口<code>preparing</code></strong>）。</p>
</blockquote>
<ul>
<li>通过<code>@ApiOperation</code>中的<code>tags</code>属性做更细粒度的接口划分,修改<code>TeacherController.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api</span>(tags = <span class="string">"教师工作"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/teacher"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TeacherController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/teaching"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"教书"</span>, tags = <span class="string">"教学管理"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">teaching</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"teaching...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/preparing"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"备课"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">preparing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"preparing...."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动项目，<code>Swagger</code>接口如下:</li>
</ul>
<p><img src="/File/Imgs/swagger_group_3.png" alt="Swagger 分组-3"></p>
<p>此时，教师工作中的接口<code>preparing</code>不在<strong>教学管理</strong>中，说明粒度更细的精准分组生效。</p>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><ol>
<li><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-restful/swagger-demo" target="_blank" rel="noopener">Github 示例代码-demo</a></p>
</li>
<li><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-restful/swagger-group" target="_blank" rel="noopener">Github 示例代码-分组和多包扫描</a></p>
</li>
</ol>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>Swagger2</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring 从应用获取Bean的常用姿势</title>
    <url>/2019/01/03/961239cf.html</url>
    <content><![CDATA[<blockquote>
<p>如何在普通类中获取 <code>Spring</code> 管理的 <code>Bean</code> ,各种姿势，从本文中寻找。</p>
</blockquote>
<a id="more"></a>

<p>通常，在<code>Spring</code>应用程序中，当我们使用<code>@Bean</code>/<code>@Service</code>/<code>@Controller</code>、<code>@Component</code>/<code>@Configuration</code>或者其它的注解将<code>Bean</code>注入的<code>Spring IOC</code>。然后我们可以使用<code>@Autowired</code>或者<code>@Resource</code>来使用由<code>Spring IoC</code>来管理的<code>Bean</code>。</p>
<h2 id="一、从应用程序上下文中获取Bean"><a href="#一、从应用程序上下文中获取Bean" class="headerlink" title="一、从应用程序上下文中获取Bean"></a>一、从应用程序上下文中获取<code>Bean</code></h2><p>我们今天学习将来如何从<code>ApplicationContext</code>中的<code>Bean</code>。因为有些情况下我们不得不从应用程序上下文中来获取<code>Bean</code>，例如在没有注入<code>Spring</code>的工具类中。</p>
<h3 id="1-1-在初始化时保存ApplicationContext对象"><a href="#1-1-在初始化时保存ApplicationContext对象" class="headerlink" title="1.1  在初始化时保存ApplicationContext对象"></a>1.1  在初始化时保存<code>ApplicationContext</code>对象</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationContext ac = <span class="keyword">new</span> FileSystemXmlApplicationContext(<span class="string">"applicationContext.xml"</span>); </span><br><span class="line">ac.getBean(<span class="string">"beanId"</span>);</span><br></pre></td></tr></table></figure>

<p>这种方式适用于采用<code>Spring</code>框架的独立应用程序，需要程序通过配置文件手工初始化<code>Spring</code>的情况。</p>
<p>注意：在获取失败时抛出异常。</p>
<h3 id="1-2-通过Spring提供的工具类获取ApplicationContext对象"><a href="#1-2-通过Spring提供的工具类获取ApplicationContext对象" class="headerlink" title="1.2 通过Spring提供的工具类获取ApplicationContext对象"></a>1.2 通过<code>Spring</code>提供的工具类获取<code>ApplicationContext</code>对象</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ApplicationContext ac1 = WebApplicationContextUtils.getRequiredWebApplicationContext(ServletContext sc); </span><br><span class="line">ApplicationContext ac2 = WebApplicationContextUtils.getWebApplicationContext(ServletContext sc); </span><br><span class="line">ac1.getBean(<span class="string">"beanId"</span>); </span><br><span class="line">ac2.getBean(<span class="string">"beanId"</span>);</span><br></pre></td></tr></table></figure>

<p>这种方式适合于采用<code>Spring</code>框架的<code>B/S</code>系统，通过<code>ServletContext</code>对象获取<code>ApplicationContext</code>对象，然后在通过它获取需要的类实例。获取失败时返回<code>null</code>。</p>
<h3 id="1-3-继承自抽象类ApplicationObjectSupport"><a href="#1-3-继承自抽象类ApplicationObjectSupport" class="headerlink" title="1.3 继承自抽象类ApplicationObjectSupport"></a>1.3 继承自抽象类<code>ApplicationObjectSupport</code></h3><p>抽象类<code>ApplicationObjectSupport</code>提供<code>getApplicationContext()</code>方法，可以方便的获取<code>ApplicationContext</code>。</p>
<p><code>Spring</code>初始化时，会通过该抽象类的<code>setApplicationContext(ApplicationContext context)</code>方法将<code>ApplicationContext</code> 对象注入。</p>
<h3 id="1-4-继承自抽象类WebApplicationObjectSupport"><a href="#1-4-继承自抽象类WebApplicationObjectSupport" class="headerlink" title="1.4 继承自抽象类WebApplicationObjectSupport"></a>1.4 继承自抽象类<code>WebApplicationObjectSupport</code></h3><p>类似上面方法，调用<code>getWebApplicationContext()</code>获取<code>WebApplicationContext</code></p>
<h3 id="1-5-通过Spring提供的ContextLoader"><a href="#1-5-通过Spring提供的ContextLoader" class="headerlink" title="1.5 通过Spring提供的ContextLoader"></a>1.5 通过<code>Spring</code>提供的<code>ContextLoader</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">WebApplicationContext wac = ContextLoader.getCurrentWebApplicationContext();</span><br><span class="line">wac.getBean(beanID);</span><br></pre></td></tr></table></figure>

<p>该方式不依赖于<code>servlet</code>,不需要注入的方式。</p>
<h3 id="1-6-实现接口ApplicationContextAware-本文重点"><a href="#1-6-实现接口ApplicationContextAware-本文重点" class="headerlink" title="1.6 实现接口ApplicationContextAware(本文重点)"></a>1.6 实现接口<code>ApplicationContextAware</code>(本文重点)</h3><p>实现该接口的<code>setApplicationContext(ApplicationContext context)</code>方法，并保存<code>ApplicationContext</code> 对象。<code>Spring</code>初始化时，会通过该方法将<code>ApplicationContext</code>对象注入。</p>
<h2 id="二、Spring-ApplicationContext-工具类"><a href="#二、Spring-ApplicationContext-工具类" class="headerlink" title="二、Spring ApplicationContext 工具类"></a>二、<code>Spring ApplicationContext</code> 工具类</h2><h3 id="2-1-项目准备"><a href="#2-1-项目准备" class="headerlink" title="2.1 项目准备"></a>2.1 项目准备</h3><blockquote>
<p>新增一个<code>Bean</code>，使其被<code>Spring IOC</code> 管理。 </p>
</blockquote>
<ul>
<li><code>SpringBean.java</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SpringBean desc"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>application.yml</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">demo:</span><br><span class="line">  value: 8888</span><br></pre></td></tr></table></figure>

<h3 id="2-2-定义一个工具类，实现-ApplicationContextAware"><a href="#2-2-定义一个工具类，实现-ApplicationContextAware" class="headerlink" title="2.2 定义一个工具类，实现 ApplicationContextAware"></a>2.2 定义一个工具类，实现 <code>ApplicationContextAware</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringUtils</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spring应用上下文环境</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现ApplicationContextAware接口的回调方法，设置上下文环境</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> applicationContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (SpringUtils.applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            SpringUtils.applicationContext = applicationContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对象，重写了bean方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SpringUtils.applicationContext.getBean(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 同上方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SpringUtils.applicationContext.getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果BeanFactory包含一个与所给名称匹配的bean定义，则返回true</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">containsBean</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SpringUtils.applicationContext.containsBean(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取配置信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getProperty</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SpringUtils.applicationContext.getEnvironment().getProperty(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>通过<code>@Component</code>注解将<code>SpringUtils.java</code>注入的<code>Spring IOC</code>，<code>Spring</code>能够为我们自动地执行 <code>setApplicationContext()</code> 方法；</li>
<li>我在该工具类封装了三个方法，主要用于获取<code>Bean</code>/判断<code>Bean</code>是否存在/获取配置文件中信息。</li>
</ol>
<h3 id="2-3-getBean"><a href="#2-3-getBean" class="headerlink" title="2.3 getBean()"></a>2.3 <code>getBean()</code></h3><blockquote>
<p>该方法用于获取对象，获取不到会抛异常。</p>
</blockquote>
<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getBeanDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SpringBean springBean = SpringUtils.getBean(SpringBean<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    log.info(<span class="string">"springBean.desc:&#123;&#125;"</span>, springBean.getDesc());</span><br><span class="line">    <span class="comment">// 如果bean 不存在</span></span><br><span class="line">    log.info(<span class="string">"springBeanOther:&#123;&#125;"</span>, SpringUtils.getBean(<span class="string">"springBeanOther"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-containsBean"><a href="#2-4-containsBean" class="headerlink" title="2.4 containsBean()"></a>2.4 <code>containsBean()</code></h3><blockquote>
<p>用来判断该<code>Bean</code> 是否注入到<code>Spring IOC</code>。</p>
</blockquote>
<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">containsBeanDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"containsBean:&#123;&#125;"</span>, SpringUtils.containsBean(<span class="string">"springBean"</span>));</span><br><span class="line">    <span class="comment">// 如果bean 不存在</span></span><br><span class="line">    log.info(<span class="string">"containsBean:&#123;&#125;"</span>, SpringUtils.containsBean(<span class="string">"springBeanOther"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-getProperty"><a href="#2-5-getProperty" class="headerlink" title="2.5 getProperty()"></a>2.5 <code>getProperty()</code></h3><blockquote>
<p>用来获取配置文件属性，属性不存在返回<code>null</code>。</p>
</blockquote>
<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getPropertyDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String value = SpringUtils.getProperty(<span class="string">"demo.value"</span>);</span><br><span class="line">    log.info(<span class="string">"value:&#123;&#125;"</span>, value);</span><br><span class="line">    <span class="comment">// 配置中不存在</span></span><br><span class="line">    String key = SpringUtils.getProperty(<span class="string">"demo.key"</span>);</span><br><span class="line">    log.info(<span class="string">"key:&#123;&#125;"</span>, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>这里仅作简单展示，如需探究更多使用方法，可以直接定义<code>getApplicationContext()</code>方法，将<code>ApplicationContext</code>返回，具体详见文末工具类中代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ApplicationContext context = SpringUtils.getApplicationContext();</span><br><span class="line">    log.info(<span class="string">"context.containsBean():&#123;&#125;"</span>, context.containsBean(<span class="string">"springBean"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/vanDusty/Frame-Home/tree/master/spring-case/spring-demo" target="_blank" rel="noopener">Github 示例代码</a></p>
<ol>
<li><a href="https://github.com/vanDusty/Frame-Home/blob/master/spring-case/spring-demo/src/main/java/cn/van/spring/demo/util/SpringUtils.java" target="_blank" rel="noopener">SpringUtils.java</a></li>
<li><a href="https://github.com/vanDusty/Frame-Home/blob/master/spring-case/spring-demo/src/test/java/cn/van/spring/demo/SpringUtilsTest.java" target="_blank" rel="noopener">SpringUtilsTest.java</a></li>
</ol>
<blockquote>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
</blockquote>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Bean</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot 配置文件详解</title>
    <url>/2018/12/21/47ef90.html</url>
    <content><![CDATA[<blockquote>
<p><code>Spring Boot</code>是为了简化<code>Spring</code>应用的创建、运行、调试、部署等一系列问题而诞生的产物，自动装配的特性让我们可以更好的关注业务本身而不是外部的<code>XML</code>配置，我们只需遵循规范，引入相关的依赖就可以轻易的搭建出一个 <code>WEB</code> 工程。</p>
</blockquote>
<a id="more"></a>

<h2 id="一、准备"><a href="#一、准备" class="headerlink" title="一、准备"></a>一、准备</h2><h3 id="1-1-背景"><a href="#1-1-背景" class="headerlink" title="1.1 背景"></a>1.1 背景</h3><p>熟悉 <code>Spring Boot</code> 的小伙伴都知道，<code>Spring Boot</code> 中的配置文件有两种格式：<code>properties/yaml</code>，一般情况下，两者可以随意使用本文就来和大伙重点介绍下 <code>yaml</code> 配置。</p>
<h3 id="1-2-建议使用的包"><a href="#1-2-建议使用的包" class="headerlink" title="1.2 建议使用的包"></a>1.2 建议使用的包</h3><p>为了让<code>Spring Boot</code>更好的生成数据，我们需要添加如下依赖（该依赖可以不添加，但是在 <code>IDEA</code> 不会有属性提示），该依赖只会在编译时调用，所以不用担心会对生产造成影响…</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="二、自定义属性配置"><a href="#二、自定义属性配置" class="headerlink" title="二、自定义属性配置"></a>二、自定义属性配置</h2><h3 id="2-1-application-yml-自定义属性"><a href="#2-1-application-yml-自定义属性" class="headerlink" title="2.1 application.yml 自定义属性"></a>2.1 <code>application.yml</code> 自定义属性</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">original:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">title:</span> <span class="string">OriginalConfig</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">主配置文件中属性</span></span><br></pre></td></tr></table></figure>
<h3 id="2-2-新建OriginalConfig配置类"><a href="#2-2-新建OriginalConfig配置类" class="headerlink" title="2.2 新建OriginalConfig配置类"></a>2.2 新建<code>OriginalConfig</code>配置类</h3><blockquote>
<p>该配置类用来映射我们在<code>application.yml</code>中的内容，这样一来我们就可以通过操作对象的方式来获得配置文件的内容了。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OriginalConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入 application.yml 配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;original.config.title&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;original.config.description&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里，可以采用<code>@ConfigurationProperties</code>简化<code>@Value</code>注入值的写法,详见文末Github源码写法。</p>
</blockquote>
<h3 id="2-3-ConfigTest-java测试"><a href="#2-3-ConfigTest-java测试" class="headerlink" title="2.3 ConfigTest.java测试"></a>2.3 <code>ConfigTest.java</code>测试</h3><h4 id="2-3-1-测试方法testOriginalConfig"><a href="#2-3-1-测试方法testOriginalConfig" class="headerlink" title="2.3.1 测试方法testOriginalConfig"></a>2.3.1 测试方法<code>testOriginalConfig</code></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   OriginalConfig originalConfig;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 读取自定义属性</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOriginalConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"开始读取 application.yml 的自定义属性："</span>);</span><br><span class="line">       System.out.println(<span class="string">"读取配置信息："</span>);</span><br><span class="line">       System.out.println(<span class="string">"title: "</span> + originalConfig.getTitle());</span><br><span class="line">       System.out.println(<span class="string">"desc: "</span> + originalConfig.getDescription());</span><br><span class="line">       System.out.println(<span class="string">"application.yml 文件的属性读取完毕！"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-控制台打印如下："><a href="#2-3-2-控制台打印如下：" class="headerlink" title="2.3.2 控制台打印如下："></a>2.3.2 控制台打印如下：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">开始读取 application.yml 的自定义属性：</span><br><span class="line">读取配置信息：</span><br><span class="line">title: OriginalConfig</span><br><span class="line">desc: 主配置文件中属性</span><br><span class="line">application.yml 文件的属性读取完毕！</span><br></pre></td></tr></table></figure>

<h2 id="三、自定义文件配置"><a href="#三、自定义文件配置" class="headerlink" title="三、自定义文件配置"></a>三、自定义文件配置</h2><h3 id="3-1-定义一个名为myConfig-properties的自定义文件"><a href="#3-1-定义一个名为myConfig-properties的自定义文件" class="headerlink" title="3.1 定义一个名为myConfig.properties的自定义文件"></a>3.1 定义一个名为<code>myConfig.properties</code>的自定义文件</h3><blockquote>
<p>自定义配置文件的命名不强制application开头</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">customize.config.title&#x3D;CustomizeConfig</span><br><span class="line">customize.config.description&#x3D;自定义配置文件中属性</span><br></pre></td></tr></table></figure>

<h3 id="3-2-新建CustomizeConfig配置类"><a href="#3-2-新建CustomizeConfig配置类" class="headerlink" title="3.2 新建CustomizeConfig配置类"></a>3.2 新建<code>CustomizeConfig</code>配置类</h3><blockquote>
<p>该配置类用来映射我们在<code>myConfig.properties</code>中的内容，这样一来我们就可以通过操作对象的方式来获得配置文件的内容了。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource</span>(value = <span class="string">"classpath:myConfig.properties"</span>, encoding = <span class="string">"utf-8"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入 myConfig.properties 配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;customize.config.title&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;customize.config.description&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>@PropertySource</code> :配置文件路径和编码格式</li>
</ul>
<h3 id="2-3-单元测试"><a href="#2-3-单元测试" class="headerlink" title="2.3 单元测试"></a>2.3 单元测试</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   CustomizeConfig customizeConfig;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从 myConfig.properties 获取配置</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCustomizeConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"开始读取 myConfig.properties 文件的属性："</span>);</span><br><span class="line">       System.out.println(<span class="string">"title: "</span> + customizeConfig.getTitle());</span><br><span class="line">       System.out.println(<span class="string">"desc: "</span> + customizeConfig.getDescription());</span><br><span class="line">       System.out.println(<span class="string">"myConfig.properties 文件的属性读取完毕！"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>控制台打印如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">开始读取 myConfig.properties 文件的属性：</span><br><span class="line">title: CustomizeConfig</span><br><span class="line">desc: 自定义配置文件中属性</span><br><span class="line">myConfig.properties 文件的属性读取完毕！</span><br></pre></td></tr></table></figure>



<h2 id="三、多环境化配置"><a href="#三、多环境化配置" class="headerlink" title="三、多环境化配置"></a>三、多环境化配置</h2><blockquote>
<p>真实的应用中，常常会有多个环境（如：本地，开发，测试，正式），不同的环境数据库连接都不一样，这个时候就需要用到<code>spring.profile.active</code>，它的格式为<code>application-{profile}.yml</code>，这里的<code>application</code>为前缀不能改，<code>{profile}</code>是我们自己定义的。</p>
</blockquote>
<h3 id="3-1-指定不同环境的路径"><a href="#3-1-指定不同环境的路径" class="headerlink" title="3.1 指定不同环境的路径"></a>3.1 指定不同环境的路径</h3><blockquote>
<p>通过<code>server.servlet.context-path</code>将不同环境指定不同的路径。</p>
</blockquote>
<ul>
<li><code>application-local.yml</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">title: local配置文件</span><br><span class="line">server:</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: &#x2F;local</span><br></pre></td></tr></table></figure>

<ul>
<li><code>application-daily.yml</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">title: daily配置文件</span><br><span class="line">server:</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: &#x2F;daily</span><br></pre></td></tr></table></figure>

<ul>
<li><code>application-gray.yml</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">title: gray配置文件</span><br><span class="line">server:</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: &#x2F;gray</span><br></pre></td></tr></table></figure>


<ul>
<li><code>application-production.yml</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">title: production配置文件</span><br><span class="line">server:</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: &#x2F;production</span><br></pre></td></tr></table></figure>

<h3 id="3-2-新增配置类EnvConfig-java"><a href="#3-2-新增配置类EnvConfig-java" class="headerlink" title="3.2 新增配置类EnvConfig.java"></a>3.2 新增配置类<code>EnvConfig.java</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnvConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;title&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-测试方法"><a href="#3-3-测试方法" class="headerlink" title="3.3 测试方法"></a>3.3 测试方法</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   EnvConfig envConfig;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从 不同环境配置读取</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testEnvConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"开始读取 不同环境 文件的属性："</span>);</span><br><span class="line">       System.out.println(<span class="string">"title: "</span> + envConfig.getTitle());</span><br><span class="line">       System.out.println(<span class="string">"myConfig.properties 文件的属性读取完毕！"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-激活某个环境配置"><a href="#3-4-激活某个环境配置" class="headerlink" title="3.4 激活某个环境配置"></a>3.4 激活某个环境配置</h3><p>在<code>application.yml</code>配置文件中指定环境，例如指定<code>gray</code>环境：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">    active: daily</span><br></pre></td></tr></table></figure>

<ul>
<li>控制台打印如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">开始读取 不同环境 文件的属性：</span><br><span class="line">title: gray配置文件</span><br><span class="line">myConfig.properties 文件的属性读取完毕！</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里指定不同的环境配置文件，即可访问到不同环境的配置。</p>
</blockquote>
<h2 id="四、源码地址"><a href="#四、源码地址" class="headerlink" title="四、源码地址"></a>四、源码地址</h2><p><a href="https://github.com/vanDusty/SpringBoot-Home/tree/master/springboot-demo-list/springboot-demo-config" target="_blank" rel="noopener">Github 示例源码</a></p>
]]></content>
      <categories>
        <category>Spring Boot</category>
      </categories>
      <tags>
        <tag>配置</tag>
      </tags>
  </entry>
  <entry>
    <title>Java 时间日期 API 之 Date</title>
    <url>/2018/12/11/6ef1e190.html</url>
    <content><![CDATA[<blockquote>
<p>虽然 <code>JDK 1.8</code> 已经出来好多年了，<code>LocalDate</code>、<code>LocalDateTime</code>、<code>LocalTime</code> 不知道要比 <code>Date</code> 好用多少倍，但是没办法，很多老项目还是用 <code>Date</code>。</p>
</blockquote>
<a id="more"></a>

<p>本文分享博主日常用的比较多的几个方法，仅供参考。</p>
<h3 id="1、计算两个时间的间隔天数"><a href="#1、计算两个时间的间隔天数" class="headerlink" title="1、计算两个时间的间隔天数"></a>1、计算两个时间的间隔天数</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calcIntervalDays</span><span class="params">(Date date1, Date date2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (date2.after(date1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.valueOf((date2.getTime() - date1.getTime()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>)).intValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (date2.before(date1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.valueOf((date1.getTime() - date2.getTime()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>)).intValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据此方法，我们可以<strong>判断两个时间是否是同一天</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSameDay</span><span class="params">(Date date1, Date date2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> calcIntervalDays(date1, date2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、计算两个时间的间隔小时，只会整除"><a href="#2、计算两个时间的间隔小时，只会整除" class="headerlink" title="2、计算两个时间的间隔小时，只会整除"></a>2、计算两个时间的间隔小时，只会整除</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calcIntervalOurs</span><span class="params">(Date date1, Date date2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (date2.after(date1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.valueOf((date2.getTime() - date1.getTime()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>)).intValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (date2.before(date1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.valueOf((date1.getTime() - date2.getTime()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>)).intValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、计算两个时间的间隔分钟，只会整除"><a href="#3、计算两个时间的间隔分钟，只会整除" class="headerlink" title="3、计算两个时间的间隔分钟，只会整除"></a>3、计算两个时间的间隔分钟，只会整除</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calcIntervalDays</span><span class="params">(Date date1, Date date2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (date2.after(date1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.valueOf((date2.getTime() - date1.getTime()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>)).intValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (date2.before(date1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.valueOf((date1.getTime() - date2.getTime()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>)).intValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、返回日期对应的是星期几"><a href="#4、返回日期对应的是星期几" class="headerlink" title="4、返回日期对应的是星期几"></a>4、返回日期对应的是星期几</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dayOfWeek</span><span class="params">(Date date)</span> </span>&#123;</span><br><span class="line">    Calendar ca = Calendar.getInstance();</span><br><span class="line">    ca.setTime(date);</span><br><span class="line">    <span class="keyword">int</span> dayOfWeek;</span><br><span class="line">    <span class="keyword">if</span> (ca.get(Calendar.DAY_OF_WEEK) == <span class="number">1</span>) &#123;</span><br><span class="line">        dayOfWeek = <span class="number">7</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dayOfWeek = ca.get(Calendar.DAY_OF_WEEK) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dayOfWeek;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、获取今天当前的总分钟数，如今天16-54，则返回1014"><a href="#5、获取今天当前的总分钟数，如今天16-54，则返回1014" class="headerlink" title="5、获取今天当前的总分钟数，如今天16:54，则返回1014"></a>5、获取今天当前的总分钟数，如今天16:54，则返回1014</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTodayMinutes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Calendar ca = Calendar.getInstance();</span><br><span class="line">    <span class="keyword">int</span> hours = ca.get(Calendar.HOUR_OF_DAY);</span><br><span class="line">    <span class="keyword">int</span> minutes = ca.get(Calendar.MINUTE);</span><br><span class="line">    <span class="keyword">return</span> hours * <span class="number">60</span> + minutes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、将-String-转成-Date将-Date转成String"><a href="#6、将-String-转成-Date将-Date转成String" class="headerlink" title="6、将 String 转成 Date将 Date转成String"></a>6、将 <code>String</code> 转成 <code>Date</code>将 <code>Date</code>转成<code>String</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">stringParseDate</span><span class="params">(String dateStr)</span> </span>&#123;</span><br><span class="line">    SimpleDateFormat format = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (dateStr.contains(<span class="string">"/"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dateStr.contains(<span class="string">":"</span>) &amp;&amp; dateStr.contains(<span class="string">" "</span>)) &#123;</span><br><span class="line">            format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy/MM/dd"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateStr.contains(<span class="string">"-"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dateStr.contains(<span class="string">":"</span>) &amp;&amp; dateStr.contains(<span class="string">" "</span>)) &#123;</span><br><span class="line">            format = <span class="keyword">new</span> SimpleDateFormat(YYYYMMDDHHMMSS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            format = <span class="keyword">new</span> SimpleDateFormat(YYYYMMDD);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateStr.contains(<span class="string">"年"</span>) &amp;&amp; dateStr.contains(<span class="string">"月"</span>) &amp;&amp; dateStr.contains(<span class="string">"日"</span>) &amp;&amp; dateStr.contains(<span class="string">"时"</span>) &amp;&amp; dateStr.contains(<span class="string">"分"</span>) &amp;&amp; dateStr.contains(<span class="string">"秒"</span>)) &#123;</span><br><span class="line">        format = <span class="keyword">new</span> SimpleDateFormat(YYYYMMDDHHMMSS_CHINESE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dateStr.contains(<span class="string">"年"</span>) &amp;&amp; dateStr.contains(<span class="string">"月"</span>) &amp;&amp; dateStr.contains(<span class="string">"日"</span>)) &#123;</span><br><span class="line">        format = <span class="keyword">new</span> SimpleDateFormat(YYYYMMDD_CHINESE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!dateStr.contains(<span class="string">"年"</span>) &amp;&amp; dateStr.contains(<span class="string">"月"</span>) &amp;&amp; dateStr.contains(<span class="string">"日"</span>)) &#123;</span><br><span class="line">        format = <span class="keyword">new</span> SimpleDateFormat(MMDD_CHINESE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (format == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    format.setTimeZone(TimeZone.getTimeZone(<span class="string">"Asia/Shanghai"</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> format.parse(dateStr);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">dateToString</span><span class="params">(Date date, String format)</span> </span>&#123;</span><br><span class="line">    DateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(format);</span><br><span class="line">    dateFormat.setTimeZone(TimeZone.getTimeZone(<span class="string">"Asia/Shanghai"</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dateFormat.format(date);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7、获取指定日期偏移指定时间后的时间"><a href="#7、获取指定日期偏移指定时间后的时间" class="headerlink" title="7、获取指定日期偏移指定时间后的时间"></a>7、获取指定日期偏移指定时间后的时间</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">offsiteDate</span><span class="params">(Date date, <span class="keyword">int</span> calendarField, <span class="keyword">int</span> offsite)</span></span>&#123;</span><br><span class="line">    Calendar cal = Calendar.getInstance();</span><br><span class="line">    cal.setTime(date);</span><br><span class="line">    cal.add(calendarField, offsite);</span><br><span class="line">    <span class="keyword">return</span> cal.getTime();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>参数说明：</li>
</ul>
<ol>
<li><code>date</code>：基准日期</li>
<li><code>calendarField</code>：偏移的粒度大小（小时、天、月等）使用<code>Calendar</code>中的常数</li>
<li><code>offsite</code>：偏移量，正数为向后偏移，负数为向前偏移</li>
</ol>
<ul>
<li>例如常用的：</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取昨天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">getYesterday</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> offsiteDate(<span class="keyword">new</span> Date(), Calendar.DAY_OF_YEAR, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取上周今天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">getLastWeek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> offsiteDate(<span class="keyword">new</span> Date(), Calendar.WEEK_OF_YEAR, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取上个月今天</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">getLastMouth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> offsiteDate(<span class="keyword">new</span> Date(), Calendar.MONTH, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="8、获取某月的最后一天"><a href="#8、获取某月的最后一天" class="headerlink" title="8、获取某月的最后一天"></a>8、获取某月的最后一天</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getMonthLastDay</span><span class="params">(<span class="keyword">int</span> year, <span class="keyword">int</span> month)</span> </span>&#123;</span><br><span class="line">    Calendar a = Calendar.getInstance();</span><br><span class="line">    a.set(Calendar.YEAR, year);</span><br><span class="line">    a.set(Calendar.MONTH, month - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//把日期设置为当月第一天</span></span><br><span class="line">    a.set(Calendar.DATE, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//日期回滚一天，也就是最后一天</span></span><br><span class="line">    a.roll(Calendar.DATE, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">int</span> maxDate = a.get(Calendar.DATE);</span><br><span class="line">    <span class="keyword">return</span> maxDate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9、判断是否是闰年"><a href="#9、判断是否是闰年" class="headerlink" title="9、判断是否是闰年"></a>9、判断是否是闰年</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLeap</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((year % <span class="number">100</span> == <span class="number">0</span>) &amp;&amp; year % <span class="number">400</span> == <span class="number">0</span>) || ((year % <span class="number">100</span> != <span class="number">0</span>) &amp;&amp; year % <span class="number">4</span> == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="10、由出生日期获得年龄"><a href="#10、由出生日期获得年龄" class="headerlink" title="10、由出生日期获得年龄"></a>10、由出生日期获得年龄</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">(Date birthDay)</span> </span>&#123;</span><br><span class="line">    Calendar cal = Calendar.getInstance();</span><br><span class="line">    <span class="keyword">if</span> (cal.before(birthDay)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">"The birthDay is before Now.It's unbelievable!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> yearNow = cal.get(Calendar.YEAR);</span><br><span class="line">    <span class="keyword">int</span> monthNow = cal.get(Calendar.MONTH);</span><br><span class="line">    <span class="keyword">int</span> dayOfMonthNow = cal.get(Calendar.DAY_OF_MONTH);</span><br><span class="line">    cal.setTime(birthDay);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> yearBirth = cal.get(Calendar.YEAR);</span><br><span class="line">    <span class="keyword">int</span> monthBirth = cal.get(Calendar.MONTH);</span><br><span class="line">    <span class="keyword">int</span> dayOfMonthBirth = cal.get(Calendar.DAY_OF_MONTH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> age = yearNow - yearBirth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (monthNow &lt;= monthBirth) &#123;</span><br><span class="line">        <span class="keyword">if</span> (monthNow == monthBirth) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dayOfMonthNow &lt; dayOfMonthBirth)&#123;</span><br><span class="line">                age--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            age--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>博主将这些方法封装成一个工具类，详见<a href="https://github.com/vanDusty/jdk/blob/master/JDK-Date/src/main/java/cn/van/jdk/date/DateUtil.java" target="_blank" rel="noopener">DateUtil.java</a></p>
<p>更多 <code>Java</code> 笔记，详见<a href="https://github.com/vanDusty/Java-Note" target="_blank" rel="noopener">【Java 知识笔记本】</a>，欢迎提供想法建议。</p>
]]></content>
      <categories>
        <category>JDK</category>
      </categories>
      <tags>
        <tag>时间日期</tag>
      </tags>
  </entry>
</search>
